IMPORTANT NOTE:

  * Instructions to run *
    check out clean version of Unimod (safest as there are several new files)

    Options:

    1) Use the make system (stallo/vilje only!), e.g. type:
        make EMEP
        make SR-EMEP

        make EMEP2011 for met year 2011 Base runs
        make SR-EMEP2011 for met year 2011 SR runs

    make EMEP2010 for met year 2010 Base runs
    make SR-EMEP2010 for met year 2010 SR runs

      or other targets. See Makefile for these

       This is the easiest and safest method as of 2012!!

****** PLEASE READ CAREFULLY  "*****Run/Make examples:" SECTION BELOW 
	BEFORE SUBMITTING ANY RUN  **********************************


    2) By hand:

    edit mk.GenChem, set "run" if not default (=EmChem09)
     (type mk.GenChem -h for some examples)
    mk.GenChem
    cp ZD_OZONE/My* .
  [option: if SOA wanted, do:
    cp ZD_VBS/My* .          # gets MySOA_ml and My_Derived including SOA
  ]
    make clean
    make
    edit run.pl for year, Chem etc.

   [option: if SR wanted, cp ZD_SR/My* .]

*****    Run/Make examples:
  2011 Base run:
    * Compile the model with `make EMEP2011` and 
      USE_EMERGENCY=.true. in config_EMEPSTD.nml to use Grimsvotn eruption data.
    * run.pl: $year=2011 and $MAKEMODE="EMEP2011", and the program
      will be compiled by run.pl including Grimsvotn eruption tracers. 
  2011 SR run:
    * Compile the model with `make SR-EMEP2011` and
      USE_EMERGENCY=.true. in config_EMEPSTD.nml to use Grimsvotn eruption data.
    * run.pl: $year=2011, $SR=1 and $MAKEMODE="EMEP2011", and the program
      will be compiled by run.pl including Grimsvotn eruption tracers. 
  2010 Base run
    * Compile the model with `make EMEP2010` and USE_EMERGENCY=.true.
      USE_EMERGENCY=.true. in config_EMEPSTD.nml to use Eyjafjöll eruption data.
    * Run $year=2010 and $MAKEMODE="EMEP2010" (run.pl), and the program
      will be compiled by run.pl including Eyjafjöll eruption tracers.
  2010 SR run
    * Compile the model with `make SR-EMEP2010` and USE_EMERGENCY=.true.
      USE_EMERGENCY=.true. in config_EMEPSTD.nml to use Eyjafjöll eruption data.
    * Run $year=2010, $SR=1 and $MAKEMODE="EMEP2010" (run.pl), and the program
      will be compiled by run.pl including Eyjafjöll eruption tracers.
  2009 Base run (or any other year/=2010)
    * Compile the model with `make EMEP`.
    * Run $year=2009 and $MAKEMODE="EMEP" (run.pl),
      and the program will be compiled by run.pl.
  2009 SR run (or any other year/=2010)
    * Compile the model with `make SR-EMEP`.
    * Run $year=2009, $SR=1 and $MAKEMODE="EMEP" (run.pl),
      and the program will be compiled by run.pl.
          
  Modules & Make in stallo/vilje
    Since rv4rc8, the modules required for compilation are set and tested on Makefile.
    This is done to ensure that the model is compiled/linked with consistent compiler/libraries.
    Please add the following lines to your ~/.bashrc file
      
## Unimod: Modules & Make
export MACHINE=vilje                  # select stallo/vilje machine
case $MACHINE in                   # modules needed to compile Unimod
 stallo)EMEPMODULES="intel/13.0 openmpi/1.6.2 hdf5/1.8.9 netcdf/4.2.1.1";;
gstallo)EMEPMODULES="gcc/4.7.2  openmpi/1.6.2 hdf5/1.8.9 netcdf/4.2.1.1";;
  vilje)EMEPMODULES="intelcomp/13.0.1 mpt/2.06 netcdf/4.3.0";;
esac
[[ -z "$MODULESHOME" && -s /etc/profile.d/modules.sh ]] &&
  . /etc/profile.d/modules.sh      # load modulecmd wraper, fi needed
if [[ -n "$EMEPMODULES" ]]; then
  module purge                     # unload default modules
  module load  $EMEPMODULES        # load versions needed by Unimod
fi

    Inputs

     HDD (Degree Day files)
     ----------------------
     If you get an error message such as:


 ERROR: Missing!!! in check-file:DegreeDayFactors.nc    (rv4_1_7 onwards)

 Or in earlier versions:

 Looking for DegreeDayFac: /global/work/mifapw/emep/Data/inputs_emepdefaults_May2012/HDD18-TNO28-2008.nc

      you may need to generate this file. Use:

      *  meteoPreProc from utils sub-directory, use e.g. mk.meteoPreProc script.


SOIL NOx ISSUES - Mainly think about (1) for policy

This versions works for European soil-NO emissions, but work still
needed on a few issues for e.g. global usage, or NH3

    (1) Soil-NO needs maps of annual N-deposition.
        Need to have climatalogical values, e.g.  5-year avg.
        Also need to consider "trends" for future scenarios

        Currently done with mkcdo.Ndep_5yrs in mifads/bin directory
        on stallo.

    (2) Can now have either the hourly calculations or the monthly
        global fields. Ideal is probably hourly for Europe and
        monthly outside.

    (3) Not sure the global soil works, since now rcbio is used
        check

    (4) NH3 should be in reactions too?

KNOWN PROBLEMS

ForestFire bug cleaned out for FINN, EmChem09soa.
Needs to be repeated for other combinations

TERPPEROXY

IMPORTANT NOTE:

All CM_ files are removed from the cvs system. You have to
run GenChem!!!

Run mk.GenChem  or e.g. make EMEP, see above!!!!

Also - GenChem makes femis.defaults in the ZCM_... directory

!----------------------------------------------------------
CLEAN-UP: all code should be checked to remove old comments before
the public release. Ideally compile code on PC with gfortran's
pedantic debug switches (eg make MACHINE=precise EMEP) - gives loads of
info on unused variables, etc.


TAGS. svn does not have the same tagging system as cvs. For now, record
changes here (and when committing svn), and Dave will tag as required

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 April 2015  Alvaro 2984,2985,2986

Nest_ml,ZD_Pollen/Pollen_ml:
- On Forecast mode, write pollen species to the pollen/restart file (*-pollen.nc)
  instead of the dump/restart files (*-dump.nc)

run.pl:
- Analysis and Forecast runs for 5+ days be runs as in hindcast mode,
  ie will use the 00UTC-D0 or 12UTC-D1 datasets.
- Forecasts will look for dump/restart files (CWF_$k-dump.nc) in the following order:
  00AN, 00FC, 00, 12AN, 12FC, 12, current-run.
- Forecasts will look for pollen/restart (CWF_$k-pollen.nc) files in the following order:
  xxAN, xxFC, xx, current-run, where xx is the met version (00 or 12).

NetCDF_ml:
- Limit printout messages to MasterProc in vertical_interpolate.

ZD_OZONE/My_Outputs_ml:
- add MY_OUTPUTS:="TRENDS@12UTC" hourly output definition

Output_hourly:
- only output at 12UTC for MY_OUTPUTS such as "TRENDS@12UTC"

Functions_ml, ZD_3DVar/B_NMC/Util_ml,
ZD_3DVar/Analysis/DA_3DVar_ml,DA_Obs_ml:
- move norm interface and and norm_* module functions from Functions_ml to Util_ml.

config_EMEPSTD.nml,config_FORECAST.nml:
- add missing come after DEBUG%IJ definition
- tidy up ExternalBICs_bc for "EVA_EU_FC"

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14 April 2015  Dave 2983

ModelConstants_ml, Met_ml, config_EMEPGLOB.nml

 - added CONVECTION_FACTOR. Values < 1.0 reduce convective fluxes from default
   value (=1)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12-14 April 2015  Dave 2980-2982

NEW - start of easier outputs for d_2d fields. The OutputMisc field system
  lets the user add new variables directly in config_Outputs, although
  of course Unimod needs to know how to deal with the "class" and names given.
  class type now for these OutputMisc is 'USET' (user-set), will likely 
  refine later.

  I have added the example USTAR_d which should give exactly the same output
  as the older USTAR_NWP from My_Derived, without the need for the code in
  My_D.  (Code is still needed in Derived to know how to deal with this class
   of output though.)

  I also added a class rct where Setup_1d_ml sets d_2d values directly
  from the rct values. (Used for comparing loss rates.)

  This will hopefully enable us to get rid of My_Derived soon :-)

New - AeroFunctions! (should have been in 2979. Updated now anyway)
- functions to calculate wet-radius (Gerber method), surface area, etc.
  now has kaero routine (which is chemistry-independent)

Chem_ml
- added cHNO3, aero_fom, etc. for aerosol calculations

ChemFunctions_ml
- HydrolysisN2O5 has  many more options for gamma factors, using functions
  from AeroFunctions
- kaero renamed xkaero, now not used.
  (Logic is that "physics" functions are kept in AeroFunctions. These know
   nothing about EMEP model chemical species or assumptions. Functions which
   need access to chemical information are kept in ChemFunctions.)

OwnDerivedTy, My_Derived, Derived
- modified to allow new OutputMisc types, and better initialisation
- plus SurfArea added in Derived - surface area of different aerosol types

ModelConstants, Setup_1d_ml, Setup_1dfields_ml
- changes to calculation of aerosol surface area
- allows rate coefficients (class RCT) to use new OutputMisc system, here
  setting d_2d directly

ModelConstants
- changes to calculation of aerosol surface area, in AERO%
- allows rate coefficients (class RCT) to use new OutputMisc system, here
- added USES%n2o5Hydrolysis
- added DEBUG%STOP_HH to enable run-stop after e.g. 1 hour.

MosaicOutputs
- better use of sub='AddMosaicMetConc:' for debugging

Unimod.f90
- added DEBUG%STOP_HH to enable run-stop after e.g. 1 hour.

ZCM_EmChem09/EmChem09.reactions
- use kaero(rh) from AeroFunctions.
- has fake reaction of Rnwater to allow debugging of Riemer and gamm

ZD_ESX/refman.pdf deleted. Was starting to take space, and can anyway be
  generated from script.

config_EMEPSTD, config_Outputs_EMEPSTD, config_BM-EECCA
- added USES%n2o5Hydrolysis
- added new SurfArea and 'USET'
- added DEBUG%STOP_HH to enable run-stop after e.g. 1 hour.

GenChem.pl
- add call to AeroFunctions



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th April 2015  Dave 2979
- introduction of surface area calculations. So far not used, but intended
  as outputs.
- results so far identical to 2976

Chem_ml, Setup_1dfields, Setup_1d_ml
- adapted to provide and calculate SurfArea_m2m3 and S_m2m3

Derived_ml, config_EMEPSTD
- added SurfArea outputs

ModelConstants_ml
- Renamed AERO%diam to AERO%DpgV, added %DpgN and consistent calculation from
    DpgV to DpgN.
- Added NSD_F, etc, for surf-area

SeaSalt_ml
- Use Gerber functions to get wet-radius
  Rename diam to DpgV

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd April 2015  Dave 2976-2978
- small preparations for new aerosol system

config_EMEPGLOB.nml - NEW!
- defines settings for global runs, which typically differ from EECCA runs, 
  eg PFT_MAPS, GRIDDED_MONTHLY_FACTOR
  Needs care with emissions settings! This version uses emislist.

NumberConstants - NEW (from ESX)
-  defines UNDEF_R, UNDEF_I which can be used in initialisations

OwnDataTypes 
- now uses NumberConstants to get UNDEF_R, UNDEF_I

Makefiles.SRC
- added NumberConstants

ModelConstants, Emissions_ml, TimeFactors_ml, config_XXXX
- Changed USE_DEGREEDAY_FACTORS, USE_GRIDDED_MONTHLY_FACTOR to USES% system, so
  now in config
 
SeaSalt_ml
- uses DEBUG%SEASALT instead of DEBUG_SEASALT

Setup_1d_ml
- Added isnan test on 1st call to set_rct_rates (suggested by Peter)
- Also added cleaner debug_flag system, isnan on NO2, and removed IXADV_ + NSPEC_SHL usage

Sites_ml
- reduced outputs to MasterProc

GenChem.pl
- added safety setting of rct to zero
- removed unused Branching statements

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
  The previous implementation switched BC file after reading all records in it.

Nest_ml, config_FORECAST.nml
- Use new logical variables native_grid_3D and native_grid_BC,
  read in Nest_config namelist, to indicate if the IC/BC files are on the same
  grid/domain as the current run. This is used to skip the expensive call to 
  grid2grid_coeff in init_nest.
- Use new logical variable omit_zero_write, read in Nest_config namelist,
  to indicate if constant=0.0 variables are to be skiped from output.

Nest_ml
- FORECAST no longer supersedes MODE, in order to smplify the code.
- Update filename_read_3D, filename_read_BC and filename_write from their
  respective templates within init_icbc.
- Call init_icbc on Config_Nest to ensure that the variables for IC/BC mappings
  are found.
- Set output type for all variables (Real4) in a consistent manner
  (DFtype=>Real4), instead of in each Out_netCDF call.
- Declare coordinates of sub-domain to write as public.
- Replace StopAll by CheckStop calls.

NetCDF_ml, Nest_ml:
- Rename and move max_string_length parameter in Nest_ml to max_filename_length
  in NetCDF_ml
- Set all fileName* variables (NetCDF_ml) to max_filename_length,
  to ensure that the full path/fileNames from Nest_ml are kept.

NetCDF_ml:
- Out_netCDF:
  - Ensure ncfileID_given input/output variable (introduced in 2961)
    contains the correct valid ncID when create_var_only=.true.
  - New parmeter IOU_GIVEN=-IOU_INST to indicate present(ncfileID_given).
  - Use variable iotyp_new in Out_netCDF to hold iotyp or IOU_GIVEN.
- GetCDF_modelgrid:
  - Remove duplicated output from .not.MasterProc.
- vertical_interpolate:
  - Use explicit array dimensions on Rvar (input) and Rvar_emep (output) variables.
    Previous version could exceeld variable boundaries, depending on the
    domain and NPROC.
- createnewvariable, GetCDF_modelgrid, Out_netCDF and vertical_interpolate:
  - Add crash/debug information to necdf calls trough check function (CheckNC).
  - Clean up calls to netcdf procedures.
  - Replace StopAll by CheckStop calls.

Makefile:
- Add $(SRCS.$(EXP)) to %.tar.bz2, so source code from ZD_3DVar/Make.SRCS
  is also archived.

run.pl,config_FORECAST.nml:
- Set $MAKEMODE for MACC runs based on $ENV{"PBS_JOBNAME"}.
- Always recompile model (make clean) for MACC runs.
- So not interpolate vertical leveld on meteo for MACC14 domain.
- Do not link $HDD file for MACC14 domain.
- Write full path to pollen input files into Pollen_config namelist.

ZD_Pollen/My_Pollen_ml,Pollen_const_ml,
- new version with grass & olive pollen, in addition to birch pollen.

ZCM_EmChem09/Pollen.species,Pollen.reactions:
- rename POLLEN_B specie to POLLEN_BIRTCH
- add POLLEN_OLIVE and POLEN_GRASS species
- add POLLEN group for all POLLEN_* species

config_Outputs_EMEPSTD.nml:
- Add POLLEN (GROUP) output for MACC-ENS runs
- Add O3 output in ug/m3 for MACC-EVA runs

config_Outputs_EMEPSTD.nml, config_BM-EECCA.nml:
- Remove POLLEN_B (SPC) output

ZD_OZONE/My_Outputs_ml.f90, Output_hourly:
- MACC_ENS mode: output grass & olive pollen, in addition to birch pollen.
- MACC_EVA mode: use D2D_inst outputs
- MACC_NMC mode: do not output hourly

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th March 2015 Peter  2971

adv_vert_fourth, 4th order Bott for the vertical routine available 
(but not used).
Only there for possible test in the future (not switch included).
Only small differences noticed for O3 (a few ppb), much less for SIA.

adv_vert_zero, also available, but give large differences, and may therefore 
still have bugs.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th March 2015 Birthe  2968

Added Gravset_ml for gravitational settling hardcoded for ash, and added
USE_GRAVSET in ModelConstant_ml and calling in Physchem_ml for this module,
but they are commented out

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th March 2015 Peter  2965

Removed a hardcoded "3" which should be METSTEP.
(does not make any difference for now, but it is easy to forget if we change
metstep one in the future) 

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th March 2015 Peter  2964

Gridded monthly timefactors can be switched on with 
USE_GRIDDED_EMIS_MONTHLY_FACTOR
in  ModelConstants_ml.f90
It uses the file ECLIPSEv5_monthly_patterns.nc and the mapping between sectors is 
defined (hardcoded) in Read_monthly_emis_grid_fac in Timefactors_ml.f90 

Careful with normalization:
A constant emission means a value of nmdays(month)/nydays in ECLIPSEv5_monthly_patterns.nc,
but when use as a multiplicative factor for tfac, GridTfac = 1.0 corresponds to constant 
emissions.

Careful with normalization 2:
The fac_emm which normally (in case ASCII factors) are used for monthly timefactors, are now used to
renormalize the monthes, in order to correct for varying number of week-ends.

The ASCII monthly factors are overwritten, i.e. not used if 
USE_GRIDDED_EMIS_MONTHLY_FACTOR=.true.

Modified:
Timefactors_ml.f90 NetCDF_ml.f90 ModelConstants_ml.f90 run.pl Emissions_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th March 2015 Peter  2963

Bug when there is no stations in the rundomain. The program crashed with error:
 NetCDF: NC_UNLIMITED size already in use
 ERRMSG: dim:station

Added two if(NStations>0)then conditions, which avoid creating and writing the 
NetCDF sites/sondes file.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th March 2015 Peter, Svetlana  2962

Dust BIC is read from a Global NetCDF file. The values have been obtained with a 
global run of the model.
The molwt as defined in the file is 200 g/mol.
The fields set here are defined in CM_BoundaryConditions.inc for IBC_DUST_f 
and IBC_DUST_c

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th March 2015 Peter, Riinu  2961

When writing nest BC on one single file, the model crashes after a long time 
(for instance 35 days), without apparent reasons. The crash occurs when the file is attempted closing, 
with the error message: "Can't open HDF5 attribute".

The time after which it crashes depends on the size of the domain and the number 
of components, but it is the same if debug options are set.

No direct solution has been found. One indirect solution is to write into a 
different file every month (or day).

Another indirect solution which is implemented in this revision, is to keep the 
file open between each component write; this is also faster.

Modified NetCDF_ml, Nest_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th March 2015 Peter, Alvaro  2959-60

NETCDF_DEFLATE_LEVEL = -1 (netcdf 3 output) was broken.
Moved a put_var for P0 after enddef.

MARS_ml more diagnostic output when  'RPMARES: not safe to divide', so that we 
can analyze what happens

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd March 2015 Peter, Agnes  2955-2958

Bug introduced in version 2927. Femis reduction for countries with code higher 
than 93 would not function if the emissions were in NetCDF.
(A conversion between country code and index was missing in Netcdf_ml)

Also the CC in RunLog was wrong

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th February 2015 Dave  2954

HEADERS added to ZCM_EmChem09ecom/EMISSPLIT/emissplit.defaults.omco
(fixed error found by Agnes)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th February 2015 Peter  2951-2953

Emissions_ml with netcdf emissions: variable names read from EMIS_FILE(iem).
NB: Names in Emis_GLOB_05.nc and Emis_TNO7.nc in $DataDir have been changed, 
so as to match names in EMIS_FILE

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th February 2015 Dave  2949-2950

For G20 but also other projects - new system which expects separate OM, EC
and REMPPM for fine and coarse aerosols.

Added

  ZCM_EmChem09ecom directory
      - has EC_OM.reactions with these new emissions
      - EMISPLIT files
      - Biomass files

  mk.GenChem has added EmChem09ecom option

WARNING:

Emissions_ml had hard-coded NC_EMIS_SPEC names, which will not work with
the new system. This needs to be altered anyway, so for now has been
commented out. CAN NOT USE cdf-fractions untuil this is fixed!!!

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st February 2015 Peter 2948

Bug from version 2943
BoundaryConditions: the allocatable arrays for O3 BC where not saved, causing 
the program to crashe sometimes at new monthes.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th February 2015 Peter 2947

Bug in trend_o3, was applied twice.
Affects runs with year_trend<1990 or  (year_trend<2000 and USES%MACEHEADFIX=false)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th February 2015 Peter 2943-6

Refactoring the GlobalBC_ml  and BoundaryConditions_ml.

All fulldomain arrays are removed and a lot of unnecessary buffer and indices.
GlobalBC_ml is not in use anymore; most of the content is moved into GetBICData, 
but with local arrays instead of fulldomain arrays.

O3 read from Logan_P.nc, which is flexible wrt number of vertical levels.
Can slightly change O3 (<0.1 ppb?) compared to earlier versions.

DO_SAHARA removed. (DUST BC will be replaced by global values in later revision)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th February 2015 Peter, Dave 2937-2942

Changes in BIC, GlobalBCs_ml :

all Latitude profiles are removed! (set to 1)

Vertical profiles implemented for IBC_HCHO ,IBC_SEASALT_f, 
IBC_SEASALT_C, IBC_SEASALT_G, IBC_CH3CHO, IBC_NH4_f, IBC_NO3_f
(were missing)

trend for O3 removed when Mace Head correction is applied for year 1990-1999

run.pl corrected for Inputs_Mar2013

ForestFire_ml with single opening of file. Some seconds saved, perhaps, for many
processors runs.

Write out which Mace Head correction is used in RunLog

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th February 2015 Dave, 2936

GlobalBCs_ml 
  Mace Head correction for 2012 corrected.... 
   if((iyr_trend==year).and.(year>=1990).and.(year<=2011))then
  
  changed to use of MH_YEAR1=1990, MH_YEAR2=2012 (for now)

Also header comments removed.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th February 2015 Anna, Peter    2933

Mace Head correction for 2012 included
 
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th February 2015 Alvaro  2930--2932,2934

ModelConstants_ml, Output_hourly:
- HOURLYFILE_ending from ModelConstants_config

Output_hourly:
- Fix bug on PMwater at SRF level, likely introduced in 2597 (June 2013).
  Output was PM25_water (ambient) instead of PM25_water_rh50.

ZD_OZONE/My_Outputs_ml:
- DEBUG_PM10 option for MACC_ENS/MACC_EVA.

Sites_ml:
- Use D2D unit conversion (f_2d%scale) for NXTRA_SITE_D2D output.

Derived_ml:
- Additional units options for COLUMN output (MISC). 
  Units can be specified in OutputConcs_config namelist
  by their unit name ('ug/m2,'molec/cm2,'1e15molec/cm2), or 
  by their keyword ('mcm2,'ugm2','e15mcm2').

Functions_ml,TimeDate_ExtraUtil_ml,ZD_3DVar/B_NMC/Util_ml,
ZD_3DVar/Analysis/DA_3DVar_ml,DA_Obs_ml,DA_Bias_ml:
- Move norm function(s) from Util_ml to Functions_ml.
- Move compare_date from Util_ml to TimeDate_ExtraUtil_ml.

NetCDF_ml,CheckStop_ml,EmisGet_ml,GridValues_ml,
ZD_3DVar/B_NMC/Util_ml,Unimod_B_nmc:
- Rename/Move check in NetCDF_ml to CheckNC in CheckStop_ml.
- Use CheckNC instead of local implementation.

EmisGet_ml,GridValues_ml:
- Explicitelly declare the variables/procuderes in use netcdf.

NetCDF_ml:
- Bug fix on Create_CDF_sondes.
  Units with spaces in the text where wrongly parsed.

Nest_ml:
- On FORECAST, use compare_date function (TimeDate_ExtraUtil_ml)
  to determine the dates/times to write out a restart/dump file.

Functions_ml:
- Remove Copyright notice as it will be added by mk.OpenSource.

GridValues_ml:
- New function coord_in_domain. Functions coord_in_domain and coord_in_processor
  are special cases of coord_in_domain.

Makefile:
- delegate 'clean' & 'modules' to 3DVar/Makefile for %-Bnmc & %-3DVar targets.

run.pl:
- Use variable $KEEP_LINKS instead of $BENCHMARK{'cleanup'} to indicate if the
  links to input files are to be kept or removed.
- CWF MAKEMODE and CWFBC for MACC EVA 2013 runs.
  
config_FORECAST.nml:
- Update NMC options.

ZCM_EmChem09/EmChem09base.species
- O3 is now a member of DAOBS group, together with NO2.
  By default, the model is set up for assimilation of NO2 and O3 observations.

ZD_3DVar/B_NMC/Unimod_B_nmc:
- Read nv from and USE_EtaCOORDINATES from namelist.nml.
- Add logical variables trimX/trimY (unused) and deltaDateHH,
  read from namelist.nml.

ZD_3DVar/B_NMC/Util_ml:
- Read vertical coordinate ('lev'/'k') according to USE_EtaCOORDINATES.

ZD_3DVar/Makefile,B_NMC/spectralcov_ml:
- remove -DDEBUG_B cpp option and #ifdef DEBUG_B code.
- temporally disable BIAS_CORRECTION.

ZD_3DVar/B_NMC/spectralcov_ml:
- Resize nstar(nex),mt(nex,nex),nt(nex,nex)
  to nstar(nxex*nyex),mt(nxex*nyex,nex),nt(nxex*nyex,nex).
- New function atan2PI to reproduce MATCH code.
  Intrinsic atan2 gives a different result.

ZD_3DVar/B_NMC/covmat_ml:
- write_stat:
  - revert to old code on PS calculation (avoid real overflow);
  - reference level for correlations (lref);
  - check nmin/nmax range.
- diagonalise_covmat
  - Resize lambda(nv),ifail(nv)
    to vt(nbg,nv),lambda(nbg),ifail(nbg).

ZD_3DVar/B_NMC/stddev_ml:
- 6-hourly NMC.

ZD_3DVar/DA_ml,DA_Obs_ml:
- New logical variable DA_DEBUG_OBS.
- Tag DA info/debug messages with processor.

ZD_3DVar/Analysis/DA_Bias_ml:
- Change default value of biasStdDev (biasData%stddev read from BIAS_PREDICTOR namelist)
  to avoid DIV0 errors on new obs types.

ZD_3DVar/Makefile.SRCS,Analysis/DA_3DVar_ml,DA_Obs_ml:
- remove unused EXT_DOMAIN,EXT_DOMAIN_INV dependecy.
- use new space conversion (x<-->chi) subroutines from chitox_ml.
- Replace array xn_adv_ex by an_bgd,an_inc pointers.
- organize re-write loops withing H_op.
- track if an observation bellong to the local domain (pidx%local).
- Additional timining items (DA_3DVar_ml).

ZD_3DVar/Analysis/chitox_ml:
- new subroutines chi_Init initalizes space conversion (x<-->chi).

ZD_3DVar/B_NMC/Unimod_B_nmc,spectralcov_ml,Util_ml,
ZD_3DVar/Analysis/DA_3DVar_ml,DA_Obs_ml,DA_Bias_ml,ufftw3_ml,chitox_ml:
- Use HERE(MSG) macro on CheckStop calls.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th February  2015 Dave     2929

utils/Rd_csvsondes.f90 - added bug fix for undefined, and UNDEF_R to make it
    clearer. Also used site and pollutant name in output files.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th February  2015 Peter    2928

NetCDF_ml, ReadField_CDF: ncFileID_given when the file is already open. 
                          The file is not closed on exit.

EmisGet_ml: ncFileID_given=ncFileID in EmisGetCdf. 
Much faster if no emissions are read (took about 0.3 seconds to open the file).
Now "all" emissions can be read in about 3 minutes (instead of 18). 

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th January  2015 Peter    2927

Completely decoupled the array index in Country_ml and the country-code used in 
emission files.
This is both more logical (you now choose for instance a country code= 1000000 without problems, 
giving more flexibility for systematicdefinitions)
and will save array sizes, since NLAND is now exactely equal to the number of countries.

It does not give exactely the same results, because there was some bugs in the earlier version.
(Russia?). Hopefully this only affected a timefactor or split.
Modified:
Country_ml
Unimod
Timefactors_ml
EmisGet_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th January  2015 Peter, Jan Eiof    2926

Possibility to get total emissions after splits and including all natural 
emissions. Units are mg/m2 (uses molecular weight of components, not only "N" etc.)
Put EmisSplit_OUT = .true. in My_Derived_ml.f90
For now put 18 splits (can be increased)
Modified:
Derived_ml.f90 
Setup_1d_ml.f90
Emissions_ml.f90
ZD_OZONE/My_Derived_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th January  2015 Dave    2923-2924

TimeDate_ml - added same_date and print_date routines

   (from ESX work, but generally useful I hope)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th December 2014 Peter   2921

MARS_ml.f90 in some situations the "IS_SAFE_DIV" got true (once encountered for 
GLOBAL run once for MACC14). It does not happen often.
This is probably because the test is done assuming that we use real*4.
We have set our "small numbers" as 1E-30, and the actcof routine contains a 
GAMA=10.0**TRM which can be as much as 1E30. 
sometimes (in combination with other small numbers) this triggers the test.

Threfore I have set: 
IS_SAFE_DIV: R4=.FALSE. (for the "MARS" case)
Which did not trigger IS_SAFE_DIV, at least in the GLOBAL case.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th December 2014 Dave   2919-2920

NB: IN-PROGRESS VERSION
  Bug mentioned below is partially fixed if USES%PFT_MAPS set to true, but
  not all implications workde out yet. Also need to add SGS, EGS for crops
  which are not dealt with by PFT_MAPS. Also need to consider use of SGS in
  Biogenics_ml

  In other words, if considering global runs, THINK and CHECK!


MARS_ml (2919)
  Crashed on 23rd May 2010 global run. Now replaced CheckStop with write-out and
  exit from routine. Needs attention? (See DSMARS lines, and nMarsErrors usage)

  
Landuse_ml
ModelConstants
config_EMEPSTD
(Other configs will need adapting!)

  DEBUG% PFT_MAPS, LANDUSE and DO3SE now use integers. Specify 1 for basic
   debug, 2 for more verbose.

DO3SE_ml
  Added gsf scaling factor to fPhenology to account (in a crude way) for EGS-SGS < 90 days.
  Removed elemental tag to allow print out.

LandDefs_ml
   Small debug output change

Sites_ml
  Set debug_1d = .false. to avoid excessive printouts.



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th December 2014 Dave   2918

NB: Bug discovered in Landuse_ml: effectivdaynumber usage gives wrong
  growing seasons. Will be fixed in next days.

AOTnPOD_ml: added SpringWheat, WinterWheat PODs
DO3SE_ml: increased MAXnSumVPD
DryDep_ml: DEBUG for DRYDEP now as DEBUG%DRYDEP
LandDefs_ml: DEBUG for LandDefs_ml now as DEBUG%LANDDEFS
Landuse_ml:
   Added initial code to read growing seasons from GAEZ-CRU system, with
    VEG_2dGS, Veg_2dGSparams from config
   DEBUG for Landuse_ml now as DEBUG%LANDUSE
   Added initial code for SpringWheat, WinterWheat
   Added some extra debugs while chasing effectivdaynumber bug
ModelConstants_ml
   Moved DEBUG as decribed above
   Added VEG_2dGS, Veg_2dGSparams for config
MosaicOutputs_ml
   Added LAI as one of the MOSAIC_METCONCS array (gives e.g. LAI_GR - exposes bug very well
   near equator!)
   DEBUG for MOSAICS now as DEBUG%MOSAICS
My_Derived_ml 
   Added MMC_LAI
   Added PODs for SpringWheat, WinterWheat PODs
   (should all be moved to config!)
   More MET_LCS to get LAI while chasing bug 
StoFlux_ml
   DEBUG for STOFLUX now as DEBUG%STOFLUX


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22nd December 2014 Peter  2916

Emissions can be reduced according to a mask file. The mask file must be of the same
size as the native emissions (i.e. not necessarily the same as model grid).

Usage:
in ReadField_CDF the following optional variables can be set:

     Mask_fileName,Mask_varname,Mask_Code,NMask_Code,Mask_ReducFactor

  !Mask_fileName -> name of the file
  !Mask_varname -> name of the variable used for mask ,
  !Mask_Code(1:NMask_Code) -> values from the mask_value for which to apply 
  !the reduction (reduction is applied if any of the Mask_Code=Mask_value)
  !NMask_Code -> size of the array Mask_Code with defined values
  !Mask_ReducFactor -> multiplicative factor for reduction where mask applies


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22th December 2014 Alvaro  2914,2915,2917(Log.changes)

Sites_ml,NetCDF_ml:
- Rewrite siteswrt_surf, siteswrt_sondes, siteswrt_out (Sites_ml), 
  Create_CDF_sondes & Out_CDF_sondes (NetCDF_ml), so the station meta-data 
  can is stored on variables instead of attributes.
- Instead of using multiple arrays for attribute names and values for each 
  attribute type (string/integer/real), use string arrays to hold all
  meta-data.
- Global attributes and station meta data are collected on MetaData array, and
  variables names attributes (long_name, units, _FillValue) on SpecDef array.
  MetaData and SpecDef are phrased on Create_CDF_sondes to retrieve the information.
- Special care is taken to match variables and _FilValue types.

Units_ml:
- Correct mcm2 (molec/cm2) and e15mcm2 (1e15molec/cm2) definitions.
  This units do need to be further multiplied by roa to complete the conversion.

config_BM-EECCA.nml:
Following changes on config_EMEPSTD.nml
- Remove unused DEBUG%GLOBBC and DEBUG%HOURLY_OUTPUTS
- Add USES%PFT_MAPS 
- Set EMIS_OUT=F and need_poll=F

Convection_ml,Derived_ml
- Remove unused INCLUDE 'mpif.h' statement.

MassBudget_ml:
- Add comment about "use mpi" statement.
- Remove unused MPI variables.

run.pl,Makefile:
- Write svnversion to .version with `make version`,
  so run.pl has access to version number in vilje compute nodes.
- Keep linked files on BM runs
- Reduce the FORECAST/HINDCAST threshold from 10 days to 6 days for MACC-ENS/EVA.
- Increase MPI_BUFS_PER_PROC on vilje runs

Makefile:
- Use `nc-config --cflags` (only include paths)
  instead of `nc-config --fflags` (include paths and optimization options)
  to avoid possible incompatibilities with options on OPT_FLAGS or DEBUG_FLAGS
- Move -cpp $(DFLAGS) from line 15 to line 71 so they are available to all
  supporeted machines/compilers

Derived_ml:
- Use to_molec_cm3 instead of to_number_cm3 (same constant) to improve readability.

CoDep_ml,DryDep_ml,Convection_ml,OutputChem_ml,GridValues_ml,BoundaryConditions_ml,
Setup_1d_ml,DO3SE_ml,Io_Progs_ml,Volcanos_ml,EmisGet_ml,Landuse_ml,Derived_ml,
Emergency_ml,Wesely_ml,LandDefs_ml,Rsurface_ml,ZD_OZONE/My_Outputs_ml:
- Replace '/**' in comments by '***', as they cause an error for gfrtran -cpp.

CoDep_ml,BoundaryConditions_ml,DO3SE_ml,Io_Progs_ml,Volcanos_ml,
Wesely_ml,Rsurface_ml,Sites_ml:
- Remove Copyright notice as it will be added by mk.OpenSource.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

18th December 2014 Peter, Massimo  2913

Additional "if" that allows to use WRF metdata directly from WRF output.
Experimental. Needs to be developed. Should not influence other runs.

MetFields_ml
GridValues_ml.f90
NetCDF_ml.f90
Met_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th December 2014 Peter, Dave, Svetlana  2911-2912

Test versions of MARS. We have now:

MARS_2900 : version that we had up to now
GEOSCHEM : GEOSCHEM version. NB: this version is not continuous
MARS : Small (?) improvements compared to MARS_2900. Complete list of improvements:
1) TSO4 = MAX( FLOOR, TSO4  ) 
2) IF ( fRH .LT. 0.01 ) -> return original values
3) if( (TSO4 <= MINSO4 ) (instead of "<")
4) IF ( .NOT. ( IS_SAFE_DIV( GAMAS2, GAMAS1*GAMAS1*GAMAS1, R4=.TRUE. )& 
                 .AND. IS_SAFE_DIV( KNA, GAMANA*GAMANA, R4=.TRUE. ) & 
                 ) ) THEN
                WRITE(6,*) 'RPMARES: not safe to divide...exit'
               call CheckStop("UNDER/OVERFLOW in rpmares (MARS)")

5) IF (HPLUS <= 0d0)-> return original values    
6) MHSO4 = MAX( 1.0d-10, MHSO4 ) 
7) if(abs(GAMANA)<FLOOR  .or. abs(GAMAS1)<FLOOR) -> return original values
8) ASO4_Low = MSO4 * WH2O * MWSO4 !pw added after [rjp, 12/12/01]
9)  after 1601      ASO4_Low = TSO4 * MWSO4    ! PW after [rjp, 12/17/01]
(8) and 9) showed no effect in a 1 month test) 
10) ANH4 = NH4, GNO3 = HNO3 if((TSO4 <= MINSO4 ) .and. (TNO3 < MINNO3)), and under IF ( TNO3 <= MINNO3 )
11)removed if( XXQ > 1.0e-30 )  (introduced 2907) . NB: XXQ always <0!

One month run (June, EECCA) showed a max difference of 0.15 ug/m3 for SIA 
and much less in random places.(new MARS-GEOSCHEM)

Between "new" and "old"(2900) MARS the SIA differences were less than 0.01 ug/m3 at max.

In addition small (?) change in awater in MARS_Aero_water_ml when x < 1.9999
Y2     = ( 1.0 - MFSSO4 ) / MFSSO4
(MARS_2900 use also the new version of awater)


AerosolCalls.f90 adapted for allowing "MARS_2900" and "GEOSCHEM"
config_EMEPSTD: adapted comments for AERO%EQUILIB
ModelConstants_ml: character(len=15) :: EQUILIB  (was only len=5, too small)

Netcdf_ml: sondes.nc, positive = "up"

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th December 2014 Dave,  2908-2909

Start of Isorropia 2.1 capability. Files added and/or modified to work towards
usage of Isorropia aerosol thermodynamics code

new files:

isocom.f90
ISOFWD.f90
isorev.f90
isrpia.inc

Changes in:

AerosolCalls - cleaner interface (switches between MARS, EMEP, EQSAM, ISORROPIA
 now done here, not in RunChem)
 My... routines renamed to emep2... routines (eg emep2MARS)

Runchem_ml - now just calls  AerosolEquilib instead of My_MARS etc.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th December 2014 Dave,  2907

BUG and CRUDE fixes :-(

1) BUG fix:

DryDep_ml 

  Vds for nitrate -  new equation from 2894 had wrong formulation.

2) CRUDE fixes for MARS

AerosolCalls

  Added FLOOR2 = 1.0e-9 #/cm3 as min conc. on input. Not nice, but with 90% of all
  crashes coming from the MARS module we need to do something.

  WILL TEST WITH SMALLER VALS to make sure this isn't too important. As noted below,
  the current codes are in-development.

MARS_ml:

  if( XXQ > 1.0e-30 ) then!CRUDE FIX
             RR2 = CC / XXQ
  else
             RR2 = 1.0e30 !CRUDEVIX
  end if
  (was just RR2 = CC / XXQ, which crashed and crashed...)

WE NEED TO DROP MARS!


CheckStop - slightly more informative ERROR message

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th December 2014 Dave,  2906

ZD_OZONE/My_Aerosols renamed to AerosolCalls.f90 in main dirctory - no need
for "My" treatment now that the AERO stuff in the namelist makes all choices.
(By the way, that module didn't have a "private" statement. All modules should
 have that.)

One fewer "special" My file :-)

Related changed in:

 AerosolCalls - change of name, and added private for safety
 Makefile     - no need for ZD_OZONE/My_Aerosols
 Makefile.SRCS 
 RunChem_ml
 
  
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th December 2014 Dave,  2905

AERO% created as namelist variable, contains NSIZE, EQUILIB, diam, etc., plus Vs
(enables faster switch from MARS to othe schemes.)

AERO Changes in:

 - Aero_Vds_ml - SettlingVelocity now elemental
 - Derived_ml
 - DryDep_ml
 - ModelConstants_ml
 - RunChem_ml

Plus tidy-ups in:

 - EmisGet_ml
 - NetCDF_ml - more use of MasterProc

Extra print ut

 - GridValues - some prints to figure out south pole stuff (unfinished)

Corrected text in

utils/Rd_emepcdf.90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th December 2014 Dave,  2904

Partial reversion to avoid pre-processing, and to enable compilation om stallo:

Makefile - removed VERSION

run.pl - added result of svnversion to runlabel2

MassBudget_ml - had to modify MPI stuff to enable compilation. (Not sure why)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th December 2014 Peter, Jan Eiof 2903

Sites_ml.f90
Bug in NetCDF sondes output:
The name of the sondes-components got the names of the sites-components.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th December 2014  Alvaro 2902

Derived_ml:
- Explicitly set unitscale, unittxt and volunit for SHL output,
  as they are NOT supported by Units_Scale (Units_ml)
- Allow all units supported by Group_Units to be used on group_calc.
  Use needroa optional output on Group_Units to determine when to multiply
  by density

Units_ml:
- Declare explicitly when a supported unit should be treated
  as PPB class by Derived_ml (unit_map%volunit).
- Declare explicitly when a supported unit needs to be multiplied
  by the air density to complete the unit conversion (unit_map%needroa).
- Return unit_map%volunit and unit_map%needroa as optional output on
  Group_Units, Group_Scale and Units_Scale 

ModelConstants_ml,Units_ml,Output_hourly:
- Rename MFAC to to_number_cm3 and move it from ModelConstants_ml to Units_ml.
- Move atwS, atwN from ModelConstants_ml to Units_ml.
- Remove unused atwPM variable.

ModelConstants_ml,PhysicalConstants_ml,
Sites_ml,MassBudget_ml,DryDep_ml,Aqueous_n_WetDep_ml,Setup_1d_ml,
ZD_OZONE/My_Outputs_ml:
(got random values)
NetCDF_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th November 2014  Dave   2894  - still v4.6gamma if needed.

NOTE: MORE CHANGES IN RESULTS!!!!

DryDep_ml.f90  - added no3nh4 ratio and usage
Wesely_ml.f90  - added CDDEP_PMfNH4 and CDDEP_LASTPM
ZCM_EmChem09/EmChenm09base.species - used CDDEP_PMfNH4 for NH4_f

Corrected bug in NH4 deposition (it was all depositing at the faster NH4NO3 rate, 
 whereas (NH4)xSO4 should deposit as SO4. See no3nh4ratio in DryDep_ml
 Needed new assigment CDDEP_PMfNH4

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th November 2014  Dave   2893  - new label v4.6gamma if needed.

NOTE: CHANGES IN RESULTS!!!!

This is the first in a series of changes that will modify results. Next
change will be bug-fix for PM deposition. Then hopefully coarse nitrate
and something with stratospheric O3, etc.... 


NO2 bias changed from 10 to 6 for 2008 BM. Small changes for secondary components.

Added USE_SOILNO test to see if "no2fac" should be activated.

The intention was that no2fac reduces NO2 deposition for low NO2 (< 4ppb), which
is a crude way to mimic expected soil NO emissions. However, when we have
explicit emissions, no2fac should not be used.

SO: rv4.5 series below.....
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th November 2014  Alvaro 2892

Derived_ml,ZD_OZONE/My_Derived_ml:
- Remove "2D implies 3D" behaviour, simplify code and streamline usage.
  Before 2888 a "3D" output request implied a "2D" request
  with the same temporal resolution.
  From 2888 "2D" and "3D" could be requested with different temporal resolutions,
  as long "2D" was requested before "3D".
  Now "2D" and "3D" need individual requests, one each.
- Add warning messages (PrintLog) for Unsupported (Not coded yet) outclass/outtyp/outdim

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th November 2014  Semeena (commited by Peter) 2891

Derived_ml.f90, ZD_OZONE/My_Derived_ml.f90
Short lived species output 

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th November 2014  Alvaro, Peter, Svetlana 2888-2890

Derived_ml.f90 and My_Derived_ml.f90 are fixed for writing out the same 
parameter in 2d and 3d, and also at different time resolutions 
(e.g. daily 2d and monthly 3d)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th November 2014  Alvaro 2887

ForestFire_ml,config_FORECAST.nml:
- Add 3 logical variables read trough Fire_config: need_file, need_date, need_poll.
  If .true. the model will crash when the file/date/pollutant is not found (default).
  For "skip pollutant if not found" behaviour (2634--2882),
  required for FINN 2012 emissions, set in Fire_config (config_*.nml):
    need_file=T, need_date=T, need_poll=F, 
- Replace dependency to FORECAST variable.
  "Skip file|date|polutant if not found" behaviour by setting (config_FORECAST.nml):
    need_file=F, need_date=F, need_poll=F, 

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th October 2014  Peter 2886

Femis working for NetCDF-fractions emissions.
Mask put in place but not tested.

EmisGet_ml.f90 Emissions_ml.f90 NetCDF_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23rd October 2014  Peter; Massimo 2885

TimeDate_ExtraUitls_ml.f90

bug in our Time_Date library:
1412125200 seconds corresponds to 1st October 2014 01:00
but nctime2idate(ndate,1412125200) will return a date with hour=0; 
because it compute seconds = 3599.99999, but these are not returned.

Superficial fix this by putting  
ts%secs=nint(ts%secs) in  secs1970_to_int.

This is just correcting this particular case. Somewhere deep in the method there is still a 
flaw with an improper mixing of real and int. Not nice to know that this can happen at anytime.

Probably no consequences, because we do not use "seconds since 1970" for many years.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22th October 2014  Peter 2884

Set USE_EtaCOORDINATES=.true. as default.
Should now work in any case.
GridValues_ml.f90: changed the setup for eta_coordinates.
Now eta_coordinates can be choosen as output, even if sigma are used in meteo.

(also the potential problem when nlevels is 20 mentioned in rv 2879 is solved.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22th October 2014  Alvaro 2882,2883

NetCDF_ml
  Fix minor bug on ReadField_CDF introduced on 2634:
- When a variable was not found in file (e.g. due a stallo disk hiccup)
  UnDef_local was used before definition (line 2449 Rvar=UnDef_local).
  Then, the model crashed if compiled with DEBUG=yes.
- Move UnDef_local assignment before nf90_inq_varid call.
- Restore "if(needed) STOP" behaviour lost on 2634.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th,17th October 2014  Alvaro 2880,2881

ForestFire_ml
- Add fire_year to Fire_config namelist, missing on 2878.
- Fix bug introduced on 2878. MODE="MONTHLY_AVG" gave wrong output.
- Calculate yearly averages from available records if MODE="YEARLY_AVG".

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th October 2014  Peter 2879

run.pl:
link always to Vertical_levels.txt. This used to work only for meteo files in 
new format.
removed link to GridDef.nc (nobody used it)

GridValues_ml: 
Avoid reading Vertical_levels.txt if another than 20 levels are found in the meteo file.
(this might be a problem only if there are 20 levels in the meteo file, but 
another number is wanted. Not likely to happen often)

Trajectory_ml: default month 16 to avoid unnecessary MPI communication

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th October 2014  Alvaro 2878

ForestFire_ml
- Read time records instead of assuming 1-record/N-day structure.
- Implement persistence of forest fires. This is relevant for FORECASTS,
  or when no record can be found for current_date.
- Simplify GFED reading using 8-day persistence.
- Calculate monthly averages from available records if MODE="MONTHLY_AVG".
- Read config param from Fire_config namelist:
    MODE          "DAILY_REC" (default) || "MONTHLY_AVG"
    verbose       debug verbosity 0,..,4
    persistence   fire persistence in days (default GFED=8,FINN=1,GFAS=3)
    fire_year     override current year
    GFED_PATTERN  GFED path/file pattern
    FINN_PATTERN  FINN path/file pattern
    GFAS_PATTERN  GFAS path/file pattern

run.pl,ModelConstants_ml,config_EMEPSTD.nml,config_BM-EECCA.nml,
config_FORECAST.nml,config_EMERGENCY.nml,config_IMPACT2C.nml
- File pattern for forest fire emissions (GFED,FINN,GFAS)
  to be read in Fire_config namelist.
- Replace USES%MONTHLY_FF (ModelConstants_config) for MODE (Fire_config).

NetCDF_ml
- ReadTimeCDF will read all time records, when TimesInDays<1 on input.

Makefile
- Implement `make MACC-3DVar clean`

ZD_OZONE/My_Outputs_ml.f90
- Add DEBUG_PBL logical variable for additional output on FORECAST mode.

Nest_ml
- Fix typo/bug introduced on 2876

Emissions_ml
- allocate *glob*land variables on .not.MasterProc (with size 1),
  as required for DEBUG=yes options

Emissions_ml,ForestFire_ml
- Remove Copyright notice as it will be added by mk.OpenSource.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th October 2014  Alvaro 2877

Nest_ml.f90
  add "longitude", "latitude" and "level" to the list of recognised i, j & k
  dimensions on init_nest. Use new get_dimLen function on init_nest to obtain
  the dimension lenght given a list of possible dimension names.

run.pl, config_FORECAST.nml
  On FORECAST mode:
- Switch between MOZIFS and CIFS BCs according to date.
- Implement 0-DAY forecast (1 time step) for development/debugging.
- Use IC and BC files pattern on Nest_config namelist, see template_*
  in config_FORECAST.nml.

config_FORECAST.nml
- Add CIFS BCs description (IFS_CMP_g4e2).
- Rename IFS-MOZART description fo distinguis between MACC_ENS and MACC_EVA
  settings.
  
ExternalBICs_ml
  Asume IFS_CMP_g4e2 from 2014-09-18 for EXTERNAL_BIC_VERSION="MACC_ENS"

Units_ml
  Add "kg kg**-1" units support on Units_Scale

Unimod
  Skip call wrtxn at the end of the run on FORECAST mode.

Makefile
  Use `nc-config --flibs --fflags` to get linking flags (LDFLAGS).

ZD_3DVar/Makefile,Makefile.SRCS
- FFTW3 setup for stallo
- Cleanup MKL setup for stallo & villje.
- Add DA_Bias_ml.f90 to SRCS.3DVar

ZD_3DVar/B_NMC/spectralcov_ml
- Set parameter DAPREC (used on m1qn3 settings) so 1/real4 remains real4.
  This is consistent with accuracy on diagonalise_covmat.

ZD_3DVar/Analysis/DA_3DVar_ml
- Use ES12.3 format on debug printout.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th October 2014 Peter, Alvaro 2876

Bug in nesting, when the read frequency (NHOURREAD) is not equal to the BC-file 
frequency.
In old versions this worked, but has been destroyed some time in the beginnging 
of 2013?

put "date_nextfile" for both Forecast and normal case:
  filename_read_BC=date2string(template_read_BC,date_nextfile,debug=mydebug)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th October 2014 Birthe (Peter) 2875

Bug for grid resolution between 61 and 76 km, dt_advec was not set.
Advection_ml:  dt_advec=1800.0 for resolutions coarser than 61km

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th September 2014 Peter 2874
JUMPOVER29FEB can be set true in config file, and the 29th of February will 
be jumped over. This is to be used in the case where it is not available in a 
leap year (typically climate runs).
Note that this is difficult to do this in a 100% consistent way: date are 
everywhere and used through TimeDate_ml libraries. For instance the number 
of days in a leap year will still be 366, even if the 29th is jumped over; 
therefore some diagnostics values may be wrong.
Met_ml.f90
PhyChem_ml.f90
ModelConstants_ml.f90

utils/meteoPreProc.f90 modified to allow leap years with 365 days.

Small change in NetCDF to avoid compielr error in debug mode.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th September 2014  Alan  2872

ZD_ESX/D_Misc/GenChem.py:
  - Remove deprecated 'rcbio:' support
  - Always process 'rcemis:' rates

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th September 2014 Alvaro 2869-2871

InterpolationRoutines_ml
- New subroutine point2grid_coeff takes care of the inner loops of grid2grid_coeff.
- Consilidate Weight1,..Weight4(NX,NY) output variables on grid2grid_coeff
  into a single output variable Weight(4,NX,NY), and update dimensions of output variables IIij,JJij(4,NXG,NYG).

InterpolationRoutines_ml,NetCDF_ml
- Update grid2grid_coeff calls and IIij,JJij,Weight variables on
  Nearest4interp (InterpolationRoutines_ml) and ReadField_CDF (NetCDF_ml).

Nest_ml
- call grid2grid_coeff on init_nest instead local (equivalent) code.
- Update IIij,JJij,Weight variables on init_nest, read_newdata_LATERAL and
  reset_3D (Nest_ml).
- Bug fix on readxn. Avoid div0 on time weights calculation (lines 282--288).
- On FORECAST mode, set filename_read_3D and filename_read_BC using ndate for 
  correct debug messages

CheckStop_ml
- Add CheckStop_range subroutine to CheckStop interface.
  CheckStop(var,(/vr0,vr1/),msg) will stop the model if .not.(vr0<=var<=vr1).

TimeDate_ExtraUtil_ml
- add text keys "PPP" and "PPPP" to output processor number (me) from
  date2string interface (function cd2str).

Par_ml,ModelConstants_ml
- Add variable DOMAIN_DECOM_MODE (ModelConstants_ml) to be read on ModelConstants_config.
- On subroutine parinit (Par_ml), when DOMAIN_DECOM_MODE is set by the user
  it will override the default domain decomposition mode based on Pole_singular.

Timing_ml,Unimod,PhyChem_ml
ZD_3DVar/My_3DVar_ml,Analysis/DA_3DVar_ml
- Add parameter NTIMING_UNIMOD (39) and NTIMING variable (Timing_ml)
  to keep track of the "standard Unimod" time tracking indices (hard coded trough Unimod)
  and the total number of time tracking indices.
- Add optional input ntim to subroutine Init_timing (Timing_ml).
  If present, this variable can be used to increase (or decrease) the number of
  time taking indices (39 by default).
- On subroutine Add_2timing (Timing_ml) ensure that only time tracking indices
  are accessed (return if .not.(1<=n<=NTIMING)).
- Add parameter NTIMING_3DVAR=0 on for non 3DVar runs (My_3DVar_ml)
  and NTIMING_3DVAR=8 for 3DVar runs (DA_3DVar_ml)
- call Init_timing(NTIMING_UNIMOD+NTIMING_3DVAR) on Unimod, to allocate
  NTIMING_3DVAR time taking indices for 3DVar usage.
- call Add_2timing(T_3DVAR,..) on PhyChem_ml for total 3DVar usage on ANALYSIS runs.

Makefile
- Extend DEBUG=yes options from -check bounds (-CB) to
  -check all -check noarg_temp_created 
- Change order between My_*.f90 file dependency and linking, so .depend target
  options are correctly displayed.
- Remove -j4 option from $(MAKE) call, as this option is already set on run.pl

Makefile.SRCS
- Define SRCS only if not already set (SRCS ?=), so .depend target
  options are correctly displayed.
- Add Pollen_const_ml.o dependency to My_Pollen_ml.o
  so pollen_const_ml.mod is up to date.

NetCDF_ml,
- Fix DEBUG=yes error on CreatenetCDFfile, xcoord loop lines 743--748.

ZCM_EmChem09/BiomassBurning_GFASv1_to_EmChem09.inc,
ZCM_EmChem09soa/BiomassBurning_GFASv1_to_EmChem09soa.inc
- Fix DEBUG=yes error, wrong NEMEPSPECS.

InterpolationRoutines_ml,NetCDF_ml,Nest_ml,CheckStop_ml,Par_ml,PhyChem_ml,Timing_ml
- Remove Copyright notice as it will be added by mk.OpenSource.
- Minor formatting changes.

ZD_3DVar/Analysis/DA_3DVar_ml
- Use parameters to designate the index and text of time traking indices,
  eg Add_2timing(T_3DVAR,..) instead of Add_2timing(47,..)
- Rename logical variable calculate_chisq to use_chisq 
- Replace compilation flag NO_UPDATE_UNOBSERVED by logical variable use_unobserved.
- Read use_chisq, use_unobserved variables and m1qn3 paremeters maxiter,maxsim
  on DA_CONFIG namelist.
- Reduce m1qn3 progress output and write it to a separate log file for each processor.

ZD_3DVar/Analysis/DA_Obs_ml
- Add interpolation_method variable, to be read on OBSERVATIONS namelist.
- Use interpolation_method in call to get_interpol_const (subroutine H_op).
- Add input variable method to subroutine get_interpol_const:
  'distance-weighted' method calls point2grid_coeff (InterpolationRoutines_ml);
  'nearest-neighbor' methods also calls point2grid_coeff, but only uses the 1st value;
  'local' method calls a local implementation of point2grid_coeff for test/debuging.

ZD_3DVar/Makefile,Analysis/DA_3DVar_ml,DA_Bias_ml
- Temporary disable bias correction (DA_Bias_ml)

ZD_3DVar/Makefile,Makefile.SRCS,
ZD_3DVar/Analysis/ufftw3_ml,chitox_ml,
- Add linking options for FFTW3 library.
- Add FFTW3 util/wrapper module and FFTW3 based subroutines (chitox_ml).

ZD_3DVar/Analysis/DA_3DVar_ml,DA_Obs_ml
- Use FFTW3 variables and methods provided by chitox_ml.
- Remove unused output variable iostat from subroutine read_obs.
- Remove OLD_MATCH_CODE & old commented code.

ZD_3DVar/DA_ml.f90,Analysis/DA_3DVar_ml
- Add DA_NAMELIST parameter (DA_ml) for the name of the DA namelist file.

ZD_3DVar/B_NMC/spectralcov_ml.f90
- Set parameter DAPREC (used on m1qn3 settings) to single real precision.
  Previous setting was unrealistically low.

ZD_3DVar/B_NMC/cplx_fft_2d.F
- Fix bug on eliptic truincation reported by Arjo Segers.

ZD_3DVar/Makefile,Makefile.SRCS,
ZD_3DVar/B_NMC/quicksort.c,
ZD_3DVar/Analysis/chitox.F,chitox_adj.F
- Remove obsolete subroutines quicksort (C version) & chitox*.F (based on FFTpack5).
- Remove no longer needed compilation rule for C (%.o:%.c).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th September 2014  Alan  2868

ZD_ESX/D_Misc/GenChem.py:
  - Add some line wrapping to ChemRates output

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20th August  Alvaro 2867

mk.GenChem: Bug fix for eEMEP.
  Historical eruption data (V*.eruptions) on ZCM_Emergency/
  was appended to emergency_location.csv instead of emergency_emission.csv.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th August  Peter, Massimo 2866

NetCDF_ml: "mass conservative" interpolation from general projection improved
(when model resolution has fine resolution).
Not 100% robust: may not always work well when the interpolated data is not 
approximately aligned with lon-lat.
Tested by Massimo for "Amersfoort" projection (1km resolution) to 1km resolution.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st August  Alvaro  2863-2865

Data assimilation with variational bias correction.

Makefile, ZD_3DVar/Makefile
- export variables to submake
- use nc-config to set appropriate LDFLAGS
- split .depend and depend targets
- use GenChem-MACCEVA-EmChem09soa for MACC-Bnmc MACC-3DVar targets,
  instead of bouilding MACC target.
- modulelist/modules targets to use/show LOADEDMODULES environment variable

ZD_3DVar/Makefile.SRCS, Analysis/DA_Bias_ml, DA_3DVar_ml, DA_Obs_ml
- New module DA_Bias_ml for variational bias correction.
  Enabled by -DBIAS_CORRECTION compilation flag.
- Add number of valid observations (nobs) to obsData array (obs_data type).
- Move set-up of obsData array from subroutine H_op to read_obs.

run.pl:
- Re-implement "month trimming". The day of the Start/End of the run
  are adjusted so they do not exceed the length of the corresponding month.
- Ensure all met files are present before starting the simulation.

TimeDate_ExtraUtil_ml:
- Prevent formatting errors on *2string functions by setting negative
  values to zero on ?key2str functions.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 and 23 July 2014 Peter, Jan Eiof, Dave 2862

FastJ_ml: 
put USE_FASTJ=.true. in ModelConstants_ml and fastj is used for photolysis rates.
Need also to link a few data files from run.pl

Added FastJ_ml.f90
modified: ModelConstants_ml, Runchem_ml, DefPhotolysis_ml, Met_ml, Makefile.SRC

First work version. A lot should be revised and upgraded and tested!
In particular:
.-mapping of photolysis rates
.-components should be synchronised with GenChem (or similar). Hardcoded now
.-interpolating functions should be systematically reviewed
.-cloud ice and water 
.-Idiffuse Idirect can be provided for surface
.-aerosol = 0 for now
.-reflectivities must be provided (basic default from fastj used now)
.-probably much more

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th June - 10th July 2014  Dave  2853..2859

  Tidy ups - removed commented out !CMR lines from some modules. These were
   from the older GenChem system with separate modules.

  ZD_ESX changes - added mk.testESXmods and Radiation_ml to demonstate.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th June 2014  Alan  2842-49

ESX changes only.

ZD_ESX/D_Misc/GenChem.py:
  - Generate WetDep, DryDep, AerExt and emis outputs.
  - Add reaction species checking.
  - Add reaction balance checking.
  - Handle RO2POOL.
  - Resolve some TODOs.

ZD_ESX/ZCM_{EmChem09,EmChem09soa}_py/*:
  - Fix a couple of malformed reactions (discovered by reaction species
    checking).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th June 2014  Alvaro,Birthe  2838-2841

Emergency_ml
  - Emission definitions (erupdef) are not allocatable, so is it possible
    to have more than 2000 releases (NMAX_ERUP) without compilation issues.
  - If a timestep starts at the end of the release (END code),
    it wont be taken as part of the release.
  - Ensure that the release time is at least 1 advection time step.
  - A "1-puff" emission [Kg] can me set with D="1DT".
    For a longer release, the total emission  [Tg] can be set with D="TOTAL".
    Default behaviour is emission rate [Kg/s].

Derived_ml,Units_ml
  - Rename subroutine uggroup_calc group_calc (Derived_ml)
    and extended to handle ppb, ppbC, ppbN & ppbS units for groups.
  - Add support for ppbC, ppbN & ppbS units (Units_ml)

Changes implemented over current MACC-ENS forecast version (2708--2716)
for MACC-EVA 2012 runs

config_FORECAST.nml,config_BM-EECCA.nml,config_Outputs_EMEPSTD.nml
  - Correct typo on MACC_EVA BCs
  - Correct typo on commented output

Makefile
  - Add MACC-EVA & MACC-NMC compilation targets

ZD_OZONE/My_Outputs_ml.f90
  - Hourly output definition for NMC runs

run.pl
  - $MAKEMODE, $CWFBC and $RESDIR for EVA & NMC runs

ZD_Pollen/Pollen_ml,Pollen_const_ml,My_Pollen_ml
  - Include Sub array from SubMet_ml, previously from LocalVariables_ml.
  - Correct typo on first_call variable name

ZD_3DVar/Makefile,Makefile.SRCS
  - Force DA_ml.o compilation
  - Update SRCS.Bnmc

ZD_3DVar/Analysis/DA_3DVar_ml,DA_Obs_ml
  - Optional chi^2 calculation, controlled by calculate_chisq variable
    read from DA_CONFIG namelist.
  - Write number of observations found in each ObsData file to RunLog

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th June 2014  Alan  2837

ESX changes only.

ZD_ESX/D_Misc/GenChem.py:
  Remove #SLOW handling of slow advected species (now an error).

ZD_ESX/ZCM_{ESX_r12,EmChem09,EmChem09soa}_py/*:
  Make copies of some chemical schemes and replace #SLOW with setting adv=3
  to test GenChem.py.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th June 2014  Alan  2827-2836

ESX changes only.

ZD_ESX/D_Misc/GenChem.py:
  Generate CM_ChemRates.f90, CM_Reactions1.inc and CM_Reactions2.inc from
  GenIn.reactions.  A bit of refactoring to remove code generation concerns
  from chemical scheme reading.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

5th June 2014, Dave, 2824

ESX changes only.

ZD_ESX/esx_Zmet - extra Kz output
ZD_ESX/esx_DO3SE - uses odir for output Log
ZD_ESX/esx_Variables - more checks on z_bnds and DiffSpecs, OutSpecs
ZD_ESX/esx_tester - some more comments, pcm3_to_pm3 replaces chem2Kz_units

**NEW** scripts directory added

  added fmkmf - now original script from Univ. Edinburgh, replaces makegf90
  mk.Makefile - does same job as older mk.makegf90, but using fmkmf
  mk.docESX moved here

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5 June 2014  Peter  2823

Bug in cloudwater! It was read as a 2D field.
Introduced at version 2693.
Does make the 3D precipitations derived from 2D precipitaions fail.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxx   USED for SR June 2014 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxx   tag  rv4_5  (=2822)   xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

4th June 2014 Semeena, 2820-2821

ZD_SR/My_Derived_ml.f90 - Updated according to the changes in namelist for SR runs

Derived_ml.f90  - Include daily and monthly outputs also for SR mode which makes
it easy for debugging. !SVS 22May2014

config_Outputs_EMEPSR.nml -  New namelist for selecting variables for SR output

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 May 2014  Alan  2813-2819

ESX changes only.

ZD_ESX/D_Misc/{GenChem.py,ordered_set.py}:
  Started work on reading GenIn.reactions, implemented most of the replacement
  for define_rates.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st May 2014  Dave   2812

ESX changes only - use of odir in esx plot outputs, minor stuff

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th May 2014  Robert/Dave/Peter (via Svetlana)   2808/9

My_SOA_ml.f90 - Backgroung level of OC (BGND_OC) is reduced from 0.5 to 0.2 ugC/m3

Derived_ml.f90 - Irritating check print *,"COLUMN TEST subclass " is out

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th May 2014  Svetlana   2804/2805

Aero_Vd_ml.f90 - MMD for coarse sea salt is set to 4.8 um (from 4.0)
GlobBCs_ml.f90 - boundary conditions for sea salt are decreased to more 
                 reasonable values (from comparison with observations)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th May 2014  Peter   2803

Meaningfull error message when two sites or sondes have the same name.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th May 2014  Peter, Birthe   2802

Solver_ml.f90: error message when dt_advec < 200 seconds.
(we haven't implemented for small dt_advec, although it would be very easy to do)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd May 2014  Peter   2801

z_bnd in (Met_ml) is now updated every timestep (dt_advec), instead of
every METSTEP (3 hours).

Expected (small?) changes in results related to:
AOD_Ext
(setup_phot, only in rare cases)
COLUMN output
Emergency
ForestFire emissions
Pointsources
Rn222 emissions
Trajectory

CellMet_ml: hardcoded 20 in roa changed to KMAX_MID
     Grid%DeltaZ  = (dA(KMAX_MID)+dB(KMAX_MID)*ps(i,j,1) )/(GRAV*roa(i,j,KMAX_MID,1))


Moved call to metfieldint after vall to WrtChem() and  trajectory_in, since we do not want
to write or use metdata which has not yet been used.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd May 2014  Peter   2800

Define density (roa) from pressure and heights, so that they are consistent.
this changes roa by up to approximately 0.3% (done a simple test only).
The final results for concentrations will not change much (less than 0.1%)

Met_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30 April 2014  Peter   2799

Advection_ml: for eta coordinates, corrected bug (fluxin,fluxout) in mass balance diagnostic 
(only massbalance diagnostic, not concentrations are changed).

run.pl: uodate 2012 forestfire and 2012 EECCA emission

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29 April 2014  Dave   2795-2798

   More DEBUG moved to config:
   (All not yet written into config_EMEPSTD files. Am considering 
    leaving that for user. There are so many.)

     DEBUG%AQEUOUS
     DEBUG%DRYRUN
     DEBUG%DO3SE
     DEBUG%EQUIB
     DEBUG%pH
     DEBUG%RUNCHEM
     DEBUG%SETUP_1DCHEM

    Aqueous_n_WetDep_ml
    DO3SE_ml
    MARS_ml
    ModelConstants_ml
    My_Aerosols
    RunChem_ml
    Setup_1d_ml
    Solver_ml

    GenChem.pl - DEBUG_RUNCHEM now just DEBUG
    config_EMEPSTD.nml - some of above added


    ESX:

     AllocInit_ml now linked from Unimod

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 April 2014  Dave   2794 

  ZD_ESX changes only. Changed calls to CheckStops to CheckStop_ml, to allow
  merging of more modules with EMEP. In future, I will likely remove _ml
  from all code, but not before the summer.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25 April 2014  Dave   2780 

  COLUMN data requests  moved from My_Derived to config_Outputs, plus tidy-up
  of debug output. Changes in:

   My_Derived_ml
   Derived_ml
   ModelConstants_ml   now has DEBUG%MY_DERIVED 
   OwnData

   config_Outputs_EMEPSTD.nml


   My_Derived is rapudly approaching zero in hard-coded requests, and can
   hopefully be completely repalced by config requests soon :-)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24 April 2014  Dave   2779

  DEBUG%SPEC is now the name of the species wanted. Used so far only in
  PhyChem, but recommended for more general use. The variable DEBUG%ISPEC
  gives the index in species(:)%name that corresponds to this.

  ModelConstants_ml - DEGUG%SPEC, DEBUG%ISPEC defined. Latter calculated
   in Config subroutine. Also some cleanup.

  PhyChem - DEBUG%SPEC used in debug_conc

  Unimod.f90 - moved called define_species before Config_ModelConstants


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 April 2014  Dave   2774-2778

RESULTS change!!!!! Mainly for BSOA, but also other

BUG fix - TERPperoxy added in EmChem09.species, to ensure treatment as SHL

ZCM_vbs_tests/VBS_SOAformation.species - TERPPeroxy removed

ZCM_vbs_tests/VBS_partitoining.reactions - now HO2 and NO reactions with
    TERPperoxy set oxidant neutral (in []). (Since we don't have the 
    gas-phase chemistry to do this properly.)

ESX only. Small changes to FortranTips.txt

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 April 2014  Peter  2773

Bug in the netcdf sites output: attributes for Sites where undefined.

In addition the sondes/sites at 31st December midnight are now written in the 
previous year, instead of the next year (this was also done in the csv output).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22 April 2014  Dave   2769-2770

** NEW ** AllocInit.f90 - to encourage setting of initial values when
   allocating. Almost identical to ESX.

   Added in Makefile.SRCs, but not used yet

** Debug changes. More use of config.

  Note: DEBUG_i, DEBUG_j now replaced by DEBUG%IJ array, set through config.

  BoundaryConditions - used DEBUG%IJ
  Chem_ml 
  EmisGet  - had to change meaning of DEBUG (was => DEBUG_GETEMIS)
  Emissions - had to change meaning of DEBUG (was => DEBUG_EMISSIONS)
  ForestFire_ml, DEBUG%FORESTFIRE
  GridValues_ml, DEBUG%GRIDVALUES
  IoProgs_ml,    DEBUG%IOPROG
  ModelConstants_ml 
  PhyChem_ml,     DEBUG%PHYCHEM, now uses DEBUG%SPEC
  Unimod,         DEBUG%MAINCODE instead of DEBUG_UNI

  config_EMEPSTD.nml - DEBUG changes

  Some code had "use DEBUG_i" which wasn't used at all:

  Derived_ml
  DryDep_ml
  Landuse_ml
  Met_ml
  SeaSalt_ml
  Setup_1d_ml

 Clean-up (incomplete!)
  ZD_VBS/My_SOA_ml


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21 April 2014  Peter  2768

Bug for rho_surf in Met_ml, introduced probably (by me) 11 December 2013 (2690).
ps in still hPa instead of Pa when calculating rho_surf.
rho_surf is normally overwritten (several times!) later in the code, so this 
has no effect normally.
Only case where it has consequences, is when 'ustar_nwp' is read from metdata,
which is only used for WRF metdata.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 April 2014  Peter  2767

Makes NetCDF output of sites and sondes.

I tried first to define a new variable for each station/species pair, but this
 was very slow (double cpu time) and also the compression did not work well.
What I did not like when defining the stations as dimension, is that you have
 to first find which index correspond to which station; we have to live with that for now.

I was not able to use the string type in NetCDF (defining xtype = nf90_string
 gives the error message
 "Mapped access for atomic types only" when trying to write the strings with put_var)

We can add more attributes to the file, as required. This is hard coded now, and 
I would recommend NOT to have the attributes too flexible, i.e. to have them as
 an input to the model. This should not be changed to much by the user, so that the attribute are a sort of standard which can be trusted by scripts.

I thought it would be relatively simple, but the code in Sites_ml got a bit messy. 
Lots of small details which complicates (info available on different CPUs, surface 
pressure to add, differences between species, station and global attributes etc).

I put only the meteo path (and size) as info about the grid. We do not have the name 
of the grid (EECCA, TNO14..) directly availble in the model. We could add it some time.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 April 2014  Dave  2766

 **NEW** ChemSpecs_tmp.f90

  LOTS of routines now "use" ChemSpec from here.

  wrapper for the ChemSpecs_adv etc sub-modules, to allow
  other routines to "use ChemSpecs". Previous calls such
  as use ChemSpecs_adv removed in many routines, see !CMR comments
  (This is a step towards a simpler GenChem script.)

  Makefile.SRCS

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 April 2014  Alan  2765

ESX changes only.

ZD_ESX/D_Misc/GenChem.py:
  Process species index groups in a more generic way (remove special case for
  SOA).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 April 2014  Dave  2760-2764

  GridValues_ml     - clean up - remove commented out lines
  ModelConstants_ml - added experimental MINCONC stuff
  Setup_1d_ml       - clean up - remove commented out lines
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 April 2014  Dave  2760-2761

  SmallUtils_ml. Added to_Upper function for strings

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14 April 2014  Alan  2758-2759

ESX changes only.

ZD_ESX/D_Misc/GenChem.py:
  Some fixes in processing GenIn.species.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 April 2014  Dave   2757

    BUG fix, Mosaics_ml,  sorry.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 April 2014  Dave   2753-2756

  ESX changes
    Wesely_ml linked from EMEP
    LocalVariables_ml now uses Wesely_ml for Vg_ref etc
    Makefile changes for above
    mk.GenChem copies CM_DryDep.inc, CM_WetDep.inc 
    config - swiched plotting flag F 

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 April 2014  Dave   2752

  1) Sub array moved from LocalVariables to SubMet, to remove NLANDUSEMAX
  dependency. This module should only care about the local landuse, not
  how many there are. Change will help ESX also.

  Changes in:
    AOTnPOD_ml - now uses L not Sub. L set in Mosaics_ml
    CellMet_ml
    DryDep_ml
    Dust_ml
    GlobalBCs (Sub, Grid weren't needed anyway)
    LocalVariables_ml
    MosaicOutputs_ml
    SeaSalt_ml
    StoFlux_ml



   BUG found in experimental SPOD. No effect on normal outputs:
    AOTnPOD_ml 

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 April 2014  Dave   2750-2751

  DEBUG_AOT, DEBUG_DERIVED, DEBUG_COLUMN now moved to config DEBUG

  Changes in:
    ModelConstants_ml
    AOTmPOD_ml
    Derived_ml
    DryDep_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 April 2014  Dave   2749

  run.pl:  cdo infov run in all cases now, not just benchmarks

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 April 2014  Dave   2746-2748

   More namelisting:
  
     DDEP_ECO, DDEP_WANTED, WDEP_WANTED now specified in config_Outputs

   Changes in

     My_Derived_ml
     Derived_ml
     Aqueous_ml
     config_Outputs_EMEPSTD.nml
     config_BM-EECCA.nml

   Plus test of real(kind=dp) in Solver.f90

     Use of real(ken=dp) has no effect numerically, but is designed to move
     towards integration with other chemistry codes, e.g. KPP

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
09 April 2014  Alan  2742-2745

ESX changes only.

ZD_ESX/D_Misc/GenChem.py:
  Can now generate CM_ChemRates.f90 and CM_ChemGroups.f90 (mostly).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
09 April 2014  Dave  2741     

  Io_Progs_ml - optional io argument to PrintLog
  SmallUtils_ml - num2str expanded to integer and real versions

  ZD_ESX/

    esx_tester.f90 - some re-organisation

   Use of PrintLog routine (temporary here) and esx%odir to specify output
    directory for logfiles and results

    **NEW** in ZD_ESX
    Io_Progs - has same PrintLog routine (temporary here)as EMEPs Io_Progs_ml
       (but EMEPs Io_Progs gas many more dependencies)

    esx_Variables      - added esx%odir, more use of UNDEF_R
    esx_Zchem          - uses esx%odir
    esx_Zgrid          - uses PrintLog
    esx_Zmet           - uses esx%odir
    esx_Zveg           - uses esx%odir
    Zmet_ml            - uses esx%odir and PrintLog
    config_esx.nml     - uses esx%odir
    Io_Routines.nml    - uses esx%odir


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
09 April 2014  Dave  2736-2740

  SmallUtils_ml - added num2str function to convert 
  run.pl  - added more comments w.r.t. MAKEMODE
  Makefile.SRCS - added Precision_ml.f90

**NEW**

  Precision_ml - to enable use of real(kind=dp) declarations.
  More consistent with other codes. (We use values from KPP system.)

   (Not yet used, but quick tests in Solver_ml suggest real(kind=dp)
    produces identical output to standard runs.)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
08 April 2014  Alan  2733-2735

ESX changes only.

ZD_ESX/D_Misc/GenChem.py:
  More work on Python port of GenChem.pl.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8 April 2014  Dave  2730-2732
SmallUtils_ml - added trims to strip all blanks (even inside strings)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29 March 2014  Alan  2724-2729

ESX changes only.

Added D_Misc/GenChem.py and mk.GenChemPy in ZD_ESX:
  Started implementing Python port of GenChem.pl, copied mk.GenChem to make a
  version that runs GenChem.py instead of GenChem.pl.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25 March 2014 Heiko 2723

NETCDF_DEFLATE_LEVEL (-1 to 9) instead of NETCDF_COMPRESS_OUTPUT (T/F)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24 March 2014  Dave 2720-2721

ESX changes only:  Updates to GenChem.rst

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20 March 2014  Dave 2718, 2719

ESX changes only.

Added GenChem.rst in ZD_ESX/D_Misc as a start on GenChem documentation, to
  help Alan in conversion of ESX's GenChem.py to python. This script is
  intended for the full EMEP system in the end, but will be tested in 
  ESX first.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17 March 2014  Alvaro  2715,2716

Nest_ml,config_FORECAST.nml
  - Additional variables on Nest_config namelist to explicitly define
    which advected variables should be written to filename_write.
  - By default all advected variables will be written.
  - If WRITE_GRP or WRITE_SPC are found on the namelist,
    only the variables specified on WRITE_SPC and WRITE_GRP (group members)
    are written.
  - Remove NMC_OUTPUT variable. Functionality achieved by WRITE_SPC/WRITE_GRP.

config_EMEPSTD.nml,config_BM-EECCA.nml,config_FORECAST.nml,config_EMERGENCY.nml
  - Update comments regarding variables EXP_NAME and MY_OUTPUTS.
  - Homogenize comments and variable setting among NML files.

PhyChem_ml,Timing_ml
  Fix error on 3DVar timing.
  - '3DVar: Total' and  "'3DVar: CHI^2 evaluation.' time strings were assigned
    to timing index 46.

ZD_3DVar/Makefile
  - gFortran option for all .mod files to be kept in main path.
  
ZD_3DVar/Analysis/DA_3DVar_ml,DA_Obs_ml
  Fix errors o implementation of the chi^2 evaluation (2599).
  - The return after chisq_over_nobs2 call was never reach
    due to wrong if/else logic.
  - Wrong index on chisq_over_nobs2 calculation

ZD_3DVar/B_NMC/Unimod_B_nmc
  - deallocate(ucovmat) only if allocated

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12 March 2014  Alvaro  2714

GenChem.pl:
  - Create NMVOC group following the "recipe" found on Derived_ml, i.e.
    all advected species(:)%carbons > 0, exept CO and CH4.

ZD_OZONE/My_Outputs_ml
  - Update hourly output on FORECAST mode: additional variables and levels.

Makefile:
  - Remove Isotopes from MACC compilation targets.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th February 2014  Peter  2713

Do not recalculate etadot and sdot if etadot is read from metdata.
Met_ml.f90
run.pl CWF=0;

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th February 2014  Alvaro,Birthe  2709-2710

ZD_Pollen/Pollen_ml,Pollen_const_ml,My_Pollen_ml
  - Increased the available birch pollen amount to 1e9 grains/m2.
  - Set a heatsum condition for season end.
  - New birch pollen limiting formula, for latitudes north of 60 degrees.
  - Remove Copyright notice from My_Pollen_ml.

config_FORECAST.nml,ExternalBICs_ml:
  - Additional species for IFS-MOZ (fnyp) BCs.
  - Explicitly set the BC version name (EXTERNAL_BIC_VERSION) on
    ExternalBICs_config namelist.

run.pl:
  - Join stallo PBS commands for CPU (-lnodes) and memory (-lpmem)
    in a single line to facilitate switching between vilje/stallo.
  - Clean up BENCHMARK setings: archive option is set only once
    and remove behckmarks marked as "Candidate for removal".
  - Improve support for different met versions on FORECAST (FC) runs.
    The usage of $CWFMETV was extended so
    now 00|24|48|72 means 00UTC met starting from 00d|01d|02d|03d
    and 12|36|60|84 means 12UTC met starting from 01d|02d|03d|04d.
  - Improve IC/restart/dump file search ANALYSIS (AN) runs.
    An AN run will only start if a IC file is found. 
    When the IC file from the AN chain is not found,
    attempts are made to link a suitable IC file from one the FC chains.
  - Link PointSources.txt file only when found.

PointSource_ml:
  - Small change so BENCHMARK archive conditions can be met.

ZD_SR/My_Derived_ml,ZD_OZONE/My_Derived_ml:
  - Implement OutputConcs_config namelist on SR version.
  - Remove Copyright notice from OZONE version.

Nest_ml:
  - Add warnings messages when IC/BC varables are not found on
    their corresponding files.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th February 2014  Alvaro,Birthe  2707-2708

GridValues_ml:
  Fix error on procedure coord_check. Wrong/Unnecessary latitude coordinate range fix.
  The error propagates to functions coord_in_gridbox and coord_in_processor, giving
  wrong latitudes for emergency scenarios (Emergency_ml) with sources on the southern hemisphere.
  This error has been present since coord_check was introduced (rv4.1.6; 20th Nov 2012).

run.pl:
  add comment about $MAKEMODE=0 to avoid model re-compilation

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th February 2014  Peter  2706

Small changes:
BoundaryConditions_ml: use Logan_P.nc whenever KMAX_MID /=20. Path in run.pl
EmisGet: MPI_Barrier for nicer output
Timings: format for larger grid
GridValues: format of output
Met_ml.f90: Interpolate etadot from mid to boundary when read from metdata
NetCDF: force monotone lon in the lon lat projection 
(last lon was set to -179.75 instead of +180.25 in the GLOBAL05 grid!).  


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th February 2014  Peter  2705

Bug in Nest for eta coordinates.
The program crashed when it did not find "k" as vertical coordinate.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th February 2014  Peter  2703

EmisGet_ml.f90
Can define emission release distribution in explicit Pressure levels instead 
of model levels.

To use Pressure levels, simply add one line to EmisHeights.txt, using keyword "Plevels", see example:
stallo: /global/work/mifapw/emep/Data/inputs_emepdefaults_Jun2012/EmisHeights_P.txt

# Emissions distribution for EMEP2012 version rv4
# Has 100% SNAP2 emissions in lowest layer
# Plevels are pressure in Pa at top of corresponding levels (P Surface = 101325.0=
Nklevels 7   Vertical Levels 
Plevels 100229.1 99133.2 97489.35 95206.225 92283.825 88722.15 84521.2
1         0.0      0.00     0.15     0.40     0.30     0.15     0.00    ! SNAP1
2         1.0      0.00     0.00     0.00     0.00     0.00     0.0     ! SNAP2
3         0.1      0.10     0.15     0.30     0.30     0.05     0.0     ! SNAP3
4         0.9      0.10     0.00     0.00     0.00     0.00     0.0     ! SNAP4
5         0.9      0.10     0.00     0.00     0.00     0.00     0.0     ! SNAP5
6         1.0      0.00     0.00     0.00     0.00     0.00     0.0     ! SNAP6
7         1.0      0.00     0.00     0.00     0.00     0.00     0.0     ! SNAP7
8         1.0      0.00     0.00     0.00     0.00     0.00     0.0     ! SNAP8
9         0.1      0.15     0.40     0.35     0.00     0.00     0.0     ! SNAP9
10        1.0      0.00     0.00     0.00     0.00     0.00     0.0     ! SNAP10
11        1.0      0.00     0.00     0.00     0.00     0.00     0.0     ! SNAP11


Emissions_ml: removed a double output of country emission in RunLog

Met_ml: retablished the definition of debug_iloc, debug_jloc, which was deleted 
inadvertently in a previous version and made the DEBUG version fail.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th February 2014  Peter  2701

Landuse_ml.f90 allow sumfrac up to 1.2 around poles.
run.pl: removed "ppn=16", as Stallo has now many nodes with 20 cpus too. 
        removed mem=16gb for Vilje, as nodes on vilje have about 28 gb memeory
        do not stop the run.pl when natso2 not found (as it can be neglected, 
                                                  and many grid don't have it)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20th January 2014  Peter  2700

Number of level for use of "NewLogan" was set wrongly. 
(does only affect runs if you explicitely set NewLogan=.true.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th January 2014  Svetlana, Peter  2699

Flexible dust. Dust can now be used for any grid. It is interpolated from a 
global file. 
To use the old grid specific data set USE_TEGEN=.false. in ModelConstants_ml
Met_ml.f90
ModelConstants_ml.f90
run.pl

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21th December 2013  Peter  2696

Small cleaning: 
added  "PBS_O_HOST" in run.pl, so that it finds Stallo
USES%EMISSTACKS = F in config_EMEP_STD.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th December 2013  Peter  2693-5

 Complete reorganization of MeteoRead. The fields are systematically read from
the met(ix) "list".
Metvar is now integrated into MeteoRead (since everything was put there anyway).
Lot of clean up. 
The weird definition of precipitation is corrected (as planend in 2010...); 
Now pr is simply the precipitation (forced positive) in mm/s. 

All results should be identical

NewLogan in BoundaryConditions_ml: path to Logan_P.nc, which takes into account 
surface pressure (tests show better correlation than when constant surface pressure is assumed).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th December 2013  Alan Briolat  2691-2692

ZD_ESX/{AllocInit.f90,Zmet_ml.f90,ZchemData.f90}:
    Reworked the AllocInit subroutine to allow array initialisers and
    automatic reallocation when new shapes are required.  Updated ESX Zmet
    and ZchemData to rely on the new AllocInit.

ZD_ESX/My_ESX_ml.f90, ZD_EXTRA/My_ESX_ml.f90, DryDep_ml.f90, Makefile.SRCS:
    Added basic ESX initialisation, called from DryDep.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th December 2013  Peter  2690

Big reorgarnization of loops: the loop within PhyChem is merged with the loop in Unimod.
Now there is only one main time loop in Unimod, whith timestep=dt_advec.
numt does not exist anymore.
The routine must themself check that the time is correct for what they intend to do.
Some cleanup too.

The results should be identical as before. If not there is a bug.

Modified:
Biogenics_ml.f90 Landuse_ml.f90 Trajectory_ml.f90 Runchem_ml.f90 OutputChem_ml.f90 
Advection_ml.f90 PhyChem_ml.f90 MetFields_ml.f90 PointSource_ml.f90 Sites_ml.f90 
Met_ml.f90 Unimod.f90 

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th December 2013  Peter  2688-9

Start of a reorganisation of the meteorological fields.
Introduced the "metfield" type.
This is meant to do be used for all the transformations that are done sytematically, 
like the time integration.
The "normal" fields (ps, SigmaKz etc...) are still there and connected with pointers 
(pointer means that basically there are 2 names for the same data: change the values 
in one of the arrays, and the data is changed in the other too)

For now only time integration is done in this way (metfieldint). Metint will be removed.

The fields are hardcoded in MetFields. Please I want it like that, at least for the near future!

Bug in Met_ml introduced in 2672. KMAX not inititalized. Would probably cause 
crashe if not initialized to any reasonable value. 

Changes: Met_ml, MetFields_ml, PhyChem_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th December 2013  Peter, Birthe, Anna  2687

GridValues_ml: Check that the highest level in meteo grid is at least as high as the one in  VerticalLevels.txt.
Output_hourly: Put height Z of the "surface level" in hourly output at 3 meters.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th December 2013  Matthias, Dave  2685


Point-source code added: implementation of NILU and other plume-rise methods,
 with Peter's spread-plume routine to assign emissions to layers

 No change in results unless USES%EMISSTACKS=T

  ** New **  PointSource_ml
  ** New **  PlumeRise_ml   

The code will read coordinates and emissions from a file PointSources.txt.
Plume rise and hence effective emissions height  is calculated from the
stack parameters and meteorology, and the spread into the z-layers using
an assumed standard deviation of the emissions (=25% of the plume-rise
delta). Can work with any z-layers (no hard coding :-)

Changes in:

   Makefile.SRCS
   Emissions_ml      - USES%EMISSTACKS and USES%PlumeMethod
   ModelConstants_ml - USES%EMISSTACKS and USES%PlumeMethod
   RunChem_ml - if (USES%EMISSTACKS) call point_sources...
   Emissions_ml - if (USES%EMISSTACKS) call point_sources...
   run.pl  - links PointSources.txt file (from MyData so far)

Also:
   OwnDerived_ml - added UNDEFS, initialisation of Asc2D, and print_Asc2D

Caveats

   Currently the meteorology assumes lowest layer has 90m depth. Should in
   future also make wind-speed and dt/dz depend on z values.

   Currently emissions make use of EmisNat arrays, since this was easier
   for non SNAP emissions. Will modify.

   Need to harmonise with volcanic and emergency emissions.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th December 2013  Dave,Peter  2684

2684 - Dave updated Log.changes with this info
2683 - Sketch added to ESX Zgrid_mk
2682 - Peter - MaceHead
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd December 2013  Peter  2681

Corrected MaceHead corrrection for NewLogan (can still bbe improved)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 November 2013  Peter, Birthe  2677-79

NetCDF_ml.f90:
vertical interpolation routine.
NB: this routine does assume Pref at surface everywhere!
BoundaryConditions_ml:
Hardcoded option (NewLogan), to run with a  new Logan BC for O3
The new file is in the original pressure grid:
/global/work/mifapw/emep/Data/Logan_clim/Logan.nc
This is a temporary setup. Hopefully the entire BIC routine will be reviewd.

GridValues_ml.f90:
A_bnd_met allocated also in case the old system for vertical levels is used

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 November 2013  Alan Briolat  2675-2676

ZD_ESX/esx_DO3SE.f90, ZD_ESX/esx_gleaf.f90, ZD_ESX/esx_tester.f90:
- Move ESX-DO3SE integraton to its own module

DryDep_ml.f90, Makefile, Makefile.SRCS, ModelConstants_ml.f90,
ZD_ESX/My_ESX_ml.f90, ZD_EXTRA/My_ESX_ml.f90:
- Integrate ESX into the build system in a similar way to MACC pollen, and
  other optional components.  Can build ESX variant with "make EmChem09-ESX".

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21/25 November 2013  Alvaro 2673/2674

Update Copyright text and Forecast/Analysis running modes.

mk.OpenSource, Copyright.txt
- Remove the need of Copyright text on *.f90 files.
  The Copyright text is kept on Copyright.txt and will be inserted to *.f90
  files by mk.OpenSource.
- For files already containg Copyright text,
  the year is updated by mk.OpenSource

Unimod.f90,Nest_ml,Nest_ml,OutputChem_ml
- Remove Copyright text from files

run.pl:
- Fix incomplete emissions path for GEMS25, MACC02 & MACC14 domains.
  Bug introduced on 2667.
- Change file name convetion for 00 and 12 UTC versions of forecast metyeorology.
  Assume that 00/12 UTC versions are kept on different direcotries.
  00/12 UTC versions are no longer distingused by 00/12 tag on file name.
- Hash variable %inml collects input files to be defined in config_emep.nml.
  This should slowly replace %ifile/linking.
  See $inml{'filename_eta'} for an usage example.
- Vertical description of External BCs used on Forecast runs defined
  by $inml{'filename_eta'} in run.pl, instead of linking the file.
- Additional model setup information written to config_emep.nml.

Unimod.f90,Nest_ml,run.pl:
- Move Forecast restart/dump dates (outdate in Nest_ml; $CWFDUMP in run.pl)
  from INPUT_PARA namelist (read by Unimod.f90)
  to Nest_config namelist (read by Nest_ml)

Nest_ml:
- Set number of forecast restart/dump records (FORECAST_NDUMP) on running time.
- New logical vaiable NMC_OUTPUT to reduce the output on restart/dump records.
  Only members of DAobs, DAunobs, PM10 and AOD groups are written out.
- FORECAST_NDUMP and NMC_OUTPUT read from Nest_config namelist.

config_FORECAST.nml:
- Port updates to config_EMEPSTD.nml
- Add NMC_OUTPUT and FORECAST_NDUMP to Nest_config.
- Set outdate (Nest_config) and filename_eta (ExternalBICs_config)
  by run.pl using hash/keys.
- Remove some unused/commented options.

ExternalBICs_ml:
- Extend char/len of filename_eta
- Fix minor error for DEBUG output.

OutputChem_ml:
- Redefine Jan_1st in Wrtchem as the first day of run.
  This variable is used to avoid writing partial results on the first
  run day that only contains 00-06 UTC data.

TimeDate_ExtraUtil_ml:
- Add FFFF format tag for forecast step (fstep)

Makefile,ZD_3DVar/DA_ml,Analysis/DA_Obs_ml,B_NMC/spectralcov_ml
  minor updates

ZD_3DVar/Makefile:
- MKL path for intelcomp/13.0.1 module
- Compile/link options for all *.mod files in the same directory.
- Pass $(DEBUG) to sub-make calls

ZD_3DVar/B_NMC/Util_ml
- Add (optional) debug check to GetNCRec for fetching exact time records.

ZD_3DVar/B_NMC/covmat_ml,Unimod_B_nmc
- Rename resolution variables from dx/dy variables dxdim/dydim.
- Change default domain resolution from dx=dy=0.25 to TNO14 (dxdim=0.25;dydim=0.125).
- Check nchemNoObs>0 before allocate/read ucovmat and related variables.

ZD_3DVar/Analysis/DA_3DVar_ml
- Limit analysis increments (dx/du) to 500% (ANALYSIS_RELINC_MAX=5.0).
- Check nchemNoObs>0 before unsing ucovmat and related variables.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14 November 2013  Peter 2672

Flexible vertical coordinates.
If a file Vertical_levels.txt is found at run time, the defintion of the 
vertical levels are read (in hybrid coordinates) and used for the run. 
Link in run.pl to one of the files given in the ProgDir, or make your own

The meteorology must be defined in hybrid coordinates too 
only defined so far with 37 levels:
EECCA/metdata_EC/2009_k
GLOBAL/metdata_EC/2009_k

Modified:
Met_ml.f90, GridValues_ml.f90, run.pl (and ModelConstants_ml.f90, Unimod.f90)
Added:
Vertical_levels20.txt Vertical_levels30.txt Vertical_levels34.txt Vertical_levels.txt

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12 November 2013  Alvaro 2670

Pollen modules for "out of the box" compilation.

Makefile,Makefile.SRCS,ZD_Pollen/My_Pollen_ml,Pollen_ml,Pollen_const_ml
- Rename FUTURE_Pollen module files and place them on ZD_Pollen directory.
- Use "real" pollen modules (Pollen_ml,Pollen_const_ml) form MACC compilation
  target (`make MACC`). For all other compilation targets (e.g. `make EMEP`)
  use "empty" pollen module (My_Pollen_ml).

Runchem_ml,PhyChem_ml
- Call Pollen_ml functions

Output_hourly
- Reflow hr_out%type cases for surface/3d hourly output types.
- Hourly output types for Pollen_ml variables.
- CheckStop after CloseNetCDF, so the offending variable is written out
  and can be examined for debugging.

ZD_OZONE/My_Outputs_ml.f90
- Hourly AOD output on TRENDS output mode.
- Hourly pollen output on FORECAST output mode, when USE_POLLEN/DEBUG_POLLEN.
- Hourly RN222 on FORECAST output mode, when variable is found.
- Do not CheckStop on FORECAST mode when hourly output fails consistency check.
  Instead, reduce number of hourly output variables and continue.

run.pl:
  Fix given/when cases for $year ranges. Bug introduced on 2667.
  
utils/compinfos.py 
  Add scipt for  comparison benchmark *.infov files

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 November 2013  Dave 2669

ESX changes:
    plotZarray - noshow option added
    ZCM_ESX_R12: GenIn.species, GenIn.reactions modified to make sure TRACER!
    and TRACER2 have applied rcemis terms. Need change to GenChem for better
    safety.

    esx_gleaf, DefPhotolysis - small changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 November 2013  Alvaro 2667

run.pl:
- Simplify script/options for
  - $MetDir in stallo.
  - $emisdir/$pm_emisdir using given/when cases for $GRID/$year.
  - $HDD skip cases.
- Restore '1-step-run if($dd2=0)' functionality lost on 2646.
- Cleaner config_emep.nml
  - Do not copy comments config_*.nml templates
  - Add a list of linked files in namelist style as a comment.
    This would help to introduce more input files into config_*.nml,
    and to reproduce model runs with future versions of the model.
- Reflow/rewrite partial of the SR code
  - $country_nums definition.
  - Reduction assignments using given/when cases for $pollut.
  - Add split countries/sea areas to $femisdat using given/when cases for $cc.

config_BM-EECCA.nml
  Commented line for a 1 week "Debug-Benchmark" run between Jan 1st and 8th.

config_EMEPSTD.nml
  Minor formatting changes

AOD_PM_ml
  Small bug fix on Qm_grp function (introduced on 2665)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8 November 2013  Dave   2666

More ESX:

   Added Zmet%Ra, using fine-scale calculation of Kz 

   CM_, GenChem stuff
   Re-introduced Riemer, etc., for more realistic chemistry
   Added TRACER2 (and TRACER became TRACER1) for Jalle. Provides
   reacting species.

   
   Kz_ml
     - stability effects continued
     - added Zmet%Ra term, from fine-scale integration of Kz

   esx_Variables
     - added Zmet%Ra term

   + small tidy-ups in ESX codes.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8 November 2013  Alvaro 2665

Refactor AOD_PM_ml and clean up CM_ChemGroups_ml.

AOD_PM_ml,GenChem.pl,mk.GenChem:
- Modify GenChem.pl and *.species files to assign extinction prototype/classes
  and Wet/Dry mode to each model variable.
- AOD_GROUP is not longer explicitly defined on the *.species files,
  instead it is the collection of all model variables with a defined
  extinction class.
- The extinction classes and Wet/Dry mode are summarised on mapping file 
  (CM_AerExt.inc) produced by GenChem.pl/mk.GenChem.
- Extinction prototype/classes and Wet/Dry mode are defined on AOD_PM_ml.

ZCM_EmChem09/SeaSalt.species,PMmass.species,EmChem09base.species,Dust.species,
ZCM_EmChem09soa/VBS_nonvolatile.species,
ZCM_CB04/CB04base.species,ZCM_CB05/CB05base.species,
ZCM_CRI_v2_0/CRI_v2_0base.species,CRI_v2_R5base.species,
ZCM_Emergency/NUC.species,ASH_2bin.species,ASH_7bin.species,
ZCM_vbs_tests/VBS_help.species,VBS_help_Detailed.species,VBS_nonvolatile.species:
- Define extinction class (e.g. DDf) instead of the value of the 
  dry mass extinction efficiency at 550 nm (e.g. 1.0 [m2/g]).
- The Wet/Dry calculation mode can be explicitly defined (e.g. DDf:Dry),
  otherwise the Wet mode is assumed.

AOD_PM_ml:
- Partial support to older model versions can be achieved by editing CM_AerExt.inc.
  If the case, the new subroutine AOD_check ensures the consistency between
  AOD_GROUP and CM_AerExt.inc.
- The functionality previously provided by function wetExtC (introduced on 2638) 
  is now achieved by 2 separate functions: Qm & Qm_grp
- Private function Qm returns dry/wet mass extinction efficiencies for species
  in CM_AerExt.inc. Dry/Wet efficiencies are returned depending on the value of
  mode input parameter.
- Public function Qm_grp returns the wet extinction efficiencies
  for given a rel.hum. Dry extinction efficiencies are returned if no rel.hum.
  is provided.
- Subroutine AOD_Ext calculates AOD and Extinction coefficient.
  By default calculations are based on wet mass extinction efficiencies.
  The default behaviour is controlled by global variable EXT_MODE.
- Subroutine AOD_calc was removed as is functionality can be reproduced by
  AOD_Ext with EXT_MODE="DRY".

Units_ml:
  Remove support for ext550nm units (extinction at 550 nm).
  Conversion to ext550nm unit was based on dry mass extinction efficiencies.
  By default, AOD calculations are based wet mass extinction efficiencies,
  which change with rel.hum.
  This inconsistency makes the former ext550nm unit conversion misleading.

GenChem.pl(CM_ChemGroups_ml),Aqueous_n_WetDep_ml,Derived_ml,ZD_OZONE/My_Derived_ml:
  Remove INDEX_*_GROUP, GROUP_ARRAY, and unused/obsolete groups (e.g. DDEP_OXNGROUP).
  Use find_index('NAME',chemgroups%name) instead of GROUP_ARRAY. 

ZD_ESX/ZCM_ESX_r12/GenIn.species,ZD_ESX/ZCM_EmChem09/GenIn.species,
ZD_ESX/CM_ChemSpecs,CM_ChemRates,D_Misc/GenChem.pl:
  AOD relevant changes ported to ESX model.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8 November 2013  Dave   2661-2664

ESX-related changes (also main code, but no effect)

Main directory:

  SubMet_ml.f90   - Ln95 disabled
  MicroMet_ml.f90 - Ln95 disabled, and linked into ZD_ESX directory
                  - added phi_h, phi_w

ZD_ESX:

  DefPhotolysis_ml - BUG fix on Phux routine

  MicroMet_ml.f90 - linked into ZD_ESX directory

  Kz_ml - stability corrections added to Leuning code

  esx_Zmet - added safety clause, that hSL > 2 Veg%h
             added z/h to print_Kz
             Veg%hVeg renamed to Veg%h

  esx_Zveg - Veg%hVeg renamed to Veg%h 
  config_esx - Veg%hVeg renamed to Veg%h
  

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7 November 2013  Peter  2660

Nest_ml: recognize "Months" as a valid time (testet only for MODE=100)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6 November 2013  Peter  2658

Nest_ml: recognize hPa for the definition of hyam/hyai

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6 November 2013  Dave  2652-2657

ESX changes only
----------------

Major changes

  1) Photolysis system changed to get rid of hard-coded ID indices, and to
  use "Phux" algorthims, an

  GenChem.pl 
  ZCM_EmChem09/GenIn.reactions
  ZCM_ESX_r12/GenIn.reactions
  DefPhotolysis

  2) rcemis implemented better in esx_tester and config_esx.nml
  config and testing done for Plume1 case of Kuhn et al. AE, 1998
  EmChem09 set as standard chemical package for now

  STILL need to reconcile Fb and rcemis type entries. Will likely
  move Vd, Fb, etc. to BIC. 

Minor changes:

  ChemSolver - printouts tidied
  Zmet_ml - printout removed
  LocalVariables -ZenDeg and CosZ terms added (zenith angle)
  esx_Zmet_m.f90 - printouts tidied
  esx_ZdiffSolver.f90 - printouts tidied
  D_Plotting/plotZarray - colour/linestyle change

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4 November 2013  Dave  2651

ZD_ESX changes:

 Bug-fixes in ESX chemistry codes:

  DefPhotloysis  - fixed indices, e.g. NO3. (Need to return to this.)
  ChemSolver.f90 - stop loop over k. Safer max(x, ZERO)
  esx_tester.f90 - add ChemSolver loop k explicitly. More ouput. 

Extensions

  esx_GetData - changed to use esx%DataSoure text flag
  config_esx.nml - esx%DataSource = "-" or "Extern" added


Minor (mainly debug changes)

  Zmet_ml - extra output (TMP)
  Zmet_ml - extra output (TMP)
  D_Plotting/plotZarray - improved linestyle and colors usage
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4 November 2013  Dave  2649-2650

ZD_ESX/Amminium_ml - recoded version for ESX. Will harmonise with EMEP later.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 October 2013  Alan Briolat  2648

KeyValueTypes.f90,SmallUtils_ml.f90,TimeDate_ml.f90:
  Merge changes made to ESX versions of utility modules into their EMEP
  equivalents.

ZD_ESX:
  Replace EMEP modules duplicated in ESX with symlinks to EMEP files.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 October 2013  Peter, Semeena  2647

Nest_ml: allow vertical levels for nesting to be defined with hyai/hybi 
(values at levels interface), instead of hyam/hybm

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17-18 October 2013  Alvaro  2645-2646

config_EMEPSTD.nml,config_Outputs_EMEPSTD.nml:
  Formatting and clean-up and small changes to make them more gfortran friendly
  
config_BM-EECCA.nml:
  Single config_emep.nml file for EECCA 100x100 runs.
  Will work for any EECCA benchmark year.
  Benchmarks on other domains will need an specific config file,
  which can be created using this file as an example.

run.pl,ZD_OZONE/My_Derived_ml.f90:
  Single namelist file for runs (config_emep.nml).
  Benchmark runs use domain specific templates.
  For normal runs, config_emep.nml is created by combining INPUT_PARA (namelist)
  with config_$exp_name.nml and config_Outputs_$outputs.nml files.

run.pl,Unimod,Met_ml,GridValues_ml:
  * Replace INPUT.PARA file with a namelist (INPUT_PARA) on single file
    (config_emep.nml).
  * New string variable 'meteo' (Met_ml) is read in INPUT_PARA namelist.
    It contains a filename template for the met files.
  * MeteoRead, Check_Meteo_Date (Met_ml) and GridRead (GridValues_ml)
    use this variable and a date to generate the correct met filename.
  * For non forecast runs, it is not longer needed to link the met files.
    run.pl only checks existence of first and last meteo file before creating
    config_emep.nml.
  * Forecast runs still need linking of met files, as the file names follow
    a different rule. Nonetheless, the linking of met files has been
    cleaned up and simplified.
  * Parts of Met_ml and GridValues_ml have been clean up and re-formatted.

GridValues_ml:
  Small change to coord_in_gridbox and coord_in_processor,
  in order to ensure correct result for coordinates outside of the model domain.
  Error seems to appear only on 3DVar applications.

Met_ml:
  * Add optional logical variables ('needed' and 'found') to Getmeteofield.
    If present, found="variable was found"".
    If present, CheckStop(needed,...) when the variable is not found.
  * Re-write some of the variable-found logic on MeteoRead,
    in order to make the code easier to follow.

run.pl:
  * remove erroneous '$iyr_trend .. if $SR' line
  * add $MAKEMODE to 'my ($testv,...' definition line
  * Enforce $BENCHMARK{MAKEMODE} if defined
  * move special cases of $Chem, $exp_name and $testv
    for BENCHMARK and CWF runs to their respective code blocks at the
    begging of the script
  * simplify felt file handling, and remove obsolete code

GlobalBCs_ml: gfortran compliance

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th October 2013  Dave     2643-2644

ESX-only changes:

 New: mk.export - packages ESX into one dierctory for external users
                  (set at Dave's dropbox for now!)

 Fb units system implemented, changes in:

   config_esx.nml 
   esx_tester
   esx_Variables
   esx_ZdiffSolver

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th October 2013  Alvaro   2642

Clean up & small changes

Makefile
  Reorganize GenChem targets and remove obsolete MACHINE configurations.

Emergency_ml
  Increase max number of events def per location (NMAX_ERUP) to 360.
  This should allow a 3 months eruptuon descroption with 6h records. 

Units_ml
  Add support for "mass_ratio" units.
  Units_Scale process "kg/kg","kg kg-1","massratio","mmr" as "mass_ratio",
  and "vmr" as "mix_ratio".

Nest_ml
  Add unit support for IFZ-MOZART BC files from FZ Jülich.
  Variables ending in "vmr" (volume mix.rat.) and "mmr" (volume mix.rat.)
  have units attribute "1".

GlobalBCs_ml
  Collect macehead_O3 corrections for each year into one parameter array.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th October 2013  Alan Briolat + Dave   2639-2640

ZD_ESX added - for ESX development work.  This should not be used in standard
EMEP work, but we are working towards an experimental version. Code will be
shared between EMEP and ESX as far as possible.

(From ESX own's subversion 202)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th October 2013  Alvaro   2638

AOD calculations free of iadv_*/spec_* indexes:
  The previous version of AOD_PM_ml, developed specifically for EmChem09soa,
  made extensive usage of iadv_*/spec_* indexes to avoid hard-codded indexes.
  The new version gives almost identical results (diff<2.06e-5).
  I tried to cover all chem. mec., but can not be sure
  as the current implementation relies on AOD_GROUP and the variable names.

AOD_PM_ml:
  Rewrite routine avoiding iadv_*/spec_* indexes.
  Instead use the AOD_GROUP and variable names on a case statement.
  Work is still needed in order to remove explicit references to the variable
  names/indexes.

ZCM_EmChem09/EmChem09base.species,ZCM_EmChem09/PMmass.species,
ZCM_EmChem09soa/VBS_nonvolatile.species,
ZCM_vbs_tests/VBS_help.species,ZCM_vbs_tests/VBS_help_Detailed.species
ZCM_CRI_v2_0/CRI_v2_0base.species,ZCM_CRI_v2_R5/CRI_v2_R5base.species
ZCM_CB04/CB04base.species,ZCM_CB05/CB05base.species:
  The new wet extinction coefficient calculation (wetExtC function in AOD_PM_ml)
  relies on the AOD_GROUP. Therefore one must ensure that all variables
  involved belong to this GROUP.

Derived_ml:
  remove unused iadv_*/spec_* indexes

AODrh_PM_ml:
  Old version of AOD_PM_ml. Delete redundant module.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th September 2013  Peter   2637

Temporary solution: the correction 2635 was not correct.

In met_derived t2_nwp(i,j,1) -> t2_nwp(i,j,nt)

In metvar, call met_derived twice, so that the fields computed in met_derived 
are pointing to "now" after metvar:
    call met_derived(nr) !compute derived meteo fields used in BLPhysics
    call BLPhysics(numt)
    call met_derived(1) !compute derived meteo fields for nr=1 "now"

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th September 2013  Peter   2635

Bug. in metvar (Met_ml.f90), was:
   call met_derived(nr) !compute derived meteo fields
corrected to:
   call met_derived(1) !compute derived meteo fields

Because met_derived computes fields for "now" (nr=1).
This caused jumps (but within normal values) in some fields 
(u_mid, v_mid, u_ref, rho_surf, ustar_nwp, invL_nwp and values derived from these)

This will change results!


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th September 2013  Peter   2634

NetCDF_ml.f90: ReadField_CDF. 
New case: General projection of data, and zeroth order mass conservative inerpolation (2D only).
(used for Nederland/Amersfoort projection emissions in 1 km)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st August 2013  Peter   2633

The correction from version 2632 was not put in correctly. New trial here.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st August 2013  Peter   2632

There was a bug in the defintion of i and j for rotated lon lat projections, introduced
27th May 2013  revision 2592.
The values where shifted by one gridcell. The results (concentration etc.) were not affected.
NetCDF_ml.f90


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th August 2013  Dave   2630-2631

KeyValueTypes - replaces KeyValues_ml

   - adds funcionality for new key-value pair with (key, float) instead of
  (key, value). Not used yet, but makes use of config easier, e.g. in ESX
  config we can now have e.g. 
esx%Kz_kwargs =
  "Kza", 0.1
  "za",  0.5

followed in the relavent code by   za = KeyValue( kwargs, "za" )
etc. Very useful :-)

Changes in:

     Biogenics_ml.f90
     EmisGet_ml.f90
     Io_Progs_ml.f90
     KeyValueTypes.f90   NEW
     KeyValue_ml.f90     DEL
     LandDefs_ml.f90
     Landuse_ml.f90
     Log.changes
     Makefile.SRCS
     Sites_ml.f90
     Volcanos_ml.f90
     run.pl

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st August 2013  Dave   2628

utils/Rd_emepcdf.f90 - modified to stop when asking for 1-d variable. Case
   arose with rotated latlon files. Coding needs more work, but wanted to
   save.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st August 2013  Peter  2627

NetCDF_ml, (CreatenetCDFfile  _Eta):
Always output lon and lat in netcdf output.

removed "call GlobalPosition" (should not be in use anymore. Can be completely removed some day)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 July 2013  Dave  2626

utils/Rd_emepcdf improved:
    accounts for scale_factor and addoffset
    allows for -f option to set format
    checks that format-string sufficient for output. (avoids ***)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2 July 2013  Peter  2625

GridValues_ml.f90: eta coordinates works when coordinates defined in metfile too.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 June 2013  Dave  2624

CRI_v2_R5 now works again, phew! 

  See caveats below for limitations (BiomassBurning, BPINENE), but these
  are easily fixed (with some time).

Makefile - added proper dependencies for CRI_v2_R5. Can now type

     make CRI_v2_R5

 

ZCM_CRI_v2_R5:

  CRI_v2_R5base.reactions file - corrected for rcbio, Rn222 etc,

  BiomassBurning_FINN... file copied from EmChem09. Should
  really use CRI species.

  EMISPLIT/emissplit.defaults.pmxx - copied from EmChem09

  BPINENE not yet in emissions. Have commented out rcemis term for
  now, and also "BVOC" label in .species files (otherwise the
  emep model expects to find an emission fields), but if wanted
  BPINENE could be taken as a fraction of the APINENE emis.

Also:

  run.pl   $outputs added to stear which config file is used for outputs. No
           need for different outputs for all exp_names.
 
           + CRI changes, also to use EMISPLIT for now

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 June 2013  Dave  2623

Radiation_ml: added units for PAR (a user asked what they were)
              and slightly more doxygen-friendly comment indicators
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25 June 2013  Peter 2622

NetCDF_ml: ReadTimeCDF recognise times unit 'day as %Y%m%d.%f'
(as in EnsClim BC)

NetCDF_ml:   bug in ReadField_CDF
      Ndiv=2*nint(Grid_resolution/GRIDWIDTH_M)
will give strange landuse patterns if all these condition are met:
1) PolarStereographic projection
2) Resolution finer than 5km
3) Emep area


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20 June 2013  Dave 2619

RESULTS CHANGE FOR HISTORICAL TREND RUNS < 2000 - tag as rv4.4.1

GlobalBCs_ml - 1) added macehead_default array 

               2) Set USES%MACEHEAD_AVG = T in config to force use of
               default MH corrections.

               3) Set base-year of O3 trend to 2000, instead of 1990. Seems
               better compared to observations, Parrish et al. and forthcoming
               borders paper (with JEJ). This will change O3trends prior to
               2000.

ModelConstants_ml - Added USES%MACEHEAD_AVG = .false. to namelist variables

Log.changes    - added rv4.4 message to 2599. Probably needs a branch for the
               final release of rv4.4.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20 June 2013  Dave 2618

Small tidy up and correction to settings:

mk.GenChem - reset to EmChem09soa default

ModelConstants_ml - debugs false

Emissions_ml.f90 -  commented out code removed

My_Derived_ml.f90 - NMOSAIC print outs commented out.

config_EMEPSTD.nml - EMIS_SOURCE set to None


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19 June 2013  Dave 2617

emis_inputlist introduced  to read any number of netcdf emission files, as long
   as they conform to the EMEP style, e.g.  Emis:INTSHIPS:snap:8

   Has been used to combine MACC2 7km, IIASA 0.5 degree and IPCC shipping 
   

ModelConstants_ml
  emis_inputlist  defined and in namelist

EmisGet_ml
  various debugging changes.

Emissions_ml
  loop over emis_inputlist now replaces older calls to GriddedSnap, GlobalSnap

config_EMEPSTD.nml
  examples of use of emis_inputlist added, from ECLAIRE work. 


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 June 2013  Dave 2616

Emission_ml: changed unset index iem to iemCO in SnapPos printout 

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 June 2013  Dave 2614-2615

run.pl - grouped together testv, Chem, exp_name , GRID for clarity and to
  prevent common mis-matches.

ModelConstants_ml
  new config DEBUG system started, with:
   DEBUG%HOURLY_OUTPUTS
   DEBUG%BCs
  Also:
   USES%MACEHEADFIX = .true. by default

BoundaryConditions_ml
  DEBUG%BCs instead of DEBUG_BCS

ForestFire_ml.f90
   Improved monthly calculation. Still in development and testing though.

GlobalBCs_ml -  Uses USES%MACEHEADFIX  and DEBUG%GLOBBC

Unimod - removed older TEST DOY printout. That had just shown that DOY was
  okay with e.g. day_of_year(yyyy,12+1,1)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5 June 2013  Svetlana and Alvaro,   2608-12

AOD_PM_ml.f90 - hard-coding removed, MWT for PPM corrected, 
some cleaning in Rh interpolation.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5 June 2013  Peter,   2607

NetCDF_ml: remove characters after "lat lon" for projection read from file.
(an invisible characater is appended by nco)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5 June 2013  Dave,   2605-2606

2606:
** NEW ** 
   config_Outputs_EMEPSTD  - start of new config system for My_Derived - 
   now reads namelist from (currently) config_Outputs_$exp_name

ZD_OZONE/My_Derived_ml. Much code removed, replaced by  namelist read in
    Init_My_Derived. (Will consider moving this call later.) 


Also:
   run.pl - extended for some RCA settings.

2605:
SmallUtils_ml - added option first_only to find_index_c - let's user search
   for first occurence of a string (e.g. NOTSET).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4 June 2013  Alvaro, 2604

ZD_OZONE/My_Outputs_ml
- correct 1 char bug introduced on 2602.
  It caused the model to crash on the first hourly output.

Makefile
- Update vilje modules: new requirements for intel compiler 13.0.1 are
  MODULES = intelcomp/13.0.1 mpt/2.06 netcdf/4.3.0

config_EMEPSTD.nml
- restore  to full domain.
  RUNDOMAIN was wrongly set to 100x100 benchmark on 2599

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4 June 2013  Dave, 2603

de-associate...

Forest_Fire_ml.f90 - removed outer associate block, which (for unknown reasons)
  stops intel 12.0 (vilje) from compiling code. intel 13.0 works fine, but for
  now I have replaced => with simple = assignments. Shame.

  (The inner loop associate does work, as does associate in Unimod.f90. Very
   odd.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3 June 2013  Alvaro, 2602

Output_hourly,ZD_OZONE/My_Outputs_ml
- re introduce PS output on Output_hourly as part of the CF convention
  (introduced revision 2509; removed revision 2597).
  To be written out only if there is no user defined PS output
- remove PS user defined hourly output (introduced revision 2597).

ExternalBICs_ml,config_FORECAST.nml
- Rename IFS_EVA_2010 ExternalBICs_bc description%version to IFS_MACC_EVA

ZD_OZONE/My_Outputs_ml
- Rename MY_OUTPUTS EVA2010 case to MACC_EVA

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1 June 2013  Dave, 2600-2601             

Fortran 2003 "associate" introduced, and start of new config system (USES% type):

ForestFires_ml:
   USES type added, with forest-fire settings as first example
   Introduced USES%MONTHLY_FF option to force monthly-average emissions
    (very inefficient so far, called every day, but will fix later.)

ModelConstants_ml: USES type added, with forest-fire settings as first example
Setup_1d_ml: USES%FOREST_FIRES
Unimod.f90:  USES%FOREST_FIRES and associate (e.g. mm=> current_date%month)

config_EMEPSTD, EMERGENCY, FORECAST, IMPACT2C updated with new USES system.

Both of these features simplify the code and should be expanded.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 May 2013  Alvaro, 2595-2599 - to be released as rv4.4 open-source summer 2013

2595: Prepare code for status runs
2596: eEMEP and FORECAST downstream updates
2597: Improve hourly output
2598: Extend Nest configuration via namelist
2599: 3DVar updates

Makefile:
- make targets with Grimsvotn eruption tracers (EMEP2011 SR-EMEP2011)
- make eEMEP target with EmChem09 insead of EmChem09soa
- mk.GenChem quiet option (-q) for all GenChem targets, except EMEP and EMCHEM09
- compilation options for MACHINE=byvind

run.pl
- make and BM options for status run
- introduce MACC14 domain, and use it as default for FORECAST runs

mk.GenChem
- Emergency files created by mk.GenChem (emergency_location.csv & emergency_emission.csv)
  will be kept in ZCM_Emergency, instead of the run directory (ZCM_EmChem09soa).

Units_ml
- Fix wrong unit conversion for uBqh.

FUTURE_Pollen_ml,run.pl
- change name for pollen forecast dump/restart files

Emissions_ml,run.pl
- Remove hardcodded path to Emis_TNO7.nc
- Change name used in model from Emis_TNO7.nc to EmisFracs_TNO7.nc,
  in order to distinguish this emission format from others currently been tested.
- run.pl links EmisFracs_TNO7.nc to Emis_TNO7.nc

Output_hourly,Derived_ml,ModelConstants_ml
- rename IOU_HOUR_PREVIOUS to IOU_YEAR_LASTHH

Output_hourly,ZD_OZONE/My_Outputs_ml
- D2D specific types _inst, _accum & _mean for instantanous, accumulated and mean
  output comparable to daily,...,yearly output.
  D2D_inst is taken from d_2d(..,IOU_INST). D2D_accum and D2D_mean are
  calculated from d_2d(..,IOU_YEAR)-d_2d(..,IOU_YEAR_LASTHH).
- Change D2D output for averaged species (f_2d(ispec)%avg).
  For such species D2D will assume that D2D_mean is required.
  In previous versions, it assumed D2D_inst.
- Hourly PS output is defined as
    hr_out(0)=Asc2D("PS","D2D_inst",find_index("PSURF",f_2d(:)%name),...
  This is to avoid the double definition in hr_out and Output_hourly

Nest_ml,config_*.nml
- Nest BC input/output frequency (NHOURREAD/NHOURSAVE)
  defined trough Nest_config namelist

ZD_3DVar/Makefile,Analysis/DA_Obs_ml,DA_3DVar_ml
- implement MATCH chisq_over_nobs2 routine for chi^2 evaluation

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 May 2013 Dave, 2594

Met_ml:  code for SMI now re-written to check for different options in a loop:

   ! Soil water has many names. Some we can deal with:
   ! (and all need to end up as SMI)
    character(len=*), dimension(4), parameter :: possible_soilwater_uppr = (/&
        "SMI1                " &
       ,"SMI                 " &
       ,"soil_water_content  " &
       ,"soil_wetness_surface" &
    /)
    character(len=*), dimension(3), parameter :: possible_soilwater_deep = (/&
        "SMI3                   " &
       ,"SMI                    " &
       ,"deep_soil_water_content" &
    /)

Tested for IFS, TNOxx, RCA, and EMEP (after the usual struggles with DUST, 
clay, etc.) 

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th May 2013  Dave, 2593

Makefile - EMCHEM09 option added, to use just EmChem09 chemistry.
          (We don't always need SOA!)

run.pl  - Just uses EMISPLIT specials if EmChem09  (to avoid trying to
           split PM25)
        - commented out VolcanoesLL_2010.dat line added. Should probably be
          used for all years.
        
Log.changes  - try to keep text within 78 chars (as in code).
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th May 2013  Peter, Heiko  2592

NetCD_ml: i and j defined correctly in Rotated lat lon projection 
          (were in km up to now).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 May 2013  Dave  2591

ModelConstants_ml
config_EMEPSTD.nml

  Replaced faulty Ndep_trends system with namelist-controllable
   EURO_SOILNOX_DEPSCALE in ModelConstants_ml, Biogenics_ml.
   See ModelConstants_ml for usage.
   Removed Ndep_trends code from Emissions_ml

Also, moved USE_AIRCRAFT_EMIS, USE_LIGHTNING into namelist system.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 May 2013 Peter 2590

Added a switch MARS_RATIO_SMOOTH in MARS_ml to test without smoothinh between 
different TNH4/TSO4 regimes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 May 2013 Semeena 2589

Some formatting corrections with tex file, chapter:Subrun.tex of Manual

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 May 2013  Semeena 2588

Added more details to the Manual.  
Chapter: How to submit a run.  Details about different 'Nesting' options.

2586 and 2587 are submitted my me with the above mentioned changes in the
 chapter 'subrun.tex'.  Forgot to mention those changes here.  So 2588 is 
identical to 2587 apart from this 'Log.changes' file.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th May 2013 Anna 2585
Deleted old versions of Manual/UserGuide files in DOCS/Manual:
running.tex, general.tex, Outputs.tex, Inputs.tex

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th May 2013 Anna (2584 (and 2583))
Updated files in DOCS/Manual as released with Open Source code 2565 rv 4.3:
Input.tex, Intro.tex, Manual.tex, Output.tex, references.tex, Subrun.tex

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th May 2013  Peter (2582)

Met_ml
Slightly different derivation of vertical wind in eta coordinates (not use in sigma coordinates)
DOCS/vert_wind.tex 
Tex documentation with mathematical justification of the expression for vertical wind. 

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd May 2013  Peter (2581)
Added "micro g/m3" as unit in Units_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd May 2013  Peter (2580)
Met_ml: character *100 :: period_read=' '
It seems that gfortran can fail (runtime segmentation fault) in some cases when the variable 
is not initialized  *in the declaration* (!)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd May 2013 Alvaro, Peter (2578)

Nest_ml, ExternalBICs_ml
ICBC_FMT, istart=max(istart,RUNDOMAIN(1)...)
can now put in config file to get full domain:
istart=-999,jstart=-999,iend=9999,jend=9999,

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd May 2013 Peter (2577)
One line had fallen out of Makefile
  LLIB := $(foreach L,$(LLIB),-L$(L) -Wl,-rpath,$(L))
Removed output comment in NetCDF
('WARNING: interpolation method may be CPU demanding' for Rotated_Spherical)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st May 2013 Dave (2575)
GlobalBCs_ml - changed format for SIAtrend output to fix gfortran crash
  reported  by Adam Miles.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th April 2013 Peter (2574)
Units_ml: accept ppbV as ppb
NetCDF_ml: accept 'longitude' or 'latitude' instead of 'lon' 'lat'

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th April 2013 Dave (2573)

Makefile - gstallo option added (with Steinar's help), so one can do
   make MACHINE=gstallo (on stallo). NOTE - need to do:

    module swap intel gcc/4.7.2

   before compilation. Doesn't run yet, that is for another day. There
   are plenty of warnings generated by the make though, should keep us
   busy for a while.

Also, utils/Rd_csvsondes.f90. Length of longline increased to cope with
   all-species sonde outputs (35000 chars).
  

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th April 2013 Dave (2572)

gfortran compilation needed changes in:

 EcoSystem_ml.f90 - needed trim around entries in DepEcoSystem setting

 ModelConstants_ml.f90 - removed unused variables

 SeaSalt_ml.f90 - had + & then another + (on 2 lines for rcss)

 ZD_OZONE/My_Derived_ml - had to have equal width entries

Not tried to run yet.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th April 2013 Dave (2571)

Emissions_ml - fixed call for global soil emissions for 2005, which
  was causing a crash in global runs.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th April 2013 Dave (2570)

Added utils/Rd_emepcdf   -  reads EMEP (or some other netcdf) files
  and outouts ascii. Can read PS or lat/long data. Good to extract data
  for plotting.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23rd April 2013 Dave (2569)

Corrected: Rd_csvsondes.f90 ;-)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22nd April 2013 Dave (2568)

Added:

Rd_csvsondes.f90 to utils directory

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st April 2013 Dave  (2567)

Country_ml - added EGYP

EmisGet_ml.90 - tmp - some debugging changes

run.pl - added $MONTHLY_EMIS, which should be set to zero if
         global emissions are not monthly. ECLAIRE example added.


(all in preperation for new ECLAIRE/ECLIPSE global runs)

Emissions files (annual) for ECLAIRE 1deg created in GLOBAL. Used
if exp_name =~ /ECLAIRE/

NOTE - BUG found in some global emission files. Always check
emission output of runs!

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TAG: 2565 as rv4.3   19th April 2013 xxxxxxxxxxxxxxxxxxxx
      (version used for Open-source course, and apart from AOD same
       as for Gothenburg Protocol runs.)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th Svetlana (2564)

AOD_PM_ml.f90 - corrections in v. high RH behaviour.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th Svetlana (2563)

AOD_PM_ml.f90 has been re-written in a flexible way,
where species indices are found by "find_index" function in Derived_ml.

AOD_PM_ml.90
Derived_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th Dave  (2562)

BGND_CH4 added as namelost variable, to allow CH4 to be reset with 
  the config file. Use of BGND_CH4 = -1 keeps default settings.

ModelConstants_ml
BoundaryConditions_ml
config_EMEPSTD.nml -  have not added yet to other configs as optional

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th April (2561)
Birthe - removel Pollen for user course
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 17th April  (2543)  = GP_work version

run.pl -- added die unless config_exp name (I wasted 1000s h CPU with
    a missing config file! Dangerous)

Clean-ups only, no result change. Mainly took away JAN2013, NONWP etc.

AOTnPOD_ml
BLPhysics_ml
BoundaryConditions_ml
DO3SE_ml
DustProd_ml 
DryDep_ml
LandDefs_ml
Landuse_ml
MetFields_ml
MosaicOutputs_ml
Unimod.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TAG: 2546 as rv4.3beta   14th April 2013 xxxxxxxxxxxxxxxxxxxx
          (version used for Gothenburg Protocol runs.)
          (same as 2543. System seems a bit confused
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 13th April  (2543)  = GP_work version
Fixed bug in Ndep_trends (now sent to all nodes)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 13th April  (2542)

Soil-NO emissions future proofed for Euro-versions anyway

Emissions_ml
  added sumEU and calcu
  Ndep_trends factor added, which compares read-in EU N emissions with
  value from 2005 GP_work. The latter is hard-coded, but this method
  allows the model to be run for e.g. 2050, without needing pre-runs
  to establish deposition fields.

Biogenic_ml
  Uses Ndep_trends to calculate soil NO (if USE_EURO_SOILNOX )

run.pl
  Removed link to 2020 Ndep fields. Just use the 2005_2009 average
  as base.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 12th April  (2541)

Changes in : a) Soil-NOx 
             b) MedLAI function
             c) config_EMEPSTD

a) Better split between USE_EURO_SOILNOX and USE_GLOBAL_SOILNOX

   Biogenics_ml
   Emissions_ml
   Setup_1d_ml
   ModelConstants_ml


b) MedLAI provides Mapping Manual variation in LAI

  Landuse_ml

c) config_EMEPSTD now has
    EMIS_SOURCE           = "emislist", ! "emislist" or CdfFractions
    EMIS_TEST             = "None",  ! "None" or "CdfSnap" 
  (I thought I had put these earlier. Overwrite?)

Minor tidy-ups
DryDep_ml, Derived_ml, LandDefs_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 12th April  (2540)

Pollen_ml, SeaSalt_ml, Setup_ml : Emis_BioNat changed to EMIS_BioNat,
as used in rest of code. Please be careful not to change case...

Unimod.f90  - removed unused variables from "use" list.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 11th April  (2538)

Tidy-up (more to RunLog)

ModelConstants_ml, 
Unimod.f90
MassBudget

  More outputs sent to RunLog, including NML from ModelConstants
  USE_CONVECTION added to NML, default F
  (added in config_EMEPSTD, config_IMPACT2C)

  eulmod.res/IO_RES removed. Was empty except for extended Mass
   debugging. Latter now sent to IO_LOG, but could just use
   unit 6?

GlobalBCs_ml, BoundaryConditions_ml, Unimod.f90
  iyr_trend removed from subroutine calls. Use from ModelConstants_ml
  BC trends sent to PrintLog

Smaller changes:

Biogenic_ml - refs updated

DryDep_ml - print changed to write except before CheckStop

Emissions_ml - comments re soil NOx corrected

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 11th April  (2537)

GlobalBCs_ml

- soxtrend, noxtrend, nh4 trend method (based loosely upon observations
  of US emissions) modified, now with data from EPA to 2012,  then
  IIASA ECLAIRE/ECLIPSE emissions for 2030 and 2050. Fake 2200 values
  added. BCs to non-existing years interpolated.

  Results change, since previous code used 2003 values for all later
  years.

  Trends now written to RunLog

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter 10th April 2013 (2536)

Met_ml.f90:
Bug when cc3d is derived from cloudwater -> was always zero!
(not sure which metdata uses cloudwater)
put also an additional max,min for cc3d, to ensure non-negative values.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter, Dave 9th April 2013 (2535)

Bug in massbalance when eta coordinates are used (not default)
Advection_ml.f90

run.pl: new test for STALLO/VILJE, removed TITAN

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter 8th April 2013 (2534)

Modified definition of timezones in Country_ml.
NB: this will modify results!

Modifications (in parenthesis the old values):
 Portugal: 0 (1)
 Former USSR: -100  (3)
 Remaining land areas: -100 (1)
 Remaining NE Atlantic Ocean: -100 (1)
 The Black Sea: 2 (1)
 Natural marine sources: -100 (1)
 Kola/Karelia: 4 (3)
 St.Petersburg/Novgorod-Pskov: 4 (3)
 Belarus: 3 (2)
 Kazakstan : -100 (6) ?
 Rest of Kazakhstan (in the extended EMEP domain) : -100 (5) ?
 Other Asian areas: -100 (0)
 Russian Federation: -100 (3)
 USA: -100 (1)
 Canada: -100 (1)
 Azerbaijan: 4 (3)
 Atlantic outside. EMEP : -100 (1)
 Russian Fed. outside emep: -100 (4)
 Biomass burning (wild): -100 (0)
 B. Sea * cargo * 12 : 2 (1)
 Rest of extended Russian Federation (in the extended EMEP domain): -100 (7)
 Uzbekistan (in the original EMEP domain) : 5 (4)
 Turkmenistan (in the original EMEP domain): 5 (4)
 Rest of Uzbekistan (in the extended EMEP domain) : 5 (4)
 Rest of Turkmenistan (in the extended EMEP domain): 5 (4)
 Caspian Sea (in the original EMEP domain): 4 (3)
 Tajikistan (in the extended EMEP domain): 5 (4)
 Aral Lake (in the original EMEP domain) : 5 (4)
 Rest of Aral Lake (in the extended EMEP domain): 5 (4)
 Modified remaining Asian areas (in the original EMEP domain): -100
 (3)
 Remaining extended Asian areas (in the extended EMEP domain): -100
 (6)
 Arctic Ocean (in the extended EMEP domain): 9 (8) ??
 Extended EMEP-external part of Russian Federation: -100 (12)
 Extended EMEP-external part of Asia : -100 (7)
 Extended EMEP-external part of Pacific Ocean : -100 (12)
 Extended EMEP-external part of Arctic Ocean : 9 (12) (same as Arctic
 Ocean)
 EMEP-external part of North Africa : -100 (1)
 Rest of Africa and Asia: -100 (1)
 Ships: -100 (1)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 6th April,  2529

run.pl - uses hostname to detect stallo or vilje. Needs testing for
          titan


AOTnPOD_ml
   new index SPOD added    (SPOD is experimental. Not for routine output)

Derived
   SPOD enabled. 

DryDep_ml
   SPOD enabled. Possibility of ascii outputs (default off)  

MosaicOutputs_ml
   SPOD enabled. 

Rsurface
   extra debug

Sites_ml
   made site_gn public  ( was site_n)

ZD_OZONE/My_Derived_m
  SPOD added


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter 4th April 2013 (2528)

New paramater in namelist for ModelConstants_ml:
 EMIS_OUT    = .false.           ! output emissions in separate files (memory demanding)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave,  3 Apr 2013 (2527)

** results change a little. Due to slighlty different coverage of
   IAM species. Also, somewhat updated DO3SE params **

New 5km landcover file (LC) used, with allowance for flexible
landcover. 

Landuse_ml - reads the Landuse_PS_5km_LC.nc file to set Land_Codes
           - if a variable IAM_VEG is found, creates fake
             landcover for all veg in FLUX_VEGS array (see below)

             Hard-coded LC defns removed :-)

DO3SE_ml - modified to use Land_Codes coming from Landuse
LandDefs_ml - modified to use Land_Codes coming from Landuse
  
ModelConstants_ml - added new namelist item:
  FLUX_VEGS   - can be IAM_DF, or NEUR_SPRUCE etc.
  + new variable nFluxVegs which is used in Landuse_ml
    removed unused variable NVGOUT_MAX

(defaults set in config_EMEPSTD.nml, config_IMPACT2C.nml)

StoFlux - removed unneeded variables (NLanduse_DEF)

run.pl - links to new files, exclude link to older

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter, Dave 2nd April 2013 (2526)

Towards new system to define landuse codes from netcdf file, instead of predefined list.
Landuse_ml will first try to find a file 'Landuse_PS_5km_LC.nc'. 
If this is found it includes all landuse with names of the form LC:CF:EMEP (where CF can be any name).
The missing data are still read from the "old" "LanduseGLC.nc" (with old names).


Recipe for use:
include this line in the run.pl
  $ifile{"$DataDir/Landuse/Landuse_PS_5km_LC.nc"} ="Landuse_PS_5km_LC.nc";
The rest is automatic

If the file is not found, old system is used (i.e. default if run.pl is not modified).
/global/work/mifapw/emep/mk.rename 
has been used to make the new names

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 29 March 2013 (2525)

i) Corrected MY_OUTPUTS usage (I had forgotten to commit My_outputs_ml and Met_ml) 
ii) towards more flexible landuse/DO3SE params:

ModelConstants_ml: NLANDUSEMAX increased to 30

ZD_OZONE/My_Derived_ml: extra requets for "real" species (NEUR_SPRUCE etc.)

ZD_OZONE/My_Outputs_ml:  uses MY_OUTPUTS as decribed below

LandDefs_ml - NLANDUSE_EMEP = 29  ! work-in-progress
              More flexible definition of forests (LAImax>0.5, h>5)

Met_ml - PARLAM soil water fixed as noted below

GridValues_ml, StoFlux_ml - small debug changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 27 March 2013 (2524)

MY_OUTPUTS variable now used in place of EXP_NAME, with new system

   EXP_NAME - should match the config file

   MY_OUTPUTS should select the appropriate data-sets in My_Outputs_ml

  - added in config_EMEPSTD, config_EMERGENCY, etc.


BUG-fix for PARLAM usage and extensions for "real" species, and re-enabled
   PARLAM runs with soil water

AOTnPOD_ml - added e.g. POD1_ACE_BEECH etc.

DO3SE_ml - longer names allowed

Met_ml - SMI now calculated for PARLAM inputs too. Reads anyway FC and PWP from IFS, as
these are used elsewhere. So, we are assuming that PARLAM gives SMI, then this can be
used with IFS  FC and PWP if needed.

SubMet_ml - sets L%fSW - BUG FIX for PARLAM usage.

GridValues_ml - small debug change

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TAG: 2522 as rv4.2.1 SVN!!!  25th March 2013 xxxxxxxxxxxxxxxxxxxx
          (version used for ECLAIRE tree-specific delivery, Dave)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Alvaro 22th Mar 2013.  (2520-1)

* Move NEST_MODE to Nest_ml (changes namelists also)
* Small ammend to 2518
* Small chanke to Units_Scale (Units_ml)

ModelConstants_ml,Nest_ml,config_*.nml:
  move NEST_MODE from ModelConstants_ml to MODE on Nest_ml.
  MODE is now read on Nest_config namelist (config_*.nml).

NetCDF_ml:
  redefine CheckStop(chunksizes...) on Out_netCDF.

Units_ml:
  Units_Scale regognizes "ppbv" units as "ppb".

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave   22nd Mar 2013.  (2519)

Changes for IMPACT2C and more general Out3D outputs:

   config_IMPACT2C.nl file added (needs checks on F/T options)

   Output_hourly - options to outut xn_shl added to Out3D case
     (Note: Out3D should replace all earlier use of ADVppb etc.,
      it is a much cleaner system.)
     IMPACT2C cases added as example

  My_Outputs_Ml - IMPACT2C cases added as example with O3, NO, NO2
    and HO2 output at 3m and 45m

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Alvaro 21th Mar 2013.  (2518)

* Handle chunksizes for nc4zip output explicitely.
  Fixes a bug introduced on rv4.2beta4 (4 Feb 13).
* Fix wrong file name for NEST_MODE 1, 11 & 12.
* Move char(0) fix from Nest_ml to Units_ml

NetCDF_ml:
  Additional optional parameter (chunksizes) on Out_netCDF and createnewvariable.
  When present, it sets the size of the data chunk writen by Out_netCDF
  to a variable on a compressed file.

Output_hourly:
  For 3d output, sets chunksizes for a 2d slize on Out_netCDF(create_var_only=.true.)

Nest_ml:
  Additional file_%=date2string(template_%,indate) to ensure that the
  file names are properly defined/updated.

Nest_ml,Units_ml:
  Move the invisible character (char(0)) removal intorduced on 2513
  from read_newdata_LATERAL and reset_3D (Nest_ml) to Units_Scale (Units_ml).
  Now, the full string is searched for char(0).
  
Nest_ml,config_EMEPSTD.nml
  Define subdomain for write (istart,jstart,iend,jend) on
  NEST_MODE 1 and 3 on Nest_config namelist.
  Other write modes write full RUNDOMAIN regardles of namelist.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave  15th Mar 2013.  (2516-2517)

  Just corrected text on location of mk.meteoPreProc for HDD files
  (has been in utils for some time now, not ZD_EXTRA)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter 15th Mar 2013.  (2513-4-5)

In Nest_ml added two times this line:
if(ichar(units(ilen:ilen))==0)units=units(1:ilen-1)!removes the last invisible character (char(0))

This is because C codes defines strings with a char(0) at the end.
It is invisible, but can makes 'ppb'=='ppb' false. This happen for 
instance when units are written in a netcdf file with nco library.

Made a temporay fix so that the model does not crash when the number of vertical 
levels is larger than 20:
GlobalBCs_ml.f90 
DefPhotolysis_ml.f90
These routines have to be changed anyway if KMAX/=20

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter & Alvaro  14th Mar 2013.  (2511-2)

Nest_ml:
  Fix bug on read IC/BC files for variables on ug/m3 or other units that
  need air density on the unit conversion to mol/mol.
  The logical variable divbyroa was defined only on MasterProc,
  therefore the unit conversion was incomplete/wrong elsewhere.
  
ExternalBICs_ml,Nest_ml:
  Improve comments. Add variable and subroutine descriptions.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  7th Mar 2013.  (2507-9)

Output in hPa. Pressure PS always put in hourly output, but removed from the others:
PS is needed to define vertical coordinates, but is not correctly defined if averaged, as in daily/monthly/full.

NetCDF_ml.f90
Derived_ml.f90
ZD_OZONE/My_Derived_ml
Output_hourly.f90

Small changes Met_ml Check_Meteo_Date (inq_varid->inq_dimid, close file)
GridValues: A_bnd=P0*A_bnd

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Svetlana  6th Mar 2013.  (2506)

AOD_PM_ml.f90 - has new AOD_Ext routine with updated AOD calculations 
(accounting for aerosol "size"  and relative humidity). 
Also calculates 3D Extinction Coeffecient

Runchem_ml.f90 - calls for AOD_Ext

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Heiko 5th Mar 2013.  (2504)

Makefile
  - enable builds on met.no-precise machines

EmisGet_ml.f90
  - change read format from "i" to "i6" to satisfy gfortran on precise

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Alvaro 1st Mar 2013.  (2503)

Update Pollen module and use on FORECAST runs.

Makefile,config_FORECAST.nml
  - MACC target is compilled wiht Pollen tracers
  - USE_POLLEN on FORECAST runs

Makefile.SRCS
  - Revert changes on 2497. AOD_PM_ml instead of AODrh_PM_ml,
    so the model can be compiled.

run.pl
  - move/rename restart/dump files for EMERGENCY runs
  - link/rename pollen restart/dump files for FORECAST runs

PhyChem_ml
  - Call to pollen_dump/pollen_read on FORECAST mode

Par_ml
  - add MSG number for global2local call on pollen_read

Pollen_const_ml,Pollen_ml,Makefile.SRCS
  - split Pollen module in Pollen_const_ml & Pollen_ml
    to resolve circular dependency wiht My_Outputs_ml

ZD_OZONE/My_Outputs_ml,Output_hourly
  - Pollen hourly output for FORECAST runs
  
Pollen_ml
  - Review code
  - Add pollen_dump/pollen_read subroutines for restart/dump files on FORECAST mode
  - Align/format & other house keeping

Runchem_ml
  - Add pollen_flux calls
  - Align/format & other house keeping

Unimod
  - PrintLog(...,USE_POLLEN)
  
NetCDF_ml,
  - remove use My_Outputs_ml FREQ_HOURLY

Emergency_ml,Makefile
  - Increase number of emergency senarios in une run.
  - Set all 10 NPP accident senarios as default.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Heiko  9th Mar 2013 (2510)

setting xenon as nobel-gas
using Xe-133 instead of Xe-131 (stable)
adding Dust and SeaSalt to emergency-runs, required by Svetlanas new AOD-module
writing out conc for all NPP and NUC, dropping 3d output (TODO: wdep,ddep)
removing restriction on 9chars per NPP/NUC

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Heiko  1st Mar 2013.  (2502)

put back positve="down" for sigma-coordinate after reading CF-convention

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  1st Mar 2013.  (2501)

Put "units=Pa" for hyam and hyai.
NetCDF_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Heiko  1st Mar 2013.  (2500)

Remove 'units' and 'positive' for atmosphere_sigma_coordinate
writing PT to file in hPa

Modified:
NetCDF_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  28th Feb 2013.  (2499)

NetCDF_ml can now output in hybrid coordinates and following 
CF-1.6 convention (requires USE_EtaCOORDINATES=.true.).
Also corrected a bug for output hourly that prevented to write 
out all 21 levels (20+surface). 
PS written out, because it is used (with name "PS" and unit Pa) 
to define the vertical coordinates.

Modified:
NetCDF_ml.f90
Derived_ml.f90
ZD_OZONE/My_Derived_ml
Output_hourly.f90
Met_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Svetlana  28th Feb 2013.  (2494-8)

AODrh_PM_ml.f90 - updated AOD calculations (accounting for aerosol "size"
  and relative humidity). Also calculates 3D Extinction Coeffecient
Chem_ml.f90 - new parameter Extin_Coeff
Makefile.SRCS
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  27th Feb 2013.  (2493)

More changes for hybrid vertical coordinates. Should not affect results.
New advection and convection in hybrid coordinates: convection_Eta, advecdiff_Eta
the "p*" from sigma equations must be replaced by dp/deta 

Adapted routines:
CellMet_ml.f90 
BoundaryConditions_ml.f90 
Convection_ml.f90 
Advection_ml.f90 
Emissions_ml.f90 
Met_ml.f90 
Sites_ml.f90 
Setup_1d_ml.f90 
Volcanos_ml.f90 
ZD_VBS/My_SOA_ml.f90
ModelConstants_ml.f90
PhyChem_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  26th Feb 2013.  (2492)

Defined Etadot and reversed the change from (2490). 
The default is again the old (same as before 2490) method!
To use new cordinates Etdot has to been exlicitely used.
Since the value of Eta at a given altitude differ from sigma, the two methods 
are not identical.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  25th Feb 2013.  (2491)

Defined EtaKz and the corresponding routine (Kz_m2s_toEtaKz). Not in use yet.
(EtaKz will replace SigmaKz at some later stage)
MetFields, Met_ml, BLPhysics_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  22nd Feb 2013.  (2490)

Define hybrid vertical coordinate Eta=A/Pref+B in GridValues.
Modify sdot definition derived from horizontal winds in Met_ml.
NB: this will modify results! 
The vertical winds should be weaker over mountains, specially at high altitude.
Also prepared a new routine in Advection_ml (not used yet).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave   21st Feb 2013.  (2487)

Sites_ml - local MY_DEBUG replaced by use of DEBUG_SITES, plus extra
           debug formatting

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  20th Feb 2013.  (2486)
A new step towards flexible vertical coordinates.
The grid definitions (and in the future all static data) can be read from a separate file,
Grid_Def.nc
Experimental so far (not used by default)
Met_ml.f90
GridValues_ml.f90
run.pl

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave  20th Feb 2013.  (2485)

Enabling extra outputs of ozone-flux params, plus more explicit
use of L% variables in DO3SE calculations

Derived_ml - change of label (YYYY to D2IND - latter is easier to find)

DryDep_ml - safer use of L and Sub 
          - SPOD_OUT outputs added. Temporary, and switched off by
            default

DO3SE_ml - safer use of L and Sub 

Io_Nums_ml - IO_SPOD added. CAREFUL - many io numbers can be called,
   as DryDep uses IO_SPOD  me. (Not switched on by default though.)

LocalVariables_ml  - just use -999 not -999.999 to avoid -1000 in prints

Mosaic_ml - added extra outputs

Rsurface - safer use of L and Sub 

Sites_ml - some variables made public for use in DryDep

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter, Dave  20th Feb 2013.  (2484)
AOD initialized to 0.0 in Chem_ml.f90 (could lead to crash when debug option used)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter, Dave  19th Feb 2013.  (2483)
replaced "/WH2O" by "/max(WH2O,FLOOR)" in MARS_ml, since WH2O could get zero.
Not expected to change results.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Alvaro  18th Feb 2013.  (2482)

Emergency_ml,ZCM_Emergency/NPP_Accident.csv
  Extend emergency event (eEMEP:volcanic eruption or npp accident) defaults.
  A single defaul can have multiple lines, e.g.
  each line with a difinition for a different specie

ZCM_Emergency/NUC.species,NUC.reactions,NUC_Location.csv,NUC_Explosion.csv
  Additional files for nuclear explosion scenarios (eEMEP)

mk.GenChem,run.pl,Makefile
  Aditional tracers and emissions for nuclear explsion senarios (eEMEP) with
    mk.GenChem -X scenario

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  18th Feb 2013.  (2481)
Removed all the "MPIbuff" used to buffer the data in  MPI_ALLREDUCE.
Can use "MPI_IN_PLACE" instead.
Does not modify results.
Advection_ml, GridValues_ml, MassBudget_ml, AirEmis_ml, Emissions_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  18th Feb 2013.  (2480)
Correction to the 2477 changes: The factor could be negative in some cases.
Timefactors_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave  18th Feb 2013.  (2479)

ZD_.../My_RunSettings files removed. Not used.

Dave  18th Feb 2013.  (2478)

Country_ml - extended with IIASA global regions. ERROR spotted for
  older global regions - timezones should be set to -100 for US, Canada
  and quite a few other regions. Not done yet!

  Country regions EU27, EEA, XMACC2 ... defined. Used in:


EmisGet_ml, Emissions_ml - extended to allow incl and excl arrays
  which can be used to choose between global IIASA emissions or
  higher resolution cdf emissions. As cdf emissions are not yet
  enabled in the code, no effect so far, except to help produce
  EmisOutCdf ascii files which contain merge of global and INERIS/TNO
  emissions for different grids.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter 15th Feb 2013.  (2477)

NB: this will affect results a lot! (shift emissions by 2 weeks)

EmisGet_ml.f90: close netcdf (memory leak otherwise)
InterpolationRoutines_ml, new routine Averageconserved_interpolateInterpolate
Timefactors_ml: timefactor for month, new interpolation between monthes. (see also 2480).

New turning point at the middle of the period. The equation to solve is then:
1)Factor at start of month is equal average between two adjacent month
2)Factor at end of month is equal average between two adjacent month
3)Integral or average over all factors in a month is equal to monthly factor
4)The factor changes linearly from start to middle, and middle and end of the month

The value to calculate by a simple formula is then the factor at the middle of the month that gives all the wanted properties.
If we don't take into account the discretization (but we will take this into account, so the formula will get much more unreadable):

Middle = 2*Average - (End + Start)/2

Also since we need a new turning point, we will get something like "if(xday<0.5)then ...else...".

This will give some level of extrapolation, since the value at middle of the month can for example be higher than the average of all the 3  monthes (but never unreasonable values).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Alvaro 15th Feb 2013.  (2475-2476)

Implement read/write for NPP Accident senarios (eEMEP/NUC)

Volcanos_ml,Emergency_ml,Makefile.SRCS,
  Move volcanic eruption code (eEMEP/ASH) out of Volcanos_ml
  into a new module Emergency_ml
  
Emergency_ml,Setup_1d_ml
  Rename EruptionRate to EmergencyRate

Emergency_ml,mk.GenChem,run.pl
  Rename volcanoes.csv and eruptions.csv to emergency_location.csv and emergency_emission.csv,
  respectively. The emergency_*.csv files contain locations and emissions parameters
  for all emergency senarios in use.

Makefile
  Add target eEMEP2013 for easy cinfiguration for "North Korea nuclear test"
  scenario

ZCM_Emergency/NPP_Accident.csv,NPP_Location.csv
  Add/update scenario paramenters for NPP accidents

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 14th Feb 2013.  (2474)
Code added to test new netcdf emission systems.  The new emissions don't
do anything just yet except slow the code down enormously if
swtiched on (-> interpolation from 7km for many countries), but a
new routine EmisOut has been added to produce emislist-like files. Thus,
it should be possible to run the code slowly once, then use the ascii.
At least until we have speeded things up. All in testing!


ModelConstants_ml
   EMIS_SOURCE EMIS_TEST added

   EMIS_SOURCE can be emislist (default) or CdfFractions (Peter's intepolation
    from INERIS 7km).

   EMIS_TEST can be none or CdfSnap - my testing

   SEAFIX_GEA_NEEDED moved into namelist

EmisGet_ml
   Added routine EmisGetCdf to read new netcdf files. Reads all variables
   with name-prefix of Emis:  (e.g Emis:UK:snap:7). Prelim.

Emissions_ml

   With EMIS_TEST = CdfSnap, now calls EmisGetCdf (above) and
    interpolates from new netcdf emissions. Results
    stored, not used. Can be output with:

   EmisOut routine - outputs emislist-like ascii files. Works for
    current snap, CdfFrac-type and CdfSnap-type


run.pl
    Link to netcdf emissions added. All prelim, and for testing.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Alvaro 13th. February (2473)

ExternalBICs_ml.f90,*/*_ExternalBICs_ml,Makefile,Makefile.SRCS,Nest_ml
  Merge */*_ExternalBICs_ml into a single module.
  Application specific code goes into namelist, see config_FORECAST.nml.
  Data type icbc extended for BC descriptions to be EmChem independent.

ModelConstants_ml,config_EMEPSTD.nml
  Set RUNDOMAIN on namelist
  
Nest_ml,config_EMEPSTD.nml
  Set filename templates on namelist  

run.pl,config_FORECAST.nml,config_EMERGENCY.nml
  Add namelist files for FORECAST & EMERGENCY runs

mk.GenChem,ZCM_Emergency/NPP_Location.csv,ZCM_Emergency/NPP_Accident.csv
  Add emission defaults for NPP accident.
  Rename NPP.csv to NPP_Location.csv

ZD_OZONE/My_SOA_ml.f90
  Remove Fgas definition

ZCM_EmChem09/BiomassBurning_GFASv1_to_EmChem09.inc
  new file

Units_ml
  ug/m2 output for column output

Volcanos_ml
  Eruption_found=.true. for first call on EMERGENCY mode

ZD_OZONE/My_Outputs_ml.f90
  Nuclear accident output

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 13th. (was 2468-2471)

Country_ml - added global IIASA/ECLIPSE countries

GridAllocate_ml - optional debug flag added

Emissions_ml, EmisGet_ml -  call to femis moved to Emissions_ml

NetCDF_ml - check subroutine made public

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxx  rv4_2 MOVE TO SVN!!!  12th February 2013 xxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Code-based moved from stallo. Code in rv4_2 has several changes which
affect results compared to rv4_1.


xxxxxxxx  rv4_2beta7      Peter  8th February 2013 xxxxxxxxxxxxxxxxxxxx

Bug in last change: did not close the file before returning in the "skipping" case. This created a memory leakage.
NetCDF_ml

xxxxxxxx  rv4_2beta6      Peter  6th February 2013 xxxxxxxxxxxxxxxxxxxx

Still INTERIM -same statis as rv4_2beta5nml

NetCDF_ml: look for minlat,maxlat,minlon,maxlat to see if data reading kan be skipped
Could need some polishing for 360 degree periodicity og longitudes.

xxxxxxxx  rv4_2beta5nml   INTERIM!!! Dave  5th February 2013 xxxxxxxxxxxxxxxxxxxx

namelist system started, changes indicated by !NML in code.


ModelConstants_ml now has routine config_ModelConstants, called from
Unimod.

The namelist file is so far called by run.pl using $exp_name, which
is EMEPSTD by default.

file config_EMEPSTD.nml added to cvs.

Code will now not work for FORECAST etc. - that will need a new namelist file,
config_EMERGENCY.nml, config_FORECAST etc.

Changes in

run.pl  - exp_name and config_$exp_name.nml added
ModelConstants_ml
Emissions_ml  (MONTHLY_EMIS now in ModelConstants)
Io_Nums_ml (now has IO_NML)
NetCDF_ml  (SELECT_LEVELS_HOURLY, now in ModelConstants)
Output_hourly  (SELECT_LEVELS_HOURLY, now in ModelConstants)
Volcanos - NEEDS CHECK. HAD Vent_found, Eruption_found tied to
  USE_EMERGENCY, but presumably even standard runs could have
  emissions? Suggest different logic, but set false for now
   (Is Vent_found used?)
My_Outputs_ml  (SELECT_LEVELS_HOURLY, now in ModelConstants)

xxxxxxxx  rv4_2beta5 Dave  5th February 2013 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

use of rough.dat removed
nwp_sea now replaced by mainly_sea, derived from landcover fractions


Landuse_ml
   Now uses SEA_LIMIT to set mainly_sea and likely_coastal arrays

Met_ml
   Remove code for rough.dat, use of 

ModelConstants_ml
   new param: SEA_LIMIT = (/ 0.2, 0.5 /)

run.pl - no rough.dat



Minor changes (rename, or comment out-often nwp_sea was "use"d but not used)
BLPhysics    - comment out
Boundary_conditions_ml  - rename nwp_sea
CellMet_ml   - rename is_NWPsea to  is_mainlysea, is_allNWPsea to is_allsea
ChemFunctions_ml  - rename nwp_sea
GlobalBCs_ml - comment out
LocalVariables_ml   - rename is_NWPsea to  is_mainlysea, is_allNWPsea to is_allsea
MetFields_ml - remove nwp_sea
SeaSalt  - rename nwp_sea
SoilWater_ml - comment out
SubMet_ml   - rename is_NWPsea to  is_mainlysea, is_allNWPsea to is_allsea
LocalVariables_ml   - rename is_NWPsea to  is_mainlysea, is_allNWPsea to is_allsea


ZD_VBS/My_SOA_ml - changed output format for the Tab SOA line.

xxxxxxxx  rv4.2beta4 Alvaro & Heiko 4rd February 2013 xxxxxxxxxxxxxxxxxxxxxx

Small changes related to eEMEP hourly output and Forecast BC nesting.

NetCDF_ml
  For 3D output compress files, set chunk-size (nf90_def_var_chunking)
  to horizontal slices of 3D fields.
  This would allow to compress output on runs which require
  multi level hourly output, such as Forecast, eEMEP and Transphorm.

ModelConstants_ml
  Always compress NetCDF output

ZCM_Emergency/Mastin*_table3.csv:
  * Rename Mastin files (eEMEP/Erupting volcanoes).
  * Replace special characters (e.g. ���) on vent names.

Makefile:
  include *.inc files on *.tar.bz2

Nest_ml,/ZD_OZONE/*_ExternalBICs_ml
  * Move filename_read_3D, filename_read_BC & filename_write back from Nest_ml
    to My_ExternalBICs_ml.
  * Remove if(EXTERNAL_BIC_SET) before call set_extbic as it prevented all calls,
    which are needed for FORECAST runs.
  * subroutine set_extbic (My_ExternalBICs_ml) does no longer update filenames.
  * New soubrotune update_bicname(date) (My_ExternalBICs_ml) updates
    filename_read_3D, filename_read_BC & filename_write according to date,
    following respective template_filenames defined on My_ExternalBICs_ml.
  * Additional call to update_bicname on wrtxn before inquire about
    filename_write existence ensures that BC output can be splitted on
    daily or monthly files.

xxxxxxxx  rv4.2beta3 Dave   31st January 2013 xxxxxxxxxxxxxxxxxxxxxx
(changes currently flagged with JAN2013 and/or SPOD. Will remove
 later)


CHANGES RESULTS:

1)  Unimod.f90, Landuse_ml.f90

    - call to Init_DO3SE moved from Unimod to Landuse_ml, since some
      params are needed for the first call to fPhenology

2) DO3SE_ml  - bug fix on g_sun usage - CHANGES RESULTS

Other:

DO3SE_ml and LocalVariables_ml - added more for access to DO3SE f functions
   (e.g. L%f_env, L%f_sun, etc...)

Rsurface_ml    - L%f_env set, for easier debug info


xxxxxxxx  rv4.2beta2 Peter  30th January 2013 xxxxxxxxxxxxxxxxxxxxxx

KMAX_MID is read from the meteo file. All arrays using KMAX are made allocatable or automatic.
Many files modified:
Setup_1dfields_ml.f90
Chem_ml.f90 
MassBudget_ml.f90
Advection_ml.f90
Aqueous_n_WetDep_ml.f90
GlobalBCs_ml.f90
BoundaryConditions_ml.f90
Met_ml.f90
DefPhotolysis_ml.f90
ForestFire_ml.f90
Nest_ml.f90
Sites_ml.f90
GridValues_ml.f90
ModelConstants_ml.f90
GenChem.pl
ZD_VBS/My_SOA_ml.f90

xxxxxxxx  rv4.2beta Peter  29th January 2013 xxxxxxxxxxxxxxxxxxxxxx

More "continuous" function for MARS_ml.f90. NB: Will modify results!
For RATIO (= TNH4/TSO4) between RATIO_Low and RATIO_High, consider the species in two boxes one with
 RATIO_Low and the other with  RATIO_High. Then take a linear combination of the results in each box
(as discussed at meeting 1st Nov 2012)

xxxxxxxx  rv4.1.16 Peter/Svetlana 29th January 2013 xxxxxxxxxxxxxxxxxxxxxx

Bug for  nwp_sea. Array not initialized and only .true. forced. Therefore nwp_sea had a random value when
no rough.dat file was found and not sea.

Changed InitLanduse to force value also when nwp_sea=.false.

xxxxxxxx  rv4.1.15 Birthe 28th January 2013 xxxxxxxxxxxxxxxxxxxxxx

New Pollen.
Pollen_ml : emissions is now gicen in rcemis and NatEmis

ZCM_EmChem09/Pollen.reactions: updated for the new emissions

Makefile.SRCS : included Pollen_ml

xxxxxxxx  rv4.1.14 Peter 28th January 2013  xxxxxxxxxxxxxxxxxxxxxx

Attempt to retablish the original Nest functionality, as documented in header of Nest_ml.f90
For EXTERNAL_BIC_SET=.false. nothing from My_ExternalBICs_ml.f90 is used.
Moved filenames into Nest_ml and call set_extbic only if EXTERNAL_BIC_SET=.true.
Default when EXTERNAL_BIC_SET=.false. is to read/write all components.

Modified: Nest_ml.f90, ZD_OZONE/My_ExternalBICs.ml.f90


xxxxxxxx  rv4.1.13 Alvaro, Agnes & Heiko 25th January 2013  xxxxxxxxxxxxxxxxxxxxxx

Update to eEMEP code. Small bug fixes and add code needed for NPP accidents.

Makefile
  eEMEP target NPP accident locations can be set with enviroment variable NPPAS.
  If NPPAS is not set, the NPP accident locations are kept.
  
mk.GenChem:
  * Fix bug on seed command for vent name generation, e.g.
      vent code 0103-00- to variable nameV0103A00A
  * Additional options
    -q Quiet mode. No GenChem.pl chatter.
    -N List of NPP accident locations to use on eEMEP runs.

ZCM_Emergency/NPP.*: Add NPP accident files
  NPP.csv         Pre-defined Accident locations
  NPP.species     Nuclear tracers
  NPP.reactions   Decay and emission

ZD_OZONE/My_Derived_ml: Derived output Nuclear accident tracers
  Add commented definitions for surf, dryDep and wetDep daily output.

Volcanos_ml:
  Increase the number of active vents (erupting volcaoes).
  Previous versions could only deal wuth 5 or less vents (bug).

NetCDF_ml: 
  Avoid filling out varables on creation by calling
  nf90_set_fill(NF90_NOFILL) from Out_netCDF(create_var_only=.true.)

Nest_ml:
  Runs which write IC/BC files (wrtxn) hang on creation of the file.
  This is because the a "fast" Proc may not find the file, and create it,
  and another will find that the file exist and skip the relevant code. 
  Now, the MasterProc inquire if the file exist, and the result is MPI_BCAST
  to the other Procs.

GenChem.pl:
  vatiables @rate_label, @rct, @rcttext defined twice

xxxxxxxx  rv4.1.12 Dave, Svetlana  22th-25th January 2013  xxxxxxxxxxxxxxxxxxxxxx

DS: utils directorty added - a place to store helper programmes

  mk.meteoProc  moved from ZD_EXTRA to utils
  meteoProc.f90 moved from ZD_EXTRA to utils

  Rd_csvsites.f90
  README.Rd_csvsites

ST: Derived_ml.f90: for consistency KMAX_MID is changes to KMAX_BND for

                Kz_m2s(i,j,KMAX_BND-1)

xxxxxxxx  rv4.1.11 Peter     10th January 2013  xxxxxxxxxxxxxxxxxxxxxxxxx

small change in script ZD_EXTRA/mk.meteoPreProc

xxxxxxxx  rv4.1.11 Heiko/Dave     7th January 2013  xxxxxxxxxxxxxxxxxxxxxxxxx

Corrected home of model to MSC-W, not MSC-E in Docs!
(Somebody in the group is confused about who we are maybe?!)

xxxxxxxx  rv4.1.10 Dave, safety   20th December 2012  xxxxxxxxxxxxxxxxxxxxxxxxx

Emissions_ml SEAFIX changed/corrected. Not sure who.

xxxxxxxx  rv4.1.9 Dave           14th December 2012  xxxxxxxxxxxxxxxxxxxxxxxxx

Country_ml - removed need for ModelConstants_ml dependency (was for SEAFIX_GEA)

Emissions_ml - added SEAFIX_GEA here.

xxxxxxxx  rv4.1.8 Alvaro          3rd December 2012  xxxxxxxxxxxxxxxxxxxxxxxxx

DryDep derived output for any group and deposition unit (supported Units_ml).
 
OwnDataTypes_ml
  * new type typ_si with one string (%name) and one integer (%ind)
  * Align/format & other house keeping

ZD_*/My_Derived_ml:
  * Remove now obsolete variables SOX_INDEX, OXN_INDEX & RDN_INDEX
  * Allow different frecuencies for different DDEP_ECOS
    by using typ_si on definition (Add_MosaicDDEP)

MosaicOutputs_ml:
  * Use different frequencies for different DDEP_ECOS (Add_MosaicDDEP)
  * Remove hard codded Ddep units/index/groups (e.g. mgSm2/SOX_INDEX/DDEP_SOXGROUP)
    from Add_MosaicDDEP
  * Use Units_Scale to calculate unitscale for Ddep of single species (Add_MosaicDDEP).
  * For group Ddep, pre-calculate group indexes and unit conversion for factors
    with Group_Scale, and store them in dryGroupUnits array (Add_MosaicDDEP).
  * Use for different unit conversion factors for each Ddep group member
    on Add_MosaicOutput.
  * Align/format & other house keeping

ModelConstants_ml:
  * Remove now obsolete variables SOX_INDEX, OXN_INDEX & RDN_INDEX

Other changes for FORECAST(MACC)/EMERGENCY(eEMEP) modes

Makefile
  * archive target creates Unimod_YYYYMMDD.tar.bz2 when the model is compiled.
    The archive file contains all sources and scripts
  * MACC target use GFASv1 Forest Fires instead of FINNv1
  * eEMEP target erupting volcanoes can be set with enviroment variable VENTS.
    If VENTS is not set, the default erupting volcanoes are kept.

Nest_ml,ZD_OZONE/IFSMOZ_ExternalBICs_ml,My_ExternalBICs_ml
  * Allow for fractions on IC/BC components, e.g. 
    for IFS_EVA_2010 BCs 'OC'*1.7 goes into IXADV_FFIRE_OM

ZCM_EmChem09/BiomassBurning_GFED_to_EmChem09.inc
  * update parameter names & numbers

xxxxxxxx  rv4.1.7 Dave 29th November 2012  xxxxxxxxxxxxxxxxxxxxxxx

Updated Degreeday/HDD system - start of more general pre-processing of met data
Files added in ZD_EXTRA so far, to avoid need for yet another sub-directory.
(Could have used e.g. Aux)

New prog and script here:

ZD_EXTRA/meteoPreProc.f90   added to cvs system
ZD_EXTRA/mk.meteoPreproc    added to cvs system

   The code here does the same job as the old DegreeDayFactors, but is a bit cleaner
   Fixes also an "apparent" problem with i,j coordinates for TNO type lat/lon grids.
   (No difference in model runs, but ncview will now see the data the right way up.)

Also, more safety checks in:

NetCDF_ml.f90
        - to make sure idimID found (catches files with x,y instead of i,j).

Io_Progs_ml.f90  - now calls CheckStop if a "needed" file is missing.

Timefactors_ml.f90 - DegreeDayFactors.nc needed=true  used

xxxxxxxx  rv4.1.6 Alvaro         20th November 2012  xxxxxxxxxxxxxxxxxxxxxxxxx

Small bug fixes and settings for FORECAST(MACC)/EMERGENCY(eEMEP) modes.

GridValues_ml:
  Fix bug introduced on rv4.1.2 (Oct 8, 2012).
  Only simulations on EMEP2010 and EMERGENCY mode were affected.
  Procedure coord_check(lon,lat,fix=.true.) converted longitudes
  from the -180..180 range to 0..360 range. The opposite conversion was required.
  Current version of coord_check converts longitudes to the -180..180 range.

ModelConstants_ml:
  Since rv4rc11 (Sep 13, 2012) USE_DUST and USE_ROADDUST are .true. by default.
  Now they are .false. on FORECAST mode.

Volcanos_ml:
  Reduce DEBUG_EMERGENCY output

ForestFire_ml:
  On FORECAST mode, the forest fire file might not present.
  In which case about 550 warnings are issued every day of simulation.
  Now, Fire_Emis checks if forest fire file exists before attempting to read it.
  In FORECAST mode return it after setting burning=.false.,
  otherwise stop the simulation.

ZD_OZONE/My_Derived_ml:
  Add daily output for ASH groups.
  They will be skipped if the groups are not found.
  
xxxxxxxx  rv4.1.5 Alvaro         16th November 2012  xxxxxxxxxxxxxxxxxxxxxxxxx

Add 3DVar code to repository:
  ZD_3DVar/My_3DVar_ml.f90
    Link dummy 3DVar module for when NO 3DVar is required.
  ZD_3DVar/Makefile,Makefile.SRCS
    sub-make files for compiling 3DVar programs Unimod_Bnmc and Unimod_3DVar
  ZD_3DVar/DA_ml,B_NMC/*.{f90,F,c},Analysis/*.{f90,F}
    3DVar and Bnmc source files

Makefile,Makefile.SRCS:
  * update stallo module requirements for the new module system
  * rename module checking functions
  * Link dummy 3DVar module (ZD_3DVar/My_3DVar_ml.f90) for Unimod
    compilaton targets, such as EMEP, eEMEP & MACC
  * Add %-Bnmc and %-3DVar compilation targets for
    EXP_Bnmc and EXP_3DVar targets on ZD_3DVar/Makefile which compile
    ZD_3DVar/Unimod_Bnmc and ZD_3DVar/Unimod_3DVar
    
ModelConstants_ml:
  * add logical parameter ANALYSIS for sich on/off 3DVar

Nest_ml:
  subroutine wrtxn
  * rename allocatable array dat to data
  * allocate data on each call and deallocate after usage
  * remove now unnecessary variable first_call
  subroutine init_nest
  * new logical parameter USE_LAST_HYBRID_LEVELS=.true.
  * check if number of vertical levels on variable and vertical dimension
    matches for hyam/hybm case and:
    * Stop simulation of hyam has less levels than variable.
    * If the variable has less vertical levels than hyam,
      assume that last vertical levels are the correct ones (if USE_LAST_HYBRID_LEVELS).
  * Previously versions assumed the first values of hyam/hybm to be the correct
    ones. The behaviour can be restored by setting USE_LAST_HYBRID_LEVELS=.false.

PhyChem_ml
  * Introruce 3DVar calls before first time step and EndOfDay
  * move call wrtxn (write IC/BC for Nest run) after EndOfDay 3DVar call

Timing_ml
  * 7 additional timing tags (NTIMING=39+7) for 3DVar
  * write timing tags only of they are non empty (Output_timing)

run.pl
  * set TNO emission path on vilje
  * do not re-compile SR or or ARRAY jobs
  * add IC file to RunLog.out
  * CWF Forecast/Analysis modes with different scenario names
  * CWF Analysis runs ZD_3DVar/Unimod_3DVar
  * CWF Forecast options for long runs (more than 10 days)

ZCM_EmChem09/EmChem09base.species
  * NO2 in daObs group

ZD_OZONE/IFSMOZ_ExternalBICs_ml
  * Rename IXADV_FFIRE_OC --> IXADV_FFIRE_OM
  * Set IFS_EVA_2010 BCs%wanted=.false. for OC and OM
  
ZD_OZONE/My_Outputs_ml
  * change EVA2010 hourly output names to upercase
  * add unique hr_out%name to consistency check

xxxxxxxx    rv4.1.4 Peter/Matthias  12th October 2012  xxxxxxxxxxxxxxxxxxxxxxxxx

Emissions_ml: if(USE_ROADDUST)gridrcroadd0(:,:,:) = 0.0 
(if was missing and causes problems with gfortran compiler)

EmisGet_ml: bug in reading file (possibly no error in normal runs, but I didn't check)
emis_kprofile(1:nemis_kprofile,snap) = tmp(1:nemis_kprofile)


xxxxxxxx    rv4.1.3 Dave/Alvaro  9th October 2012  xxxxxxxxxxxxxxxxxxxxxxxxx

Derived_ml - skips PM25X etc if needed species aren't present

Io_ml      - output fmt to es11.3, instead of es11.0 when date-string used
Sites_ml   - gfortran complaint output for sites_  .csv


xxxxxxxx    rv4.1.2 Alvaro 8th October 2012  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


GridValues_ml,Volcanos_ml
  Wrong usage of gi0 and gj0 on the "right processor" check.
  It is likely that the error does not affect the results, as the actual 
  coordinate to grid point (lon/lat-->local i,j) calculation was correct.

Makefile
  - New modules in stallo:
    Check for new (after Oct 4 maintenance) modules if directory ~/.lmod.d exists.
    Otherwise the old modules are required.
  - GFASv1 forest fire for MACC targets
  
xxxxxxxx    rv4.1.1 Dave   3rd October 2012  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Safer coding (tolerates missing species) for:

Setup_1d_ml.f90   (e.g Rn222)

DustProd_ml

Updated:

Sites_ml : gfortran friendly (and anyway easier!) output formatting

ZCM_EmChem09/Biomass...FINN..... - using simpler system introduced for EmChem09soa


xxxxxxxx    rv4.1 Alvaro,Peter, Dave   2nd October 2012  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bugfix: Nest_ml, wrtxn, "dat" declared with save 

Dave: BUGFIX: Runchem_ml:   2nd call to setup_bio removed.
                            Results will change

Alvaro/Peter (1st October)
Advection_ml: Change of algoritm; more robust advection. 
              NB: The results will show differences.
	      The concentrations are "renormalized" (division by p*) 
              after each partial advection (x, y or z direction). 
              This removes the problems 
              caused by emptying an entire gridcell (extreme divergence).
              It has been tested in two cases where the old scheme failed: 
	      at NorthPole, and a 2km resolution run with extreme winds 
              around Jan Mayen (NILU).
	      The scheme was also recommended by Alain Clappier to reduce the 
              "cross problem" (underestimation of advection in diagonal 
              directions)
	      There is some CPU penalty for using this scheme.

NetCDF_ml: "Read_Inter_CDF", close at end.
           " CreatenetCDFfile", do not open after created
	   stop if fraction and not latlon

Par_ml:    NPROCY=1 (init for runs with very few processors)

Units_ml: umap public 

gFortran cleanup: 
  - Units_ml, Volcanos_ml, EmisDef_ml
  - update Makefile for MACHINE=hardy & lucid.
    gFortran optiomnization/pedantic options if DEBUG=no/yes
  
xxxxxxxx  rv4.0.1 rtagged 1st Oct 2012  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Birthe: 
DOCS/Manual rewritten for new OS release.

Alvaro 28th/9/2012  

Nest_ml:  Bug on init_nest for a IC/BC file on longlat.
  - lon_ext & lat_ext variables where wrongly set.
  - IC and BC longlat files are wrongly interpolated.
  - This bug was introduced on rv4rc5 (Aug 29th 2012).
  - It affects runs FORECAST mode. 

xxxxxxxx    rv4.0    18-19th/9/2012  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

(Retagged on 19th after Peter's last changes)

xxxxxxxx    OpenSource Sep 2012 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Setup_1d_ml: Bug when lightning but no aircraft was used 
(airn was used but not set). Separated rcemis into two parts. 

Setup_1d_ml: extra "if" for runing with debug and burning not defined.

Emissions_ml.f90: allocate airn also if only lightning are used

Volcanoes_ml :missing initialization for io

ForestFire_ml - will die if called with GFED and wrong years

ZCM_EmChem09soa/BiomassBurning-GFED updated to new system

xxxxxxxx   Svetlana/Alvaro/Dave 17/9/2012 xxxxxxxxxxxxxxxxxxxxx

ZCM_EmChem09soa/VBS_nonvolatile.species: PPM25_FIRE group 
My_Derived: PPM25_FIRE, 
            units change back to ugS/ugN for gases
            commented out intermediate SOA compounds

ZCM_EmChem09soa/BiomassBurning-FINNv1_..... bug fix FFIRE_BC 1.0

ForestFire_ml,ZCM_EmChem09soa/BiomassBurning-GFASv1_..... 
  Update for GFAS input

xxxxxxxx  rv4_OSrc1 Dave 16/9/2012 xxxxxxxxxxxxxxxxxxxx


ForestFire_ml:
   simplified considerably. Needs changes in appropriate
   BiomassBurningMapping files. Done for FINNv1 EmChem09soa so far

    Needs to be repeated for other combinations

   Bug cleaned out for FINN, EmChem09soa, which previously had a factr
   1.7 (OM/OC) in both the mapping file and the code.

ZCM_EmChem09soa/VBS_emissions_nonvolatilePOA_FromPM25.reactions
ZCM_EmChem09soa/VBS_nonvolatile.species

   FFIRE_OM replaces FFIRE_OC


More clean-ups/checks, as above. All routines have had basic check

ModelConstants_ml 
My_Outputs

    STATUS     -> EMEPSTD   = EMEP standard runs
    STATUS2010 -> EMEP2010 - with Iceland eruption
    TOPO       -> 3DPROFILES


(Note that the latter isn't really an experiment name, just another
output choice, but we can fix that later.)

xxxxxxxx  rv4rc12 Dave/Alvaro/Peter 13/9/2012 xxxxxxxxxxxxxxxxxxxx

Various clean-ups, rcerup and output fixes.

xxxxxxxx  rv4rc11 Dave 13/9/2012 xxxxxxxxxxxxxxxxxxxx

New rc system (almost complete). Aim is to use the rc and rcemis arrays
to cover everything. Also, all "natural" (or meteorology-driven) emissions
should be treated with the same system, storage in EmisNat.

* The arrays rcss, rcroadd, rcpol have been removed. Now we
use rcemis for all. (almost complete)

* The old "rcmisc" chemical rates are now part of the "rc" arrays

These new emissions can also be collected in the EmisNat arrays, needing
no special treatment. This array now covers all emissions which are
driven by meteorology rather than SNAP-codes. Mainly natural (BVOC,
dust, SS) but road-dust also enters here.

Status 13th. The new system works, with trivial changes in
concentrations compared to the old. I still need to fix the units
in the EmisNat arrays. Will do that before public-release - all
EmisNat should be identical in units.

This involved changes in  several routines

Biogenics_ml
   new order of indices in EmisNat
Derived_ml
   new order of indices in EmisNat
Dust_ml
   "old" DU_prod, DUST_flux now removed
   emissions into rcemis
EmisDef
   no need for NSS, QSSFI, QSSCO - all done in SeaSalt_ml
Emissions_mk
   use of rcemis
GenChem.pl
   No rcmisc, rctroe arrays, one fewer module produced
Runchem_ml
   call to setup_rcemis(i,j) now done before SS, dust etc.
   deleted use of rcss, rcwbd, etc.
   road-dust still set here
SeaSalt_ml
   "old" SS_prod removed
   emissions into rcemis
Setup_1d_ml
   removed rc_Rn222, use of Dust, SS, pollen
   removed call to set_rcmisc_rates
Setup_1dfields_ml.f90
   removed call to set_rcmisc_rates
Solver_ml.f90
   removed rcss, ROADDUST, etc,

ZCM_EmChem09/
  Dust.reactions - uses rcbio for dust, e.g.
     rcbio:DUST_WB_F     = DUST_WB_F ;  # Dust
  Isotopes.reactions - uses rcbio for Rn222, e.g.
  SeaSalt.reactions  - uses rcbio for SEASALT

Alvaro 13 Sep:

Solver_ml,Setup_1d_ml,Setup_1d_ml,
ZCM_Emergency/ASH_2bin.reactions,ASH_7bin.reactions
  - remove rcerup, use rcbio instead

xxxxxxxx  rv4rc10 12Sep/2012  xxxxxxxxxxxxxxxxxxxxxxx

Alvaro 12-13 Sep

Makefile:
  Patch from Viel for `make module`.
  
ModelConstants_ml, Output_hourly:
  For hourly splitted files (see HOURLYFILE_ending in ModelConstants_ml),
  avoid writing different years on the same file.
  - Restore single hourly file as defaul (ModelConstants_ml).
  - Create NetCDF variables only if the file is newly created

GenChem.pl: get rid of one "Use of uninitialized value" perl warning
  that escaped rv4rc9

Dave 9-12th:
Just cleaning up a little so far. Not rtagged

xxxxxxxx  rv4rc9    Peter    7 Sep/2012  xxxxxxxxxxxxxxxxxxxxxxx

Met_ml: can make 3D cloudcover from cloudwater
GridValues_ml: support for rotated spherical projection in lb2ij
Emissions_ml: natso2 (DMS) not needed
ModelConstants_ml:defined CW2CC = 1.0E6

clean up of output: ModelConstants_ml, EmisGet_ml, DryDep_ml, Met_ml

Alvaro: small bug fixes & eEMEP code requirements

GenChem.pl: get rid of all "Use of uninitialized value" perl warnings

Aqueous_n_WetDep_ml: mass balance bug fix
  Re-implement balance bug fix from rv4beta22.
  Bug was re-introduced on rv4rc3.

ZD_OZONE/My_Outputs_ml.f90: fix bug on consistency check.
  The bug was introduced on rv4rc8 and caused to treat
  hourly definitions with %spec==0 as undefined.

Makefile: compile eEMEP target with GenChem-EmChem09soa
  as GenChem-Emergency (strip down version) is not yet ready

Output_hourly: in FORECAST mode,
  write a .msg file at the after a hourly set is finished.
  The .msg file has the same basename as the hourly file.
  This will be used my the FORECAST user running eEMEP,
  together with HOURLYFILE_ending="+FFF.nc" (one file per forecast hour),
  to signal that the hourly file is complete and ready for download.

TimeDate_ExtraUtil_ml: add support for forecast step on date2string ('FFF' tag).

xxxxxxxx  rv4rc8    Alvaro    6 Sep/2012  xxxxxxxxxxxxxxxxxxxxxxx

Experiment Name (EXP_NAME) to select different configurations
of USE_* flags, hourly output and external BC (on Forecast mode).

Cleanup hourly output code. Remove Hourly_ASCII option.
Improve options for splitting hourly files.

ModelConstants_ml,ZD_OZONE/IFSMOZ_ExternalBICs_ml,My_Outputs_ml
  - USE_FOREST_FIRES as default. New to FORECAST mode.
  - Introduce Experiment Name (EXP_NAME) in ModelConstants_ml,
    to select different configurations:
    - USE_* flags (ModelConstants_ml)
    - hourly output (My_Outputs_ml)
    - BC version on Forecast mode (IFSMOZ_ExternalBICs_ml)

Output_hourly,ZD_OZONE/My_Outputs_ml,OwnDataTypes_ml,ModelConstants_ml
  - Remove ASCII hourly output code:
    - ASCII hourly output code (Output_hourly).
    - Hourly_ASCII variable (My_Outputs_ml)
    - ASCII output format (ofmt) element on Asc2D type definition (OwnDataTypes_ml)
  - Improve options for splitting hourly files:
    - Replace logical variables DAILY_HOURLYFILE, MONTHLY_HOURLYFILE
      by string variable HOURLYFILE_ending  (ModelConstants_ml).
    - Use function date2string (TimeDate_ExtraUtil_ml)
      to recreate the hourly file name (fileName_hour; NetCDF_ml).
      If the file name is changed, a new hourly file is created (Output_hourly).
    - Call Out_netCDF(create_var_only=.true.) to write all variable definitions
      at once, hourly data is added later (Output_hourly).

NestCDF_ml
  - Add support for "hours since" time units in ReadTimeCDF
  - replace (me==0) by MasterProc
  - rewrite subroutine CloseNetCDF

TimeDate_ExtraUtil_ml
  - Add support for "day of the year" on date2string ('JJJ' keyword).
  - Add to int arrays of size 6 as date format.
    It assumes (/year,month,day,hour,minute,second/) format.

Units_ml
  - Add support for mix_ratio unit:
      umap("mix_ratio","mol/mol",1.0),&  ! Internal model unit
  - Units_Scale also recongizes "mole mole-1" & "mixratio" as "mix_ratio"

Unimod.f90
  - Do not create hourly output file. This is now done on Output_hourly
  - Use date2string to write current date and time messages

Makefile:
  - Target MACC-EVA2010 uses GFASv1 ForestFire
  - Update compiler & netCDF library versions on stallo & vilje.
    Use netcdf/4.1.3 for hourly split files to work,
    as required on a ModelConstants_ml comment.
    Intel compiler and MPI modules updated to match netcdf/4.1.3 requirements.
  - Use on environment variable (vilje:$NETCDF_PREFIX, stallo:$NETCDF_ROOT)
    on INCL and LLIB paths. NETCDF_PREFIX/ROOT is set by mode load netcdf/version.
    Module netcdf/4.1.3 must be loaded for make run.
  - I suggest the following lines to be added to the ~/.bashrc
    stallo:
      export MACHINE=stallo
      module load intel-compiler/12.1.2 openmpi/1.4.4 netcdf/4.1.3
    vilje: 
      export MACHINE=vilje
      module load intelcomp/12.0.5.220 mpt/2.06 netcdf/4.1.3

xxxxxxxx  rv4rc7    Peter     5 Sep/2012  xxxxxxxxxxxxxxxxxxxxxxx

Small changes only 
Met_ml: replaced some hardcoded 10800 with 3600*METSTEP
Aqueous_n_WetDep_ml.f90: added some comments

run.pl: PBS command for Vilje
TimeDate_ExtraUtils_ml, days1900_to_int correct for rounding errors

xxxxxxxx  rv4rc6    Alvaro    3 Sep/2012  xxxxxxxxxxxxxxxxxxxxxxx

New ForestFire type: GFASv1

ForestFire_ml,run.pl
  ZCM_EmChem09soa/BiomassBurning_GFASv1_to_EmChem09soa.inc
  - New ForestFire type GFASv1 (BiomassBurning_GFASv1_to_EmChem09soa.inc)
  - Clean up ForestFire_ml

xxxxxxxx  rv4rc5      28-31Aug/2012  xxxxxxxxxxxxxxxxxxxxxxx

Peter: 31/8/2012
Aqueous_n_WetDep_ml.f90
(Note: Only Aqueous changes usedin TSAP SR runs)

In setup_aqurates concentrations were calculated from pH then pH from concentrations.
A loop with fixed number (5) of iteration was doing this. In the original code nothing ensured convergence; i.e we could have for instance pH=4 in first iteration, pH=5.6 second iteration, then pH=3.7, pH=6.1, and pH= 3.5 at the last iteration. This is unstable, meaning that small change in start value can give large changes in end values.
The solution adopted is to take only 2 "iterations" (pH give concentration and then concentration give pH). A proper linear combination of the 2 values are taken. "proper" meaning correct to second order. In practice for good situations (smooth variations), the solution is very close to the self-consistent value, for difficult situations, the value is in the right direction, but not exactely equal to the self-consistent solution.
Still, since the method is not really iterative, the solution is stable.


Svetlana: 31/8/2012
GlobalBCs_ml: Saharan BCs are divided by 2, as molecular weight for dust
was increasd from 100 to 200 g/cm3

Dave:  
ChemFunctions_ml - corrected comments. Refs to ACP paper
run.pl - re-instate CS=>51 which had fallen out

Alvaro: 29/8/2012
Nest_ml,ZD_OZONE/IFSMOZ_ExternalBICs_ml,My_ExternalBICs_ml
  - Mutliple External BC definitions will result in added BCs.
    This feature was missing on previous module versions.
  - New BC type EVA2010 available for Forecast mode (IFSMOZ_ExternalBICs_ml).
    Previous default (IFS_MOZ_fkya) was kept.

run.pl
  - small change on forecast met version ($CWFMETV)

xxxxxxxx rv4rc4 Peter   22/8/2012  xxxxxxxxxxxxxxxxxxxxxxx

Bug in BLPhysics_ml.f90/JericevicRiB_Hmix0. The indices for u and v where shifted by 4 (i.e. taking the wind from higher altitude)
This will modify results.

Experimental:
Possibility to get emissions for any grid (over Europe), based on fine resolution TNO7 emissions.
put CDF_emis=.true.
The Emis_TNO7.nc file contains: 
total emission for each gridcell, each component, each sector,
the fraction of each gridcell assigned to each country code, 
the corresponding country code and 
the number of fractions defined for each gridcell

modified Emissions_ml.f90 (NetCDF_ml.f90)

xxxxxxxx rv4rc3 Peter, Dave  13/8/2012  xxxxxxxxxxxxxxxxxxxxxxx

Instability in the solver for aqueous chemistry. Gave a lot of 
noise in the SR differences.

Aqueous_n_WetDep_ml.f90


xxxxxxxx rv4rc2 Peter  10/8/2012  xxxxxxxxxxxxxxxxxxxxxxx

Cubic equation solver from MARS_ml had only 7 digit precision.
Affects results slightly.

Note that there is still some instability somewhere, producing random 
fluctuations (SIA), particularly for fine scales.


xxxxxxxx rv4rc1 Peter  3/8/2012  xxxxxxxxxxxxxxxxxxxxxxx

Dynamical allocation of the grid sizes: 
IIFULLDOMAIN, JJFULLDOMAIN, RUNDOMAIN
and the processors partitionning:
NPROC, NPROCX, NPROCY

All routines with arrays, MAXLIMAX,MAXLJMAX changed:
AOD_PM_ml.f90 Advection_ml.f90 AirEmis_ml.f90 Biogenics_ml.f90 Chem_ml.f90 CoDep_ml.f90 Derived_ml.f90 DryDep_ml.f90 DustProd_ml.f90 EcoSystem_ml.f90 EmisGet_ml.f90 Emissions_ml.f90 ForestFire_ml.f90 GlobalBCs_ml.f90 GridValues_ml.f90 Landuse_ml.f90 MetFields_ml.f90 Met_ml.f90 ModelConstants_ml.f90 Nest_ml.f90 NetCDF_ml.f90 Par_ml.f90 PhyChem_ml.f90 Pollen_ml.f90 ReadField_ml.f90 Rsurface_ml.f90 Runchem_ml.f90 SeaSalt_ml.f90 Sites_ml.f90  SoilWater_ml.f90 Solver.f90 Timefactors_ml.f90 Unimod.f90 ZD_OZONE/My_Outputs_ml.f90 ZD_VBS/My_SOA_ml.f90 run.pl

It is no more necessary to define the grid which is used. The grid is read from the metfile.
Also the rundomain is by default set as = fulldomain, but can still be set in ModelConstants_ml.
In future will be read in from a namelist.
To change grid it is sufficient to change $GRID in run.pl.



The reading of the gridparameters is done in GridValues_ml (was in Met_ml before).

A few small bugs corrected:
1)In Runchem setup_rcemis was called before SeaSalt_flux, WindDust and  Pollen_flux, so that the emissions ( SS_prod,DU_prod, Pollen_prod) where the old ones, or not defined at the first step.
2)In Pollen_ml the variables did not have the save attribute.
3)In Rsurface there is a L%SAI > SMALLSAI, but SAI and LAI where not set/initialized for bulk.


   Dave:  1/8/2012  xxxxxxxxxxxxxxxxxxxxxxx

   just removed case SOILNO from Derived_ml. Was some old
   test I think.

xxxxxxxx rv4beta22 Peter 18/7/2012  xxxxxxxxxxxxxxxxxxxxxxx
           (+ small clean-ups from Dave)
            ongoing - so not rtagged yet

New RoadDust whith grid independent input. Does not give exactly the same results as the old scheme because
the defintion of climatefactors is different.

The scheme is rather new, and is also a test for a general scheme that can be used for all gridXXX emissions.
Emissions as stored in a netcdf file with: total per gridcells, and fractions assigned to countries.

Modified:
NetCDF_ml.f90
Emissions_ml.f90
run.pl

Dave  18 July, comparing with EnsClim2 code
Aqueous_ml            - small tidy up
BoundaryConditions_ml - small tidy up
DryDep_ml             - small tidy up

Alvaro: 20/07/2012
  Makefile*,run.pl: Only one makefile with all config for any machine.
    - Use variable MACHINE in Makefile to decide which configuration to use, e.g.
      make MACHINE=stallo instead of make -f Makefile_stallo.
      For convenience, MACHINE can be set once as:
        export MACHINE=stallo # on command line or ~/.bashrc
      and all subsequent calls to make (e.g. make EMEP) will use the corresponding
      machine configuration
    - All machine specific makefiles, such as Makefile_stallo & Makefile_titan,
      have been removed from CVS.
    - New specific model target MACC-EVA2010 (Makefile)
    - Use make MACHINE=stallo instead of make -f Makefile_stallo (run.pl)

Alvaro: 23/07/2012
  Aqueous_n_WetDep_ml: Budget WetDep for all SPCS
    - Fix bug introduced on rv4beta20 mass-budget calculation:
      - From rv4beta20 only SPEC which about was required (My_Derived)
        were budgeted.
      - Previous versions, WetDep budget was based on SOX, OXN & RDN group output.
        As WetDep for this groups was always required, the budget was complete.
    - Now WetDep is budgeted for all SPCS, independent of WetDep output requirements.

Alvaro: 24/07/2012
  MassBudget_ml - tidy up
  run.pl        - eEMEP setup for Forecast user in ve
                - Clean-up Benchmark definitions
                - Clean-up SR code for ve

xxxxxxxx rv4beta21 Dave 16-18/7/2012  xxxxxxxxxxxxxxxxxxxxxxx


run.pl changed for emissplit files:

    script looks for emissplit.$Specials.xxx in $timeseries directory
    first, thus can set $Specials = "TSAP_Jul2012" to get files
    for TSAP re-runs. (This one also needs iyr_trend to be set of
    course, corresponding to SR runs.)

    Still, be careful with emissplit files! System is confusing:-(

BoundaryConditions_ml - replaced print with write to aid debugging

xxxxxxxx still  rv4beta20 Peter      15/7/2012  xxxxxxxxxxxxxxxxxxxxxxx

ZD_SR/My_Derived with T2m without SS

xxxxxxxx rv4beta20 Alvaro      13/7/2012  xxxxxxxxxxxxxxxxxxxxxxx

New features:
  - WDEP/GROUP output can be produced for groups with elements
    with %nitrogens/=1 in mgN or %sulphurs/=1 in mgS.
  - WDEP/GROUP output in mg, mgC and mBq (radioactive exposure).
  - WDEP is restricted to ADV species. No WDEP is allowed for SHL species.
    Note that, this was already the case for DDEP.

Aqueous_n_WetDep_ml,Derived_ml:
  Wrong WDEP/SPEC output. Bug introcuded in rv4beta14.
  Was not corrected in rv4beta16, as My_Derived_ml contains no WDEP/SPEC output.
  - Molecular wheight was accounted twice, in Define_Derived
    (Derived_ml via Units_Scale) and in Init_WetDep (Aqueous_n_WetDep_ml)
  - Remove hard codded molecular weights in Init_WetDep (Aqueous_n_WetDep_ml)
  - Units conversions for WDEP/SPEC output are handeled exclusively
    by Units_Scale (in Derived_ml.Define_Derived).
  - Units conversions for WDEP/GROUP output are handeled exclusively
    by Group_Units (in Aqueous_n_WetDep_ml.WetDep_Budget).
  - Use only the SPEC/GROUP number defined in Define_Derived (Derived_ml),
    and refer to f_2d(if2)%index in Init_WetDep & WetDep_Budget.
    Thus, eliminating the need for typ_i3 arrays tmpgroup & tmpspec.

ZD_*/My_Derived_ml:
  - WDEP specific units mgSS and mgP(?) are now obselete.
    They are replaced with mg in ZD_*/My_Derived_ml.
  - Add SO2 and HNO3 to WDEP/SPEC output in ZD_OZONE/My_Derived_ml
    New Benchmarks for rv4beta14 & rv4beta16 contain this additional output.

Units_ml:
  Wrong unit text for mg, mgC, mgN & mgS. Bug introcuded in rv4beta14.
  - Units written for WDEP Derived outputs were mg*/m3 instead of mg*/m2.

GenChem,MassBudget_ml,Aqueous_n_WetDep_ml,Derived_ml:
  Limit WetDep to ADV species
  - WetDep mapping uses IXADV_"SPEC" (GenChem)
  - Restrict wdeploss & ddeploss (currently not used) to NSPEC_ADV (MassBudget_ml)
  - Use IXADV indexes in AddNewDeriv (Derived_ml) for WDEP_WANTED,
    and assume f_2d(if2)%index an IXADV in Init_WetDep & WetDep_Budget (Aqueous_n_WetDep_ml)
  - totWdep is no longer calculated for hard coded groups (only SOX, OXN & RDN).
    It is assigned to the IXADV indexes in WetDep_Budget (Aqueous_n_WetDep_ml),
    just as totDdep is assigned in drydep (DryDep_ml).

Aqueous_n_WetDep_ml,Units_ml:
 Store group IXADV and unit conversion factors in special type
 - type group_umap(name,iadv,uconv) for group index & conversion factors (Units_ml).
 - function Group_Scale, based on subroutine Group_Units,
   provides group_umap output (Units_ml).
 - store wetGroupUnits in Init_WetDep for later reference in WetDep_Budget (Aqueous_n_WetDep_ml)

xxxxxxxx rv4beta19 Dave/Agnes  13/7/2012  xxxxxxxxxxxxxxxxxxxxxxx

Country_ml   - correction for CS

Sites_ml.f90 - sets "NOT FOUND" d_2d species to -999

ZD_SR/My_Derived_ml - extra params as requested by Agnes/Chris

xxxxxxxx rv4beta18 Dave         5/7/2012  xxxxxxxxxxxxxxxxxxxxxxx

MARS_ml - more safety checks added.

My_Aerosols_ml - more safety checks whe DEBUG_EUIB = true.


xxxxxxxx rv4beta17 Dave Peter   4/7/2012  xxxxxxxxxxxxxxxxxxxxxxx

(not tested)

Bug in MARS_ml.
A case what not taken into account, giving negative or meaningless concentrations.
The casae where two roots are negative is now taken into account (by taking the same values as when the roots are complex).
Also a few "min(YNH4 * MWNH4, TMASSNH3)" have been added, as these could give negative values.

For later reference, the following input values were giving wrong results:
so4in= 9.469145296322812E-008
hno3in=1.575623936674725E-002
no3in=6.964374931256713E-012
nh3in=2.877165942842792E-008
nh4in=1.927434239142973E-009
rh=1.00000000000000
rh=0.99000000000000
temp=263.068584647992


xxxxxxxx rv4beta16 Alvaro    27,29/6/2012  xxxxxxxxxxxxxxxxxxxxxxx

  Units_ml,Derived_ml (27/6/2012): Fix bug introduced on rv4beta15
    Before rv4beta15 Units_Scale (Derived_ml) provided ug/m3 conversion
    for all species. The current version of Units_Scale (Units_ml) provides
    unit conversion factors only for advected species.
     - Units_Scale calls in Derived_ml have been modified to take iadv instead of itot
     - Units_Scale will Stop if iadv is out of range.

  Derived_ml (29/6/2012): Fix bug introduced on rv4beta15
    Fix from (27/6/2012) solved the problem only for SPCS output,
    GROUP output was still wrong.
    - uggroup_calc calc gets the unit conversion factor from Group_Units (Units_ml)
    - Avoid hard codded molwt by introducing aux variables, such as
      ug_NO3_C=Units_Scale('ug', iadv_NO3_C)
    - Use d_2d(ind_pmwater,i,j,IOU_INST) instead of PM25_water_rh50(i,j)*ATWAIR/PPBINV
      for PM25_rh50, PM25X_rh50 and PM10_rh50 output types

  Output_hourly:
    - Add Z_MID hourly output type
    - Align/format & other house keeping
    - (29/6/2012) Initialize group index/conversion pointers =>null()

  ZD_OZONE/My_Outputs_ml:
    - Add Z_MID and Volcano (vent) column hourly output on Emergency-Forecast mode

  GenChem.pl (ChemChemicals_ml), Units_ml, Derived_ml:
    - Define species_adv and species_shl in ChemChemicals_ml
      as pointers to species short lived and advected portions.
    - species_adv is now used in Units_ml and Derived_ml as a short hand to
      species(NSPEC_SHL+1:NSPEC_SHL+NSPEC_ADV)

  Derived_ml:
    - Avoid hard codded IXADV_"SPC" by introducing aux variables, such as
      iadv_O3=find_index('O3',species_adv(:)%name)

  run.pl:
    - define $skipHDD
    - $MAKEMODE for $SR
    - Options for $VILJE for $EruptionDir, $WORKDIR and $CWFDUMPDIR

  Functions_ml:
    - great_circle_distance is now a PURE function

  Nest_ml:
    - Change debug output format F4.2 to F5.2 to avoid compilation warning

xxxxxxxx rv4beta15 Dave,Alvaro  20/6/2012  xxxxxxxxxxxxxxxxxxxxxxx

  Dave:
  run.pl
     skipHDD introduced to avoid HDD files for some runs
     metdata_EC used by default for global

  Alvaro:
  Units_ml,Makefile.SRCS,Derived_ml,My_Outputs_ml,Output_hourly
    - New module Units_ml gathers routines and variables dealing
      with units convertions formerly scattered between Output_hourly and Derived_ml
    - Function Units_Scale (formerly Derived_ml sunbroutine).
    - Unit concertion varaibles (formerly My_Outputs_ml):
        to_molec_cm3,to_molec_cm2,to_mgSIA,to_ugSIA,&
        to_ug_ADV,to_ug_C,to_ug_N,to_ug_S
    - Subroutine Group_Units replaces group_setup on Output_hourly.

  Output_hourly
    - Alingn/format & other house keeping

xxxxxxxx rv4beta14 Alvaro & Birthe 11,13-15/6/2012 xxxxxxxxxxxxxxxxxxxxxxxx

eEMEP update

Volcanos_ml:
  - Fix MPI bug on reading eruption.csv
  - Change default VAAC splits for 2bin mode.

run.pl:
  - Official eruoption emissions for 2010 Eyjafj�ll eruption
  - SOx & PMx reduced files for 2010 Eyjafj�ll eruption (SR-VOL run)

Makefile_vilje:
  - Add model specific targets (EMEP / MACC / eEMEP)

Makefile,Makefile_stallo,Makefile_vilje (13-15th June):
  - Fix for recursive make. Use -f $(firstword $(MAKEFILE_LIST))
    in $(MAKE) recursive calls (for EMEP/MACC/eEMEP targets)
    to ensure that right Makefile is used.
  - Fix for SR-EMEP2010 target. Wrong My_Derived_ml.f90 was used,
    creating inecesary output. Now it links ./ZD_SR/My_Derived_ml.f90.
  - Re-organize EMEP/MACC/eEMEP targets
  - Add eEMEP2010 target for evaluation of the model.

ZD_OZONE/IFSMOZ_ExternalBICs_ml.f90 (15th June):
  - Add integer,save, public :: iw=-1, ie=-1, js=-1, jn=-1, kt=-1,
    as in rv4beta13 for My_ExternalBICs_ml.f90

xxxxxxxx rv4beta13 in-progress   6/6/2012 xxxxxxxxxxxxxxxxxxxxxxxx

run.pl: change of link for 5yr annual N dep to AnnualNdep_PS50x_EECCA2005_2009.nc (5 year average 2005-2009 run for EECCA with PS50 for 2005-2009)
  (now hand-edited and re-created with ncgen)

run.pl - emissplit for emepdefaults corrected

Nest_ml 