=============================================================================
IMPORTANT NOTES:

After checking out new code from dev, one has to copy the appropriate
chemical mechanism files (CM) to the main directory, e.g. to get EmChem19
chemistry, run:

    mk.ChemFiles EmChem19rc

  [This will copy pre-made files from ZCM_EmChem19rc. The files in that directory
    are usually prepared by Dave, Willem, Robert or Alvaro, from the ecosx branch -
    ecosx/box/src directory - see the README_emep_setup.md there.) ]

2023 UPDATE:
EmChem19rc - for CLOUDJ - new default

2021 UPDATE:
EmChem19r,  EmChem19rp (=EmChem19r+pollen).

  now splits PM into Res and nonRes species (e.g. POM_f_Res,
  POM_f_nonRes), which are basically tracers of GNFR C emissions.
  If you want PM split into wood/ffuel, use EmChem19a, EmChem19p

  To be used in 2021 reporting, and GP SR runs

EmChem19a was previously the default chemistry for most emep jobs, and should
  still be used where the distinction wood/ffuel is wanted.

EmChem19p is just EmChem19a + Alvaro's pollen species.

MAKE sure that SplitDefaultFile  and SplitSpecialsFile  point to
the appropriate place, DataDir/ZCM_DIRS/ZCM_EmChem19.

Soil NOx - NOW COMPLICATED since some inventories include already include soil NOx:

  USES%SOILNOX_METHOD - needs user decision!
    NoFert       - for EMEP, ECLIPSEv6
    Total        - ok for CAMS_REG_ANT, ECLIPSEv5

** See new config SOILNOx system, rv4.42



=============================================================================
!----------------------------------------------------------
CLEAN-UP: all code should be checked to remove old comments and
prints that are not meaningful for an average user, before the public release.
Ideally compile code on PC with gfortran's pedantic debug switches
(eg make MACHINE=precise EMEP) - gives loads of info on unused variables, etc.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th August 2024, Dave
NEW TAG: rv5.4 - since we now have PBAP prelim, plus changed output for Emis_mgm2_NO
 and  MaxD8M_O3_19th
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th August 2024, Peter

19th highest Max8D.

OutputMisc=
 'MaxD8M_O3_19th','MaxD8M_19th', '',  'O3', 'ug/m3',  -1 , -1,   F,    1.0,   F, 'YM',


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22 August 2024, Gunnar

Added Primary Biogenic Aerosol Particles (PBAP) in PBAP_mod.f90. Currently only
supports fungal spores, but there is skeleton code for both bacteria and MarineOA,
to be implemented at a later stage. This also adds two new tracers: FUNGAL_SPORE3
and FUNGAL_SPORE5, corresponding respectively to spores with a diameter of 3um
and spores with a diameter of 5um. For more info on this, as well as the various
fungal emission parameterizations, see the EMEP status report 2024 chapter 7.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24 July  2024, Peter

Allow choice of different inputs for metdata: alternative names can be added,
and special treatment for those added in a systematic way.

Adaptation of code and compiler flags to more recent gnu fortran compiler.
LUMI Makefile, and adapted Makefile.Open

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11  July  2024, Dave

Biogenics_mod: EmisNat for NO scaled by 30/14, so that output Emis_mgm2_BionatNO
is actually as NO as stated. Was as N.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10  July  2024, Dave

SmallUtils_mod: increased word size in basename and basedir functions -
 wasn't coping with some long CAMS emission names. 
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2  July  2024, Dave

NetCDF_mod: Allow timestamps as e.g. "days since 1990-1-1", ie without 00:00:00
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27 June  2024, Peter

Changed reading format for ModsCloudJ, as one compiler on LUMI did not like it.

Bug in LF for "relative" type: lf_sector_map was not allocated

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 June  2024, Peter

LF: Changed the eps1 for SIA to 0.95. Included aqueous reaction rate changes
(new mk.LF_Chem not tested!)

Also added small LUMI compatibility changes (DataDir in config, and defaults
values for "loc" in ColumnSource).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12 June  2024, Peter, Willem

pH convergence did make lots of warnings in  global runs. The case was when
the pH function was outputting always the same result (1 or 7), whatever start pH.
Will slightly modify results.

LF: lots of fixes for PM_Water

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6 June  2024, Peter

LF: sectors 14 and 15 are put into sector 1
    sectors 6 and 16-19 into 6.
Could easily by steered by config settings if required.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4 June  2024, Dave
NEW TAG: rv5.3 -  Aiming at code for 2023 report SR runs.

Last change:
config_emep.nml - just leave O3, NO2 as YMDH. No YMDI now (was O3)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3 June  2024, Willem

Added an option (turned off by default) to include a simple latitudinal gradient
for CH4, as described in Section 4.1 of https://doi.org/10.5194/egusphere-2024-1422

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3 June  2024, Peter, Willem

LF filtering of unsafe values for SIA: when more than 4 molecules are created
or destroyed for each additional molecule entering the equ module, the entire
equ update for LF is canceled.
LF filtering of very small values, lf_limit = 1e-5

Replaced hardcoded if ( k > (KMAX_MID - 8) ) then in AerosolCalls by
 if ( k >= KEMISTOP ) then

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 May  2024, Willem

Some more default changes in Config_module:

- FIXED_CLW from 0.6e-6 to -999 (toggles use of CLW from input meteorology)

- SEASALT_fFrac from 0.5 to 0.3 (uncertainty in binsizes allows for wiggle room)

- AERO%EQUILIB and AERO%EQUILIB_WATER from 'MARS' to 'ISORROPIA' (ISORROPIA-Lite 
  for SIA and its aerosol water uptake)

- AERO%ORGANIC_WATER from .false. to .true. to take into account water uptake
  by OM in ISORROPIA

- AERO%OM_KAPPA from 0.15 to 0.087 to reflect that our OM is a mixture of organic
  compounds, with 0.087 being representative of OM/OC = 1.7

- AERO%ThermoH2OSurfArea from .false. to .true. to use equilibrium PMf water 
  and sea-salt water from Lewis & Schwartz in surface area calculations

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 May  2024, Dave

Config_module  changed  to "HuangOCC", which is a function of OH, O3, H2O.
Not better than old ("ACP2012"), but removes unphysical use of layer number.
(Should change name later though - Croft and others should get most of credit.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29 May  2024, Peter

Better convergence for pH -> No more pH "warnings".

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29 May  2024, Willem

Changed the default lower RH limit from 5% to 15% for increased numerical stability 
when using ISORROPIA. The ISORROPIA lower temperature limit within the lowest 
layers (where pollutants might be emitted) is also set to a minimum of 255K, up
from 250K. Both the RH and temperature change do not impact the simulation 
results, while increasing numerical stability a bit when using ISORROPIA. 

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24 May  2024, Willem

Added the option to use aerosol water from the thermodynamics modules to 
calculate wet areasol surface area. Turned off by default, but can be turned on
by setting AERO%ThermoH2OSurfArea = T (being defined in AeroConstants_mod).

Water uptake associated with different aerosol options (e.g., inclusion of dust
cations or organic water uptake) remains consistent with those available for the
different modules (e.g., MARS cannot consider effects of dust cations, thus fine
dust is assumed to be dry in the surface area calculations).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22 May  2024, Peter, Dave

  Fixed bug for ugm3_pmH2O outputs.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21 May  2024, Dave, Willem

Aqueous_mod, Config_mod:  moveed PR_LIMIT, B_LIMIT, CW_LIMIT to config system

Aquous_mod: added cw_gm2grid usage, limit of CLW to 0.6 - 3 g/kg.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 May  2024, Peter

Makefile: changed nc-config to nf_config for Atos
NB: the debug flags does not work anymore (-ftrapuv ?).

Some more diagnostic outputs when pH does not converge.

LF: repaired POD output. rctA and rctB disabled (they had little effect anyway)
LF%Nvert default set to 14.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13 May  2024, Peter

LF for Isorropia. (NB: gives relatively large differences with BF)
Reduced max value for lf derivatives in equilibrium chemistry to 10.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10 May  2024, Peter

Setup_Clouds: b(k) was not defined in second loop. (the first loop is below 
clouds, the second within clouds)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6-7 May  2024, Dave/Peter

Aqueous_...
Setup_Clouds: small tidy up and safety change. Don't assume order of terms in
 if test evaluated left to right, even if they probably are. 
MetFields_mod: removed pbl=0 line which was before allocation.

gfortran tidy-ups:
  config_emep.nml - removed some side-comments that caused crash.
   TO-DO check if AOT etc should use WH or WH_Irrig
  AeroFunctions : just removing unused variables
  Ammonium_mod:just removing unused variables
  Aqueous_n_WetDep_mod
  Biogenics_mod.f90
  ChemFunctions_mod.f90
  Convection_mod.f90
  Derived_mod
  DryDep_mod.f90
  EmisDef_mod: just removing unused variable
  EmisGet_mod: just removing unused variable
  ExternalBICs_mod: added dtxt usage
  LocalFractions_mod:  changed if(found) to if(found==1)
  Met_mod
  Setup_1d_mod
  Timefactors_mod: corrected print format.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5 May  2024, Peter /Dave

Bug fix: Setup_Clouds, ksubcloud was not set properly, because it used
undefined b(k)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3 May  2024, Peter /Dave

** Interim commit. n2 vs n6 issues solved for gases, but remain for pmH2O

Aqueous_mod: added Fgas(SO2,:) = 1

Setup_1d_mod, RunChem_mod

1. call to setChemRates moved to be after Setup_Clouds so that Fgas(SO2) is set
correctly.
2. Some code moved to checkChemRates, called after setChemRates.

Met_mod: tiny clean-up
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2 May  2024, Willem

Added a lower limit on the in-cloud liquid water content in case cloud liquid
water from the input meteorology is used (USES%FIXED_CLW < 0). The lower limit
corresponds to the in-cloud liquid water content representative of fog (0.06 g/m3).

This seems to avoid problems when clouds are mostly in ice form, sometimes giving
very low in-cloud liquid water contents. 

Also set the default thermodynamics RH limit to 98%, following equilibrium time-scale
discussions with A. Nenes. Avoids rapid 'blowing up' of aerosol liquid water at very 
high RH values, while also making source-receptor calculations a bit more stable. 

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30 Apr  2024, Peter

(Small) instability in interpolation. Affected at least Aircraft emissions.
When two real numbers where exactly equal, it could lead to different results
in the interpoaltion. This can happen when two grids are compared and the
gridcell boundaries match some pattern. It happened when the Surface pressure
read from a file is read for the aircraft emissions. The result was not wrong,
just that it can take different values, for example if the number of procs is
changed.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 Apr  2024, Dave

  ChemRates_mod: safety check added for ECageMethod
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25 Apr  2024, Dave

Derived_mod: added more explicit output of fracPM25 details to olog. 
Gives:
  IniDeriv:fracPM25  umDpgV  3.000 sig  2.000 rho  2.200 PMc  0.203

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 Apr  2024, Dave

Added EC-aging options, configarable with USES based upon Croft et al
(ACP, 2005, 10.5194/acp-5-1931-2005) and Huang et al. (ACP, 2013,
10.5194/acp-13-6329-2013).

Config_module:

  Added USES%ECageMethod, can be one of:

    ACP2012 - current method, still default
    HuangOXD - O3 and H2O impacts
    HuangCC  - OH oxidation
    HuangOCC  = HuangOXD + HuangCC
    TauXX    - specify fixed lifetime in hours, e.g. Tau24

  Plus USES%ECageFac to modifyt the Huang rates.

ChemFunctions_mod:
  expands ec_ageing_rate for above functions

Debug_module:
  added ECAGE = .false.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18 Apr  2024, Peter

NB: still bugs in this version! (results for NH4 change for different number of
procs and LF results for NO3_f are too bad)

Put back the "any_cases" settings from previous versions for emission read.
But now only define single species if they do not exist in
EMIS_FILE (case sensitive).

Also removed duplicate femis and Emis_source(1) definitions in
config_eme.nml, as it is dangerous to have several definitions (one may
change one of them and forget that it is overwritten later)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13 Apr  2024, Joffen/Dave
 NEW TAG: rv5.2beta - as aqueous and gas/particle chem changed
 : Small changes in SO2 and SO4, but overall little change


Aqueous and heterogenous changes:

   emep_Main: moved call to init_aqeous
   Aqueous_mod - updated all rates and added HO2-cloud uptake
   Solver  - ICLHO2H2O2 for HO2 - cloud reaction

  Changes in ecosx:

     UPDATED EmChem19rc to use Aqueous_EmChem19c
     Aqueous_EmChem19c now replaces older Aqeous_EmChem16x
       - skips CRUDE H2O2, CH3OOH losses
       - changed OH + SO2 rate
       /box/script/emep_setup now has Aqueous_EmChem19c in common_RNR

      ISSUE with EmChem19rcp - used EmChem19cj base, not EmChem19c.
        but EmChem19cj no longer in ecosx or public genchem
        mainly different order of species, but EmChem19c has PAN
        photolysis.
        used EmChem19c for now.
        copied original CM* files to ZCM_EmChem19rcp/Apr12_CMfiles/

   
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 Apr  2024, Peter

PM water  from MARS was using a discontinuous function. That caused unstabilities
(sharp spikes in time and space) when doing differences between two similar runs.
Now the function is forced to be continuous and the worse spikes seem to disapear
 in a test run.  

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8 Apr  2024, Dave

Emissions_mod - a little more associate
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1-2 Apr  2024, Dave

Emissions_mod, EmisGet_mod: adding more debug output (some tmp)

  used associate ( emsrcfiln => Emis_sourceFiles(n), emsrcii => Emis_source(ii) )
   and  associate ( emi => Emis_sourceFiles(n)%source(isource) )

  to improve clarity.

OwnDataTypes_mod: added print_Sector_type
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30 mar 2024, Dave

Emissions_mod, EmisGet_mod: adding more debug output
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28-29 mar 2024, Dave

SmallUtils_mod: added basename and basedir - similar to python/perl functions

Timefactors_mod: extra debug lines, and 1st use of basename, basedir to reduce
 lengths of output strings

Emissions_mod, EmisGet, Net_mod: debug additions

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27 mar 2024, Peter

Put runlabel on "Timings.out", so that different timings are not overwritten
when testing.

LF: include integral over cities in ad hoc file, to accelareate Hourly outputs.
(Will be integrated for "normal" runs later too (CAMS needs it), although it
is not exactly the same)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 mar 2024, Peter

Bug in emission per file printouts, when more than one emission file is used.
(emission totals over all files, and emissions used by model were correct).
Also no print out per file, if only one emission file is used.

Increased max number of iterations for pH.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7 mar 2024, Peter, Willem

Bug in AvgMDA8AprSep: the counter was reset to zero every month.

The "countrycode" variable attribute was not recognized for emissions (but was
recognized for files and in config_emep.nml). The country_ISO are normally used,
so this should not have consequences for reporting results for example.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27 feb 2024, Peter
Filename for O3_TOP was not updated correctly for multi years runs.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19 feb 2024, Svetlana

AerosolCalls.f90 - harmonized EQSAM inputs with those for ISORROPIA
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 feb 2024, Peter, Willem

Bug fix: When there were undefined  Emis_sourceFiles in between defined ones, the
SectorNames could get wrong, causing the code to stop with error message.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8 feb 2024, Dave

  Timefactors_mod - fixed bug in normalisation. 
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7 feb 2024, Dave

  Moved location of CAMS_TEMPO_GLOB4emep1degSig2p0mmSig60.nc to 
    Data/Timefactors/CAMS_TEMPO/

  Config, Timefactors_mod - removed Monthly_patternsFile and
    added GriddedMonthlyFacFile. The latter is only used when timeFacs%Monthly==GRIDDED.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6 feb 2024, Dave

 NEW TAG: rv5.1

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4-5 feb 2024, Dave

1) Timefactor re-write - choices simplified with use of timeFacs type:

  type, public :: timeFacs_t
   integer :: MonthlySmoothFac = 100   ! <100 smooths MonthlyFacs across months
   logical :: Day_of_Year = .false.    ! overrides Monthly and Daily if used 
   character(len=20) :: MonthlyNH3  = 'NOTSET'    ! can be 'LOTOS'
   character(len=TXTLEN_SHORT) :: &
     Monthly = 'CAMS_TEMPO_CLIM'  & ! or GRIDDED
    ,Daily   = 'CAMS_TEMPO_CLIM'  &!
    ,Hourly  = 'CAMS_TEMPO_CLIM'
  end type timeFacs_t
  type(timeFacs_t), public, save :: timeFacs


 Impacts Config_module.f90, Emissions_mod.f90, Timefactors_mod.f90, config_emep.nml

 Also EmisDef_mod - added IS_AGRK, IS_AGRL - prepping for new timefactors

 STATUS: also timeFacs%Monthly can be "GRIDDED", but final file to be decided.
         timeFacs%MonthlySmoothFac = 60 seems to give better results tha default 100.
         More checks needed, but hopefully we can soon finalise.

2) Changed order of CM speds for EmChem19rc.

 Affects:
  ZCM_EmChem19rc/CM* - re-ordered species to give more efficient LF (Peter request)
  ** should update other ZCM_ also. Not today though.

3) Also;

 Makefile - commented out  GITVERSION line. Caused compilation error for large changes from git orig

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3 feb 2024, Dave

Adding ability to smooth MonthlyTimeFacs. Set MonthlySmoothFac to e.g. 60 (%)
if factors believed to be too "spiky".

 Functions_mod - added monthly_convolve function, and TSTEMX system
 Config_mod    - add USES%MonthlySmoothFac - integer in % of value retained from
    original monthly value. .e.g MonthlySmoothFac 60 will convolve monthly
    values  with [ 0.2, 0.6, 0.2 ]
 Timefactors_mod - uses USES%MonthlySmoothFac
 Also NetCDF_mod: small debug extras

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
->1 feb 2024, Peter

Lots of changes in the LF for full chemistry.
BVOC, SOMO35, Surface reactions, reductions of all emissions at once, new
nomenclature (lf_set% ), hourly with fixed 24 records, and some refactoring.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19 jan 2024, Willem

Added upper and lower RH limit config options to AeroConstants_mod.f90, which
apply equally to all thermodynamics modules. Lower and upper limits set to 0.05 and 0.999
by default. Lower limit > 0 to avoid divisions by zero, and upper limit slightly
less than 1 to avoid extreme blowing up of results/numerical noise.

Also introduced a flag that controls whether or not organic water uptake is 
included for PM25, using the same kappa-kohler eq. from Kakavas 2022 
(https://doi.org/10.16993/tellusb.33) for all thermodynamics modules. OM water
uptake turned off by default (for now).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 jan 2024, Peter

Country include exclude option for CV format emissions. Format example:
  Emis_sourceFiles(1)%country_ISO_excl(1:) = 'DE','NO',
  Emis_sourceFiles(1)%country_ISO_incl(1:) = 'DE','NO',
  (up to 601 countries)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21 Dec 2023, Dave

make SITE_ADV configurable, e.g. use:
  SITE_ADV_names(1:)  = 'O3','NO2','NO','NO3','C5H8','APINENE',

Use 'ALL' if all advected species wanted, i.e.:
  SITE_ADV_names(1:)  = 'ALL',

Changes in Config_module, Sites_mod and config_emep.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20 Dec 2023, Willem

Removed the old tabulated photolysis system. The model can now only use 
CloudJ. The CloudJ photolysis rate and photolysis reaction matching
has also been improved; now all chemical schemes generated by (the upcoming
release of) GenChem will run using the same CloudJ input files. 

A CloudJ userguide will be released shortly, detailing e.g. how now reaction rates
can be added to the EMEP modeling system. 

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 Oct 2023, Peter

Properly converge pH calculation in Aqueous_n_WetDep, using binary search.
Should change slightly results.
The main goal is to get more stable results when
difference between scenarios are made.

Rxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 Oct 2023, Peter

Remove the emis_inputlist functionality!
To be replaced by Emis_sourceFiles format.
path to OceanDMS and OceanNH3 have been defined in adhoc filenames.
OceanDMS and OceanNH3 are steered by USES%OCEAN_DMS and USES%OCEAN_NH3

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27 Oct 2023, Peter

LF: include dependence of rct on SO4, NO3_f, NO3_c.
hardcoded indices 96(Hydrolysisn2o5), 97 100.
LF: Also propotional shl_lf.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 Oct 2023, Peter

Local Fraction: SIA and large refactoring. (was waiting for Open source to commit)
Should now be ok to mix LF outputs with relative and country types.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19 July 2023, Willem, Peter
Local Fraction: bug in yearly MDA8 for local fractions corrected.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10 Oct 2023, Dave

config_Open.nml - removed  IAM_MF
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9 Oct 2023, Peter, Bruce

Bug in Local Fractions: if several sectors are asked for, pm25 (not the
fraction, but the pure value) was wrong (it added the "new" parts for each
sector asked instead of only once).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30 Sep 2023, Dave

Logic surrounding FLUX_VEGS moved into Landuse module.

   Config_module:
     FLUX_VEGS, nFluxVegs removed (moved to Landuse_mod)
     Add: if ( USES%PFT_MAPS ) then
        GLOBAL_settings = "YES"
        European_settings = "NO"

   LandDefs_mod
     FLUX_VEGS removed (moved to Landuse_mod)
     is_iam logic also moved to Landuse_mod


   Landuse_mod
     Now handles EXTRA_FLUX_VEGS (was FLUX_VEGS)

NOTE: the model now calculates only G-POD for GLOBAL05 runs, since POD is only
really defined for European growing seasons and veg. Contact Dave if wanting to
use.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th Oct.2023, Dave

Removed last IAM_CR from config_emep.nml and config_Open.nml.
  (EUAOT40_Crops and MET_LCS now use IAM_WH)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd Oct.2023, Dave/Yao

AOTnPOD_mod - removed integer, save, public :: nOutputVegO3 = 0
 (is defined in Config_mod).
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st Oct 2023, Dave

AOTnPOD_mod - small debug tidy-up
DO3SE_mod   - small debug tidy-up
Mosaics_mod - debug system revamped to get print-outs in line with
 Landuse debugs. Now print if MasterProc or DEBUG%MOSAICS .and. debug_proc
My_Derived_mod -  small debug tidy-up
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 Sep 2023, Dave

FLUX_VEGS now removed from config_Open.nml, config_emep.nml; these are now
  discovered from the land-covers asked for in OutputVegO3.


Changes in:

 AOTnPOD_mod  = nOutputVegO3 change, plus use L%FstO3 to define day, not Grid%izen
 Config_module - just move nOutputVegO3, and remove old PFT_MAPS/FLUX_VEGS stuff
 DO3SE_mod - removed "OLDBUG" code
 Landuse_mod - figures out FLUX_VEGS
 Mosaics_mod - just move nOutputVegO3
 My_Derived_mod - just move nOutputVegO3, and rename sub to dtxt

 config_Open.nml - only has European IAM veg
 config_emep.nml - has some example global IAMs (G-IAM)
                 - also uses LandInputs_Sep2023 for e.g. Inputs_DO3SE.csv

+BUG fix
 StoFlux_mod - remove test for old_gsun(i,j,1)<1.0e6 - caused "diamond" PODs



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 Sep 2023, Dave

Tidy ups:

 All DEBUG_ variables now removed and/or added into DEBUG% structure :-)

 Debug_module, Rb_mod: removed DEBUG_RB
 Debug_module: removed unused DEBUG_OUT_HOUR
 change _ to %:
 Debug_module, OutputChem_mod: OUTPUTCHEM
 Debug_module, Nest_mod, ExternalBICs_mod: NEST and NEST_ICBC
 Debug_module, Setup_1d_mod (_MASS not used, removed),   MassBudget_mod

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22 Sep 2023, Dave

Wanted table of EMEP country codes and numbers. Now get from running

  mk.testX Country_mod.f90

  Produces: Results_Country_mod.txt
    $head Results_Country_mod.txt
   ncc  code           gains  incams   name
     1  AL              ALBA       F   Albania
     2  AT              AUST       T   Austria

  (The incams logical is provisional, based on EUMACC2, and will be uodated soon.)

Changes in:

Country_mod.f90
  writes out Results_Country_mod.txt
  - also fprettify run on this.

SmallUtils_mod.f90
 - added blank_replace to swap " " for e.g. "_" (produces e.g. The_North_Sea in table names)
 - removed print from find_duplicates, which are not allowed in gfortran
   (thanks Heiko)
  https://stackoverflow.com/questions/24923076/print-to-standard-output-from-a-function-defined-in-an-fortran-module
  https://gcc.gnu.org/bugzilla/show_bug.cgi?id=51286
 - removed unused variable  to be --pedantic
 - modified Self_test

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19 Sep 2023, Dave

Tidying up:

TimeFacBasis = 'DAY_OF_YEAR' replaces v5.0 USES%DAYOFYEARTIMEFAC. This removes
  some confusion about setting both TimefacBasis = 'CAMS_TEMP_CLIM' and USES%DAYOFYEARTIMEFAC = T.

Removed USES%TIMEZONEMAP and made this default for all runs.

Changes in:

 Config_module.f90
 EmisGet_mod.f90
 Emissions_mod.f90
 Timefactors_mod.f90

Also, moved ZCM_ into ZCM_OLD for most EmChem16s

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21 Sep 2023, Dave

Soil NO - now uses "official" CAMS soil-NO (from ECCAD), file
  (same results as previous EMEP equivalent)

Adapted:

 Emissions_mod.f90 - Note that coding is still crude, needing the names to be correct, i.e.:

    if (  index(soilnox_emission_File,'v2.4a_GLOBAL05_Clim2000') > 0 .or. & ! EMEP-style
           index(soilnox_emission_File,'v2.4clim') > 0) then                ! ECCAD-style

 Config_module.f90 - defaults to ECCAD version
 config_emep.nml
 config_Open.nml

Also:
 Timefactors_mod - just changes in comments

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18 Sep 2023, Dave

Emissions_mod.f90 - bugfix for issue #232

Debug changes:

 Debug_module.f90

 Debug changes. Moved DEBUG_NETCDF, DEBUG_NETCDF_RF and many others
 into DEBUG% system.


Affected also:

 Advection_mod.f90
 BoundaryConditions_mod.f90
 EmisGet_mod.f90
 Emissions_mod.f90
   Also needed changes since Emissions_mod used "debug" as an argument
   to various subroutines, conflictig with DEBUG. Changed to either
   debug_flag or dbg. Also smaller debug changes.
 Met_mod.f90
 NetCDF_mod.f90
 PointSource_mod.f90
 Runchem_mod.f90
 Sites_mod.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14 Sep 2023, Alvaro

Emissions_mod (EmisUpdate)
  reset NEmis_source_ij before reading new emissions, close #231
  https://github.com/metno/emep-mscw/issues/231

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10 Sep 2023, Dave

 Config_module   - excludes IAM_ veg from VEG_FLUXES if global (USES%PFT_MAPS=T)
 config_Open.nml - added comments about this

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8 Sep 2023, Dave

 config_Open.nml    - removed IAM:CR, IAM_CROP
 GaspParticleCoeffs - small fmt change
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7 Sep 2023, Dave

Important change:

 Landuse_mod.f90 - add use_eur array to avoid IAM_ calculations outside EUR.
     (These IAM_ classes use European growing seasons, and results outside
      this region are therefore senseless.)

Other:
 LandDefs.f90 - removed unneeded WANTED output
 StoFlux_mod  - removed debug LOOP output


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5 Sep 2023, Alvaro

Add ZCM_EmChem19rcp, same as ZCM_EmChem19rc + Pollen tracers

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1 Sep 2023, Peter, Willem

MDA8: The first day of the month was not included (counted as zero).
For AvgMDA8AprSep, it is only the very first day (1st April) which was counted as zero.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 Aug 2023, Dave

Heiko spotted two modules:
  Gravset_mod.f90
  GravSettling_mod.f90

The latter was an incomplete attempt by Dave to expand from ASH to all PMc.
Peter pointed out numerical issues with basic method though, which still apply.

Solution:
git mv GravSettling_mod.f90 FUTURE_GravSettling_mod.f90k
Makefile.SRCS  - remove GravSettling_mod.f90
PhyChem_mod    - comment out if(USES%GRAVSET) call gravSettling
Config_module  - comment out GRAVSET

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29 Aug 2023, Heiko

Gravset_mod
  fix sizes in 7bin ash-sizes to be log-center of bins
  rather than upper sizes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25 Aug 2023, Alvaro

Emissions_mod
  reset NEmis_source_ij on EmisUpdate, close #231
  https://github.com/metno/emep-mscw/issues/231

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24 Aug 2023, Dave

Landuse_mod
  removed some debug which was hard-coded for Alps.

Met_mod:
 checkstop for USES%FFireDispMethod == 'PBL' .and. .not. foundHmix, since
 ok to use PBL with non-NWP Hmix also
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
08 Aug 2023, Dave

Met_mod: code will crash if HmixMethod = 'NWP', and no varable found. (var names
          are one of  "pblh", "PBLH", "blh ")
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13 July 2023, Dave

 NEW TAG: rv5.0
 code used for 2023 reporting and SR runs.
 Defaults to MARS equilib, and FIXED_CLW = 1.0e-6, see 12th July commits.

 config_emep.nml - just improved comments surrounding CAMS_TEMP_CLIM.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12 July 2023, Dave/Willem

Towards rv5.0 tag

  Aqueous_n_WetDep_mod
  Config_mod

    USES%FIXED_CLW introduced, with defaul 0.6e-6 vol(H2O)/vol(air-in-cloud)

  AeroConstants_mod:
    back to MARS by default

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

11 July 2023, Dave
 Emissions_mod: no change in coding, but lots of debug tweaks. Focus on
  Hungaru and NH3 with dbgPoll.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
04 July 2023, Peter
Replace EmisDir before DataDir

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
04 July 2023, Dave

 Timefactors_mod - BUG fixed. The code attempted to read the cams_tempo hourly
  facs file with the older integer-based system when USES%DAYOFYEARTIMEFAC was T.
  The relim bugfix is to use text-based when when the HourlyFacSpecialsFile
  contains the text cams_tempo. Whole module needs re-factoring!

 Emissions_mod: added a dtxt
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 June 2023, Peter

Small bug: satellite_altind was declared as real, but is used as index in arrays.
Did a small test, and it does not seem to make any difference.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20 June 2023, Dave, Agnes

  Changed EmChem19cj above to EmChem19rc - was mistake

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 June 2023, Dave

Config_mod
  - added TimeFacBasis:
          If CAMS_TEMPO_CLIM then month, week and hour factors from that data.
          If MIXED - old behaviour

config_emep.nml
  - Fixed type on SECTORS_ADD GNFR_G 2nd index (from 7 2 7 to 7 8 7)


Timefactors_mod
  - added TimeFacBasis:

  code re-arrangement started:
     to avoid if (.not.XXXX), and
     added labels to clarify loop start and end (e.g. HRLYLOOP)
     replaced if (ios==0) then with if (ios/=0) cycle - saves a load of
      indentation.

New code deals with CAMS_TEMPO_CLIM Hourly as a "Specials" case. Should make
default one day.

EmisGet_mod - fixed output format error for debug_tfac line

*** IMPORTANT ****
  If CAMS_TEMPO_CLIM used  then use SECTORS_ADD in config_emep.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13 June 2023, Peter

Fixed bug for MET2D outputting of 3D fields
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8 June 2023, Dave, Alvaro

  CAMS_TEMPO_CLIM methods enabled. Needs check, and possible bugs in
   CAMS_TEMPO and DAYOFYEARTIMEFAC need checking

  So, we have two CAMS options:

   CAMS_TEMPO (=from previous code, from 12/4/23)  - can read day-of-year variations

  USES%DAYOFYEARTIMEFAC = T,

   CAMS_TEMPO_CLIM = new - reads climatological monthly, day-of-week, and hour-of-day files
    from CAMS-TEMPO system.

   IMPORTANT:::

    If MonthlyFacBasis set to "CAMS_TEMPO_CLIM" in config, needs to
    uncomment/enable ADD_SECTORS lines in config_emep.nml to reset
    time-factor indices to 1-19, instead of SNAP's 1-11.

    *** Check if original CAMS_TEMPO and DAYOFYEARTIMEFAC methods should have
        done this.  Maybe hourly data were from SNAP sectors?


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7 June 2023, Dave

Timefactors.f90 - small tweak to debug output (tfacs:emm) to record which country
 and sector is found when using CAMS_TEMPO.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2 June 2023, Dave

Moved bgnd_ch4 dir to BoundaryConditions on nebula and atos.

Changed Config_module and config_emep.nml to cope.
Set appropriate fileName_O3_Top and fileName_CH4_ibcs in both.

BoundaryConditions_mod - now, fileName_CH4 needed=.true. if used.

CAMS REG.v5 emissplits set in config_emep-nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1 June 2023, Svetlana

BoundaryConditions_mod.f90: Mace Head correction is added for 2021
as calculated by Anna

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1 June 2023, Willem

Background CH4 is now read from a default ch4 input file. This file
contains historical concentrations up to 2019 and projections made using the
IIASA GP Review CLE scenario with Dirk's box-model. The folder containing the
default CLE CH4 file also contains files describing the SSP scenarios
discussed in CMIP6 AR6 Annex III.

The default behavior is that the iyr_trend CH4 concentration (when BGND_CH4=-1) is
replaced by the value read in from the file, if the file is found and if iyr_trend
is between 1960-2050 (range of years in the input file).

If the file is found but the year is out of range, the model stops.

When BGND_CH4 is set to something greater than zero in config_emep.nml, this
value overwrites the value from the input file.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 May - 1st June 2023, Dave

PARTIALLY UPDATE - STILL IN PROGRESS

AeroConstants - defaults to Isorropia

Config_module -defaults to:
 CLOUDJ           = .true. + same for CLOUDJAEROSOL, HRLYCLOUDJ, CLOUDICE,CLIMSTRATO3
 (+CLEARSKYTAB = F)
 HmixMethod = "NWP"
 FFireDispMethod = "PBL"
 soilnox_emission_File = 'DataDir/cams81_monthly_SoilEmissions_v2.4a_GLOBAL05_Clim2000_2020.nc'
 LandInputs%desert changed to DataDir/Olson_2001_DEforEmep.nc

BiDir_emep - change intent out to intent inout to avoid Make warning

Config_module - added YYYY change for fileName_O3_Top (Is this needed?)

Derived_mod - reduced dbg output amount

Met_mod - check if USES%FFireDispMethod and PBL%HmixMethod are consistent

MosaicOutputs_mod - added any_case to find_index calls

Runchem_mod - changed debug option to WindDust call.

config_emep.nml:
   PARTIALLY CHANGED. To be continued
  e.g.
   FINN_PATTERN='DataDir/ForestFire/FINN/v25mod/ForestFire_Emis_mod_v25_YYYY.nc',

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25 May 2023, Willem

When ISORROPIA-Lite is used for fine-mode thermodynamics, this now runs with
internally mixed sea-salt assumption as well as base cations from dust as default.
These assumptions can be turned off by specifying AERO%CATIONS and
AERO%INTERALMIXED in config_emep.nml.

SAFELOG10 function is now used in the aerosol pH calculations from ISORROPIA,
avoiding any possible NaN and infinities, as well as dealing with any possible
negative H+ concentrations.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19 May 2023, Peter

Proper handling of dates for O3_Top.
The intervall between records is assumed to be 3 hours, instantaneous values.
Will updates at time close to the middle of two time stamps.
Accept missing first record, or passing to a new year.
The vertical level is still hardcoded.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16-17 May 2023, Dave

Prepping BiDir followi9ng NMR meeting.

  BiDir_emep.f90    - matching subroutines to FUTURE version
  BiDir_module.f90  - matching BiDir type to FUTURE version
  Config_module     - matching BiDir type to FUTURE version
  Derived_mod       - calls BiDir_Derived if USES%BIDIR
  DryDep_mod.f90    - matching subroutine calls to FUTURE version
  SubMet_mod.f90    - use of BiDir%skipForestDisp
  emep_Main.f90     - removed call to BiDir_Init

 with in-progress files (NOT to be re-distributed) put here:
  FUTURE_BiDir_emep.f90
  FUTURE_BiDir_module.f90


Dust_mod: need DEBUG%DUST to call printCDF for deserts

Volcano stuff:
  config_emep.nml - switched to Heiko's new format file.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2 May 2023, Svetlana

EQSAM_mod.f90 updated from v10 to v11
AerosolCalls.f90 - modified accordingly (EQSAM is called for fine aerosols, including
                   Na, Cl, Mg and K from Sea salt
                   PM25_water and PM25_water_rh50 derived in same call (Aero_water and Aero_water_rh50 removed)
Runchem_mod.f90 - modified accordingly

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17 Apr 2023, Peter

LF: Remove short lived from lf (all assumed equal to base case at start).
N_lf_derivemisMAX now smaller; only one nemis per source.
Setup_1d modified when LF_fullchem, to avoid difference with base case
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13 April 2023, Heiko

ColumnSource_mod - >10x performance improvement for many emissions, i.e. Eyja
                 - fix pre-advection when locations contain several emissions, i.e. in different levels
Makefile         - add ppi-r8 with opath

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13 April 2023, Dave

EmisGet_mod - small debug formatting changes
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12 April 2023, Alvaro

MonthlyFacBasis="CAMS_TEMPO" option

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6 April 2023, Joffen, Dave

New Forest Fire vertical dispersion scheme

Adding USES%FFireDispMethod - allows either:
   "P800" = old, still default, or
   "PBL"  = new option - disperses through PBL.

Changes in:
 Config_module.f90 - USES%FFireDispMethod
                     Also USES%CLOUDJ is set true by default
 Derived_mod       - can output  Emis_CO_Profile
 EmisDef_mod       - adding Emis_CO_Profile
 ForestFire_mod    - use of USES%FFireDispMethod


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5 Apr 2023, Willem

Removed old Fastj code, and the model now reads in WRF ice cloud meteorology
when present in WRF input file.

Also fixed a minor bug where the CloudJ photolysis rate calculations were called
every model timestep between 23:00-24:00 hr UTC, even when hourly updates
were requested.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3 Apr 2023, Peter

Allow use of names for masks numbers (LF)
For LF, avoid convections for latitudes larger than 60.0

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 Mar 2023, Peter

Refactoring of the treatment of emissions in LocalFractions.
More unified between fullchem and other.
Now all setting treat non-antropogenic emissions correctly.
Fullchem accepts sectors and masks.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th March 2023, Willem

Polished Cloud-J code, now running with version 3 of the input stratospheric
ozone and temperature observations. The structure of this new input file makes
the cod compatible/function no matter the altitude (hPa) of the EMEP model top.

Also introduced new indexing in DefPhotolysis_mod to make the EMEP code
compatible with both the EmChem19 and CRIv2R5 chemical mechanisms. The
CLJ1-CLJ172 indices are used in CRIv2R5, and the EmChem19 photolysis reactions
are mapped to these for when the EmChem19 is used.

Also added the USES%CLOUDJVERBOSE option in Config_module.f90 to toggle
write-outs from the Cloud-J code in the model output file. Default set to F,
to avoid lengthy output files.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
NEW TAG: rv4.51 (as desert mask changes results)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23-24 Mar 2023, Dave

 Adding desert masks to prevent European areas producing sand - prelim default
  set to Olson mask.

 Config_module.f90 changes to allow LandInputs%deserts, LandInputs%ssmThreshold

 Debug_module.f90 - changed DEBUG_DUST to DEBUG%DUST

 DustProd_mod.f90 - Now allow Olson or ParajuliZender deserts to override
  default settings. Removes deserts (and hence dust) in Spain, Scotland, etc.
  Output PRINTCDF_Deserts_xxxxx shows original desert and modified desert.

  Plus, re-organisation of code and formatting.

 RESULTS WILL CHANGE if Olson or ParajuliZender chosen for LandInputs%deserts
 BEST value for ssmThreshold is still unclear, hence the Olson mask seems
 good-enough for now.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
NEW TAG: rv4.50
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 Mar 2023, Dave

New default for soil emissions, using climatological data.

Emissions_mod.f90:  Implemented v2.4 climatological emissions. CLimatology triggered by
  file name: cams81_monthly_SoilEmissions_v2.4a_GLOBAL05_Clim2000_2020.nc
  (Needs a more elegant solution one day, but not today.)

Config_module.f90: added extra outouts (MonthlyFacFile etc) to RunLog.out outputs), and reverted default MonthlyFacs to xJune2012 settings. Needs to be followed up!

config_emep.nml: removed MonthlyFacFile, MonthlyFacBasis.

Results will change a bit.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th Mar 2023, Willem

Added config option to exclude reading in cloud ice meteorology fields,
which in config_emep.nml can be set by

USES%CLOUDICE       = F,

Also added a flag for climatological overhead stratospheric ozone for use
in the Cloud-J photolysis rate calculations. Default is to use climatology,
until the effects of monthly means (between 2005 and 2019) on surface ozone
trends is investigated in more detail.

Using monthly-means for the available years can be set through

USES%CLIMSTRATO3    = T,

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th Mar 2023, Dave

Config_module: cmxBiomassBurning_GFASv1 now modified to 'ZCMDIR/CMX_BiomassBurning_GFASv1a.txt', instead of v1.txt. The v1a data adds PM emissions.
Results will change for GFAS users!

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th March 2023 Dave

ForestFire_mod - small improvements in debug output
GridValues_mod - i4 to i5 on coord output
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
NEW TAG rv4.49 = Tagging for isorropia_lite version
(Applied 13th Feb. 2023, but added here 7th Mar 2023)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th Feb 2023, Willem

Added option to output surface aerosol pH, calculated using ISORROPIA-lite.

Edit: removed unintentionally added (undefined) variable, and added
a min concentration limit to aerosol water content to avoid division by zero.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th Feb 2023, Willem

Old ISORROPIA II code is replaced with Isorropia-lite (2022 code).

Aerosol water uptake is handled in the thermodynamics call to isorropia, for
which the (i,j) grid indices are now included in the AerosolEquilib call.

The new config option AERO%INTERNALMIXED determines whether or not internal
mixing is assumed. If set to true, Na and Cl from sea salt are included in the
call to isorropia.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22nd Mar 2023, Peter

SMall bug fix: if MET2D was used when a 3D metfield was outputted, and debug
options were applied, it would stop.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th Feb 2023, Peter

The reading of global emission files in new format was *very* slow. The read
time increases with the number of variables in the emission files EVEN if they
are not read !!
It is solved by defining the time dimension in the file as fixed instead of
unlimited. This simple trick divides the read time by a factor of 30 or so!

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th Feb 2023, Peter

Convection implemented for Local Fractions

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd Feb 2023, Peter, Heiko
For Lambert projection (EMEP4NO/AROME), we redefine the emep Earth radius as
the value found in the meteo file (not WRF though).
Emep default Earth radius: 6370000 m
Arome/Lambert Earth radius set to: 6371000 m

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd Feb 2023, Peter, Heiko
We store u10 and v10 (10m wind speed) in the model.
(previously only sqrt(u10**2+v10**2) was stored)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 Jan 2023, Arjo Segers
Updates for simulation at pixel and/or station locations in "ZD_EmCso" sub-code.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30 Jan 2023,  Dave
NEW TAG rv4.48a = bug-fixed 4.48
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 Jan 2023,  Peter

Bug fix: the code had an array not allocated. (Introduced 19th jan)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25 Jan 2023,  Dave
NEW TAG rv4.48

- contains changes from Sep 2022.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19 Jan 2023, Peter

Upgrade of emissions in "new format". Can read sectors as extra dimension in
NetCDF file. Much faster. Use less memory.

Extra utility file: utils/ReadWriteEmis.f90 which converts a file in old
format into a file in new format (model results are unchanged). This code
will still improve.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 Jan 2023, Svetlana

1. AerosolCalls.f90: Aero_Water - calculates both PM25_water and PM25_water_rh50
                     from EQSAM  (Aero_Water_rh50 is not used)
   Runchem_mod.f90: call PM25_water_rh50  is commented out

2. AOD_PM_mod.f90 - updated for SO4, NO3f and NH4f extinction efficiencies:
                    Cext for soluble aerosols (as for OC) from OPEC

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23rd Dec 2022 -2 Jan2023 Peter, Svetlana, Dave

Removed lwc variable which was used as a = cc3d *0.6*1-6
In Aqueous use cw_met instead which is the variable using cloudwater from the
metdata.
Make cw_met from cc3d if cloudwater not defined in metdata.
Make cc3d from cw_met if cc3d not defined in metdata.
Stop if cw_met and cc3d not defined in metdata.

surface pressure was used for all levels! (corrected in this version)

Changed CW_LIMIT from 1e-10 to 1e-7, since now it is used againt cw_met which
is multiplied by roa and 1e-3

Changed CW2CC from 1.e6 to 1.e4, but it is not used for cc3d in fraction units.
So no net change of value.

In Aqueous, lwc was used, i.e. lwc=cc3d *0.6*1e-6. Now if cloudwater was not found
in metdata, (1/CW2CC)*1e-3 is used instead. So the net effect is that 0.1*1e-6
is no applied instead of 0.6*1e-6.

Time interpolation is done now (before cc3d was constant during METSTEP)

2nd Jan 2023: changed some comments, but no code change.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st Dec 2022 Peter, Heiko

The met levels are checked against they mid values instead of bnd values.
Bnd values will have no sense if not all levels are present in the met file
(In Arome, we want to store only the required levels in the metdata)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th Dec 2022 Dave

Enabled PM10 and ffire_c and FINNv2.5 usage. (1.5 still works, just change FINN_PATTERN in config as below)

ForestFire_mod:

  Added PM10 to
  also notation change, removing 1p5 from FINN variables

Config_mod

  v2.5 mentioned, and small notation change, but not default. Choose in config:

config_emep.nml

  ! Dec 2022: can use same mapping file for 1.5 and 2.5, but need different FINN patterns:
  !v1.5 here:
  FINN_PATTERN = 'DataDir/ForestFire/FINN/ForestFire_Emis_v15_YYYY.nc'
  !v2.5 here:
  FINN_PATTERN = 'DataDir/ForestFire/FINN/work/v25_convert/ForestFire_Emis_modvrs_v25_YYYY.nc'

  cmxBiomassBurning_FINN = 'ZCMDIR/CMX_BiomassBurning_FINNv2p5.txt',  ! works also for v1.5


Also, tiny re-format in AerosolCalls. To remind me of something...

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th Dec 2022 Peter

CLOUDJ switch for cloudwater was broken.

Makefile and DataDir in config_emep.nml adapted for new machine Atos

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th Dec 2022 Peter, Heiko

AROME meteorology:
Included more advenced treatment of 3D precipitations reconstruction.
cloud_ice and cloudwater.

NB: lwc in Aqueous is completely wrong! (has been for a while)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

8th Dec 2022, Willem

- Improved CloudJ aerosol handling by allowing hygroscopic growth of sea salt
  using Gerber functions (for now), considerably increasing sea salt aerosol path.

- Fixed CloudJ issue where forest fire organic matter (OM) was divided by 1.7
  to get original OC values from emissions, causing the total forest fire
  aerosol loading to be misrepresented.

- CloudJ default stratospheric O3 observational input folder changed to
  OzoneObs_v2. These files more accurately represent pressure interface
  levels starting from EMEP 100 hPa top and the ozone path between these
  levels. Negligible change on simulation results. Next version (v3) will
  be more flexible in how it handles EMEP model top.

- Added aerosol functions in AeroFunctions_mod. Not all currently in use, and
  if used, only in CloudJ for now. Sig functions include effects of geometric
  standard deviation growth using Gerber's (1985) function. Lewis & Schwartz
  can be used to describe sea salt growth.

       - GerberWetSig
       - pmSurfAreaSig
       - pmH2O_gerberSig
       - LewisSchwartz

- EmChem19rc added ffire_c emissions line

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

6th July 2022, (But pushed 28 Nov) Peter

LF with full chemistry: include voc derivatives through new emis system.
borders (several countries in same gridcell, with different splits) are also
accounted for now.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25 Nov 2022, Qing

Complete the code example from 23 Nov 2022 by Dave.

EcoSystem_mod.f90 - complete first 16 LC for Norway work.

My_Derived_mod.f90 - complete Area_ of 16 LC to D2_EXTRA

Config_module.f90 - increase MAX_NUM_DDEP_ECOS from 9 to 25 to allow extra 16 LC output.
                    increase MAX_NUM_DERIV2D from 343 to 600.

DerivedFields_mod.f90 - increase MAXDEF_DERIV2D to 1000.

MosaicOutputs_mod.f90 - increase MAX_MOSAIC_OUTPUTS from 150 to 500
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 Nov 2022, Dave

Prelim code changes to help Norwegian Tlegrenser project. To be completed by Qing.

EcoSystem_mod.f90 - added CF and DF to DEF_ECOSYSTEMS, with new param LAST_ECO.
  Should be continued with remaining land-cover categories for Norway work.

My_Derived_mod.f90 - adding Area_ for CF, DF etc to D2_EXTRA

MosaicOutputs - tiny comment change

config_emep.nml - added CF, DF to DDEP_ECOS, and NO2 example in DDEP_WANTED

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 Nov 2022, Dave

Adding ISORROPIA back as aerosol solver. PRELIMINARY!!!
  Needs more testing, and we need to add HCl etc, but it seems to work
  numerically at least. (I had to add checks for negative concentrations
  in AerosolCalls though, but the ones I saw were very small, and mass
  balance hasn't deterioated verh much.)

AeroConstants_mod  - just refer to ISORROPIA now, but can change in config anyway

AerosolCalls - now has ISORROPIA as possibility

Makefile - now with isocom.f90, isorev.f90, ISOFWD.f90

renamed FUTURE_xxx to xxx.f90 for xxx = isocom, isorev, ISOFWD


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4 Nov 2022, Dave

Adding nonForest as ecosystem category - everything which isn't forest (includes
seminat, water, ..)

EcoSystem_mod - adding nonForest
My_Derived_mod - adding Area outputs of Forest and nonForest

Debug_module - switched DEBUG_ECOSYSTEMS to DEBUG%ECOSYSTEMS
DryDep_mod   - switched DEBUG_ECOSYSTEMS to DEBUG%ECOSYSTEMS

config_emep.nml - adding both Forest and nonForest to defaults
                  updated runlabel2 to rv4_47



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3 Nov 2022, Dave

Added  ffire_c emissions line for EmChem19a, EmChem19p, EmChem19r, EmChem19rp, since
GFAS has substantial emissions in coarse mode.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18 Oct 2022, Willem
ryDe
Added and expanded aerosol functionality in the photolysis rate calculations
using Cloud-J. The latter now takes into account the effects of sea salt,
forest fire (biomass burning), dust, and sulphate.

CloudJ photolysis rates are now also mapped onto all photochemical reactions
present in EmChem19.

Photolysis rate definitions for chemistry that includes explicit glyoxal
channels and PAN photolysis are now included.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17 Oct 2022, Willem

Bug fix in the call to LogNormFracBelow in Derived_mod.f90, used to calculate
the PM25 fraction of coarse nitrate. Fraction changes from 0.13 to 0.20.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6 Oct 2022, Willem

Fixed the equation that calculates the gravitational settling velocity (v_s) for ash
and other aerosol particles. Previously, a wrong notation for the drag coefficient
was used in determining a single expression for v_s.

Together with the temperature bug fix from below, newly calculated v_s values are
about a factor of two greater than before.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30 Sep 2022, Willem

Fixed a bug in the gravitational settling module(s) where potential temperature
was treated like absolute temperature in the calculations for the dynamical
viscosity and mean path of air.

Updated Setup_1d to include specified methane and hydrogen background
concentrations, which only come into effect when these species are defined
with <> brackets in the CM files (like H2O, O2 and N2 are in EmChem19).

Other minor tweaks involve cloud liquid water content being a mandatory field
when CloudJ is used to calculate photolysis rates (as a bare minimum), and that
the read-in level of the newly downloaded O3 top boundary files matches that
of the EMEP top layer (maybe this hardcoding should be avoided in the future).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

29 Sep 2022, Dave

Added output of "New format" emissions to RunLog, wth EMTBL label (cf EMTAB
from emis_inputlist methods). Also produces summary table at end of
RunLog.

NOTE: only tested for simple annual emission input. BE CAREFUL and suspicious
for other situations.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27 Sep 2022, Peter

when emis_inputlist()%sector == 'GNFR', redefine as'GNFR_CAMS', for
compatibility with treatment of sectors_name from the emission file (which was
already redefined automatically).
It was already done for the emissions in "new format", sectorsName

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
07 Sep 2022, Dave
NEW TAG rv4.47

- reflecting addition of CloudJ functionality, and changed results  from
Willem's changes.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
05 Sep 2022, Arjo Segers

Extended error messages to trap incorrect records in listings of satellite data.

  ZD_EmCso/cso_listing.F90
  ZD_EmCso/cso_string.F90


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
05 Sep 2022, Arjo Segers

Added optional argument "fix" to "coord_in_domain" to prevent that
longitudes are changes by a call to this routine.

  GridValues_mod.f90

Updated comment.

  PhyChem_mod.f90

Synchronized source files in "ZD_EmCso" extension with changes in base model.

  ZD_EmCso/GridValues_mod.f90
  ZD_EmCso/PhyChem_mod.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 Aug 2022, Wim van Caspel

Introduced CloudJ functionality, which can be toggled on/off in Config_emep.f90.

In the current setup, CloudJ can be used to calculate photolysis rates
for reactions having a 1-to-1 correspondence with those from the standard
CloudJ input files (which are most of the EMEP reactions, see Runchem_mod.f90). The
new code runs as 'stand alone' for all years. Between the years 2005 and 2021
monthly mean lat-lon-altitude satellite ozone and temperature data are read in.
For other years, monthly climatologies based on these years are used instead.

IF USES%CLOUDJ = .true. CloudJ is used to update rcphot(:,:)
IF USES%HRLYCLOUD = .true. CloudJ updates only once every model hour
  rather than every model timestep, to save CPU time

For global runs, hourly CloudJ calls lead to a ~10% increase in CPU time,
whereas instantaneous CloudJ calls lead to a ~25% increase in CPU time.

An additional change includes a bug-fix to DefPhotolysis_mod.f90, which caused
only clear-sky tabulated Jvalues to be used at all times.

IF USES%CLEARSKYTAB = .true. only clear-sky tabulated Jvalues are used, to comply
  with the state of the model pre-bug-fix.

Another minor change is that the 3d cloud cover array cc3d, used in
Aqueous_n_WetDep_mod.f90 and Met_mod.f90, is now interpolated
in time, for consistency with the other metfields used by CloudJ.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 Aug , 15 sep 2022, Peter

Emis new format: allow use countrycode as a number.
LF: removed RUE from country predefined group

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30 Aug 2022, Peter , Hilde, Dave

Average of daily max 8 hour mean:

OutputMisc=
   'AvgMDA8','AvgMDA8', '',  'O3', 'ug/m3', -1 , -1, F, 1.0, F, 'Y',
   'AvgMDA8_6month','AvgMDA8AprSep', '',  'O3', 'ug/m3', -1 , -1, F, 1.0, F, 'Y',

The first field is the name in the output,can be chosen freely.
For AvgMDA8AprSep only the monthes from Apr to Sep are included for yearly, but
all month have a monthly value (i.e for monthly, AvgMDA8AprSep and AvgMDA8 are the same)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 July 2022, Peter & Massimo

Bug in emis new format: the "%factor" attribute, when given in the config file
for the the entire file, was not applied.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
03 June 2022, Agnes & Anna

Mace Head correction for 2020 added to BoundaryConditions_mod.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th May 2022, Peter

LF with full chemistry: correctly takes into account Dchem and short-lived
for chemical derivatives.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23th May 2022, Qing, Peter

phih can be outputtes with:
OutputMisc= 'phih 10m' ,'phih','phih' ,'phih',' ' ,10,-99,F,1.0,T,'H',

The 10 (index) is the height. Must be integer.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20th May 2022, Peter

Allow to use degreedays together with dayofyear timefactors.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th May 2022, Peter

Small changes for compatibility with gfortran

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th May 2022, Peter, Alvaro, Svetlana

Can define a file with timefactors defined every day of the year instead of
monthly+weekly factors.
Usage example, in config_emep.nml:
  USES%DAYOFYEARTIMEFAC = T,
  DayofYearFacFile ='/home/sm_alvva/EMEP/time_factors_2020/no_lockdown.POLL',

Bug in DegreeDays when a country used the timefactors from another country,
the DD would not work, i.e. give only hourly variation, but constant between all days.

In Europe, it is only RUX (Russian Fed. outside emep) which is affected,
so no dramatic changes (this is only domestic sector, and sums over a year are still correct).

fac_min(iland,tfac_idx,iem) should be  fac_min(iland_timefac,tfac_idx,iem)
fac_min(iland,tfac_idx,iem)=1.0 (dfault) for countries which do not have a
monthly factor defined for themselves, as RUX.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22nd April 2022, Peter

Changed the printout of model level heights using Pref instead of P0.
WRF use P0= 100000Pa. Which means a surface pressure much lower than a standard
atmosphere(!). Using P0, gave a surface with height 110m, which is confusing.
Does the P0 from WRF actually mean something?

The results (pollutants etc.) should be unchanged anyway: P0 is a local
variable, not used after the printout of model heights.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th March 2022, Alvaro

update rv4.45 tag
git tag -a rv4.45 -m "OpenSource rv4.45 (202203)" -f
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21th March 2022, Alvaro

git tag -a rv4.45 -m "OpenSource rv4.45 (202203)"
git tag -a CAMS2-40.202203 -m "CAMS2-40 U5 production"
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10 Mar 2022, Dave

Config_mod - switches default soilnox_emission_File to be v2.3, not v2.2, of the CAMS81 data.

 Changes results, but only V. SMALL changes in monthly concentrations.

EmisGet_mod    - small debug changes
Emissions_mod  - small debug changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th Feb 2022 Peter, Dave

Fixed memory issue when number of emis sources is very large.

NB: on Betzy Makfile now requires
ml load netCDF-Fortran/4.5.3-iompi-2021a

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th Feb 2022 Dave
Made NEmis_sourcesMAX a config variable. Changes in:

  Config_mod
  EmisDef_mod
  EmisGet_mod   - allocate source_found
  Emissions_mod - allocate Emis_source, ix3Dmap

Also:
   Solver - added rcemis ranges in NCHEM error message
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th Feb 2022 Dave

Derived_mod: one extra comment about SOMO
EmisGet_mod: allow Mg, small debug changes
Emissions_mod: Added Mg as unit (CEIP provide as Mg)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th Feb 2022 Peter

Added the possibility to output the 1st, 2nd, 3rd and/or 4th highest Max8D
fullrun value. (99% highest over 1 year is between  third and fourth)
Only fullrun output make sense(?)

OutputMisc=
   'MaxD8M_O3_1st','MaxD8M_1st', '',  'O3', 'ug/m3', -1 , -1, F, 1.0, F, 'Y',
   'MaxD8M_O3_2nd','MaxD8M_2nd', '',  'O3', 'ug/m3', -1 , -1, F, 1.0, F, 'Y',
   'MaxD8M_O3_3rd','MaxD8M_3rd', '',  'O3', 'ug/m3', -1 , -1, F, 1.0, F, 'Y',
   'MaxD8M_O3_4th','MaxD8M_4th', '',  'O3', 'ug/m3', -1 , -1, F, 1.0, F, 'Y',
   'MaxD8M_O3', 'MaxD8M',  '',  'O3', 'ug/m3',       -1 , -1, F, 1.0, F, 'YMD',

NB: if one of the 'MaxD8M_Xth' is used, 'MaxD8M' for  'O3' must be defined too.
Only O3 can be outputted for 'MaxD8M_Xth'.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31st Jan 2022 Dave

Cleaning: removed Idirect lines from:
  CellMet_mod.f90
  Derived_mod.f90
  LocalVariables_mod.f90
  PhyChem_mod.f90
  Rsurface_mod.f90

Small tidy and simpified debug
  StoFlux_mod.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th Jan 2022 Peter

Added the 26th highest Max8D fullrun value. (gives approximately the 93% percentile
highest value). For EU target value "120 g/m 3 not to be exceeded on more than
25 days per calendar year averaged over three years"

OutputMisc=
   'MaxD8M_O3_26th','MaxD8M_26th', '',  'O3', 'ug/m3',  -1 , -1,   F,    1.0,   F, 'Y',
   'MaxD8M_O3', 'MaxD8M',  '',  'O3', 'ug/m3',          -1 , -1,   F,    1.0,   F, 'YMD',

NB: if 'MaxD8M_26th' is used, 'MaxD8M' for  'O3' must be defined too.
Only O3 can be outputted for 'MaxD8M_26th'.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th Dec 2021 Peter

Local Fractions: the emissions for the "fullchem" mode, are included through
derivatives in the chemical scheme. Lots of reorganizations required in the LF
routines.

mk.LFChem adapted too. Need some manual changes too(?)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th Dec Peter

maximum daily eight-hour mean concentration

Following page 24 note (2)
https://eur-lex.europa.eu/LexUriServ/LexUriServ.do?uri=OJ:L:2008:152:0001:0044:EN:PDF

The maximum daily eight-hour mean concentration shall be selected by examining
eight-hour running averages, calculated from hourly data and updated each hour.
Each eight -hour average so calculated shall be assigned to the day on which it
ends. i.e. the first calculation period for any one day will be the period from
17:00 on the previous day to 01:00 on that day; the last calculation period
for any one day will be the period from 16:00 to 24:00 on the day.

Can be used with for example (in config_emep.nml):
OutputMisc=
   'MaxD8M_O3', 'MaxD8M', '',  'O3', 'ug/m3', -1 , -1,   F,    1.0,   F, 'YMD',
   'MaxD8M_CO', 'MaxD8M', '',  'CO', 'ug/m3', -1 , -1,   F,    1.0,   F, 'YMD',


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th NDec 2021, Peter, Michael

NEST_MODE_SAVE = 'MONTH': write out also at end of year.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th Nov 2021, Heiko, Peter

Remove -ftz compiler flag in Makefile, as it is implicit in -O2 (or -O3)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th Nov 2021, Peter

Removed many old config files, that were anyway not maintained and no more
compatible.
rm 'config_ANALYSIS.nml'
rm 'config_EMEPGLOB.nml'
rm 'config_EMEPSTD.nml'
rm 'config_EMERGENCY.nml'
rm 'config_FORECAST.nml'
rm 'config_IMPACT2C.nml'
rm 'config_NORWAY.nml'
rm 'config_Outputs_CAMS50.nml'
rm 'config_Outputs_CAMS71.nml'
rm 'config_Outputs_EMEPSR.nml'
rm 'config_Outputs_EMEPSTD.nml'
rm 'config_Outputs_EMERGENCY.nml'
rm 'config_Outputs_NORWAY.nml'

put printCDF('NEWSGS_IAM_DF'..) behind the DEBUG flag

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th Nov 2021, Peter, Heiko

New optimization flag in Makefile. Tested on Nebula. Can give 25% improvement
in runtime!

(cut from a mail to Heiko:)
Test on Nebula, EMEP01, 6 hours, 8*32 CPUs.
times: total within loops

 -O2  -ftz 38.3
 -O2  -ftz -ipo 38.9
 -O3  -ftz 38.7
 -O2  -ftz -march=core-avx2 -ipo 33.4
 -O2  -ftz -march=core-avx2 31.8
 -O3  -ftz -march=core-avx2 34.6
 -O3 -xcore-avx512  -ftz  -ipo 37.5
 -O2 -xcore-avx512 -ftz -ipo 36.5
 -O3 -xcore-avx512  -ftz 38.7
 -O2 -xcore-avx512 -ftz 37.1
 det er omtrent 1 sekund random usikkerhet i tallene)

S det ser ut som ipo og O3 forverre tiden, mens avx2 er nyttig. Litt rart at avx512 blir verre igjen.
Omtrent 10 sekunder av tallene er i/o, som (ofte) blir relativt lite for lengre kjringer. Dvs at for resten gr man fra ca 28.3 til 21.8 (med -O2  -ftz -march=core-avx2), = 23% forbedring i kjretid

P den andre siden, har jeg ogs gjort noen tester med nye Local Fractions som har veldig tung (vectorisert) kjemi loop. og der blir:

-O2  -ftz 429.7
-O2  -ftz -march=core-avx2 -ipo 416.3
-O2  -ftz -march=core-avx2 352.8
-O3 -xcore-avx512  -ftz  -ipo 360.5
-O2 -xcore-avx512 -ftz 325.4

S her er det en del  hente med avx512!

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th Nov 2021, Peter

Emission new format: "country" when defined with number (not ISO) was not
working properly.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th Nov 2021, Peter, Massimo

The 2 meter relative humidity from wrf had wrong units.
Now converted from kg(H2O)/kg(air) into relative to saturation.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd Nov 2021, Peter

Accept average for SOMO class. Allows to output monthly average of MDA8 with:
OutputMisc='MDA8', 'SOMO','SURF',  '-','ppb',0,-99,F,1.0,T,'YMD',

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th Oct 2021, Peter

Back to (i,j) = (dx,dy,34,42,1) for the LF chunksize
NetCDF LF 5dim output: put data from all subdomain into one big array before
writing, if the array is les than 2GB (for faster write).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th Oct 2021, Peter

Corrected bugs introduced 22nd Oct 2021, for LF chunksizes optimizations.

Also noticed/corrected that the lf%out_DOMAIN was not working for the upper
bounds

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th Oct 2021, Arjo

Updated satellite observation operator.

Makefile                    - Removed dependency on chemistry version.

ZD_EmCso/EMEP_CSO_mod.f90   - Fixed memory leak.
ZD_EmCso/PhyChem_mod.f90    - Fixed memory leak.

ZD_EmCso/Makefile           - Added templates to enable debug flags.
                              Removed macro definition flag to enable MPI code.
ZD_EmCso/Makefile.SRCS      - Updated comment.

ZD_EmCso/cso.inc            - Define macro to enable MPI code.

ZD_EmCso/GridValues_mod.f90 - Optional argument "fix" to "coord_in_domain"
                              to disable automatic adaptation of arguments.

ZD_EmCso/config/config_GLOBAL05.cams81__cso.nml   - Template settings for global Soil-NOx runs.
ZD_EmCso/config/cso-settings__S5p-no2-superobs.rc - Template settings for global Soil-NOx runs.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th Oct 2021, Peter, Dave

Replace "YYYY" for the SplitSpecialsFile and SplitDefaultFile.
For Specials, the file must exist for at least one pollutant,
for Defaults they must all exist.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22nd Oct 2021, Peter

Reorganizing the writing of localfraction in NetCDF. Chunk sizes are now:
(dx,dy,64,64,1,1)
Now each CPU send its data to master, which writes it as soon as it is
received (only for the LF).

Should be much faster write and faster uEMEP read too.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th Oct 2021, Dave

Small debug changes:

  GridValues_mod: small re-format to ensure space in dbg statememt
  RunChem_mod: made debug_flag argument to setup_1d call
  Setup_1d: made debug_flag argument to setup_1d call

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th Oct 2021, Dave

RE-TAGGED as rv4.44. MMD change of 14/10/21 was only committed on 16/10/21
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th Oct 2021, Dave

GasParticleCoeffs_mod: (should have been done for rv4.44)
  Changed MMD of SS to 4.0um (was 4.8)

SeaSalt_mod.f90:   just added helper text.

Chasing strange behaviour:
  CellMet_mod.f90:  Added some debug lines
  Setup_1d_mod.f90: Added some debug lines.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th Oct 2021, Arjo

Testing benchmark for satellite observation operator.
Added extra checks on input files.

ZD_EmCso/cso_ncfile.F90         - check number of dimensions of variable
ZD_EmCso/cso_pixels.F90         - show information on supported attribute types
ZD_EmCso/config/config_emep.nml - updated benchmark settings
ZD_EmCso/config/cso-settings.rc - updated benchmark settings

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th Oct 2021, Dave
DELETED TAG: rv4.44

GasParticleCoeffs_mod:   FAILED **** wasn't committed :-(
  Changed MMD of SS to 4.0um (was 4.8)

WETRAD is now removed from config, and wet radius used always when applicable

  config_emep.nml
  Config_module.f90
  DryDep_mod.f90

Landuse_mod.f90
  PFT_MAPs check added, so that updateSGS only called if USES%PFT_MAPS false
  (ie for global runs)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th Oct 2021, Arjo

Facilite debugging of incorrect source description.

ColumnSource_mod.f90  -  ignore empty lines in column source description files,
                         print routine name in error messages.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th Oct 2021, Arjo

Added extension "ZD_EmCso" for simulation of satellite observations.
Main Makefile has a new target "EmCso" to compile the model including
this extension.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th Oct 2021, Dave

Just prepping for futire Tleaf calculations:

Biogenics_mod.f90 - uses Grid%dTleaf, though this is currently zero

Config_mod.f90 - added TLEAF_FROM_HD, TLEAF_FROM_RN, both .false. for
                 future usage.

Derived_mod.f90 - added dTleafHd, dTleafRn outputs as MISC. Also corrected
                  indentation of some "end forall"

Io_Progs  - misleading initial text removed (claiming F-compliance).
          - datewrite_iia improved using advance='NO' construct to avoid
            useless outputs

MetFields_mod - added dTleafHd, dTleafRn possibilities. Use of USES%TLEAF etc
    temporarily disabled to allow model to run.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th Oct 2021, Dave

Landuse_mod - add %has_veg and %GsH2O to LandCover

LocalVariables_mod - adding Tleaf testing variables dTLeaf, Tleaf, GsH2O

PhysicalConstants_mod - pi is now 4*atan(1.0) = best possible ;-)
            Added LAMBDA_W, GAMMA_Psychr
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th Oct 2021, Peter

More robust netcdf "conservative" interpolation: neglect the values larger
than 1e30, so as to avoid "fillvalues".

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th Oct 2021, Dave/Peter

changed usage of printCDF to avoid single-processor calls
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th Oct 2021, Peter

Local Fractions. Changed the behaviour at top of LF region.
Earlier the LF where not mixed with LF above the region in adv_k,
now they mix with lf=0.

Mask bug corrected: model stops in a checkstop.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th Sep 2021, Dave

BUG-FIX: SoilWater_mod was setting all fSW to 1.0!! Also changed DEBUG_SOILWATER
 to DEBUG%SOILWATER. Fixes in:

 Debug_mod.f90
 Met_mod.f90
 SoilWater_mod.f90
 SubMet_mod.f90

USES%WETRAD added as option to trigger use of wet-radius and density in
  aerosol settling velocity (Vs) calculations. Only really affects coarse
  sea-salt.

  Default is .false. for now to preserve rv4.43 results, but will be set .true.
  very soon, after further tests and maybe another tweak or two.

   Changes in:
    config_emep.nml - added USES%WETRAD for clarity.
    Config_mod.f90 - just added WETRAD in USES structure
    DryDep_mod.f90 - uses USES%WETRAD

  Note: current system tests both wet and dry Vs just to compare in debug output.
  A more CPU effective vesion would only calculate the one needed.
  Also, the USES option will be removed once we are happy that everything works
  well. Settling velocity should use the wet radius and density.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th Sep 2021, Dave
NEW tag:rv4.43

Changes to update POD calculations to 2017 Mapping Manual (MM):
(Results don't change very much at all, except slight degrade in O3 and
 new veg for POD.)

1) added PODscale and SMIcrit params to do3se(iLC) type
    and also special treatment for IAM_SNL_MED

  Impacts:

   AOT40nPOD_mod.f90 - uses PODscale
   DO3SE_mod.f90 - added PODscale and SMIcrit
                   and L%g_sto = min( do3se(iLC)%g_max, 550.0) - for IAM_SNL_MED

   DataDir/Input_LandDefs_Sep2021, with map of (approx) Meditteranean


2) Use of mask for (approx) Meditteranean, and of topography for SGS, EGS

    - medMap_0.5deg.nc
    - updates LandDefs, DO3SE with new MM IAM vegs

  Config_module.f90 - reads LandCoverInputs%mapMed
  Landuse_mod.f90   - routine updateSGSmaps corrects SGS, EGS for topography

  DryDep_mod.f90 - calls updateSGSmaps to change SGS, EGS

3) Introduced fSW40, fSW50 and fSW90 for different veg. Impacts:

  CellMet_mod.f90
  LocalVariables_mod.f90
  MetFields_mod.f90
  SoilWater_mod.f90
  SubMet_mod.f90

Other:

  config_emep.nml - new LandInputs, POD, FLUX_VEGS

  LandDefs_mod: dbg changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th Sep 2021, Dave

Derived_mod: just added 2 small safety checks
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31st Aug 2021, Peter

Added the "RESTART" option for NEST. This is to be used when one restart a run
without changing the domain size ("checkpoint-restart").
The difference with "START" is only that BC are not overwritten. This is important
In the case of restarting exactly at the start of a month (at time 00:00, the 1st),
because the nest file had the BC from preceding month, and it will otherwise
use old month BC.

Allow to define a multiplicative factor for emission masks for new format
emissions, for example:
EmisMask(1)%fac = 0.85,

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20th Aug 2021, Peter

Reduce the threshold for "no sea and no land" warning, since it was often giving
huge numbers of false warnings.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th Aug 2021, Alvaro

Allow daily ouput of emissions with the flag DailyEmisOut = T

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th Aug 2021, Alvaro

Stop simulation when an external BC mapping is required (USE_EXTERNAL_BIC=T)
but no ExternalBICs_bc namelist matches the required EXTERNAL_BIC_NAME/EXTERNAL_BIC_VERSION.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th Aug 2021, Peter

Core parts of the full chemistry setup for Local Fractions.
Runs the chemistry loop many time to make numerical derivatives.

the script utils/mk.LF_chem must be run to modify the two CM_ReactionsX.inc

Still rough version, not really practical:
All advected species are included in the LF O3 chemistry, even if many (most?) of them
do not contribute.
Only country sources.
Corresponding LF values are not normalized (? concentrations maps are defined
with an unknown multiplicative constant)
Equilibrium chemistry not included.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th Aug 2021, Peter, Qin, Agnes, Dave

EmisDef_mod
timefactor and height release for GNFR_D changed from 4 to 5
(=SNAP indices for "Production processes").

NB: WILL CHANGE RESULTS.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th Aug 2021, Peter

Exact Local Fractions for O3 chemistry. Still under development.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th July 2021, Peter

Primitive "linear O3" Local Fractions for countries.
Use
lf_src(1)%species="NO2"
lf_src(2)%species="NO"
lf_src(3)%species="oddO".

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd July 2021, Peter

New masks possibilities for Local Fractions. Can give a netCDF file with
integer values that show different regions to include as sources.
 example /nobackup/forsk/sm_petwi/Data/municip_mask/municip_mask_500m.nc

New format for lf_country, use lf_country%list instead of lf_country_list etc.

Some compatibility with UTM projection (to read the Norwegian municiplaties masks)

Larger size for new format emissions arrays (EmisFiles).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th June 2021, Peter

LocalFractions: faster wetdep calculations.
(for some reason the call to lf_wetdep itself was taking long time.
Probably called very many time. Now it is called only for species that are
wetdeposited )

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th June 2021, Dave

Prepping for EQSAM:

 AeroConstants_mod: Added logical JUN21AERO to AERO type (default false)
 ChemFields_mod   : new fields, allocated if AERO%JUN21AERO is .true.
 My_Derived_SR    : commented out JUN21AERO option.
 Derived_mod      : JUN21AERO outputs for pmcowater

Small changes
  EmisGet_mod - just print femis warning from MasterProc
  Sites_mod   - just print levels warning from MasterProc

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22nd June 2021, Dave

Adding ZCM_EmChem19a-CAMS5

 - for use with CAMSv5 (CANT) emissions, which have OC and EC. Activate with
   mk.ChemFiles EmChem19a-CAMS5 as usual. Be careful with emissplits though -
   they are not yet added in DataDir, but exist in ZCM_EmChem19a-CAMS5.

 - will added in ecosx or genchem soon....

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th June 2021, Peter

Replaced many of the hardcoded species indices by "soft" indices, so
that it is possible to compile the model with chemistry where thoase are
not defined.

define_chemicals_indices makes:
SO2_ix, O3_ix, NO2_ix, SO4_ix, NH4_f_ix, NO3_f_ix,
NO3_c_ix, NH3_ix, HNO3_ix, C5H8_ix, NO_ix, HO2_ix, OH_ix

To check:
In DryDep default for so2nh3ratio when nh3 is not defined?
Switch off codep in this case?

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th June 2021, Peter

Emissions new format upgrades:
.- Can read units with "-1" instead of "/", as in "kg m-2 s-1"
.- Moved the calls, so that it can define SECTORS.
.- For daily and hourly periodicity can set
Emis_sourceFiles(1)%timevalidity = 'start'
if the time corresponds to the start of the period.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th June 2021, Peter

Much faster reading og netcdf emissions in new format.
(down from hours to seconds for file with all countries and sectors!)
Open the file took all the time. Now it is done only once per file instead
of once per variable.

"if" -> "case"  in emissions new format (should not affect functionality)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th June 2021, Dave

Small bug in NMHC output fixed: TERPO2 removed from NMVOC group (SHL species
  cannot be used in group output, so no RO2 species can be included. Their
   concentrations should be very small though.)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th June 2021, Peter

Bug in the LocalFractions "pm25_new": was not working properly if other species
than pm25 where also included.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th June 2021, Dave

NAME changes:
  ZCM_EmChem19rnr  renamed to ZCM_EmChem19r
  ZCM_EmChem19rnrp renamed to ZCM_EmChem19rp

Consistent NMVOC, and without PAN, MPAN in NMVOC_GROUP:
  ZCM_EmChem19r, ZCM_EmChem19rp, ZCM_EmChem19a, ZCM_EmChem19p

DryDep_mod, Config_module

  - added USES%NO2_COMPENSATION_PT to mimic old behaviour if SOILNOX=F.
    Only for testing, and will be removed soon!

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th June 2021, Peter

Makefile adapted for Betzy

EmisGet_mod: changed tmp_emisfrac from automatic to allocatable array, because
otherwise the code crashes on Betzy, with segmentation error (!?).
(netCDF/4.7.4-iimpi-2020b)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd June 2021, Peter/Arjo

Gridded hourly timefactors.
Config setting should be of format for example:
hourly_emisfac(1)%file = 'Emis-hfactorYYYYMMDD.nc',
hourly_emisfac(1)%cdfname = 'NOx_emis_factor',
hourly_emisfac(1)%poll = 'nox',

hourly_emisfac(2)%file = 'Emis-hfactorYYYYMMDD.nc',
hourly_emisfac(2)%cdfname = 'PM_emis_factor',
hourly_emisfac(2)%poll = 'pm25',

and the file must have 24 records starting from 00:00

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd June 2021, Peter

LocalFractions for pm25:
Now treats the pm25 "chemistry" (new->age) exactly by default.
The pm25 are then divided into two groups, new species and the remainder.
The cost is then only twice (was seven times when each species
needed to be treated separatly and needed to sum then in the postprocessing)

The non-chemistry pm25, can be required by requiring the "pm25_tot" species
(useful it one does not want to pay twice the price, and accept the small
differences).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th May 2021, Dave
RE-TAG: rv4.42

ZCM_EmChem19rnrp added - same as EmChem19rnr below, but with Pollen too.

On DataDir, ZCM_DIRS/ZCM_EmChem19/emissplits_gnfr/CAMS-REG-AP_v4_2_yr2017_REF2_1
  was copied to rnr-suffixed: CAMS-REG-AP_v4_2_yr2017_REF2_1 _rnr, to make it
  clear that ony EmChem19rnr type chem schemes can be used.
  Will delete non-suffixed version after some days.


config_emep.nml updated to reflect this change

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th May 2021, Dave
NEW TAG: rv4.42


ZCM_EmChem19a -   Update: CM_ChemGroups now has NMVOC, NMHC groups.
                          NMVOC species removed.

ZCM_EmChem19rnr added - has Res and nonRes species (e.g. POM_f_Res, POM_f_nonRes),
                        which are basically tracers of GNFR C emissions.
                        CM_ChemGroups: now has NMVOC, NMHC groups, from EmChem19a

config_emep.nml - added commented out link to Ref 2.1 with Res/nonRes emissions,
                  under ZCMDIR/emissplits_gnfr/CAMS-REG-AP_v4_2_yr2017_REF2_1

Config_module - added PBL outout to RunLog outputs

utils/Rd_csvsites.f90 - bug fix

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th May 2021, Anna
BoundaryConditions_mod.f90: Updated with 2019 Mace Head

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th May 2021, Peter

LocalFractions: Updated conversion rate index for EC_old->EC_new

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th May 2021, Dave/Peter/Agnes

1. SOILNOx emissions system improved (gridded 3h steps), and simplified to just:

  USES%SOILNOx            ! T or F
  USES%SOILNOx_METHOD     ! Total, NoFert, Zaehle2011, or OLD_EURO
  soilnox_emission_File   ! cams81 or Zaehle files

  Changes in:
    Biogenics_mod
    Config_module
    Emissions_mod
    NetCDF_mod

2. config_emep.nml

  Simpler system started. The complex bit involving emissions, domain,
   soil-NOx is now at the top, and needs user-decisions. Many other
   settings removed if the defaults are fine. Comments/suggestions welcome
   for further improvements.

  GridValues_mod, emep_Main: commented out set_EuropeanAndGlobal_Config

3. Volcano files updated in Config_module:

   volcano_emission.csv_20210525, volcano_location.csv_20210525


4. TRONKz is now TROENKz, = default (renamed after Troen ;-)

  BLPhysics
  Config_module
  config_emep.nml

5. NEW FILE: GravSettling_mod.f90: Code added as EXPERIMENTAL ONLY. Do not use yet.

  Affects:
    Makefile.SRCS
    Config_module.f90 - USES%GRAVSET = .false.
    PhyChem_mod.f90 - calls grav settling if USES%GRAVSET

6. Small tidy-ups:
     AeroFunctions_mod, Setup_1d_mod

7. IAM_CROP added to LandInputs_May2021 files and config_emep.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st May 2021, Dave
NEW TAG: rv4.41

1. AeroFunctions_mod, SeaSalt_mod, Setup_1d_mod:

   Merged WetRad calcs into GerberWetRad, and added RH limits for different PM types.
   Simplified tab to 2 pm types.
   (changes results a little, but mainly pmH2O)

2. Changed default config options

 Config_module:
  Defaults changed:
    TIMEZONEMAP      = .true.
    SEASALT_fFrac = 0.5

  Removed: SURF_AREA_RHLIMITS

 config_emep.nml
  Removed: SURF_AREA_RHLIMITS completely

3. fracPM25 now changed to use LogNormFrac below. Reduced from 27% to 13%, so
   small reduction in PM25, but only really affects NO3_c

4. Log.changes - added Soil NOx comments to IMPORTANT NOTES above

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20th May 2021, Dave

Biogenic_mod:  small additions to help printouts
Config_module: small additions to help testing
Derived_mod: added fPMc_specs NO3 test line
SeaSalt_mod: small tidy p and added Andreas ref (from Svetlana)
SubMet_mod: added use of PBL%NEUTRAL_USTAR_START for SEI testing
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th May 2021, Peter/Dave

SoilNox in the GLOBAL_SOILNOX case were counted twice, once in setup_1d and
once in setup_bio! The SoilNox from setup_1d is now removed.

SoilNox in the GLOBAL_SOILNOX case are now read/converted into molecules/m2/s
instead of molecules/cm3/s as before, then converted into molecules/cm3/s in
setup_bio.

Also moved the sumation of emissions into a new routine sum_rcemis, so that it
contains also the emission set by setup_bio

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th May 2021, Dave

Timefactors_mod, config_emep.nml

  bug fix on use of MonthlyFacBasis. ALL NEEDS CLEARER/SAFER system.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th May 2021, Dave/Svetlana

SeaSalt, SoilNOx, Emissions changes

1. Sea-Salt:

 Config_mod, SeaSalt_mod

  USES%SEASALT_fFrac  added to split 7th emission mode into fine & coarse
  Set to zero to captyure "old" method. New default will be 0.5
  Also, git didn't like the  in Mrtenson, so I used aa instead. (From
  some Windows encoding maybe?)

2. SoilNOx:

 This is COMPLICATED. CAMS81_SOILNOX provides monthly soil NOx from 4
 types of emissions source, of which one of fertilizer-induced. Such
 emissions are included in some inventories (EMEP!, ECLIPSEv6), but not
 others (CAMS_REG_ANT, ECLIPSEv5). Thus, the user needs to know and set
 properly!

 Config_mod, Emissions_mod

  USES%SOILNOX_METHOD - needs user decision!
    CAMS_NoFert  - for EMEP, ECLIPSEv6
    NOTSET       - ok for CAMS_REG_ANT, ECLIPSEv5

  (will likely change NOTSET to "wFert" for these latter emissions, to force
   the user to make a choice.)

 Emissions_mod
   Use of USES%SOILNOX_METHOD to get either all CAMS81 emissions or just
   the non-Fertilizer ones.

3. MonthlyFactors

 Config_mod, Timefactors.f90

  1. New ECLIPSE-based MonthlyFac files created and stored on DataDir
  2. MonthlyFacBasis added to Config system. Set as GENEMIS for "old"
     MonthlyFacs, or "ECLIPSE" for new.
  3. MonthlyFacBasis is used in  Timefactors to prevent summer/winter
    ratio scaling for ECLIPSE case. (The GENEMIS data were from 1994,
    so needed scaling to get to year 2000-ish ratios. ECLIPSE data should
    not be scaled like this.

4. EmisDef_mod

    made SNAP8 height index same as for GNFR - giving more elevated ship
    (+train/plane!) emissions



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th May 2021, Peter

Bug in DryDep for treatment of vg_eff. Sub(0)%Vg_eff was not properly initialized.
There is an initialization in CellMet_mod.f90, Sub(:)          = ResetSub
However ResetSub does not explicitely set value of Vg_eff. However since ResetSub
is defined by compiler, it is likely to be zero(?).
I did not notice any change in results.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th May 2021, Dave
NEW MODULE: Io_RunLog_mod.f90

Simple move of PrintLog routine from the Io_Progs_mod, to avoid
circularity problems in some other modules, plus addition of logtxt
variable to help internal-write usage in calling routines. (Io_Progs_mod
had grown beyond its intended simple routines, and all the dependencies
were causing problems.

Changes in all modules that had "use Io_Progs_mod" for PrintLog.

Most code changes in GridValues:

  adding output of USES%CAMS81_SOILNOx and PFT_MAPS to final settings.
  use of logtxt for internal-writes before call to PrintLog

Plus PrintLog commented out in Io_Progs_mod.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th May 2021, Dave
NEW TAG: rv4.40

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th May 2021, Peter

Accept 2m relative humidity (rh2m) from meteo files in both % and fraction units.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th May 2021, Dave

EmisDef_mod - now shipping emissions in bottom 2 layers, 20:80%. SMALL CHANGE in
results (near shipping lanes or rivers only)

Emissions_mod - cleaner soil NO debug

GridValues_mod: added CAMS81_SOILNOx override here

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th May 2021, Peter

Different treatment of accumulated precipitation for AROME.
The meteo2021MMDD_00.nc restarted the accumulation of precipitation at midnight.
New treatment use the metdata precipitaion directly if "negative precipitations"
are found, i.e. restart accumulation from zero.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4rd May 2021, Anna 6 Alvaro

Add mugwort poillen for CAMS50 U4

- implement mugwort pollen on Pollen_const_mod and Pollen_mod
- add 5 mugwort pollen tracers to ZCM_EmChem19p
- small changes to Biogenics_mod and Derived_mod

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd May 2021, Peter

Print out also height in meters of model levels

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th April 2021, Michael/Peter/Dave

GNFR_H, Aviation, are now outputted into a new vertical distribution, with
50% below 50 m, and the rest evenly distributed up to 1106 m.

The Emission heights levels are now defined in meters, and the default levels
are rounded to zero decimals:
     Emis level    1         20.0 m      101085.0 Pa
     Emis level    2         50.0 m      100725.8 Pa
     Emis level    3         92.0 m      100224.7 Pa
     Emis level    4        184.0 m       99134.0 Pa
     Emis level    5        324.0 m       97492.8 Pa
     Emis level    6        522.0 m       95209.3 Pa
     Emis level    7        781.0 m       92287.8 Pa
     Emis level    8       1106.0 m       88725.0 Pa

NB: those will slightly change concentrations (but not total emission columns)!

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th April 2021, Michael/Peter

New aircraft emission default:
DataDir/Emis_CAMS_GLOB_AIR/CAMS-GLOB-AIR_v1.1_nox_YYYY.nc'

The emissions in the lowest flight level are set to zero, and the next lowest
flight level are multiplied by 0.5.
This can be steered by
USES%zero_below3000ft  = F,
or
USES%zero_below3000ft  = T, !default

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th April 2021, Michael/Dave

New DMS methods and input introduced:

Config_module, config_emep.nml:
   Added DMS_t to allow change between new and old (DMS%KzNew, DMS%ScNew)
   DMS%FileFound replaces OCEAN_DMS_FOUND

Emissions_mod, MassBudget_mod - use of DMS%FileFound
Setup_1d_mod: New equations added

RESULTS WILL CHANGE with new defaults. Use KzNew=F, ScNew=F, emis from DMS.nc
 to retrieve old system.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th April 2021, Peter

Defined the old split mapping for SNAP predefined.
More security checks.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th April 2021, Peter

Corrected incompatibilities with the emissions in "new format"

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th April 2021, Peter

Big bug in aircraft emissions: they were 1000000 times too small.
Has been wrong for at least 12 years.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th April 2021, Dave

Added pmH2O outputs from from Gerber system, and added USES%SURF_AREA_RHLIMITS
to restrict RH range of Gerber cals to goven RH (in %). Use of -1 (default) or 100
equivalent to current system, but will need changing soon!

** PROBLEM identified: coarse sea-salt can generate enormous (>1000 ug/m3)
  pmH2O at 100% RH.  Need to decide if 98 or 99% will be best thresholds.

AeroFunctions: modified self_test and some QUERY comments
ChemFields_mod: use now pmH2Ogb for Gerber water for f and c (LIMAX*LJMAX*2)
Config_module: Added SURF_AREA_RHLIMITS  = -1; will be set to 98 or 99 soon!
Setup_1d_mod:  use and output of pmH2O and USES%SURF_AREA_RHLIMITS. Also tidy up
               and one QUERY added.
config_emep.nml - added pmH2O outputs

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th April 2021, Peter

More fundamental definitions of the "special sectors": DOM, POW, TRAF, IND

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th April 2021, Peter

Emission height can be given in meters.
gfortran compatibility.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23rd April 2021, Peter

Changes to allow reading of the CAMS aircraft nox emission files.
Now all input file go through a keyword replacement for YYYY

Allow cdfnames in SECTORS for fraction format (neede if mixing sectors?)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22nd April 2021, Dave

Enabled CAMS81 soil NOx for testing. Not yet default, but can be enabled with
  config settings:

 config_emep.nml - added explicit:
  !UNCOMMENT for new CAMS81 SOILNOX
  !  USES%EURO_SOILNOX = F,
  !  USES%GLOBAL_SOILNOX = T,
  !  USES%CAMS81_SOILNOX = T,
  !  USES%SOILNOX = T,

IMPORTANT: Careful with above. More safety checks will be added in future, and USES%EURO_SOILNOX

Biogenics_mod - added hourlySoilFac for global SOILNOx

Config_module - added nox_emission_cams81File: DataDir/cams81_monthly_SoilEmissions_v2.2_GLOBAL05_2000_2018.nc'
  code is basically a copy of nox_emission_1996_2005File

Emissions_mod - added USES%CAMS81_SOILNOX section. Similar to previous global treatment

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st April 2021, Peter
NEW TAG: rv4.39

Heavy refactoring of the sectors setups.
GNFR_CAMS is now the default normally. Although the "SECTOR_NAME" is removed
from code, since it is open to really mix sectors if one wants (i.e. without
necessarily mapping sectors to either SNAP or GNFR).
One can easily add new sectors through config_emep.nml, see documentation.

The EmisHeights.txt file is removed, now included in the code. It can also be
set in config_emep.nml, see documentation.

Although a lot has changed, the results should be the same, if used correctly.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th April 2021, Peter, Massimo

Bug: tag for mpi could overflow. The mpi tag has a max value which is guaranteed
to be at least 32767, but is in practice much larger (millions). Some installation
had max set to 524287, and then if lots of things are outputted (for example nesting
hourly), this could get too large, and the code crashes.

Also removed some unused "include mpif.h", and put a default case in Makefile
for gfortran installations (ubuntu etc.).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th April 2021, Dave

VerticalDiffusion_mod.f90 - NEW - vertdiffn and other (older) diffusion codes
   extracted from Advection_mod.f90.

Changes in:

 Advection_mod.f90
 Debug_module.f90  (DEBUG%VERT_DIFF)
 Makefile.SRCS

Also, small changes in
 Solver.f90 - more output for testing time-steps

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th April 2021, Alvaro

Add USES%NO_3DPRECIP option to ignore 3D precipitation fields.
The model will use 2D precipitations even if the meteorology has 3D fields.
This option is meant to emulate operational IFS meteorology (used on CAMS50/71 forecasts),
which does not have 3D precipitation fields.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23th March 2021, Heiko

fix ColumnSource do-loop compatibility with gcc

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th March 2021, Heiko

Fix PreADV in ColumnSource, which gave up to 2x more emissions than asked for

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th March 2021, Peter

Error message when wrong sector is used in emissplit-special.

Added "if(DEBUG%SETUP_1DCHEM) to some debug printouts.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th March 2021, Dave

1. Default MonthlyFacFile now DataDir/Timefactors/MonthlyFacs_eclipse_V6b_snap_xJun2012/MonthlyFacs.POL

   - which merges non-European facrors derived fro ECLIPSE6b with European from Jun2012

2.  Timezone handling improved - uses Monthly_timezoneFile =
   'DataDir/Timefactors/monthly_timezones_GLOBAL05.nc'

  USES%TIMEZONEMAP       = T,

Sets "proper" timezones for countries which have -100 flag. Also takes care of
summer time for e.g. Europe for all countries.

Changes in:
  Config_module
  EmisGet_mod
  Emissions_mod
  Timefactors_mod

Also commented out some debug code in Met_mod: was failing when make DEBUG=yes was used.

RESULTS WILL CHANGE, hence rv4_38

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th March 2021, Peter

Typo for SplitSpecialsFile in config_emep.nml, did not exist!


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th March 2021, Peter

WRF met fix: the North pole had wrong mapping factor in lon-lat.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th March 2021, Dave

AeroFunctions.f90
  Added rho_gcm3 optional argument to  LogNormFracBelow function.
  Also modified TSTEMX bit to just call "self_test_fracs" for now,
  while exloring these functions.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th Feb 2021, Dave

Met_mod, Config_mod:

Small modification for PBL%KzMethod: use "Mixed" and not "-"  to get previous
default. This is to avoid incorrect names (e.g. "TR") dropping through the
if-tests without the user being aware. Now, anything which isn't defined
results in a call to StopAll.

Also recoded this section to use select case PBL%KzMethod rather than
if-tests. (Seemed neater.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th Feb 2021, Dave

Moved various PBL param definitions from BLPhysics to Config_mod PBL type:
  NWP_Kz, USE_MIN_Kz, KzMethod, UnstableKzMethod, StableKzMethod


Debug_mod: more variables moved from _XXX to %XXX system: BL, Kz, EMISTIMEFACS
           -> changes in Config_mod, Emissions_mod, Timefactors_mod,

NetCDF_mod - reduced printout from all nodes

(MOVING towards rv4.38, which will have Qing+Bruce's Troen as default)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th Feb 2021, Qing, Bruce

New KzMethod TRONKz and SILAMKz. TRONKz is used as new default.
You can set KzMethod="TRONKz" in BLPhysics_mod.f90.
Previous default is KzMethod="--" (different KzMethod in stable and unstable conditions).

New HmixMethod default JcRb_t2m, based on JcRb HmixMethod but change the formulation of the stable condition.
You can set HmixMethod = "JcRb_t2m" in Config_module.f90.
Previous default is HmixMethod = "JcRb".

New HmixMethod JcRb_surfT is also available in the code but commented out, as surface/skin temperature is not always in met files.
When surface/skin temperature is available, it should replace JcRb_t2m.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th Feb 2021, Dave
rv4_37, since results are different to rv4_36

Completed removal if Idurect usage. Used Grid%zen instead. Used !F21 label
to indicate changes for now. Will clean up another day

  CellMet_mod
  DryDep_mod
  LocalVariables_mod
  PhyChem_mod
  Rsurface_mod
  Setup_1d_mod
  StoFlux_mod

Also:

  Met_mod - added printCDF output of Topo file:

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9 Feb 2021, Dave

RESULTS changing!! Will change tag soon!

1. Changes which modify results a little!
   - remove calc of Idirect, Idiffuse, and use coszen to define daylight. Completes
     moved to WiessNorman

 Changes in: PhyChem, Rsurface_mod

vpd calculations :
  rh2m (from NWP) now used in deposition calculations, instead of latent heat calculation
  Simplifies the code, and seems more consistent with use of T2m from NWP,
  and as we have only grid-average LE to work with.
  Added USES%RH_FROM_NWP in Config_mod for this.

 Changes in: Config_mod, Submet_mod

2. Other changes:

MIN_USTAR_LAND (default 0.1 m/s) moved from BLPhysics to PBL% in Config
 changed hard-coded Grid%ustar to min 0.1 in CellMet to PBL%MIN_USTAR_LAND  also.
 CHECK later if sea-values affected by this?

 Changes in: BLPhysics_mod, CellMet_mod, Met_mod

Derived_mod:
  Added CloudFrac possibility, though using  quck n dirty MISC method

Smaller changes:
  config_emep.nml -  fixed some comment lines for DEBUG
  DryDep_mod - tidied debug output
  Io_Progs - added "afmt" option to datewrite as optional argument. Still
   needs work, but doesn't affect previous usage.
  LandDefs - longer name and code strings
  Landuse_mod - more debug output (for SEI)
  Radiation_mod - changed comment
  Setup_1d_mod - removed ancient "use" for S_RiemnerN2O5
  StoFlux_mod - more debug, using new afmt flag to datewrite.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th Dec 2020, Peter, Alvaro

Two bugs in Timefactors in reading hourly factors.
The "inputline" was only 200 char long, and if this is exceeeded (which can
be when writing 24 real numbers) the last timefactors would be set to zero.
The normalization of the factors for daynumber zero (all) was only normalizing
Monday.

Also updated so that it can handle N_TFAC/=11.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st Nov 2020, Peter, Massimo,

In specific cases the interpolation in ReadField_CDF fails.
So far the only case found was a 0.011x0.011 degree latlon grid, when DMS
(1 degree grid) is interpolated ("conservative" interpolation),
the rightmost part of the domain was showing zero emissions of DMS.
(Happens when the left side of a DMS gridcell is outside the domain and
the right side is outside the local subdomain)
Fixed now.

Also small optimization of LF

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th Nov 2020, Dave/Robert

Added two new chemical scheme directories for testing:

  ZCM_EmChem19X-vbs     = expanded EmChem19a scheme
  ZCM_CRIv2R5Em-vbs     = CRI-based scheme

(Robert is working on the documentation paper for these.)

Setup_1d_mod.f90 - safer Rn222 treatment, and source of emissions documented

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th Nov 2020, Peter

Total per countries *and* sectors outputted if
      SecEmisTotalsWanted = T,
in config_emep.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th Nov 2020, Peter

Can set lf_src(1)%name to set the name of the local fractions, as they appear
in oputput

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th Nov 2020, Peter

Upgrade of local fractions. The size of the sources around the receptor cells
can be set in config with
lf_src(1)%res = 5 ! sources are squares of size 5x5 gridcells
Name of file is now Base_LF_full.nc
uEMEP_GUI.py is now LF_GUI.py and can show the different source sizes
(but position can be shifted by up to n-1 gridcells, where n is size of source!)

set make_fracsum to get fracsums for that source:
lf_src(1)%make_fracsum=T,

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th Oct 2020, Dave

EmChem19a, EmChem19p - chemistry updated to match GenChem v1.0

Changes are small, mainly due to re-ordering, but with:

  pNO3 replacing TNO3 for NO3_f + NO3_c
  skipping terpPeroxy in latest code.
  new style csv files for emissplits for EmChem19a

tag updated to rv4_36, prior to Oct 2020 OS
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23rd Oct 2020, Dave/Peter

Sites_mod:
     Tightened checks for "Coords" KeyValue.
     Can now have LatLonKdown, LatLonZm, LatLonHrel or IJKdown.
     Older LatLong option will now crash with error message.

     Much use of new DEBUG%SITE to reduce excessive outputs
     Hmix out now enabled

config_emep.nml added Hmix and other outputs for Sites D2D usage

Config_mod:
   EFFECTIVE_RESISTANCE now set true. (It was accidentally true anyway!)

Debug_mod: Added DEBUG%SITE to give site name (or part of name)

DryDep_mod:
   Bug-fix: EFFECTIVE_RESISTANCE was effectively set true by default.
   logic now corrected, but will set .true. in Config_mod. Tests show
   that effects are only small so far.

SmallUtils_mod:
   Started to  add more debug to investibate str_replace.

Also: DataDir/sitesLL.dat and sondesLL.dat copied to sitesLLKD.dat and sondesLLKD.dat
 and Coord names updated.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22th Oct 2020, Robert

Changed NO3 photolysis for mechanisms including IDNO3_NO and/or IDNO3_NO2 (e.g. CRIv2R5Em)

DefPhotolysis_mod.f90
Setting:
            rcphot(IDNO3_NO,:) = 0.127 * rcphot(IDNO3,:)
            rcphot(IDNO3_NO2,:) = 0.873 * rcphot(IDNO3,:)

The fractions 87.3% NO2-path and 12.7% NO path are based on relative photolysis speeds in MCM.

Earlier version used IDNO3_NO = IDNO3 and IDNO3_NO2 = IDNO3 (which means total NO3
photolysis was too fast and the relative fraction of NO product was too large).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20th Oct 2020, Peter, Dave

Copy pzpbl into hmix variable, and interpolate hmix in time.
When "HMIX" is asked for in output output hmix, i.e. the interpolated value.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th Oct 2020, Peter

Hourly time factors per country and species.

Usage:
In config_emep.nml
HourlyFacSpecialsFile = '/Path/My_hourlySpecials.POLL',

My_hourlySpecials.pm25:

#Example
#CC DAY SECTOR 01:00,02:00,03:00,04:00,05:00,06:00,07:00,08:00,09:00,10:00,11:00,12:00,13:00,14:00,15:00,16:00,17:00,18:00,19:00,20:00,21:00,22:00,23:00,24:00
0 0 7 1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0,1.0
60 0 7 12.0,12.0,12.0,12.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0
27 0 7 0.0,0.0,0.0,0.0,12.0,12.0,12.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14-15th Oct 2020, Dave

Sites_mod.f90:

1. New option for  VertCoords: LatLonHrel

 This builds on Peter's LatLonZ option, though now the user provides Hrel,
 the relative height in meters. The calculation of z_topo is still used
 to get the model's grid-average height, but the site is now located
 at Hrel+z_topo.

 The advantage of Hrel over Z is that the resulting mode level used
 is independent of the EMEP domain in use.  Hrel as a concept typcally
 uses height above the lowest terrain  within 5km, and so is a sub-grid
 phenomena.  This can be calculed from a digitial elevation map, or
 local knowledge.

2. More info on site location now output to sites.csv, e.g.:

 42  sites in domain  12 132   1 111 InpCoords: LatLonHrel
  1 Hours between outputs
name                                         lat     lon,    ix,    iy,    iz, z_site, ztopo
DK0012R_Risoe                           ,   55.694,   12,    48,    57,    20,    44,    41
FI0096G_Pallas_(Sammaltunturi)          ,   67.973,   24,    35,    84,    17,   628,   325

This shows the option chosed (here LatLonHrel), the lat, lon,

 output coordinates (ix,iy) are now for the output RUNDOMAIN, not the
 full-domain (meteo) coordinates previouslty output. Thus, Risoe here
 should be locaed at 48, 57 in the output Base_fullrun.nc.

 iz gives the model level used. This is calculated for LatLonZ and LatLonHrel cases.
 z_site gives the site altitude or rel. altiude as given in inputs (-9999 for LatLon case)
 ztopo  gives the grid-average altitude.

NB extra outputs for ascii outputs only.
 formatting of output still a little tricky. Long station names produce error
 (easily fixed, but then formats need tweaking.)

ToDo: Would be great to output for exact coordinate, using bilinear
 interpolation of surrounding cells. For example Birkenes is almost on
 the edge of two cells in the EECCA domain.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st Oct 2020, Peter

SitesLL.dat can give elevations in meters.
The header should mention
: Coords LatLonZ

and then all heights have to be given in meters (not allowed to mix with levels)
same filename, but recognize header
example:

# "Sites: names, locations, elevations"
# "Area: EMEP-Europe"
# "ix: x coordinate"
# "iy: y coordinate"
# "z: altitude of station in meters"
# " Some starting sites...."
# "Harestua         60.211 10.717    228.0 !Older coords "
: Units index
: Coords LatLonZ
: VertCoords EMEP
: DomainName NA
#
name ix iy lev #HEADERS
-    index index height #SKIP
#DATA:
Harestua_Obs     60.21  10.76     10.0  !Jon/RSS
Harestua_Obs18   60.21  10.76     200.0  !Jon/RSS, rel ht. 18

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th Sep 2020, Peter

emissions new format: daily timefactor for monthly emissions

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28,29th Sep 2020, Peter

Local fractions wet deposition
Local fractions for group of countries

example in config_emep.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th  August 2020, Peter

3D relative humidity available as output. in config_emep.nml add in OutputMisc a line such as:

'relative_humidity',  'MET3D', 'RH_3D', '-', 'frac', -99,  -99,   F,   1.0, T, 'YM',

(the first name can be changed: it is the variable name as it will appear in the output file)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st  August 2020, Massimo, (Peter)

 ix3Dmap(NEmis_sourcesMAX) in EmisDef_mod.f90
(was limited to 1000 and giving errors with more than 1000 sources)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st  August 2020, Anna, (Peter)

Updated compiler setting in mk.meteoPreProc into a more generic form that works
on Nebula

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th July 2020, Peter
Replace also keyword DataDir for DegreeDayFactorsFile

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th June 2020, Dave

Derived_mod: surround species%carbons with int to get voc_carbon
             unused variables removed.
NetCDF_mod: allowed longer auxL(4) texts - now TXTLEN_File
SmallUtils_mod: added dtxt and improved error message

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th June 2020, Peter, Agnes

Defined new "Country", AST  = Asian areas in the EMEP domain (CAS+ARL+ARE+ASM+ASE, 80,82,83,84,85,)
Country( IC_AST ) = cc(  "AST" ,'-', 96 ,F, 96, 96, -100  , "Asian areas in the EMEP domain" )

Allowed sum of countries for Local Fractions for
TMT = TM+TME
AST = CAS+ARL+ARE+ASM+ASE
UZT = UZ+UZE
KZT = KZ+KZE
RUE = RU+RFE+RUX

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th June 2020, Peter

Emissions new format: do not apply DegreeDay correction if the emissions are
not monthly or yearly (because daily/hourly emissions already should take those
variations into acccount).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th June 2020, Peter

Bug in LocalFraction for SO4 when concentration is zero

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th June 2020, Dave

New emissplits in SNAP system. Same data as GNFR below.
    - now part of emep-dev, in ZD_EXTRA/EMISSPLITS, but should be copied
      to DataDir/ZCMDIRS/EMISSPLITS

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th June 2020, Dave

New emissplits files added to git system for better tracking.
    - uses new .csv style (libreoffice friendly!)
    - Ref1 and Ref2 versions, to cope with condensables in PM splits
    - GNFR_CAMS (19 sector splits) provided here
    - (snap still needs work)
    - revised NMVOC from CAMS71/Robert/Dave
    - now part of emep-dev, in ZD_EXTRA/EMISSPLITS, but should be copied
      to DataDir/ZCMDIRS/EMISSPLITS

config_emep.nml - now points to new files, with .csv format.
EMISSPLITS directory added to ZD_EXTRA
ZD_EXTRA/README - modified to reflect update

Note: I will soon add SNAP versions of these. Meanwhile, if you want snap,
the older systems still work, including the non .csv format. Just make
sure config_emep.nml matches what you want.

tag updated to rv4_35, also to cover other changes since rv4_34os.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th June 2020, Peter

Changed molecular weights from MARS so that they get equal to the rest of the
code.
MWNO3  = 62.0049 -> 62.0
MWHNO3 = 63.0287 -> 63.0
MWSO4  = 96.0576 -> 96.0
MWHSO4 = MWSO4 + 1.0080 -> MWSO4 + 1.0
MH2SO4 = 98.07354 -> 98.0
MWNH3  = 17.03061 -> 17.0
MWNH4  = 18.03858 -> 18.0

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 May 2020, Peter

Reversed the change done 29 May!
removed "if ( isec>NSECTORS ) cycle"
"isec" in this context is not the model sector, but the splitfile index (1.. N_SPLIT).
It is allowed to have a different N_splits and NSECTORS.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29 May 2020, Dave, Peter

added
  if ( isec>NSECTORS ) cycle
in the EmisSplit reading routine, to allow to use GNFR13 with splits defined
for GNFR19.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29 May 2020, Dave

  ZCM_Chem19a-ECf added - for runs with just EC emissions
     No SOA, SeaSalt, Dust, PM25 etc.
     Best to switch off FOREST_FIRES; DUST; SEASALT in config.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 May 2020, Dave

  AerosolCalls - removed need for SEASALT_f. Use iSeaSalt variable to cope.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 May 2020, Anna, (Peter)

Mace Head 2018

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 May 2020, Dave

Added utils/clean_config.py script - removes trailing comments (which
  seem to cause problems with some gfortran systems).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12-13th May 2020, Peter

Safer automatic "GLOBAL_settings". Take the (approximatively) the point in the
middle of the grid in latitude direction and Easternmost in the longitudes, and
see if it is within "Europe", here defined as the square
with lon from -32 to 90 and lat from 30 to 70

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th May 2020, Peter

Bug in MARS, rpmares. We assumed that mass of NH3+NH4  (or NO3+HNO3),  is conserved
while it is only the number of molecules which is conserved.

old version:
TNH4 = MAX( 0.0, (NH3 / MWNH3 + NH4 / MWNH4)  )
TMASSNH3  = MAX(0.0, NH3 +  NH4 )

...

ANH4_High = min( YNH4 * MWNH4, TMASSNH3 )  !ASSUMES NH4 cannot be larger than TMASSNH3!!
GNH3_High = TMASSNH3   - ANH4_High  !ASSUMES ANH4 + GNH3_High (in kg) is conserved!!


Replaced two lines  with:

ANH4_High = min(  YNH4 , TNH4 )* MWNH4
GNH3_High = max(FLOOR,(TNH4 - YNH4))*MWNH3

Since the mass(NH3)=17, mass(NH4)=18, mass(NO3)=62, mass(NO3)=63, so the error
is about <6% for NH4 and <1.5% for NO3


(also some additional changes for local fractions)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th Apr 2020, Peter, Massimo

More robust sites.dat: allows to use -999 as vertical level for surface (not tested).

Small bug corrected: WriteConfig_to_RunLog was writing into "fort.7" if not MasterProc

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th Mar 2020, Peter

Renamed uEMEP_mod to LocalFractions_mod and in config use lf_src% instead of
uEMEP% to set settings.
Compatibility with old (uEMP) format is kept for input and output, if input
is in old format.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th Mar 2020, Peter

Heavy refactoring of all uEMEP parts. Backward compatibility for now.
Will allow generalization to remote fractions, land fractions, chemistry etc.
Will go over to "lf" names instead of uEMEP.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st Mar 2020, Peter

Moved EmisSet call (in PhyChem) just before runchem.
Gives identical results.
It is better to define emis just before they are used in runchem.
(this will perhaps be needed by uEMEP later)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th Mar 2020, Svetlana, (Peter)

replace in config_emep the old
  flocdef="DataDir/volcano_location.csv_20160610",
  femsdef="DataDir/volcano_emission.csv_20160610",

with more relevant
  flocdef="DataDir/volcano_location.csv_20180321",
  femsdef="DataDir/volcano_emission.csv_20190606",


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th Mar 2020, Peter

EmisDir replaced as keyword in all config names. (not tested)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th Feb 2020, Peter

Interpolation failed for GLOBAL_LAInBVOC.nc in GLOBAL05 runs.
The reason is a combination of many factors:
both grid have same resolution, but shifted by half a gridcell. The "nearest"
neighbor (zero order interpolation) is just in between two gridcells, and at
the end of the map it chose the "wrong side".
Solution: we force the index to be within range.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd Feb 2020, ????
rv4_34os tag added.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31th Jan 2020, Peter, Qing

Nesting: the number of vertical levels in the BC file is checked before each
usage. If the number of levels has changed, it reinitilializes the interpolation
parameters.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31th Jan 2020, Robert

Added missing deposition parameters for an EmChem19X species + minor update of
some (di)carbonyl dry deposition parameters

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th Jan 2020, Peter, Robert

The bug correction from 13th Dec was not done properly. (and the comment that
this only happens when the data grid does not cover the model grid was wrong;
it should be: "the bug gives error message that the data does not cover
the model grid")

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th Jan 2020, Peter

Country array was not initialized correctly (looped over NLAND, with NLAND
undefined).

nvoc was uninitialized in Derived_mod

find_index: first_only = .true. by default

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th Jan 2020, Peter

Bug in timestep for dt_advec<620 sec (grid 7km or smaller)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th Jan 2020, Peter

The SMI is also fetched using "needed" flag. (It was no longer compatible with the changes made for hmix).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th Jan 2020, Robert/Dave

Updated EmChem19a and EmChem19p

rv4_34 tag added? (before or after? Need to check)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th Jan 2020, Peter

Bug in Sec_emis output, when sector spcific output was requested.
The bug referred below 10th jan (pblh) was not well fixed. Fixed now

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th Jan 2020, Dave

ZCM_EmChem19p added  = EmChem19a + Pollen (4 species)

ZCM_EmChem19a files - slight updates.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th Jan 2020, Peter

Added "pblh" in the list of possible HMIX names. (tested on EECCA)
More robust interpolation from Polar Stereo to lat lon
(EECCA was crashing on Logan interpolation!)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th Jan 2020, Dave

StoFlux - logic improved to use night rather than daynumber to reset SumVPD etc.
          Should work better in non-European locations
          Also, hard-coded 8.0 replaced by VPDcrit

DryDep_mod  - call to Setup_StoFlux modified

RunChem_mod - DebugCell definition now separate from DEBUG%RUNCHEM

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th Jan 2020, Dave/Alvaro

ForestFire_mod - enabled use of non-essential components (eg tpmfire) through
    BBfound variable, and POSSIBLE_FINNv1p5_SPECS and POSSIBLE_GFASv1_SPECS
    arrays. Also code tidy-up.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd Jan 2020, Alvaro

Merge changes from cams50 branch. Mostly data assmimilation related.

Derived_mod: cleanup pmfine/pm10/sia indexing code
EmisGet_mod: longer errmsg buffer

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th Dec 2019, Dave, Robert
  Got rid of "Unified" in header lines! (10 years too late..)

  ZCM_CB6r2 added

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th Dec 2019, Peter

Small bug in interpolation routine: in the case of zero order interpolation,
lat lon, and the data does not cover the entire model grid, the results may
be dependent on the number of CPUs.
This does not happen with standard inputs.
Now values are set to Undef in this case. (Earlier it would take in practice a
random point within the defined values)

New emission format: the combination GNFR new emissions with SNAP sector
defintions did not work properly. Redefined gnfr2snap, where values are
negative if repeated. In loops over "all sectors" (read all sectors) only
positive values are taken, so that nothing is used twice. If values are
added (convert from gnfr to snap), the absolute value is taken.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th Dec 2019, Dave

Further CMX'ing:

ZCM_DIRS on DataDir now stores new-style files. Currently for EmChem19
   and EmChem09.

config_emep.nml - clearer text for CMX stuff. Changed default emis to
                  GNFR instead of ancient TNO, and removed ancient GLOB_05

ZCM_EmChem19a, ZCM_EmChem09

  - updated files after upper-casing groups in GenChem, and fixing Ash

MassBudgetSummary_mod: used wider field for compound name.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5-10th Dec 2019, Dave

*** GenChem upgrade :-)

The code has been modified in various places to cope with the new GenChem
system. The largest changes are:

*** NEW **
Use of text (not .inc) files for boundary and BiomassBurning now
replaces older .inc files. Main advantage is that one can simply
append series of files from different mechanisms, eg adding
basic gas-phase, sea-salt, dust, PM, as requested by the user
(via GenChem)

CMX_BoundaryConditions.txt now replaces CM_BoundaryConditions.inc, and uses
a simple mapping table of strings, e.g.

  # globBC     emep             fac  wanted
  #
    'O3      ','O3      '   ,   1.0, T
    'HNO3    ','HNO3    '   ,   1.0, T


BoundaryConditions_mod - now reads table  from CMX_BoundaryConditions
together with defBICs definitions for mapping.  Removed IBC_NO etc.

ForestFire_mod - now reads tables  from CMX_BiomassBurning files.
Some harmonisation of mapping routines for FINN and GFAS.

CMX_BiomassBurning_FINNv1p5.txt and CMX_BiomassBurning_GFASv1.txt
(stored in GenChem system) now replace older .inc files.

EmisGet - uses any_case when reading emissplit

mk.ChemFiles uses the new system.

ZCMDIR now added in config_emep.nml, Config_module.f90
(eg ZCMDIR="ZCM_EmChem19a")


ZCM_EmChem19a - updated species settings also (from Robert/ecosx).
ZCM_EmChem19  - updated species names etc
ZCM_EmChem09  - updated to CMX (for FINNv1p5 and GFASv1 anyway)

SmallUtils - added xcindex funtion to return index of substr in string
   regardless of case. (e.g. matches DUST in Dust_road.)

Biogenics_mod - small debug change

NOTE: The CMX files should be placed in the appropriate ZCMDIR (probably
on DataDir, e.g. ZCM_EmChem19). Done on stallo only so far.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd Dec 2019, Dave

USES treatment expanded to almost all USE_ variables.

Config_module:

  WriteConfig_to_RunLog routine added -
     called at end of run.  Writes out the USES settings as they
      were actually used.

  Output of full ModelConfig namelist to RunLog.out commented out.
  Could be sent elsewhere (config.out maybe?), but a RunLog of 35000 lines
  was not readable, and this did not show if USES varuables had been
  changed.

  I would prefer that we build up a tidy output of the ModelConfig, but
  it isn't obvious how to do it yet. Might just need hard-coded lines to
  print out the important information, skipping all unused or unset values.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th Nov 2019, Peter

Bug in loop for Gridded monhly factor. No consequences in pratice now, but could
be prpblematic in other configurations.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th Nov 2019, Agnes, Peter

19 sector defintions for GNFR_CAMS.
Indicate SECTORS_NAME = "GNFR_CAMS" in the emission file or in the config file.

Note that the mixing of GNFR_CAMS sectors with other sectors defintions in the
same run will not work at present.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th Nov 2019, Alvaro

Config_module, config_emep.nml:
  - EmChem19 split files by default (SplitDefaultFile/SplitDefaultFile)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th Nov 2019, Dave

Country_mod
  - new routine add_Country to simplify country inputs
  - expanded self_test to write out which EMEP codes are in-use
    (use 'mk.testX Country_mod.f90' to see the results!)
  - added extra CAMS country codes (JOR etc)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4-5 Nov 2019, Alvaro

New outputs for CAMS_50 U2 upgrade, see #168
- add ffuelECfine, woodECfine and PPM10_fire groups
- add ffire_c tracer

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1 Nov 2019, Robert

Added EmChem19a chemistry scheme -- a slightly revised version of EmChem19

Main difference: MACR is used to represent both methacrolein (MACR) and methyl
vinyl ketone (MVK).
[The first EmChem19 had both, but the treatment was a bit inconsistent]

Minor updates of reaction rates for APINENE+O3 and APINENE+OH (the second rate
was inconsistent in the previous version).

Bug fix for wet deposition parameters for gas phase fraction of VBS-species.
[previous version had WD-parameter set to PMf, which gave much more efficient
in-cloud scavenging]

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 Oct 2019, Robert

Bug (sort of) in YieldModifications_mod.f90 fixed.

The SOA yields for benzene and toluene were inconsistent with the SOA yields
for other VOCs (including OXYL) when using YieldModifications = 'VBS-T10'.

The yields for benzene and toluene were too large (based on Hodzic et al., 2016)
when including SOA aging (which is included in the "standard" model version).

If anyone for some reason want to use the old (erroneous/inconsistent) SOA yields
it can still be done by setting
YieldModifications = 'VBS-T10old'
in the config file

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22 Oct 2019, Alvaro

Fix AOD:GROUP output, see #113

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21-22 Oct 2019, Peter

Bug in ReadField_CDF. In case of emissions defined on a limited are (like TNOIII),
the left most gridcells of the emissions would not always be included.

Small cleanups:
Timestep for chemistry was buggy (crash) if dt_advec=150.
In a global run, if there are too many MPI, so that the domain cannot be cutted
in small enough pieces in the lon direction, then the lat dimension is cut in
more than two parts (which was imposed until now).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15-16 Oct 2019, Peter

New format emissions: if species in not found, it will also look for species with
other lower/upper cases
New format emissions: implemented femis in lonlat format.

Now longitudes from femislonlat can go around the entire globe (but still
cannot cross -180, if not the entire globe is included).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10 Oct 2019, Peter

Bug in setup_1d: aero_fss, aero_fdust, aero_fbc, aero_fom could be 0/0, giving
Nan in reaction rates.

kg/m2 added in Units_mod

Removed PSURF, as we already have PS which is the same.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10 Oct 2019, Alvaro

Consolidate column outputs, see #164
- Add COLUMN:SHL (MISC) output for short lived species. Only molec/cm2
- Remove xncol (USET) otputs.

Commits:
- 9a463da9: COLUMN:SHL output replaces USET/xncol, close #164
- 6e79ee8b: update XNCOL/COLUMN comments, see #164

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
07 Oct 2019, Peter

Small fixes in Makefile and uncomment EmChem19 Split in config_emep.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
04 Oct 2019, Peter

Complete deep revision of convection.
The method is now mostly rewritten and base on mixing ratios.
It does not try to keep the sigma coordinate formalism.
There were probably bugs in the old version. (subsidence counted twice? and
wrong flux limitations)

It should be stable and safe now, however the CONVECTION_FACTOR should be
redefined.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
03 Oct 2019, Dave

Landuse_mod - quick bug fix on yesterdays versions
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
02 Oct 2019, Dave

Landuse_mod - now OK to specify just one LandCoverInputs%Mapfile
            - small tidy-up

LandDefs_mod - better debug info, tidy-up.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 Sep 2019, Peter, Alvaro

Bug in nesting: the last record was saved twice.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 Sep 2019, Peter, Svetlana

When a new variable 'ps' is defined by user, it can mess with the 'PS' already defined,
see Issue #160. Now the variable is first looked for with case sensitive search,
then case insensitive if not found.

Bug in find_index: any_case=.true. and any_case=.false. had same effect, since
only presence was tested.

New output: pressure_3D. for 3D pressure output set for instance in config:
      'pressure'      ,'hPa', '3d','pressure_3D' ,'MISC' ,'YMD',


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25 Sep 2019, Peter, Agnes

The pollName restrictions for emission was not working correctly (worked only
if "sox" was among pollNames!).

The bugfix had implications for the "non fraction" cases, and it has not been
tested for that cases.
(The hope is that this all get deleted once the new formats take over :) )

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14 Sep 2019, Dave

Derived_mod - BUG fix on column calculations of OM25. Now  avoids ik=1, and
               applies Fgas also for ik != 0

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 Sep 2019, Dave

Config_module - enabled use of DataDir  as part of OwnInputDir

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13 July 2019, Robert

Bug fix -- Derived_mod.f90

           Earlier version (from 30 May?) store erroneous (too large)
           concentrations when using the unit ugC_PM (e.g. for storing total
           particulate OC-concentrations or BSOA (BSOC) in ug C / m3). The
           gas-phase fractions of semi-volatile OC were included.
           Total OM was ok (if stored using ug_PM).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25 June 2019, Dave

Just cleaning:
  Derived_mod - cut down outputs of HORIZ_LINE plus more dtxt
  GasParticle_Coeffs - small output changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24 June 2019, Peter

Bug in Emission new formats. Periodicity not read correctly from file
Effect is that no timefactor is applied for those emissions.
(Note that it will be correct if periodicity is read form config).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24 June 2019, Dave

Just removed some DS comments. Left some too for the future: reminder of to-do
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13 June 2019, Peter & Alvaro

Case insensitive Nest variable mappings for IC/BC files
- find_icbc (Nest_mod) is now case insensitive
- set_extbic_id (ExternalBICs_mod) is now case insensitive
- adv_bc%found and adv_ic%found computed independently,
  also when no extrenal bc are used

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12 June 2019, Peter, Dave

USES%MonthlyNH3 set to 'LOTOS' automatically when european and not global grid
is detected.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
07 JUne 2019, Dave/Robert

ZCM_EmChem19 introduced. (EmChem16ziVBS2012 in RB's testing system)
This scheme has been thoroughly tested against MCM and performs better
in box model tests than EmChem16. (Differences will be smaller in emepctm.)

To use:

1. Compile:
   mk.ChemFiles EmChem19
   make clean
   make

2. Make sure that DataDir has an emissplit directory ZCM_EmChem19 on DataDir (exists
   on vilje and stallo 7th June).

3. Edit config_emep.nml - uncomment the "Split" lines to point to that directory

4. Run, and check ;-)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
06 June 2019, Svetlana (Peter)

"PM_coarse" in Derived_mod and
'SURF_ug_PM_coarse'   ,'ug' ,'2d','PM_coarse' ,'MISC','YMD',
in config_emep.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
06 June 2019, Anna (Peter)

Mace Head correction for 2017

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
06 June 2019, Peter

femis: allow country_ISO instead of code in femis, with keyword 'Country'
(or 'country' or 'Country_ISO').
Example of femis:

Name       sec     sox   nox   voc   nh3  co   pm25 pmco
Country  DE 0      0.0   1.0   1.0   1.0  1.0   1.0  1.0

Will stop cleanly if the country is not recognized.
(Can be combined with lines in other formats)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
06 June 2019, Dave

IMPORTANT (for PODs):

  DO3SE_mod - bug fix on PAR enabled (keep OLDBUG fflag for comprisons)

Convenience:
  Derived_mod - changed HORIZ_LINE to avoid f2003 new_line
  SmallUtils_mod - added (back) str_replace.  I find it more intuitive than key2str.


REVERTED HERE
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30 May 2019, Dave

rv4_33beta tag started ... results will change over coming days...


Derived_mod - calls Reset_3dOrganic to harmonise OM25_p and SURF_ugPM_OM25
              Fixes problem found by Hilde that OM25_p >= ugPM_OM25, by
              more conistent cfac usage, and now produces mixed-phase
              outputs if ug_PM not specified.
              All very messy though, and old semivol usage not working so
              well. Should consider getting rid of OM25_p.

              Also more dtxt, changed 'index' to 'ind' (index is a fortran
              function, so good to avoid).

              Thus, PM results CHANGE (not drastically though)

              (Could do with a little more testing.)

SOA_mod.f90 - added Reset_3dOrganic to harmonise OM25_p and SURF_ugPM_OM25
              before Derived outouts are calculated.
              Also tidy up and more dtxt

Units_mod.f90 - some dtxt added


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30 May 2019, Dave

rv4_32 tag added

Results will start to change after this ...

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 May 2019, Svetlana, (Peter)

EQSAM equlibrium for PM water can be chose by config:
AERO%EQUILIB_WATER    = 'EQSAM'
AERO%EQUILIB          = 'EQSAM'

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24 May 2019, Peter

Removed ZD_OZONE/My_Ouputs
Content moved to Sites_mod and Config_module.f90
Sondes and sites species can be defined in config_emep.nml
(see example)
It should be compatible with different Chemical schemes in the sense
that unexisting species are accepted, but not outputted.
All the "extras" are still hardcoded in Config_module.
It was heavy to refactorize, because arrays are "merged" and everything was
hardcoded.
It would be good to simplify the multitude of arrays
(SITE_SHL,SITE_ADV, XTRA_SITE_MISC, XTRA_SITE_D2D, etc..)
Also merge with normal outputs would simplify (could simply have a new flag in our output).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 May 2019, Dave

CellMet_mod - adding dtxt and tidy-up

Debug_mod - made DEBUG%SUBMET as integer, allowing eg dbg for iL==2
            (deleted DEBUG_SUBMET)

GridValulues - more dtxt and output. Replace me==0 by MasterProc: ie emep-style ;-)

SubMet_mod - use DEBUG%SUBMET and tidy-up

ZD_OZONE/My_Outputs - corrected BIOTERP to TERP

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 May 2019, Alvaro

remove old style hourly output (My_Outputs_mod), see #142

Config_module, NetCDF_mod, PhyChem_mod, Sites_mod, TimeDate_ExtraUtil_mod, config_*.nml:
- remove IOU_HOUR_EXTRA and IOU_HOUR_EXTRA_MEAN
- remove MY_OUTPUTS and SELECT_LEVELS_HOURLY

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 May 2019, Dave

ForestFire_mod - fixed some output formats wehn debug activated

utils/Rd_csvsites.f90 - re-coded to cope with comma in new date, hh format
 (Should update python version too!)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22 May 2019, Dave

Config_module:

   - moved ExtraConfig replacements (key2str) later in Config, so that
      DataDir is set correctly. (See EEEEEE bits)
   - added LAST_CONFIG_LINE - a variable which can be added to the end of
      configs (or actually anywhere), to allow the user to check that
      the full config was actually read.
      (Very useful if also debugging use of ExtraConfig)
   - added associate_File usage for NEST_MET_inner, to allow DataDir

PhyChem_mod - added units to PAR

My_Outputs_mod: added use of find_duplicates
                started correction of met outputs (Bosco-inspired)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21 May 2019, Dave

Smal tidy-ups and helper code

Biogenics_mod      - tidy up

Config_module      - added logtxt to write out USE_SOILNOx settings

DO3SE_mod          - added BUGGY to highlight current bug.
                     *** FIX before release (->rv4.33)
                     plus tidy up

DryDep_mod         - tidy up

GridValues_mod     - added fname to error message (it helps!)

LocalVariables_mod - added units to PAR

Rsurface_mod       - tidy up

Sites_mod          - tidy up and init of site_gindex, sonde_gindex
                     PLUS - added comma in asci output between date and hh
                     (more libreoffice calc friendly)

SmallUtils_mod     - added find_duplicates routine

Solver_mod         - tidy up

StoFlux_mod        - tidy up (Massimo's query inspired). FOUND BUG - for global
  runs - should change reset to reflect local time, not jd.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20 May 2019, Peter

Nest options have changed. The "OUTDATE_NDUMP" is now decoupled from the "MODE"
options and both can be used simultaneously.

The "NEST_outdate" option (dump at given dates) is now chosen by:
1) Setting NEST_OUTDATE_NDUMP to the number of dates wanted (max 4).
2) Setting the firsts NEST_outdate accordingly
For example:
  NEST_OUTDATE_NDUMP = 2,          ! dump (save) 2 dates (max 4)
  NEST_outdate(1)= 2016,1,1,3,0    ! first date to save
  NEST_outdate(2)= 2016,1,1,7,0    ! second date to save

The filename for the dumps can be defined in NEST_template_dump.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18 May 2019, Peter

Small bug in emis printout.
StoFlux_mod first_call set to false after first call.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 May 2019, Peter

New format emissions: automatic GNFR/SNAP sectors mapping.
SNAP is default. If sectors in an emission file are defined as GNFR (values
from 1 to 13), it should have an attribute sectorsName= 'GNFRsectors'
(or it can be set in config file)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 May 2019, Robert/Dave

GasParticleCoeffs_mod:
  Added more surrogates, based upon R151A

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 May 2019, Peter

Emissions by countries in new format are printed out.
(Only first call, and only species which are one of the splitted standard emissions)
Country and sector as global attribute also enabled.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14 May 2019, Dave
Setup_1d_mod - small tidy up
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14 May 2019, Peter

INDI_BIHA had a value for the timefac_code_hourly of -289(!) must be 289 and
timezone=100 instead of -100.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14 May 2019, Dave

Derived_mod: SIA25 added, for 2d and 3d.
             plus small tidy-up

config_emep.nml - added example SIA25 lines

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10 May 2019, Peter

Nest stops if Met_inner not found (was only a warning before)

uEMEP: local fraction "completeness" diagnostic. Outputs a value for each
gridcell that sums all the local fractions. 1.0-> all sources have been found.

new format emissions: accept unit kt (and kt/year, kt/m2, kt/m2/year/).
and corrected bug when units where mg/s or mg/m2/s (were factor 1000 too small)

number of vertical levels in meteo file are checked each time a new meteofile
is read. If it has changed (happens in CAMS?), the vertical interpolations coefficients are recalculated.
Maybe a bug when not starting the run at hour=0 corrected (nrec was set to 1 at first call in meteoread)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7-9 May 2019, Alvaro

Add CheckStop_real2 to compare reals to machine precision

Support IC/BCs from older model versions
Nest_mod will try upper case variables name when the variable is not found

Update pollen mopules
- add EmChem09cwf (EmChem09 w/pollen)
- update pollen modules from cams50
- fix pollen dependency on Config_module (previously Nest_mod)
- fix pollen dependency on GasParticleCoeffs_mod
- add pollen spcs to DD_t
- add pollen spcs to EMIS_BioNat

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7-8 May 2019, Peter

Renamed ModelConstants_config -> Model_config

Merged nest and external_bic config into ModelConstants_config.
Most nest config variables renamed with a "NEST_" in front of variable.
Some cleaning for consistency.
Did *not* merge ExternalBICs_bc config

Also OutputConcs_config, OutputDep_config and OutputSize_config are now
part of  Model_config

Removed OutputMisc_config from config_emep.nml, as I could not see it was used.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6 May 2019, Peter

Merged Columns and ForestFire config namelists into ModelConstants_config
NB: some BB variables have changed name:
MODE->BBMODE
need_file->BBneed_file
need_date->BBneed_date
need_poll->BBneed_poll
verbose->BBverbose

Allow to include additonal namelist files. Example:
ExtraConfigFile(1)='OwnInputDir/MySpecialConfig.nml',
ExtraConfigFile(2)='OwnInputDir/MyVerySpecialConfig.nml',

The definition of the last namelist is used if variables are set several times.

Also replaced k20 with kmax in config, since we do not necessarily use 20
levels.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3 May 2019, Peter

Merged INPUT_PARA and Machine_config namelists into ModelConstants_config

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2 May 2019, Peter

Topography is read from HGT in case WRF meteo. It will automatically redefine
Topofile (cannot be defined from config then!)
Also more robust GetCDF_modelgrid when dimensions are incompatible (will now
stop only if the file is "needed")

The emis_inputlist%PollName functionality was broken (since May 2018?). Repaired.

USES%AOD removed. Instead AOD_WANTED is set to true if any AOD or EXT variable
are requested in outputs

Landuse files, fileName_O3_Top and fileName_CH4_ibcs are now set in the general
config file treatments (i.e. DataDir and OwnInputDir are replaced).

Met_inner for nesting tries to replace datadir and dates if not found
(but not GRID, as it should be another grid usually) (not tested)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1 May 2019, Peter

Small bug in interpolation from Polar stereo to Polar stereo.
In the case when all these conditions are met:
1) interpolation from Polar stereo to Polar stereo
2) Conservative or mass conservative
3) Resolution of in grid is at coarser than met resolution/3

There is a small shift in the diagonal direction (1/3 gridcell).
This does not affect landuse PS to EECCA (exception 3))

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 Apr 2019, Robert

Added dry deposition parameters for MPAN

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18 Apr 2019, Peter

mapping factor not allowed to be 0.0 at poles (lon lat only). (wrf problems otherwise).

DryDep: added a "if(dbg)" for  'DBGXNO2 WRONG' . Please check: is this just a
warning or not allowed? (it is triggered when USES%EURO_SOILNOX=F and USES%GLOBAL_SOILNOx=F).
Note also that the "first_ddep" never gets .false. (it is not saved).

Put -O2 for intel optimization: test show that it is not slower and faster to compile.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 Apr 2019, Robert

* Added ZCM_EmChem16z directory -- for updated chemistry scheme

* Some find_index changed to case insensitive (to avoid problems with some old
model versions using capital F instead of f for "fine" particle components etc.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 Apr 2019, Peter

The model will output also part of monthes if startdate or enddateare not at
start/end of the month.
The timestamps should always point to the middle of the period.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 Apr 2019, Peter

NetCDF_mod: added debug1 to get 'interpolating from' printouts only on first
  step_main unless debug specified

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 Apr 2019, Peter

Reduced size of arrays that can be used for new format emissions.
Because the entire arrays are outputted into RunLog.out, even if not used.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 Apr 2019, Peter

Replaced nstep by step_main. It is slightly different, now it always increase.
The results can be slightly different, because mod(nstep,2) which is used to alternate
in the timesplitting, is not alternating every nmax, if nmax is odd.
(Now it does always alternating).
You choose nmax by setting dt_advec in config. For example dt_advec=900.0 will
give nmax=12 and identical results.

Reduced the writings of 'dividing each gridcell...' and some new emission comments.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 Apr 2019, Dave

Small problem-fixes:


Config_module: OwnInputDir enabled for EmisMask

Emissions_mod: Added filename to error message from EmisMask

Landuse_mod:  Allow longer and more ewords to cope with complex fName

SmallUtils_mod:  Extra error message if eword too long

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 Apr 2019, Dave

config_emep.nml. Comments added about Emis_source. FMI stuff commented out.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10 Apr 2019, Dave

Cleanup. A2018 comments and old lines removed.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4 Apr 2019, Peter

Forest Fire emissions distributed evenly taking into account layer thickness
(measured in pressure difference). (Precedent version would double emissions
into a layer if the layer is cut in two!)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2 Apr 2019, Peter

PS is added to hourly files iftey are 3D. This is required to define the
vertical levels.
Sorry for very heavy implementation, but I really struggle with following the
logic of the outputting routines.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1 Apr 2019, Peter

FirestFire_mod must now take both BiomassBurningMapping_FINN.inc and
BiomassBurningMapping_GFAS.inc
The choice of which one to use is set in config.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st Apr 2019  Dave, John

Emissions_mod - replaced 1000000 by 1.0e6 to avoid gfortran int overrun

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29 Mar 2019, Alvaro

Remove FORECAST mode
https://github.com/metno/emep-ctm/issues/51
https://github.com/metno/emep-mscw/issues/127

Advection_mod, BoundaryConditions_mod, ForestFire_mod, NetCDF_mod:
- remove from use call and update comments

Config_module and config_*.nml:
- remove FORECAST option

Derived_mod:
- skip monthly output for runs under 28 days
- skip full-run under for runs under 181 days

My_Outputs_mod.f90:
- remove deprecated/old-style hourly output

emep_Main, PhyChem_mod and ZD_Pollen/Pollen_mod:
- implement forecast restart/dump logic
- remove zero hour output, no longer needed

Nest_mod and config_*.nml:
- rename MODE_READ='FORECAST' to MODE_READ='RESTART'
- rename MODE_WRITE='FORECAST' to MODE_WRITE='OUTDATE'
- rename FORECAST_NDUMP and OUTDATE_NDUMP.

OutputChem_mod, Config_module and config_*.nml:
- new option USES%PROGRESS_FILES to output progress files,
  e.g. CWF_12FC-20190321_hourInst.msg for CWF_12FC-20190321_hourInst.nc,
  and modelrun.finished at the end of the run.

Note: The pollen modules are broken since c22db23 (Apr 2018)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24 Mar 2019, Peter

Defined masks for emissions. Example of use:
EmisMask(1)%filename = '/global/work/mifads/HongKong/emis4emep_3km/emis_3km_20161010_qt.nc'
EmisMask(1)%cdfname = 'PMFINE'
EmisMask(1)%ID = 'HK'
EmisMask(1)%threshold = -1.0E-10

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20-21 Mar 2019, Dave

** INTERIM COMMITS  ** OF ATTEMPTS TO cope with HK emissions
                       labelled often with !DSHK

Made start to allow lonlat femis to be applied outside, rather than inside box

Config_module - moved EmisSplit_OUT to config namelist (default false)

Debug_mod - changed DEBUG_EMISSIONS TO DEBUG%EMISSIONS (easier when debugging)

EmisDef_mod -  added 12th TEST sector while testing HK
               added logical femis_lonlat_internal - true if femis for inside domain

EmisGet_mod -  uses femis_lonlat_internal flag for in or out exclusion
               "xlonlat" in femis signals exclusion from outside lonlat domain
               comments (#) now allowed in femis data section
               use PrintLog and MasterProc instead of IO_LOG and me==0

Emissions_mod - uses DEBUG%EMISSIONS, and extra debug changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 Feb 2019, Peter

Removed "daytime" (and localhour and hourloc) from Emissions_mod.f90 . Was not in use.

Introduced timefactors for Emissions new format.
yearly-> apply monthly and hourly factors
monthly-> apply hourly factors
other periodicity do not apply timefactors

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13 Feb 2019, Dave

Biogenics_mod.f90  - removed warning (DAVE PLEASE CHECK). Looks okay.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17 Jan 2019, Peter

The timestamp (i.e. value of time variable) of the Base_fullrun.nc is set to
the middle of the run period (also if less than one year is run).
The attribute is also set to "time at middle of period", so you can know which file is new or old.
(Background: some scripts had problems since the time for a 2016 run
for example was previously set to 2017-1-1 00:00)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11-14 Jan 2019, Robert

GasParticleCoeffs_mod.f90: Added some deposition groups (used with CB6 scheme)
DefPhotolysis_mod.f90:     Bug fix IDMEK now set = IDCH3COX (was IDCH3O2H)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 Jan 2019, Peter

ForestFire is now a "normal" module: it does not need to be specially integrated
in the genchem and compilation process. One can switch between GFAS and FINN using
BBMAP in the config file. The existence of the relevant species are tested before
they are used and only the one existing are included.

The module can still be defined with something like "if(OM25_ix>0)then..."
for other types of chemical schemes. But it will always compile and use the
species available from the default chemistry.

NBB_DEFS and NEMEPSPECS are set automatically.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20 Dec 2018, Dave

EmisGet_mod.f90
Emissions_mod.f90

  - added dtxt and debug write-outs

Biogenics_mod.f90
Rsurface_mod.f90
StoFlux_mod.f90

- removed some A2018 comments

ZD_OZONE/My_Outputs

- removed OD and OP from SHL SONDE outputs. (Easier for CB6 tests)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19 Dec 2018, Dave

Added possibility to take CH4 BCs from RCP values (2.6, 4.5, or 8.5 so far)

BoundaryConditions_mod - now looks for fileName_CH4_ibcs
Config_module          - adding fileName_CH4_ibcs
config_emep.nml        - adding fileName_CH4_ibcs, commented out so far

Setup_1d_mod - small clean out of A2018 comments

Files added to DataDir/BoundaryConditions (stallo only so far).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22-27 Nov 2018, Peter

Time for CMAQ emissions improved, 3D emissions new format started (read but not yet used).
Species cases:
1) emitted species (nox,sox,pm25 ...) with sector (1...11)
2) individual species (SO2, NO, NO2, ...) with sector. The species MUST be one of the splitted species.
3) individual species (SO2, APINENE, O3 ...) without sector (<=0, or not specified)
   In this case the emissions are summed up in setup_rcemis (not in EmisSet)

Can inject into individual levels (only case 3), individual species without sector)

e_fact (femis) is applied through the source%factor in Emis_init_GetCdf

New format for FMI ship emissions included in config_emep.nml.
All attributes can specified and overwritten by the config (see example for EC).
NB: this has different definitions, as the old method corrected REMPPM25 and
POM_f_FFUEL for molecular weights, but should not (emissions in kg, not moles. to be confirmed by Jan Eiof?)

Note on units "as SO2":
if the sector is defined, units are defined "as SO2" and SO4 must include the
factor 0.6666 to be right. If sector is defined as zero, no factor is required.

METSTEP settable in config
Softcoded mw for roaddust

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14- Nov 2018, Dave

Interim changes to get stuff into dev

MetFields_mod
Met_mod
   in testing - enabled NWP Hmix, for now with GLOBAL05 variable 'blh'.

Config_module
   in testing - added OwnInputDir


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12 Nov 2018, Peter

bug in wind_speed_3D output corrected

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Nov 2018, Peter

On going... new format for emissions.
The goal is to be able to read any emission file, without having to modify it,
simply by describing the main parameters in the config file.

General structure as follows:
One 2D (or 3D) array for each "source".
One set of metadata for each file and each source (type(EmisFile_id_type) and type(Emis_id_type))

subroutine Init_Emissions and Emis_init_GetCdf read and set all metadata parameters (only once)
subroutine EmisUpdate update the 2D emission sources arrays when the data is outdated
in the (old) subroutine EmisSet the emissions are integrated into the final gridrcemis array

Metadata covers so far:
Filename, variable name.
Projection: 'lon lat' or not
Periodicity: hourly, monthly, yearly...
Grid resolution
Multiplicative factors for emissions: femis, or global attribute or variable attribute
Species (can be a emissions species that is splitted, or any single species)
Sectors
Country
Units
Flag to include this emission into the uEMEP local fractions.
Internal variables, such as number of sources, source indices, country indices etc.

Not yet implemented: timefactors, multicountry grids.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31st Oct 2018, Peter

New format for emissions. For now it will work side by side with the old format,
and hopefully gradually take over.
Should work exactly as before for old emissions only.

Also some other small changes:
GLOBAL_SOILNOX set automatically true if global grid.
Moved assign_nmax after metstep defined (bug, but nmax is almost not used anyway).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th Oct 2018, Dave, (Peter)

YieldModifications set to 'VBS-T10' in config_emep.nml, config_EMEPSTD.nml
and config_EMEPGLOB.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th Oct 2018, Peter, Dave

Bug in surface_precip (not "pr" the 3D precipitations).
The value was set 3600*METSTEP (= 10800 usually) times too small.
Like that since December 2013.

surface_precip is used as threshold in CellMet_mod.f90 and DustProd_mod.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th Sep 2018, Robert

YieldModifications_mod:

Added Benzene and Toluene as SOA-precursors.
Added RO2+RO2-reactions as part of the low-NOx-path to SOA.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th Sep 2018, Robert, John, Dave

GasParticleCoeffs_mod:

BUG fix for problem triggered by 4th Sep version. The bug (using len(defnames)
instead of size(defnames) has been around for months.

Some problems caught by gfortran:
  My_Derived - removed NEMIS_FILE from use EmisDef_mod. Is in CM_ChemDims_mod

  Setup_1d_mod:
    write(*,"(a,i)") dtxt//'CHECK:iPMNEG:',ipm
    -> write(*,"(a,i0)") dtxt//'CHECK:iPMNEG:',ipm

  Makefile..SRCS
    removed FUTURE_isocom.o FUTURE_ISOFWD.o FUTURE_isorev.o

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th Sep 2018, Dave

femis for AIRCRAFT added:

Country_mod:    used 900 for AIRCRAFT
Emissions_mod:  uses e_fact to modify NOX emissions (only nox possible)
Setup_1d_mod:   extra debug printout
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th Sep 2018, Robert
Added some more deposition classes for dry and wet deposition -- mainly for
EmChem18 but also for updated versions of EmChem16x.

GasParticleCoeffs_mod.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd Sep 2018, Dave
rv4.31 tag added
since Robert will soon make changes that affect results
rv4.31 can be associated with the (untested) NWP Hmix possibility

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd Sep 2018, Peter

Big bug when femis and non-fraction emissions are used (introduced 22 May 2018).


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st Sep 2018, Dave

Aqueous - removed lots of A2018 comment lines

ColumnSource  - added CheckStop for size of PROC_LOC (failed a DEBUG=yes test for global run)
       NEEDS check. Why doesn't -1 for NMAX_LOC work as suggested in config_emep?
       And ... please don't use l as a variable. Looks too much like 1 sometimes. This is one of our
       few 'programming rules' ;-)

Debug_module   - moved GETEMIS and ROADDUST to DEBUG% system
EmisGet_mod    - moved GETEMIS and ROADDUST to DEBUG% system. Also some formatting to get < 78 char lines
Emissions_mod  - moved GETEMIS and ROADDUST to DEBUG% system. Also some formatting to get < 78 char lines

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 Aug 2018, Dave, based upon Matthieu, Peter code

Incomplete introduction of NWP as an option for Hmix
Not tested yet since PBLH isn't in EECCA or EMEP01 standard data.

 BLPhysics_mod
     HmixMethod moved to PBL%

 Config_module - moved HmixMethod
 Debug_module  - DEBUG_MET becomes DEBUG%MET

 MetFields_mod.f90
    - added use of pbl_nwp. Set as needed if PBL%HmixMethod set at NWP

 Met_mod.f90
    - NWP option uses pbl_nwp
    - Also some tidy-ups (lines should be less than 78 chars wide)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27 Aug 2018, Robert

Added deposition parameters for some semi-volatile VBS-species (extending the
"Wesely Table") in GasParticleCoeffs_mod.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27 Aug 2018, Peter

Bug in wrf metdata for Lambert projection, when TRUELAT1 = TRUELAT2
Allow several meteo records within one METSTEP (when metdata has timestep less than one hour)
Only superficially tested, and only wrf.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27 Aug 2018, Dave

RE-TAGGING as rv4.30 (since there were problems with the attempt to re-name
as rv4.20)

Radiation_mod.f90 - just cleaned up units explanation

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22 Aug 2018, Dave

TAGGING as rv4.20.

This code differs mainly from rv4.17 as used in R2018 by using the new
ecosx-based chemistry and YieldModifications, as detailed below.
(Peter had used rv4.18, 19 for internal work.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 Aug 2018, Dave

NEW FILE: Debug_module - with variables moved from Config_module. This helps
  compatability with ESX, and should also allow more space to add comments
  concerning these debug variables.

=> many changes in .f90 files

SOA_mod.f90
Solver_mod.f90
YieldModifications_mod.f90

  - modified yield modifications code and usage


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th Aug 2018, Dave

ZCM_EmChem16x/emissplt_run
  Replaced  defaults.nox with new version containing SHIPNOx
  Added specials files for all POLL

On vilje, stallo, elvis:
  ~mifapw/Data/ZCM_EmChem16x/emissplit_run:
    Copied all files from above here. Used as default by Config_module.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th Aug 2018, Dave

ZCM_EmChem16x
BiomassBurningMapping_FINNv1.5_to_EmChem16x.inc - added back PM
CM_* files: Added new style Yield Modification equations to match rv4.17master


Small changes:

Config_module - DEBUG%SOA now integer

Setup_1d__mod.f90 - just removed some printout
SOA_mod.f90 - corrected use of DEBUG%SOA
YieldModifications_mod  - using integer DEBUG%SOA

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20th  July 2018, Peter

ReadField_CDF: Return zero (or Undef) when file or field not found and not needed
(returned unchanged array before)

ForestFire: replaced allocatable array rdemis and xrdemis by automatic arrays
(this is more efficient memorywise). Also set xrdemis to zero (was not done but
possibly is done automatically when the array is allocated).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th  July 2018, Dave

ZCM_EmChem16x files: removed BIOTERP as species, and changed ordering of species

Biogenic_mod.f90 - more use of dtxt and corrected case in Ash

Derived_mod.f90 - changed sub to dtxt for easier greps

My_Derived_mod.f90 - added BioNatC5H8 and BioNatTERP. CRUDE and confusing with
  also code in Derived_mod.f90. FIX LATER.

config_EMEPSTD.nml - added GLOBAL/EURO settings comments and DEBUG%STOFLUX
                    (not needed, just as reminder while testing.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th  July 2018, Peter

Change chunk size of 2D output to 300 ,130 (i,j) to speed up the verification
script (recommended by Heiko)

Changed the test for GLOBAL_setting with minlat=19 instead of 28 (EECCA was set
as global!) and East limit to -40

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th  July 2018, Dave

Aqueous_mod: found error (k=0) when using DEBUG. Fixed by setting kcloudtop
  to -999 in the "cirrus" cases that were not caught, and using RETURN in
  WetDeposition call if kcloudtop < 1. Results for WDEP_specs identical,
  but WDEP_PREC has tiny difference. Not understood, but the old code did
  allow array overrun in e.g. dA(k).

Biogenics_mod.f90: Use DEBUG%SOILNOX

Config_module.f90: Use DEBUG%SOILNOX

Emissions_mod.f90: Use DEBUG%SOILNOX, plus some extra writes (debugging)

GridValues_mod.f90 : just another write statement whie checking GLOBAL_settings etc.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th  July 2018, Peter

Changed default path of EmisHeights.txt

work/Data/EmisHeights.txt -> EmisHeights_Rep17.txt

Gave different files for Stallo/Elvis and Vilje! (Vilje will be unchanged now, sector 10 was different)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd  July 2018, Dave

BUG FIXES

Setup_1d_mod.
  Check for DDspec(ipm)%Gv > 0, not 1 !! Was big bug!!
  Smaller debug formatting changes
  use size(rcphot,dim=1) instead of just size(rcphot) (only when debugging)

DefPhotolysis_mod
   Comment out HCOHCO options. (bug related to BoxChem compatability)

ZCM_EmChem16x
   Corrected various rates, including HCOHCO

config_Outputs_EMEPSTD
   Corrected numbering for rcAeroN2O5 and now rc98HO2

CLEANUP:
   Removed most of A2018files. Shouldn't be needed now. Some files left while checking

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22nd June 2018, Peter

Removed sdot from code (was not in use). Only Etadot is used.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th June 2018, Peter

Small bugs in landuse (affect performance only)
old_month was not reset -> recalculate pftmaps each iteration
my_first_call was not saved -> may allocate an allocatable array.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th June 2018, Peter, Svetlana

Made the file   DataDir/CLIM/EMEP_BC.nc
Which is produced from 2012-2016 GLOBAL05 runs averaged monthly and to 1x1 degrees.
Covers slighlty more than the EMEP01 grid

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th June 2018, Peter

Nest  out_DOMAIN=RUNDOMAIN default
Was
  if(.not.FORECAST)then
    out_DOMAIN=RUNDOMAIN+[1,-1,1,-1]
  else
    out_DOMAIN=RUNDOMAIN
  end if
But we do not remember the reason for avoiding the boundaries

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th June 2018, Peter

Automatic global settings in subroutine set_EuropeanAndGlobal_Config
(GridValues_mod.f90)
The code will find out by itself if the rundomain is global (meaning not only
Europe is covered) or not

  !If the file is GLOBAL:
  !1) USES%PFT_MAPS = .true. (can be overridden by FORCE_PFT_MAPS_FALSE)
  !2) USES%DEGREEDAY_FACTORS = .false.
  !3) USES%EURO_SOILNOX = .false.
  !
  !If the file is EUROPEAN:
  !nothing happens for now

Degreeday file is not required to exist for wrf users, for others, by default
it is required for non-global runs (code will stop if not found).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7tn June 2018, Alvaro

Fix USES%AOD=T.

ZCM_EmChem16x/CM_ChemGroups_mod:
  Some of the elements in EXTINC_GROUP_MAPBACK were misnamed

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th June 2018,  Peter

Can now start and end run at any hour (must be one that is available in the metdata)

The method to setup the meteo reading is much modified, so it might be that
some new meteo format will not fit (will stop the code).
METSTEP is now set in Check_Meteo_Date_Type (was set in GetFullDomainSize)
The method relies on the ReadTimeCDF routine to be able to interpret times in
the meteo file.
All meteo files are assumed to have the same number of records (this could
probably be upgraded if needed)

Spinup period:
in OutputSize_config you can set spinup_enddate. If this is after startdate
The averaging and outputting of data is not started before spinup_enddate is
reached. Not thoroughly tested.
Note: it should be allowed to start a run in Decembre for spinup, but that
will not work for now, because Emission time factors, leapyear and perhaps
other things are set only once at the start of the run, and not updated when a
new year is reached.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th June 2018,  Peter

Monthly save for nest allowed.
set MODE_SAVE = 'MONTH'. Will not output for 1st of January.

Bug in ChecStop that made the error message not come out.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th June 2018, Svetlana, Peter

In Aqueous_n_WetDep_mod there was a return which was never reached.
Some unnnecessary calculations, but no effect on results

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1 June 2018, Anna
BoundaryConditions_ml.f90 - 2016 Mace Head corrections update

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th May 2018, Peter

Emis_mgm_... are now in same units as Sec_Emis_... i.e. NOx as NO2 etc.
(were in own mass units)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th May 2018, Dave

BUG - reaction of NO3 -> HNO3 was doubled up in Aero2017nx_Reactions.txt

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th May 2018, Dave

Setup_1d_mod: AREACHECK printouts now only activated with debug_flag
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th May 2018, Dave

More bug fixes, and chemistry made more consistent with rv4.17:

ZCM_EmChem16x changes

   Aqueous reactions added back!
   Ash added
   Many species set to "slow" CM_Reactions2 mode
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th May 2018, Svetlana

More corrections in DD_t in GasParticleCoeffs_mod (dry radii and dencities of
coarse SS and DU are made consistent with OpenSource)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th May 2018, Dave, Svetlana, Peter

Changed many names from upper to mixed case to match new EmChem16x,
eg DUST to Dust, SEASALT to SeaSalt, -F to _f.

ZCM_EmChem16x/BoundaryConditions_EmChem16x - added back DUST_SAH

Config_module.f90 - changed default DustFile to Dust2014_month.nc

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22-24 May 2018, Peter

Big refactoring of emission inputting.
EmisGetCDF is now more general, and is used both for "fraction" or "country" style
sector emissions. Works also with monthly emissions.
A new format is allowed, which is an extension of the "country" style format.
The emissions can have names with format
Emis:FR:snap:7:spec:sox:fac:1.0
where the name after "spec:" specifies the species, and the number after
"fac:" gives a scaling factor

A completely new (internal) format for emissions is introduced.
Will be generalized in the future.
In the new format, a new emission is read into Emis_field(i,j,n) where n defines the identity of the field.
the structure "Emis_id" will then identify for each id the actions to be taken (splits, time factors, emission heights etc.)
It is a kind of generalized sector, and sectors emissions will be attempted put there in the future.
For now it can already handle the "SpecialShips" from FMI if the names are redefined (updated file defined in config_emep.nml).
There was a difficulty with old setup, since the FMIship emissions do not use our standard emitted species and splits.
The new format can use emissions for any species in CM_ChemSpec.

"flat" emissions removed. (were not even used anymore!)

There was also a bug in the SecEmisOut maps (output): the map namess did not match the
species (introduced 30 April 2018)

And a bug for ship emissions: NTime_Read was not reinitialized. As a consequence "special
 ship emissions" may not be used in some cases. If DMS is just before in the emis_inputlist,
 as is default, it will work fine.

NB: the ship used special molecular weights, therefore, the factors are not integers
      !mw from Jukka-Pekka  Jalkanen  (e-post 16 June 2016)
      mw=46.0 for NOx
      mw=28.0 for CO
      mw=64.0655 for SOx which is only SO2
      mw=96.0655 for SO4
      mw=42.4 for Ash
      mw=12.01 for EC
      mw=17.32 for OC
! Comments from Jukka-Pekka Jalkanen at FMI

!   The composition of Ash can be taken from Janas paper
!   (Moldanova et al, Atm Env 43 (2009) 2632-2641), Table 8. According to
!   that, the composition by weight is: C (11.1%), O (5.7%), S (4.9%),
!   V (30.7%), Ni (20.9%), Ca (26.7%). This composition was determined for
!   fuel with 1.9% sulphur and it will not be directly applicable to fuels
!   used in the Baltic Sea during 2015. However, that is the only reference
!   I could find which reports the elemental composition of Ash.

! All primary PM emitted should be assigned to PM2.5 fraction since the PM
! size of fresh exhaust is less than 100 nm. Whether this grows fast enough
! to >2.5 microns in the timescale used by the regional models is not known
! to me at this point.

!nco commando for making the new names:
ncrename -v CO,Emis:SHIP_CO:snap:8:spec:CO:fac:0.001 FMIGlobShip2015mon.nc
ncrename -v NOx,Emis:SHIP_NOx:snap:8:spec:NO:fac:0.00095 FMIGlobShip2015mon.nc
ncks -A -v NOx FMIGlobShip2015mon_orig.nc FMIGlobShip2015mon.nc
ncrename -v NOx,Emis:SHIP_NOx:snap:8:spec:NO2:fac:0.00005 FMIGlobShip2015mon.nc
ncrename -v SOx,Emis:SHIP_SO2:snap:8:spec:SO2:fac:0.000998977608853439 FMIGlobShip2015mon.nc
ncrename -v SO4,Emis:SHIP_SO4:snap:8:spec:SO4:fac:0.0006662121156918978 FMIGlobShip2015mon.nc
ncrename -v Ash,Emis:SHIP_ASH:snap:8:spec:REMPPM25:fac:0.0002830188679245283 FMIGlobShip2015mon.nc
ncrename -v EC,Emis:SHIP_EC:snap:8:spec:EC_f_FFUEL_new:fac:0.0007993338884263115 FMIGlobShip2015mon.nc
ncrename -v OC,Emis:SHIP_OC:snap:8:spec:POM_f_FFUEL:fac:0.0008660508083140878 FMIGlobShip2015mon.nc
ncks -A -v EC FMIGlobShip2015mon_orig.nc FMIGlobShip2015mon.nc
ncrename -v EC,Emis:SHIP_EC:snap:8:spec:EC_f_FFUEL_age:fac:0.00019983347210657787 FMIGlobShip2015mon.nc
mv FMIGlobShip2015mon.nc FMIGlobShip2015monEmis.nc

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th, May 2018, Dave, Svetlana

Many bug fixes!
 Interim still - DUST isn't working, but SurfArea and SeaSalt are back, and
 chem params closer to R2017.

Deposition changes:
  GasParticleCoeffs_mod - revised to R2017 values!
                          BIG effects on NO2!
Surface area changes:

  AeroConstants_mod  - revised AERO constants
  ChemFields_mod     - use NSAREA_DEF not AERO%NSAREA
  Setup_1d_mod       - bug fixes on SurfArea

SeaSalt/Dust emissions fixed:
  (upper case tests weren't matching new mixed case names)
  SmallUtils_mod     - added any_case option to find_index_c
  SeaSalt_mod        - added any_case usage to find_index_c and StopAll
  DustProd_mod       - added any_case usage to find_index_c

Also needing any_case, since GenChem doesn't upper-case species names now:

  Derived_mod       - added any_case usage
  My_Derived_mod    - added any_case usage


ZCM_EmChem16x files
  - fixes for N2O5 dep, Extinc seetings, FINEEC for FFIRE_BC, etc.
  - DustExtended from chem used
  - MW corrected for dust

SMALLER CHANGES:
  Aero_Vds_mod    - use DEBUG%VDS not DEBUG_VDS
  Config_module   - use DEBUG%VDS not DEBUG_VDS

  ChemFunctions_mod -  StopAll for Riemer SIA usage

  run.pl - removed need for CM_emislist.csv

uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 May 2018, Dave

Aqueous_mod: BUG fix  - nwdep was being overwritten.

DryDep_mod - debug info changed

GasParticleCoeffs_mod - NO2 f0 corrected to 0.5.

ZCM_EmChem16x/CM_WetDep.inc - changed PMf to ECfn for new EC components

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 May 2018, Dave

corrected some chemistry/dep settings. Changes in ZCM_EmChem16x files.
Some debug changes in DryDep, GasParticleCoeffs and AeroFunctions

Small changes in Rb due to new diff coeffs, hence small changes in Vg

So far, large changes in Setting velocoty fir large particles found. Being
investigated.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th May 2018, Peter

Moved uEMEP diffusion into uEMEP_mod.f90 and more optimization.
Now vertical advection is done only up to 2 layers above uEMEP%Nvert
Since all local fraction are zero above uEMEP%Nvert, this gives almost the same
result. Less than 0.001 differences in locfrac, except sometimes over sea, because
ship emission are higher up and need to come down to diminish locfrac
Also bug fix, that could make localfractions nan at the northern boundary.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8tn May 2018, Alvaro

Fix USES%AOD=T.

Deriver_mod:
  EXTINC mapping logic (chemgroups_maps) was missing

ZCM_EmChem16x/CM_ChemGroups_mod:
  Some of the elements in EXTINC_GROUP_MAPBACK were misnamed

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd May 2018, Peter

Ouput timings for uEMEP, when active.
Redefine timings as max and min time (was first and last proc up to now)
And small moving around for timings.

More efficient diffusion for uEMEP. Was very slow.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd May 2018, Peter

To output local fraction corrected groups or primary components, set the subclass
as 'Local_Correct', in config, for instance:
      'NO'       ,'ppb' ,'Local_Correct','AIR_CONCS','SPEC' ,'YMH',
      'PPM25'    ,'ug'  ,'Local_Correct','AIR_CONCS','GROUP','YMH',

(note that not all 'Local_Correct' will make sense, since they will take local
correction for all parts. PMFINE, for instance will also correct the SIA, using
PPM local fractions.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Forgotten note from ca.last week in April 2018,Svetlana

Corrected aerosol dencities for coarse sea salt (2200 kg/m3) and dust (2600 kg/m3) in GasParticleCoeffs_mod.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30 April 2018, Peter

Now sector emissions are included in output by default, as part of
the ... sector emissisons.
Individual sector emissions can be added by setting for example:
  SecEmisOutWanted(2) = T,
  SecEmisOutWanted(7) = T,

for separate output of sector 2 and 7 (in addition to the default "all").


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27 April 2018, Peter

Now all emissions are included in the "Emis_mgm2_POLL" output.
Except the one which do not correspond to a split of standard emissions.
Up to now DMS, Ocean NH3, volcanoes, lightning, forestfire, aircraft, specialship were not included.

Renamed some of the arrays, for more clarity:
EmisOut,SecEmisOut,SplitEmisOut

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 April 2018, Robert, Dave

BUG fix - the two O3 photolysis rates were switched around. Makes a huge difference!

DefPhotolysis_mod   - fixed bug
Runchem_mod         - just some debug info
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24 April 2018, Peter

Removed gridrcemis0 (again!). Tested. multiplication by roa/(dA(k)+dB(k)*ps(i,j,1))
is done in setup_rcemis.
gridrcemis0 is a very large array, so it saves memory (and probably make the code
more efficient)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 April 2018, Peter

Big bug in emissions introduced 18 April, corrected.
(gridrcemis)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21 April 2018, Dave

BUG FIXES, MAJOR
  1. Photolysis - was zero
  2. Aerosols - calculation of ugSIA was wrong

rcphot - was zero!
  now defined in ZchemData_mod, and allocated in ChemFields
  Need to allocate with NRCPHOTextended!
  Affects DefPhotolysis, FastJ_mod, Solver

DefPhotolysis
  HONO rate added at 0.22* NO2 rate (uses NRCTPHOTextended dimension)

Setup_1d_mod
  Added is_sia and is_sia_a and made it work ;-)
  Fixed wrong use of ugPMF
  Added checkValidArray checks on rct and rcphot (when DEBUG%SETUP_1d on)

ChemFields
  Allocate rcphot with NRCPHOTextended!


NEW ROUTINES

  CheckStop_mod: checkValidArray to check eg all rct
  SmallUtils_mod: num2str for simple conversions

FUTURE -need to check/implement HONO and NRCTPHOTextented in FastJ

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20 April 2018, Peter

All "very important messages" at head of Log.changes removed, as most of them where
outdated, and just make people think that nothing is valid.

Updated link to emissplit in Config_module.f90. Can be overridden by config

Added a format in StopAll message, so that path do not get cut.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20 April 2018, Dave

mk.ChemFiles: NEW - to collect CM files from ZCM_ directories

New split files (EmChem16x) added into DataDir/inputs_emepdefaults_Apr2018
and config files (config_A2018.nml for run.pl, config_emep.nml for
stallo sbatch).

Added "IMPORTANT NOTE" for A2018 stuff above

MOVED:
GenChem.pl to ZCM_OLD  - not used now
mk.GenCheml to ZCM_OLD - not used now

ZCM_EmChem16x
 - added CM files
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19 April 2018, Dave

ZCM_OLD - new directory.
          All pre-A2018 ZCM directories moved here.
          Cannot be used with new system

Aero2017nx reactions added to ZCM_EmChem16x

AeroConstants_mod: NEW - to store AERO and NSAREA_DEF and avoid
  circularity

Radiation_mod: needed to declare real hour

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17-18 April 2018, Alvaro

Radiation_mod:
  Fix error on sunrise/sunset caused. The hourangle returned radians instad
  of degrees. This functions are, so far, only used on the development
  of Pollen emissions (FORECAST mode).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17 April 2018, Dave


AeroFunctions_mod

   *BUG* found in old code. SS2 and SS3 were mixed up for Gerber calculations

Config_module - changes in AERO

Derived_mod - changed DpgV to umDpgV

GasParticleCoeffs_mod
    Re-coded AERO stuff - still confusing, but a bit less so I hope.
    DpgV changed to umDpgV in DDdefs
    Added Gb to DDspec
    More changes to come.

Setup_1d_mod.f90
    Re-coded aerosol surface area - still confusing, but a bit less so I hope.
    More changes to come

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 April 2018, Dave

SOA_ml - recoded for new system
Runchem_ml - added first_tstep argmument to Init_OrganicAerosol call

run.pl - new temporary SplitDefaultsFile location (hard-coded on stallo)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 April 2018, Dave

A2018 INTERIM changes continue...

Biogenics_mod - now use 'NATBIO' type, so we have NATBIO%C5H8 etc. This can
  be used from CM_Reactions1. The advantage is that one can write terms such
  as:

      rcbio(NATBIO%TERP) = 0.45 APINENE + 0.20 LIMONENE + 0.35 TESTBVOC ;

  in GenIn_Reactions.txt. The disadvantage is that this term won't appear
  as emissions in the mass budget of eg APINENE. Needs more thought....

  BUG in OLD code? Didn't find rcemis for SOILNO in GLOBAL case. Maybe
   elsewhere? Added StopAll until this is resolved.

ChemFields_mod - needed hard-coded size 4 for rcbio. Needed to avoid circularity with
  NetCDF - Biogenics.  Will re-code soon, likely with new module for non-CDF
  NatBioFunctions_mod.

Config_module - removed BVOC stuff, except new NATBIO

Emissions_mod - removed unused NBVOC

LandPFT_mod - removed need of BVOC_USED

SOA_mod    - just renamed OM25_P to _p. The new GenChem preserves case

Solver_mod - added NATBIO access

My_Derived - removed use of BVOC_GROUP. NEED to recode!

ZD_ESX/My_ESX_ml.f90 removed. Obsolete

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
08-09 Apr 2018, Dave

Unimod no more :-)

emepctm is the executable

emep_Main is the name of the main :-)

(end of poetry section.)


MANY MANY CHANGES! INTERIM VERSION!
(Changes usually marked with A2018 for April 2018)

SORRY,.....
     but once this is done EMEP, ESX and BoxChem will all work from the
 same system, with the immediate benefit that Robert  can test chemistry
 in the box and emep models at the same time. The new GenChem fixes some
 bugs with the old in any case. The complex mapping of wet and dry deposition
 have also been simplified.

WARNING: some code is simply commented out since I didn't have time
  to fix all, and some help from others would be useful.

WARNING: Do not use the old GenChem system now! We need to get the new one
 in place - speak to Dave

 THEREFORE: CM_ files in current directory are *only* scheme to use just now
  Will change soon!

  Also, the Makefile no longer attempts to run GenChem. We will do this
 separately in future.

WARNING: Aerosol stuff *has* bugs, especially
  the link to surface area which is/was confusing.

WARNING: Extinc stuff is currently commented out, but will be brought
  in via the new GenChem, as part of the GenIn_Species file.


GasParticleCoeffs_now now takes care of the CM_DryDep.inc and
CM_WetDep.inc stuff, now mapping to a simpler set of arrays and avoiding
different indices for gases and particles. Definitions of scav rates,
particle size and density are all now done in this module.


Now have CM_ChemDims for eg NSPEC_TOT, NEMIS_File, etc.


EmisDef_mod and Emissions_mod.
  Added 'private' to EmisDef_mod
  which needed a lot of 'public' on various variables used by Emissions_mod


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9 April 2018, Peter

Small bug in "day of the week": the local hour West  UTC was always positive,
giving possible wrong day of the week a few hours each day.

Introduction of "automatic mask" for emissions. In config set for instance:
emis_inputlist(1)%set_mask = T,
emis_inputlist(2)%use_mask = T,
NB: the order of the masks do matter and Yealy emissions are always treated before monthly (i.e. you cannot make a mask from monthly and apply it to yearly)
The mask will be defined *only* at positions with some emissions (larger than 1.E-20)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27 Mar 2018, Dave

Small renames, on way to EMEP/ESX merge

mv ChemFunctions_ml.f90 ChemFunctions_ml.f90
mv Setup1dfields_ml.f90 ZchemData_mod.f90

GasParticleCoeffs_ml to GasParticleCoeffs_mod

Changed references in most files.

Also Makefile.SRCS, GenChem.pl

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 Mar 2018, Dave

NetCDF_ml : small debug changes - added dtxt and dtxt_smg

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
09 Mar 2018, Peter, Massimo

When the input data has at least 10 times coarser resolution than teh metdata
and both are in latlon, there can be an interpolation bug that give zero.
Shows clearly as vertical lines.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
08 Mar 2018, Peter

Allow separate files for hourly outputs. Use the config keyword, for example:
  HOURLYFILE_ending	= 'JJJ.nc',
(note that compared to earlier versions, "hour" is always added by the model,
 and should not be part of the keyword)

removed the deprecated Output_hourly.f90 (excellent to be able to clean something!)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
07 Mar 2018, Peter

Upgrade of "emis_inputlist". Can now mix monthly and yearly emission sets.
Also "country style" emissions can now be monthly (although not tested).
NB: the monthly time factors are reset to 1 if monthly emissions are used
(in order not to count them twice). Will change results
If both monthly and yearly emissions are used, the monthly emissions will first
be divided by the monthly factor before merging to yearly.
renamed "snapemis" to "secemis", as we do not only have snap sector categories.
Perhaps not fully tested, as there are plenty of combinations possible.

Also set NITERXMAX=40 in Advection_ml
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
06 Mar Dave, Heiko

Ecosystem_ml
My_Derived_ml
config_Outputs_EMEPSTD.nml

  - added is_forest and Forest outputs - merges both conif and decid
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
02 Mar 2018, Heiko

Showing namelist-error line, gfortran fixes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th Feb 2018, Alvaro

Open Source 201802, rv4_17

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20th Feb 2018, Alvaro

DefPhotolysis_ml
  Fix USET query when no 3D output is required

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th Feb 2018, Dave

ZCM_EmChem16mt and all EmChem16mt files renamed to EmChem16a

Also in mk.GenChem, run.pl and Makefile.

EmChem16abase-reactions: bug-fixes for HONO and OD+H2O rates

NEW: LandInputs_Feb2018

   glc2000xCLMf18.nc i
   csv files same as Apr2017

config_EMEPGLOB.nml
   uses new landcover
   added PANDA emissions as possible (better?!) emissions for global

config_EMEPSTD.nml
   uses new landcover
   has MonthlyNH3='LOTOS' - intended for EECCA/Europe only!

ChemFunctions_ml
   Merged SmixC into Smix. Just use Smix, but this now has coarse aerosol too.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13-14th Feb 2018, Peter

Removed the two 2d and one 3d "specials" for uEMEP outputs, and replace them
by "USET" outputs (example in config_emep.pl and config_Outputs_NORWAY.nml
Redefined slightly is_water is_ice and is_allsea; several water or ice categories
can in principle be defined.
For 3d output, also subclass can start by 'D3', instead of name (to allow more
freedom in names as they appearin the output).

New config flag HourlyEmisOut = .false., to output snap and sector emissions hourly
This is set automatically if uEMEP hourly output are requested.

In effect removed the changes introduced 5th Feb 2018

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th Feb 2018, Svetlana

LandType(n)%is_desert is implemented in LandDefs_ml and DustProd_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th Feb 2018, Peter

Snowdepth multiplied by 5 by default (not for WRF metdata). This is because
IFS snowdepth is given in water equivalent, while the model needs meters of
snow.
Added SplitSpecialsFile and BiDirInputFile under NAMELIST /ModelConstants_config/
(were missing)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th Feb 2018, Dave

Config_module
Timefactors_ml
  - added USES%MonthlyNH3, with a LOTOS option. Gives better NH3 :-)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th Feb 2018, Dave

NEW BUT EMPTY:  BiDir_module.f90, BiDir_emep.f90
  - added so that Roy and Dave can work with the BiDir version.
  - Makefile.SRCS modified

BiDir -associated changes in :

  Biogenics_ml.f90
   - commented out old enh3 code. Some safety initialisations added.

  CellMet_ml.f90
   - added is_frozen, sets Grid%latitude rh2m
  DryDep_ml.f90
   - also clean up and some BIDIR entries
  LocalVariables_ml.f90
   - removed GasParticleCoeffs_ml dependency with NLOCDRYDEP_MAX param
   - added sst

  My_Derived_ml
   - added Emis_mgm2_BioNatSoilNH3

  Unimod.f90
   - added call to Init_BiDir

ZCM_EmChem16mt/
  Added Aero2017nx.reactions - excludes some (R18) gas-aerosol uptake
        Aero2017nx.species
  EmChem16mtbase.reactions - added rcbio for NH3

mk.GenChem - uses above Aero2017nx

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th Feb 2018, Dave

config_EMEPSTD.nml
 - commented out GRID line in ColumnSource_config that was causing problems
 - added BIDIR and BiDir variables in preparation for future step

ColumnSource_ml.f90
 - added dtxt='ColSrcConf' to help debug outputs

NEW: UPDATE_README.md - start of text to explain rv4.17 update

Config_module.f90
  - clean-up - removed old USE_ variables


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th Feb 2018, Matthieu, Alvaro, Peter

Special outputs for uEMEP. Only temporary.
Tee "specials" (special2d, special3d) should be put into USET, and the "H" in
Derived_ml must be revised.

Edit: these changes are removed 14th Feb

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th Jan 2018 Peter, John

Corrected bug in wrf met reading for snow. Was using SNOWNC which is accumulated since
the start of the run, while SNOWH should have been used.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th Jan 2018 Peter

A specific sector category (SNAP or GNFR) can be forced in config for example:
USE_SECTORS_NAME = 'SNAP',

Even if the emissions are defined in GNFR, they will be mapped over to SNAP, so
that everything looks like SNAP was used. The concentrations should be identical,
because so far we haven't introduce any specific parametrization for GNFR.

Also removed the Emis_SOURCE and Emis_TEST flags, that were no more in use.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st Dec     2017 Dave  rv4_16

** TAGGING as rv4_16 **

Rsurface_ml: cleaned and simplified structure

ChemFunctions: bug fix for gamma SmixC   (changes results a bit with SmixC)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th Dec      2017 Dave

** TAGGING as rv4_16beta **
Should be same as code used for N2O5 paper

Config_module - now includes previous emep_Config_mod.f90

rm emep_Config_mod.f90

Changes in :

  Biogenics_ml.f90 BLPhysics_ml.f90 Config_module.f90 Landuse_ml.f90 Met_ml.f90
  OutputChem_ml.f90 PhyChem_ml.f90 Runchem_ml.f90 Solver.f90 YieldModifications_mod.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th Dec      2017 Dave

*** RESULTS CHANGING ***** START of rv4_16beta
** ModelConstants_ml renamed!

1) Science

N2O5:

  EmChem16mtbase.species now has deposition of N2O5 set to that of HNO3. This
  makes a big difference to N2O5 levels, and some difference to
  o3 etc.  Could have done the same for NO3 but that causes small changes.

FFIRE_CO:
  ZCM_EmChem16mt:

  BiomassBurning_FINNv1.5_to_EmChem16mt  - added FFIRE_CO

  ZCM_EmChem09:

  Added ForestTracers.species ForestTracers.reactions

  ForestFire_ml - modified to cope with FFIRE_CO

  config_emep.nml and config_Outputs_EMEPSTD now have FFIRE_CO as examples.

  mk.GenChem - uses ForestFire tracers for EmChem16mt


ModelConstants_ml now renamed to Config_module!

  - since the constants are now very variable and it was easier to rename this
    than to move code into emep_Config. In the next step the small emep_Confg
    stuff can move here, and maye we can even retsart ModelConstants for some
    constants ;-)

  - change 'use' calls in most files.

  NOTE: Changed also in ZD_Pollen, and ZD_3CVar, but not other ZD_Var directories.



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd Dec      2017 Michael G

Switched from USE_XXX to USES%XXX method for five variables:
USE_POLLEN, USE_ASH, USE_NOCHEM, USE_AOD, USE_PreADV

Files affected:
config_*nml
ModelConstants_ml.f90
ZD_OZONE/My_Outputs_ml.f90
ZD_POLLEN/My_Pollen_ml.f90
ZD_POLLEN/Pollen_ml.f90
ZD_POLLEN/Pollen_const_ml.f90
Nest_ml.f90 PhyChem_ml.f90 Runchem_ml.f90 ColumnSource_ml.f90
AOD_PM_ml.f90 Derived_ml.f90 My_Derived_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st Dec      2017 Dave

*** RESULTS CHANGING ***** START of rv4_16beta

Implemented Weiss & Norman radiation scheme, to give better diffuse/direct
treatment. Changes in:

  Biogencs_ml - modified to use total PAR from W & N
  MetFields - added PARdbh, PARdif, fCloud
  Radiation_ml - add WeissNorman routines and usage
  Rsurface_ml  - add WeissNorman routines and usage
  PhyChem -  use of above

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
01st Dec     2017 Michael G

Switched from USE_XXX to USES%XXX method for nine variables:
USE_SOILWATER, USE_CONVECTION, USE_AIRCRAFT_EMIS, USE_LIGHTNING_EMIS,
USE_SEASALT, USE_DUST, USE_ROADDUST, USE_EURO_SOILNOX, USE_GLOBAL_SOILNOX

Files affected:
config_*nml MetFields_ml.f90 DO3SE_ml.f90 Met_ml.f90 SoilWater_ml.f90
SubMet_ml.f90 Advection_ml.f90 Convection_ml.f90 Emissions_ml.f90
Setup_1d_ml.f90 AirEmis_ml.f90 Unimod.f90 ModelConstants_ml.f90
BoundaryConditions_ml.f90 Runchem_ml.f90 SeaSalt_ml.f90 Solver.f90
DustProd_ml.f90 EmisGet_ml.f90 Biogenics_ml.f90

This should not lead to any changes in the model results and this was
tested before git push.
Other USE_* variables will be changed in further updates soon.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th Nov     2017  Dave

ChemFunctions_ml
  Now allows any number in Gamma:xxxx for N2O5 hydrolysis (instead of SmixC
   etc). For example, with Gamma:0.02 we derive the numerical value, gFix=0.02,
   from this string

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th Nov     2017  Dave

Country_ml
   Fixed --100 to -100 for HT1015   ! BUG!!
   More length to country name
   Extra tests in self_test

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23rd Nov     2017  Peter, Massimo

There was a bug when the lon lat grid is defined in such a way that the transition
from negative to positive longitudes is on the same processor.
This does never happen if the grid starts at -180, such as our GLOBAL or GLOBAL05 grids.
The model could then crash in the landuse (explains Massimo's issue).

Also changed the lib path in utils/uEMEP_GUI.py , so that it works on Stallo.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th Nov     2017  Peter

GetEuroBVOC() uses hardcoded landuse (CF,DF...). If these where not defined
the index (ibvoc) gets negative, and values are written in a random part of memory.
This might be the reason why the code crash when glc2000.nc was defined for both
landuse files.
Added if(ibvoc<0)cycle which seems to solve this problem.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14-15th Nov     2017  Peter

All files (except config) can be linked through config.
Only Unimod and config_emep.nml are needed.
Just run from any directory; copy Unimod (executable) and config_emep.pl and:
mpirun Unimod
(you should of course do this from a compute-node or in a script)

config_emep.nml is now simply made from config_EMEPSTD.nml+config_Outputs_EMEPSTD.nml
and the first &INPUT_PARA Block
At present default path are set in ModelConstants_ml
ALL links removed from run.pl. We do not need it anymore?
Still to be done:
.-Emissplit now taken from DataDir/ZCM_EmChem16mt/EMISSPLIT/ . Should be adapted to chemistry in use
.-femis/SR runs?
.-general bash script?


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th Nov     2017  Peter

Corrected bug in uEMEP/uemep_adv_k when uEMEP%Nvert = 1
(Otherwise no effect)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th Nov     2017  Peter

Some flexibilities for AROME meteorology:
Surface precipitations can be accumulated. Assumes it has name
'precipitation_amount_acc'and unit mm (or kg/m2).
Surface pressure can be either Pa or hPa (it looks at the value to find out).
Time dimension can be called "times" (but it is not recommended).
The code accept meteorology in either Short or Float (or Double) types.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th Oct     2017  Dave

Landuse_ml - BUG FIX for non Euro domains anyway
             Initialise landuse_tot
             Add where statement to check if landuse_tmp > 0

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th Oct     2017  Dave

My_Derived_ml - just increased default size of MAX_NUM_NEWMOS to be 30, see #76.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th Oct     2017  Peter

Country code column in the "lonlat" lines in femis.dat.
If the code is zero, all countries within the lonlat rectangle will be reduced;
otherwise only the country corresponding toi the code will be reduced.

There is backward compatibility, in the sense that it will work if the country code
is omitted, however this should be avoided: put 0 instead for reducing all countries.
The backward compatibility will not work if there are comments at the end of the line

Example of femis:
Name  7         sox        nox        co       voc     nh3     pm25   pmco
 28    0        1.0        1.0       1.0      1.0      1.0     1.0    1.0
lonlat 0.0 25.0 45.0 60.0  0 0    0.0  1.0   1.0   1.0   1.0   1.0   1.0
lonlat 0.0 25.0 45.0 60.0  17 0    1.0  0.0   1.0   1.0   1.0   1.0   1.0
lonlat 0.0 25.0 45.0 60.0  3 0    1.0   1.0   1.0   1.0   0.0   1.0   1.0

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th Oct     2017  Alvaro

ModelConstants_ml, Met_ml, ColumnSource_ml, ForestFire_ml, ZD_Pollen/Pollen_ml:
- Extend length of the meteo path/filename variable.
  From open source user feedback, see metno/emep-ctm#25.
- TXTLEN_FILE parameter defines path/filename length.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th Oct     2017  Peter

Allow to switch off (i.e. not take into account) femis for specific emissions
files. Only the lines with "lonlat" format are switched off.
To switch off femis-lonlat for the emissions specified in emis_inputlist(1),
add this in config file:
emis_inputlist(1)%use_lonlat_femis = F,

uEMEP: output only lowest level (can be modified to different number of levels,
but hardcoded for now)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th Oct     2017  Dave

run.pl - just added Peter's text concerning 16 or 32 threads, since this it
 clarifies a lot!

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th Oct     2017  Dave/Roy

Radiation_ml:  identified problem with diffuse/direct !!! TO-FIX
               Added TSTEMX lines to illustrate this.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
03rd Oct     2017  Dave

  config_*nml files. Added comment that 1km PS Landcover also available

  run.pl. Started to remove ancient or config'd code lines

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19-21th Sep  2017  Alvaro

ForestFire_ml:
- fix gFortran compile error

ModelConstants_ml
- Ash from historical Eruptions by default (#49,#29)

ColumnSource_ml:
- stop simulation when NMAX_LOC/NMAX_EMS is exceeded (#44)
- topography file (topo_nc) is required by default,
  can be made optional on ColumnSource_config namelist (need_topo=F) (#31)

ColumnSource_ml,run.pl,config_$exp_name.nml
- read NMAX_LOC/NMAX_EMS from ColumnSource_config namelist (#29)
- estimate NMAX_LOC/NMAX_EMS from lines on input files when NMAX_LOC/NMAX_EMS<1 (#29)

Derived_ml:
- fix bug afecting Z_MID output (#47)

ForestFire_ml,Nest_ml,Pollen_ml,run.pl,config_$exp_name.nml
- use DataDir/GRID keywords on Fire_config,Nest_config,Pollen_config (#63)

NetCDF_ml:
- improve missing file error message

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th Sep  2017  Dave

ForestFire_ml.f90

   - added new option (MODE="MONTHLY_CLIM" or "C" or "c") to deal with
   climatological BB emissions, where the monthly averages have been
   pre-calculated. This might be from the year in question, but the main
   aim is to allow e.g. 10-year average climatologies to be used where
   'real' data is not available.

   (A preliminary 10-year data set from FINNv1.5 can be found in
    /global/work/mifads/FFIRE_TESTS/gRemapMonthly10yr.nc.  Also need to
    set ${'FINN'} in run.pl to use, along with modified MODE in
    config Fire_config. )

   - changed function newFFrecord to be subroutine, since (a) I don't
   like functions to do more than return one value (ie no side-effects),
   (b) most fortran style-suggestions don't like that either, and (c)
   having more than one contains command per module is also confusing
   (IMO!).

  - harmonised treatement of ReadField_CDF across different BB sources
  - Extra documentation
  - Modified debug, though this is still somewhat confusing

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th   Sep  2017 Alvaro

OPEN-SOURCE RELEASE (tag rv4_15os)

The open source release contains some commits between rv4_15_1 and this point.
The list of commit included can be found on issue #52.

The release is based on master after cleanUp2017 (PR #56, #61 & #62).
It contains some additional clean up, intended only for the open source release.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th   Sep  2017 Alvaro

config_BM-EECCA.nml,config_Open.nml,
config_ANALYSIS.nml,config_FORECAST.nml,config_FORECAST_CitySR.nml:
 Add FLUX_IGNORE bug-fix entry from Aug 5th to remaining namelists

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st    Sep  2017 Alvaro

allow multiple Special_ShipEmis files, see #55

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th   Aug  2017 Alvaro

- make EMEP on EmChem16mt (#50)
- Fix Pollen_ml after rv4_12beta

Makefile
  On 6b4c9e3 (Aug 8th) the configuration for EMEP was wolled back to EmChem09soa
  by mistake. This change set it back to EmChem16mt

Pollen_ml.f90
  On rv4_12beta (Mar 2017) Wesely_ml was renamed to GasParticleCoeffs_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th   Aug  2017 Dave

ForestFire_ml.f90

  Merged ReadField_CDF coding for GFAS, GFED and FINN, folllowing #51
  Added explanation of Interpolation options from ReadField_CDF for
  fiture reference.
  Small tidy-up, with line length < 78 chars

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th   Aug  2017 Alvaro

Fix eEMEP emission expansion, close #54

ColumnSource_ml:
  Revert bug introduced on svn 3303 (Oct 2016, git aaa393b).
  It caused the default emissions used by eEMEP to fail to expand as groups

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th   Aug  2017  Alvaro

cherry-pick patches from cams50 branch
  2017-06-29: fix Nest for native_grid, close #48
  2017-05-15: log #obs assimilated
  2017-05-12: compile new 3Dvar17 version
  2017-05-10: import new 3Dvar17 version
  2017-03-20: fix grass pollen forecast (#12)
  2017-01-02: fix pollen forecast crash, close #18

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th   Aug  2017  Alvaro

Fix GFASv1 ForestFire mapping for EmChem16mt
and update FORECAST/ANALYSIS namelist (see #50)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th   Aug  2017  Dave
Bug-fix to restore IAM_VEG for whole domain. (rv4_15 only had IAM_VEG for the inner
area where landocover came from the Landuse_PS_5km_LC.nc file.

Solution now is to set IAM_VEG for all land-cover areas except those specified
in the config array FLUX_IGNORE:

  FLUX_IGNORE = 'W', 'D', 'DE', 'ICE', 'BARE'   ! Ignore these for FLUX calcs.

This allows for future landcover data-sets, which might have other codes for
these non-veg areas. (The 'IAM_VEG' currently found in Landuse_PS_5km_LC.nc
is now ignored.)

Changes:
Landuse_ml - as above
ModelCostants_ml - added FLUX_IGNORE
config_EMEPSTD.nml - added FLUX_IGNORE
config_EMEPGLOB.nml - added FLUX_IGNORE

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th  June 2017  Peter, Anna

Bug fix! timefactors can be wrong in certain cases.
If a timefactor code is defined several times in Country_ml, the timefactor for
the last one is used instead of the first one (using find_index).
This will normally give a default timefactor of 1. Affects:
shipping emissions (country codes 30-34, but does not matter, since the timefactors are 1 anyway?)
"European Community" (code 64, not used?), Turkey (code 25), "Rest of Russia " (Code 42).

Allow country specific hourly factor. The idea is that we define cities by a new
country code, and special traffic hourly factors are applied to those (CAMS50 project).
17 European cities are defined in Country_ml.f90.
The new factors are given for now at:
$DataDir/inputs_emepdefaults_Jun2017/HourlyFacsSpecials.CAMS50
As long as the emisions do not have these new City-codes, there will be no effect.
Defaults are the old values.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th June 2017 Peter rv4_15_1 (status 2017 version, 494ad81)

GridValues_ml:
  bug for uemep long rang transport corrected

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th  June 2017  Peter, Joffen

Allow a special format for ship emissions.
Implemented in a rush for reporting. Should be cleaned/revised.
Monthly only for now.

Example of format:
!  emis_inputlist(3)%name = '/home/mifajej/Emissions/Ships/FMI_Glob/2015/FMIGlobShip2015mon.nc',  !
!  emis_inputlist(3)%type = 'Special_ShipEmis',

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th  June 2017  Peter

Can use a mix of SNAP and GNFR emission, if the type of the second is specified.
The first emission determines the main sector categories, the other emissions
will be mapped. For instance

  emis_inputlist(1)%name = '/global/work/nyiri/emis01deg_EMEP2015/GNFREmis_EMEP01_2015.nc',! GNFR

  emis_inputlist(3)%name     = '/global/work/mifapw/emep/Data/Emis_TNO7_MACCIII/Emis_TNO7_MACCIII_2011.nc',
  emis_inputlist(3)%type     = 'SNAPsectors',          !interpret as SNAP
  emis_inputlist(3)%incl(1:) = 'MED','NOS','ATL','BAS','BLS',


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th  June 2017  Dave

CellMet_ml - restriced z_ref to be >= 30m to avoid negative height calculations
  in SubMet_ml.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th  June 2017  Peter

Allow for outputting sectorwise emission.
In ModelConstants_config set for instance:

  SecEmisOutPoll(1:)	= 'pm25', 'nox',

This will give you separately all the 11 sectors for each of these pollutants

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
07th June 2017  Dave

mk.testX - small update to remove previous executable

Country_ml.f90 - Added 4-letter gains code to Country type. Not used in EMEP
  yet, but useful offline for processing info from IIASA

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
06th June 2017  Dave

mk.testX - added 2nd optional argument which can be ifort. Otherwise gfortran used.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
05th June 2017  Dave,  rv4_15

BUG fix on apinene reactions - was reacting in two .reactions files

  - CHANGES results!

So, chemistry cleanup was the result, with new VBS system to keep the code
shorted and more visible.

VBS reactions and coefficients now dealt with in YieldModifications_mod, together
with new system in ZCM_EmChem16mt/VBS_SOAformationY.reactions. The new system
now makes use of labels, e.g. |YCOXY(1)| to set yields for different components
in different VBS bins. Here, from OXYL into 10**1 (ie 10ug/m3) bin.

ZCM_CRIv2R5/GenIn.shorthand
  Copied CRIv2R5jpc.shorthand to GenIn.shorthand

ZCM_EmChem16mt:

  Aero2017n.reactions:
    Added fine-mode O3 uptake on dust

 EmChem16mtbase.reactions:
    Cleaned out old C5H8 chemistry

 EmChem16mtbase.species:
    Removed TERPPeroxy, since we now use new VBS system

 VBS_SOAformationY.reactions  ---- NEW !!!
    uses new and improved YieldModifications for VBS

ChemFields_ml.f90
  Adding cell_tinv as 1/T for use in YieldModifications

ChemFunctions_ml.f90
  Added SmixC option to explore coarse-mode uptake. Not used yet.

mk.GenChem
  Used new SOAformation file for EmChem16mt - using YieldModification methods

config_EMEPSTD.nml
  Using YieldModification = VBS

emep_Config_mod.f90
  Made YieldModification = VBS default. Also safe for EmChem09soa; just wastes
a little CPU.

config_Outputs_EMEPSTD
   Added SQT output

Solver.f90
  Adapted for new VBS methods in YieldModifications

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31st  May 2017  Peter

NetCDF_ml: bug in interpolation routine:
Can affect only cases where:
1)interpolation from lon-lat to lon-lat
and 2) the model grid has finer resoltion than the data interpolated (which is normally not the case)

Nest_ml.f90: option to save only the data at BC  of inner grid.
Set  "MET_inner" and "RUNDOMAIN_inner" in config.
Still under testing.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th  May 2017  Peter

run.pl: changed SLURM commands. There is a bug on Stallo, that makes MPI count
wrong the number of CPUs if not entire nodes are taken.

Introduced special2d and special3d arrays in MetFields.
If you need very special output (i.e some quantity that cannot be outputted by
standard My_Derived). For 2D fields
1) set Nspecial2d  in MetFields according to the number of new outputs
2) write in set in the code the values of the array special2d(i,j,N), where N is
   the output number (i.e. 1,2,... Nspecial2d).
   For instance special2d(i,j,1)=Grid%invL in CellMet_ml.f90 for invL
3) include in the same routine the use MetFields_ml  , only : special2d
4) In config_Output.nml include the line for instance
 'MyName','MET2D','special2d1', '-','MyUnit' ,-99,-99,F,1.0,T,'YMD',
(and 'special2d2', 'special2d3', ... for other outputs)

For 3D fields replace all the "2d" by "3d"

Redefined a group OX in ZCM_EmChem16mt/EmChem16mtbase.species


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23rd May 2017  Dave,  rv4_14

ZCM_EmChem16mt/EmChem16mtbase.reactions

  - CHANGES results!

  - removed most SOA-induced yield reductions in gase-phase. Just keeping
    any SOA-effect for compounds which partition at 1ug/m3 and under

  - added Photolysis of HO2NO2, based upon MOZART chemistry

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th  May 2017  Peter

Some uemep improvements: pollutant destination, more dimensions possible in
Out_NetCDF, zero order advction config flag

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th  May 2017  Alvaro

Update for new modules in stallo:
Makefile, run.pl:
- compile with mpiifort instead of mpif90
- execute with mpirun instead of mpiexec

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th Apr - 8th May 2017 Peter

Sign error when pre-correcting the fluxes in uEMEP:
     xn=xn-xx+x -> xn=xn-xx-x

Some clean up (uemep rundomain, molecular weights,..)
presave loc_frac in advec microiterations.
zero order vert advection flag.
for zero order advection, uemep (for ppm) gives exactely the same result as SR,
also the 2nd, third neighbor. (one day test).

bug in uemep diffusion corrected
set advection to 4th order again

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st Apr 2017 Peter
Reorganization of uEMEP. Own uEMEP file with uemep routines.
uEMEP: for each gridcell computes fractions for a surrounding region.
Needs write out many dimensional data (i,j,k,t,sector, + x and y for origin of pollutant).
New routine in NetCDF_ml that writes many dimensional array.
Still need interface for input parameters and more checking.
Molecular mass of emissions/pollutant hardcoded now.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th Apr 2017 Dave

ZD_ESX deleted - wasn't being used and was more confusing than helpful

Modified to remove ESX bits:
DryDep_ml.f90
Makefile.SRCS

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th Apr 2017 Dave/Robert, tag rv4_13

BIGGISH CHANGES CONTINUE. RESULTS HAVE CHANGED!!!!

Makefile - now uses EmChem16mt as default

ZCM_EmChem16mt/GenIn.shorthand - added. (Same as EmChem16mt.shorthand)

NEW CHEM:
ZCM_CRIv2R6jpc/ - CRI_v2_R5 with new isoprene from Mike Jenkin (via Robert)

BUG-FIXED emissplit:
ZCM_CRI_v2_R5/EMISSPLIT/emissplit.defaults.voc
   -  Garry H sent new file to replace old (and badly bugged) previous version
   -  old version had loads of BPINENE, new version hardly any.

run.pl - now checks for CRI pattern for emissplits

NEW FILE:
 YieldModifications_mod.f90
  - allows changes in e.g. yield coefficients during execution of
    Solver iterations.
  - only triggered with CRIv2R5 so far, for SOA yields and JPC testing

Associated changes:

config_EMEPSTD, config_EMEPGLOB - mentions YieldModifications

Makefile.SRCS - added YieldModifications_mod.f90

Solver_ml.f90 - calls YieldModifications if wanted





xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st Apr 2017 Peter

Old DMS (natso2.dat) removed from the code

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15-20th Apr 2017 Dave, tag rv4_12

BIGGISH CHANGES CONTINUE. RESULTS HAVE CHANGED!!!!

1) LandConverInputs - config'd:

emep_Config_mod.f90
LandDef_ml.f90
Landuse_ml.f90
ModelConstants_ml.f90
config_EMEPSTD.nml
config_EMEPGLOB.nml

  -  Adding landcover file names and LandDefs, DO3SE inputs to config system.
  -  Defaults now from LandInputs_Apr2017, incl. glc2000mCLM.nc

run.pl

  - commented out links to Landuse_PS, LanduseGLC. Use config instead.

2) Mosaic outputs - config'd:

MosaicOutputs_ml.f90
My_Derived_ml.f90
config_Outputs_EMEPSTD

  - added NewMosaic, MOSIAC_METCONC, MET_LCS and Mosaic_timefmt to config
  - in future NewMosaic should replace other systems, but as with much else
    we are currently running partially completed upgrades..
  - also noticed that with new landcover system, outputs such as VG_O3_GR
    only apply to European part of globe, not to e.g. C3_NARC_GRASS. Need
    to modify to cover PFTs or ecosystem definitions.


3) ColumnSource_ml - reduced NMAX_LOC, NMAX_EMS to 5, 300 to avoid problems
   discussed on github issues.

   *  Action needed: Alvaro

4) NEW DEFAULT CHEM - EmChem16mt


NEW::: ZCM_EmChem16mt introduced
  (Dave/Robert/Hannah)

  Significant update of chemistry! Added monoterpenes, simple SQT, replaced
  isoprene chemistry. Fixed PAN rate coefficient bug.

  Contributions from Hannah Imhof and Robert Begstrm included.

NEW::: ZCM_EmChem16mt/Aero2017n.species, .reactions  introduced

   update/cleanup of  aerosol  reactions for N2O5 testing. May change in
   April as testing proceeds.


mk.GenChem  - defaults to new system

Setup_1d_ml - Added cNO3, cNO2 for N2O5 testing


5) Improved Fpart (Robert)
Aqueous_ml

   Corrected use of Fpart in dep calculations
   Expanded list of surrogates (e.g. CWDEP_0p5) for organics

6) BVOC, Dave

Biogenics_ml, emep_Config_mod

   Added explicit EmBio%CLF variable for default (non-Euro) BVOC
    - to be used with new LandInputs files

   Downgraded MEGAN. Now prefer to use GLC/CLM methods (to be commited soon!)

7) Misc

Derived_ml - changed YMD to YM for various not so important outputs (u_ref, Kz, Idirect, etc) to
  reduce size of Base_day.nc . Need to move to config soon!

DO3SE_ml

   Longer names allowed (to cope with CLM,eg BDLF_EVGN_TROP_TREE)

GasParticleCoeffs_ml

   Updated and extended. Higher PAN and HONO deposition.

LandDefs_ml

   Small tidy up, changed sub to dtxt for debug output

Landuse_ml

   Updated to cope with CLM
   Now allows landcover to be different in European and global files

ModelConstants_ml

   Moved GlobBvocMethod to emep_Config
   Extended NLANDUSEMAX to 40

My_Derived_ml

   Changed YMD to YM for mosaic outputs to reduce size of Base_day. This
   should really be done in config one day.

Setup_ml

   Added safety catch on RCT_USED in debug mode

run.pl

   Point to LandInputs_Apr2017 which has GLC-CLM based global use and
   appropriate Inputs files.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th Mar 2017 Dave  rv4_12beta

BIG CHANGE FOR GLOBAL BVOC and also some structural changes

1)  emep_Config_mod.f90 - ** NEW **

  - will take over the non-constant stuff from ModelConstants one day
  - designed to ease merge of emep with ESX and BoxChem (we have an
    esx_Config and Box_Config also
  - currently just has:
       PBL type - with ZiMin, ZiMAN and HmixMethod
       EmBio type, with GlobBvocEmis, IsopFac, TerpFac

  BLPhysics_ml
  Met_ml
  ModelConstants_ml

  - all modified to use emep_Config_mod

  config_EMEPSTD.nml - just added commented out example for PBL%ZiMin

  Note: The _mod suffix is intended also for the merge with ESX/BoxChem -
        - I will use it to denote modules which have been updated/merged.

2) Biogenic changes

Biogenics_ml

  - Added MEGAN_ml within to look after MEGAN-like global BVOC
    (working version. Tripples global isoprene if used. Will be
     improved, but this should be the new default.)
  - now uses BIOTERP for terpene emissions, since APINENE is just one of
    many possible terpenes.

run.pl - linked to Megan4Emep.nc file

ZCM_EmChem09/EmChem09base.species/reactions - modified with BIOTERP

3) Wesely changes

Wesely_ml renamed to GasParticleCoeffs_ml
  - since it has less and less to do with Wesely, and for future ESX merge

4) GenChem changes

  - added option of variable yields on RHS of equations, with |YA_xx| notation, e.g.
    coded for gas and aerosol yields so far, e.g. to allow:
     A + B = |YG_isopO3| gas-phase-products + |YA_isopO3| aerosol-phase-products
    Needs more work.

5) Name changes

  Chem_ml -> ChemFields_ml, since it contained ChemFields_ml!

  CM_ChemSpecs_tmp.f90 ->  ChemSpecs_wrapper.f90 to be slightly more explicit
         and to avoid the mistake of rm CM_* and thinking only GenChem files
         will be removed

6) Defaults for n2o5Hydrolysis set to Smix, not SmixTen
   (THIS WILL CHANGE RESULTS IF USERS HAD FORGOTTEN TO EXPLICITLY SET Smix!)


  Makefile.SRCS - adapted to these changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th Feb 2017 Peter

NetCDF_ml - fixed bug with GOBAL_SOILNOx which had been zero since ???

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th Feb 2017 Peter

Pre-advection of ColumnSources.
Define USE_PreADV=T in config to activate. (otherwise no effect).
The emissions from ColumnSources are distributed along a line.
The length and direction of the line is defined according to winds at each level.
The line is "one-dimensional" in the 2D layer.
The wind is defind only at origin (emission source), it is not varying along
the line. The number of gridcells on the line is equal to the Courant number in
each direction (nearest integer larger than C).

This is to avoid the problem of holes in the concentration when there are
strong wind, since the advection will move pollutants far away, while emissions
are put into the atmosphere only every dt_advec.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22nd Feb 2017 Dave

ModelConstants_ml
Runchem_ml

  - Added DEBUG%datetxt - to add a date string which  can be accessed from
     other modules while debugging. Saves the need for TimeDate_ml,
     print_date etc.

Wesely_ml
  - massive expansion in number of species to cope with 2017 CRI
    chemistry. No change in resuls for EmChem09 though.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st Feb 2017 Dave

Small changes

My_Derived_ml.f90
 -  Removed n1 from print - was not set when DEBUG turned on

Setup_1d_ml.f90
 - Increased length of specname and size of d2index

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th Feb 2017 Peter

The new interpolation method (9th feb) was switched off. Switched on now.
Also improved the selection of data to be read in, as it was reading way too much
for lon lat grids, thereby wasting lots of memory.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th Feb 2017 Peter

Removed the diagnostic "natso2" from the old system:
it was producing a divide by zero.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th Feb 2017 Peter

Removed NTERM (and assign_NTERM). Was not really used.
Allow (eventually) to set hours for start- and enddate in config file.
NB: run.pl changed (slightly), line 1092:
        ."  enddate   = ".date2str($enddate   ,"%Y,%m,%d,000024,\n")

NetCDF_ml: GetCDF_modelgrid can return units and validity (needed for Harmonie).


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th Feb 2017 Peter

Problems from the new interpolation routine (26th Jan) for global grids:
the cyclic longitudes where not taken correctly into account.

The landuse could be numerically large than 1 (1E-15 over), and that caused
negative deposition over south pole for PB210. Added a "max(1,lu_cover)"

Found a few (3?) gridcell at south pole (left corner) in LanduseGLC.nc with 150%
lu coverage. Will replace with correct one.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th Feb 2017 Peter

Support for Lambert conical conformal projection.
Tested for WRF metdata.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th  May 2017  Alvaro

Update for new modules in stallo:
Makefile, run.pl:
- compile with mpiifort instead of mpif90
- execute with mpirun instead of mpiexec

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd  Feb 2017  Dave

Country_ml.f90 - added 199 to cope with non-specific emissions as seen
  in annual Emis_01degGLOBAL_2012_HTAP_MIEC.nc file.

EECCA 2012 beckmark, submitted to AeroCom
  EMEP_dev@0ecbb68_170208alvarov_RGBMEECCA_day_2012.nc
  vilje:~alvarov/work/Benchmark/EECCA.2012/BM_dev@0ecbb68

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st  Feb 2017  Dave

run.pl - used pattern match on EmChems to get emissplit.specials

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th Jan 2017 Peter

Faster and better latlon to latlon interpolation:
integrates exactly, assuming uniform emissions over gridcells

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23rd Jan 2017 Peter      rv4_11_5

Smoother interpolation when lon and lat resolution is not the same, as in TNO7
emissions.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20th Jan 2017 Dave      rv4_11_4

run.pl
- added testv in ProgDir defaults. Most people will have several test versions.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th Jan 2017 Alvaro    rv4_11_3

config_BM-EECCA.nml:
- Add missing output period (eg 'YMD') to WDEP_WANTED.
- Missing since Oct 2016 (svn 3304)

EECCA 2012 beckmark, submitted to AeroCom
  EMEP_dev@ace01da_170117alvarov_RGBMEECCA_day_2012.nc
  vilje:~alvarov/work/Benchmark/EECCA.2012/BM_dev@ace01da

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th Jan 2017 Dave    rv4_11_2

Testing tags

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th Jan 2017 Peter   rv4_11_0

Updated run.pl with the SLURM queue commands for Stallo.
Removed links to natso2 (use DMS in config instead)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th Jan 2017 Dave   rv4_11_0

Re-started tags. We need something to keep track of model changes in
a simple way - as had with svnversion.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th Jan 2017 Peter

New routine that extend arrays across subdomains.
uEMEP: diagonal neighbors.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th Jan 2017 Peter

Faster and better latlon to latlon interpolation:
integrates exactly, assuming uniform emissions over gridcells

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd Jan 2017 Alvaro

Fix pollen forecast crash, issue #18


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th Dec 2016 Alvaro

Update pollen modules (ZD_Pollen), issue #12

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23rd Dec 2016 Peter

Bug when wrf is used: XLAT reading for pole detection was read as a one-dimensional array.
Detected by Massimo.

Reading 3 hourly O3 from top when fileName_O3_Top is set in config file

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20th Dec 2016 Alvaro

Update assimilation modules (ZD_3DVar16)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th Dec 2016 Peter

Sectorwise uemep. For now all sectors included

Map of Ocean NH3 when emissions provided

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th Dec 2016 Peter

GridValues: transformation to and from UTM (Transverse Mercator) projection routines

AeroFunctions.f90, Setup_1d_ml.f90 some simple optimizations (could require more)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th Dec 2016 Heiko

Disabling SURF_AREA and SEA_SALT in config_EMERGENCY, 1.5times faster

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th Dec 2016 Peter

Possibility to choose a limited number of pollutants from each emission file.
Example in config which will take only voc and sox from Emis_GLOB_05.nc:
  emis_inputlist(1)%name     = 'DataDir/Emis_GLOB_05.nc', !example of Fractions type
  emis_inputlist(1)%pollName(1:2)     = 'voc','sox', !example of restricted choice of pollutants

By default (i.e. if the line is commented out), all pollutants are included.


Faster transformation from stereographic (landuse) for fine resolution model grids

dt_advec can be set by config file

removed the "only" in use MPI_Groups_ml. MPI_IN_PLACE is a special variable, and
it does not behave well under certain versions of gfortran (reported by Massimo)

Meaningful error message when Mask file (monthly emissions) not found

Attempt to clean the timings overview

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th Dec 2016 Peter

top vertical level allowed to be exactly = top met level
The code stopped because of numerical differences when they where exactly =.

Better interpolation for fine resolution model grids:
Bilinear interpoaltion is used when going interpolating from a coarse lat-lon grid
into a fine resolution model grid (specially useful for emissions).
Also the interpolation from polarstereographic is now using a finer subdivision of
gridcells; this may however increase the time for interpolating landuse.

(and testing git!)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th Nov 2016 Dave

CB05 chemical scheme files updated. No impact on normal EmChem usage.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th Oct 2016 Alvaro, from dev branch

First git pull request:
- add .gitignore
- update README.md with git usage

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th,24th Oct 2016 Alvaro, 3306-3307

run.pl:
- On FORECAST mode, fix year change for 12UTC meteo.

ZD_3DVar/Analysis/DA_3DVar_ml,
ZD_3DVar16/Analysis/DA_3DVar_ml:
- fix chemgroups type changes after 3290

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th Oct 2016 Agnes, 3305

Country_ml, Emissions_ml
-New sub-regions in Asia added for the UNEP-SR project (IIASA) in
Country_ml. The new sub-region abbrevations are 9 digit long, therefore the
format of writing the emission table into the log file has been changed in
Emissions_ml (before only 4 digits of the country name abbrevations were visible in the emission table).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th Oct 2016, Alvaro, 3304

Derived_ml,My_Derived_ml,config_Outputs_*.nml
- Add output period (eg 'YMD') to WDEP_WANTED variable on OutputDep_config namelist.
  It is no longer needed to edit the source code to change the WDEP output period.
- Improve debug messages (write_debugadv) for 3D outputs.

ModelConstants_ml,Wesely_ml,ZCM_Pollen/Pollen.species:
- Different pollen types have different diameters
- Expand AERO_SIZE, additional CDDEP_* constants.

Units_ml,ZD_Pollen/My_Pollen_ml,Pollen_const_ml,Pollen_ml:
- Update unit conversion for pollen species, taking into account
  the different diameters.
- Redefine 'grains' units, to support deposition.
  Use 'grains/m3' for concentrations ('Gm3' shorthand),
  and 'grains/m2' for deposition ('Gm2' shorthand).

ZD_OZONE/My_Outputs_ml,ZD_Pollen/Pollen_ml
config_FORECAST.nml,config_Outputs_CAMS50.nml:
- Update pollen extra hourly output (old style). Only for debug.
  To be removed in the near future.
- Derived USET pollen output. Only for debug.
  Meant to replace pollen extra output.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th Oct 2016, Alvaro, 3303

ModelConstants_ml,Derived_ml,My_Outputs_ml,ColumnSource_ml,config_EMERGENCY.nml:
- Move variable DEBUG_COLSRC to DEBUG%COLSRC,
  so it can be read from ModelConstants_config.

Gravset_ml,config_Outputs_EMERGENCY.nml:
- Only apply gravset to ASH with 7 or 9 bins.
- Ash particles settling velocity output (USET) for debug/test.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th Sep 2016, Alvaro, 3302

Derived_ml:
- fix unit conversion for FLYmax6h output
- correct DEBUG_COLSRC messages

config_Outputs_EMERGENCY.nml:
- fix ASH column output entry

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th Sep 2016, Heiko, 3301

Derived_ml:
-add kmax to select all levels to COLUMN output instead of k20

config_Outputs_EMERGENCY.nml,config_EMERGENCY.nml:
- start using namelist for Volc-emergencys, start updating output for VOLCEX16

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28-29th Sep 2016, Agnes, Alvaro, 3295-3300

ModelConstants_ml,Runchem_ml:
- New config variable USE_NOCHEM, read from ModelConstants_config namelist,
  allows to bypass chemistry call on subroutine runchem (Runchem_ml)

Derived_ml,config_Outputs_EMERGENCY.nml:
- Fix flight level definitions, eg FL200 means 20.000 feet.

ColumnSource_ml:
- Increase NMAX_EMS

config_EMERGENCY.nml,config_Outputs_EMERGENCY.nml:
- USE_NOCHEM=T, USE_AOD=F (currently needs chem)
- Update output.

ModelConstants_ml,PhyChem_ml,Makefile.SRCS:
- Ash gravitational settling (gravset) when USE_ASH=T
- Remove USE_GRAVSET variable, use USE_ASH instead.
- Compile and Gravset_ml out of the box.

Gravset_ml:
- Fix 3293 update

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th Sep 2016, Dave , 3294

Make changes that I thought 3284-90 had done for endif, enddo and endfunction.
Odd.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23rd Sep 2016, Birthe, Agnes, Alvaro, 3291-3

Gravset_ml:
- Update module following 3290
- Clean up

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st Sep 2016, Dave , 3284-90

Some renaming (essentially all modules, and GenChem.pl):

  endfunction -> end function
  endsubroutine -> end subroutine
  endtype -> end type
  endselect -> end select
  enddo -> end do

  chemgroups % ptr -> chemgroups % specs

  Some changes in ZD_ but not completed

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th Sept 2016 Alvaro, 3283

mk.OpenSource,config_Open.nml:
- Update release version and year
- Add configuration file for Open Source runs

Makefile.Open,modrun.sh
- Update netCDF version as in userguide
- Use nc-config for netcdf options
- Remove meteo link step on modrun.sh

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd Sept 2016 Alvaro, 3280-82

rv4_10:= Open Source 2016

Tag version version with:
svn copy \
  https://svn.met.no/unimod/trunk -r3280 \
  https://svn.met.no/unimod/tags/rv4_10 -m "2016 Open source"

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd Sept 2016 Alvaro, 3279

Derived_ml,EcoSystem_ml,MPI_Groups_ml,ModelConstants_ml,MosaicOutputs_ml,
My_Derived_ml,Nest_ml,Output_hourly,OwnDataTypes_ml,PhyChem_ml,Unimod,
ZD_OZONE/My_Outputs_ml,config_Outputs_EMEPSR.nml,config_Outputs_EMEPSTD.nml:
- Clean-up old comments and re-format.

PS: Peter cleared all his remaining files over the phone.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st Sept 2016, Dave and Hannah, 3278

NEW! utils/Rd_ncsites.py - script to read and plot sites_xxxx.nc files.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31st August 2016, Dave and Hannah, 3276-3277

AeroFunctions_ml
ChemFunctions_ml
   Clean-up.

NEW! utils/Rd_ncsondes.py - script to read and plot sondes_xxxx.nc files.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th-30th August 2016 Alvaro, 3274-5

My_Derived_ml:
- Fix write/format. Error introduced on 3255-3259 (July 2016).

My_Derived_ml,MosaicOutputs_ml:
- Fix missing DDEP. Error introduced on 3255-3259 (July 2016).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th August 2016 Alvaro, 3273

AOTnPOD_ml,Chem_ml,Derived_ml,ModelConstants_ml,MosaicOutputs_ml,
MosaicOutputs_ml,MPI_Groups_ml,My_Derived_ml,Nest_ml,Output_hourly,
PointSource_ml,TimeDate_ExtraUtil_ml,Unimod:
- avoid gfortran pedantic warnings, such as unused variables.
- In MPI_world_init (MPI_Groups_ml) explicitly define the integer kind
  as sizeof kind is system dependant.
- In Init_My_Deriv (My_Derived_ml) group USE_uEMEP 2D/3D wanted output
- In init_nest (Nest_ml) use nctime2string instead of nctime2date for
  warning messages.
- In hourly_out (Output_hourly) replace non-standard continuation line
  write descriptor "$" by f90 standard write(..,adance='no').
- In errorfunctionc (PointSource_ml) use PI from PhysicalConstants_ml instead
  of local varaible.
- In get_pointsources (PointSource_ml) replace if/elseif/else by select/case
- In readstacks (PointSource_ml) use coord_in_processor

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th August 2016 Dave, 3271-3272

cleanups:

Runchem_ml
SmallUtils_ml
SOA_ml
TimeDate_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th August 2016 Peter, 3270

"gfortran pedantic" cleanup of Emissions_ml.f90 and GridValues_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th and 25th August 2016 Alvaro, 3268-9

Makefile:
- Do not use option -fpe-all=3 to compile NetCDF_ml.f90 with gfortran.
- Fix pollen forecast setup: MACC compilation target did not include pollen species.
  This error was intoduced on SVN 3205-3209 (May 2015).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th and 22nd August 2016 Peter, 3265-7

GridValues_ml.f90
Bug when WRF is used in lon lat projection.
Tested compilation, but not with wrf metdata.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th August 2016 Alvaro, 3264

Nest_ml:
- Fix bug introduced on 3261 (July 2016).
  MODE_SAVE='END' did not work, Nest output was written every NHOURSAVE hours.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th August 2016 Alvaro, 3263

Makefile
- Comilation target MACC-EVAan, used on CAMS50 VRA runs,
  uses new data assimilation modules (ZD_3DVar16)

ZD_3DVar16/Analysis/DA_3DVar_ml,config_ANALYSIS.nml:
- Use 'SPC' string keyword on Bnmc_filename variable
- Analysis every hour by default.

ZD_3DVar16/Analysis/DA_Obs_ml:
- Write total #obs on log file.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th July 2016 Alvaro, 3261-3262

Nest_ml:
- Replace integer variable MODE by string variables MODE_READ and MODE_SAVE.
- Old integer modes can be reproduced as follows:
    MODE  MODE_READ MODE_SAVE Description
      0   'NONE'    'NONE'    do nothing
      1   'NONE'    'NHOUR'   write every NHOURSAVE
      2   'NHOUR'   'NONE'    read  every NHOURREAD
      3   'NHOUR'   'NHOUR'   read/write every NHOURREAD/NHOURSAVE
     10   'NONE'    'END'     write at end of run
     11   'START'   'NONE'    read at start of run
     12   'START'   'END'     read at start and write at end of run
     20   'NHOUR'   'END'     write at end   of run and read  every NHOURREAD
     30   'START'   'NHOUR'   read  at start of run and write every NHOURSAVE
    100   'MONTH'   'NONE'    read monthly
- New read/write modes to obtain FORECAST mode behaviour
    MODE_READ='FORECAST'  read at the start of run, if the files are found
    MODE_SAVE='FORECAST'  write every OUTDATE(1:FORECAST_NDUMP)
- See file header for the full list of supported modes.

config_EMEPSTD.nml,config_EMEPGLOB.nml,config_IMPACT2C.nml:
- set for "do nothing" nesting mode
- add available nesting modes as comments

config_BM-EECCA.nml:
- set for "do nothing" nesting mode

config_FORECAST.nml,config_ANALYSIS.nml,
config_FORECAST_CitySR.nml,config_EMERGENCY.nml:
- set for "FORECAST" nesting mode

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th July 2016 Alvaro, 3260

run.pl:
- correct given/when syntax in generate_updated_femis

ZCM_Emergency/Eemep.species:
- add SHIPNOX to minimal chemestry set (Eemep).
  Eemep uses EmChem09soa's EmChem09soa, and stopped working
  after the incusion of SHIPNOX into emissplit.*.nox (SVN 322, June 2016)

config_Outputs_CAMS50.nml:
- comment empty OutputMisc setup

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th July 2016 Alvaro, 3255-3259

ModelConstants_ml,Derived_ml,My_Derived_ml,EcoSystem_ml,Unimod,
config_Outputs_*.nml,config_BM-EECCA.nml:
- New variable IOU_KEY define strings shorthands
  for IOUs: yearly 'Y', montly 'M', daily 'D', hourly mean 'H' and
  hourly instantaneous 'I' (ModelConstants_ml).
- Replace numerical IOU codes by string shorthands on output definitions:
  IOU_YEAR(2) by 'Y', IOU_MON(3) by 'YM', IOU_DAY(4) by 'YMD',
  IOU_HOUR(5) by 'YMDH', IOU_HOUR_INST(6) by 'YMDI'.

OwnDataTypes_ml,Nest_ml,AOTnPOD_ml,ZD_Pollen/Pollen_ml:
- Redefine type(Deriv)  so %iotype is a string (OwnDataTypes_ml).
- Redefine type(O3cl_t) so %iotype is a string (AOTnPOD_ml).

OwnDataTypes_ml,Derived_ml,My_Derived_ml,MosaicOutputs_ml:
- New type(typ_s1ind), like type(typ_si)  with %ind a string instead of integer.
- New type(typ_s5ind), like type(typ_s5i) with %ind a string instead of integer.
- Replace type(typ_si)/type(typ_s5i) by type(typ_sind)/type(typ_s5ind).
- type(typ_si) and type(typ_s5i) could be removed at a later stage,
  when they are no longer used in the code.

Makefile
- Test different module configurations for vilje
- Add ifort option -assume noold_maxminloc, so a minloc(...MASK=.false.)
  returns zero as gFrotran does.
- Add ifort option -fpe-all=3 for NetCDF_ml.f90 to avoild a div0 error
  deep in netcdf/4.3.1 and later versions when compiling with DEBUG=yes.

Derived,My_Derived_ml:
- Support 3D USET MISC output.

PhyChem_ml,ZD_3DVar/DA_ml,My_3DVar_ml,ZD_3DVar16/DA_ml:
- Remove DEBUG_DA_OUTPUT parameter, use 3DVAR_FG output USET instead.

ZD_Pollen/Pollen_ml:
- Ensure pollen species are found in species_adv%name and EMIS_BioNat arrays
- Introduce a feature/bug of SILAM in order to match their code.
- Switch OFF pollen calculations if dump/restart file is found empty/corrupted.
- Ensure pollen dump/restart record is written to file.

DOCS/ModelOutput.md
- Short documentation for the output namelist configuration.

config_ANALYSIS.nml,ZD_3DVar16/DA_ml,Analysis/DA_3DVar_ml:
- move DA namelists into config_emep.nml

config_Outputs_CAMS50.nml,ZD_3DVar/Analysis/DA_3DVar_ml,ZD_3DVar16/Analysis/DA_3DVar_ml
- New USET 3DVAR_FG OutputMisc

ZD_3DVar16/Analysis/DA_3DVar_ml,DA_Obs_ml
- remove xn_an from get_innovations and ObsOper_Fill

ZD_3DVar16/DA_Util_ml,Makefile,Analysis/DA_3DVar_ml,B_NMC/Util_ml
- rename Utils_ml to DA_Util_ml

ZD_3DVar16/Analysis/DA_Obs_ml.f90
- rewrite ObsOper_Fill
- remove 4 point interpolation

ZD_3DVar16/Makefile,Makefile.conf,DA_Util_ml,
ZD_3DVar16/Analysis/DA_3DVar_ml,DA_Obs_ml
ZD_3DVar16/tools/go,go_rc,go_file,B_NMC/c3po_datafile:
- Replace GO by Unimod modules on DA_Obs_ml and DA_3DVar_ml
  - Move T_Domains to DA_Util_ml
  - Remove unused GO modules go_rc.F90 & go_file.F90
- Support make MACC-3DVar16 DEBUG=yes

ZD_3DVar16/DA_ml:
- Remove #ifdef with_ajs.

ZD_3DVar16/Analysis/DA_Obs_ml.f90
- Move obsData setup out from ObsOper_Fill to read_obs

rv4_9/*
- Remove failed tag that ended up as subdirectory (3251)...

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th July 2016 Alvaro, 3250-3254

Tag version used on 2016 status runs: r3245 from June 28th.

svn copy \
  https://svn.met.no/unimod/trunk -r3245 \
  https://svn.met.no/unimod/tags/rv4_9 -m "2016 Status runs"

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th July 2016 Alvaro, 3249

TimeDate_ExtraUtil_ml:
- Add optional parameter mode to date2file and date2str interfaces.
  Use mode='YMDH' to avoid replacing minutes and seconds in a string/file.
- Add optional parameter mode string2file interface.
  Use last=1 to pharse date keywords only on the basename of the file template.
- Remove cdYMDH2str and YMDH2str functions (date2string inferface),
  added in 3247 (July 2016).
- Merge cd2str_add/int2str_add into cd2str/int2str functions.
- Comment date2file and date2str interfaces to give an overview of the
  parameters.

Nest_ml:
- Use date2file(mode='YMDH') and date2str(mode='YMDH')
  to avoid replacing minutes and seconds in the read and write file,
  as was intended in 3247.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th July 2016 Peter, 3248

Reversed the changes in Nest_ml.f90, as it did not work properly.
(init_icbc needed also a 'YMDH_only' flag but that was difficult to integrate
into the library for date2file)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th July 2016 Peter, 3247

A few upgrades that were waiting.
NetCDF_ml.f90: better interpolation from general projection
Nest_ml.f90 TimeDate_ExtraUtil_ml.f90 : date2string with YMDH_only option,
 to avoid replacing minutes and seconds in the read and write file.
Emissions_ml.f90 : can choose to read only one pollutant from emission file,
use for instance emis_inputlist(3)%pollName(1) = 'voc' in config file.
Derived_ml: Units for uEMEP

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29 June 2016 Dave, 3246

SOA_ml - some cleaning of debug code. No change in values

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 June 2016 Dave, 3245
==============
rv4.9: Status 2016 runs
==============

ZCM_EmChem09soa/VBS_nonvolatile.species - add NONVOLPCM group to POM_F_FFUEL

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 June 2016 Alvaro, 3244

Makefile:
- make SR-EMEP is now equivalent to make EMEP

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 June 2016 Dave, 3243

BUG FIX! Hopefully....

SOA_ml -
  (i)  now add BGND_OA into xn(OM25_BGND, ) before first loop, and
  (ii) (biggest problem) do not have BGND_OA in loop to get COA values.
  (iii) removed old commented out XSOA stuff, to clean up.

  Fixes labelled with J16 and BUG FIX

RunChem_ml - add logical first_tstep to help OrganicAerosol know when to do (i)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27 June 2016 Alvaro, 3241-3242

Reintroduce Log.chage entries to 3231-3234, lost in 3235.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27 June 2016 Agnes, Dave  3240

ZCM_EmChem09soa/
  emissplit.specials.pm25
  emissplit.specials.pmco - NEW!

  -  Added 9,10 German codes:
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27 June 2016 Peter, Anna 3239

Bug when wdep_prec was not included in output: it gets undefined causing the
code to write in the wrong place in memory.

Aqueous_n_WetDep_ml.f90 Log.changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 June 2016 Svetlana 3238

Nothing new, just corrected some bugs occured under the previous commitment
in config_Output and Modrun-link

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 June 2016 Svetlana 3235

SeaSalt_ml.f90, ModelConstants_ml.f90, config_*.nml:
Several alternatives for whitecap fraction calculations: Callaghan etal. 2008;
Monahan etal.1986; Norris eta. 2013
Selects from USES%WHITECAPS : "Callaghan" - default

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22 June 2016 Peter 3234

Moved "USE_OCEAN_DMS=.true." higher "up". DMS was not set early enough
and the emission maps did not come out in output (Emis_mgm2_DMS).
Possibly this also change DMS the first month, since both old and new would
have been included?

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21 June 2016 Alvaro 3231,3233

Units_ml,
config_Outputs_EMEPSTD.nml,config_Outputs_EMEPSR.nml,config_BM-EECCA.nml:
- rename ug:PM, ugC:PM, ugN:PM and ugS:PM units (Units_Scale)
      to ug_PM, ugC_PM, ugN_PM and ugS_PM,
  so Derived variable names follow the CF-convention.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17 June 2016 Peter, Dave 3230

Emissions_ml:
moved allocations before call femis and inside "first_call".

EmisGet_ml, EmisSplit: stop if country not found.
Country_ml: redefined some indices
NetCDF: Ndiv=nint(5*...) otherwise may get too small for fine to coarse grids.
(this last change can slightly change results (noise only) compared to early versions!)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17 June 2016 Agnes, 3229

Country_ml - Added 'new' countries to Country_ml (KZT, TMT, UZT), which have
been divided into sub-areas before.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 June 2016 Alvaro, 3226-3228

Reintruduce SOA contribution to PM groups.
The PM part of SOA (PART_OM_F) was unintentinally removed from PMFINE and PM10
groups in 3118 (Jan 2016).

SOA_ml,ZD_OZONE/My_Outputs_ml,
ZCM_EmChem09soa/VBS_nonvolatile.species
ZCM_vbs_tests/VBS_help.species:
- Rename PART_OM_F to OM25_P
- Rename OM25_SUM to OM25_P
- Give OM25_P OC Extinc characteristics (for AOD calculation),
  as was the case for PART_OM_F. This will inlcude OM25_P in AOD_GROUP.
- Add OM25_P to PM10 and PMFINE groups.

config_Outputs_EMEPSTD.nml,config_Outputs_EMEPSR.nml,config_BM-EECCA.nml:
- Rename PART_OM_F to OM25_P
- Replace PART_OC10 and PART_OC25 outputby OM25 OMCOARSE (ugC:PM) output

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 June 2016 Agnes, 3224-3225

run.pl - changed links to volcano emissions and locations.
         New data files for volcano emissions were made. We include now
         passive degassing from three volcanoes: Stromboli, Etna, Vulcano. We
         use emissions as reported by CEIP in the new files, not our
         defaults. This will lead to a significant decrease of SOx from VOL for
         recent years, while there will be an increase for the 1990s and early
         2000s.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16  June  Dave, 3223

ZCM_EmChem09soa/EMISSPLITS uodated:

    emissplit.defaults.nox - added SHIPNOx column
    emissplit.specials.nox - for SHIPNOx, using codes 350 and (HTAP) 1002 for ships

    emissplit.specials.pm25 -  based upon IIASA/ECLIPSE updates of Jun 2016
    emissplit.specials.pmco -  based upon IIASA/ECLIPSE updates of Jun 2016

run.pl - added EmChem09soa to list of chems that result in use of EMISSPLIT files.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th  June  Peter, 3222

Read emissions in GNFR sectors. Updated the "GNFR mappings" in EmisDef_ml.f90
To use GNFR, simply use the GNFR emission file in config.
For now only 1 version exist:
emis_inputlist(1)%name  = 'DataDir/GNFREmis_EMEP01.nc',

Corrected a bug for zero order advection (used only by me probably).
Removed a print out of x lines with +++++++++ in massbudget

modified: Emissions_ml.f90 EmisDef_ml.f90 Advection_ml.f90 MassBudget_ml.f90
NetCDF_ml.f90 Log.changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3  June  Dave, 3221

MassBudget_ml - added creation of MassBudgetSummary.txt for all runs, with
   summary of budget for all species.
   Deleted totox stuff (was from old code)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th May Dave, 3220

AeroFunctions  - added & to allow compilation
Log.changes    - re-order text in Log.changes to be in order
config_Outputs_EMEPSTD - reset HMIX to monthly, not hourly
config_EMEPGLOB.nml - added DMS.nc usage

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th May Svetlana,Anna 3219
AeroFunctions_ml - WetRad m -> cm conversion
BoundaryConditions_ml.f90 - 2014 Mace Head corrections update

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th May  Svetlana 3218

SeaSalt_ml - bug fixed: radius in [cm] should be instread [um]
             Uses updated cmWetRad from AeroFunctions_ml
AeroFunctions_ml - cmWetRad is included
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

24th May Dave, 3217

mk.testX modified to use ifort, not gfortran (stallo's gfortran is too old),
  and to use !TSTEMX string as marker for test code. (TSTEMX = test of EMEP and/or ESX)

AeroFunctions_ml modified with !TSTEMX. Had to remove one CheckStop since
  the system doesn't yet cope with netcd/MPI links
SmallUtils_ml modified with !TSTEMX
TimeDate_ml   modified with !TSTEMX

(Reminder, usage is e.g. mk.testX AeroFunctions_ml.)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th May Peter, Svetlana 3216

DMS from Ocean file (DMS.nc), switched on by default in config_EMEPSTD.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23rd May, Peter 3214-5

Possibility to choose zero order horizontal advection.
set hor_adv0th=.true. in Advection_ml

Can be used for testing "Bott" effects.
(For dominant point sources, Bott can give strange patterns in the neighbor cells)

Program stops if the emission file is not found

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th May, Alvaro 3213

run.pl:
- Reintroduce $emisyear for MACC14 grid, removed in 3199 (May 11th).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th May, Peter 3210-2

Tested sector grouping (defined new categories for timefactors, height, split
and used them instaed of sector 1 )
Put back the ISEC_NAT and ISEC_SHIP, which should not have been removed.
Defined SECTORS_NAME='SNAP' to steer sector grouping.
SECTORS_NAME='GNFR' ready to use when we get emissions.
Small changes in runtime checks.

Small optimization of a factor in Timefactors_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th May, Alvaro 3205-3209

run.pl,config_BM-EECCA.nml,config_EMERGENCY.nml,
config_FORECAST.nml,config_FORECAST_CitySR.nml,config_ANALYSIS.nml:
- Update meteo definition to be consistent with 3203 (May 15th).
  Move meteo variable from INPUT_PARA namelist to ModelConstants_config namelist.
- Update DataPath to be consistent with 3186 (May 6th)
  DataPath in Machine_config namelist was missing '/Data' at the end.

Makefile,mk.GenChem,ZCM_Pollen/Pollen.*,ZCM_Pollen/*
- Move Pollen.species and Pollen.reactions to his own ZCM_Pollen
- make Pollen target will compile a minimum chemistry set (Eemep) for pollen
  tracers experiments.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th May, Peter 3204

More flexible definitions of sectors.
Now we can define new sectors grouping (like GNFR).

NB: it is easy to get confused, about what is mapped and what is not!

Definitions:
NSECTORS: number of sectors defined in emission file
N_TFAC: Number of timefactor classes defined
N_HFAC: Number of height distribution classes defined
N_SPLIT: Number of speciation classes defined
In principle these could all be different.

The mapping arrays give the value of the index for each of the sector emissions:
sec2tfac_map
sec2hfac_map
sec2split_map

The values are set (they are actually pointers) by the maps defined.
For example if "USE_SNAP=T", the emissions are mapped to the indices using:
SNAP_sec2tfac_map
SNAP_sec2hfac_map
SNAP_sec2split_map
For now they simply return the same value: SNAP_sec2tfac_map(i)=i

Adding new sectors can be done by defining these 3 maps for the new sectors.

Not fully tested yet!

modified: Timefactors_ml.f90 ModelConstants_ml.f90 EmisDef_ml.f90 EmisGet_ml.f90
Emissions_ml.f90 Log.changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th May, Peter 3201-3

Moved the definition of meteorological path into config file.
set the path with the exact version (metdata_VERSION) if you want to be
sure to run with a constant version of the meteo!

Also DegreeDays is now set automatically (or can be defined manually in config
use "DegreeDayFactorsFile=/MY/PATH/HDDMYNAME.nc").
keyword "GRID" defined in run.pl (and put by run.pl into config); this is to
avoid situations where definitions in the config and run.pl are defined differently.
(that is also the reason that I couldn't move entirely &INPUT_PARA into the code)

startdate and enddate variables moved to ModelConstants (was in TimeDate).

Lot of files modified:
Sites_ml.f90 ColumnSource_ml.f90 Derived_ml.f90 GridValues_ml.f90 OutputChem_ml.f90
TimeDate_ExtraUtil_ml.f90 Unimod.f90 Timefactors_ml.f90 ModelConstants_ml.f90
BoundaryConditions_ml.f90 Met_ml.f90 run.pl Log.changes config_EMEPSTD.nml
config_EMEPGLOB.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th,13th May, Alvaro 3199,3200

run.pl,config_FORECAST.nml:
- Update $PollenDir/$EmergencyDir paths for development and production.
- New grass pollen input files.

Output_hourly,ZD_OZONE/My_Outputs_ml,ZD_Pollen/My_Pollen_ml:
- Pollen debug: output 1-pollen_released/pollen_total instead of pollen_left.

ZD_Pollen/Pollen_ml,Pollen_const_ml:
- New grass pollen code. grass_mode='linear' for old grass calculation
  and grass_mode='gamma' is the new one.
- Remove Pollen_left and Pollen_rest variables, use R instead.
- Use grass_end instead of grass_start+grass_len.
- Reorganize parts of the module to improve readability.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th May, Dave,Alvaro 3197,3198

run.pl:
- changed = to eq on lines 471, 472, 797, 801
- fix warning on line 456

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th May, Alvaro 3194-3196

ZD_3DVar16/Makefile*,ZD_3DVar16/Analysis/DA_3DVar_ml
- Updates the new data assimilation modules Makefile.
- Remove NO_UPDATE_UNOBSERVED compilation option

ZCM_EmChem09/EmChem09base.species
- Add SO2 to the DAOBS grup, used for data assimilation.

ZD_3DVar16/Analysis/DA_3DVar_ml
- Encapsulate timing options for code development.
- Remove unused/obsolete use_chisq,use_unobserved,nchemnoobs,ichemNoObs,du_loc...
  variables and related code (update_unobserved)
- Remove unused/obsolete interpolation_method variable and related code

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th May, Peter 3193

uEMEP: integrated the advection uemep part into the regular advection routine.
Gives idebtical advection treatment instead of approximate as before.

Moved loc_frac to EmisDef

some small loop optimization in advection routine.

Bug in write_klev NetCDF (Ai defined with kmax instead of kmax+1)

modified: Advection_ml.f90 Emissions_ml.f90 EmisDef_ml.f90 Derived_ml.f90
My_Derived_ml.f90 NetCDF_ml.f90 GridValues_ml.f90 Log.changes run.pl

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th May, Alvaro 3187-3192

Derived_ml,My_Derived_ml,Output_hourly,config_Outputs_EMERGENCY.nml:
- New MISC Derived output type for Volcanic ASH (eEMEP) runs
  output the 6h maximum of a model species (FLYmax6h:SPEC)
  or group of species (FLYmax6h:GROUP) over a range flyght levels.
- FLYmax6h:GROUP MISC Derived type (set in OutputSize_config namelist)
  replaces Output_hourly MAX6Hgroup output type
  (set in MY_OUTPUTS="EMERGENCY" in My_Outputs_ml).

Emissions_ml:
- Remove unused "use ChemGroups_ml,only: PPM25_GROUP"

GridValues_ml:
- subroutine coord_check is now public

Chem_ml,ColumnSource_ml,NetCDF_ml:
- fix small errors from `make eEMEP DEBUG=yes`

Unimod,PhyChem_ml,
ZD_3DVar/My_3DVar_ml,Analysis/DA_3DVar_ml:
- Compatibility with new 3DVar modules (ZD_3DVar16)
  - Add calls to DA_3DVar_Init/DA_3DVar_Done;
  - Add status output variable to main_3dvar.

Makefile,ZD_3DVar16/*
- New 3DVar modules. Some of this modules will be removed
  as functionality is implemented using standard Unimod modules.

config_Outputs_CAMS50.nml:
- Set most of CAMS50 output as IOU_HOUR_INST

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th May, Peter, Dave 3186

Clean up of some emission linking.
Emissions and pathes must be set in config file. The linking by run.pl
for emissions will not necessarily work unless you know what you are doing.

ASCII emissions (gridsox...) will now also accept the "capital format" (gridSOx...).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th May, Peter 3185

uEMEP:
included HDD timefactors in uemep and moved diffusion into advecdiff_Eta

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd May, Alvaro 3179-3184

Output_hourly,ZD_OZONE/My_Outputs_ml
- The following hourly types produce output available from Derived:
  ADVppbv, BCVppbv, ADVugXX, BCVugXX, ADVugXXgroup, BCVugXXgroup,
  PMwater, PMwaterSRF, Z_MID, dZ_BND, COLUMN, COLUMNgroup,
  D2D_inst, D3D_inst, D2D_accum, D3D_accum, D2D_mean, D3D_mean.
- This output types are disabled and their usage in
  set_output_defs (My_Outputs_ml) will produce a run time error.
- If needed, these hourly output types (except D2D/D3D)
  can be enabled by setting ENFORCE_HOURLY_DERIVED=.false. in Output_hourly.

ModelConstants_ml,My_Derived_ml,Derived_ml,NetCDF_ml:
- New user defined variables num_lev3d,lev3d (ModelConstants_ml)
  hold the number and list of levels to be included on Derived 3D output.
- New user defined variable lev3d_from_surface (My_Derived_ml),
  indicate that the levels listed in lev3d are from source.
- num_lev3d,lev3d,lev3d_from_surface are read in OutputSize_config namelist (My_Derived_ml).
- By default all model levels, from model top to surface,
  will be outputted for 3D Derived output.

Derived_ml,My_Derived_ml:
- Changes to 3d MISC output:
  - PM25water, previously called PM25water3d, outputs PM25_water (ambient).
    Note that 2d version outputs PM25_water_rh50 (50%rh, 20C);
  - New PM25, same as 2d output;
  - New PM25_wet/PM10_wet, same definition than PM25_rh50/PM10_rh50,
    but with PM25water at ambient conditions.
  - Z_BND/ZMID, same as in Output_hourly, previously called Zbnd_3d/Zmid_3d.
  - New dZ_BND, same as in Output_hourly, output level thickness.
- New COLUMN:GROUP MISC output. Same as COLUMN output, but for groups.
- All new MISC types are can be read from OutputConcs_config namelist.
- Increase MAX_NUM_DERIV3D to 16.
- Reimplement character(len=..) trick from SVN 3000 (May 2015), removed in 3173.
- Clean-up, reformat &c.

Derived_ml,OutputChem_ml:
- Move function wanted_iou from OutputChem_ml to Derived_ml.
- Rewrite update d_2d/d_3d of IOU_YEAR,IOU_MONTH,IOU_DAY,IOU_HOUR
  in subroutine Derived. IOU_INST and all IOU_YEAR,..,IOU_HOUR
  are updated by default. Optional argument ONLY_IOU, makes possible to
  update only IOU_INST and IOU_HOUR (call Derived(..,ONLY_IOU=IOU_HOUR)).
- Wrtchem optional argument ONLY_HOUR makes possible to write and reset only
  IOU_HOUR and IOU_HOUR_INST outputs (call Wrtchem(ONLY_HOUR=IOU_HOUR).
- This options will be used on FORECAST mode, to produce "zero hour" output.
- FORECAST mode Output_fields shows that finished writing to filename_iou(iotyp),
  by adding a line into the corresponding *.msg file.

ZD_OZONE/My_Outputs_ml,config_Outputs_EMEPSTD.nml
- Default hourly output is no longer o3_3m in *_hourExtra.nc.
- The new hourly output is SURF_ppb_O3 in *_hourInst.nc

ZD_OZONE/My_Outputs_ml,config_Outputs_CAMS50.nml
- Move all MACC_EVA/MACC_ENS hourly output to OutputConcs_config.

NetCDF_ml:
- Adapt Init_new_netCDF and partial rewrite CreatenetCDFfile
  to accommodate different output level selections.
- New procedures in CreatenetCDFfile should improve its readability:
  - function   define_var: define variables and their attributes.
  - subroutine write_klev: write vertical level variables.

config_Outputs_*.nml:
- Add examples of 3D settings to OutputSize_config.

ModelConstants_ml, Output_hourly:
- Rename hourly output defined on My_Outputs_ml,
  as Derived can also produce 3D hourly output.
  Change default ending from "_3Dhour.nc" to "_hourExtra.nc".
- Move deprecated parameter IOU_YEAR_LASTHH from ModelConstants_ml to Output_hourly

ModelConstants_ml,NetCDF_ml,Output_hourly,TimeDate_ExtraUtil_ml,AOTnPOD_ml,Nest_ml:
- Rename IOU_3DHOUR to IOU_HOUR_EXTRA, as Derived can also produce 3D hourly output

Makefile:
- On precise machines use nc-config instead of nf-config
  to configure NetCDF libraries

Log.changes:
- Sort entries for 3175-3178 in chronological order.

ModelConstants_ml,PhyChem_ml,OutputChem_ml,TimeDate_ExtraUtil_ml:
- Rename FREQ_3DHOURLY to FREQ_HOURLY.
- Apply FREQ_HOURLY to all hourly types.

MPI_Groups_ml,Unimod:
- New paramenter MasterPE=0 (MPI_Groups_ml).
- Define MasterProc=(me==MasterPE) (Unimod).

PhyChem_ml,ZD_3DVar/My_3DVar_ml:
- Replace (me==0) by (MasterProc).
- On FORECAST mode, call Derived(..,ONLY_IOU=IOU_HOUR) and
  call WrtChem(ONLY_HOUR=IOU_HOUR) to produce "zero hour" output.
- On ANALYSIS mode:
  - DEBUG_DA_1STEP will return after main_3dvar.
  - DEBUG_DA_OUTPUT will produce an extra IOU_HOUR_INST record before main_3dvar.


ZD_3DVar/DA_ml,
ZD_3DVar/Analysis/chitox_ml,DA_Bias_ml,DA_3DVar_ml,DA_Obs_ml
ZD_3DVar/B_NMC/Unimod_B_nmc,covmat_ml:
- Rename debug parameters DEBUG_DA

run.pl:
For MACC14 grid
- Update emission path;
- Do not link emission files, use namelist instead.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
03 May 2016, Agnes 3177-3178

Country_ml:
- New country codes added for Latin America and Vietnemese sub-regions (needed
for using the recent ECLIPSE v5a global emissions)
- New codes are:
HANO  238 Hanoi
NVIE  239 North Vietnam
RVEI  240 Rest of Vietnam

BOLV  241         Bolivia
CARB  242         Caribbean
CEAM  243         Central America
COLO  244         Colombia
ECUA  245         Ecuador
PARA  246         Paraguay
PERU  247         Peru
URUG  248         Uruguay
VENE  249         Venezuela

241-249 were included in 'OLAM  227 Other_Latin_America' before

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd May, Peter 3175-6

Included vertical advection in uemep (is non-negligible for single gridcell budgets).
Added a new dimension to local_fraction array, so that it can compute results
for several sectors/components in one run. (not implemented yet)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th April, Peter 3174

INQUIRE(directory=trim(DataPath(i)) in ModelConstants_ml, replaced
by an "open".
The INQUIRE(directory form did not fit both intel and gfortran:

does not work for gfortran:
!     INQUIRE(directory=trim(DataPath(i)), exist=exist)!intel.

does not work for intel:
!     INQUIRE(file=trim(DataPath(i)), exist=exist, action = 'read')!gfortran.

does not work without action='read':
     open(IO_TMP,file=trim(DataPath(i)), iostat=iostat, action='read')!

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26-27th April, Alvaro 3172-3173

Emissions_ml:
- Replace str_replace/num2str by key2str calls.
- Replace me==0 by MasterProc.
- Clean up.

SmallUtils_ml:
- Remove str_replace subroutine and num2str interface&functions

ZD_OZONE/My_Outputs_ml:
- Remove extra/unnecesary "character(len=24)" added on SVN 3000 (May 2015).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22th April, Peter 3170-1

Nest_ml: MODE=30, Read at start of run and write every NHOURREAD

Small bug corrected for uEMEP (diffusion).
(adds a few % to local fraction)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th April, Alvaro 3168,3169

ModuleTester.f90, Makefile:
- New tester program for modules with self_test routines
- Example: make TEST && ModuleTester SmallUtils_ml

SmallUtils_ml
- Extend num2str/key2str output to 32 characteres to avoid write overflow errors
- Comment print messages on num2str to avoid recursive io errors
- Extend self_test format for 1.23e19 to f24.2 to avoid formatting errors
- Fix bug on real version of key2str.
- key2str returns unchanged input when keyword is not found.
- Improve key2str self_test comments

TimeDate_ExtraUtil_ml
- Debug/fix self_test

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th April, Dave  3167

testing system:

NEW: mk.testX and utils/fmkmf

Usage: e.g.  mk.testX  SmallUtils.f90

This will create a small test program testX_SmallUtils, and a Makefile
testX_Makefile_SmallUtils. The code will be compiled and run.

Requirement: to run this, some code at the end of the module has make
a proper program, but be commented out this !DSX (sorry for the DS, this
was TSTESX in ESX and I ran out of imagination for Unimod..)

Example:

   module SmallUtils_ml
   ....
   end module SmallUtils_ml

   !DSX program tester
   !DSX   use SmallUtils_ml, only : Self_test
   !DSX   call Self_test()
   !DSX end program tester

(where here we also have put a self_test routine in the module. This
 isn't essential, but often very useful.)

NOTE: fmkmf has copyright from University of Edinburgh, so NOT emep gnu

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th April, Peter 3164

More user friendly version of uEMEP: the component indices are set automatically.
Emission file and sector can be chosen in config.

modified: Emissions_ml.f90 OwnDataTypes_ml.f90 config_EMEPSTD.nml
ModelConstants_ml.f90 Log.changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th April, Alvaro 3163

NetCDF_ml:
- Re-enhable real fields on GetCDF_modelgrid.
  This feature disabled on 3145 (Feb 2016).
- Re-write xtype/reverse_k_loc logic so they are no longer nested.
  This way it is easy to ensure consistency over xtype/reverse_k_loc combinations.

Output_hourly:
- Correct bug on dZ/dZ_BND hourly output type.
  Bug was introduced with dZ/dZ_BND on SVN 2973 (Mar 2015).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13-14th April, Alvaro 3160-62

SmallUtils_ml,TimeDate_ExtraUtil_ml:
- Move key2str interface and module procedures from
  TimeDate_ExtraUtil_ml to SmallUtils_ml and make it public.
- Add string version to key2str interface (skey2str),
  to provide the same functionality than str_replace.
- Expand integer/real versions of key2str (ikey2str/rkey2str)
  to provide the same functionality than str_replace and num2str combination.

run.pl,config_FORECAST.nml,config_FORECAST_CitySR.nml
- use replace keywords on emission files
  EmisDir               ='DataDir/Data/Emis_TNO7_MACCIII',
  emis_inputlist(1)%name='EmisDir/Emis_TNO7_MACCIII_$emisyear.nc',

TimeDate_ExtraUtil_ml,Met_ml,Nest_ml,NetCDF_ml,GridValues_ml:
- Remove nctime2idate/idate2nctime interfaces,
  as they are superseded by nctime2date/date2nctime.
- Replace nctime2idate/idate2nctime calls by nctime2date/date2nctime calls
- Remove unused use..nctime2idate

TimeDate_ExtraUtil_ml
- Add self_test subroutine with example usages.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th April, Dave 3158-59

utils/Rdf_csvsites.f90
utils/Rdf_csvsondes.f90

- Some bug-fixes (stopped array overrun) and speed-ups
- also, can add k-level as argument to Rd_csvsondes, and this will extract
  hourly values for that level.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th April, Alvaro 3157

run.pl:
- fix missing bracket from 3155

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th April, Dave  3156

Emissions_ml:
  - enabled use of str_replace, now to allow YYYY as well as POLL in
  config's EmisDir , e.g.

  EmisDir = str_replace('YYYY',num2str(year),EmisDir)
  fname = str_replace('POLL',EMIS_FILE(iem), emis_inputlist(iemislist)%name )

  some old code commented out with !DSA16, awaiting clean-up

SmallUtils.f90:
 - added str_replace

config_EMEPSTD.nml:
 - added example (and default?):
 !Good EECCA default:
  EmisDir = 'DataDir/Data/EECCA/Modrun15/2015_EMEP_trends/model_input_YYYY',

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th April, Alvaro 3155

ZD_OZONE/My_Outputs_ml,config_Outputs_CAMS71.nml:
- Add CAMS50 and CAMS71 hourly output datasets

run.pl,config_FORECAST_CitySR.nml:
- CitySR setup (forecast SR) for CAMS71 runs.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31st March, Peter 3150-4

uEMEP routines and setup.
If USE_uEMEP = .true. and uEMEP%XXX is set at start of routine uemep_emis
(in emissions_ml.f90), the Local fraction of a given pollutant/sector is calculated.
Still in an experimental/development phase.

Modified:
Emissions_ml.f90 ModelConstants_ml.f90 OwnDataTypes_ml.f90 Advection_ml.f90
PhyChem_ml.f90 Derived_ml.f90 My_Derived_ml.f90

"Pole_Singular" is set according to rundomain (instead of fulldomain)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24-25th  February   2016 Peter  3146-9

Small bug with monthly netcdf emission. Caused the code to stop at start.
(emis_inputlist(iemislist)%type == "sectors")
Emissions_ml.f90

Included "buckets" for wrf metdata.
Met_ml MetFields

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th  February   2016 Peter  3145

More adaptation to a future "shared memory" model. Mostly variables as "use only".
(Some problems during compilation with MPI_IN_PLACE with gfortran and mpi_f08)
No changes in results for normal runs.

Unimod.f90 CheckStop_ml.f90 GridValues_ml.f90 Io_Progs_ml.f90 MassBudget_ml.f90
Advection_ml.f90 AirEmis_ml.f90 NetCDF_ml.f90 Landuse_ml.f90 EmisGet_ml.f90
BoundaryConditions_ml.f90 DefPhotolysis_ml.f90 Met_ml.f90 MetFields_ml.f90 ColumnSource_ml.f90
ReadField_ml.f90 Emissions_ml.f90 Sites_ml.f90 Nest_ml.f90 Trajectory_ml.f90
global2local.f90 My_Derived_ml.f90 MPI_Groups_ml.f90 ModelConstants_ml.f90 Par_ml.f90 Log.changes


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th  February   2016 Alvaro  3144

Fix error on the file describes the SO2 passive degassing from volcanoes (volcano_emission.csv).
The vertical description of the emission from Etna and Stromboli are wrong.
The emission is too high and it is spread in several levels.
volcano_emission.csv was introduced on 3009 (May 2015).
As far as I can tell, the effect is rather localized.

ColumnSource_ml:
- Read model surface high [m asl] (from topography.nc) and
  correct vent elevation [m asl] from (volcano_location.csv),
  so base and top of each emission are relative to the model surface.
- Use 'MLEV' in as the base descriptor (*_emission.csv) to indicate the
  specific model level for the emission.

run.pl:
- Link topography file "$DataDir/$GRID/topography.nc", if found.
  So far this file is only available for EECCA.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th   February   2016 Dave    3143

Country_ml: added Country_test routine to check contents of Country array
            and modified header lines

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4-5th February   2016 Alvaro  3141-3142

NetCDF_ml
- Fix small bug on subroutine Out_netCDF:
  call Out_netCDF(...,overwrite=.true.) failed to overwrite an existing file.

Nest_ml
- On FORECAST mode: do not stop if filename_write already exists.
  Existing file will be overwritten.

ZD_Pollen/Pollen_ml,Pollen_const_ml
- Existing file will be overwritten.
- Reorganize pollen_read/pollen_dump subroutines.
  Loop over POLLEN group instead of read/write calls for each pollen species.

run.pl
- Integrate FORCAST runs by forecast user into SMS scripts.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd February   2016 Alvaro, Birthe  3136-3140

Derived_ml
- Check PM* prerequisites (ind_pmfine,ind_pm10,ind_pmwater)

Makefile
- Revert netcdf library on vilje to netcdf/4.3.0, in order to use DEBUG=yes.
  3020 upgraded netcdf/4.3.1 (intelcomp/14.0.1) from netcdf/4.3.0 (intelcomp/13.0.1).
  Unfortunatelly the model crashes with netcdf/4.3.1 and DEBUG=yes.

ZD_OZONE/My_Outputs_ml,config_Outputs_CAMS50.nml:
- Move extra FORECAST output (MACC_ENS) to Derived/Hourly.
- Add PMxx_rh50 prerequisites to CAMS50 output

config_FORECAST.nml
- Use EmisDir/emis_inputlist instead of linking files.

run.pl,ZD_Pollen/Pollen_ml,config_FORECAST.nml
- Birch pollen frac/correction for 2016.

ZD_3DVar/B_NMC/Util_ml,
ZD_3DVar/Analysis/DA_3DVar_ml,DA_Obs_ml,ufftw3_ml,chitox_ml:
- 'use MPI_Groups_ml' instead of 'use mpi'.

ZD_3DVar/Analysis/DA_3DVar_ml.f90
- fix #ifdef.

ZD_3DVar/Analysis/DA_Obs_ml.f90
- call Units_Scale, following the function to subroutine in 3126.

ZD_3DVar/Makefile,Analysis/ufftw3_ml,chitox_ml:
- clean-up
- remove unused 3D fft module.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th January   2016 Dave  3135

Added 2D output of SHL species (following tip from Peter), with:

config_Output, e.g.
      'OH'    ,'molec' ,'2d','AIR_CONCS','SHL' ,4, !! test SHL

Derived_ml:
  SHL enabled

  BUT name-changed needed in future. The SURF_PPB_ class is very confusing, since
  it doesn't really mean ppb. Consider VOL

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th January   2016 Peter  3131-3

Bug in MPI_Groups_ml, make the model crash immediately.
Typo in Emissions for monthly emis (crash).
Emissions_ml recognize type="ASCII"
My_Derived_ml, NetCDF_ml small changes for gfortran compatibility

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th January   2016 Peter  3130

Starting reorganization of MPI setup. So far only moving all MPI stuff into
MPI_Groups_ml and renaming MPI_COMM_WORLD to MPI_COMM_CALC.
This will allow me to develop and test, without having to modify all the files
each time a new versions comes up.
No influence on results.

Many files modified:

Unimod.f90 CheckStop_ml.f90 GridValues_ml.f90 Io_Progs_ml.f90 MassBudget_ml.f90
Advection_ml.f90 AirEmis_ml.f90 NetCDF_ml.f90 Landuse_ml.f90 EmisGet_ml.f90
BoundaryConditions_ml.f90 DefPhotolysis_ml.f90 Met_ml.f90 ColumnSource_ml.f90
ReadField_ml.f90 Emissions_ml.f90 Sites_ml.f90 Nest_ml.f90 Trajectory_ml.f90
global2local.f90 Makefile.SRCS MPI_Groups_ml.f90 Log.changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th January   2016 Dave  3129

Derived_ml: small modification in use of first_semivol_call (affects debug
             output only)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th January   2016 Peter 3127-8

Ocean DMS: bug fix (typo: gave about 2(?) times too much DMS) and cleanup of diagnostic budget.

USE_OCEAN_DMS automatically set T when file is found.

Bug in group_calc/Derived_ml.f90 (first_semivol defined locally as logical,
and globally as integer)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th January   2016 Alvaro 3126

Derived_ml,Units_ml:
- Use new optional output to Units_Scale semivol==.true. for units containing
  ':PM' substring.

config_EMEPSTD.nml:
- rename ugPM unit to ug:PM

Units_ml:
- rename ugPM unit to ug:PM (Units_Scale)
- add support for ugC:PM, ugN:PM and ugS:PM (Units_Scale)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th January   2016 Peter  3124-5

Nest: mode=20 for 3-hourly read and write at end

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th January   2016 Dave 3123

Derived_ml.f90
- fixed ugPM coding to stop Fgas being used for just "ug"

config_EMEPSTD.nml
- reset DEBUG%DERIVED to F

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th January   2016 Alvaro 3122

Units_ml:
- Replace function Units_Scale with equivalent sunroutine do_Units_Scale
  (introduced in 3118)
- Replace function calls (eg unitscale=Units_Scale(units,n,...)) by
  sunroutine calls (eg call Units_Scale(units,n,unitscale,...)).

Makefile:
- Group all compilation targets with the same My_* dependencies

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th January   2016 Dave  3121

ZD_SR/My_Derived_ml DELETED
ZD_SR DELETED

ZD_OZONE/My_Derived_ml.f90 moved to Unimod directory

Makefile modified to remove dependencies on above

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5-7th January   2016 Dave  3118-3120

INTERIM, needs further checks!!!
(and for changes to be passed to more complex SOA, as well as SR versions, etc)

NEW: SOA_ml.f90 replaces ZD_OZONE/My_SOA_ml.f90 and ZD_VBS/My_SOA_ml.f90

Main changes:

1) SOA handling modified. Helper species (e.g. PART_ASOA_OC) removed from
  ZCM_vbs_tests and My_SOA removed, since these were for output only. Instead,
  the outputs can now be obtained through config with ugPM....

2) ugPM units handling added to Derived_ml and Units_ml, to handle species or
groups which involve semivolatile species (ie SOA!).

3) ZD_VBS directory deleted. Empty after My_SOA_ml removed

Chem_ml.f90 - made allocation of Fgas3d depend on FIRST_SEMIVOL>0

config_Outputs_EMEPSTD.nml - modified to use ugPM (need to change other Outputs, but not today.)

Derived_ml - added ugPM to cope with groups which have semivolatile components
             changes in group_calc to accept semivol argument


mk.GenChem - removed  VBS_help.species

ModelConstants_ml - removed DEBUG_SOA since we have DEBUG%SOA

RunChem_ml - calls Reset_OrganicAerosols, which resets OM25_BGND and OM25_SUM
  to correct for any changes (emissions, etc.)

Units_ml
  - added do_Units_Scale subroutine which is intended to replace the
     Units_Scale functions. The problem with the functions is that they
     could modify arguments, not just return values.

ZCM_EmChem09soa/VBS_nonvolatile species - added OM25_BGND, OM25_SUM and OM25 groups
ZCM_vbs_tests/VBS_help.species - not needed any more for EmChem09soa. Likely needs
  modification if wanted for any other VBS setup.
ZCM_vbs_tests/VBS_nonvolatile.species - modifications started until I realised that
   ZCM_EmChem09soa has a file with the same name. mk.GenChem uses the latter, so
   the vbs_tests version will likely be deleted shortly.
ZCM_vbs_tests/VBS_partitioning.species - group OM25 added - this is essential now
   for SOA species.

ZD_OZONE/My_Derived_ml - just increased MAX_NUM_DERIV2D to 250


(Changes marked with FSOA and XSOA. Will be cleaned further in next iterations.)


NEW: SOA_ml.f90
DELETED: ZD_OZONE/My_SOA_ml
DELETED: ZD_VBS/My_SOA_ml
Makefile.SRCS - SOA_ml replaces My_SOA_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st December 2015 Anna via Alvaro 3117

Nest_ml:
- Fix FORECAST mode bug.
  Forecast crashed when BC file was missing.
  Bug was introduced on 2972 (Mar 2015).

Log.changes:
- Recover descriptions for 2972--2975,
  which were accidentally removed on 2979 (Apr 2015).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th December 2015 Peter, Jesper 3116

Integrated OcenVariables from Jesper into the code.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th December 2015 Peter 3114-5

Bug when EMIS_OUT = T: was not appending all processors, then only last cpu
results were left.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th December 2015 Peter via Dave 3113

GridValues_ml : bug fix for METSTEP

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th December 2015 Peter 3105-12

Bug for METSTEP not 3 hours when set by WRF.
(was set to o late, so that nmax and nstep got wrong values, and the metint went wrong)

Modified GridValues_ml and Met_ml

Make also maps for DMS emissions when used. Some cleanup

Setup_1d_ml.f90 EmisDef_ml.f90 MassBudget_ml.f90 Emissions_ml.f90 Derived_ml.f90
ZD_OZONE/My_Derived_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th December 2015 Peter, Svetlana 3103-4

Extended flexibility for emis_inputlist.
Developed for new Ocean emission files with NH3 and DMS.
Can be read by adding in config file:

  emis_inputlist(2)%name  = 'EmisDir/geia_emissions_nh3_ocean_0.5x0.5.nc',    ! Ocean NH3
  emis_inputlist(2)%type  = 'OceanNH3',    ! Needs ad-hoc treatment
  emis_inputlist(3)%name  = 'EmisDir/DMS.nc',    !Global DMS in Oceans
  emis_inputlist(3)%type  = 'DMS',    ! Needs ad-hoc treatment

NB: this will include NH3, but not SO2 from DMS.
To replace our traditional natso2.dat emissions by the new SO2 values,
in addition USE_OCEAN_DMS must be set T in ModelConstants_ml.f90.
(this is temporarily while we test).

If USE_OCEAN_DMS=F the budget will still be calculated

Modified:
ModelConstants_ml.f90 MassBudget_ml.f90 Setup_1d_ml.f90  Emissions_ml.f90 EmisDef_ml.f90 NetCDF_ml.f90 config_EMEPSTD.nml Log.changes


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4rd December 2015 Alvaro, Svetlana 3099-3102

ModelConstants_ml,Unimod.f90,OutputChem_ml,NetCDF_ml:
- New output type IOU_HOUR_INST=6.
- Instantaneous hourly fields (IOU_HOUR_INST) will be written to 'Base_hourInst.nc'.
- IOU_YEAR_LASTHH=6 is not longer used, and will be removed on the near future.

Derived_ml,config_BM-EECCA.nml:
- Deprecate output type "USTAR_NWP", use "MET2D","ustar_nwp" in OutputMisc instead.
- Reduce LENOUT2D from IOU_YEAR_LASTHH=6 to IOU_HOUR=5, as the last field is no longer used.

ZD_OZONE/My_Outputs_ml,Output_hourly.f90:
- Move output fror MY_OUTPUTS="MACC_EVA" and "MACC_NMC" to hourly Derived.
- Move DEBUG_PBL and DEBUG_PM10 additional output to hourly Derived.
- Deprecate D2D/D3D output types, as they are now available directly from Derived.
  It is possible to re-instate this output types by setting parameters
  DxD_DEPRECATED=.true. (Output_hourly) and
  LENOUT2D=IOU_YEAR_LASTHH (Derived_ml).
- Hourly output types "theta" and "sh" can now output
  other levels for other KMAX_MID.

PhyChem_ml:
- On FORECAST mode, write hourly Derived outputs before
  the 1st advection step (zero hour).

Units_ml:
- Add pollen grains as possible output unit.

config_Outputs_EMEPSTD.nml,config_Outputs_EMEPSR.nml:
- Update comments "freq ... IOU_HOUR=5, IOU_HOUR_INST=6"

run.pl,config_Outputs_CAMS50.nml:
- New output configurations for CAMS50 (formerly MACC) runs.
- Place tared copy of the source files (Unimod*.tar.bz2) on $RESDIR/
  if/when $MAKEMODE specified.

Nest_ml:
On subroutine wrtxn
- Remove printout for each time filename_write is not found.
- Parameter APPEND can be used to append new time steps to filename_write.

Makefile:
- Add HTAP compilation target. Like EMEP, but with GFED forest fires.
- Fix GFAS forest fire version. Set MACC targets tu use GFASv1.
  On 3018 MACC targets were wrongly set to GFASv1.5.

ZCM_EmChem09soa/BiomassBurning_*_to_EmChem09soa.inc,
ZCM_EmChem09ecom/BiomassBurning_*_to_EmChem09ecom.inc:
- Correct BiomassBurningMapping parameter to include soa/ecom.

GridValues_ml,NetCDF_ml,Sites_ml,PointSource_ml:
- Integer interface for lb2ij, offering a consistent rounding for coordinates
  right on the boundary between grid-cells/processor-subdomains.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd December 2015 Peter, Semeena 3097-8

Cleaned up config_EMEPSTD.nml and config_EMEPGLOB.nml
Cleaned up "yearly" emis output when monthly emis
Clearer error message when Array size exceeded
Corrected old bug that caused PrintCDF to crash if the file existed already :)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29-30th november 2015 Peter 3094-6

Bugs in Sites_ml.f90.
Appears for 160 CPU on a ASIA run, but not when run on 40 procs.
The netcdf finds non-allowed values to output, and the values outputted seem wrong (infinite, 0, etc)
Corrected some array indices.
Initialized out=0.0 for sondes.
Two MPI tags had the same values (tag=347); this could cause the code to mix up sends,
when many CPU where waiting.
Added a +1.0E-7 in:
ix=nint(x+1.0E-7)
In special cases when
1) the station is exactely at a boundary between two gridcells
2) the station is exactely at a boundary between two subdomains
3) the last bit in the rounding is different between MasterProc and owner CPU
then the number of stations in the CPU and MasterProc are no more in sync!

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th     November 2015 Alvaro   3092-3

Homogenize the definitions of output sub domains across the model

NetCDF_ml:
- Use hour_DOMAIN for IOU_3DHOUR type (subroutine Init_new_netCDF).
- replace optional input variables ist,jst,ien,jen by out_DOMAIN
  (subroutines Out_netCDF and WriteCDF).

Nest_ml,ZD_Pollen/Pollen_ml,
config_EMEPSTD.nml,config_IMPACT2C.nml,config_EMEPGLOB.nml,config_FORECAST.nml:
- replace user variables istart,jstart,iend,jend read in Nest_config
  by out_DOMAIN (subroutines Config_Nest, wrtxn and pollen_dump)

Output_hourly,ZD_OZONE/My_Outputs_ml,OwnDataTypes_ml:
- Use hour_DOMAIN for hourly netcdf output and
  remove ix1,ix2,iy1,iy2 from Asc2D type
  (subroutine hourly_out, set_output_defs and print_Asc2D).

Output_hourly:
- add specific humidity hourly output type ("sh").

config_BM-EECCA.nml
- remove garbage after OutputDep_config namelist.

GridValues_ml:
- Extend RestrictDomain so it accepts wildcards,
  eg [10,20,-1,-1] implies [10,20,RUNDOMAIN(3),RUNDOMAIN(4)].
- Add consistency check for RestrictDomain

Changes/updates from MACC (now CAMS50) FORECAST/ANALYSIS set-up

Nest_ml:
- FORECAST mode accepts out_DOMAIN. Use RUNDOMAIN as default.

config_FORECAST.nml:
- Use 'CdfFractions' instead of 'emislist' (deprecated).
- Add Machine_config namelist

ZCM_EmChem09/EmChem09base.species:
- remove SHIPNOX from DAOBS group.

ZD_3DVar/Makefile
- Requere module fftw/3.3.3 for intelcomp/13.0.1
  or module fftw/3.3.4  for intelcomp/14.0.1.

ZD_3DVar/Analysis/DA_3DVar_ml:
- Fix bug for ANALYSIS on 32 CPUs.The error was unnoticed as we only
  run with 16 CPUs because hyper-treading slows down FFTW3.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19-23th  November 2015 Peter, Alvaro   3085-91

Bug in nesting for restricted domain introduced in 3070.
Also some inconsistency with netcdfID for non-master corrected.
Restricted Nest domain output now possible for MODE 10 also

The model will stop if the Nest will find an existing "EMEP.OUT" when writing.

Restricted domain output:
choose size of domain in the output files in config_Outputs.nml Example
&OutputSize_config
    fullrun_DOMAIN = 1,100,1,100 ,
    month_DOMAIN =   100,300,1,100 ,
    day_DOMAIN =     1,100,90,100 ,
    hour_DOMAIN =    50,100,50,100
&end

3087: corrected bug in NetCDF, when using nesting. (all processors in stead of only masterproc
where opening the file, and not closing)

3088: more bugs corrected for restricted domain and stereographic projections
3089: increased size of WRITE_SPC and WRITE_GRP in Nest_ml
3090: Stop Nest_ml *at start of run*, when the write file exists.
      Defined the time for "hourly", as middle of period. Hourly is averaged over the hour.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th  November 2015 Peter   3084

Hourly outputs now possible with same interface as daily, monthly, yearly.
Choose "5" for period.
This is supposed to be used mostly for 2D fields.


The "old format" hourly files setup are now sent to XXX_3Dhour.nc
This should be used for special uses: restricted area or vertical levels, CAMS,
nesting(?).
replaced some "hourly" by "3Dhourly" for the "old format" hourly.

repaired config_BM-EECCA.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th  November 2015 Peter   3082

Bug in ReadField_CDF: did not interpoalte correctly in the case when all these
three conditions are met:
1)The field read and the model grid are lon-lat
2)"zero-order" interpolation
3)longitudes are not defined from -180 to 180 (but 0 to 360)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th November 2015 Alvaro 3081

ModelConstants_ml,ZD_OZONE/My_Outputs_ml
PhyChem_ml,TimeDate_ExtraUtil_ml:
- Move FREQ_HOURLY from My_Outputs_ml to ModelConstants_ml.
- Set FREQ_HOURLY FREQ_HOURLY as a user variable,
  read trough ModelConstants_config namelist.

ModelConstants_ml:
- Small bug fix: NETCDF_DEFLATE_LEVEL and HOURLYFILE_ending were
  twice on ModelConstants_config.

Output_hourly,ZD_OZONE/My_Outputs_ml:
- Add D3D hourly types: D3D_inst, D3D_accum & D3D_mean.
- Hourly output for MY_OUTPUTS="MACC_NMC":
    AOD_550nm(D2D_inst), EXT_550nm(D3D_inst),
    PMFINE(BCVugXXgroup) & PM10(BCVugXXgroup).

Makefile:
- Add MACC-EVAan: MACC-EVA-3DVar

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th  November 2015 Dave  3080

BUG FIXES!!! - results will change for Smix and SmixTen gamma values
  The fsia (SO4/(SO4+NO3)) was being uses as 1-fsia. Also, the
  gamma for NO3 was being added instead of weighted.
  The changes are not very dramatic, but not trivial. The code needs
  to be tested again for best gamma. (For Dave's global runs Smix is
  still clearly best.)

  Bug fixes in:
   AeroFunctions_ml
   ChemFunctions_ml
   Setup_1d_ml

  RCT_SKIP expanded to array in:
   ModelConstants_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th  November 2015 Alvaro, Svetlana  3079

AOD_PM_ml: bug fix.
  Mass extinction efficiency for ECn/ECa types at 350 nm
  were one order of magnitude too big. The error traces back to 2994, when
  the multiple wavelengths were included.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th  November 2015 Peter, Svetlana   3076-8

Bug in the defintion of vertical levels in netcdf output files, introduced in
version 3070.
Only the values/defintion of the vertical levels written are wrong, the data is correct.

"Extended" Massbudget now also with consistent units.

3D met output enabled for fields defined in "met%".
In config_Outputs.nml, set for instance
'rho_airdensity',  'MET3D', 'air_density', '-', 'kg/m3', -99,  -99,      F,   1.0, T, 3,

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th  November 2015 Peter, Dave, Jan Eiof, Matthieu   3075

Mass budget for O3 at top and others.
Now number in mass budget are given in kg (I think!)

Small bug in monthly emissions corrected (no effect on results,
but could trigger a false error if run with debug=yes).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd  November 2015 Peter  3073

Removed almost all maxlimax and maxljmax. They are replaced by limax and ljmax.
That means that arrays in different subdomains can have different declared
sizes.
This matters only when arrays are sent with MPI: otherwise the subdomains
do not need to "know" the size of teh other subdomains.

The local2global/global2local approaches still need maxlimax/maxljmax, but these
are on the way out. local2global has been removed already.
ReadField (ASCII), also needs it. It is only in use for DMS.

Note that the advection scheme (even if subdomains are exchanging info at boundaries)
do not need maxlimax/maxljmax, because the adjacent borders always are of same size.

I did a brutal
sed -i 's/MAXLIMAX/LIMAX/g' *90
and then corrected the few places where it should still be maxlimax

The results should be identical. (Tested only 1 day EECCA).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd  November 2015 Peter  3072

New "Machine_config". The code tries the different "Datapath" until it finds one
that exists. The key word "DataDir" is then replaced by that path.
Same config file can be used for Vilje and Stallo.

Modified: ModelConstants_ml, config_EMEPSTD.nml, config_EMEPGLOB.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st  November 2015 Dave  3071

DOCS/Manual/
  Intro.tex - small changes
  EECCA.eps - removed! We do not need a 2Mb file in each svn directory
  EECCA.pdf - added! Replaces the above

Use "pdflatex Manual", not "latex Manual"

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th October 2015 Peter 3070

Refactoring parts of the codes concerned with horizontal coordinates.
sigma coordinates no more available.

Modified:
EmisGet_ml.f90 Emissions_ml.f90 MassBudget_ml.f90 DustProd_ml.f90 Advection_ml.f90 Landuse_ml.f90
Derived_ml.f90 NetCDF_ml.f90 Met_ml.f90 GridValues_ml.f90 ZD_OZONE/My_Derived_ml.f90

EmisGet_ml, Emissions_ml: removed the "emislist" option. Removed arrays that run over the fulldomain
(glat_fdom, glon_fdom, globemis, globland, globnland, flat_globnland, flat_globland, globemis_flat).
carea removed (it was still based on sigma coordinates) (Massbudget_ml)
Advecdiff and Advecdiff_poles removed
Removed routines GlobalPosition DefGrid and Position.

Had to rewrite Init_new_netCDF and CreatenetCDFfile to avoid using glat_fdom and glon_fdom.
CreatenetCDFfile_Eta removed (replaced by the new CreatenetCDFfile).
Out_netCDF is still using fulldomain arrays, but this will be corrected another time.

Derived_ml and My_Derived_ml; put a line
         if(outdim=='3d')Is3D=.true.
for the "MISC" case. (not sure about this, but I can't see that it can harm)

Did a lot of testing (PS, lon-lat,wrf and GLOBAL grids), but there may still be
bugs (many possibilities for special cases)
Results should almost not be affected: <1E-4 relative max error, due to slightly
different extrapolation at domain boundaries. For PS projection the definition
of gridareas (xm2 and xmd) is slightly different (<1E-5).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th October 2015 Dave   3069

Biogenics_ml
  Removed duplicate line for E_ISOP (no effect on results, but confusing).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th October 2015 Alvaro 3068

AOD_PM_ml:
- Fix bug on DRY mode AOD calculations:
  - On DRY mode, AOD calculations missed the cross-section to surface transformation.
  - NOc calculation was inconsistent between DRY and WET modes.
  - The bugs were introduced in 2665 (November 2013), but did not become active
    until 2994 (April 2015), when the description of dust types (DDf & DDc) on
    Dust.species and VBS_nonvolatile.species were explicitly set to DRY mode
    (DDf:dry and DDc:dry).
- Use a constant grow factor of 1.0 for non hygroscopic components.
- Consistently set ECn as non hygroscopic.
- Add consistency checks for Qm_ref array.

AOD_PM_ml,GenChem.pl,
ZCM_EmChem09/Dust.species,ZCM_EmChem09soa/VBS_nonvolatile.species:
- Do not allow different DRY or WET mode calculations for different AOD components.
  All AOD components will be treated the same, all WET or all DRY.

PhyChem_ml:
- On FORECAST, update derived before hourly output for zero hour.

config_EMEPSTD.nml:
- Remove garbage at the end of the file.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th October 2015 Dave   3067

Assorted changes to simplify and enable more aerosol reactions, plus
prepare for bug correction (missing BC in Smix, new scheme will be denoted S16mix for
2016 usage)


AeroFunctions_ml
  - Added usage of faero_bc. Currently set to zero, but future versions will
    activate this.

Biogenics_ml
  - Added commented out Paleo lines, preperation for future changes

Chem_ml
  - Added faero_bc, cNO2, cNO3

ChemFunctions_ml
  - Added faero_bc, cNO2, cNO3
  - provisional allowance of S16mix as do-nothing placemaker (same as Smix)


Derived_ml
  - Added MasterProc test to limit number of warnings  for not all PM25X species present

EmisGet - added a commented out section to explain GEOS-CHem needs. Not used.

ModelConstants_ml
  Added SKIP_RCT to  allow one reaction to be zero'd out (will extend to array later)
  Added PALEO_TEST for future use

Setup_1dfields_ml
  - Added cNO2, cNO3, aero_fbc, gamN2O5
  - Added is_BC and usage
  - Added SKIP_RCT and usage
  - dtxt replaces 'sub' (will do throughout cod, easier to grep)

Setup_1d_ml
  - Added BC to faero usage, will fix BUG in next svn
  - use of SKIP_RCT where wanted

ZCM_EmChem09/
  EmChem09.species - added DUMMY, to allow access to gamN2O5 in rct arrays
  EmChem09.reactions - added gamN2O5 as rate for DUMMY


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th October 2015 Peter  3066

GridValues_ml.f90
USE_WRF_MET_NAMES automatically set as true, if wrf metdata is found.
(no need to set it in config anymore)
Not really tested.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th October 2015 Dave  3065

AeroFunctions - clean up and harmonised with ESX

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th October 2015 Dave  3064 rv4.8 OFFICIAL

Corresponds to open-source code as released for EMEP model course.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th October 2015 Agnes 3060-62

Updates in the user guide in DOCS/Manual.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th October  2015 Peter 3059

Updates for gfortran compatibility. changed double precision into real for many
FastJ routines.

One worrying change:
in CM_ChemRates_ml.f90 we have "rct(62,:) = KAERO()", but KAERO is undefined.
Replace with rct(62,:) = KAERO2() ? This is generated by genchem, not an svn file

To use gfortran on stallo:
module rm intel
module load gcc/4.7.2
module load netcdf

then put export MACHINE ?= gstallo

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th October  2015 Peter, Semeena 3053-4

Updated DOCS for "mixed" setup.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th October  2015 Peter 3051

output cleanup
 ModelConstants_ml.f90 Landuse_ml.f90 Emissions_ml.f90 Met_ml.f90 NetCDF_ml.f90 Derived_ml.f90 BoundaryConditions_ml.f90 EmisGet_ml.f90
modrun.sh: removed all INPUT.PARA parts (they are in config file now)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th October  2015 Dave 3049

CLEAN-up prior to open-source

- config_Outputs_EMEPSTD cleaned

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd Ocober  2015 Dave 3049

CLEAN-up prior to open-source
BUG fix on AOT (some metrics)

AOTnPOD
 - buggy code removed, and cleaner system for EU, MM etc used.
 - prelim XMM, XEU from 3048 deleted
 - SPOD calculations deleted

config_Outputs
 - prelim XMM, XEU from 3048 deleted

DryDep_ml
 - cleaned (a bit)

Setup_ml
 - cleaned

Sites_ml
 - small debug modifications (use of dtxt== 'siteswrt:')
 - changed iz=20 to iz=KMAX_MID for "If ZERO'd, skip surface correction" case
   in siteswrt_srf
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th September 2015 Dave 3046-3047

Most AOT and POD type definitions moved to config  system - enables simpler
changes in the settings, and varying output frequency through iotype.
NOTE - changes done for EMEPSTD so far. Needs to be done for SR, other...

AOTnPOD_ml
- All O3cl settings removed - moved to config_Outputs_EMEPSTD.nml
- O3cl_t (was O3cl) now has iotype
- is_EU, is_MM, is_XX logicals added to help clear up confusions and
  chase down a possible bug in AOT (to be continued)
- debug stuff cleaned and extended,

config_Outputs_EMEPSTD:
- added new section for PODs and AOTs

Mosaics_ml
- modified for O3cl_t
- and iotype usage

My_Derived_ml
- All POD/AOT defintions removed
- older commented-out code for COLUMN removed

SMALL TIDY-UPS (as 3046):

Derived_ml
- small debug changes
- tmp comment-out of iadv_EC_C_WOOD type checks. Killed EmChem09 runs!

DerivedFields_ml
- removed copyright

Landuse_ml
- small debug changes

Sites_ml
- small debug changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th September 2015 Dave 3045

More clean-ups -
Aero_Vds_ml - deleted commented out lines from older code
DefPhotolysis - removed copyright text
DryDep_ml - clean up, and added surf_o3_ppb1 to capture O3 after deposition
  loss (o3_ppb was before)
LocalVariables - added surf_o3_ppb1
ModelConstants - removed mention of Riemer stuff
Setup_1d_ml - removed old comments concerning bugs, old setup_nh3 (FUTURE) code
    and general clean-up

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th September 2015 Dave 3044

Small clean-ups - removed older !CMR comments and copyright text and 'Unified'
from Nest_ml, ExternalBICs_ml, Dust_ml, Output_hourly.f90 and My_SOA_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7-8th September 2015 Peter 3041-3

"Mixed" format for emissions put as default in ModelConstants_ml.f90 and removed
from config_EMEPSTD.nml.
Old bug in the "inclusive countries": all countries were always taken.
See example of use in config_EMEPSTD.nml or ask Peter or Semeena
Mixed format can combine several emission sources files, netcdf or ASCII.
Can include some countries, or exclude some countries for each emission file
Can NOT interpolate the ASCII emissions.

for ASCII emissions, pollutants names must be expressed with the keyword "POLL",
and will be replaced with the names defined in CM_EmisFiles.inc. These are in
lowercases. The link is now provided in the run.pl, but new emissions
should preferably be defined directly with lowercases (gridsox...)

In the longer term pathes should be defined in config file, and not run.pl
so that we can remove completely run.pl at some stage. This will make it easier
to backtrace pathes of files used by the model.

Indices of emis_inputlist must start at 1 and increase by 1 at a time
(no undefined inputs in between defined inputs)

Emis4D: reverse k order

Some clean ups

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd September 2015 Peter 3037-3040

Safer clean up for modrun.sh:
remove all links

Met_ml kmax->kmax_mid (wrf met)
Changed SMI formula for SMI (wrf)
Test for positive precipitations (wrf)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd September 2015 Peter 3036

New method for reducing emissions by coordinates.
Included in our "femis.dat" as lines starting by the keyword lonlat.
Example of valid femis.dat file:
Name  7         sox       nox        co       voc       nh3      pm25      pmco
 8    0        0.0       0.0       0.0       0.0       0.0       0.0       0.0
 lonlat 1.0 3.0 46.5 50.0    0   0.0       0.0       1.0       1.0       1.0       1.0       1.0
 lonlat 11.0 13.0 58.0 62.0  0   1.0       0.0       1.0       1.0       1.0       1.0       1.0

The lonlat lines have the format:
lonlat minlon maxlon minlat max lat sector reduction1 reduction2 ....

lonlat and "normal" lines can be mixed, and it is always the product of all reductions which is used.
(It is however not allowed to cross the longitude=180 degrees line, i.e have minlon on one side and maxlon on the other)
Should work for all gridded emissions (tested for ASCII, "Mixed" ASCII, "Mixed" fractions)

Output femis.dat into RunLog, as it is important to keep track of reductions

Removed OH from config_Output.nml, as it was crashing the code

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20th August 2015 Peter 3034-3035

Adaptation of the code to handle WRF metdata directly. (and cleanups)

Met_ml, MetFields_ml: many new WRF names defined.
3D Precipitations done by:
1) make surface precip by adding RAINNC and RAINC
2) fetch QRAIN which is 3D but instantaneous. Smooth horizontally with smoosp,
   smooth in time by adding values at begin and end of met period.
3) scale surface precip vertically according to QRAIN
4) if QRAIN=0 but still have surcafe precip, use humidity instead

METSTEP set to WRF value automatically.

TimeDate_ExtraUtil_ml

NetCDF_ml: change of extrapolation method for below lowest or above highest level
(no extrapolation but take lowest/highest value)

AirEmis_ml: above max height (19000m?) set emissions to zero (was "out of bounds bug")

GridValues_ml: check for lowest level thick enough

ModelConstants_ml: METSTEP variable instead of parameter. USE_WRF_MET_NAMES in namelist

SmallUtils_ml: do not stop if to many words , but take the first ones. Needed because wrf metdata has
"00:00:00" which can be interpreted as three words when ":" is used as delimiter.

Nest_ml: do not output lots info if MODE=0
AOTnPOD_ml: commented out some output
Site_ml: more characters in strings
run.pl: removed $DATA_LOCAL from list of necessary directories (now nothing is required!).

To use wrf met you must
in run.pl:
$METformat="$MetDir/wrfout_d01_YYYY-MM-DD_00:00:00";
(and define emissions, for instance $CDF_EMIS="Emis_GLOB_05.nc";)
unset degreedays setup.
You can but do not need use "Vertical_levels.txt"; WRF levels can be used, but
be careful then with definition of emis heights.

in config_EMPSTD.nml:
USE_WRF_MET_NAMES = .true.
USES%DEGREEDAY_FACTORS = F
(and possibly forest fire ...)

no change of results if you use standard setups.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th August 2015 Peter, Heiko 3033

New emission input possibility, "Emis_4D.nc".
These must be given in the fulldomain with all vertical levels as hourly intervalls.
At present no space interpolation is performed.
The emissions will then sum up into the model ("smoothly" in Reaction.inc).
So far only use in EEMEP.
To use this, specify   EMIS_SOURCE = 'Mixed' in config file,
then add lines in the form:
emis_inputlist(1)%name = '/global/work/mifapw/emep/snap/Emis_4D.nc', !name of input file
emis_inputlist(1)%pollName(1) = 'Cs137_concentration_dump_ml', !Name of 1st pollutant in file
emis_inputlist(1)%pollemepName(1) = 'NPP22L689_CS137', !Name of 1st pollutant in "CM_ChemSpecs_ml.f90
emis_inputlist(1)%pollName(2) = 'I131_concentration_dump_ml', !Name of 2nd pollutant in file
emis_inputlist(1)%pollemepName(2) = 'NPP22L689_I131', !Name of 2nd pollutant in "CM_ChemSpecs_ml.f90
emis_inputlist(1)%pollName(3) = 'Xe-133_concentration_dump_ml', !Name of 3rd pollutant in file
emis_inputlist(1)%pollemepName(3) = 'NPP22L689_XE133', !Name of 3rd pollutant in "CM_ChemSpecs_ml.f90

The pollutants must start with indice 1, then 2 ... (no empty indices)
At present the pollutants are assumed given every hour and with unit molecules/m3

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

2nd August 2015 Dave, 3032, rv4.7.1

(I think rv4.8 can with full implementation of SHIPNOX, if results are as
  promising as first tests.)


** SHIPNOX introduced into chemistry, but not yet implemented into EMISSPLITS
   (see model updates chapter in EMEP Report R2015)

   Use of SHIPNOx will give large changes in O3 in global modelling at least. If used,
   use Smix (not SmixTen!) for the N2O5 hydrolysis - the shipping and N2O5 rates both affect and
   depend on oceanic NOx.


** BUG FIX version of Setup_ml. Results  may change a little

1) SHIPNOx

ZCM_EmChem09/
    EmChem09.species - added SHIPNOX, similar to NO2
    EmChem09.reactions - added:

      TROE_NO2_OH  SHIPNOX + OH + {M}  = HNO3   ; A97,J
      3.2e-5       SHIPNOX             = HNO3   ;
      - latter gives half-life of  6h, loosely based on dark experiments of Vinken et al, ACP,2009

    EmChem09/EMISSPLIT/emissplit.xxx.nox
    - added SHIPNOX as possible fraction, and with 47% NO, 3% NO2 and 50% SHIPNOX for INTISHIPS (cc350)


    NOTE - SHIPNOX not yet used for EmChem09soa chemistry. This is partly for safety while others
    have the chance to test and comment, and partly as the run.pl SplitDir system needs a good
    clean up.

2) BUG FIX
Setup_ml
  - use of pevious ugRemF = max(ugRemF, 1.0e-9) could cause aero_fom > 1 for very
    small ug/m3 levels. This could cause negative Sarea and negative rate uptake rates!
  - now fixed
  - added extra check on 1st call for any rct < 0


3) Other

For global crops assessments:

 AOTnPOD_ml,
  - Added IrrigatedWheat and NonIrrig wheat for work with ICP-Veg global modelling
 ZD_OZONE/My_Derived
  - Added IrrigatedWheat and NonIrrig wheat for work with ICP-Veg global modelling
  - now as daily output, to allow post-processing over different growing seasons
 run.pl, /global/work/mifapw/emep/Data/LandInputs_Jul2015/
  - now uses /global/work/mifapw/emep/Data/LandInputs_Jul2015/ data to get specs
    for irrigated and non-irrigated wheat.
 SubMet_ml
  - now sets fSW for landcovers with Irrigated in name. Very crude - should do this
    via input files!

DO3SE_ml
  - small debug changes

Emissions_ml
  - Added more flexible naming system, to allow POLL in middle of string to be used.

LandDefs_ml
  - small debug changes

Landuse_ml
  - some minor changes to prepare for Paleo and other external files

RunChem_ml
  - check_negs routine added for extra checks, when e.g. negative concs found somehere
    (triggered by DEBUG%RUNCHEM)

TimeDate_ml
  - can now call print_date without argument. Defaults to current_date
  - removed GNU info.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th July 2015 Dave, 3031

XNCOL system introduced to add column totals of short (or long)-lived species
to d_2d system.

Setup_1d_ml
- XNCOL system added into reset_3d routine, since this is afer chemical processing.
  Column total from dot_product(xn_2d(ispec,:),deltaZcm(:))

Setup_1dfields_ml, Chem_mk
 - added deltaZcm - thickness of layers in cm.

config_Outputs_EMEPSTD
 - examples added, with caveat/warnign test:
     ! Column data. Note that these data are compiled just after the chemistry step,
     ! and are probably best used for short-lived species. REMEMBER that boundary
     ! cells are not calculated, hence expect zeros on edges.

    OH - very useful and reason for this change
    NO2 - for comparison to NO2 from COLUMN system. The latter uses concentrations from
           after the advection step, and also produces values at domain edge.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th July 2015 Peter, Massimo  3029-30

Chem_ml: S_m2m3=0.0 (to avoid debug false errors when ":" is used)
Derived_ml: output lowest level when 3D metfield is asked for (real 3D not
yet functionning)

Lots of changes to allow the model to use directly WRF output as metdata.
tested for rotated spherical projection (climatrans).
Met_ml
MetFields_ml
GridValues_ml
NetCDF_ml

No change in results.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st July 2015 Peter  3028

EmisGet_ml: emission height. Bug when defined as P levels (not default)
(loop over nemis_kprofile instead of nemis_hprofile)

GridValues_ml: deallocate xm_global (should be removed completely one day!)

NetCDF: vertical interpolate. Completed change from 3025.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th June 2015 Dave  3027

EmisGet_ml
Emissions_ml

  Tidy up, while checking (succesful) use of Mixed netcdf inputs
  (clearer debug, lines shortened < 78 chars, etc., old comments removed)

config_EMEPSTD.nml
  Extra comments to remind that Mixed soures need POLL, not explicit sox, etc

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th June 2015 Heiko 3026

Increase number of emissions in columnsource. Fukushima hourly, 3 heights
required already 1200, so increased to 10000

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23rd June 2015 Peter 3025

Vertical interpolation for NetCDF input:
When extrapolating for altitude higher than the input data, use a ribust scheme,
i.e. something which is bounded by the values in the two highest availbale
levels. (Not explicitely tested for these high altitudes though).
Should be useful when including stratosphere in the runs,
but O3 is not important for instance (eemep/volcanoes).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22th June 2015 Svetlana 3024

Minor changes in DustProd_ml.f90 (small reduction) and
AOD_PM_ml.f90 (dust extinction efficiency)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th June 2015 Peter 3023

Use ncFileID_given for Hourly output.
In case very many hourly outputs fields where chosen, the model might otherwise
crash due to bug in netcdf/hdf5 library.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th June 2015 Heiko 3022

Rename ZCM_Emergency/ESX_r12.[reactions/species] to Eemep.[reactions/species]

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th June 2015 Heiko 3020,3021

Enable reduced chemistry in Emergency (taken/modified from ESX_r12)

Fix unitscale for radioactive particles
Add frost (HPC,Sweden) to Makefile
Use intel 14 on vilje in Makefile

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

9th June 2015 Peter, Dave, Svetlana 3018

New set of emissions for FINN: "v15".
Requires new BiomassBurningMapping.inc
ZCM_EmChem09soa/BiomassBurning_FINNv1.5_to_EmChem09soa.inc
ZCM_EmChem09/BiomassBurning_FINNv1.5_to_EmChem09.inc

Makefile and run.pl modified to use the new ones

modified mk.GenChem and ForestFire_ml.f90 also

Notes on FINN ForestFire for 2012:
ForestFire_Emis_2012.nc is omewhat special: it is build from
GLOBAL_2012_GESOCHEM_04222014.txt (=FINNv1_2012_GESOCHEM_04222014.tgz) which
has still the v1 tag, but it has the same components as the v15 version.
i.e. ForestFire_Emis_2012.nc differs from ForestFire_Emis_v15_2012.nc but has
same components!
ForestFire_Emis_2012.nc was used for 2012 model runs up to now.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th June 2015 Svetlana 3019

Setup_1d_ml.f90 - corrected call for pmSurfArea (now includes PMdens)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th June 2015 Dave, Peter 3018

New mapping for FINN ForestFire emissions - BiomassBurning.inc

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th June 2015 Peter 3016-17

Some corrections for making the code run on abel and also with "DEBUG=yes".

TimeDate_ExtraUtil_ml, ExternalBICs_ml : compiler on abel did not like the form:
 module procedure :: secs1970_to_ts,secs...

Met_ml: Kz_m2s_toSigmaKz called with (1:limax,1:ljmax,:) also for Kz_m2s.
BoundaryConditions_ml: does not read Dust.nc when USE_DUST=.false.

ColumnSource_ml did read long names. set TXTLEN_NAME = 50 in ModelConstants_ml (was 20)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th June 2015 Agnes 3015

Country_ml:
Added EU28 definition (Croatia (HR) is new EU land), modified EEA

Emissions_ml:
sumEU modified to include all EU28 land

BoundaryConditions_ml:
Mace Head correction for 2013 added

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd June 2015 Peter 3013-4

NetCDF_ml:
Removed the "flight levels" (Airplane emissions) part of the ReadField_CDF routine,
and put it in an new ad hoc routine ReadField_CDF_FL.
The flight levels are a special vertical coordinates not used elsewhere.

This allows to remove the "recursive" requirement from the routine and in the Makefile.

One small step towards a better world.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th May 2015 Peter 3011

NetCDF_ml:
New parameter "rotated_pole" to conform to NCL and CF convention(?), in case of
rotated lat lon projection.
ReadField_CDF: "stagg" for staggered interpolation of wind fields.

ModelConstants_ml, Met_ml, GridValues_ml:
Possibility to define new grid projection manually without explicit metdata.
Under development, but used for CARBONORD project already.

OutputChem_ml: write out also in test run with one iteration.

Emissions_ml, run.pl: small comments changed

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th May 2015 Alvaro 3009-10

Volcanos_ml,Emergency_ml,ColumnSource_ml,Makefile.SRCS:
- Implement volcanic passive degassing of SO2 (previously in Volcanos_ml)
  into Emergency_ml.
- Rename Emergency_ml (with SO2 from volcanoes) to ColumnSource_ml.
- Remove deprecated modules: Volcanos_ml and Emergency_ml.
- Set USE_ASH=T (F by default) in ModelConstants_config namelist
  to read historical ASH emissions from Eyjafjallajkull's 2010 and Grimsvotn's 2011 eruptions into the ASH group.
- The ASH group is only available on EmChem09, EmChem09soa and Emergency schemes.
  ColumnSource_ml will write a warning into RunLog when USE_ASH=T but
  the ASH group is not found.
- Note that for periodic events, eg eruption the 15th of each month,
  it is better to run full months in order to ensure the vent is picked up.

ModelConstants_ml,Derived_ml,ZD_OZONE/My_Outputs_ml,
config_EMEPSTD.nml,config_BM-EECCA.nml,
config_FORECAST.nml,config_EMERGENCY.nml,
config_EMEPGLOB.nml,config_IMPACT2C.nml:
- Rename USE_EMERGENCY to USE_ASH.
- Rename/merge DEBUG_VOLC and DEBUG_EMERGENCY to  DEBUG_COLSRC.
- Change SOURCE_RECEPTOR from a parameter,
  to a user variable to be read in ModelConstants_config.
- Add VOLCANO_SR user variable read in ModelConstants_config,
  for a 15% reduction of volcanic emissions.

run.pl,Makefile:
- replace deprecated VolcanoesLL.dat files by columnsource_location.csv and
  columnsource_emission.csv files, to be used by ColumnSource_ml.
  Default files, $DataDir/volcano_location.csv and $DataDir/volcano_emission.csv,
  contains SO2 passive deggasing from Etna and Stromboli,
  ASH Eyjafjallajkull's 2010 eruption, and ASH and SO2 from Grimsvotn's 2011 eruption.
- 2 EMERGENCY modes: Emergency and AshInversion set from environment variable
  eEMEP. Emergency mode (default) for multy-scenario eEMEP forecasts,
  can be run by `qsub -v eEMEP=Emergency,UTC=12,NDAY=4,DATE=... run.pl`.
  AshInversion mode for unit-emission ensemble hindcast
  can be run by `qsub -v eEMEP=AshInversion,UTC=12,NDAY=2,DATE=... -J 1-8 run.pl`.

Setup_1d_ml:
- Replace calls to rcemis_volc(volc_no) and EmergencyRate(i,j) by calls to
  ColumnRate(i,j,REDUCE_VOLCANO=0.85) if VOLCANO_SR, and ColumnRate(i,j) otherwise.

Emissions_ml,EmisGet_ml:
- Remove/comment calls to deprecated functions from Volcanos_ml.

Derived_ml,ZD_OZONE/My_Derived_ml:
- "COLUMN:SPEC" and "COLUMN:GROUP" "MISC" types for output the column for a
  single SPEC and a GROUP of species.
  "COLUMN" "MISC" type is equivalent to "COLUMN:SPEC".
- Do not create Emis_mgm2_BioNat output for ASH_LxxByy (level xx, bin yy)
  tracers for eEMEP=AshInversion, as they total 171 species and the output is not needed.

ZD_OZONE/My_Outputs_ml,config_Outputs_EMERGENCY.nml:
- MY_OUTPUTS="INVERSION" for eEMEP=AshInversion unit-emission ensemble hourly output
- config_Outputs_EMERGENCY.nml for reduced derived output on eEMEP runs.

TimeDate_ExtraUtil_ml:
- extend date conversion interfaces (to_stamp, to_date & to_idate) to accept
  dates in string format.

Makefile,mk.GenChem,ZCM_Emergency/mk.Emergency,
ZCM_EmChem09/Ash.species,Ash.reactions,
ZCM_Emergency/BiomassBurning_*_Emergency.inc,EMISSPLIT,
ZCM_Emergency/ASH_9bin.species,ASH_9bin.reactions,
ZCM_Emergency/Mastin_et_al_2009b_table3.csv,NUC_Explosion.csv,NPP_Accident.csv:
- Move eEMEP set-up from mk.GenChem into its own script (ZCM_Emergency/mk.Emergency).
- For eEMEP target Make calls ZCM_Emergency/mk.Emergency before calling mk.GenChem.
- Add of ASH_F and ASH_C tracers to EmChem09 and EmChem09soa schemes.
  In this way, there is no need for special 2010 amnd 2011 targets (eg EMEP2011)
  to include ash from
- Set Emergency scheme to be equivalent to EmChem09 and link
  BiomassBurning_*_Emergency.inc and EMISSPLIT files to EmChem09.
- New 9bin ASH tracers for eEMEP=AshInversion runs.
- Improve/correct headers on Mastin_et_al_2009b_table3.csv, NUC_Explosion.csv
  and NPP_Accident.csv files.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22nd May  Peter  3006-8

Emissions_ml: Added posibility to have monthly emissions in the "Mixed" EMIS_SOURCE.
Combining monthly and other emissions not tested.

GridValues_ml: lb2ij added a case when longitude >360.

NetCDF_ml: interpolate from all longitudes when only a part of the Globe is in the input grid
ModelConstants_ml, Met_ml: increased the size of some strings to allow for long pathes.

Removed an exstra space in ZCM_EmChem09ecom/EMISSPLIT/emissplit.defaults.omco
and renamed rempm25 -> remppm25, rempmco -> remppmco

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th May  Peter  3005

Start of reorganization of Emission setup.
The new setup will use EMIS_SOURCE= 'Mixed' in config file.
Then one can define ASCII, NetCDF/fractions and NetCDF/SnapEmis formats and mix
and add those. Use of exclude/include possible for each one.
The ASCII gridXXX files must still be in the native grid (no interpolation).

New reading of gridXXX that does not use "global" arrays.
Avoids using "flat emissions".

Does not work for monthly emissions yet. Also roaddust should be included in the scheme.

Started also to define explicit path in the config file.
The idea would be to remove all linking in the run.pl, so that the program "knows"
exactely what is used (for log/reruns).

Wil need more cleanup etc.

Also included changes in readfield_cdf used in EDIII.

Should not modify results. The "old" scheme is still the default.

Modified:
EmisDef_ml.f90 Setup_1d_ml.f90 Solver.f90 ModelConstants_ml.f90 NetCDF_ml.f90
EmisGet_ml.f90 Emissions_ml.f90 config_EMEPSTD.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th May  Peter  3004

NetCDF_ml , ReadTimeCDF: can read units "years since...".
Gives answer in years, not in days in this case.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th May  Peter  3001-3002

Reorganization of the monthly emission setup.
To use the monthly emissions Emis_GLOB_01deg_2010_month.nc
(or Emis_GLOB_01deg_2008_month.nc) just set
$CDF_EMIS="Emis_GLOB_01deg_2010_month.nc"
in run.pl.

NB: Emis_GLOB_01deg_2010_month.nc and Emis_GLOB_01deg_2008_month.nc
do not have proper country codes (only HTAP regions).

All the MONTHLY_GRIDEMIS from ModelConstants/config files are removed.
The code find out itself whether the emissions are monthly or yearly by
checking that there are 12 records.

The new naming convention for emissions are used (lower case).

HTAP2 regions included in Country_ml.f90

The old scheme for road dust is also removed (was not in use).

The Emis_GLOB_01deg_YYYY_month.nc files were constructed from the data in
/home/mifajej/Emissions/HTAP2/YYYY/HTAP_'//trim(pollut(ipollut))//'_YYYY_01degLonLat.',month

If monthly emissions are used, one must set GRIDDED_EMIS_MONTHLY_FACTOR=F, otherwise
you double correct for monthly variations. The code will stop with a warning if you try.

Modified Country_ml, Emissions_ml, ModelConstants_ml, all config files (except outputs)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd May  Dave  3000

Introduced new MET2D system, to allow direct setting of meteorology outputs from
config_Outputs. Tested and works perfect for ustar_nwp, rh2m, u_ref, etc.
Some problems still for precipitation. Need to work out the right combination
of scaling.

The main benefit is to make it easier to set new output variables, without the
hard-coding we have so far used in Derived_ml. If it is a meteorological field
it should be possible to get it into d_2d from just the MetFields name.

config_Outputs_EMEPSTD
- added examples using new system, e.g.
 'met2d_t2m', 'MET2D', 'temperature_2m','-', 'degK', -99,  -99, F,1.0, T, 4,
- removed older ws10,SMI_deep,SMI_uppr, etc.
- BUG? Old Snow_m was found to be more like snow fraction than depth in m
  (The new met2d_snow_m gives the true depth in m.)

Derived_ml
- modified to use the new MET2D system
- some clean-up of debugging info
- typ renamed to class, since it came from f_2d%class
- SNOW renamed to XSNOW, since this was not giving the expected data

MetFields_ml
- added derivmet with type metfield, to store meteo not coming from NWP. Unlike met%
  we only need name and the pointer settings.
- added u_ref to derivmet as first example.

MosaicOutputs_ml
- some clean-up of debugging info

My_Outputs_ml
- added some of the new met2d variables to sites output

Sites_ml
- enabled setting of iz=0, to provide data from k=20 without surface correction
  (useful for e.g. coastal sites with no nocturnal depletion, or boundary
   conditions for e.g. ESX.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th April Peter 2999

Vertical interpolation of external netcdf files:
The model did not interpret correctly the vertical coordinates when
formula_terms = "ap: hyam b: hybm ps: PS p0: P0" (instead of "a: hyam ...)
This was used for Dust BC introduce in  version 2962.

Corrected vertical_interpolate in NetCDF_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 April 2015 Alvaro 2997

run.pl
- Use TNO-MACC-III for MACC runs (forecast/hindcast/analysis)

ZD_3DVar/Analysis/DA_Obs_ml
- Correct bug introduced in 2996.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24 April 2015 Alvaro 2993--2996

AOD_PM_ml,Chemfields_ml(Chem_ml.f90),
ZCM_EmChem09/Dust.species,ZCM_EmChem09soa/VBS_nonvolatile.species:
- Extend AOD/Extin_coeff calculation for 9 different wavelengths.
  Original code calculated optical properties for 550nm.
- Update some of the 550nm parameters.
- Resolve inconsistencies for dust (DDf, DDc) and elemental carbon
  (EEa, EEn) optical types.

AOD_PM_ml,Derived_ml,ZD_OZONE/My_Derived_ml
config_Outputs_EMEPSTD.nml,config_BM-EECCA.nml:
- AOD and Extin_coeff output set-up taken from OutputConcs, which is read as
  part of OutputConcs_config namelist.
- AOD calculations for a given wavelength are only performed
  if such output is required. Extin_coeff calculations are skipped if no 3D
  output is required.
- All AOD/EXT calculations and output will be skipped if USE_AOD=F in ModelConstants_config.
- Commented examples for AOD and Extin_coeff output can be found on
  config_Outputs_EMEPSTD.nml.
- Benckmark output (config_BM-EECCA.nml) consists of daily AOD_550nm
  and monthly EXT_550nm.

AOD_PM_ml,ZD_3DVar/Analysis/DA_Obs_ml:
- Use SpecExtCross array for AOD/EXT observation operator.

AOD_PM_ml
- Remove Copyright notice as it will be added by mk.OpenSource.

Derived_ml:
- Format and tidy up.

Output_hourly,ZD_OZONE/My_Outputs_ml:
- Defer hourly AOD output to Derived (D2D) output.
- Ignore DEBUG_POLLEN when .not.USE_POLLEN.

Nest_ml, ZD_Pollen/Pollen_ml:
- Fix bug introduced ca 2987:
  FORECAST mode wrongly assumed USE_POLLEN.

Nest_ml, ZD_Pollen/Pollen_ml:
- Fix bug introduced ca 2987.
  Advected pollen variables where read to xn_adv(-1,:,:,:).

run.pl:
- Move $KEEP_LINKS variable definition next to $RESET, $COMPILE_ONLY,$DRY_RUN
  definitions.

Makefile:
- Variable ARCHIVE enables/disables the archiving of source code.
  ARCHIVE=no by default. make ... ARCHIVE=yes will create the *.tar.bz2 file.
- Use variable BINDIR to compile the model into a different path than $ProgDir.
  make ... -C $ProgDir BINDIR=$RESDIR will link into $RESDIR/Unimod
  instead of $ProgDir/Unimod.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24 April 2015 Dave 2989-2991
==============
rv4.7beta1 = 1st bug fix.

ZCM_EmChem09/EmChem09.reactions:

Bug fix:
was:
APR2015
_func_kaero(rh)              HNO3 = NO3_c        ;

now comment out, as Aer2015.reactions has more explicit methods:

*APR2015 _func_kaero(rh)              HNO3 = NO3_c        ;


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21 April 2015 Dave 2989-2991
==============
rv4.7beta !!!!
==============

Main change: Aerosol reactions use Gerber-calculated surface area
             + very low gamma values for N2O5

For HTAP: can now output stomatal deposition


RESULTS WILL CHANGE SIGNIFICANTLY WHEN USING NEW DEFAULTS!
  Older  (let's say rv4.6) results can be restored if setting
  n2o5Hydrolis='OrigRiemer' and Aero=" " in mk.GenChem

NEW: ZCM_EmChem09: Aero2015.reactions, Aero2015.species

NOTE!:
  These are now used by default by mk.GenChem - with Aero="Aero2015".
  Set to " " to switch off. (Should make Aero same as Isotopes etc., but
  lacked time....)

ChemFunctions_ml

- Two new recommended functions for gamma(N2O5):
  Gamma:0.002   (was bLow in April 2015 aero tests)
   - provides simple gixed gamma of 0.002
  SmixTen       (was bTen in April 2015 aero tests)
   - provides gamma  which depends on chemical mixture, but reduced by a factor
     of ten.

Derived_ml
- removed USTAR_NWP, Snow:

ModelConstants_ml:
- default n2o5Hydrolysis set to 'SmixTen' (=bTen in April 2015 tests)
- default CONVECTION_FACTOR set to  0.33   (=cv33 in April 2015 tests)

MosaicOutputs_ml
- enabled output of stomatal fluxes (needs STO_ prefix in DDEP_WANTED array)

mk.GenChem
- uses Aero2015 by default. SEE NOTE ABOVE

GenChem.pl
- access AERO from ModelConstants


config_Outputs_EMEPSTD.nml, config_BM-EECCA.nml

- moved USTAR_NWP, Snow to new OutputMisc fields
- n2o5Hydrolysis set to 'SmixTen' by default
- USE_CONVECTION set F for BM runs

config_Outputs_EMEPSTD.nml
- added O3 and  STO_O3 to DDEP_WANTED

config_EMEPGLOB.nml
- n2o5Hydrolysis set to 'SmixTen' by default
- CONVECTION_FACTOR     = 0.33 by default

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20 April 2015  Dave 2988

ChemFunctions_ml
- Added Gamma:0.002 and Smix, SmixTen  methods for n2o5Hydrolyis - as used
  in global testing of 2982 series


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17 April 2015  Dave 2988

Commit of tidy ups, made before a new attack on Derived outputs...

FIX: ZCM_EmChem09/EmChem09.reactions
- commented out _func_HydrolysisN2O5('OrigRiemer')    Rnwater  since
  it only worked if isotopes used.

DryDep_ml
- Many debug clean-ups
  (Added mysub string for these)
  Gsto added
  K2 => KMAX_MID to help condense code
  Partial cleanup and re-format

LocalVariables
- Added StoFrac, Gsto

ModelConstants_ml
- DEBUG%RSUR replaces DEBUG_RSUR
  AERO for surface area extended to 8 (will be cut down soon)

MosaicOutputs
- Added Gsto
  Removed some unused Gns code

Rsurface_ml
- Added Gsto instead of Gns
  debug tidy-up

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 April 2015  Alvaro 2984--2987

Nest_ml,ZD_Pollen/Pollen_ml:
- On Forecast mode, write pollen species to the pollen/restart file (*-pollen.nc)
  instead of the dump/restart files (*-dump.nc).

run.pl:
- Analysis and Forecast runs for 5+ days be runs as in hindcast mode,
  ie will use the 00UTC-D0 or 12UTC-D1 datasets.
- Forecasts will look for dump/restart files (CWF_$k-dump.nc) in the following order:
  00AN, 00FC, 00, 12AN, 12FC, 12, current-run.
- Forecasts will look for pollen/restart (CWF_$k-pollen.nc) files in the following order:
  xxAN, xxFC, xx, current-run, where xx is the met version (00 or 12).

NetCDF_ml:
- Limit printout messages to MasterProc in vertical_interpolate.

ZD_OZONE/My_Outputs_ml:
- add MY_OUTPUTS:="TRENDS@12UTC" hourly output definition

Output_hourly:
- only output at 12UTC for MY_OUTPUTS such as "TRENDS@12UTC"

Functions_ml, ZD_3DVar/B_NMC/Util_ml,
ZD_3DVar/Analysis/DA_3DVar_ml,DA_Obs_ml:
- move norm interface and and norm_* module functions from Functions_ml to Util_ml.

config_EMEPSTD.nml,config_FORECAST.nml:
- add missing come after DEBUG%IJ definition
- tidy up ExternalBICs_bc for "EVA_EU_FC"

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14 April 2015  Dave 2983

ModelConstants_ml, Met_ml, config_EMEPGLOB.nml

 - added CONVECTION_FACTOR. Values < 1.0 reduce convective fluxes from default
   value (=1)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12-14 April 2015  Dave 2980-2982

NEW - start of easier outputs for d_2d fields. The OutputMisc field system
  lets the user add new variables directly in config_Outputs, although
  of course Unimod needs to know how to deal with the "class" and names given.
  class type now for these OutputMisc is 'USET' (user-set), will likely
  refine later.

  I have added the example USTAR_d which should give exactly the same output
  as the older USTAR_NWP from My_Derived, without the need for the code in
  My_D.  (Code is still needed in Derived to know how to deal with this class
   of output though.)

  I also added a class rct where Setup_1d_ml sets d_2d values directly
  from the rct values. (Used for comparing loss rates.)

  This will hopefully enable us to get rid of My_Derived soon :-)

New - AeroFunctions! (should have been in 2979. Updated now anyway)
- functions to calculate wet-radius (Gerber method), surface area, etc.
  now has kaero routine (which is chemistry-independent)

Chem_ml
- added cHNO3, aero_fom, etc. for aerosol calculations

ChemFunctions_ml
- HydrolysisN2O5 has  many more options for gamma factors, using functions
  from AeroFunctions
- kaero renamed xkaero, now not used.
  (Logic is that "physics" functions are kept in AeroFunctions. These know
   nothing about EMEP model chemical species or assumptions. Functions which
   need access to chemical information are kept in ChemFunctions.)

OwnDerivedTy, My_Derived, Derived
- modified to allow new OutputMisc types, and better initialisation
- plus SurfArea added in Derived - surface area of different aerosol types

ModelConstants, Setup_1d_ml, Setup_1dfields_ml
- changes to calculation of aerosol surface area
- allows rate coefficients (class RCT) to use new OutputMisc system, here
  setting d_2d directly

ModelConstants
- changes to calculation of aerosol surface area, in AERO%
- allows rate coefficients (class RCT) to use new OutputMisc system, here
- added USES%n2o5Hydrolysis
- added DEBUG%STOP_HH to enable run-stop after e.g. 1 hour.

MosaicOutputs
- better use of sub='AddMosaicMetConc:' for debugging

Unimod.f90
- added DEBUG%STOP_HH to enable run-stop after e.g. 1 hour.

ZCM_EmChem09/EmChem09.reactions
- use kaero(rh) from AeroFunctions.
- has fake reaction of Rnwater to allow debugging of Riemer and gamm

ZD_ESX/refman.pdf deleted. Was starting to take space, and can anyway be
  generated from script.

config_EMEPSTD, config_Outputs_EMEPSTD, config_BM-EECCA
- added USES%n2o5Hydrolysis
- added new SurfArea and 'USET'
- added DEBUG%STOP_HH to enable run-stop after e.g. 1 hour.

GenChem.pl
- add call to AeroFunctions

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th April 2015  Dave 2979
- introduction of surface area calculations. So far not used, but intended
  as outputs.
- results so far identical to 2976

Chem_ml, Setup_1dfields, Setup_1d_ml
- adapted to provide and calculate SurfArea_m2m3 and S_m2m3

Derived_ml, config_EMEPSTD
- added SurfArea outputs

ModelConstants_ml
- Renamed AERO%diam to AERO%DpgV, added %DpgN and consistent calculation from
    DpgV to DpgN.
- Added NSD_F, etc, for surf-area

SeaSalt_ml
- Use Gerber functions to get wet-radius
  Rename diam to DpgV

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd April 2015  Dave 2976-2978
- small preparations for new aerosol system

config_EMEPGLOB.nml - NEW!
- defines settings for global runs, which typically differ from EECCA runs,
  eg PFT_MAPS, GRIDDED_MONTHLY_FACTOR
  Needs care with emissions settings! This version uses emislist.

NumberConstants - NEW (from ESX)
-  defines UNDEF_R, UNDEF_I which can be used in initialisations

OwnDataTypes
- now uses NumberConstants to get UNDEF_R, UNDEF_I

Makefiles.SRC
- added NumberConstants

ModelConstants, Emissions_ml, TimeFactors_ml, config_XXXX
- Changed USE_DEGREEDAY_FACTORS, USE_GRIDDED_MONTHLY_FACTOR to USES% system, so
  now in config

SeaSalt_ml
- uses DEBUG%SEASALT instead of DEBUG_SEASALT

Setup_1d_ml
- Added isnan test on 1st call to set_rct_rates (suggested by Peter)
- Also added cleaner debug_flag system, isnan on NO2, and removed IXADV_ + NSPEC_SHL usage

Sites_ml
- reduced outputs to MasterProc

GenChem.pl
- added safety setting of rct to zero
- removed unused Branching statements

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31th March 2015 Alvaro, Arjo 2974,2975

run.pl:
- Use $CDF_EMIS as the file to be used for "CdfFractions",
  instead of relying on commented/uncommented sections of the script.
- Link "CdfFractions" file for MACC14 emissions.
- Small clean-up - suggest deletion of emis_, but much more needed.

Functions_ml:
- optional arguments to norm_* functions available trough norm interface:
  w: integer array of weights of the same dimension as the variable.
  reduce: logical input to calculate the norm of a variable stored on
    local/partial arrays on each PROC (call MPI_ALLREDUCE).

ZD_3DVar/DA_ml,Analysis//DA_3DVar_ml,DA_Obs_ml:
- Specific debug variables/options for 3Dvar and Obs modules.

ZD_3DVar/Makefile,Makefile.SRCS
- MPI version of optimization utility (m1qn3-mpi.f)
- Remove non-MKL blas library options

ZD_3DVar/Analysis/DA_3DVar_ml,chitox_ml,ufftw3_ml
- Avoid half<-->full complex transformations, by only using half-complex arrays
  and calculating the norm as a weighed L2 norm.
- Distinguish between eVal/eVec on the local/global (nvLoc/nvTot) spectral grid.
- Rename/move subroutine update_unobserved (DA_3DVar_ml) to chitou (chitox_ml).

ZD_3DVar/Analysis/DA_3DVar_ml,DA_Obs_ml
- Remove 4-point interpolation options.
  Only use the grid-cell that contains the observation.
- Update bias correction routines for MPI calculations (untested)
- Increase memory on optimization calls (nupdates from 4 to 20)

ZD_3DVar/B_NMC/covmat_ml:
- write correlation matrix.

ZD_3DVar/B_NMC/spectralcov_ml,stddev_ml,spectral_filter:
- Make KTRUNC a parameter in spectralcov module.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th March 2015 Alvaro, Birthe 2972-2973

PhyChem_ml:
- comment call to gravset (included on 2968)
- uncomment ANALYSIS calls (commented on 2967)

GridValues_ml:
- Fix minor bug in Alloc_GridFields. Wrong exit condition on vertical level
  interpolation.

CheckStop_ml:
- Add integer range check (rangeI) to CheckStop interface
- Rename real range check (rangeR) on CheckStop interface

TimeDate_ExtraUtil_ml:
- Declare function interfaces for swapping between different date formats as public.
  to_stamp, to_date and to_idate take a date on any supported format:
  timestamp (type), date (type) or idate (int array).
- Add interface date2file. Like date2string transforms a date (various formats)
  into a string, with additional options for looking for over previous dates
  if the file for the specific date is not found.

Derived_ml:
- On FORECAST mode select output depending on length of run (number fo days)

Unimod.f90:
- Replace hard--coded 39 length of lastptim on MPI_SEND/RECV calls,
  so additional timing IDs used for 3DVar are also sent/received.

ForestFire_ml:
- Adapt "single opening of file" feature (introduced on 2942) to work
  on FORECAST mode. New files are opened inside newFFrecord function.
- Use date2file instead of nctime2string for persistence.

ForestFire_ml, Nest_ml, :
- Use CheckNC (CheckStop_ml) instead of check (NetCDF_ml).
- Explicitly declare variables and functions used from netcdf module.
- Clean up calls to necdf procedures.

ExternalBICs_ml, config_FORECAST.nml:
- Year dependant mappings versions for MACC_EVA:
  Rename IFS_MACC_EVA mapping version to EVA_EU_AN (up to 2012),
  and add EVA_EU_FC (from 2013).
- Accept explicit mappings for MACC_ENS and MACC_EVA versions.
- Remove EnsClimRCA BICs mapping from config_FORECAST.nml, as it is never used
  on FORCAST/ANALYSIS runs.

ExternalBICs_ml, Nest_ml:
- When the BC file for a given date, look for a file from a previous date up
  to BC_DAYS old. This is used for re-runs with MACC_ENS BCs,which contain 5 days each.
  The previous implementation switched BC file after reading all records in it.

Nest_ml, config_FORECAST.nml
- Use new logical variables native_grid_3D and native_grid_BC,
  read in Nest_config namelist, to indicate if the IC/BC files are on the same
  grid/domain as the current run. This is used to skip the expensive call to
  grid2grid_coeff in init_nest.
- Use new logical variable omit_zero_write, read in Nest_config namelist,
  to indicate if constant=0.0 variables are to be skiped from output.

Nest_ml
- FORECAST no longer supersedes MODE, in order to smplify the code.
- Update filename_read_3D, filename_read_BC and filename_write from their
  respective templates within init_icbc.
- Call init_icbc on Config_Nest to ensure that the variables for IC/BC mappings
  are found.
- Set output type for all variables (Real4) in a consistent manner
  (DFtype=>Real4), instead of in each Out_netCDF call.
- Declare coordinates of sub-domain to write as public.
- Replace StopAll by CheckStop calls.

NetCDF_ml, Nest_ml:
- Rename and move max_string_length parameter in Nest_ml to max_filename_length
  in NetCDF_ml
- Set all fileName* variables (NetCDF_ml) to max_filename_length,
  to ensure that the full path/fileNames from Nest_ml are kept.

NetCDF_ml:
- Out_netCDF:
  - Ensure ncfileID_given input/output variable (introduced in 2961)
    contains the correct valid ncID when create_var_only=.true.
  - New parmeter IOU_GIVEN=-IOU_INST to indicate present(ncfileID_given).
  - Use variable iotyp_new in Out_netCDF to hold iotyp or IOU_GIVEN.
- GetCDF_modelgrid:
  - Remove duplicated output from .not.MasterProc.
- vertical_interpolate:
  - Use explicit array dimensions on Rvar (input) and Rvar_emep (output) variables.
    Previous version could exceeld variable boundaries, depending on the
    domain and NPROC.
- createnewvariable, GetCDF_modelgrid, Out_netCDF and vertical_interpolate:
  - Add crash/debug information to necdf calls trough check function (CheckNC).
  - Clean up calls to netcdf procedures.
  - Replace StopAll by CheckStop calls.

Makefile:
- Add $(SRCS.$(EXP)) to %.tar.bz2, so source code from ZD_3DVar/Make.SRCS
  is also archived.

run.pl,config_FORECAST.nml:
- Set $MAKEMODE for MACC runs based on $ENV{"PBS_JOBNAME"}.
- Always recompile model (make clean) for MACC runs.
- So not interpolate vertical leveld on meteo for MACC14 domain.
- Do not link $HDD file for MACC14 domain.
- Write full path to pollen input files into Pollen_config namelist.

ZD_Pollen/My_Pollen_ml,Pollen_const_ml,
- new version with grass & olive pollen, in addition to birch pollen.

ZCM_EmChem09/Pollen.species,Pollen.reactions:
- rename POLLEN_B specie to POLLEN_BIRTCH
- add POLLEN_OLIVE and POLEN_GRASS species
- add POLLEN group for all POLLEN_* species

config_Outputs_EMEPSTD.nml:
- Add POLLEN (GROUP) output for MACC-ENS runs
- Add O3 output in ug/m3 for MACC-EVA runs

config_Outputs_EMEPSTD.nml, config_BM-EECCA.nml:
- Remove POLLEN_B (SPC) output

ZD_OZONE/My_Outputs_ml.f90, Output_hourly:
- MACC_ENS mode: output grass & olive pollen, in addition to birch pollen.
- MACC_EVA mode: use D2D_inst outputs
- MACC_NMC mode: do not output hourly

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th March 2015 Peter  2971

adv_vert_fourth, 4th order Bott for the vertical routine available
(but not used).
Only there for possible test in the future (not switch included).
Only small differences noticed for O3 (a few ppb), much less for SIA.

adv_vert_zero, also available, but give large differences, and may therefore
still have bugs.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th March 2015 Birthe  2968

Added Gravset_ml for gravitational settling hardcoded for ash, and added
USE_GRAVSET in ModelConstant_ml and calling in Physchem_ml for this module,
but they are commented out

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th March 2015 Peter  2965

Removed a hardcoded "3" which should be METSTEP.
(does not make any difference for now, but it is easy to forget if we change
metstep one in the future)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th March 2015 Peter  2964

Gridded monthly timefactors can be switched on with
USE_GRIDDED_EMIS_MONTHLY_FACTOR
in  ModelConstants_ml.f90
It uses the file ECLIPSEv5_monthly_patterns.nc and the mapping between sectors is
defined (hardcoded) in Read_monthly_emis_grid_fac in Timefactors_ml.f90

Careful with normalization:
A constant emission means a value of nmdays(month)/nydays in ECLIPSEv5_monthly_patterns.nc,
but when use as a multiplicative factor for tfac, GridTfac = 1.0 corresponds to constant
emissions.

Careful with normalization 2:
The fac_emm which normally (in case ASCII factors) are used for monthly timefactors, are now used to
renormalize the monthes, in order to correct for varying number of week-ends.

The ASCII monthly factors are overwritten, i.e. not used if
USE_GRIDDED_EMIS_MONTHLY_FACTOR=.true.

Modified:
Timefactors_ml.f90 NetCDF_ml.f90 ModelConstants_ml.f90 run.pl Emissions_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th March 2015 Peter  2963

Bug when there is no stations in the rundomain. The program crashed with error:
 NetCDF: NC_UNLIMITED size already in use
 ERRMSG: dim:station

Added two if(NStations>0)then conditions, which avoid creating and writing the
NetCDF sites/sondes file.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th March 2015 Peter, Svetlana  2962

Dust BIC is read from a Global NetCDF file. The values have been obtained with a
global run of the model.
The molwt as defined in the file is 200 g/mol.
The fields set here are defined in CM_BoundaryConditions.inc for IBC_DUST_f
and IBC_DUST_c

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th March 2015 Peter, Riinu  2961

When writing nest BC on one single file, the model crashes after a long time
(for instance 35 days), without apparent reasons. The crash occurs when the file is attempted closing,
with the error message: "Can't open HDF5 attribute".

The time after which it crashes depends on the size of the domain and the number
of components, but it is the same if debug options are set.

No direct solution has been found. One indirect solution is to write into a
different file every month (or day).

Another indirect solution which is implemented in this revision, is to keep the
file open between each component write; this is also faster.

Modified NetCDF_ml, Nest_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th March 2015 Peter, Alvaro  2959-60

NETCDF_DEFLATE_LEVEL = -1 (netcdf 3 output) was broken.
Moved a put_var for P0 after enddef.

MARS_ml more diagnostic output when  'RPMARES: not safe to divide', so that we
can analyze what happens

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd March 2015 Peter, Agnes  2955-2958

Bug introduced in version 2927. Femis reduction for countries with code higher
than 93 would not function if the emissions were in NetCDF.
(A conversion between country code and index was missing in Netcdf_ml)

Also the CC in RunLog was wrong

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th February 2015 Dave  2954

HEADERS added to ZCM_EmChem09ecom/EMISSPLIT/emissplit.defaults.omco
(fixed error found by Agnes)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th February 2015 Peter  2951-2953

Emissions_ml with netcdf emissions: variable names read from EMIS_FILE(iem).
NB: Names in Emis_GLOB_05.nc and Emis_TNO7.nc in $DataDir have been changed,
so as to match names in EMIS_FILE

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th February 2015 Dave  2949-2950

For G20 but also other projects - new system which expects separate OM, EC
and REMPPM for fine and coarse aerosols.

Added

  ZCM_EmChem09ecom directory
      - has EC_OM.reactions with these new emissions
      - EMISPLIT files
      - Biomass files

  mk.GenChem has added EmChem09ecom option

WARNING:

Emissions_ml had hard-coded NC_EMIS_SPEC names, which will not work with
the new system. This needs to be altered anyway, so for now has been
commented out. CAN NOT USE cdf-fractions untuil this is fixed!!!

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st February 2015 Peter 2948

Bug from version 2943
BoundaryConditions: the allocatable arrays for O3 BC where not saved, causing
the program to crashe sometimes at new monthes.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th February 2015 Peter 2947

Bug in trend_o3, was applied twice.
Affects runs with year_trend<1990 or  (year_trend<2000 and USES%MACEHEADFIX=false)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th February 2015 Peter 2943-6
(2946 was used for EuroDelta SOA. Denote as rv4.6 in Status Report 2017 Table)

Refactoring the GlobalBC_ml  and BoundaryConditions_ml.

All fulldomain arrays are removed and a lot of unnecessary buffer and indices.
GlobalBC_ml is not in use anymore; most of the content is moved into GetBICData,
but with local arrays instead of fulldomain arrays.

O3 read from Logan_P.nc, which is flexible wrt number of vertical levels.
Can slightly change O3 (<0.1 ppb?) compared to earlier versions.

DO_SAHARA removed. (DUST BC will be replaced by global values in later revision)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th February 2015 Peter, Dave 2937-2942

Changes in BIC, GlobalBCs_ml :

all Latitude profiles are removed! (set to 1)

Vertical profiles implemented for IBC_HCHO ,IBC_SEASALT_f,
IBC_SEASALT_C, IBC_SEASALT_G, IBC_CH3CHO, IBC_NH4_f, IBC_NO3_f
(were missing)

trend for O3 removed when Mace Head correction is applied for year 1990-1999

run.pl corrected for Inputs_Mar2013

ForestFire_ml with single opening of file. Some seconds saved, perhaps, for many
processors runs.

Write out which Mace Head correction is used in RunLog

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th February 2015 Dave, 2936

GlobalBCs_ml
  Mace Head correction for 2012 corrected....
   if((iyr_trend==year).and.(year>=1990).and.(year<=2011))then

  changed to use of MH_YEAR1=1990, MH_YEAR2=2012 (for now)

Also header comments removed.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th February 2015 Anna, Peter    2933

Mace Head correction for 2012 included

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th February 2015 Alvaro  2930--2932,2934

ModelConstants_ml, Output_hourly:
- HOURLYFILE_ending from ModelConstants_config

Output_hourly:
- Fix bug on PMwater at SRF level, likely introduced in 2597 (June 2013).
  Output was PM25_water (ambient) instead of PM25_water_rh50.

ZD_OZONE/My_Outputs_ml:
- DEBUG_PM10 option for MACC_ENS/MACC_EVA.

Sites_ml:
- Use D2D unit conversion (f_2d%scale) for NXTRA_SITE_D2D output.

Derived_ml:
- Additional units options for COLUMN output (MISC).
  Units can be specified in OutputConcs_config namelist
  by their unit name ('ug/m2,'molec/cm2,'1e15molec/cm2), or
  by their keyword ('mcm2,'ugm2','e15mcm2').

Functions_ml,TimeDate_ExtraUtil_ml,ZD_3DVar/B_NMC/Util_ml,
ZD_3DVar/Analysis/DA_3DVar_ml,DA_Obs_ml,DA_Bias_ml:
- Move norm function(s) from Util_ml to Functions_ml.
- Move compare_date from Util_ml to TimeDate_ExtraUtil_ml.

NetCDF_ml,CheckStop_ml,EmisGet_ml,GridValues_ml,
ZD_3DVar/B_NMC/Util_ml,Unimod_B_nmc:
- Rename/Move check in NetCDF_ml to CheckNC in CheckStop_ml.
- Use CheckNC instead of local implementation.

EmisGet_ml,GridValues_ml:
- Explicitelly declare the variables/procuderes in use netcdf.

NetCDF_ml:
- Bug fix on Create_CDF_sondes.
  Units with spaces in the text where wrongly parsed.

Nest_ml:
- On FORECAST, use compare_date function (TimeDate_ExtraUtil_ml)
  to determine the dates/times to write out a restart/dump file.

Functions_ml:
- Remove Copyright notice as it will be added by mk.OpenSource.

GridValues_ml:
- New function coord_in_domain. Functions coord_in_domain and coord_in_processor
  are special cases of coord_in_domain.

Makefile:
- delegate 'clean' & 'modules' to 3DVar/Makefile for %-Bnmc & %-3DVar targets.

run.pl:
- Use variable $KEEP_LINKS instead of $BENCHMARK{'cleanup'} to indicate if the
  links to input files are to be kept or removed.
- CWF MAKEMODE and CWFBC for MACC EVA 2013 runs.

config_FORECAST.nml:
- Update NMC options.

ZCM_EmChem09/EmChem09base.species
- O3 is now a member of DAOBS group, together with NO2.
  By default, the model is set up for assimilation of NO2 and O3 observations.

ZD_3DVar/B_NMC/Unimod_B_nmc:
- Read nv from and USE_EtaCOORDINATES from namelist.nml.
- Add logical variables trimX/trimY (unused) and deltaDateHH,
  read from namelist.nml.

ZD_3DVar/B_NMC/Util_ml:
- Read vertical coordinate ('lev'/'k') according to USE_EtaCOORDINATES.

ZD_3DVar/Makefile,B_NMC/spectralcov_ml:
- remove -DDEBUG_B cpp option and #ifdef DEBUG_B code.
- temporally disable BIAS_CORRECTION.

ZD_3DVar/B_NMC/spectralcov_ml:
- Resize nstar(nex),mt(nex,nex),nt(nex,nex)
  to nstar(nxex*nyex),mt(nxex*nyex,nex),nt(nxex*nyex,nex).
- New function atan2PI to reproduce MATCH code.
  Intrinsic atan2 gives a different result.

ZD_3DVar/B_NMC/covmat_ml:
- write_stat:
  - revert to old code on PS calculation (avoid real overflow);
  - reference level for correlations (lref);
  - check nmin/nmax range.
- diagonalise_covmat
  - Resize lambda(nv),ifail(nv)
    to vt(nbg,nv),lambda(nbg),ifail(nbg).

ZD_3DVar/B_NMC/stddev_ml:
- 6-hourly NMC.

ZD_3DVar/DA_ml,DA_Obs_ml:
- New logical variable DA_DEBUG_OBS.
- Tag DA info/debug messages with processor.

ZD_3DVar/Analysis/DA_Bias_ml:
- Change default value of biasStdDev (biasData%stddev read from BIAS_PREDICTOR namelist)
  to avoid DIV0 errors on new obs types.

ZD_3DVar/Makefile.SRCS,Analysis/DA_3DVar_ml,DA_Obs_ml:
- remove unused EXT_DOMAIN,EXT_DOMAIN_INV dependecy.
- use new space conversion (x<-->chi) subroutines from chitox_ml.
- Replace array xn_adv_ex by an_bgd,an_inc pointers.
- organize re-write loops withing H_op.
- track if an observation bellong to the local domain (pidx%local).
- Additional timining items (DA_3DVar_ml).

ZD_3DVar/Analysis/chitox_ml:
- new subroutines chi_Init initalizes space conversion (x<-->chi).

ZD_3DVar/B_NMC/Unimod_B_nmc,spectralcov_ml,Util_ml,
ZD_3DVar/Analysis/DA_3DVar_ml,DA_Obs_ml,DA_Bias_ml,ufftw3_ml,chitox_ml:
- Use HERE(MSG) macro on CheckStop calls.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th February  2015 Dave     2929

utils/Rd_csvsondes.f90 - added bug fix for undefined, and UNDEF_R to make it
    clearer. Also used site and pollutant name in output files.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th February  2015 Peter    2928

NetCDF_ml, ReadField_CDF: ncFileID_given when the file is already open.
                          The file is not closed on exit.

EmisGet_ml: ncFileID_given=ncFileID in EmisGetCdf.
Much faster if no emissions are read (took about 0.3 seconds to open the file).
Now "all" emissions can be read in about 3 minutes (instead of 18).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th January  2015 Peter    2927

Completely decoupled the array index in Country_ml and the country-code used in
emission files.
This is both more logical (you now choose for instance a country code= 1000000 without problems,
giving more flexibility for systematicdefinitions)
and will save array sizes, since NLAND is now exactely equal to the number of countries.

It does not give exactely the same results, because there was some bugs in the earlier version.
(Russia?). Hopefully this only affected a timefactor or split.
Modified:
Country_ml
Unimod
Timefactors_ml
EmisGet_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th January  2015 Peter, Jan Eiof    2926

Possibility to get total emissions after splits and including all natural
emissions. Units are mg/m2 (uses molecular weight of components, not only "N" etc.)
Put EmisSplit_OUT = .true. in My_Derived_ml.f90
For now put 18 splits (can be increased)
Modified:
Derived_ml.f90
Setup_1d_ml.f90
Emissions_ml.f90
ZD_OZONE/My_Derived_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th January  2015 Dave    2923-2924

TimeDate_ml - added same_date and print_date routines

   (from ESX work, but generally useful I hope)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th December 2014 Peter   2921

MARS_ml.f90 in some situations the "IS_SAFE_DIV" got true (once encountered for
GLOBAL run once for MACC14). It does not happen often.
This is probably because the test is done assuming that we use real*4.
We have set our "small numbers" as 1E-30, and the actcof routine contains a
GAMA=10.0**TRM which can be as much as 1E30.
sometimes (in combination with other small numbers) this triggers the test.

Threfore I have set:
IS_SAFE_DIV: R4=.FALSE. (for the "MARS" case)
Which did not trigger IS_SAFE_DIV, at least in the GLOBAL case.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th December 2014 Dave   2919-2920

NB: IN-PROGRESS VERSION
  Bug mentioned below is partially fixed if USES%PFT_MAPS set to true, but
  not all implications workde out yet. Also need to add SGS, EGS for crops
  which are not dealt with by PFT_MAPS. Also need to consider use of SGS in
  Biogenics_ml

  In other words, if considering global runs, THINK and CHECK!


MARS_ml (2919)
  Crashed on 23rd May 2010 global run. Now replaced CheckStop with write-out and
  exit from routine. Needs attention? (See DSMARS lines, and nMarsErrors usage)


Landuse_ml
ModelConstants
config_EMEPSTD
(Other configs will need adapting!)

  DEBUG% PFT_MAPS, LANDUSE and DO3SE now use integers. Specify 1 for basic
   debug, 2 for more verbose.

DO3SE_ml
  Added gsf scaling factor to fPhenology to account (in a crude way) for EGS-SGS < 90 days.
  Removed elemental tag to allow print out.

LandDefs_ml
   Small debug output change

Sites_ml
  Set debug_1d = .false. to avoid excessive printouts.



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th December 2014 Dave   2918

NB: Bug discovered in Landuse_ml: effectivdaynumber usage gives wrong
  growing seasons. Will be fixed in next days.

AOTnPOD_ml: added SpringWheat, WinterWheat PODs
DO3SE_ml: increased MAXnSumVPD
DryDep_ml: DEBUG for DRYDEP now as DEBUG%DRYDEP
LandDefs_ml: DEBUG for LandDefs_ml now as DEBUG%LANDDEFS
Landuse_ml:
   Added initial code to read growing seasons from GAEZ-CRU system, with
    VEG_2dGS, Veg_2dGSparams from config
   DEBUG for Landuse_ml now as DEBUG%LANDUSE
   Added initial code for SpringWheat, WinterWheat
   Added some extra debugs while chasing effectivdaynumber bug
ModelConstants_ml
   Moved DEBUG as decribed above
   Added VEG_2dGS, Veg_2dGSparams for config
MosaicOutputs_ml
   Added LAI as one of the MOSAIC_METCONCS array (gives e.g. LAI_GR - exposes bug very well
   near equator!)
   DEBUG for MOSAICS now as DEBUG%MOSAICS
My_Derived_ml
   Added MMC_LAI
   Added PODs for SpringWheat, WinterWheat PODs
   (should all be moved to config!)
   More MET_LCS to get LAI while chasing bug
StoFlux_ml
   DEBUG for STOFLUX now as DEBUG%STOFLUX


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22nd December 2014 Peter  2916

Emissions can be reduced according to a mask file. The mask file must be of the same
size as the native emissions (i.e. not necessarily the same as model grid).

Usage:
in ReadField_CDF the following optional variables can be set:

     Mask_fileName,Mask_varname,Mask_Code,NMask_Code,Mask_ReducFactor

  !Mask_fileName -> name of the file
  !Mask_varname -> name of the variable used for mask ,
  !Mask_Code(1:NMask_Code) -> values from the mask_value for which to apply
  !the reduction (reduction is applied if any of the Mask_Code=Mask_value)
  !NMask_Code -> size of the array Mask_Code with defined values
  !Mask_ReducFactor -> multiplicative factor for reduction where mask applies


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22th December 2014 Alvaro  2914,2915,2917(Log.changes)

Sites_ml,NetCDF_ml:
- Rewrite siteswrt_surf, siteswrt_sondes, siteswrt_out (Sites_ml),
  Create_CDF_sondes & Out_CDF_sondes (NetCDF_ml), so the station meta-data
  can is stored on variables instead of attributes.
- Instead of using multiple arrays for attribute names and values for each
  attribute type (string/integer/real), use string arrays to hold all
  meta-data.
- Global attributes and station meta data are collected on MetaData array, and
  variables names attributes (long_name, units, _FillValue) on SpecDef array.
  MetaData and SpecDef are phrased on Create_CDF_sondes to retrieve the information.
- Special care is taken to match variables and _FilValue types.

Units_ml:
- Correct mcm2 (molec/cm2) and e15mcm2 (1e15molec/cm2) definitions.
  This units do need to be further multiplied by roa to complete the conversion.

config_BM-EECCA.nml:
Following changes on config_EMEPSTD.nml
- Remove unused DEBUG%GLOBBC and DEBUG%HOURLY_OUTPUTS
- Add USES%PFT_MAPS
- Set EMIS_OUT=F and need_poll=F

Convection_ml,Derived_ml
- Remove unused INCLUDE 'mpif.h' statement.

MassBudget_ml:
- Add comment about "use mpi" statement.
- Remove unused MPI variables.

run.pl,Makefile:
- Write svnversion to .version with `make version`,
  so run.pl has access to version number in vilje compute nodes.
- Keep linked files on BM runs
- Reduce the FORECAST/HINDCAST threshold from 10 days to 6 days for MACC-ENS/EVA.
- Increase MPI_BUFS_PER_PROC on vilje runs

Makefile:
- Use `nc-config --cflags` (only include paths)
  instead of `nc-config --fflags` (include paths and optimization options)
  to avoid possible incompatibilities with options on OPT_FLAGS or DEBUG_FLAGS
- Move -cpp $(DFLAGS) from line 15 to line 71 so they are available to all
  supporeted machines/compilers

Derived_ml:
- Use to_molec_cm3 instead of to_number_cm3 (same constant) to improve readability.

CoDep_ml,DryDep_ml,Convection_ml,OutputChem_ml,GridValues_ml,BoundaryConditions_ml,
Setup_1d_ml,DO3SE_ml,Io_Progs_ml,Volcanos_ml,EmisGet_ml,Landuse_ml,Derived_ml,
Emergency_ml,Wesely_ml,LandDefs_ml,Rsurface_ml,ZD_OZONE/My_Outputs_ml:
- Replace '/**' in comments by '***', as they cause an error for gfrtran -cpp.

CoDep_ml,BoundaryConditions_ml,DO3SE_ml,Io_Progs_ml,Volcanos_ml,
Wesely_ml,Rsurface_ml,Sites_ml:
- Remove Copyright notice as it will be added by mk.OpenSource.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

18th December 2014 Peter, Massimo  2913

Additional "if" that allows to use WRF metdata directly from WRF output.
Experimental. Needs to be developed. Should not influence other runs.

MetFields_ml
GridValues_ml.f90
NetCDF_ml.f90
Met_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th December 2014 Peter, Dave, Svetlana  2911-2912

Test versions of MARS. We have now:

MARS_2900 : version that we had up to now
GEOSCHEM : GEOSCHEM version. NB: this version is not continuous
MARS : Small (?) improvements compared to MARS_2900. Complete list of improvements:
1) TSO4 = MAX( FLOOR, TSO4  )
2) IF ( fRH .LT. 0.01 ) -> return original values
3) if( (TSO4 <= MINSO4 ) (instead of "<")
4) IF ( .NOT. ( IS_SAFE_DIV( GAMAS2, GAMAS1*GAMAS1*GAMAS1, R4=.TRUE. )&
                 .AND. IS_SAFE_DIV( KNA, GAMANA*GAMANA, R4=.TRUE. ) &
                 ) ) THEN
                WRITE(6,*) 'RPMARES: not safe to divide...exit'
               call CheckStop("UNDER/OVERFLOW in rpmares (MARS)")

5) IF (HPLUS <= 0d0)-> return original values
6) MHSO4 = MAX( 1.0d-10, MHSO4 )
7) if(abs(GAMANA)<FLOOR  .or. abs(GAMAS1)<FLOOR) -> return original values
8) ASO4_Low = MSO4 * WH2O * MWSO4 !pw added after [rjp, 12/12/01]
9)  after 1601      ASO4_Low = TSO4 * MWSO4    ! PW after [rjp, 12/17/01]
(8) and 9) showed no effect in a 1 month test)
10) ANH4 = NH4, GNO3 = HNO3 if((TSO4 <= MINSO4 ) .and. (TNO3 < MINNO3)), and under IF ( TNO3 <= MINNO3 )
11)removed if( XXQ > 1.0e-30 )  (introduced 2907) . NB: XXQ always <0!

One month run (June, EECCA) showed a max difference of 0.15 ug/m3 for SIA
and much less in random places.(new MARS-GEOSCHEM)

Between "new" and "old"(2900) MARS the SIA differences were less than 0.01 ug/m3 at max.

In addition small (?) change in awater in MARS_Aero_water_ml when x < 1.9999
Y2     = ( 1.0 - MFSSO4 ) / MFSSO4
(MARS_2900 use also the new version of awater)


AerosolCalls.f90 adapted for allowing "MARS_2900" and "GEOSCHEM"
config_EMEPSTD: adapted comments for AERO%EQUILIB
ModelConstants_ml: character(len=15) :: EQUILIB  (was only len=5, too small)

Netcdf_ml: sondes.nc, positive = "up"

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th December 2014 Dave,  2908-2909

Start of Isorropia 2.1 capability. Files added and/or modified to work towards
usage of Isorropia aerosol thermodynamics code

new files:

isocom.f90
ISOFWD.f90
isorev.f90
isrpia.inc

Changes in:

AerosolCalls - cleaner interface (switches between MARS, EMEP, EQSAM, ISORROPIA
 now done here, not in RunChem)
 My... routines renamed to emep2... routines (eg emep2MARS)

Runchem_ml - now just calls  AerosolEquilib instead of My_MARS etc.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th December 2014 Dave,  2907

BUG and CRUDE fixes :-(

1) BUG fix:

DryDep_ml

  Vds for nitrate -  new equation from 2894 had wrong formulation.

2) CRUDE fixes for MARS

AerosolCalls

  Added FLOOR2 = 1.0e-9 #/cm3 as min conc. on input. Not nice, but with 90% of all
  crashes coming from the MARS module we need to do something.

  WILL TEST WITH SMALLER VALS to make sure this isn't too important. As noted below,
  the current codes are in-development.

MARS_ml:

  if( XXQ > 1.0e-30 ) then!CRUDE FIX
             RR2 = CC / XXQ
  else
             RR2 = 1.0e30 !CRUDEVIX
  end if
  (was just RR2 = CC / XXQ, which crashed and crashed...)

WE NEED TO DROP MARS!


CheckStop - slightly more informative ERROR message

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th December 2014 Dave,  2906

ZD_OZONE/My_Aerosols renamed to AerosolCalls.f90 in main dirctory - no need
for "My" treatment now that the AERO stuff in the namelist makes all choices.
(By the way, that module didn't have a "private" statement. All modules should
 have that.)

One fewer "special" My file :-)

Related changed in:

 AerosolCalls - change of name, and added private for safety
 Makefile     - no need for ZD_OZONE/My_Aerosols
 Makefile.SRCS
 RunChem_ml


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th December 2014 Dave,  2905

AERO% created as namelist variable, contains NSIZE, EQUILIB, diam, etc., plus Vs
(enables faster switch from MARS to othe schemes.)

AERO Changes in:

 - Aero_Vds_ml - SettlingVelocity now elemental
 - Derived_ml
 - DryDep_ml
 - ModelConstants_ml
 - RunChem_ml

Plus tidy-ups in:

 - EmisGet_ml
 - NetCDF_ml - more use of MasterProc

Extra print ut

 - GridValues - some prints to figure out south pole stuff (unfinished)

Corrected text in

utils/Rd_emepcdf.90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th December 2014 Dave,  2904

Partial reversion to avoid pre-processing, and to enable compilation om stallo:

Makefile - removed VERSION

run.pl - added result of svnversion to runlabel2

MassBudget_ml - had to modify MPI stuff to enable compilation. (Not sure why)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th December 2014 Peter, Jan Eiof 2903

Sites_ml.f90
Bug in NetCDF sondes output:
The name of the sondes-components got the names of the sites-components.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th December 2014  Alvaro 2902

Derived_ml:
- Explicitly set unitscale, unittxt and volunit for SHL output,
  as they are NOT supported by Units_Scale (Units_ml)
- Allow all units supported by Group_Units to be used on group_calc.
  Use needroa optional output on Group_Units to determine when to multiply
  by density

Units_ml:
- Declare explicitly when a supported unit should be treated
  as PPB class by Derived_ml (unit_map%volunit).
- Declare explicitly when a supported unit needs to be multiplied
  by the air density to complete the unit conversion (unit_map%needroa).
- Return unit_map%volunit and unit_map%needroa as optional output on
  Group_Units, Group_Scale and Units_Scale

ModelConstants_ml,Units_ml,Output_hourly:
- Rename MFAC to to_number_cm3 and move it from ModelConstants_ml to Units_ml.
- Move atwS, atwN from ModelConstants_ml to Units_ml.
- Remove unused atwPM variable.

ModelConstants_ml,PhysicalConstants_ml,
Sites_ml,MassBudget_ml,DryDep_ml,Aqueous_n_WetDep_ml,Setup_1d_ml,
ZD_OZONE/My_Outputs_ml:
(got random values)
NetCDF_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th November 2014  Dave   2894  - still v4.6gamma if needed.

NOTE: MORE CHANGES IN RESULTS!!!!

DryDep_ml.f90  - added no3nh4 ratio and usage
Wesely_ml.f90  - added CDDEP_PMfNH4 and CDDEP_LASTPM
ZCM_EmChem09/EmChenm09base.species - used CDDEP_PMfNH4 for NH4_f

Corrected bug in NH4 deposition (it was all depositing at the faster NH4NO3 rate,
 whereas (NH4)xSO4 should deposit as SO4. See no3nh4ratio in DryDep_ml
 Needed new assigment CDDEP_PMfNH4

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th November 2014  Dave   2893  - new label v4.6gamma if needed.

NOTE: CHANGES IN RESULTS!!!!

This is the first in a series of changes that will modify results. Next
change will be bug-fix for PM deposition. Then hopefully coarse nitrate
and something with stratospheric O3, etc....


NO2 bias changed from 10 to 6 for 2008 BM. Small changes for secondary components.

Added USE_SOILNO test to see if "no2fac" should be activated.

The intention was that no2fac reduces NO2 deposition for low NO2 (< 4ppb), which
is a crude way to mimic expected soil NO emissions. However, when we have
explicit emissions, no2fac should not be used.

SO: rv4.5 series below.....
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th November 2014  Alvaro 2892

Derived_ml,ZD_OZONE/My_Derived_ml:
- Remove "2D implies 3D" behaviour, simplify code and streamline usage.
  Before 2888 a "3D" output request implied a "2D" request
  with the same temporal resolution.
  From 2888 "2D" and "3D" could be requested with different temporal resolutions,
  as long "2D" was requested before "3D".
  Now "2D" and "3D" need individual requests, one each.
- Add warning messages (PrintLog) for Unsupported (Not coded yet) outclass/outtyp/outdim

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th November 2014  Semeena (commited by Peter) 2891

Derived_ml.f90, ZD_OZONE/My_Derived_ml.f90
Short lived species output

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th November 2014  Alvaro, Peter, Svetlana 2888-2890

Derived_ml.f90 and My_Derived_ml.f90 are fixed for writing out the same
parameter in 2d and 3d, and also at different time resolutions
(e.g. daily 2d and monthly 3d)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th November 2014  Alvaro 2887

ForestFire_ml,config_FORECAST.nml:
- Add 3 logical variables read trough Fire_config: need_file, need_date, need_poll.
  If .true. the model will crash when the file/date/pollutant is not found (default).
  For "skip pollutant if not found" behaviour (2634--2882),
  required for FINN 2012 emissions, set in Fire_config (config_*.nml):
    need_file=T, need_date=T, need_poll=F,
- Replace dependency to FORECAST variable.
  "Skip file|date|polutant if not found" behaviour by setting (config_FORECAST.nml):
    need_file=F, need_date=F, need_poll=F,

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29th October 2014  Peter 2886

Femis working for NetCDF-fractions emissions.
Mask put in place but not tested.

EmisGet_ml.f90 Emissions_ml.f90 NetCDF_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23rd October 2014  Peter; Massimo 2885

TimeDate_ExtraUitls_ml.f90

bug in our Time_Date library:
1412125200 seconds corresponds to 1st October 2014 01:00
but nctime2idate(ndate,1412125200) will return a date with hour=0;
because it compute seconds = 3599.99999, but these are not returned.

Superficial fix this by putting
ts%secs=nint(ts%secs) in  secs1970_to_int.

This is just correcting this particular case. Somewhere deep in the method there is still a
flaw with an improper mixing of real and int. Not nice to know that this can happen at anytime.

Probably no consequences, because we do not use "seconds since 1970" for many years.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22th October 2014  Peter 2884

Set USE_EtaCOORDINATES=.true. as default.
Should now work in any case.
GridValues_ml.f90: changed the setup for eta_coordinates.
Now eta_coordinates can be choosen as output, even if sigma are used in meteo.

(also the potential problem when nlevels is 20 mentioned in rv 2879 is solved.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22th October 2014  Alvaro 2882,2883

NetCDF_ml
  Fix minor bug on ReadField_CDF introduced on 2634:
- When a variable was not found in file (e.g. due a stallo disk hiccup)
  UnDef_local was used before definition (line 2449 Rvar=UnDef_local).
  Then, the model crashed if compiled with DEBUG=yes.
- Move UnDef_local assignment before nf90_inq_varid call.
- Restore "if(needed) STOP" behaviour lost on 2634.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th,17th October 2014  Alvaro 2880,2881

ForestFire_ml
- Add fire_year to Fire_config namelist, missing on 2878.
- Fix bug introduced on 2878. MODE="MONTHLY_AVG" gave wrong output.
- Calculate yearly averages from available records if MODE="YEARLY_AVG".

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th October 2014  Peter 2879

run.pl:
link always to Vertical_levels.txt. This used to work only for meteo files in
new format.
removed link to GridDef.nc (nobody used it)

GridValues_ml:
Avoid reading Vertical_levels.txt if another than 20 levels are found in the meteo file.
(this might be a problem only if there are 20 levels in the meteo file, but
another number is wanted. Not likely to happen often)

Trajectory_ml: default month 16 to avoid unnecessary MPI communication

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th October 2014  Alvaro 2878

ForestFire_ml
- Read time records instead of assuming 1-record/N-day structure.
- Implement persistence of forest fires. This is relevant for FORECASTS,
  or when no record can be found for current_date.
- Simplify GFED reading using 8-day persistence.
- Calculate monthly averages from available records if MODE="MONTHLY_AVG".
- Read config param from Fire_config namelist:
    MODE          "DAILY_REC" (default) || "MONTHLY_AVG"
    verbose       debug verbosity 0,..,4
    persistence   fire persistence in days (default GFED=8,FINN=1,GFAS=3)
    fire_year     override current year
    GFED_PATTERN  GFED path/file pattern
    FINN_PATTERN  FINN path/file pattern
    GFAS_PATTERN  GFAS path/file pattern

run.pl,ModelConstants_ml,config_EMEPSTD.nml,config_BM-EECCA.nml,
config_FORECAST.nml,config_EMERGENCY.nml,config_IMPACT2C.nml
- File pattern for forest fire emissions (GFED,FINN,GFAS)
  to be read in Fire_config namelist.
- Replace USES%MONTHLY_FF (ModelConstants_config) for MODE (Fire_config).

NetCDF_ml
- ReadTimeCDF will read all time records, when TimesInDays<1 on input.

Makefile
- Implement `make MACC-3DVar clean`

ZD_OZONE/My_Outputs_ml.f90
- Add DEBUG_PBL logical variable for additional output on FORECAST mode.

Nest_ml
- Fix typo/bug introduced on 2876

Emissions_ml
- allocate *glob*land variables on .not.MasterProc (with size 1),
  as required for DEBUG=yes options

Emissions_ml,ForestFire_ml
- Remove Copyright notice as it will be added by mk.OpenSource.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th October 2014  Alvaro 2877

Nest_ml.f90
  add "longitude", "latitude" and "level" to the list of recognised i, j & k
  dimensions on init_nest. Use new get_dimLen function on init_nest to obtain
  the dimension lenght given a list of possible dimension names.

run.pl, config_FORECAST.nml
  On FORECAST mode:
- Switch between MOZIFS and CIFS BCs according to date.
- Implement 0-DAY forecast (1 time step) for development/debugging.
- Use IC and BC files pattern on Nest_config namelist, see template_*
  in config_FORECAST.nml.

config_FORECAST.nml
- Add CIFS BCs description (IFS_CMP_g4e2).
- Rename IFS-MOZART description fo distinguis between MACC_ENS and MACC_EVA
  settings.

ExternalBICs_ml
  Asume IFS_CMP_g4e2 from 2014-09-18 for EXTERNAL_BIC_VERSION="MACC_ENS"

Units_ml
  Add "kg kg**-1" units support on Units_Scale

Unimod
  Skip call wrtxn at the end of the run on FORECAST mode.

Makefile
  Use `nc-config --flibs --fflags` to get linking flags (LDFLAGS).

ZD_3DVar/Makefile,Makefile.SRCS
- FFTW3 setup for stallo
- Cleanup MKL setup for stallo & villje.
- Add DA_Bias_ml.f90 to SRCS.3DVar

ZD_3DVar/B_NMC/spectralcov_ml
- Set parameter DAPREC (used on m1qn3 settings) so 1/real4 remains real4.
  This is consistent with accuracy on diagonalise_covmat.

ZD_3DVar/Analysis/DA_3DVar_ml
- Use ES12.3 format on debug printout.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th October 2014 Peter, Alvaro 2876

Bug in nesting, when the read frequency (NHOURREAD) is not equal to the BC-file
frequency.
In old versions this worked, but has been destroyed some time in the beginnging
of 2013?

put "date_nextfile" for both Forecast and normal case:
  filename_read_BC=date2string(template_read_BC,date_nextfile,debug=mydebug)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th October 2014 Birthe (Peter) 2875

Bug for grid resolution between 61 and 76 km, dt_advec was not set.
Advection_ml:  dt_advec=1800.0 for resolutions coarser than 61km

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th September 2014 Peter 2874
JUMPOVER29FEB can be set true in config file, and the 29th of February will
be jumped over. This is to be used in the case where it is not available in a
leap year (typically climate runs).
Note that this is difficult to do this in a 100% consistent way: date are
everywhere and used through TimeDate_ml libraries. For instance the number
of days in a leap year will still be 366, even if the 29th is jumped over;
therefore some diagnostics values may be wrong.
Met_ml.f90
PhyChem_ml.f90
ModelConstants_ml.f90

utils/meteoPreProc.f90 modified to allow leap years with 365 days.

Small change in NetCDF to avoid compielr error in debug mode.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th September 2014  Alan  2872

ZD_ESX/D_Misc/GenChem.py:
  - Remove deprecated 'rcbio:' support
  - Always process 'rcemis:' rates

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th September 2014 Alvaro 2869-2871

InterpolationRoutines_ml
- New subroutine point2grid_coeff takes care of the inner loops of grid2grid_coeff.
- Consilidate Weight1,..Weight4(NX,NY) output variables on grid2grid_coeff
  into a single output variable Weight(4,NX,NY), and update dimensions of output variables IIij,JJij(4,NXG,NYG).

InterpolationRoutines_ml,NetCDF_ml
- Update grid2grid_coeff calls and IIij,JJij,Weight variables on
  Nearest4interp (InterpolationRoutines_ml) and ReadField_CDF (NetCDF_ml).

Nest_ml
- call grid2grid_coeff on init_nest instead local (equivalent) code.
- Update IIij,JJij,Weight variables on init_nest, read_newdata_LATERAL and
  reset_3D (Nest_ml).
- Bug fix on readxn. Avoid div0 on time weights calculation (lines 282--288).
- On FORECAST mode, set filename_read_3D and filename_read_BC using ndate for
  correct debug messages

CheckStop_ml
- Add CheckStop_range subroutine to CheckStop interface.
  CheckStop(var,(/vr0,vr1/),msg) will stop the model if .not.(vr0<=var<=vr1).

TimeDate_ExtraUtil_ml
- add text keys "PPP" and "PPPP" to output processor number (me) from
  date2string interface (function cd2str).

Par_ml,ModelConstants_ml
- Add variable DOMAIN_DECOM_MODE (ModelConstants_ml) to be read on ModelConstants_config.
- On subroutine parinit (Par_ml), when DOMAIN_DECOM_MODE is set by the user
  it will override the default domain decomposition mode based on Pole_singular.

Timing_ml,Unimod,PhyChem_ml
ZD_3DVar/My_3DVar_ml,Analysis/DA_3DVar_ml
- Add parameter NTIMING_UNIMOD (39) and NTIMING variable (Timing_ml)
  to keep track of the "standard Unimod" time tracking indices (hard coded trough Unimod)
  and the total number of time tracking indices.
- Add optional input ntim to subroutine Init_timing (Timing_ml).
  If present, this variable can be used to increase (or decrease) the number of
  time taking indices (39 by default).
- On subroutine Add_2timing (Timing_ml) ensure that only time tracking indices
  are accessed (return if .not.(1<=n<=NTIMING)).
- Add parameter NTIMING_3DVAR=0 on for non 3DVar runs (My_3DVar_ml)
  and NTIMING_3DVAR=8 for 3DVar runs (DA_3DVar_ml)
- call Init_timing(NTIMING_UNIMOD+NTIMING_3DVAR) on Unimod, to allocate
  NTIMING_3DVAR time taking indices for 3DVar usage.
- call Add_2timing(T_3DVAR,..) on PhyChem_ml for total 3DVar usage on ANALYSIS runs.

Makefile
- Extend DEBUG=yes options from -check bounds (-CB) to
  -check all -check noarg_temp_created
- Change order between My_*.f90 file dependency and linking, so .depend target
  options are correctly displayed.
- Remove -j4 option from $(MAKE) call, as this option is already set on run.pl

Makefile.SRCS
- Define SRCS only if not already set (SRCS ?=), so .depend target
  options are correctly displayed.
- Add Pollen_const_ml.o dependency to My_Pollen_ml.o
  so pollen_const_ml.mod is up to date.

NetCDF_ml,
- Fix DEBUG=yes error on CreatenetCDFfile, xcoord loop lines 743--748.

ZCM_EmChem09/BiomassBurning_GFASv1_to_EmChem09.inc,
ZCM_EmChem09soa/BiomassBurning_GFASv1_to_EmChem09soa.inc
- Fix DEBUG=yes error, wrong NEMEPSPECS.

InterpolationRoutines_ml,NetCDF_ml,Nest_ml,CheckStop_ml,Par_ml,PhyChem_ml,Timing_ml
- Remove Copyright notice as it will be added by mk.OpenSource.
- Minor formatting changes.

ZD_3DVar/Analysis/DA_3DVar_ml
- Use parameters to designate the index and text of time traking indices,
  eg Add_2timing(T_3DVAR,..) instead of Add_2timing(47,..)
- Rename logical variable calculate_chisq to use_chisq
- Replace compilation flag NO_UPDATE_UNOBSERVED by logical variable use_unobserved.
- Read use_chisq, use_unobserved variables and m1qn3 paremeters maxiter,maxsim
  on DA_CONFIG namelist.
- Reduce m1qn3 progress output and write it to a separate log file for each processor.

ZD_3DVar/Analysis/DA_Obs_ml
- Add interpolation_method variable, to be read on OBSERVATIONS namelist.
- Use interpolation_method in call to get_interpol_const (subroutine H_op).
- Add input variable method to subroutine get_interpol_const:
  'distance-weighted' method calls point2grid_coeff (InterpolationRoutines_ml);
  'nearest-neighbor' methods also calls point2grid_coeff, but only uses the 1st value;
  'local' method calls a local implementation of point2grid_coeff for test/debuging.

ZD_3DVar/Makefile,Analysis/DA_3DVar_ml,DA_Bias_ml
- Temporary disable bias correction (DA_Bias_ml)

ZD_3DVar/Makefile,Makefile.SRCS,
ZD_3DVar/Analysis/ufftw3_ml,chitox_ml,
- Add linking options for FFTW3 library.
- Add FFTW3 util/wrapper module and FFTW3 based subroutines (chitox_ml).

ZD_3DVar/Analysis/DA_3DVar_ml,DA_Obs_ml
- Use FFTW3 variables and methods provided by chitox_ml.
- Remove unused output variable iostat from subroutine read_obs.
- Remove OLD_MATCH_CODE & old commented code.

ZD_3DVar/DA_ml.f90,Analysis/DA_3DVar_ml
- Add DA_NAMELIST parameter (DA_ml) for the name of the DA namelist file.

ZD_3DVar/B_NMC/spectralcov_ml.f90
- Set parameter DAPREC (used on m1qn3 settings) to single real precision.
  Previous setting was unrealistically low.

ZD_3DVar/B_NMC/cplx_fft_2d.F
- Fix bug on eliptic truincation reported by Arjo Segers.

ZD_3DVar/Makefile,Makefile.SRCS,
ZD_3DVar/B_NMC/quicksort.c,
ZD_3DVar/Analysis/chitox.F,chitox_adj.F
- Remove obsolete subroutines quicksort (C version) & chitox*.F (based on FFTpack5).
- Remove no longer needed compilation rule for C (%.o:%.c).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th September 2014  Alan  2868

ZD_ESX/D_Misc/GenChem.py:
  - Add some line wrapping to ChemRates output

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20th August  Alvaro 2867

mk.GenChem: Bug fix for eEMEP.
  Historical eruption data (V*.eruptions) on ZCM_Emergency/
  was appended to emergency_location.csv instead of emergency_emission.csv.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th August  Peter, Massimo 2866

NetCDF_ml: "mass conservative" interpolation from general projection improved
(when model resolution has fine resolution).
Not 100% robust: may not always work well when the interpolated data is not
approximately aligned with lon-lat.
Tested by Massimo for "Amersfoort" projection (1km resolution) to 1km resolution.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st August  Alvaro  2863-2865

Data assimilation with variational bias correction.

Makefile, ZD_3DVar/Makefile
- export variables to submake
- use nc-config to set appropriate LDFLAGS
- split .depend and depend targets
- use GenChem-MACCEVA-EmChem09soa for MACC-Bnmc MACC-3DVar targets,
  instead of bouilding MACC target.
- modulelist/modules targets to use/show LOADEDMODULES environment variable

ZD_3DVar/Makefile.SRCS, Analysis/DA_Bias_ml, DA_3DVar_ml, DA_Obs_ml
- New module DA_Bias_ml for variational bias correction.
  Enabled by -DBIAS_CORRECTION compilation flag.
- Add number of valid observations (nobs) to obsData array (obs_data type).
- Move set-up of obsData array from subroutine H_op to read_obs.

run.pl:
- Re-implement "month trimming". The day of the Start/End of the run
  are adjusted so they do not exceed the length of the corresponding month.
- Ensure all met files are present before starting the simulation.

TimeDate_ExtraUtil_ml:
- Prevent formatting errors on *2string functions by setting negative
  values to zero on ?key2str functions.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 and 23 July 2014 Peter, Jan Eiof, Dave 2862

FastJ_ml:
put USE_FASTJ=.true. in ModelConstants_ml and fastj is used for photolysis rates.
Need also to link a few data files from run.pl

Added FastJ_ml.f90
modified: ModelConstants_ml, Runchem_ml, DefPhotolysis_ml, Met_ml, Makefile.SRC

First work version. A lot should be revised and upgraded and tested!
In particular:
.-mapping of photolysis rates
.-components should be synchronised with GenChem (or similar). Hardcoded now
.-interpolating functions should be systematically reviewed
.-cloud ice and water
.-Idiffuse Idirect can be provided for surface
.-aerosol = 0 for now
.-reflectivities must be provided (basic default from fastj used now)
.-probably much more

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th June - 10th July 2014  Dave  2853..2859

  Tidy ups - removed commented out !CMR lines from some modules. These were
   from the older GenChem system with separate modules.

  ZD_ESX changes - added mk.testESXmods and Radiation_ml to demonstate.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th June 2014  Alan  2842-49

ESX changes only.

ZD_ESX/D_Misc/GenChem.py:
  - Generate WetDep, DryDep, AerExt and emis outputs.
  - Add reaction species checking.
  - Add reaction balance checking.
  - Handle RO2POOL.
  - Resolve some TODOs.

ZD_ESX/ZCM_{EmChem09,EmChem09soa}_py/*:
  - Fix a couple of malformed reactions (discovered by reaction species
    checking).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th June 2014  Alvaro,Birthe  2838-2841

Emergency_ml
  - Emission definitions (erupdef) are not allocatable, so is it possible
    to have more than 2000 releases (NMAX_ERUP) without compilation issues.
  - If a timestep starts at the end of the release (END code),
    it wont be taken as part of the release.
  - Ensure that the release time is at least 1 advection time step.
  - A "1-puff" emission [Kg] can me set with D="1DT".
    For a longer release, the total emission  [Tg] can be set with D="TOTAL".
    Default behaviour is emission rate [Kg/s].

Derived_ml,Units_ml
  - Rename subroutine uggroup_calc group_calc (Derived_ml)
    and extended to handle ppb, ppbC, ppbN & ppbS units for groups.
  - Add support for ppbC, ppbN & ppbS units (Units_ml)

Changes implemented over current MACC-ENS forecast version (2708--2716)
for MACC-EVA 2012 runs

config_FORECAST.nml,config_BM-EECCA.nml,config_Outputs_EMEPSTD.nml
  - Correct typo on MACC_EVA BCs
  - Correct typo on commented output

Makefile
  - Add MACC-EVA & MACC-NMC compilation targets

ZD_OZONE/My_Outputs_ml.f90
  - Hourly output definition for NMC runs

run.pl
  - $MAKEMODE, $CWFBC and $RESDIR for EVA & NMC runs

ZD_Pollen/Pollen_ml,Pollen_const_ml,My_Pollen_ml
  - Include Sub array from SubMet_ml, previously from LocalVariables_ml.
  - Correct typo on first_call variable name

ZD_3DVar/Makefile,Makefile.SRCS
  - Force DA_ml.o compilation
  - Update SRCS.Bnmc

ZD_3DVar/Analysis/DA_3DVar_ml,DA_Obs_ml
  - Optional chi^2 calculation, controlled by calculate_chisq variable
    read from DA_CONFIG namelist.
  - Write number of observations found in each ObsData file to RunLog

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th June 2014  Alan  2837

ESX changes only.

ZD_ESX/D_Misc/GenChem.py:
  Remove #SLOW handling of slow advected species (now an error).

ZD_ESX/ZCM_{ESX_r12,EmChem09,EmChem09soa}_py/*:
  Make copies of some chemical schemes and replace #SLOW with setting adv=3
  to test GenChem.py.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th June 2014  Alan  2827-2836

ESX changes only.

ZD_ESX/D_Misc/GenChem.py:
  Generate CM_ChemRates.f90, CM_Reactions1.inc and CM_Reactions2.inc from
  GenIn.reactions.  A bit of refactoring to remove code generation concerns
  from chemical scheme reading.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

5th June 2014, Dave, 2824

ESX changes only.

ZD_ESX/esx_Zmet - extra Kz output
ZD_ESX/esx_DO3SE - uses odir for output Log
ZD_ESX/esx_Variables - more checks on z_bnds and DiffSpecs, OutSpecs
ZD_ESX/esx_tester - some more comments, pcm3_to_pm3 replaces chem2Kz_units

**NEW** scripts directory added

  added fmkmf - now original script from Univ. Edinburgh, replaces makegf90
  mk.Makefile - does same job as older mk.makegf90, but using fmkmf
  mk.docESX moved here

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5 June 2014  Peter  2823

Bug in cloudwater! It was read as a 2D field.
Introduced at version 2693.
Does make the 3D precipitations derived from 2D precipitaions fail.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxx   USED for SR June 2014 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxx   tag  rv4_5  (=2822)   xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

4th June 2014 Semeena, 2820-2821

ZD_SR/My_Derived_ml.f90 - Updated according to the changes in namelist for SR runs

Derived_ml.f90  - Include daily and monthly outputs also for SR mode which makes
it easy for debugging. !SVS 22May2014

config_Outputs_EMEPSR.nml -  New namelist for selecting variables for SR output

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 May 2014  Alan  2813-2819

ESX changes only.

ZD_ESX/D_Misc/{GenChem.py,ordered_set.py}:
  Started work on reading GenIn.reactions, implemented most of the replacement
  for define_rates.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st May 2014  Dave   2812

ESX changes only - use of odir in esx plot outputs, minor stuff

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th May 2014  Robert/Dave/Peter (via Svetlana)   2808/9

My_SOA_ml.f90 - Backgroung level of OC (BGND_OC) is reduced from 0.5 to 0.2 ugC/m3

Derived_ml.f90 - Irritating check print *,"COLUMN TEST subclass " is out

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15th May 2014  Svetlana   2804/2805

Aero_Vd_ml.f90 - MMD for coarse sea salt is set to 4.8 um (from 4.0)
GlobBCs_ml.f90 - boundary conditions for sea salt are decreased to more
                 reasonable values (from comparison with observations)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th May 2014  Peter   2803

Meaningfull error message when two sites or sondes have the same name.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12th May 2014  Peter, Birthe   2802

Solver_ml.f90: error message when dt_advec < 200 seconds.
(we haven't implemented for small dt_advec, although it would be very easy to do)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd May 2014  Peter   2801

z_bnd in (Met_ml) is now updated every timestep (dt_advec), instead of
every METSTEP (3 hours).

Expected (small?) changes in results related to:
AOD_Ext
(setup_phot, only in rare cases)
COLUMN output
Emergency
ForestFire emissions
Pointsources
Rn222 emissions
Trajectory

CellMet_ml: hardcoded 20 in roa changed to KMAX_MID
     Grid%DeltaZ  = (dA(KMAX_MID)+dB(KMAX_MID)*ps(i,j,1) )/(GRAV*roa(i,j,KMAX_MID,1))


Moved call to metfieldint after vall to WrtChem() and  trajectory_in, since we do not want
to write or use metdata which has not yet been used.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd May 2014  Peter   2800

Define density (roa) from pressure and heights, so that they are consistent.
this changes roa by up to approximately 0.3% (done a simple test only).
The final results for concentrations will not change much (less than 0.1%)

Met_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30 April 2014  Peter   2799

Advection_ml: for eta coordinates, corrected bug (fluxin,fluxout) in mass balance diagnostic
(only massbalance diagnostic, not concentrations are changed).

run.pl: uodate 2012 forestfire and 2012 EECCA emission

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29 April 2014  Dave   2795-2798

   More DEBUG moved to config:
   (All not yet written into config_EMEPSTD files. Am considering
    leaving that for user. There are so many.)

     DEBUG%AQEUOUS
     DEBUG%DRYRUN
     DEBUG%DO3SE
     DEBUG%EQUIB
     DEBUG%pH
     DEBUG%RUNCHEM
     DEBUG%SETUP_1DCHEM

    Aqueous_n_WetDep_ml
    DO3SE_ml
    MARS_ml
    ModelConstants_ml
    My_Aerosols
    RunChem_ml
    Setup_1d_ml
    Solver_ml

    GenChem.pl - DEBUG_RUNCHEM now just DEBUG
    config_EMEPSTD.nml - some of above added


    ESX:

     AllocInit_ml now linked from Unimod

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 April 2014  Dave   2794

  ZD_ESX changes only. Changed calls to CheckStops to CheckStop_ml, to allow
  merging of more modules with EMEP. In future, I will likely remove _ml
  from all code, but not before the summer.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25 April 2014  Dave   2780

  COLUMN data requests  moved from My_Derived to config_Outputs, plus tidy-up
  of debug output. Changes in:

   My_Derived_ml
   Derived_ml
   ModelConstants_ml   now has DEBUG%MY_DERIVED
   OwnData

   config_Outputs_EMEPSTD.nml


   My_Derived is rapudly approaching zero in hard-coded requests, and can
   hopefully be completely repalced by config requests soon :-)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24 April 2014  Dave   2779

  DEBUG%SPEC is now the name of the species wanted. Used so far only in
  PhyChem, but recommended for more general use. The variable DEBUG%ISPEC
  gives the index in species(:)%name that corresponds to this.

  ModelConstants_ml - DEGUG%SPEC, DEBUG%ISPEC defined. Latter calculated
   in Config subroutine. Also some cleanup.

  PhyChem - DEBUG%SPEC used in debug_conc

  Unimod.f90 - moved called define_species before Config_ModelConstants


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 April 2014  Dave   2774-2778

RESULTS change!!!!! Mainly for BSOA, but also other

BUG fix - TERPperoxy added in EmChem09.species, to ensure treatment as SHL

ZCM_vbs_tests/VBS_SOAformation.species - TERPPeroxy removed

ZCM_vbs_tests/VBS_partitoining.reactions - now HO2 and NO reactions with
    TERPperoxy set oxidant neutral (in []). (Since we don't have the
    gas-phase chemistry to do this properly.)

ESX only. Small changes to FortranTips.txt

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 April 2014  Peter  2773

Bug in the netcdf sites output: attributes for Sites where undefined.

In addition the sondes/sites at 31st December midnight are now written in the
previous year, instead of the next year (this was also done in the csv output).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22 April 2014  Dave   2769-2770

** NEW ** AllocInit.f90 - to encourage setting of initial values when
   allocating. Almost identical to ESX.

   Added in Makefile.SRCs, but not used yet

** Debug changes. More use of config.

  Note: DEBUG_i, DEBUG_j now replaced by DEBUG%IJ array, set through config.

  BoundaryConditions - used DEBUG%IJ
  Chem_ml
  EmisGet  - had to change meaning of DEBUG (was => DEBUG_GETEMIS)
  Emissions - had to change meaning of DEBUG (was => DEBUG_EMISSIONS)
  ForestFire_ml, DEBUG%FORESTFIRE
  GridValues_ml, DEBUG%GRIDVALUES
  IoProgs_ml,    DEBUG%IOPROG
  ModelConstants_ml
  PhyChem_ml,     DEBUG%PHYCHEM, now uses DEBUG%SPEC
  Unimod,         DEBUG%MAINCODE instead of DEBUG_UNI

  config_EMEPSTD.nml - DEBUG changes

  Some code had "use DEBUG_i" which wasn't used at all:

  Derived_ml
  DryDep_ml
  Landuse_ml
  Met_ml
  SeaSalt_ml
  Setup_1d_ml

 Clean-up (incomplete!)
  ZD_VBS/My_SOA_ml


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21 April 2014  Peter  2768

Bug for rho_surf in Met_ml, introduced probably (by me) 11 December 2013 (2690).
ps in still hPa instead of Pa when calculating rho_surf.
rho_surf is normally overwritten (several times!) later in the code, so this
has no effect normally.
Only case where it has consequences, is when 'ustar_nwp' is read from metdata,
which is only used for WRF metdata.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 April 2014  Peter  2767

Makes NetCDF output of sites and sondes.

I tried first to define a new variable for each station/species pair, but this
 was very slow (double cpu time) and also the compression did not work well.
What I did not like when defining the stations as dimension, is that you have
 to first find which index correspond to which station; we have to live with that for now.

I was not able to use the string type in NetCDF (defining xtype = nf90_string
 gives the error message
 "Mapped access for atomic types only" when trying to write the strings with put_var)

We can add more attributes to the file, as required. This is hard coded now, and
I would recommend NOT to have the attributes too flexible, i.e. to have them as
 an input to the model. This should not be changed to much by the user, so that the attribute are a sort of standard which can be trusted by scripts.

I thought it would be relatively simple, but the code in Sites_ml got a bit messy.
Lots of small details which complicates (info available on different CPUs, surface
pressure to add, differences between species, station and global attributes etc).

I put only the meteo path (and size) as info about the grid. We do not have the name
of the grid (EECCA, TNO14..) directly availble in the model. We could add it some time.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 April 2014  Dave  2766

 **NEW** ChemSpecs_tmp.f90

  LOTS of routines now "use" ChemSpec from here.

  wrapper for the ChemSpecs_adv etc sub-modules, to allow
  other routines to "use ChemSpecs". Previous calls such
  as use ChemSpecs_adv removed in many routines, see !CMR comments
  (This is a step towards a simpler GenChem script.)

  Makefile.SRCS

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 April 2014  Alan  2765

ESX changes only.

ZD_ESX/D_Misc/GenChem.py:
  Process species index groups in a more generic way (remove special case for
  SOA).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 April 2014  Dave  2760-2764

  GridValues_ml     - clean up - remove commented out lines
  ModelConstants_ml - added experimental MINCONC stuff
  Setup_1d_ml       - clean up - remove commented out lines
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 April 2014  Dave  2760-2761

  SmallUtils_ml. Added to_Upper function for strings

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14 April 2014  Alan  2758-2759

ESX changes only.

ZD_ESX/D_Misc/GenChem.py:
  Some fixes in processing GenIn.species.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 April 2014  Dave   2757

    BUG fix, Mosaics_ml,  sorry.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 April 2014  Dave   2753-2756

  ESX changes
    Wesely_ml linked from EMEP
    LocalVariables_ml now uses Wesely_ml for Vg_ref etc
    Makefile changes for above
    mk.GenChem copies CM_DryDep.inc, CM_WetDep.inc
    config - swiched plotting flag F

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 April 2014  Dave   2752

  1) Sub array moved from LocalVariables to SubMet, to remove NLANDUSEMAX
  dependency. This module should only care about the local landuse, not
  how many there are. Change will help ESX also.

  Changes in:
    AOTnPOD_ml - now uses L not Sub. L set in Mosaics_ml
    CellMet_ml
    DryDep_ml
    Dust_ml
    GlobalBCs (Sub, Grid weren't needed anyway)
    LocalVariables_ml
    MosaicOutputs_ml
    SeaSalt_ml
    StoFlux_ml



   BUG found in experimental SPOD. No effect on normal outputs:
    AOTnPOD_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 April 2014  Dave   2750-2751

  DEBUG_AOT, DEBUG_DERIVED, DEBUG_COLUMN now moved to config DEBUG

  Changes in:
    ModelConstants_ml
    AOTmPOD_ml
    Derived_ml
    DryDep_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 April 2014  Dave   2749

  run.pl:  cdo infov run in all cases now, not just benchmarks

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 April 2014  Dave   2746-2748

   More namelisting:

     DDEP_ECO, DDEP_WANTED, WDEP_WANTED now specified in config_Outputs

   Changes in

     My_Derived_ml
     Derived_ml
     Aqueous_ml
     config_Outputs_EMEPSTD.nml
     config_BM-EECCA.nml

   Plus test of real(kind=dp) in Solver.f90

     Use of real(ken=dp) has no effect numerically, but is designed to move
     towards integration with other chemistry codes, e.g. KPP

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
09 April 2014  Alan  2742-2745

ESX changes only.

ZD_ESX/D_Misc/GenChem.py:
  Can now generate CM_ChemRates.f90 and CM_ChemGroups.f90 (mostly).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
09 April 2014  Dave  2741

  Io_Progs_ml - optional io argument to PrintLog
  SmallUtils_ml - num2str expanded to integer and real versions

  ZD_ESX/

    esx_tester.f90 - some re-organisation

   Use of PrintLog routine (temporary here) and esx%odir to specify output
    directory for logfiles and results

    **NEW** in ZD_ESX
    Io_Progs - has same PrintLog routine (temporary here)as EMEPs Io_Progs_ml
       (but EMEPs Io_Progs gas many more dependencies)

    esx_Variables      - added esx%odir, more use of UNDEF_R
    esx_Zchem          - uses esx%odir
    esx_Zgrid          - uses PrintLog
    esx_Zmet           - uses esx%odir
    esx_Zveg           - uses esx%odir
    Zmet_ml            - uses esx%odir and PrintLog
    config_esx.nml     - uses esx%odir
    Io_Routines.nml    - uses esx%odir


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
09 April 2014  Dave  2736-2740

  SmallUtils_ml - added num2str function to convert
  run.pl  - added more comments w.r.t. MAKEMODE
  Makefile.SRCS - added Precision_ml.f90

**NEW**

  Precision_ml - to enable use of real(kind=dp) declarations.
  More consistent with other codes. (We use values from KPP system.)

   (Not yet used, but quick tests in Solver_ml suggest real(kind=dp)
    produces identical output to standard runs.)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
08 April 2014  Alan  2733-2735

ESX changes only.

ZD_ESX/D_Misc/GenChem.py:
  More work on Python port of GenChem.pl.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8 April 2014  Dave  2730-2732
SmallUtils_ml - added trims to strip all blanks (even inside strings)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
29 March 2014  Alan  2724-2729

ESX changes only.

Added D_Misc/GenChem.py and mk.GenChemPy in ZD_ESX:
  Started implementing Python port of GenChem.pl, copied mk.GenChem to make a
  version that runs GenChem.py instead of GenChem.pl.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25 March 2014 Heiko 2723

NETCDF_DEFLATE_LEVEL (-1 to 9) instead of NETCDF_COMPRESS_OUTPUT (T/F)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24 March 2014  Dave 2720-2721

ESX changes only:  Updates to GenChem.rst

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20 March 2014  Dave 2718, 2719

ESX changes only.

Added GenChem.rst in ZD_ESX/D_Misc as a start on GenChem documentation, to
  help Alan in conversion of ESX's GenChem.py to python. This script is
  intended for the full EMEP system in the end, but will be tested in
  ESX first.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17 March 2014  Alvaro  2715,2716

Nest_ml,config_FORECAST.nml
  - Additional variables on Nest_config namelist to explicitly define
    which advected variables should be written to filename_write.
  - By default all advected variables will be written.
  - If WRITE_GRP or WRITE_SPC are found on the namelist,
    only the variables specified on WRITE_SPC and WRITE_GRP (group members)
    are written.
  - Remove NMC_OUTPUT variable. Functionality achieved by WRITE_SPC/WRITE_GRP.

config_EMEPSTD.nml,config_BM-EECCA.nml,config_FORECAST.nml,config_EMERGENCY.nml
  - Update comments regarding variables EXP_NAME and MY_OUTPUTS.
  - Homogenize comments and variable setting among NML files.

PhyChem_ml,Timing_ml
  Fix error on 3DVar timing.
  - '3DVar: Total' and  "'3DVar: CHI^2 evaluation.' time strings were assigned
    to timing index 46.

ZD_3DVar/Makefile
  - gFortran option for all .mod files to be kept in main path.

ZD_3DVar/Analysis/DA_3DVar_ml,DA_Obs_ml
  Fix errors o implementation of the chi^2 evaluation (2599).
  - The return after chisq_over_nobs2 call was never reach
    due to wrong if/else logic.
  - Wrong index on chisq_over_nobs2 calculation

ZD_3DVar/B_NMC/Unimod_B_nmc
  - deallocate(ucovmat) only if allocated

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12 March 2014  Alvaro  2714

GenChem.pl:
  - Create NMVOC group following the "recipe" found on Derived_ml, i.e.
    all advected species(:)%carbons > 0, exept CO and CH4.

ZD_OZONE/My_Outputs_ml
  - Update hourly output on FORECAST mode: additional variables and levels.

Makefile:
  - Remove Isotopes from MACC compilation targets.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th February 2014  Peter  2713

Do not recalculate etadot and sdot if etadot is read from metdata.
Met_ml.f90
run.pl CWF=0;

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th February 2014  Alvaro,Birthe  2709-2710

ZD_Pollen/Pollen_ml,Pollen_const_ml,My_Pollen_ml
  - Increased the available birch pollen amount to 1e9 grains/m2.
  - Set a heatsum condition for season end.
  - New birch pollen limiting formula, for latitudes north of 60 degrees.
  - Remove Copyright notice from My_Pollen_ml.

config_FORECAST.nml,ExternalBICs_ml:
  - Additional species for IFS-MOZ (fnyp) BCs.
  - Explicitly set the BC version name (EXTERNAL_BIC_VERSION) on
    ExternalBICs_config namelist.

run.pl:
  - Join stallo PBS commands for CPU (-lnodes) and memory (-lpmem)
    in a single line to facilitate switching between vilje/stallo.
  - Clean up BENCHMARK setings: archive option is set only once
    and remove behckmarks marked as "Candidate for removal".
  - Improve support for different met versions on FORECAST (FC) runs.
    The usage of $CWFMETV was extended so
    now 00|24|48|72 means 00UTC met starting from 00d|01d|02d|03d
    and 12|36|60|84 means 12UTC met starting from 01d|02d|03d|04d.
  - Improve IC/restart/dump file search ANALYSIS (AN) runs.
    An AN run will only start if a IC file is found.
    When the IC file from the AN chain is not found,
    attempts are made to link a suitable IC file from one the FC chains.
  - Link PointSources.txt file only when found.

PointSource_ml:
  - Small change so BENCHMARK archive conditions can be met.

ZD_SR/My_Derived_ml,ZD_OZONE/My_Derived_ml:
  -Implement OutputConcs_config namelist on SR version.
  - Remove Copyright notice from OZONE version.

Nest_ml:
  - Add warnings messages when IC/BC varables are not found on
    their corresponding files.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th February 2014  Alvaro,Birthe  2707-2708

GridValues_ml:
  Fix error on procedure coord_check. Wrong/Unnecessary latitude coordinate range fix.
  The error propagates to functions coord_in_gridbox and coord_in_processor, giving
  wrong latitudes for emergency scenarios (Emergency_ml) with sources on the southern hemisphere.
  This error has been present since coord_check was introduced (rv4.1.6; 20th Nov 2012).

run.pl:
  add comment about $MAKEMODE=0 to avoid model re-compilation

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th February 2014  Peter  2706

Small changes:
BoundaryConditions_ml: use Logan_P.nc whenever KMAX_MID /=20. Path in run.pl
EmisGet: MPI_Barrier for nicer output
Timings: format for larger grid
GridValues: format of output
Met_ml.f90: Interpolate etadot from mid to boundary when read from metdata
NetCDF: force monotone lon in the lon lat projection
(last lon was set to -179.75 instead of +180.25 in the GLOBAL05 grid!).


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
10th February 2014  Peter  2705

Bug in Nest for eta coordinates.
The program crashed when it did not find "k" as vertical coordinate.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th February 2014  Peter  2703

EmisGet_ml.f90
Can define emission release distribution in explicit Pressure levels instead
of model levels.

To use Pressure levels, simply add one line to EmisHeights.txt, using keyword "Plevels", see example:
stallo: /global/work/mifapw/emep/Data/inputs_emepdefaults_Jun2012/EmisHeights_P.txt

# Emissions distribution for EMEP2012 version rv4
# Has 100% SNAP2 emissions in lowest layer
# Plevels are pressure in Pa at top of corresponding levels (P Surface = 101325.0=
Nklevels 7   Vertical Levels
Plevels 100229.1 99133.2 97489.35 95206.225 92283.825 88722.15 84521.2
1         0.0      0.00     0.15     0.40     0.30     0.15     0.00    ! SNAP1
2         1.0      0.00     0.00     0.00     0.00     0.00     0.0     ! SNAP2
3         0.1      0.10     0.15     0.30     0.30     0.05     0.0     ! SNAP3
4         0.9      0.10     0.00     0.00     0.00     0.00     0.0     ! SNAP4
5         0.9      0.10     0.00     0.00     0.00     0.00     0.0     ! SNAP5
6         1.0      0.00     0.00     0.00     0.00     0.00     0.0     ! SNAP6
7         1.0      0.00     0.00     0.00     0.00     0.00     0.0     ! SNAP7
8         1.0      0.00     0.00     0.00     0.00     0.00     0.0     ! SNAP8
9         0.1      0.15     0.40     0.35     0.00     0.00     0.0     ! SNAP9
10        1.0      0.00     0.00     0.00     0.00     0.00     0.0     ! SNAP10
11        1.0      0.00     0.00     0.00     0.00     0.00     0.0     ! SNAP11


Emissions_ml: removed a double output of country emission in RunLog

Met_ml: retablished the definition of debug_iloc, debug_jloc, which was deleted
inadvertently in a previous version and made the DEBUG version fail.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4th February 2014  Peter  2701

Landuse_ml.f90 allow sumfrac up to 1.2 around poles.
run.pl: removed "ppn=16", as Stallo has now many nodes with 20 cpus too.
        removed mem=16gb for Vilje, as nodes on vilje have about 28 gb memeory
        do not stop the run.pl when natso2 not found (as it can be neglected,
                                                  and many grid don't have it)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20th January 2014  Peter  2700

Number of level for use of "NewLogan" was set wrongly.
(does only affect runs if you explicitely set NewLogan=.true.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16th January 2014  Svetlana, Peter  2699

Flexible dust. Dust can now be used for any grid. It is interpolated from a
global file.
To use the old grid specific data set USE_TEGEN=.false. in ModelConstants_ml
Met_ml.f90
ModelConstants_ml.f90
run.pl

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21th December 2013  Peter  2696

Small cleaning:
added  "PBS_O_HOST" in run.pl, so that it finds Stallo
USES%EMISSTACKS = F in config_EMEP_STD.nml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th December 2013  Peter  2693-5

 Complete reorganization of MeteoRead. The fields are systematically read from
the met(ix) "list".
Metvar is now integrated into MeteoRead (since everything was put there anyway).
Lot of clean up.
The weird definition of precipitation is corrected (as planend in 2010...);
Now pr is simply the precipitation (forced positive) in mm/s.

All results should be identical

NewLogan in BoundaryConditions_ml: path to Logan_P.nc, which takes into account
surface pressure (tests show better correlation than when constant surface pressure is assumed).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th December 2013  Alan Briolat  2691-2692

ZD_ESX/{AllocInit.f90,Zmet_ml.f90,ZchemData.f90}:
    Reworked the AllocInit subroutine to allow array initialisers and
    automatic reallocation when new shapes are required.  Updated ESX Zmet
    and ZchemData to rely on the new AllocInit.

ZD_ESX/My_ESX_ml.f90, ZD_EXTRA/My_ESX_ml.f90, DryDep_ml.f90, Makefile.SRCS:
    Added basic ESX initialisation, called from DryDep.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th December 2013  Peter  2690

Big reorgarnization of loops: the loop within PhyChem is merged with the loop in Unimod.
Now there is only one main time loop in Unimod, whith timestep=dt_advec.
numt does not exist anymore.
The routine must themself check that the time is correct for what they intend to do.
Some cleanup too.

The results should be identical as before. If not there is a bug.

Modified:
Biogenics_ml.f90 Landuse_ml.f90 Trajectory_ml.f90 Runchem_ml.f90 OutputChem_ml.f90
Advection_ml.f90 PhyChem_ml.f90 MetFields_ml.f90 PointSource_ml.f90 Sites_ml.f90
Met_ml.f90 Unimod.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th December 2013  Peter  2688-9

Start of a reorganisation of the meteorological fields.
Introduced the "metfield" type.
This is meant to do be used for all the transformations that are done sytematically,
like the time integration.
The "normal" fields (ps, SigmaKz etc...) are still there and connected with pointers
(pointer means that basically there are 2 names for the same data: change the values
in one of the arrays, and the data is changed in the other too)

For now only time integration is done in this way (metfieldint). Metint will be removed.

The fields are hardcoded in MetFields. Please I want it like that, at least for the near future!

Bug in Met_ml introduced in 2672. KMAX not inititalized. Would probably cause
crashe if not initialized to any reasonable value.

Changes: Met_ml, MetFields_ml, PhyChem_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
9th December 2013  Peter, Birthe, Anna  2687

GridValues_ml: Check that the highest level in meteo grid is at least as high as the one in  VerticalLevels.txt.
Output_hourly: Put height Z of the "surface level" in hourly output at 3 meters.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6th December 2013  Matthias, Dave  2685


Point-source code added: implementation of NILU and other plume-rise methods,
 with Peter's spread-plume routine to assign emissions to layers

 No change in results unless USES%EMISSTACKS=T

  ** New **  PointSource_ml
  ** New **  PlumeRise_ml

The code will read coordinates and emissions from a file PointSources.txt.
Plume rise and hence effective emissions height  is calculated from the
stack parameters and meteorology, and the spread into the z-layers using
an assumed standard deviation of the emissions (=25% of the plume-rise
delta). Can work with any z-layers (no hard coding :-)

Changes in:

   Makefile.SRCS
   Emissions_ml      - USES%EMISSTACKS and USES%PlumeMethod
   ModelConstants_ml - USES%EMISSTACKS and USES%PlumeMethod
   RunChem_ml - if (USES%EMISSTACKS) call point_sources...
   Emissions_ml - if (USES%EMISSTACKS) call point_sources...
   run.pl  - links PointSources.txt file (from MyData so far)

Also:
   OwnDerived_ml - added UNDEFS, initialisation of Asc2D, and print_Asc2D

Caveats

   Currently the meteorology assumes lowest layer has 90m depth. Should in
   future also make wind-speed and dt/dz depend on z values.

   Currently emissions make use of EmisNat arrays, since this was easier
   for non SNAP emissions. Will modify.

   Need to harmonise with volcanic and emergency emissions.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5th December 2013  Dave,Peter  2684

2684 - Dave updated Log.changes with this info
2683 - Sketch added to ESX Zgrid_mk
2682 - Peter - MaceHead
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd December 2013  Peter  2681

Corrected MaceHead corrrection for NewLogan (can still bbe improved)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 November 2013  Peter, Birthe  2677-79

NetCDF_ml.f90:
vertical interpolation routine.
NB: this routine does assume Pref at surface everywhere!
BoundaryConditions_ml:
Hardcoded option (NewLogan), to run with a  new Logan BC for O3
The new file is in the original pressure grid:
/global/work/mifapw/emep/Data/Logan_clim/Logan.nc
This is a temporary setup. Hopefully the entire BIC routine will be reviewd.

GridValues_ml.f90:
A_bnd_met allocated also in case the old system for vertical levels is used

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 November 2013  Alan Briolat  2675-2676

ZD_ESX/esx_DO3SE.f90, ZD_ESX/esx_gleaf.f90, ZD_ESX/esx_tester.f90:
- Move ESX-DO3SE integraton to its own module

DryDep_ml.f90, Makefile, Makefile.SRCS, ModelConstants_ml.f90,
ZD_ESX/My_ESX_ml.f90, ZD_EXTRA/My_ESX_ml.f90:
- Integrate ESX into the build system in a similar way to MACC pollen, and
  other optional components.  Can build ESX variant with "make EmChem09-ESX".

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21/25 November 2013  Alvaro 2673/2674

Update Copyright text and Forecast/Analysis running modes.

mk.OpenSource, Copyright.txt
- Remove the need of Copyright text on *.f90 files.
  The Copyright text is kept on Copyright.txt and will be inserted to *.f90
  files by mk.OpenSource.
- For files already containg Copyright text,
  the year is updated by mk.OpenSource

Unimod.f90,Nest_ml,Nest_ml,OutputChem_ml
- Remove Copyright text from files

run.pl:
- Fix incomplete emissions path for GEMS25, MACC02 & MACC14 domains.
  Bug introduced on 2667.
- Change file name convetion for 00 and 12 UTC versions of forecast metyeorology.
  Assume that 00/12 UTC versions are kept on different direcotries.
  00/12 UTC versions are no longer distingused by 00/12 tag on file name.
- Hash variable %inml collects input files to be defined in config_emep.nml.
  This should slowly replace %ifile/linking.
  See $inml{'filename_eta'} for an usage example.
- Vertical description of External BCs used on Forecast runs defined
  by $inml{'filename_eta'} in run.pl, instead of linking the file.
- Additional model setup information written to config_emep.nml.

Unimod.f90,Nest_ml,run.pl:
- Move Forecast restart/dump dates (outdate in Nest_ml; $CWFDUMP in run.pl)
  from INPUT_PARA namelist (read by Unimod.f90)
  to Nest_config namelist (read by Nest_ml)

Nest_ml:
- Set number of forecast restart/dump records (FORECAST_NDUMP) on running time.
- New logical vaiable NMC_OUTPUT to reduce the output on restart/dump records.
  Only members of DAobs, DAunobs, PM10 and AOD groups are written out.
- FORECAST_NDUMP and NMC_OUTPUT read from Nest_config namelist.

config_FORECAST.nml:
- Port updates to config_EMEPSTD.nml
- Add NMC_OUTPUT and FORECAST_NDUMP to Nest_config.
- Set outdate (Nest_config) and filename_eta (ExternalBICs_config)
  by run.pl using hash/keys.
- Remove some unused/commented options.

ExternalBICs_ml:
- Extend char/len of filename_eta
- Fix minor error for DEBUG output.

OutputChem_ml:
- Redefine Jan_1st in Wrtchem as the first day of run.
  This variable is used to avoid writing partial results on the first
  run day that only contains 00-06 UTC data.

TimeDate_ExtraUtil_ml:
- Add FFFF format tag for forecast step (fstep)

Makefile,ZD_3DVar/DA_ml,Analysis/DA_Obs_ml,B_NMC/spectralcov_ml
  minor updates

ZD_3DVar/Makefile:
- MKL path for intelcomp/13.0.1 module
- Compile/link options for all *.mod files in the same directory.
- Pass $(DEBUG) to sub-make calls

ZD_3DVar/B_NMC/Util_ml
- Add (optional) debug check to GetNCRec for fetching exact time records.

ZD_3DVar/B_NMC/covmat_ml,Unimod_B_nmc
- Rename resolution variables from dx/dy variables dxdim/dydim.
- Change default domain resolution from dx=dy=0.25 to TNO14 (dxdim=0.25;dydim=0.125).
- Check nchemNoObs>0 before allocate/read ucovmat and related variables.

ZD_3DVar/Analysis/DA_3DVar_ml
- Limit analysis increments (dx/du) to 500% (ANALYSIS_RELINC_MAX=5.0).
- Check nchemNoObs>0 before unsing ucovmat and related variables.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14 November 2013  Peter 2672

Flexible vertical coordinates.
If a file Vertical_levels.txt is found at run time, the defintion of the
vertical levels are read (in hybrid coordinates) and used for the run.
Link in run.pl to one of the files given in the ProgDir, or make your own

The meteorology must be defined in hybrid coordinates too
only defined so far with 37 levels:
EECCA/metdata_EC/2009_k
GLOBAL/metdata_EC/2009_k

Modified:
Met_ml.f90, GridValues_ml.f90, run.pl (and ModelConstants_ml.f90, Unimod.f90)
Added:
Vertical_levels20.txt Vertical_levels30.txt Vertical_levels34.txt Vertical_levels.txt

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
12 November 2013  Alvaro 2670

Pollen modules for "out of the box" compilation.

Makefile,Makefile.SRCS,ZD_Pollen/My_Pollen_ml,Pollen_ml,Pollen_const_ml
- Rename FUTURE_Pollen module files and place them on ZD_Pollen directory.
- Use "real" pollen modules (Pollen_ml,Pollen_const_ml) form MACC compilation
  target (`make MACC`). For all other compilation targets (e.g. `make EMEP`)
  use "empty" pollen module (My_Pollen_ml).

Runchem_ml,PhyChem_ml
- Call Pollen_ml functions

Output_hourly
- Reflow hr_out%type cases for surface/3d hourly output types.
- Hourly output types for Pollen_ml variables.
- CheckStop after CloseNetCDF, so the offending variable is written out
  and can be examined for debugging.

ZD_OZONE/My_Outputs_ml.f90
- Hourly AOD output on TRENDS output mode.
- Hourly pollen output on FORECAST output mode, when USE_POLLEN/DEBUG_POLLEN.
- Hourly RN222 on FORECAST output mode, when variable is found.
- Do not CheckStop on FORECAST mode when hourly output fails consistency check.
  Instead, reduce number of hourly output variables and continue.

run.pl:
  Fix given/when cases for $year ranges. Bug introduced on 2667.

utils/compinfos.py
  Add scipt for  comparison benchmark *.infov files

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 November 2013  Dave 2669

ESX changes:
    plotZarray - noshow option added
    ZCM_ESX_R12: GenIn.species, GenIn.reactions modified to make sure TRACER!
    and TRACER2 have applied rcemis terms. Need change to GenChem for better
    safety.

    esx_gleaf, DefPhotolysis - small changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11 November 2013  Alvaro 2667

run.pl:
- Simplify script/options for
  - $MetDir in stallo.
  - $emisdir/$pm_emisdir using given/when cases for $GRID/$year.
  - $HDD skip cases.
- Restore '1-step-run if($dd2=0)' functionality lost on 2646.
- Cleaner config_emep.nml
  - Do not copy comments config_*.nml templates
  - Add a list of linked files in namelist style as a comment.
    This would help to introduce more input files into config_*.nml,
    and to reproduce model runs with future versions of the model.
- Reflow/rewrite partial of the SR code
  - $country_nums definition.
  - Reduction assignments using given/when cases for $pollut.
  - Add split countries/sea areas to $femisdat using given/when cases for $cc.

config_BM-EECCA.nml
  Commented line for a 1 week "Debug-Benchmark" run between Jan 1st and 8th.

config_EMEPSTD.nml
  Minor formatting changes

AOD_PM_ml
  Small bug fix on Qm_grp function (introduced on 2665)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8 November 2013  Dave   2666

More ESX:

   Added Zmet%Ra, using fine-scale calculation of Kz

   CM_, GenChem stuff
   Re-introduced Riemer, etc., for more realistic chemistry
   Added TRACER2 (and TRACER became TRACER1) for Jalle. Provides
   reacting species.


   Kz_ml
     - stability effects continued
     - added Zmet%Ra term, from fine-scale integration of Kz

   esx_Variables
     - added Zmet%Ra term

   + small tidy-ups in ESX codes.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8 November 2013  Alvaro 2665

Refactor AOD_PM_ml and clean up CM_ChemGroups_ml.

AOD_PM_ml,GenChem.pl,mk.GenChem:
- Modify GenChem.pl and *.species files to assign extinction prototype/classes
  and Wet/Dry mode to each model variable.
- AOD_GROUP is not longer explicitly defined on the *.species files,
  instead it is the collection of all model variables with a defined
  extinction class.
- The extinction classes and Wet/Dry mode are summarised on mapping file
  (CM_AerExt.inc) produced by GenChem.pl/mk.GenChem.
- Extinction prototype/classes and Wet/Dry mode are defined on AOD_PM_ml.

ZCM_EmChem09/SeaSalt.species,PMmass.species,EmChem09base.species,Dust.species,
ZCM_EmChem09soa/VBS_nonvolatile.species,
ZCM_CB04/CB04base.species,ZCM_CB05/CB05base.species,
ZCM_CRI_v2_0/CRI_v2_0base.species,CRI_v2_R5base.species,
ZCM_Emergency/NUC.species,ASH_2bin.species,ASH_7bin.species,
ZCM_vbs_tests/VBS_help.species,VBS_help_Detailed.species,VBS_nonvolatile.species:
- Define extinction class (e.g. DDf) instead of the value of the
  dry mass extinction efficiency at 550 nm (e.g. 1.0 [m2/g]).
- The Wet/Dry calculation mode can be explicitly defined (e.g. DDf:Dry),
  otherwise the Wet mode is assumed.

AOD_PM_ml:
- Partial support to older model versions can be achieved by editing CM_AerExt.inc.
  If the case, the new subroutine AOD_check ensures the consistency between
  AOD_GROUP and CM_AerExt.inc.
- The functionality previously provided by function wetExtC (introduced on 2638)
  is now achieved by 2 separate functions: Qm & Qm_grp
- Private function Qm returns dry/wet mass extinction efficiencies for species
  in CM_AerExt.inc. Dry/Wet efficiencies are returned depending on the value of
  mode input parameter.
- Public function Qm_grp returns the wet extinction efficiencies
  for given a rel.hum. Dry extinction efficiencies are returned if no rel.hum.
  is provided.
- Subroutine AOD_Ext calculates AOD and Extinction coefficient.
  By default calculations are based on wet mass extinction efficiencies.
  The default behaviour is controlled by global variable EXT_MODE.
- Subroutine AOD_calc was removed as is functionality can be reproduced by
  AOD_Ext with EXT_MODE="DRY".

Units_ml:
  Remove support for ext550nm units (extinction at 550 nm).
  Conversion to ext550nm unit was based on dry mass extinction efficiencies.
  By default, AOD calculations are based wet mass extinction efficiencies,
  which change with rel.hum.
  This inconsistency makes the former ext550nm unit conversion misleading.

GenChem.pl(CM_ChemGroups_ml),Aqueous_n_WetDep_ml,Derived_ml,ZD_OZONE/My_Derived_ml:
  Remove INDEX_*_GROUP, GROUP_ARRAY, and unused/obsolete groups (e.g. DDEP_OXNGROUP).
  Use find_index('NAME',chemgroups%name) instead of GROUP_ARRAY.

ZD_ESX/ZCM_ESX_r12/GenIn.species,ZD_ESX/ZCM_EmChem09/GenIn.species,
ZD_ESX/CM_ChemSpecs,CM_ChemRates,D_Misc/GenChem.pl:
  AOD relevant changes ported to ESX model.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8 November 2013  Dave   2661-2664

ESX-related changes (also main code, but no effect)

Main directory:

  SubMet_ml.f90   - Ln95 disabled
  MicroMet_ml.f90 - Ln95 disabled, and linked into ZD_ESX directory
                  - added phi_h, phi_w

ZD_ESX:

  DefPhotolysis_ml - BUG fix on Phux routine

  MicroMet_ml.f90 - linked into ZD_ESX directory

  Kz_ml - stability corrections added to Leuning code

  esx_Zmet - added safety clause, that hSL > 2 Veg%h
             added z/h to print_Kz
             Veg%hVeg renamed to Veg%h

  esx_Zveg - Veg%hVeg renamed to Veg%h
  config_esx - Veg%hVeg renamed to Veg%h


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7 November 2013  Peter  2660

Nest_ml: recognize "Months" as a valid time (testet only for MODE=100)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6 November 2013  Peter  2658

Nest_ml: recognize hPa for the definition of hyam/hyai

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
6 November 2013  Dave  2652-2657

ESX changes only
----------------

Major changes

  1) Photolysis system changed to get rid of hard-coded ID indices, and to
  use "Phux" algorthims, an

  GenChem.pl
  ZCM_EmChem09/GenIn.reactions
  ZCM_ESX_r12/GenIn.reactions
  DefPhotolysis

  2) rcemis implemented better in esx_tester and config_esx.nml
  config and testing done for Plume1 case of Kuhn et al. AE, 1998
  EmChem09 set as standard chemical package for now

  STILL need to reconcile Fb and rcemis type entries. Will likely
  move Vd, Fb, etc. to BIC.

Minor changes:

  ChemSolver - printouts tidied
  Zmet_ml - printout removed
  LocalVariables -ZenDeg and CosZ terms added (zenith angle)
  esx_Zmet_m.f90 - printouts tidied
  esx_ZdiffSolver.f90 - printouts tidied
  D_Plotting/plotZarray - colour/linestyle change

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4 November 2013  Dave  2651

ZD_ESX changes:

 Bug-fixes in ESX chemistry codes:

  DefPhotloysis  - fixed indices, e.g. NO3. (Need to return to this.)
  ChemSolver.f90 - stop loop over k. Safer max(x, ZERO)
  esx_tester.f90 - add ChemSolver loop k explicitly. More ouput.

Extensions

  esx_GetData - changed to use esx%DataSoure text flag
  config_esx.nml - esx%DataSource = "-" or "Extern" added


Minor (mainly debug changes)

  Zmet_ml - extra output (TMP)
  Zmet_ml - extra output (TMP)
  D_Plotting/plotZarray - improved linestyle and colors usage
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4 November 2013  Dave  2649-2650

ZD_ESX/Amminium_ml - recoded version for ESX. Will harmonise with EMEP later.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 October 2013  Alan Briolat  2648

KeyValueTypes.f90,SmallUtils_ml.f90,TimeDate_ml.f90:
  Merge changes made to ESX versions of utility modules into their EMEP
  equivalents.

ZD_ESX:
  Replace EMEP modules duplicated in ESX with symlinks to EMEP files.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28 October 2013  Peter, Semeena  2647

Nest_ml: allow vertical levels for nesting to be defined with hyai/hybi
(values at levels interface), instead of hyam/hybm

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17-18 October 2013  Alvaro  2645-2646

config_EMEPSTD.nml,config_Outputs_EMEPSTD.nml:
  Formatting and clean-up and small changes to make them more gfortran friendly

config_BM-EECCA.nml:
  Single config_emep.nml file for EECCA 100x100 runs.
  Will work for any EECCA benchmark year.
  Benchmarks on other domains will need an specific config file,
  which can be created using this file as an example.

run.pl,ZD_OZONE/My_Derived_ml.f90:
  Single namelist file for runs (config_emep.nml).
  Benchmark runs use domain specific templates.
  For normal runs, config_emep.nml is created by combining INPUT_PARA (namelist)
  with config_$exp_name.nml and config_Outputs_$outputs.nml files.

run.pl,Unimod,Met_ml,GridValues_ml:
  * Replace INPUT.PARA file with a namelist (INPUT_PARA) on single file
    (config_emep.nml).
  * New string variable 'meteo' (Met_ml) is read in INPUT_PARA namelist.
    It contains a filename template for the met files.
  * MeteoRead, Check_Meteo_Date (Met_ml) and GridRead (GridValues_ml)
    use this variable and a date to generate the correct met filename.
  * For non forecast runs, it is not longer needed to link the met files.
    run.pl only checks existence of first and last meteo file before creating
    config_emep.nml.
  * Forecast runs still need linking of met files, as the file names follow
    a different rule. Nonetheless, the linking of met files has been
    cleaned up and simplified.
  * Parts of Met_ml and GridValues_ml have been clean up and re-formatted.

GridValues_ml:
  Small change to coord_in_gridbox and coord_in_processor,
  in order to ensure correct result for coordinates outside of the model domain.
  Error seems to appear only on 3DVar applications.

Met_ml:
  * Add optional logical variables ('needed' and 'found') to Getmeteofield.
    If present, found="variable was found"".
    If present, CheckStop(needed,...) when the variable is not found.
  * Re-write some of the variable-found logic on MeteoRead,
    in order to make the code easier to follow.

run.pl:
  * remove erroneous '$iyr_trend .. if $SR' line
  * add $MAKEMODE to 'my ($testv,...' definition line
  * Enforce $BENCHMARK{MAKEMODE} if defined
  * move special cases of $Chem, $exp_name and $testv
    for BENCHMARK and CWF runs to their respective code blocks at the
    begging of the script
  * simplify felt file handling, and remove obsolete code

GlobalBCs_ml: gfortran compliance

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
14th October 2013  Dave     2643-2644

ESX-only changes:

 New: mk.export - packages ESX into one dierctory for external users
                  (set at Dave's dropbox for now!)

 Fb units system implemented, changes in:

   config_esx.nml
   esx_tester
   esx_Variables
   esx_ZdiffSolver

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th October 2013  Alvaro   2642

Clean up & small changes

Makefile
  Reorganize GenChem targets and remove obsolete MACHINE configurations.

Emergency_ml
  Increase max number of events def per location (NMAX_ERUP) to 360.
  This should allow a 3 months eruptuon descroption with 6h records.

Units_ml
  Add support for "mass_ratio" units.
  Units_Scale process "kg/kg","kg kg-1","massratio","mmr" as "mass_ratio",
  and "vmr" as "mix_ratio".

Nest_ml
  Add unit support for IFZ-MOZART BC files from FZ Jlich.
  Variables ending in "vmr" (volume mix.rat.) and "mmr" (volume mix.rat.)
  have units attribute "1".

GlobalBCs_ml
  Collect macehead_O3 corrections for each year into one parameter array.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th October 2013  Alan Briolat + Dave   2639-2640

ZD_ESX added - for ESX development work.  This should not be used in standard
EMEP work, but we are working towards an experimental version. Code will be
shared between EMEP and ESX as far as possible.

(From ESX own's subversion 202)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
11th October 2013  Alvaro   2638

AOD calculations free of iadv_*/spec_* indexes:
  The previous version of AOD_PM_ml, developed specifically for EmChem09soa,
  made extensive usage of iadv_*/spec_* indexes to avoid hard-codded indexes.
  The new version gives almost identical results (diff<2.06e-5).
  I tried to cover all chem. mec., but can not be sure
  as the current implementation relies on AOD_GROUP and the variable names.

AOD_PM_ml:
  Rewrite routine avoiding iadv_*/spec_* indexes.
  Instead use the AOD_GROUP and variable names on a case statement.
  Work is still needed in order to remove explicit references to the variable
  names/indexes.

ZCM_EmChem09/EmChem09base.species,ZCM_EmChem09/PMmass.species,
ZCM_EmChem09soa/VBS_nonvolatile.species,
ZCM_vbs_tests/VBS_help.species,ZCM_vbs_tests/VBS_help_Detailed.species
ZCM_CRI_v2_0/CRI_v2_0base.species,ZCM_CRI_v2_R5/CRI_v2_R5base.species
ZCM_CB04/CB04base.species,ZCM_CB05/CB05base.species:
  The new wet extinction coefficient calculation (wetExtC function in AOD_PM_ml)
  relies on the AOD_GROUP. Therefore one must ensure that all variables
  involved belong to this GROUP.

Derived_ml:
  remove unused iadv_*/spec_* indexes

AODrh_PM_ml:
  Old version of AOD_PM_ml. Delete redundant module.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26th September 2013  Peter   2637

Temporary solution: the correction 2635 was not correct.

In met_derived t2_nwp(i,j,1) -> t2_nwp(i,j,nt)

In metvar, call met_derived twice, so that the fields computed in met_derived
are pointing to "now" after metvar:
    call met_derived(nr) !compute derived meteo fields used in BLPhysics
    call BLPhysics(numt)
    call met_derived(1) !compute derived meteo fields for nr=1 "now"

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25th September 2013  Peter   2635

Bug. in metvar (Met_ml.f90), was:
   call met_derived(nr) !compute derived meteo fields
corrected to:
   call met_derived(1) !compute derived meteo fields

Because met_derived computes fields for "now" (nr=1).
This caused jumps (but within normal values) in some fields
(u_mid, v_mid, u_ref, rho_surf, ustar_nwp, invL_nwp and values derived from these)

This will change results!


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19th September 2013  Peter   2634

NetCDF_ml.f90: ReadField_CDF.
New case: General projection of data, and zeroth order mass conservative inerpolation (2D only).
(used for Nederland/Amersfoort projection emissions in 1 km)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st August 2013  Peter   2633

The correction from version 2632 was not put in correctly. New trial here.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st August 2013  Peter   2632

There was a bug in the defintion of i and j for rotated lon lat projections, introduced
27th May 2013  revision 2592.
The values where shifted by one gridcell. The results (concentration etc.) were not affected.
NetCDF_ml.f90


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
7th August 2013  Dave   2630-2631

KeyValueTypes - replaces KeyValues_ml

   - adds funcionality for new key-value pair with (key, float) instead of
  (key, value). Not used yet, but makes use of config easier, e.g. in ESX
  config we can now have e.g.
esx%Kz_kwargs =
  "Kza", 0.1
  "za",  0.5

followed in the relavent code by   za = KeyValue( kwargs, "za" )
etc. Very useful :-)

Changes in:

     Biogenics_ml.f90
     EmisGet_ml.f90
     Io_Progs_ml.f90
     KeyValueTypes.f90   NEW
     KeyValue_ml.f90     DEL
     LandDefs_ml.f90
     Landuse_ml.f90
     Log.changes
     Makefile.SRCS
     Sites_ml.f90
     Volcanos_ml.f90
     run.pl

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st August 2013  Dave   2628

utils/Rd_emepcdf.f90 - modified to stop when asking for 1-d variable. Case
   arose with rotated latlon files. Coding needs more work, but wanted to
   save.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st August 2013  Peter  2627

NetCDF_ml, (CreatenetCDFfile  _Eta):
Always output lon and lat in netcdf output.

removed "call GlobalPosition" (should not be in use anymore. Can be completely removed some day)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 July 2013  Dave  2626

utils/Rd_emepcdf improved:
    accounts for scale_factor and addoffset
    allows for -f option to set format
    checks that format-string sufficient for output. (avoids ***)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2 July 2013  Peter  2625

GridValues_ml.f90: eta coordinates works when coordinates defined in metfile too.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 June 2013  Dave  2624

CRI_v2_R5 now works again, phew!

  See caveats below for limitations (BiomassBurning, BPINENE), but these
  are easily fixed (with some time).

Makefile - added proper dependencies for CRI_v2_R5. Can now type

     make CRI_v2_R5



ZCM_CRI_v2_R5:

  CRI_v2_R5base.reactions file - corrected for rcbio, Rn222 etc,

  BiomassBurning_FINN... file copied from EmChem09. Should
  really use CRI species.

  EMISPLIT/emissplit.defaults.pmxx - copied from EmChem09

  BPINENE not yet in emissions. Have commented out rcemis term for
  now, and also "BVOC" label in .species files (otherwise the
  emep model expects to find an emission fields), but if wanted
  BPINENE could be taken as a fraction of the APINENE emis.

Also:

  run.pl   $outputs added to stear which config file is used for outputs. No
           need for different outputs for all exp_names.

           + CRI changes, also to use EMISPLIT for now

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
26 June 2013  Dave  2623

Radiation_ml: added units for PAR (a user asked what they were)
              and slightly more doxygen-friendly comment indicators
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
25 June 2013  Peter 2622

NetCDF_ml: ReadTimeCDF recognise times unit 'day as %Y%m%d.%f'
(as in EnsClim BC)

NetCDF_ml:   bug in ReadField_CDF
      Ndiv=2*nint(Grid_resolution/GRIDWIDTH_M)
will give strange landuse patterns if all these condition are met:
1) PolarStereographic projection
2) Resolution finer than 5km
3) Emep area


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20 June 2013  Dave 2619

RESULTS CHANGE FOR HISTORICAL TREND RUNS < 2000 - tag as rv4.4.1

GlobalBCs_ml - 1) added macehead_default array

               2) Set USES%MACEHEAD_AVG = T in config to force use of
               default MH corrections.

               3) Set base-year of O3 trend to 2000, instead of 1990. Seems
               better compared to observations, Parrish et al. and forthcoming
               borders paper (with JEJ). This will change O3trends prior to
               2000.

ModelConstants_ml - Added USES%MACEHEAD_AVG = .false. to namelist variables

Log.changes    - added rv4.4 message to 2599. Probably needs a branch for the
               final release of rv4.4.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
20 June 2013  Dave 2618

Small tidy up and correction to settings:

mk.GenChem - reset to EmChem09soa default

ModelConstants_ml - debugs false

Emissions_ml.f90 -  commented out code removed

My_Derived_ml.f90 - NMOSAIC print outs commented out.

config_EMEPSTD.nml - EMIS_SOURCE set to None


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
19 June 2013  Dave 2617

emis_inputlist introduced  to read any number of netcdf emission files, as long
   as they conform to the EMEP style, e.g.  Emis:INTSHIPS:snap:8

   Has been used to combine MACC2 7km, IIASA 0.5 degree and IPCC shipping


ModelConstants_ml
  emis_inputlist  defined and in namelist

EmisGet_ml
  various debugging changes.

Emissions_ml
  loop over emis_inputlist now replaces older calls to GriddedSnap, GlobalSnap

config_EMEPSTD.nml
  examples of use of emis_inputlist added, from ECLAIRE work.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
16 June 2013  Dave 2616

Emission_ml: changed unset index iem to iemCO in SnapPos printout

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
15 June 2013  Dave 2614-2615

run.pl - grouped together testv, Chem, exp_name , GRID for clarity and to
  prevent common mis-matches.

ModelConstants_ml
  new config DEBUG system started, with:
   DEBUG%HOURLY_OUTPUTS
   DEBUG%BCs
  Also:
   USES%MACEHEADFIX = .true. by default

BoundaryConditions_ml
  DEBUG%BCs instead of DEBUG_BCS

ForestFire_ml.f90
   Improved monthly calculation. Still in development and testing though.

GlobalBCs_ml -  Uses USES%MACEHEADFIX  and DEBUG%GLOBBC

Unimod - removed older TEST DOY printout. That had just shown that DOY was
  okay with e.g. day_of_year(yyyy,12+1,1)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5 June 2013  Svetlana and Alvaro,   2608-12

AOD_PM_ml.f90 - hard-coding removed, MWT for PPM corrected,
some cleaning in Rh interpolation.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5 June 2013  Peter,   2607

NetCDF_ml: remove characters after "lat lon" for projection read from file.
(an invisible characater is appended by nco)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
5 June 2013  Dave,   2605-2606

2606:
** NEW **
   config_Outputs_EMEPSTD  - start of new config system for My_Derived -
   now reads namelist from (currently) config_Outputs_$exp_name

ZD_OZONE/My_Derived_ml. Much code removed, replaced by  namelist read in
    Init_My_Derived. (Will consider moving this call later.)


Also:
   run.pl - extended for some RCA settings.

2605:
SmallUtils_ml - added option first_only to find_index_c - let's user search
   for first occurence of a string (e.g. NOTSET).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4 June 2013  Alvaro, 2604

ZD_OZONE/My_Outputs_ml
- correct 1 char bug introduced on 2602.
  It caused the model to crash on the first hourly output.

Makefile
- Update vilje modules: new requirements for intel compiler 13.0.1 are
  MODULES = intelcomp/13.0.1 mpt/2.06 netcdf/4.3.0

config_EMEPSTD.nml
- restore  to full domain.
  RUNDOMAIN was wrongly set to 100x100 benchmark on 2599

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
4 June 2013  Dave, 2603

de-associate...

Forest_Fire_ml.f90 - removed outer associate block, which (for unknown reasons)
  stops intel 12.0 (vilje) from compiling code. intel 13.0 works fine, but for
  now I have replaced => with simple = assignments. Shame.

  (The inner loop associate does work, as does associate in Unimod.f90. Very
   odd.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3 June 2013  Alvaro, 2602

Output_hourly,ZD_OZONE/My_Outputs_ml
- re introduce PS output on Output_hourly as part of the CF convention
  (introduced revision 2509; removed revision 2597).
  To be written out only if there is no user defined PS output
- remove PS user defined hourly output (introduced revision 2597).

ExternalBICs_ml,config_FORECAST.nml
- Rename IFS_EVA_2010 ExternalBICs_bc description%version to IFS_MACC_EVA

ZD_OZONE/My_Outputs_ml
- Rename MY_OUTPUTS EVA2010 case to MACC_EVA

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1 June 2013  Dave, 2600-2601

Fortran 2003 "associate" introduced, and start of new config system (USES% type):

ForestFires_ml:
   USES type added, with forest-fire settings as first example
   Introduced USES%MONTHLY_FF option to force monthly-average emissions
    (very inefficient so far, called every day, but will fix later.)

ModelConstants_ml: USES type added, with forest-fire settings as first example
Setup_1d_ml: USES%FOREST_FIRES
Unimod.f90:  USES%FOREST_FIRES and associate (e.g. mm=> current_date%month)

config_EMEPSTD, EMERGENCY, FORECAST, IMPACT2C updated with new USES system.

Both of these features simplify the code and should be expanded.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 May 2013  Alvaro, 2595-2599 - to be released as rv4.4 open-source summer 2013

2595: Prepare code for status runs
2596: eEMEP and FORECAST downstream updates
2597: Improve hourly output
2598: Extend Nest configuration via namelist
2599: 3DVar updates

Makefile:
- make targets with Grimsvotn eruption tracers (EMEP2011 SR-EMEP2011)
- make eEMEP target with EmChem09 insead of EmChem09soa
- mk.GenChem quiet option (-q) for all GenChem targets, except EMEP and EMCHEM09
- compilation options for MACHINE=byvind

run.pl
- make and BM options for status run
- introduce MACC14 domain, and use it as default for FORECAST runs

mk.GenChem
- Emergency files created by mk.GenChem (emergency_location.csv & emergency_emission.csv)
  will be kept in ZCM_Emergency, instead of the run directory (ZCM_EmChem09soa).

Units_ml
- Fix wrong unit conversion for uBqh.

FUTURE_Pollen_ml,run.pl
- change name for pollen forecast dump/restart files

Emissions_ml,run.pl
- Remove hardcodded path to Emis_TNO7.nc
- Change name used in model from Emis_TNO7.nc to EmisFracs_TNO7.nc,
  in order to distinguish this emission format from others currently been tested.
- run.pl links EmisFracs_TNO7.nc to Emis_TNO7.nc

Output_hourly,Derived_ml,ModelConstants_ml
- rename IOU_HOUR_PREVIOUS to IOU_YEAR_LASTHH

Output_hourly,ZD_OZONE/My_Outputs_ml
- D2D specific types _inst, _accum & _mean for instantanous, accumulated and mean
  output comparable to daily,...,yearly output.
  D2D_inst is taken from d_2d(..,IOU_INST). D2D_accum and D2D_mean are
  calculated from d_2d(..,IOU_YEAR)-d_2d(..,IOU_YEAR_LASTHH).
- Change D2D output for averaged species (f_2d(ispec)%avg).
  For such species D2D will assume that D2D_mean is required.
  In previous versions, it assumed D2D_inst.
- Hourly PS output is defined as
    hr_out(0)=Asc2D("PS","D2D_inst",find_index("PSURF",f_2d(:)%name),...
  This is to avoid the double definition in hr_out and Output_hourly

Nest_ml,config_*.nml
- Nest BC input/output frequency (NHOURREAD/NHOURSAVE)
  defined trough Nest_config namelist

ZD_3DVar/Makefile,Analysis/DA_Obs_ml,DA_3DVar_ml
- implement MATCH chisq_over_nobs2 routine for chi^2 evaluation

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
31 May 2013 Dave, 2594

Met_ml:  code for SMI now re-written to check for different options in a loop:

   ! Soil water has many names. Some we can deal with:
   ! (and all need to end up as SMI)
    character(len=*), dimension(4), parameter :: possible_soilwater_uppr = (/&
        "SMI1                " &
       ,"SMI                 " &
       ,"soil_water_content  " &
       ,"soil_wetness_surface" &
    /)
    character(len=*), dimension(3), parameter :: possible_soilwater_deep = (/&
        "SMI3                   " &
       ,"SMI                    " &
       ,"deep_soil_water_content" &
    /)

Tested for IFS, TNOxx, RCA, and EMEP (after the usual struggles with DUST,
clay, etc.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th May 2013  Dave, 2593

Makefile - EMCHEM09 option added, to use just EmChem09 chemistry.
          (We don't always need SOA!)

run.pl  - Just uses EMISPLIT specials if EmChem09  (to avoid trying to
           split PM25)
        - commented out VolcanoesLL_2010.dat line added. Should probably be
          used for all years.

Log.changes  - try to keep text within 78 chars (as in code).
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
27th May 2013  Peter, Heiko  2592

NetCD_ml: i and j defined correctly in Rotated lat lon projection
          (were in km up to now).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 May 2013  Dave  2591

ModelConstants_ml
config_EMEPSTD.nml

  Replaced faulty Ndep_trends system with namelist-controllable
   EURO_SOILNOX_DEPSCALE in ModelConstants_ml, Biogenics_ml.
   See ModelConstants_ml for usage.
   Removed Ndep_trends code from Emissions_ml

Also, moved USE_AIRCRAFT_EMIS, USE_LIGHTNING into namelist system.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 May 2013 Peter 2590

Added a switch MARS_RATIO_SMOOTH in MARS_ml to test without smoothinh between
different TNH4/TSO4 regimes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 May 2013 Semeena 2589

Some formatting corrections with tex file, chapter:Subrun.tex of Manual

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23 May 2013  Semeena 2588

Added more details to the Manual.
Chapter: How to submit a run.  Details about different 'Nesting' options.

2586 and 2587 are submitted my me with the above mentioned changes in the
 chapter 'subrun.tex'.  Forgot to mention those changes here.  So 2588 is
identical to 2587 apart from this 'Log.changes' file.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th May 2013 Anna 2585
Deleted old versions of Manual/UserGuide files in DOCS/Manual:
running.tex, general.tex, Outputs.tex, Inputs.tex

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
13th May 2013 Anna (2584 (and 2583))
Updated files in DOCS/Manual as released with Open Source code 2565 rv 4.3:
Input.tex, Intro.tex, Manual.tex, Output.tex, references.tex, Subrun.tex

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
8th May 2013  Peter (2582)

Met_ml
Slightly different derivation of vertical wind in eta coordinates (not use in sigma coordinates)
DOCS/vert_wind.tex
Tex documentation with mathematical justification of the expression for vertical wind.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd May 2013  Peter (2581)
Added "micro g/m3" as unit in Units_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
3rd May 2013  Peter (2580)
Met_ml: character *100 :: period_read=' '
It seems that gfortran can fail (runtime segmentation fault) in some cases when the variable
is not initialized  *in the declaration* (!)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd May 2013 Alvaro, Peter (2578)

Nest_ml, ExternalBICs_ml
ICBC_FMT, istart=max(istart,RUNDOMAIN(1)...)
can now put in config file to get full domain:
istart=-999,jstart=-999,iend=9999,jend=9999,

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
2nd May 2013 Peter (2577)
One line had fallen out of Makefile
  LLIB := $(foreach L,$(LLIB),-L$(L) -Wl,-rpath,$(L))
Removed output comment in NetCDF
('WARNING: interpolation method may be CPU demanding' for Rotated_Spherical)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st May 2013 Dave (2575)
GlobalBCs_ml - changed format for SIAtrend output to fix gfortran crash
  reported  by Adam Miles.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th April 2013 Peter (2574)
Units_ml: accept ppbV as ppb
NetCDF_ml: accept 'longitude' or 'latitude' instead of 'lon' 'lat'

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th April 2013 Dave (2573)

Makefile - gstallo option added (with Steinar's help), so one can do
   make MACHINE=gstallo (on stallo). NOTE - need to do:

    module swap intel gcc/4.7.2

   before compilation. Doesn't run yet, that is for another day. There
   are plenty of warnings generated by the make though, should keep us
   busy for a while.

Also, utils/Rd_csvsondes.f90. Length of longline increased to cope with
   all-species sonde outputs (35000 chars).


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
30th April 2013 Dave (2572)

gfortran compilation needed changes in:

 EcoSystem_ml.f90 - needed trim around entries in DepEcoSystem setting

 ModelConstants_ml.f90 - removed unused variables

 SeaSalt_ml.f90 - had + & then another + (on 2 lines for rcss)

 ZD_OZONE/My_Derived_ml - had to have equal width entries

Not tried to run yet.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
28th April 2013 Dave (2571)

Emissions_ml - fixed call for global soil emissions for 2005, which
  was causing a crash in global runs.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
24th April 2013 Dave (2570)

Added utils/Rd_emepcdf   -  reads EMEP (or some other netcdf) files
  and outouts ascii. Can read PS or lat/long data. Good to extract data
  for plotting.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
23rd April 2013 Dave (2569)

Corrected: Rd_csvsondes.f90 ;-)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
22nd April 2013 Dave (2568)

Added:

Rd_csvsondes.f90 to utils directory

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
21st April 2013 Dave  (2567)

Country_ml - added EGYP

EmisGet_ml.90 - tmp - some debugging changes

run.pl - added $MONTHLY_EMIS, which should be set to zero if
         global emissions are not monthly. ECLAIRE example added.


(all in preperation for new ECLAIRE/ECLIPSE global runs)

Emissions files (annual) for ECLAIRE 1deg created in GLOBAL. Used
if exp_name =~ /ECLAIRE/

NOTE - BUG found in some global emission files. Always check
emission output of runs!

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TAG: 2565 as rv4.3   19th April 2013 xxxxxxxxxxxxxxxxxxxx
      (version used for Open-source course, and apart from AOD same
       as for Gothenburg Protocol runs.)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
18th Svetlana (2564)

AOD_PM_ml.f90 - corrections in v. high RH behaviour.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th Svetlana (2563)

AOD_PM_ml.f90 has been re-written in a flexible way,
where species indices are found by "find_index" function in Derived_ml.

AOD_PM_ml.90
Derived_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th Dave  (2562)

BGND_CH4 added as namelost variable, to allow CH4 to be reset with
  the config file. Use of BGND_CH4 = -1 keeps default settings.

ModelConstants_ml
BoundaryConditions_ml
config_EMEPSTD.nml -  have not added yet to other configs as optional

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
17th April (2561)
Birthe - removel Pollen for user course
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 17th April  (2543)  = GP_work version

run.pl -- added die unless config_exp name (I wasted 1000s h CPU with
    a missing config file! Dangerous)

Clean-ups only, no result change. Mainly took away JAN2013, NONWP etc.

AOTnPOD_ml
BLPhysics_ml
BoundaryConditions_ml
DO3SE_ml
DustProd_ml
DryDep_ml
LandDefs_ml
Landuse_ml
MetFields_ml
MosaicOutputs_ml
Unimod.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TAG: 2546 as rv4.3beta   14th April 2013 xxxxxxxxxxxxxxxxxxxx
          (version used for Gothenburg Protocol runs.)
          (same as 2543. System seems a bit confused
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 13th April  (2543)  = GP_work version
Fixed bug in Ndep_trends (now sent to all nodes)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 13th April  (2542)

Soil-NO emissions future proofed for Euro-versions anyway

Emissions_ml
  added sumEU and calcu
  Ndep_trends factor added, which compares read-in EU N emissions with
  value from 2005 GP_work. The latter is hard-coded, but this method
  allows the model to be run for e.g. 2050, without needing pre-runs
  to establish deposition fields.

Biogenic_ml
  Uses Ndep_trends to calculate soil NO (if USE_EURO_SOILNOX )

run.pl
  Removed link to 2020 Ndep fields. Just use the 2005_2009 average
  as base.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 12th April  (2541)

Changes in : a) Soil-NOx
             b) MedLAI function
             c) config_EMEPSTD

a) Better split between USE_EURO_SOILNOX and USE_GLOBAL_SOILNOX

   Biogenics_ml
   Emissions_ml
   Setup_1d_ml
   ModelConstants_ml


b) MedLAI provides Mapping Manual variation in LAI

  Landuse_ml

c) config_EMEPSTD now has
    EMIS_SOURCE           = "emislist", ! "emislist" or CdfFractions
    EMIS_TEST             = "None",  ! "None" or "CdfSnap"
  (I thought I had put these earlier. Overwrite?)

Minor tidy-ups
DryDep_ml, Derived_ml, LandDefs_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 12th April  (2540)

Pollen_ml, SeaSalt_ml, Setup_ml : Emis_BioNat changed to EMIS_BioNat,
as used in rest of code. Please be careful not to change case...

Unimod.f90  - removed unused variables from "use" list.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 11th April  (2538)

Tidy-up (more to RunLog)

ModelConstants_ml,
Unimod.f90
MassBudget

  More outputs sent to RunLog, including NML from ModelConstants
  USE_CONVECTION added to NML, default F
  (added in config_EMEPSTD, config_IMPACT2C)

  eulmod.res/IO_RES removed. Was empty except for extended Mass
   debugging. Latter now sent to IO_LOG, but could just use
   unit 6?

GlobalBCs_ml, BoundaryConditions_ml, Unimod.f90
  iyr_trend removed from subroutine calls. Use from ModelConstants_ml
  BC trends sent to PrintLog

Smaller changes:

Biogenic_ml - refs updated

DryDep_ml - print changed to write except before CheckStop

Emissions_ml - comments re soil NOx corrected

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 11th April  (2537)

GlobalBCs_ml

- soxtrend, noxtrend, nh4 trend method (based loosely upon observations
  of US emissions) modified, now with data from EPA to 2012,  then
  IIASA ECLAIRE/ECLIPSE emissions for 2030 and 2050. Fake 2200 values
  added. BCs to non-existing years interpolated.

  Results change, since previous code used 2003 values for all later
  years.

  Trends now written to RunLog

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter 10th April 2013 (2536)

Met_ml.f90:
Bug when cc3d is derived from cloudwater -> was always zero!
(not sure which metdata uses cloudwater)
put also an additional max,min for cc3d, to ensure non-negative values.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter, Dave 9th April 2013 (2535)

Bug in massbalance when eta coordinates are used (not default)
Advection_ml.f90

run.pl: new test for STALLO/VILJE, removed TITAN

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter 8th April 2013 (2534)

Modified definition of timezones in Country_ml.
NB: this will modify results!

Modifications (in parenthesis the old values):
 Portugal: 0 (1)
 Former USSR: -100  (3)
 Remaining land areas: -100 (1)
 Remaining NE Atlantic Ocean: -100 (1)
 The Black Sea: 2 (1)
 Natural marine sources: -100 (1)
 Kola/Karelia: 4 (3)
 St.Petersburg/Novgorod-Pskov: 4 (3)
 Belarus: 3 (2)
 Kazakstan : -100 (6) ?
 Rest of Kazakhstan (in the extended EMEP domain) : -100 (5) ?
 Other Asian areas: -100 (0)
 Russian Federation: -100 (3)
 USA: -100 (1)
 Canada: -100 (1)
 Azerbaijan: 4 (3)
 Atlantic outside. EMEP : -100 (1)
 Russian Fed. outside emep: -100 (4)
 Biomass burning (wild): -100 (0)
 B. Sea * cargo * 12 : 2 (1)
 Rest of extended Russian Federation (in the extended EMEP domain): -100 (7)
 Uzbekistan (in the original EMEP domain) : 5 (4)
 Turkmenistan (in the original EMEP domain): 5 (4)
 Rest of Uzbekistan (in the extended EMEP domain) : 5 (4)
 Rest of Turkmenistan (in the extended EMEP domain): 5 (4)
 Caspian Sea (in the original EMEP domain): 4 (3)
 Tajikistan (in the extended EMEP domain): 5 (4)
 Aral Lake (in the original EMEP domain) : 5 (4)
 Rest of Aral Lake (in the extended EMEP domain): 5 (4)
 Modified remaining Asian areas (in the original EMEP domain): -100
 (3)
 Remaining extended Asian areas (in the extended EMEP domain): -100
 (6)
 Arctic Ocean (in the extended EMEP domain): 9 (8) ??
 Extended EMEP-external part of Russian Federation: -100 (12)
 Extended EMEP-external part of Asia : -100 (7)
 Extended EMEP-external part of Pacific Ocean : -100 (12)
 Extended EMEP-external part of Arctic Ocean : 9 (12) (same as Arctic
 Ocean)
 EMEP-external part of North Africa : -100 (1)
 Rest of Africa and Asia: -100 (1)
 Ships: -100 (1)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 6th April,  2529

run.pl - uses hostname to detect stallo or vilje. Needs testing for
          titan


AOTnPOD_ml
   new index SPOD added    (SPOD is experimental. Not for routine output)

Derived
   SPOD enabled.

DryDep_ml
   SPOD enabled. Possibility of ascii outputs (default off)

MosaicOutputs_ml
   SPOD enabled.

Rsurface
   extra debug

Sites_ml
   made site_gn public  ( was site_n)

ZD_OZONE/My_Derived_m
  SPOD added


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter 4th April 2013 (2528)

New paramater in namelist for ModelConstants_ml:
 EMIS_OUT    = .false.           ! output emissions in separate files (memory demanding)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave,  3 Apr 2013 (2527)

** results change a little. Due to slighlty different coverage of
   IAM species. Also, somewhat updated DO3SE params **

New 5km landcover file (LC) used, with allowance for flexible
landcover.

Landuse_ml - reads the Landuse_PS_5km_LC.nc file to set Land_Codes
           - if a variable IAM_VEG is found, creates fake
             landcover for all veg in FLUX_VEGS array (see below)

             Hard-coded LC defns removed :-)

DO3SE_ml - modified to use Land_Codes coming from Landuse
LandDefs_ml - modified to use Land_Codes coming from Landuse

ModelConstants_ml - added new namelist item:
  FLUX_VEGS   - can be IAM_DF, or NEUR_SPRUCE etc.
  + new variable nFluxVegs which is used in Landuse_ml
    removed unused variable NVGOUT_MAX

(defaults set in config_EMEPSTD.nml, config_IMPACT2C.nml)

StoFlux - removed unneeded variables (NLanduse_DEF)

run.pl - links to new files, exclude link to older

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter, Dave 2nd April 2013 (2526)

Towards new system to define landuse codes from netcdf file, instead of predefined list.
Landuse_ml will first try to find a file 'Landuse_PS_5km_LC.nc'.
If this is found it includes all landuse with names of the form LC:CF:EMEP (where CF can be any name).
The missing data are still read from the "old" "LanduseGLC.nc" (with old names).


Recipe for use:
include this line in the run.pl
  $ifile{"$DataDir/Landuse/Landuse_PS_5km_LC.nc"} ="Landuse_PS_5km_LC.nc";
The rest is automatic

If the file is not found, old system is used (i.e. default if run.pl is not modified).
/global/work/mifapw/emep/mk.rename
has been used to make the new names

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 29 March 2013 (2525)

i) Corrected MY_OUTPUTS usage (I had forgotten to commit My_outputs_ml and Met_ml)
ii) towards more flexible landuse/DO3SE params:

ModelConstants_ml: NLANDUSEMAX increased to 30

ZD_OZONE/My_Derived_ml: extra requets for "real" species (NEUR_SPRUCE etc.)

ZD_OZONE/My_Outputs_ml:  uses MY_OUTPUTS as decribed below

LandDefs_ml - NLANDUSE_EMEP = 29  ! work-in-progress
              More flexible definition of forests (LAImax>0.5, h>5)

Met_ml - PARLAM soil water fixed as noted below

GridValues_ml, StoFlux_ml - small debug changes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 27 March 2013 (2524)

MY_OUTPUTS variable now used in place of EXP_NAME, with new system

   EXP_NAME - should match the config file

   MY_OUTPUTS should select the appropriate data-sets in My_Outputs_ml

  - added in config_EMEPSTD, config_EMERGENCY, etc.


BUG-fix for PARLAM usage and extensions for "real" species, and re-enabled
   PARLAM runs with soil water

AOTnPOD_ml - added e.g. POD1_ACE_BEECH etc.

DO3SE_ml - longer names allowed

Met_ml - SMI now calculated for PARLAM inputs too. Reads anyway FC and PWP from IFS, as
these are used elsewhere. So, we are assuming that PARLAM gives SMI, then this can be
used with IFS  FC and PWP if needed.

SubMet_ml - sets L%fSW - BUG FIX for PARLAM usage.

GridValues_ml - small debug change

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TAG: 2522 as rv4.2.1 SVN!!!  25th March 2013 xxxxxxxxxxxxxxxxxxxx
          (version used for ECLAIRE tree-specific delivery, Dave)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Alvaro 22th Mar 2013.  (2520-1)

* Move NEST_MODE to Nest_ml (changes namelists also)
* Small ammend to 2518
* Small chanke to Units_Scale (Units_ml)

ModelConstants_ml,Nest_ml,config_*.nml:
  move NEST_MODE from ModelConstants_ml to MODE on Nest_ml.
  MODE is now read on Nest_config namelist (config_*.nml).

NetCDF_ml:
  redefine CheckStop(chunksizes...) on Out_netCDF.

Units_ml:
  Units_Scale regognizes "ppbv" units as "ppb".

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave   22nd Mar 2013.  (2519)

Changes for IMPACT2C and more general Out3D outputs:

   config_IMPACT2C.nl file added (needs checks on F/T options)

   Output_hourly - options to outut xn_shl added to Out3D case
     (Note: Out3D should replace all earlier use of ADVppb etc.,
      it is a much cleaner system.)
     IMPACT2C cases added as example

  My_Outputs_Ml - IMPACT2C cases added as example with O3, NO, NO2
    and HO2 output at 3m and 45m

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Alvaro 21th Mar 2013.  (2518)

* Handle chunksizes for nc4zip output explicitely.
  Fixes a bug introduced on rv4.2beta4 (4 Feb 13).
* Fix wrong file name for NEST_MODE 1, 11 & 12.
* Move char(0) fix from Nest_ml to Units_ml

NetCDF_ml:
  Additional optional parameter (chunksizes) on Out_netCDF and createnewvariable.
  When present, it sets the size of the data chunk writen by Out_netCDF
  to a variable on a compressed file.

Output_hourly:
  For 3d output, sets chunksizes for a 2d slize on Out_netCDF(create_var_only=.true.)

Nest_ml:
  Additional file_%=date2string(template_%,indate) to ensure that the
  file names are properly defined/updated.

Nest_ml,Units_ml:
  Move the invisible character (char(0)) removal intorduced on 2513
  from read_newdata_LATERAL and reset_3D (Nest_ml) to Units_Scale (Units_ml).
  Now, the full string is searched for char(0).

Nest_ml,config_EMEPSTD.nml
  Define subdomain for write (istart,jstart,iend,jend) on
  NEST_MODE 1 and 3 on Nest_config namelist.
  Other write modes write full RUNDOMAIN regardles of namelist.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave  15th Mar 2013.  (2516-2517)

  Just corrected text on location of mk.meteoPreProc for HDD files
  (has been in utils for some time now, not ZD_EXTRA)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter 15th Mar 2013.  (2513-4-5)

In Nest_ml added two times this line:
if(ichar(units(ilen:ilen))==0)units=units(1:ilen-1)!removes the last invisible character (char(0))

This is because C codes defines strings with a char(0) at the end.
It is invisible, but can makes 'ppb'=='ppb' false. This happen for
instance when units are written in a netcdf file with nco library.

Made a temporay fix so that the model does not crash when the number of vertical
levels is larger than 20:
GlobalBCs_ml.f90
DefPhotolysis_ml.f90
These routines have to be changed anyway if KMAX/=20

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter & Alvaro  14th Mar 2013.  (2511-2)

Nest_ml:
  Fix bug on read IC/BC files for variables on ug/m3 or other units that
  need air density on the unit conversion to mol/mol.
  The logical variable divbyroa was defined only on MasterProc,
  therefore the unit conversion was incomplete/wrong elsewhere.

ExternalBICs_ml,Nest_ml:
  Improve comments. Add variable and subroutine descriptions.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  7th Mar 2013.  (2507-9)

Output in hPa. Pressure PS always put in hourly output, but removed from the others:
PS is needed to define vertical coordinates, but is not correctly defined if averaged, as in daily/monthly/full.

NetCDF_ml.f90
Derived_ml.f90
ZD_OZONE/My_Derived_ml
Output_hourly.f90

Small changes Met_ml Check_Meteo_Date (inq_varid->inq_dimid, close file)
GridValues: A_bnd=P0*A_bnd

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Svetlana  6th Mar 2013.  (2506)

AOD_PM_ml.f90 - has new AOD_Ext routine with updated AOD calculations
(accounting for aerosol "size"  and relative humidity).
Also calculates 3D Extinction Coeffecient

Runchem_ml.f90 - calls for AOD_Ext

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Heiko 5th Mar 2013.  (2504)

Makefile
  - enable builds on met.no-precise machines

EmisGet_ml.f90
  - change read format from "i" to "i6" to satisfy gfortran on precise

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Alvaro 1st Mar 2013.  (2503)

Update Pollen module and use on FORECAST runs.

Makefile,config_FORECAST.nml
  - MACC target is compilled wiht Pollen tracers
  - USE_POLLEN on FORECAST runs

Makefile.SRCS
  - Revert changes on 2497. AOD_PM_ml instead of AODrh_PM_ml,
    so the model can be compiled.

run.pl
  - move/rename restart/dump files for EMERGENCY runs
  - link/rename pollen restart/dump files for FORECAST runs

PhyChem_ml
  - Call to pollen_dump/pollen_read on FORECAST mode

Par_ml
  - add MSG number for global2local call on pollen_read

Pollen_const_ml,Pollen_ml,Makefile.SRCS
  - split Pollen module in Pollen_const_ml & Pollen_ml
    to resolve circular dependency wiht My_Outputs_ml

ZD_OZONE/My_Outputs_ml,Output_hourly
  - Pollen hourly output for FORECAST runs

Pollen_ml
  - Review code
  - Add pollen_dump/pollen_read subroutines for restart/dump files on FORECAST mode
  - Align/format & other house keeping

Runchem_ml
  - Add pollen_flux calls
  - Align/format & other house keeping

Unimod
  - PrintLog(...,USE_POLLEN)

NetCDF_ml,
  - remove use My_Outputs_ml FREQ_HOURLY

Emergency_ml,Makefile
  - Increase number of emergency senarios in une run.
  - Set all 10 NPP accident senarios as default.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Heiko  9th Mar 2013 (2510)

setting xenon as nobel-gas
using Xe-133 instead of Xe-131 (stable)
adding Dust and SeaSalt to emergency-runs, required by Svetlanas new AOD-module
writing out conc for all NPP and NUC, dropping 3d output (TODO: wdep,ddep)
removing restriction on 9chars per NPP/NUC

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Heiko  1st Mar 2013.  (2502)

put back positve="down" for sigma-coordinate after reading CF-convention

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  1st Mar 2013.  (2501)

Put "units=Pa" for hyam and hyai.
NetCDF_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Heiko  1st Mar 2013.  (2500)

Remove 'units' and 'positive' for atmosphere_sigma_coordinate
writing PT to file in hPa

Modified:
NetCDF_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  28th Feb 2013.  (2499)

NetCDF_ml can now output in hybrid coordinates and following
CF-1.6 convention (requires USE_EtaCOORDINATES=.true.).
Also corrected a bug for output hourly that prevented to write
out all 21 levels (20+surface).
PS written out, because it is used (with name "PS" and unit Pa)
to define the vertical coordinates.

Modified:
NetCDF_ml.f90
Derived_ml.f90
ZD_OZONE/My_Derived_ml
Output_hourly.f90
Met_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Svetlana  28th Feb 2013.  (2494-8)

AODrh_PM_ml.f90 - updated AOD calculations (accounting for aerosol "size"
  and relative humidity). Also calculates 3D Extinction Coeffecient
Chem_ml.f90 - new parameter Extin_Coeff
Makefile.SRCS
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  27th Feb 2013.  (2493)

More changes for hybrid vertical coordinates. Should not affect results.
New advection and convection in hybrid coordinates: convection_Eta, advecdiff_Eta
the "p*" from sigma equations must be replaced by dp/deta

Adapted routines:
CellMet_ml.f90
BoundaryConditions_ml.f90
Convection_ml.f90
Advection_ml.f90
Emissions_ml.f90
Met_ml.f90
Sites_ml.f90
Setup_1d_ml.f90
Volcanos_ml.f90
ZD_VBS/My_SOA_ml.f90
ModelConstants_ml.f90
PhyChem_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  26th Feb 2013.  (2492)

Defined Etadot and reversed the change from (2490).
The default is again the old (same as before 2490) method!
To use new cordinates Etdot has to been exlicitely used.
Since the value of Eta at a given altitude differ from sigma, the two methods
are not identical.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  25th Feb 2013.  (2491)

Defined EtaKz and the corresponding routine (Kz_m2s_toEtaKz). Not in use yet.
(EtaKz will replace SigmaKz at some later stage)
MetFields, Met_ml, BLPhysics_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  22nd Feb 2013.  (2490)

Define hybrid vertical coordinate Eta=A/Pref+B in GridValues.
Modify sdot definition derived from horizontal winds in Met_ml.
NB: this will modify results!
The vertical winds should be weaker over mountains, specially at high altitude.
Also prepared a new routine in Advection_ml (not used yet).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave   21st Feb 2013.  (2487)

Sites_ml - local MY_DEBUG replaced by use of DEBUG_SITES, plus extra
           debug formatting

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  20th Feb 2013.  (2486)
A new step towards flexible vertical coordinates.
The grid definitions (and in the future all static data) can be read from a separate file,
Grid_Def.nc
Experimental so far (not used by default)
Met_ml.f90
GridValues_ml.f90
run.pl

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave  20th Feb 2013.  (2485)

Enabling extra outputs of ozone-flux params, plus more explicit
use of L% variables in DO3SE calculations

Derived_ml - change of label (YYYY to D2IND - latter is easier to find)

DryDep_ml - safer use of L and Sub
          - SPOD_OUT outputs added. Temporary, and switched off by
            default

DO3SE_ml - safer use of L and Sub

Io_Nums_ml - IO_SPOD added. CAREFUL - many io numbers can be called,
   as DryDep uses IO_SPOD  me. (Not switched on by default though.)

LocalVariables_ml  - just use -999 not -999.999 to avoid -1000 in prints

Mosaic_ml - added extra outputs

Rsurface - safer use of L and Sub

Sites_ml - some variables made public for use in DryDep

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter, Dave  20th Feb 2013.  (2484)
AOD initialized to 0.0 in Chem_ml.f90 (could lead to crash when debug option used)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter, Dave  19th Feb 2013.  (2483)
replaced "/WH2O" by "/max(WH2O,FLOOR)" in MARS_ml, since WH2O could get zero.
Not expected to change results.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Alvaro  18th Feb 2013.  (2482)

Emergency_ml,ZCM_Emergency/NPP_Accident.csv
  Extend emergency event (eEMEP:volcanic eruption or npp accident) defaults.
  A single defaul can have multiple lines, e.g.
  each line with a difinition for a different specie

ZCM_Emergency/NUC.species,NUC.reactions,NUC_Location.csv,NUC_Explosion.csv
  Additional files for nuclear explosion scenarios (eEMEP)

mk.GenChem,run.pl,Makefile
  Aditional tracers and emissions for nuclear explsion senarios (eEMEP) with
    mk.GenChem -X scenario

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  18th Feb 2013.  (2481)
Removed all the "MPIbuff" used to buffer the data in  MPI_ALLREDUCE.
Can use "MPI_IN_PLACE" instead.
Does not modify results.
Advection_ml, GridValues_ml, MassBudget_ml, AirEmis_ml, Emissions_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter  18th Feb 2013.  (2480)
Correction to the 2477 changes: The factor could be negative in some cases.
Timefactors_ml.f90

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave  18th Feb 2013.  (2479)

ZD_.../My_RunSettings files removed. Not used.

Dave  18th Feb 2013.  (2478)

Country_ml - extended with IIASA global regions. ERROR spotted for
  older global regions - timezones should be set to -100 for US, Canada
  and quite a few other regions. Not done yet!

  Country regions EU27, EEA, XMACC2 ... defined. Used in:


EmisGet_ml, Emissions_ml - extended to allow incl and excl arrays
  which can be used to choose between global IIASA emissions or
  higher resolution cdf emissions. As cdf emissions are not yet
  enabled in the code, no effect so far, except to help produce
  EmisOutCdf ascii files which contain merge of global and INERIS/TNO
  emissions for different grids.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter 15th Feb 2013.  (2477)

NB: this will affect results a lot! (shift emissions by 2 weeks)

EmisGet_ml.f90: close netcdf (memory leak otherwise)
InterpolationRoutines_ml, new routine Averageconserved_interpolateInterpolate
Timefactors_ml: timefactor for month, new interpolation between monthes. (see also 2480).

New turning point at the middle of the period. The equation to solve is then:
1)Factor at start of month is equal average between two adjacent month
2)Factor at end of month is equal average between two adjacent month
3)Integral or average over all factors in a month is equal to monthly factor
4)The factor changes linearly from start to middle, and middle and end of the month

The value to calculate by a simple formula is then the factor at the middle of the month that gives all the wanted properties.
If we don't take into account the discretization (but we will take this into account, so the formula will get much more unreadable):

Middle = 2*Average - (End + Start)/2

Also since we need a new turning point, we will get something like "if(xday<0.5)then ...else...".

This will give some level of extrapolation, since the value at middle of the month can for example be higher than the average of all the 3  monthes (but never unreasonable values).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Alvaro 15th Feb 2013.  (2475-2476)

Implement read/write for NPP Accident senarios (eEMEP/NUC)

Volcanos_ml,Emergency_ml,Makefile.SRCS,
  Move volcanic eruption code (eEMEP/ASH) out of Volcanos_ml
  into a new module Emergency_ml

Emergency_ml,Setup_1d_ml
  Rename EruptionRate to EmergencyRate

Emergency_ml,mk.GenChem,run.pl
  Rename volcanoes.csv and eruptions.csv to emergency_location.csv and emergency_emission.csv,
  respectively. The emergency_*.csv files contain locations and emissions parameters
  for all emergency senarios in use.

Makefile
  Add target eEMEP2013 for easy cinfiguration for "North Korea nuclear test"
  scenario

ZCM_Emergency/NPP_Accident.csv,NPP_Location.csv
  Add/update scenario paramenters for NPP accidents

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 14th Feb 2013.  (2474)
Code added to test new netcdf emission systems.  The new emissions don't
do anything just yet except slow the code down enormously if
swtiched on (-> interpolation from 7km for many countries), but a
new routine EmisOut has been added to produce emislist-like files. Thus,
it should be possible to run the code slowly once, then use the ascii.
At least until we have speeded things up. All in testing!


ModelConstants_ml
   EMIS_SOURCE EMIS_TEST added

   EMIS_SOURCE can be emislist (default) or CdfFractions (Peter's intepolation
    from INERIS 7km).

   EMIS_TEST can be none or CdfSnap - my testing

   SEAFIX_GEA_NEEDED moved into namelist

EmisGet_ml
   Added routine EmisGetCdf to read new netcdf files. Reads all variables
   with name-prefix of Emis:  (e.g Emis:UK:snap:7). Prelim.

Emissions_ml

   With EMIS_TEST = CdfSnap, now calls EmisGetCdf (above) and
    interpolates from new netcdf emissions. Results
    stored, not used. Can be output with:

   EmisOut routine - outputs emislist-like ascii files. Works for
    current snap, CdfFrac-type and CdfSnap-type


run.pl
    Link to netcdf emissions added. All prelim, and for testing.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Alvaro 13th. February (2473)

ExternalBICs_ml.f90,*/*_ExternalBICs_ml,Makefile,Makefile.SRCS,Nest_ml
  Merge */*_ExternalBICs_ml into a single module.
  Application specific code goes into namelist, see config_FORECAST.nml.
  Data type icbc extended for BC descriptions to be EmChem independent.

ModelConstants_ml,config_EMEPSTD.nml
  Set RUNDOMAIN on namelist

Nest_ml,config_EMEPSTD.nml
  Set filename templates on namelist

run.pl,config_FORECAST.nml,config_EMERGENCY.nml
  Add namelist files for FORECAST & EMERGENCY runs

mk.GenChem,ZCM_Emergency/NPP_Location.csv,ZCM_Emergency/NPP_Accident.csv
  Add emission defaults for NPP accident.
  Rename NPP.csv to NPP_Location.csv

ZD_OZONE/My_SOA_ml.f90
  Remove Fgas definition

ZCM_EmChem09/BiomassBurning_GFASv1_to_EmChem09.inc
  new file

Units_ml
  ug/m2 output for column output

Volcanos_ml
  Eruption_found=.true. for first call on EMERGENCY mode

ZD_OZONE/My_Outputs_ml.f90
  Nuclear accident output

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave 13th. (was 2468-2471)

Country_ml - added global IIASA/ECLIPSE countries

GridAllocate_ml - optional debug flag added

Emissions_ml, EmisGet_ml -  call to femis moved to Emissions_ml

NetCDF_ml - check subroutine made public

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxx  rv4_2 MOVE TO SVN!!!  12th February 2013 xxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Code-based moved from stallo. Code in rv4_2 has several changes which
affect results compared to rv4_1.


xxxxxxxx  rv4_2beta7      Peter  8th February 2013 xxxxxxxxxxxxxxxxxxxx

Bug in last change: did not close the file before returning in the "skipping" case. This created a memory leakage.
NetCDF_ml

xxxxxxxx  rv4_2beta6      Peter  6th February 2013 xxxxxxxxxxxxxxxxxxxx

Still INTERIM -same statis as rv4_2beta5nml

NetCDF_ml: look for minlat,maxlat,minlon,maxlat to see if data reading kan be skipped
Could need some polishing for 360 degree periodicity og longitudes.

xxxxxxxx  rv4_2beta5nml   INTERIM!!! Dave  5th February 2013 xxxxxxxxxxxxxxxxxxxx

namelist system started, changes indicated by !NML in code.


ModelConstants_ml now has routine config_ModelConstants, called from
Unimod.

The namelist file is so far called by run.pl using $exp_name, which
is EMEPSTD by default.

file config_EMEPSTD.nml added to cvs.

Code will now not work for FORECAST etc. - that will need a new namelist file,
config_EMERGENCY.nml, config_FORECAST etc.

Changes in

run.pl  - exp_name and config_$exp_name.nml added
ModelConstants_ml
Emissions_ml  (MONTHLY_EMIS now in ModelConstants)
Io_Nums_ml (now has IO_NML)
NetCDF_ml  (SELECT_LEVELS_HOURLY, now in ModelConstants)
Output_hourly  (SELECT_LEVELS_HOURLY, now in ModelConstants)
Volcanos - NEEDS CHECK. HAD Vent_found, Eruption_found tied to
  USE_EMERGENCY, but presumably even standard runs could have
  emissions? Suggest different logic, but set false for now
   (Is Vent_found used?)
My_Outputs_ml  (SELECT_LEVELS_HOURLY, now in ModelConstants)

xxxxxxxx  rv4_2beta5 Dave  5th February 2013 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

use of rough.dat removed
nwp_sea now replaced by mainly_sea, derived from landcover fractions


Landuse_ml
   Now uses SEA_LIMIT to set mainly_sea and likely_coastal arrays

Met_ml
   Remove code for rough.dat, use of

ModelConstants_ml
   new param: SEA_LIMIT = (/ 0.2, 0.5 /)

run.pl - no rough.dat



Minor changes (rename, or comment out-often nwp_sea was "use"d but not used)
BLPhysics    - comment out
Boundary_conditions_ml  - rename nwp_sea
CellMet_ml   - rename is_NWPsea to  is_mainlysea, is_allNWPsea to is_allsea
ChemFunctions_ml  - rename nwp_sea
GlobalBCs_ml - comment out
LocalVariables_ml   - rename is_NWPsea to  is_mainlysea, is_allNWPsea to is_allsea
MetFields_ml - remove nwp_sea
SeaSalt  - rename nwp_sea
SoilWater_ml - comment out
SubMet_ml   - rename is_NWPsea to  is_mainlysea, is_allNWPsea to is_allsea
LocalVariables_ml   - rename is_NWPsea to  is_mainlysea, is_allNWPsea to is_allsea


ZD_VBS/My_SOA_ml - changed output format for the Tab SOA line.

xxxxxxxx  rv4.2beta4 Alvaro & Heiko 4rd February 2013 xxxxxxxxxxxxxxxxxxxxxx

Small changes related to eEMEP hourly output and Forecast BC nesting.

NetCDF_ml
  For 3D output compress files, set chunk-size (nf90_def_var_chunking)
  to horizontal slices of 3D fields.
  This would allow to compress output on runs which require
  multi level hourly output, such as Forecast, eEMEP and Transphorm.

ModelConstants_ml
  Always compress NetCDF output

ZCM_Emergency/Mastin*_table3.csv:
  * Rename Mastin files (eEMEP/Erupting volcanoes).
  * Replace special characters (e.g. ) on vent names.

Makefile:
  include *.inc files on *.tar.bz2

Nest_ml,/ZD_OZONE/*_ExternalBICs_ml
  * Move filename_read_3D, filename_read_BC & filename_write back from Nest_ml
    to My_ExternalBICs_ml.
  * Remove if(EXTERNAL_BIC_SET) before call set_extbic as it prevented all calls,
    which are needed for FORECAST runs.
  * subroutine set_extbic (My_ExternalBICs_ml) does no longer update filenames.
  * New soubrotune update_bicname(date) (My_ExternalBICs_ml) updates
    filename_read_3D, filename_read_BC & filename_write according to date,
    following respective template_filenames defined on My_ExternalBICs_ml.
  * Additional call to update_bicname on wrtxn before inquire about
    filename_write existence ensures that BC output can be splitted on
    daily or monthly files.

xxxxxxxx  rv4.2beta3 Dave   31st January 2013 xxxxxxxxxxxxxxxxxxxxxx
(changes currently flagged with JAN2013 and/or SPOD. Will remove
 later)


CHANGES RESULTS:

1)  Unimod.f90, Landuse_ml.f90

    - call to Init_DO3SE moved from Unimod to Landuse_ml, since some
      params are needed for the first call to fPhenology

2) DO3SE_ml  - bug fix on g_sun usage - CHANGES RESULTS

Other:

DO3SE_ml and LocalVariables_ml - added more for access to DO3SE f functions
   (e.g. L%f_env, L%f_sun, etc...)

Rsurface_ml    - L%f_env set, for easier debug info


xxxxxxxx  rv4.2beta2 Peter  30th January 2013 xxxxxxxxxxxxxxxxxxxxxx

KMAX_MID is read from the meteo file. All arrays using KMAX are made allocatable or automatic.
Many files modified:
Setup_1dfields_ml.f90
Chem_ml.f90
MassBudget_ml.f90
Advection_ml.f90
Aqueous_n_WetDep_ml.f90
GlobalBCs_ml.f90
BoundaryConditions_ml.f90
Met_ml.f90
DefPhotolysis_ml.f90
ForestFire_ml.f90
Nest_ml.f90
Sites_ml.f90
GridValues_ml.f90
ModelConstants_ml.f90
GenChem.pl
ZD_VBS/My_SOA_ml.f90

xxxxxxxx  rv4.2beta Peter  29th January 2013 xxxxxxxxxxxxxxxxxxxxxx

More "continuous" function for MARS_ml.f90. NB: Will modify results!
For RATIO (= TNH4/TSO4) between RATIO_Low and RATIO_High, consider the species in two boxes one with
 RATIO_Low and the other with  RATIO_High. Then take a linear combination of the results in each box
(as discussed at meeting 1st Nov 2012)

xxxxxxxx  rv4.1.16 Peter/Svetlana 29th January 2013 xxxxxxxxxxxxxxxxxxxxxx

Bug for  nwp_sea. Array not initialized and only .true. forced. Therefore nwp_sea had a random value when
no rough.dat file was found and not sea.

Changed InitLanduse to force value also when nwp_sea=.false.

xxxxxxxx  rv4.1.15 Birthe 28th January 2013 xxxxxxxxxxxxxxxxxxxxxx

New Pollen.
Pollen_ml : emissions is now gicen in rcemis and NatEmis

ZCM_EmChem09/Pollen.reactions: updated for the new emissions

Makefile.SRCS : included Pollen_ml

xxxxxxxx  rv4.1.14 Peter 28th January 2013  xxxxxxxxxxxxxxxxxxxxxx

Attempt to retablish the original Nest functionality, as documented in header of Nest_ml.f90
For EXTERNAL_BIC_SET=.false. nothing from My_ExternalBICs_ml.f90 is used.
Moved filenames into Nest_ml and call set_extbic only if EXTERNAL_BIC_SET=.true.
Default when EXTERNAL_BIC_SET=.false. is to read/write all components.

Modified: Nest_ml.f90, ZD_OZONE/My_ExternalBICs.ml.f90


xxxxxxxx  rv4.1.13 Alvaro, Agnes & Heiko 25th January 2013  xxxxxxxxxxxxxxxxxxxxxx

Update to eEMEP code. Small bug fixes and add code needed for NPP accidents.

Makefile
  eEMEP target NPP accident locations can be set with enviroment variable NPPAS.
  If NPPAS is not set, the NPP accident locations are kept.

mk.GenChem:
  * Fix bug on seed command for vent name generation, e.g.
      vent code 0103-00- to variable nameV0103A00A
  * Additional options
    -q Quiet mode. No GenChem.pl chatter.
    -N List of NPP accident locations to use on eEMEP runs.

ZCM_Emergency/NPP.*: Add NPP accident files
  NPP.csv         Pre-defined Accident locations
  NPP.species     Nuclear tracers
  NPP.reactions   Decay and emission

ZD_OZONE/My_Derived_ml: Derived output Nuclear accident tracers
  Add commented definitions for surf, dryDep and wetDep daily output.

Volcanos_ml:
  Increase the number of active vents (erupting volcaoes).
  Previous versions could only deal wuth 5 or less vents (bug).

NetCDF_ml:
  Avoid filling out varables on creation by calling
  nf90_set_fill(NF90_NOFILL) from Out_netCDF(create_var_only=.true.)

Nest_ml:
  Runs which write IC/BC files (wrtxn) hang on creation of the file.
  This is because the a "fast" Proc may not find the file, and create it,
  and another will find that the file exist and skip the relevant code.
  Now, the MasterProc inquire if the file exist, and the result is MPI_BCAST
  to the other Procs.

GenChem.pl:
  vatiables @rate_label, @rct, @rcttext defined twice

xxxxxxxx  rv4.1.12 Dave, Svetlana  22th-25th January 2013  xxxxxxxxxxxxxxxxxxxxxx

DS: utils directorty added - a place to store helper programmes

  mk.meteoProc  moved from ZD_EXTRA to utils
  meteoProc.f90 moved from ZD_EXTRA to utils

  Rd_csvsites.f90
  README.Rd_csvsites

ST: Derived_ml.f90: for consistency KMAX_MID is changes to KMAX_BND for

                Kz_m2s(i,j,KMAX_BND-1)

xxxxxxxx  rv4.1.11 Peter     10th January 2013  xxxxxxxxxxxxxxxxxxxxxxxxx

small change in script ZD_EXTRA/mk.meteoPreProc

xxxxxxxx  rv4.1.11 Heiko/Dave     7th January 2013  xxxxxxxxxxxxxxxxxxxxxxxxx

Corrected home of model to MSC-W, not MSC-E in Docs!
(Somebody in the group is confused about who we are maybe?!)

xxxxxxxx  rv4.1.10 Dave, safety   20th December 2012  xxxxxxxxxxxxxxxxxxxxxxxxx

Emissions_ml SEAFIX changed/corrected. Not sure who.

xxxxxxxx  rv4.1.9 Dave           14th December 2012  xxxxxxxxxxxxxxxxxxxxxxxxx

Country_ml - removed need for ModelConstants_ml dependency (was for SEAFIX_GEA)

Emissions_ml - added SEAFIX_GEA here.

xxxxxxxx  rv4.1.8 Alvaro          3rd December 2012  xxxxxxxxxxxxxxxxxxxxxxxxx

DryDep derived output for any group and deposition unit (supported Units_ml).

OwnDataTypes_ml
  * new type typ_si with one string (%name) and one integer (%ind)
  * Align/format & other house keeping

ZD_*/My_Derived_ml:
  * Remove now obsolete variables SOX_INDEX, OXN_INDEX & RDN_INDEX
  * Allow different frecuencies for different DDEP_ECOS
    by using typ_si on definition (Add_MosaicDDEP)

MosaicOutputs_ml:
  * Use different frequencies for different DDEP_ECOS (Add_MosaicDDEP)
  * Remove hard codded Ddep units/index/groups (e.g. mgSm2/SOX_INDEX/DDEP_SOXGROUP)
    from Add_MosaicDDEP
  * Use Units_Scale to calculate unitscale for Ddep of single species (Add_MosaicDDEP).
  * For group Ddep, pre-calculate group indexes and unit conversion for factors
    with Group_Scale, and store them in dryGroupUnits array (Add_MosaicDDEP).
  * Use for different unit conversion factors for each Ddep group member
    on Add_MosaicOutput.
  * Align/format & other house keeping

ModelConstants_ml:
  * Remove now obsolete variables SOX_INDEX, OXN_INDEX & RDN_INDEX

Other changes for FORECAST(MACC)/EMERGENCY(eEMEP) modes

Makefile
  * archive target creates Unimod_YYYYMMDD.tar.bz2 when the model is compiled.
    The archive file contains all sources and scripts
  * MACC target use GFASv1 Forest Fires instead of FINNv1
  * eEMEP target erupting volcanoes can be set with enviroment variable VENTS.
    If VENTS is not set, the default erupting volcanoes are kept.

Nest_ml,ZD_OZONE/IFSMOZ_ExternalBICs_ml,My_ExternalBICs_ml
  * Allow for fractions on IC/BC components, e.g.
    for IFS_EVA_2010 BCs 'OC'*1.7 goes into IXADV_FFIRE_OM

ZCM_EmChem09/BiomassBurning_GFED_to_EmChem09.inc
  * update parameter names & numbers

xxxxxxxx  rv4.1.7 Dave 29th November 2012  xxxxxxxxxxxxxxxxxxxxxxx

Updated Degreeday/HDD system - start of more general pre-processing of met data
Files added in ZD_EXTRA so far, to avoid need for yet another sub-directory.
(Could have used e.g. Aux)

New prog and script here:

ZD_EXTRA/meteoPreProc.f90   added to cvs system
ZD_EXTRA/mk.meteoPreproc    added to cvs system

   The code here does the same job as the old DegreeDayFactors, but is a bit cleaner
   Fixes also an "apparent" problem with i,j coordinates for TNO type lat/lon grids.
   (No difference in model runs, but ncview will now see the data the right way up.)

Also, more safety checks in:

NetCDF_ml.f90
        - to make sure idimID found (catches files with x,y instead of i,j).

Io_Progs_ml.f90  - now calls CheckStop if a "needed" file is missing.

Timefactors_ml.f90 - DegreeDayFactors.nc needed=true  used

xxxxxxxx  rv4.1.6 Alvaro         20th November 2012  xxxxxxxxxxxxxxxxxxxxxxxxx

Small bug fixes and settings for FORECAST(MACC)/EMERGENCY(eEMEP) modes.

GridValues_ml:
  Fix bug introduced on rv4.1.2 (Oct 8, 2012).
  Only simulations on EMEP2010 and EMERGENCY mode were affected.
  Procedure coord_check(lon,lat,fix=.true.) converted longitudes
  from the -180..180 range to 0..360 range. The opposite conversion was required.
  Current version of coord_check converts longitudes to the -180..180 range.

ModelConstants_ml:
  Since rv4rc11 (Sep 13, 2012) USE_DUST and USE_ROADDUST are .true. by default.
  Now they are .false. on FORECAST mode.

Volcanos_ml:
  Reduce DEBUG_EMERGENCY output

ForestFire_ml:
  On FORECAST mode, the forest fire file might not present.
  In which case about 550 warnings are issued every day of simulation.
  Now, Fire_Emis checks if forest fire file exists before attempting to read it.
  In FORECAST mode return it after setting burning=.false.,
  otherwise stop the simulation.

ZD_OZONE/My_Derived_ml:
  Add daily output for ASH groups.
  They will be skipped if the groups are not found.

xxxxxxxx  rv4.1.5 Alvaro         16th November 2012  xxxxxxxxxxxxxxxxxxxxxxxxx

Add 3DVar code to repository:
  ZD_3DVar/My_3DVar_ml.f90
    Link dummy 3DVar module for when NO 3DVar is required.
  ZD_3DVar/Makefile,Makefile.SRCS
    sub-make files for compiling 3DVar programs Unimod_Bnmc and Unimod_3DVar
  ZD_3DVar/DA_ml,B_NMC/*.{f90,F,c},Analysis/*.{f90,F}
    3DVar and Bnmc source files

Makefile,Makefile.SRCS:
  * update stallo module requirements for the new module system
  * rename module checking functions
  * Link dummy 3DVar module (ZD_3DVar/My_3DVar_ml.f90) for Unimod
    compilaton targets, such as EMEP, eEMEP & MACC
  * Add %-Bnmc and %-3DVar compilation targets for
    EXP_Bnmc and EXP_3DVar targets on ZD_3DVar/Makefile which compile
    ZD_3DVar/Unimod_Bnmc and ZD_3DVar/Unimod_3DVar

ModelConstants_ml:
  * add logical parameter ANALYSIS for sich on/off 3DVar

Nest_ml:
  subroutine wrtxn
  * rename allocatable array dat to data
  * allocate data on each call and deallocate after usage
  * remove now unnecessary variable first_call
  subroutine init_nest
  * new logical parameter USE_LAST_HYBRID_LEVELS=.true.
  * check if number of vertical levels on variable and vertical dimension
    matches for hyam/hybm case and:
    * Stop simulation of hyam has less levels than variable.
    * If the variable has less vertical levels than hyam,
      assume that last vertical levels are the correct ones (if USE_LAST_HYBRID_LEVELS).
  * Previously versions assumed the first values of hyam/hybm to be the correct
    ones. The behaviour can be restored by setting USE_LAST_HYBRID_LEVELS=.false.

PhyChem_ml
  * Introruce 3DVar calls before first time step and EndOfDay
  * move call wrtxn (write IC/BC for Nest run) after EndOfDay 3DVar call

Timing_ml
  * 7 additional timing tags (NTIMING=39+7) for 3DVar
  * write timing tags only of they are non empty (Output_timing)

run.pl
  * set TNO emission path on vilje
  * do not re-compile SR or or ARRAY jobs
  * add IC file to RunLog.out
  * CWF Forecast/Analysis modes with different scenario names
  * CWF Analysis runs ZD_3DVar/Unimod_3DVar
  * CWF Forecast options for long runs (more than 10 days)

ZCM_EmChem09/EmChem09base.species
  * NO2 in daObs group

ZD_OZONE/IFSMOZ_ExternalBICs_ml
  * Rename IXADV_FFIRE_OC --> IXADV_FFIRE_OM
  * Set IFS_EVA_2010 BCs%wanted=.false. for OC and OM

ZD_OZONE/My_Outputs_ml
  * change EVA2010 hourly output names to upercase
  * add unique hr_out%name to consistency check

xxxxxxxx    rv4.1.4 Peter/Matthias  12th October 2012  xxxxxxxxxxxxxxxxxxxxxxxxx

Emissions_ml: if(USE_ROADDUST)gridrcroadd0(:,:,:) = 0.0
(if was missing and causes problems with gfortran compiler)

EmisGet_ml: bug in reading file (possibly no error in normal runs, but I didn't check)
emis_kprofile(1:nemis_kprofile,snap) = tmp(1:nemis_kprofile)


xxxxxxxx    rv4.1.3 Dave/Alvaro  9th October 2012  xxxxxxxxxxxxxxxxxxxxxxxxx

Derived_ml - skips PM25X etc if needed species aren't present

Io_ml      - output fmt to es11.3, instead of es11.0 when date-string used
Sites_ml   - gfortran complaint output for sites_  .csv


xxxxxxxx    rv4.1.2 Alvaro 8th October 2012  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


GridValues_ml,Volcanos_ml
  Wrong usage of gi0 and gj0 on the "right processor" check.
  It is likely that the error does not affect the results, as the actual
  coordinate to grid point (lon/lat-->local i,j) calculation was correct.

Makefile
  - New modules in stallo:
    Check for new (after Oct 4 maintenance) modules if directory ~/.lmod.d exists.
    Otherwise the old modules are required.
  - GFASv1 forest fire for MACC targets

xxxxxxxx    rv4.1.1 Dave   3rd October 2012  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Safer coding (tolerates missing species) for:

Setup_1d_ml.f90   (e.g Rn222)

DustProd_ml

Updated:

Sites_ml : gfortran friendly (and anyway easier!) output formatting

ZCM_EmChem09/Biomass...FINN..... - using simpler system introduced for EmChem09soa


xxxxxxxx    rv4.1 Alvaro,Peter, Dave   2nd October 2012  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bugfix: Nest_ml, wrtxn, "dat" declared with save

Dave: BUGFIX: Runchem_ml:   2nd call to setup_bio removed.
                            Results will change

Alvaro/Peter (1st October)
Advection_ml: Change of algoritm; more robust advection.
              NB: The results will show differences.
          The concentrations are "renormalized" (division by p*)
              after each partial advection (x, y or z direction).
              This removes the problems
              caused by emptying an entire gridcell (extreme divergence).
              It has been tested in two cases where the old scheme failed:
          at NorthPole, and a 2km resolution run with extreme winds
              around Jan Mayen (NILU).
          The scheme was also recommended by Alain Clappier to reduce the
              "cross problem" (underestimation of advection in diagonal
              directions)
          There is some CPU penalty for using this scheme.

NetCDF_ml: "Read_Inter_CDF", close at end.
           " CreatenetCDFfile", do not open after created
       stop if fraction and not latlon

Par_ml:    NPROCY=1 (init for runs with very few processors)

Units_ml: umap public

gFortran cleanup:
  - Units_ml, Volcanos_ml, EmisDef_ml
  - update Makefile for MACHINE=hardy & lucid.
    gFortran optiomnization/pedantic options if DEBUG=no/yes

xxxxxxxx  rv4.0.1 rtagged 1st Oct 2012  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Birthe:
DOCS/Manual rewritten for new OS release.

Alvaro 28th/9/2012

Nest_ml:  Bug on init_nest for a IC/BC file on longlat.
  - lon_ext & lat_ext variables where wrongly set.
  - IC and BC longlat files are wrongly interpolated.
  - This bug was introduced on rv4rc5 (Aug 29th 2012).
  - It affects runs FORECAST mode.

xxxxxxxx    rv4.0    18-19th/9/2012  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

(Retagged on 19th after Peter's last changes)

xxxxxxxx    OpenSource Sep 2012 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Setup_1d_ml: Bug when lightning but no aircraft was used
(airn was used but not set). Separated rcemis into two parts.

Setup_1d_ml: extra "if" for runing with debug and burning not defined.

Emissions_ml.f90: allocate airn also if only lightning are used

Volcanoes_ml :missing initialization for io

ForestFire_ml - will die if called with GFED and wrong years

ZCM_EmChem09soa/BiomassBurning-GFED updated to new system

xxxxxxxx   Svetlana/Alvaro/Dave 17/9/2012 xxxxxxxxxxxxxxxxxxxxx

ZCM_EmChem09soa/VBS_nonvolatile.species: PPM25_FIRE group
My_Derived: PPM25_FIRE,
            units change back to ugS/ugN for gases
            commented out intermediate SOA compounds

ZCM_EmChem09soa/BiomassBurning-FINNv1_..... bug fix FFIRE_BC 1.0

ForestFire_ml,ZCM_EmChem09soa/BiomassBurning-GFASv1_.....
  Update for GFAS input

xxxxxxxx  rv4_OSrc1 Dave 16/9/2012 xxxxxxxxxxxxxxxxxxxx


ForestFire_ml:
   simplified considerably. Needs changes in appropriate
   BiomassBurningMapping files. Done for FINNv1 EmChem09soa so far

    Needs to be repeated for other combinations

   Bug cleaned out for FINN, EmChem09soa, which previously had a factr
   1.7 (OM/OC) in both the mapping file and the code.

ZCM_EmChem09soa/VBS_emissions_nonvolatilePOA_FromPM25.reactions
ZCM_EmChem09soa/VBS_nonvolatile.species

   FFIRE_OM replaces FFIRE_OC


More clean-ups/checks, as above. All routines have had basic check

ModelConstants_ml
My_Outputs

    STATUS     -> EMEPSTD   = EMEP standard runs
    STATUS2010 -> EMEP2010 - with Iceland eruption
    TOPO       -> 3DPROFILES


(Note that the latter isn't really an experiment name, just another
output choice, but we can fix that later.)

xxxxxxxx  rv4rc12 Dave/Alvaro/Peter 13/9/2012 xxxxxxxxxxxxxxxxxxxx

Various clean-ups, rcerup and output fixes.

xxxxxxxx  rv4rc11 Dave 13/9/2012 xxxxxxxxxxxxxxxxxxxx

New rc system (almost complete). Aim is to use the rc and rcemis arrays
to cover everything. Also, all "natural" (or meteorology-driven) emissions
should be treated with the same system, storage in EmisNat.

* The arrays rcss, rcroadd, rcpol have been removed. Now we
use rcemis for all. (almost complete)

* The old "rcmisc" chemical rates are now part of the "rc" arrays

These new emissions can also be collected in the EmisNat arrays, needing
no special treatment. This array now covers all emissions which are
driven by meteorology rather than SNAP-codes. Mainly natural (BVOC,
dust, SS) but road-dust also enters here.

Status 13th. The new system works, with trivial changes in
concentrations compared to the old. I still need to fix the units
in the EmisNat arrays. Will do that before public-release - all
EmisNat should be identical in units.

This involved changes in  several routines

Biogenics_ml
   new order of indices in EmisNat
Derived_ml
   new order of indices in EmisNat
Dust_ml
   "old" DU_prod, DUST_flux now removed
   emissions into rcemis
EmisDef
   no need for NSS, QSSFI, QSSCO - all done in SeaSalt_ml
Emissions_mk
   use of rcemis
GenChem.pl
   No rcmisc, rctroe arrays, one fewer module produced
Runchem_ml
   call to setup_rcemis(i,j) now done before SS, dust etc.
   deleted use of rcss, rcwbd, etc.
   road-dust still set here
SeaSalt_ml
   "old" SS_prod removed
   emissions into rcemis
Setup_1d_ml
   removed rc_Rn222, use of Dust, SS, pollen
   removed call to set_rcmisc_rates
Setup_1dfields_ml.f90
   removed call to set_rcmisc_rates
Solver_ml.f90
   removed rcss, ROADDUST, etc,

ZCM_EmChem09/
  Dust.reactions - uses rcbio for dust, e.g.
     rcbio:DUST_WB_F     = DUST_WB_F ;  # Dust
  Isotopes.reactions - uses rcbio for Rn222, e.g.
  SeaSalt.reactions  - uses rcbio for SEASALT

Alvaro 13 Sep:

Solver_ml,Setup_1d_ml,Setup_1d_ml,
ZCM_Emergency/ASH_2bin.reactions,ASH_7bin.reactions
  - remove rcerup, use rcbio instead

xxxxxxxx  rv4rc10 12Sep/2012  xxxxxxxxxxxxxxxxxxxxxxx

Alvaro 12-13 Sep

Makefile:
  Patch from Viel for `make module`.

ModelConstants_ml, Output_hourly:
  For hourly splitted files (see HOURLYFILE_ending in ModelConstants_ml),
  avoid writing different years on the same file.
  - Restore single hourly file as defaul (ModelConstants_ml).
  - Create NetCDF variables only if the file is newly created

GenChem.pl: get rid of one "Use of uninitialized value" perl warning
  that escaped rv4rc9

Dave 9-12th:
Just cleaning up a little so far. Not rtagged

xxxxxxxx  rv4rc9    Peter    7 Sep/2012  xxxxxxxxxxxxxxxxxxxxxxx

Met_ml: can make 3D cloudcover from cloudwater
GridValues_ml: support for rotated spherical projection in lb2ij
Emissions_ml: natso2 (DMS) not needed
ModelConstants_ml:defined CW2CC = 1.0E6

clean up of output: ModelConstants_ml, EmisGet_ml, DryDep_ml, Met_ml

Alvaro: small bug fixes & eEMEP code requirements

GenChem.pl: get rid of all "Use of uninitialized value" perl warnings

Aqueous_n_WetDep_ml: mass balance bug fix
  Re-implement balance bug fix from rv4beta22.
  Bug was re-introduced on rv4rc3.

ZD_OZONE/My_Outputs_ml.f90: fix bug on consistency check.
  The bug was introduced on rv4rc8 and caused to treat
  hourly definitions with %spec==0 as undefined.

Makefile: compile eEMEP target with GenChem-EmChem09soa
  as GenChem-Emergency (strip down version) is not yet ready

Output_hourly: in FORECAST mode,
  write a .msg file at the after a hourly set is finished.
  The .msg file has the same basename as the hourly file.
  This will be used my the FORECAST user running eEMEP,
  together with HOURLYFILE_ending="+FFF.nc" (one file per forecast hour),
  to signal that the hourly file is complete and ready for download.

TimeDate_ExtraUtil_ml: add support for forecast step on date2string ('FFF' tag).

xxxxxxxx  rv4rc8    Alvaro    6 Sep/2012  xxxxxxxxxxxxxxxxxxxxxxx

Experiment Name (EXP_NAME) to select different configurations
of USE_* flags, hourly output and external BC (on Forecast mode).

Cleanup hourly output code. Remove Hourly_ASCII option.
Improve options for splitting hourly files.

ModelConstants_ml,ZD_OZONE/IFSMOZ_ExternalBICs_ml,My_Outputs_ml
  - USE_FOREST_FIRES as default. New to FORECAST mode.
  - Introduce Experiment Name (EXP_NAME) in ModelConstants_ml,
    to select different configurations:
    - USE_* flags (ModelConstants_ml)
    - hourly output (My_Outputs_ml)
    - BC version on Forecast mode (IFSMOZ_ExternalBICs_ml)

Output_hourly,ZD_OZONE/My_Outputs_ml,OwnDataTypes_ml,ModelConstants_ml
  - Remove ASCII hourly output code:
    - ASCII hourly output code (Output_hourly).
    - Hourly_ASCII variable (My_Outputs_ml)
    - ASCII output format (ofmt) element on Asc2D type definition (OwnDataTypes_ml)
  - Improve options for splitting hourly files:
    - Replace logical variables DAILY_HOURLYFILE, MONTHLY_HOURLYFILE
      by string variable HOURLYFILE_ending  (ModelConstants_ml).
    - Use function date2string (TimeDate_ExtraUtil_ml)
      to recreate the hourly file name (fileName_hour; NetCDF_ml).
      If the file name is changed, a new hourly file is created (Output_hourly).
    - Call Out_netCDF(create_var_only=.true.) to write all variable definitions
      at once, hourly data is added later (Output_hourly).

NestCDF_ml
  - Add support for "hours since" time units in ReadTimeCDF
  - replace (me==0) by MasterProc
  - rewrite subroutine CloseNetCDF

TimeDate_ExtraUtil_ml
  - Add support for "day of the year" on date2string ('JJJ' keyword).
  - Add to int arrays of size 6 as date format.
    It assumes (/year,month,day,hour,minute,second/) format.

Units_ml
  - Add support for mix_ratio unit:
      umap("mix_ratio","mol/mol",1.0),&  ! Internal model unit
  - Units_Scale also recongizes "mole mole-1" & "mixratio" as "mix_ratio"

Unimod.f90
  - Do not create hourly output file. This is now done on Output_hourly
  - Use date2string to write current date and time messages

Makefile:
  - Target MACC-EVA2010 uses GFASv1 ForestFire
  - Update compiler & netCDF library versions on stallo & vilje.
    Use netcdf/4.1.3 for hourly split files to work,
    as required on a ModelConstants_ml comment.
    Intel compiler and MPI modules updated to match netcdf/4.1.3 requirements.
  - Use on environment variable (vilje:$NETCDF_PREFIX, stallo:$NETCDF_ROOT)
    on INCL and LLIB paths. NETCDF_PREFIX/ROOT is set by mode load netcdf/version.
    Module netcdf/4.1.3 must be loaded for make run.
  - I suggest the following lines to be added to the ~/.bashrc
    stallo:
      export MACHINE=stallo
      module load intel-compiler/12.1.2 openmpi/1.4.4 netcdf/4.1.3
    vilje:
      export MACHINE=vilje
      module load intelcomp/12.0.5.220 mpt/2.06 netcdf/4.1.3

xxxxxxxx  rv4rc7    Peter     5 Sep/2012  xxxxxxxxxxxxxxxxxxxxxxx

Small changes only
Met_ml: replaced some hardcoded 10800 with 3600*METSTEP
Aqueous_n_WetDep_ml.f90: added some comments

run.pl: PBS command for Vilje
TimeDate_ExtraUtils_ml, days1900_to_int correct for rounding errors

xxxxxxxx  rv4rc6    Alvaro    3 Sep/2012  xxxxxxxxxxxxxxxxxxxxxxx

New ForestFire type: GFASv1

ForestFire_ml,run.pl
  ZCM_EmChem09soa/BiomassBurning_GFASv1_to_EmChem09soa.inc
  - New ForestFire type GFASv1 (BiomassBurning_GFASv1_to_EmChem09soa.inc)
  - Clean up ForestFire_ml

xxxxxxxx  rv4rc5      28-31Aug/2012  xxxxxxxxxxxxxxxxxxxxxxx

Peter: 31/8/2012
Aqueous_n_WetDep_ml.f90
(Note: Only Aqueous changes usedin TSAP SR runs)

In setup_aqurates concentrations were calculated from pH then pH from concentrations.
A loop with fixed number (5) of iteration was doing this. In the original code nothing ensured convergence; i.e we could have for instance pH=4 in first iteration, pH=5.6 second iteration, then pH=3.7, pH=6.1, and pH= 3.5 at the last iteration. This is unstable, meaning that small change in start value can give large changes in end values.
The solution adopted is to take only 2 "iterations" (pH give concentration and then concentration give pH). A proper linear combination of the 2 values are taken. "proper" meaning correct to second order. In practice for good situations (smooth variations), the solution is very close to the self-consistent value, for difficult situations, the value is in the right direction, but not exactely equal to the self-consistent solution.
Still, since the method is not really iterative, the solution is stable.


Svetlana: 31/8/2012
GlobalBCs_ml: Saharan BCs are divided by 2, as molecular weight for dust
was increasd from 100 to 200 g/cm3

Dave:
ChemFunctions_ml - corrected comments. Refs to ACP paper
run.pl - re-instate CS=>51 which had fallen out

Alvaro: 29/8/2012
Nest_ml,ZD_OZONE/IFSMOZ_ExternalBICs_ml,My_ExternalBICs_ml
  - Mutliple External BC definitions will result in added BCs.
    This feature was missing on previous module versions.
  - New BC type EVA2010 available for Forecast mode (IFSMOZ_ExternalBICs_ml).
    Previous default (IFS_MOZ_fkya) was kept.

run.pl
  - small change on forecast met version ($CWFMETV)

xxxxxxxx rv4rc4 Peter   22/8/2012  xxxxxxxxxxxxxxxxxxxxxxx

Bug in BLPhysics_ml.f90/JericevicRiB_Hmix0. The indices for u and v where shifted by 4 (i.e. taking the wind from higher altitude)
This will modify results.

Experimental:
Possibility to get emissions for any grid (over Europe), based on fine resolution TNO7 emissions.
put CDF_emis=.true.
The Emis_TNO7.nc file contains:
total emission for each gridcell, each component, each sector,
the fraction of each gridcell assigned to each country code,
the corresponding country code and
the number of fractions defined for each gridcell

modified Emissions_ml.f90 (NetCDF_ml.f90)

xxxxxxxx rv4rc3 Peter, Dave  13/8/2012  xxxxxxxxxxxxxxxxxxxxxxx

Instability in the solver for aqueous chemistry. Gave a lot of
noise in the SR differences.

Aqueous_n_WetDep_ml.f90


xxxxxxxx rv4rc2 Peter  10/8/2012  xxxxxxxxxxxxxxxxxxxxxxx

Cubic equation solver from MARS_ml had only 7 digit precision.
Affects results slightly.

Note that there is still some instability somewhere, producing random
fluctuations (SIA), particularly for fine scales.


xxxxxxxx rv4rc1 Peter  3/8/2012  xxxxxxxxxxxxxxxxxxxxxxx

Dynamical allocation of the grid sizes:
IIFULLDOMAIN, JJFULLDOMAIN, RUNDOMAIN
and the processors partitionning:
NPROC, NPROCX, NPROCY

All routines with arrays, MAXLIMAX,MAXLJMAX changed:
AOD_PM_ml.f90 Advection_ml.f90 AirEmis_ml.f90 Biogenics_ml.f90 Chem_ml.f90 CoDep_ml.f90 Derived_ml.f90 DryDep_ml.f90 DustProd_ml.f90 EcoSystem_ml.f90 EmisGet_ml.f90 Emissions_ml.f90 ForestFire_ml.f90 GlobalBCs_ml.f90 GridValues_ml.f90 Landuse_ml.f90 MetFields_ml.f90 Met_ml.f90 ModelConstants_ml.f90 Nest_ml.f90 NetCDF_ml.f90 Par_ml.f90 PhyChem_ml.f90 Pollen_ml.f90 ReadField_ml.f90 Rsurface_ml.f90 Runchem_ml.f90 SeaSalt_ml.f90 Sites_ml.f90  SoilWater_ml.f90 Solver.f90 Timefactors_ml.f90 Unimod.f90 ZD_OZONE/My_Outputs_ml.f90 ZD_VBS/My_SOA_ml.f90 run.pl

It is no more necessary to define the grid which is used. The grid is read from the metfile.
Also the rundomain is by default set as = fulldomain, but can still be set in ModelConstants_ml.
In future will be read in from a namelist.
To change grid it is sufficient to change $GRID in run.pl.



The reading of the gridparameters is done in GridValues_ml (was in Met_ml before).

A few small bugs corrected:
1)In Runchem setup_rcemis was called before SeaSalt_flux, WindDust and  Pollen_flux, so that the emissions ( SS_prod,DU_prod, Pollen_prod) where the old ones, or not defined at the first step.
2)In Pollen_ml the variables did not have the save attribute.
3)In Rsurface there is a L%SAI > SMALLSAI, but SAI and LAI where not set/initialized for bulk.


   Dave:  1/8/2012  xxxxxxxxxxxxxxxxxxxxxxx

   just removed case SOILNO from Derived_ml. Was some old
   test I think.

xxxxxxxx rv4beta22 Peter 18/7/2012  xxxxxxxxxxxxxxxxxxxxxxx
           (+ small clean-ups from Dave)
            ongoing - so not rtagged yet

New RoadDust whith grid independent input. Does not give exactly the same results as the old scheme because
the defintion of climatefactors is different.

The scheme is rather new, and is also a test for a general scheme that can be used for all gridXXX emissions.
Emissions as stored in a netcdf file with: total per gridcells, and fractions assigned to countries.

Modified:
NetCDF_ml.f90
Emissions_ml.f90
run.pl

Dave  18 July, comparing with EnsClim2 code
Aqueous_ml            - small tidy up
BoundaryConditions_ml - small tidy up
DryDep_ml             - small tidy up

Alvaro: 20/07/2012
  Makefile*,run.pl: Only one makefile with all config for any machine.
    - Use variable MACHINE in Makefile to decide which configuration to use, e.g.
      make MACHINE=stallo instead of make -f Makefile_stallo.
      For convenience, MACHINE can be set once as:
        export MACHINE=stallo # on command line or ~/.bashrc
      and all subsequent calls to make (e.g. make EMEP) will use the corresponding
      machine configuration
    - All machine specific makefiles, such as Makefile_stallo & Makefile_titan,
      have been removed from CVS.
    - New specific model target MACC-EVA2010 (Makefile)
    - Use make MACHINE=stallo instead of make -f Makefile_stallo (run.pl)

Alvaro: 23/07/2012
  Aqueous_n_WetDep_ml: Budget WetDep for all SPCS
    - Fix bug introduced on rv4beta20 mass-budget calculation:
      - From rv4beta20 only SPEC which about was required (My_Derived)
        were budgeted.
      - Previous versions, WetDep budget was based on SOX, OXN & RDN group output.
        As WetDep for this groups was always required, the budget was complete.
    - Now WetDep is budgeted for all SPCS, independent of WetDep output requirements.

Alvaro: 24/07/2012
  MassBudget_ml - tidy up
  run.pl        - eEMEP setup for Forecast user in ve
                - Clean-up Benchmark definitions
                - Clean-up SR code for ve

xxxxxxxx rv4beta21 Dave 16-18/7/2012  xxxxxxxxxxxxxxxxxxxxxxx


run.pl changed for emissplit files:

    script looks for emissplit.$Specials.xxx in $timeseries directory
    first, thus can set $Specials = "TSAP_Jul2012" to get files
    for TSAP re-runs. (This one also needs iyr_trend to be set of
    course, corresponding to SR runs.)

    Still, be careful with emissplit files! System is confusing:-(

BoundaryConditions_ml - replaced print with write to aid debugging

xxxxxxxx still  rv4beta20 Peter      15/7/2012  xxxxxxxxxxxxxxxxxxxxxxx

ZD_SR/My_Derived with T2m without SS

xxxxxxxx rv4beta20 Alvaro      13/7/2012  xxxxxxxxxxxxxxxxxxxxxxx

New features:
  - WDEP/GROUP output can be produced for groups with elements
    with %nitrogens/=1 in mgN or %sulphurs/=1 in mgS.
  - WDEP/GROUP output in mg, mgC and mBq (radioactive exposure).
  - WDEP is restricted to ADV species. No WDEP is allowed for SHL species.
    Note that, this was already the case for DDEP.

Aqueous_n_WetDep_ml,Derived_ml:
  Wrong WDEP/SPEC output. Bug introcuded in rv4beta14.
  Was not corrected in rv4beta16, as My_Derived_ml contains no WDEP/SPEC output.
  - Molecular wheight was accounted twice, in Define_Derived
    (Derived_ml via Units_Scale) and in Init_WetDep (Aqueous_n_WetDep_ml)
  - Remove hard codded molecular weights in Init_WetDep (Aqueous_n_WetDep_ml)
  - Units conversions for WDEP/SPEC output are handeled exclusively
    by Units_Scale (in Derived_ml.Define_Derived).
  - Units conversions for WDEP/GROUP output are handeled exclusively
    by Group_Units (in Aqueous_n_WetDep_ml.WetDep_Budget).
  - Use only the SPEC/GROUP number defined in Define_Derived (Derived_ml),
    and refer to f_2d(if2)%index in Init_WetDep & WetDep_Budget.
    Thus, eliminating the need for typ_i3 arrays tmpgroup & tmpspec.

ZD_*/My_Derived_ml:
  - WDEP specific units mgSS and mgP(?) are now obselete.
    They are replaced with mg in ZD_*/My_Derived_ml.
  - Add SO2 and HNO3 to WDEP/SPEC output in ZD_OZONE/My_Derived_ml
    New Benchmarks for rv4beta14 & rv4beta16 contain this additional output.

Units_ml:
  Wrong unit text for mg, mgC, mgN & mgS. Bug introcuded in rv4beta14.
  - Units written for WDEP Derived outputs were mg*/m3 instead of mg*/m2.

GenChem,MassBudget_ml,Aqueous_n_WetDep_ml,Derived_ml:
  Limit WetDep to ADV species
  - WetDep mapping uses IXADV_"SPEC" (GenChem)
  - Restrict wdeploss & ddeploss (currently not used) to NSPEC_ADV (MassBudget_ml)
  - Use IXADV indexes in AddNewDeriv (Derived_ml) for WDEP_WANTED,
    and assume f_2d(if2)%index an IXADV in Init_WetDep & WetDep_Budget (Aqueous_n_WetDep_ml)
  - totWdep is no longer calculated for hard coded groups (only SOX, OXN & RDN).
    It is assigned to the IXADV indexes in WetDep_Budget (Aqueous_n_WetDep_ml),
    just as totDdep is assigned in drydep (DryDep_ml).

Aqueous_n_WetDep_ml,Units_ml:
 Store group IXADV and unit conversion factors in special type
 - type group_umap(name,iadv,uconv) for group index & conversion factors (Units_ml).
 - function Group_Scale, based on subroutine Group_Units,
   provides group_umap output (Units_ml).
 - store wetGroupUnits in Init_WetDep for later reference in WetDep_Budget (Aqueous_n_WetDep_ml)

xxxxxxxx rv4beta19 Dave/Agnes  13/7/2012  xxxxxxxxxxxxxxxxxxxxxxx

Country_ml   - correction for CS

Sites_ml.f90 - sets "NOT FOUND" d_2d species to -999

ZD_SR/My_Derived_ml - extra params as requested by Agnes/Chris

xxxxxxxx rv4beta18 Dave         5/7/2012  xxxxxxxxxxxxxxxxxxxxxxx

MARS_ml - more safety checks added.

My_Aerosols_ml - more safety checks whe DEBUG_EUIB = true.


xxxxxxxx rv4beta17 Dave Peter   4/7/2012  xxxxxxxxxxxxxxxxxxxxxxx

(not tested)

Bug in MARS_ml.
A case what not taken into account, giving negative or meaningless concentrations.
The casae where two roots are negative is now taken into account (by taking the same values as when the roots are complex).
Also a few "min(YNH4 * MWNH4, TMASSNH3)" have been added, as these could give negative values.

For later reference, the following input values were giving wrong results:
so4in= 9.469145296322812E-008
hno3in=1.575623936674725E-002
no3in=6.964374931256713E-012
nh3in=2.877165942842792E-008
nh4in=1.927434239142973E-009
rh=1.00000000000000
rh=0.99000000000000
temp=263.068584647992


xxxxxxxx rv4beta16 Alvaro    27,29/6/2012  xxxxxxxxxxxxxxxxxxxxxxx

  Units_ml,Derived_ml (27/6/2012): Fix bug introduced on rv4beta15
    Before rv4beta15 Units_Scale (Derived_ml) provided ug/m3 conversion
    for all species. The current version of Units_Scale (Units_ml) provides
    unit conversion factors only for advected species.
     - Units_Scale calls in Derived_ml have been modified to take iadv instead of itot
     - Units_Scale will Stop if iadv is out of range.

  Derived_ml (29/6/2012): Fix bug introduced on rv4beta15
    Fix from (27/6/2012) solved the problem only for SPCS output,
    GROUP output was still wrong.
    - uggroup_calc calc gets the unit conversion factor from Group_Units (Units_ml)
    - Avoid hard codded molwt by introducing aux variables, such as
      ug_NO3_C=Units_Scale('ug', iadv_NO3_C)
    - Use d_2d(ind_pmwater,i,j,IOU_INST) instead of PM25_water_rh50(i,j)*ATWAIR/PPBINV
      for PM25_rh50, PM25X_rh50 and PM10_rh50 output types

  Output_hourly:
    - Add Z_MID hourly output type
    - Align/format & other house keeping
    - (29/6/2012) Initialize group index/conversion pointers =>null()

  ZD_OZONE/My_Outputs_ml:
    - Add Z_MID and Volcano (vent) column hourly output on Emergency-Forecast mode

  GenChem.pl (ChemChemicals_ml), Units_ml, Derived_ml:
    - Define species_adv and species_shl in ChemChemicals_ml
      as pointers to species short lived and advected portions.
    - species_adv is now used in Units_ml and Derived_ml as a short hand to
      species(NSPEC_SHL+1:NSPEC_SHL+NSPEC_ADV)

  Derived_ml:
    - Avoid hard codded IXADV_"SPC" by introducing aux variables, such as
      iadv_O3=find_index('O3',species_adv(:)%name)

  run.pl:
    - define $skipHDD
    - $MAKEMODE for $SR
    - Options for $VILJE for $EruptionDir, $WORKDIR and $CWFDUMPDIR

  Functions_ml:
    - great_circle_distance is now a PURE function

  Nest_ml:
    - Change debug output format F4.2 to F5.2 to avoid compilation warning

xxxxxxxx rv4beta15 Dave,Alvaro  20/6/2012  xxxxxxxxxxxxxxxxxxxxxxx

  Dave:
  run.pl
     skipHDD introduced to avoid HDD files for some runs
     metdata_EC used by default for global

  Alvaro:
  Units_ml,Makefile.SRCS,Derived_ml,My_Outputs_ml,Output_hourly
    - New module Units_ml gathers routines and variables dealing
      with units convertions formerly scattered between Output_hourly and Derived_ml
    - Function Units_Scale (formerly Derived_ml sunbroutine).
    - Unit concertion varaibles (formerly My_Outputs_ml):
        to_molec_cm3,to_molec_cm2,to_mgSIA,to_ugSIA,&
        to_ug_ADV,to_ug_C,to_ug_N,to_ug_S
    - Subroutine Group_Units replaces group_setup on Output_hourly.

  Output_hourly
    - Alingn/format & other house keeping

xxxxxxxx rv4beta14 Alvaro & Birthe 11,13-15/6/2012 xxxxxxxxxxxxxxxxxxxxxxxx

eEMEP update

Volcanos_ml:
  - Fix MPI bug on reading eruption.csv
  - Change default VAAC splits for 2bin mode.

run.pl:
  - Official eruoption emissions for 2010 Eyjafjll eruption
  - SOx & PMx reduced files for 2010 Eyjafjll eruption (SR-VOL run)

Makefile_vilje:
  - Add model specific targets (EMEP / MACC / eEMEP)

Makefile,Makefile_stallo,Makefile_vilje (13-15th June):
  - Fix for recursive make. Use -f $(firstword $(MAKEFILE_LIST))
    in $(MAKE) recursive calls (for EMEP/MACC/eEMEP targets)
    to ensure that right Makefile is used.
  - Fix for SR-EMEP2010 target. Wrong My_Derived_ml.f90 was used,
    creating inecesary output. Now it links ./ZD_SR/My_Derived_ml.f90.
  - Re-organize EMEP/MACC/eEMEP targets
  - Add eEMEP2010 target for evaluation of the model.

ZD_OZONE/IFSMOZ_ExternalBICs_ml.f90 (15th June):
  - Add integer,save, public :: iw=-1, ie=-1, js=-1, jn=-1, kt=-1,
    as in rv4beta13 for My_ExternalBICs_ml.f90

xxxxxxxx rv4beta13 in-progress   6/6/2012 xxxxxxxxxxxxxxxxxxxxxxxx

run.pl: change of link for 5yr annual N dep to AnnualNdep_PS50x_EECCA2005_2009.nc (5 year average 2005-2009 run for EECCA with PS50 for 2005-2009)
  (now hand-edited and re-created with ncgen)

run.pl - emissplit for emepdefaults corrected

Nest_ml ed MasterProc to PrintLog call

Makefile (ZD_SR) changes copied to Makefile_stallo (pending better
  system)

xxxxxxxx rv4beta3 Dave/Peter   23/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

21:05 corrected (iyr_trend) to (iyr_trend-2000)

BoundaryConditions_ml

  CH4 BICs updated for 2010 and later

ModelConstants_ml and My_RunSettings.inc

** New ** file RunSettings.inc, in ZD_SR and ZD_OZONE.
Has just one line, e.g.

 cat ZD_SR/My_RunSettings.inc
  logical, save, public :: SOURCE_RECEPTOR = .true.

Makefile now calls the appropriate one, on doing

  make EMEP or make SR-EMEP




xxxxxxxx rv4beta2 Dave, Svetlana   23/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

PM25_rh50 and similar added to Derived_ml
  and ZD_SR, ZD_OZONE My_Derived_ml

Notation change for SOA/OM species: _C changed to _OC:
  ZCM_vbs_tests/VBS_help.species
  ZD_VBS/My_SOA_ml.f90

Also OMCOARSE added as group in

   ZCM_vbs_tests/VBS_nonvolatile.species

  Not strictly needed, as it is POM_c_FFUEL, but it is easier to
  explain to IIASA (and to remember ourselves) ;-)

ZCM_EmChem09soa/VBS_Nonvolatile.species - added ECcoarse group
ZD_SR/My_Derived_ml Added extra Eocystem outputs, and ECcoarse

Many outputs in ZD_SR/My_Derived commented out.

xxxxxxxx rv4betaSR  Dave      23/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

ZD_SR directory added
ZD_SR/My_Derived_ml added for SR work

Makefile modified for SR-EMEP target
  (type make SR-EMEP to get the new Derived values)

Explanationsat top of this file improved

xxxxxxxx rv4beta    Dave      22/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

*** THIS FILE HAS been committed while benchmark is in progress,
given the urgency of the TNO28 SR runs. Should be okay, but be
warned.

Please - do not CVS stuff at this stage without discussing with
Dave, since these SR runs are important and we don't want the
code to change much until they are finalised.
*****

Changes:

Dp = 3 for NO3_c (instead of 2.5)

EmisHeights.txt has 100% of SNAP2 emissions in lowest layer

("Older" (1-2 days old!) code linked to EmisHeights_rv3_9.txt)

Derived_ml, My_Derived_mk: PM25 and PM25X added. Adds a fraction
   (fracPM25) of the coarse aerosol to PMFINE. Very hard-coded for now,
    but easy to generalise later.)

     PM25  has f* NO3_c
     PM25X has f* (NO3_c + coarse EC + coarse POM)

     where f is 0.27 for Dp=3um.

run.pl:

For 2020 runs  use the 5-year N-deposition climatology from Agnes,
TNO28. Use the same file for all resolutions, otherwise there is too
much work involved to generate this.


xxxxxxxx rv3_15_2   Dave      22/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx


EmisDef_ml - VERTFAC code removed :-)

EmisGet_ml - EmisHeighs routine added to read in EmisHeights.txt file
  and set nemis_kprofile, emis_kprofile
   (the latter is allocatable, deduced from EmisHeights.txt)

Emissions_ml - use of emis_kprofile

run.pl - copies input_emepdefaults/EmisHeights_v3_9.txt to EmisHeights.txt
(INERIS option not set yet, will follow shortly)

xxxxxxxx rv3_15_1   Peter     21/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

"HIGHWAYplus" and "NONHIGHWAY" were exchanged in run.pl for tno7 and tno56
No effect except in title of outputs, since they are treated identically for now

xxxxxxxx rv3_15   Dave     20/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

  Submission of emission work.

    Hourly and HDD emissions variation clean-up. Now just read these
    from file linked through run.pl. If you want the old day/night from
    EMEP use file HourlyFacs.EMEP2003, but the best system is probably
    HourlyFacs.INERIS.

  Input/timeseries directories:

     Default EMEP and INERIS/EUROLDELTA use different files for
     various timeseries directories.  Created (in $DataDir):

       inputs_emepdefault_May2012
       inputs_eurodelta_May2012

     Choose which on in run.pl with INERIS_FACS.


  Emissions and changes:

     (i) Heating degree-day (HDD) system improved to now use simpler
     float-based HDD values. Can switch between "INERIS" and
     "EMEP" style, with INERIS_SNAP2, see comments in rv3_14_5 log.


      (The HDDxx files needed for this are currently in Dave's
       directory /home/mifads/Work/D_Emis/DegreeDay on stallo.
       These files can be generated for any meteo (I think) by
       running the code DegreeDayFactors in that directory. Run with
       -h to get options. These shouldn't be needed with default
       ModelConstants though.)


     (ii) New ourly system introduced, to use the 11x7x24
     EuroDelta HOURLY_FACS file. Should be new default. New
     system can restore older defaults using files from
     $timeseries directory.
     Arrays read from file and  stored in fac_hh24x7.

     (iii) INERIS_SNAP1 switches off the SNAP-1 year
     correction. Default false


  ModelConstants_ml - various HOURLY  settins removed. We should
   have hourly emissions as default ;-)
   Added INERIS_SNAP1, INERIS_SNAP2

  EmisDef_ml     - removed SNAP_HOURFAC (values can be obtained through
    new system with HourlyFacs.TNO2005 in run.pl)


  Emissions_ml   -

    Consistent use of hourly and degree-day data for time-factor tfac

    Better accounting for change of days with longitude:

     bug-fix for areas far from CET:
      replace: if( hour_iland > 24 ) hour_iland = 1 !DSA12
      with   : if( hour_iland > 24 ) hour_iland = hour_iland -24

     also wday (1=Monday etc) changed for local time (wday_loc)



   Timeseries_ml

     (i) Used GetCDF for HDD factors
     (ii) Added read of HOURLY-FACS into fac_hh24x7.

   Old Degree-day (with scaling-factors) code removed.
   DAY_NIGHT and day_factor code removed

   run.pl : added $INERIS_FACS, HDD stuff, new $timeseries for
    TNO and INERIS/EURODELTA3. Cleaned out old EUCAARI settings
    Note, need to specify Tbase 18 or 20 for HDD facs

  Other changes:

  Io_Progs fname added in debug output

  Met_ml - add call_msg txt, which can be used to pass messages
     to "check" subtroutine. Helps to find out which file is
     causing problems.

  Par_ml - add MSG_READ 88 (probably not needed?)



xxxxxxxx rv3_14_9 Dave     18/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

   Preliminary version of rv3_15 above, some problems found

xxxxxxxx rv3_14_8 Peter    18/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

Bug in RoadDust index:  hour_iland could be 0, while arrays start at 1.

xxxxxxxx rv3_14_7 Peter    16/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

Bug in country total output (only printouts, model results are correct)
EmisGet_ml.f90

xxxxxxxx rv3_14_6 Peter    16/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

Met_ml.f90: Model stops if meteo file is not found (it did not before!)

run.pl:
#make results readable for others:
#PBS -W umask=0022
new links for RoadDir

xxxxxxxx rv3_14_5     14/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

Alvaro  14/5/2012:
Makefile,Makefile_stallo
  - commented MODULE check before compilation for netcdf/4.1.1
  - include .depend only when compiling a specific object (*.o)
    or when linking the full program (all or Unimod or '').

Dave  13/5/2012:

Emissions_ml   - if INERIS_FACS=.true. uses a degree-day
   method  similar to Bertrand's HDD. This avoids the minumum
   method DS had introduced - putting more emission into
   winter. Methodology uses Dave's 18C Tbase, not yet
   Betrand's 20C. Will sort out later as part of DegreeDay
   file cleanup

ModelConstants_ml - INERIS_FACS added for Bertrand's HDD method
                    TNO/TFMM domnain defintions added

Log.changes - tidy up and exlanation at top updated

run.pl      - small extra debug info

xxxxxxxx rv3_14_4  Alvaro 8/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

eEMEP update:
* Include Volcanic ASH components into PM groups.
* 2 and 7 bin configuration for Volcanic Ash tracers.
* Handling of special characters in ZCM_Emergency/Mastin&al2009a_table3.csv.

Other:
* Allow usage of Volcanic eruption tracers from Emergency under EmChem09 and EmChem09soa.
* Specify make target and chem mechanism in Benchmark run definition.

Makefile, Makefile_stallo:
  - specify number of bins for eEMEP volcanoes (-V 7bin,Vesuvius,...)
  - use Kr.suv.k instead of Krsuvk in mk.GenChem call for eEMEP target
  - specific targets for 2010 run (EMEP2010 and SR-EMEP2010)
    with Eyjafjll volcano tracers from Emergency (-V 2bin,Eyjafj.ll)

mk.GenChem:
  - Allow -V volc option for -e EmChem09 and EmChem09soa
  - use _ASH_ as keyword for variable name in sed replacement
  - remove ISO_8859-1/UTF-8 encoding changes
  - Use capital letters on variable names for volcanic ash tracers
  - 2bin and 7bin versions for of volcanoe tracers
  - Mastin&al2009b defaults for volcano eruption

run.pl
  - New variable $MAKEMODE for specific make target, e.g. make EMEP2010.
    Replaces FORECAST specific CWFMODE. Default benchmark target is make EMEP.
  - EMEP2010 Benchmark with explicit make target ($BENCHMARK{'make'}="EMEP2010")
    and chem mechanism ($BENCHMARK{'chem'}="EmChem09soa").
    Note that pre-set compilation targets (e.g. EMEP, MACC. eEMEP) have pre-defined
    chem mechanisms. Therefore, $BENCHMARK{'chem'} most be consistent with
    $BENCHMARK{'make'}, when both hash keys are used.
  - Deal with volcanic eruption files for eEMEP and EMEP2010 runs.
    Link volcanoes.csv and copy eruptions.csv, files created from Mastin&al2009a,b by mk.GenChem,
    to working directory. Extend eruptions.csv with specific eruption details found in $EruptionDir

ZCM_Emergency/ASH*.species,ASH*.reactions
  - Include Volcanic ASH components into PM groups
  - Encapsulate _ASH_ for mk.GenChem sed replacement
  - 2bin and 7bin versions ASH_?bin.species,ASH_?bin.reactions
  - Add ASH tracers to AOD calculations. Extinction/Mass efficiency as Dust.

ZCM_Emergency/Mastin&al2009a_table3.csv,Mastin&al2009b_table3.csv:
  - Change encoding to UTF-8 (iconv -fISO_8859-1 -tUTF-8)
  - Add Mastin&al2009b defaults for volcano eruption

Setup_1dfields_ml, Setup_1d_ml, Solver, ZCM_Emergency/ASH*.reactions
  - Rename rcash to rcerup, as it can also include SO2 emissions from volcanic eruptions
  - Load volcanic emissions (Setup_1d_ml) if USE_EMERGENCY (ModelConstants_ml)

xxxxxxxx rv3_14_3  Agnes 7/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

New Mace Head data for 2010 added in GlobalBSs_ml.f90
The "default" averages are also recalculated including 2010
(for the 13 years period of 1998-2010).



xxxxxxxx rv3_14_2  Peter 4/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx
                   Robert 3/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

small change in run.pl for SR runs on Ve. This gives one run per job on Ve.

  @runs = ($runs[$ENV{'PBS_ARRAY_INDEX'}-1]) if $ENV{'PBS_ARRAY_INDEX'};   # PBS Pro, Ve, one run per job


No real update, just added the two road dust components DUST_ROAD_F and DUST_ROAD_C
in ZD_OZONE/My_Derived_ml.f90 (as comment lines, so the executable should be identical to the 3_14_1)

xxxxxxxx rv3_14_1  Peter 2/5/2012 xxxxxxxxxxxxxxxxxxxxxxxx

run.pl more compatible with Ve/Vilje. Removed references to Njord.
Added Makefile_vilje
commented out by default:
$tmpndep
$PollenDir = 0 unless $STALLO;
$RoadDir = 0 ;

Forest_ml.f90:
fmap declared as private (Massimo found that Intel 10 was complaining otherwise)

xxxxxxxx rv3_14   Dave & Alvaro, 23-24/4/2012 xxxxxxxxxxxxxxxxxxxxxxxx

run.pl  - Inputs.Landuse now only used in FORECAST mode.
          Default is now to interpolate from 5km CCE/SEI data
        - extra setups for TNO28

ModelConstants_ml - extra setups for TNO28
                  - Explicit settings for FORECAST mode (USE_*)

My_Outputs_ml & Output_hourly - AOD as standard FORECAST output

xxxxxxxx rv3_13_2 Dave, 20/4/2012 xxxxxxxxxxxxxxxxxxxxxxxx

ZCM_CB04 directory added


xxxxxxxx rv3_13_1 Dave, 17/4/2012 xxxxxxxxxxxxxxxxxxxxxxxx

Wesely_ml - add CDDEP_RCHO same as CDDEP_ALD

ZCM_CRI_v2_0 added, compiles and runs but needs further
  checks.

ZCM_CRI_v2_R5 correction


xxxxxxxx rv3_13 Dave, 16/4/2012 xxxxxxxxxxxxxxxxxxxxxxxxxx

* Bug fixes * found by Guus Velders,  16th April:
Results will change!
(UPDATE 17th April, : AOT increases by ca. 10% with this change)

AOT40nPOD_ml:   8-20CET was set wrong to test for 9-21 UTC
  changed.

GLobalBCs_ml

 error in 1993:
    macehead_o3 = (/ 37.6, 40.4, 44.4, 42.6, 43.4, 29.2, &
                     28.5, 29.6, 32.2,  0.0, 37.3, 38.3/)

Corrected (0.0 should be 33.3)

xxxxxxxx rv3_12_1 Dave, 15/4/2012 xxxxxxxxxxxxxxxxxxxxxxxxxx

Two main changes:

1)  Hourly .nc outputs: to allow 3-D output of both grid-centre and surface in
same file/variable. Examples set up for TOPO_TEST case.

Works for simple species only so far, no groups, but the intention
is to use Out3D to replace all the previous ADVppb, BCVug, etc... options.

Outputs appear only in Base_hour. Will add day, month, fullrun later.

2)  CB04 added into CVS. Code compiles and run. Further testing needed.


Changes:

Output_hourly   - coding for new Out3D type added, which can
     outputs values from both grid centres and the surface (3m)
     if klevel ik=0. (Uses surf_corrected logical to switch
     onm cfac when ik=0)

My_Outputs   - coding for new Out3D type added, which can
     outputs values from both grid centres and the surface (3m)
     if klevel ik=0.

     Changes include nhourly_out, nlevels_hourly now being set
     at run time (were paramaters), with currently values set
     for FORECAST, TOPO_TEST and the previous default

ModelConstants_ml - added TOPO_TEST. Partly for Emma+Jakob, partly
      to allow illustration of new Out3D options.


Other:

Dust_ml              extra debug. Found that DUSTY WET triggered in
                      Makefile debug mode, floating point stuff.

Met_ml               omit soil water stuff when USE_SOILWATER false
                     (hopefully temporary solution)

NetCDF_ml            some debugging stuff

ZD_VBS/My_SOA_ml     print (FEB2012) removed

ZCM_CB05/CB05base.reactions - some tracer(?) species commented out
ZCM_CB05/CB05base.species   - some tracer(?) species commented out


xxxxxxxx rv3_12     Alvaro 13/4/2012 xxxxxxxxxxxxxxxxxxxxxxxxxx

Small updates to previous. Re-tag as rv3_12 since emergency mode
is a really new addition in CVS!!

xxxxxxxx rv3_11_3   Alvaro 12/4/2012 xxxxxxxxxxxxxxxxxxxxxxxxxx

Emergency mode (eEMEP): Add Volcanic ash tracers to a EmChem09base+PMmass.
In the future only Volcanic ash and Radioactive tracers will be kept on this mode.

Added files
  ZCM_Emergency/ASH.species
  ZCM_Emergency/ASH.reactions
  ZCM_Emergency/Mastin&al2009a_table3.csv

Added as symbolic links (might be removed later on)
  ZCM_Emergency/BiomassBurning_FINNv1_to_Emergency.inc
  ZCM_Emergency/BiomassBurning_GFED_to_Emergency.inc
  ZCM_Emergency/GenIn.shorthand

mk.GenChem: add option for volcanic ash tracers (-V vol1,vol2,...)
  * For each volcano name supplied 7 ash tracers are added
  * Default eruption parameters set from Mastin&al2009a (see .csv)

Makefile, mk.GenChem: standard eEMEP setup from command line
  * eEMEP mk.GenChmem call, link and make
    make eEMEP
  * eEMEP GenChmem standard setup assumed in Makefile
    make eEMEP-GenChem-Emergency
    mk.GenChem -r Emergency -f FINNv1 -e none \
      -V Vesuvius,Etna,Krsuvk,Katla,Askja
  * Improve mk.GenChmem -h output

run.pl, Makefile_stallo:
  * Implement EMEP/MACC/eEMEP targets on Makefile_stallo
  * 'module load netcdf/4.1.1' is needed for Model to compile from run.pl/Makefile_stallo
  * 'make MACC' or 'make eEMEP' on Forecast mode

Solver.f90, Setup_1dfields_ml.f90: Volcanic ash emission variable
  * add rcash

Met_ml (DS) - some debug comments removed

xxxxxxxx rv3_11_2  Dave 10th April xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
(Committed to save work, but needs tidy up. Will remove all code labelled
 !DSA12 at a later stage.)
 !** Be careful with this code **!

Mainly soil-moisture and dust related changes

Dust_ml - now skips calculations if water_fraction > 0.99
          debugging added for use of PWP, FC.

GridValues_ml - small debug changes

Landuse_ml    - likely coastal now looks for any land, previously had<0.95

Met_ml -
         Removed local calculation of debug_proc and coords. This has been
         done already.

         FC and PWP now processed through landify. Values over sea are -999
         but these should never be called.

         landify routine modified to use different limits. Only tested
         for FC, PWP and soil water stuff so far.

NetCDF_ml - extra debug in ReadField_CDF

xxxxxxxx rv3_11_1  Dave 4th April xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Mainly soil water associated changes, but bug-fix in USE_HOURLY Emissions done.
(WARNING ** use with non-SMI data needs further workk/thought **)

Derived_ml - added SMI_deep, SMI_uppr

Dust_ml
   Now we have soil moisture index, SMI = (SW-PWP)/(FC-PWP), hence:

      v_h2o = pwp(i,j) + SoilWater(i,j,1) * (fc(i,j)-pwp(i,j) )

Emissions_ml - bug fix on hour_iland (candidate for default method)

Met_ml

   Modified Landify in Met_ml, to cope with upper and deep soil water
   Some max/min statements.
   Extra comments
   Small tidy-ups
   ** Code ** not intended to work for non-SMI yet. Will fix another day
    Also, need to check what happens near coasts.

ModelConstants_ml - added DEBUG_LANDIFY

My_Derived_ml - add SMI_deep and SMI_uppr

My_Outputs_ml - longer text strings to enable e.g. Emis_mgm2_BioNatAPINENE


xxxxxxxx rv3_11 Peter, Dave 4th April xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SMI1 and SMI3 read in Met_ml
moved the postprocessing parts from MeteoRead to metvar (MeteoRead should only
 read data, and metvar modify the data).
Met_ml.f90
MetFields_ml.f90

use 1,limax in RunChem and avoid accumulating totemis, totddep and totwdep in outer frame.
Runchem_ml.f90
DryDep_ml.f90
Aqueous_n_WetDep_ml.f90
MassBudget_ml.f90

xxxxxxxx rv3_11beta Dave 4th April xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
(Prelim version. Fixes fracmass, but leaves zero dep on outer boundary.
 Will work further with this.)

Changes to fix mass-balance problems, and simplify emissions
Code changes flagged with !DSA12 for now.(A12 = April 2012)

Biogenics_ml:   rcbio replaced by rcemis, and use of CM_EmisNat and
                EMIS_BioNat from GenChem

Derived_ml:   modified to use EMIS_BioNat from GenChem

DryDep_ml,   extra debug printout

EmisGet_ml,   extra debug printout

GenChem.pl
             Now produced CM_EmisNat.inc with biogenics
             rcbio read from GenIn.reactions  is used to flag such components

             Equations changed!
              max(xnew, ...) removed from CM_Reactions
              as change in Solver puts test on xold instead

GridValues_ml - extra debug

MassBudget_ml - routine emis_massbudget created here, from code that was in Setup_1d_ml

ModelConstants_ml - removed NSOIL_EMIS
Runchem_ml
               - uses loops of li0, li1 for now. Solved fracmass problem, but leaves zero
                 deposition on outer boundaries.
               - call setup_rcemis moved before setup_bio, so that rcemis now initialises
                 rcemis to zero, fills in with SNAP-emissions, and setup_bio adds
                 isoprene, soil-NO, etc.
               - call to  emis_massbudget_1d done after all this.
Setup_1d_ml
               - code for totem mass-budget moved to MassBudget_ml

Setup_1dfields_ml - rcbio removed

Solver_ml    - xold(n) = max( xold(n), 0.0 )  added. Avoids need for max in CM_Reactions

ZCM_EmChem09/EmChem09base.reactions new rcbio style:
   rcbio:C5H8                       = C5H8    ;
   rcbio:APINENE                    = APINENE ;
   rcbio:NO                         = NO ;
     (GenChem treates rcbio as special)


xxxxxxxx rv3_10_30 Dave 2nd April (started  30/3)/2012 xxxxxxxxxxxxxxxxxxxxxxxxxx

mk.GenChem - added example lines for CTI_V2_R5 chem, and no extras

Sites_ml, modified to cope with missing variable (-999 added).

Some small extra MASS debug changes, sorry, messed up logging

ModelConstants_ml - DEBUG_MASS added


xxxxxxxx rv3_10_29  Alvaro 28/3/2012 xxxxxxxxxxxxxxxxxxxxxxxxxx
(rtag includes up to  RObert's beta changes below)

Nesting external boundary and initial conditions (rv3_10_7 follow up).
External BCs for IFS-MOZART on FORECAST mode. Further testing is needed...

FORECAST hourly output definition has been re-touched following up changes to
mk.GenChem Isotopes.species/.reactions (rv3_10_21)

Multy level hourly output is can not be wrtitten write in compressed netCDF-4 format.
Therefore, the FORECAST output is not compressed.

Nest_ml, My_ExternalBICs_ml:
 - Move filename_read_BC,filename_read_3D & filename_write to My_ExternalBICs_ml
 - filename_read_BC (and potentially filename_read_3D & filename_write) are
   set according to the date if the date is provided, e.g. by
     'call set_extbic(idate=date_nextfile)'.

IFSMOZ_ExternalBICs_ml.f90:
 - provide My_ExternalBICs_ml for IFS-MOZART BCs on FORECAST mode.
   For use instead of My_ExternalBICs_ml.f90.
 - 2 different IFS-MOZART BCs are pre-set:
    - IFS_MOZ_f7kn (MARS EXPVER=fkya) in use up to 2011-11-30 (GEMS, MACC).
    - IFS-MOZ_fkya (MARS EXPVER=fkya) in use since 2011-12-01 (MACC-II).
    - Selection is handled automatically based on the date.

Nest_ml:
  - wrtxn will write only variables which have at least one value /=0.0.
    This should limit the number of "unused variables" written into the FORECAST
    dump/restart files.

Makefile:
 - Compile with IFSMOZ_ExternalBICs_ml instead of My_ExternalBICs_ml for
   MACC and SR-MACC targets.
 - Change depend target so .depend is updated any time a f90 file in $(SRCS) changes.
   All f90 files in $(SRCS) are needed for depend target to be made.

NetCDF_ml,ModelConsants_ml:
 - Explicit choice of NetCDF compressed output (NETCDF_COMPRESS_OUTPUT in ModelConsants_ml)
 - No compressed output on FORECAST mode. Compressed output otherwise.

My_Outputs_ml,GenChem.pl:
 - New pointer variable for short hand reference of properties for advected species
     species_adv=>species(NSPEC_SHL+1:NSPEC_SHL+NSPEC_ADV)
 - Change on FORECAST outly output definition.
   Simulation will CheckStop variable Rn222 if not found in species_adv(:)%name.

run.pl:
 - Use username variables (e.g. $ALVARO) explicitly mark data outside $DataDir.
 - Pattern for forecast & analysis IFS-MOZART BC files
 - Link BC vertical description file for FORECAST runs.

xxxxxxxx rv3_10_29beta Robert 16-21/3/2012 xxxxxxxxxxxxxxxxxxxxxxxxxx
(not rtagged)

Updated road dust emission potential files (21/3).
Now based on interpolating the TNO-data to the EMEP grid using 10x10points per TNO grid point.
    - updated files: run.pl and EmisGet_ml.f90

Crude handling of "climate-correction" factor for road dust emissions
introduced. Reading this factor from a simple text-file.

To be updated with something based on EMEP soil water!

changed files: Emissions_ml.f90, EmisDef_ml.f90
               run.pl: Added test file for climate-correction factor

xxxxxxxx rv3_10_28 Robert/Alvaro, 15/3/2012 xxxxxxxxxxxxxxxxxxxxxxxxxx

Robert:

Bug fix for Road Dust emissions in - Emissions_ml.f90

Emissions now at least seem to be of the correct order of magnitude... ;-)
Still not soil moisture "climate-correction" included.

Alvaro:

Improve mk.GenChmem & Makefile command line options

mk.GenChem: has now Help/Usage (-h) & Verbose (-v) command line options.
  * Help (-h) output contains the currently set values.
  * Verbose (-v) output shows how the command options are processed.
  * $extras can be emptied from the command line with -e 'none'.
  * Check run (-r) input so the corresponding directory has to exist.
  * Check extras (-e) input so the corresponding .species file has to exist.

Makefile: SR-EMEP & SR-MACC targets now use mk.GenChem -e 'none'

xxxxxxxx rv3_10_27  Robert/Alvaro, 14/3/2012 xxxxxxxxxxxxxxxxxxxxxxxxxx

Robert 13th Mar 2012:

A few more bugs removed in the road dust module from the rv3_10_26_beta
version (see below). Still NOT finished or tested!
So keep USE_ROADDUST=.false. !

Alvaro 13th Mar 2012:

Expand mk.GenChmem & Makefile for standard EMEP/MACC setup from command line.

The following command lines are now possible:
  make modules  # check modules/versions loaded for standard EMEP/MACC make
  make EMEP     # EMEP mk.GenChmem call, link and make
  make MACC     # MACC mk.GenChmem call, link and make
# EMEP GenChmem standard setup assumed in Makefile
  make EMEP-GenChem-EmChem09soa
  mk.GenChmem -r EmChem09soa -e SeaSalt,Dust,Isotopes -f FINNv1
# MACC GenChmem standard setup assumed in Makefile
  make MACC-GenChem-EmChem09soa
  mk.GenChmem -r EmChem09soa -e SeaSalt,Dust,Isotopes -f GFED

mk.GenChem - options for $run, $extras & $ffires from command line.
             Command line options are -r $run -e $extras -f $ffires

Makefile   - add 'EMEP' & 'MACC' compilation targets for standard setup.
           - add 'SR-EMEP' & 'SR-MACC' compilation targets for SR setup,
             i.e. no extras in mk.GenChmem  (-e "").
           - add 'module' compilation tag. It checks if certain modules/versions
             are loaded before EMEP & MACC targets. The modules/versions are
               intel-compiler/11.1 openmpi/1.4 netcdf/4.1.1

xxxxxxxx rv3_10_26_beta  Robert  9 (+12-13th bug fixes) Mar 2012   xxxxxxx

Started implementing a test version of the TNO Road dust emissions.
NOTE! The new routine is not yet tested properly (some bug(s) probably
remains to be removed). The "climatological" factor (based on average
soil water) is not yet included!

So for standard use USE_ROADDUST should be kept .false. !

Another update:
Added possibility to use SNAP-dependent hourly emission variations (the
factors taken from the EuroDelta-project) - not checked in detail yet
(so may contain bugs).
To use/test this set:   USE_HOURLY_EMISVAR = .true. in ModelConstants_ml.f90

Other changes/updates:
Country_ml   - added country code 93 for Russian Federation in ext EMEP domain
EmisDef_ml   - added SNAP_HOURFAC(24,NSECTORS) containing hourly scaling factors for SNAP-sector emissions
             - Started to add Road Dust parameters (likely to be updated/changed)
EmisGet_ml   - added routine for reading road dust emission potentials RoadDustGet (likely to be updated/changed)
Emissions_ml - Started to add Road Dust parameters (likely to be updated/changed)
ModelConstants_ml  - added USE_HOURLY_EMISVAR (for hourly variation of SNAP-sector emissions)
                   - USE_ROADDUST [to be kept .false. until bugs fixed!] (for turning on/off the TNO road dust emissions)
Setup_1d_ml  - adding road dust emissions (rcroadd)
ZCM_EmChem09/Dust.species   - added fine and coarse road dust species:
                              DUST_ROAD_F and DUST_ROAD_C
ZCM_EmChem09/Dust.reactions - added fine and coarse road dust emissions


xxxxxxxx rv3_10_25  Dave  7-8th Mar 2012   xxxxxxxxxxxxxxxxxxxxxx

ZCM_EmChem09/Isotopes.species, reactions added. (Forgot to do this
  in earlier runs).

SoilWater renamed to SoilWater_uppr in:

  Derived_ml
  DryDep_ml
  DustProd_ml  (uses =>)
  MetFields_ml
  Met_ml (also, extra debugs)

Also,

Timefactors_ml - small tidy up


xxxxxxxx rv3_10_24 Dave  6th Mar 2012   xxxxxxxxxxxxxxxxxxxxxx

Many small changes to make gfortran pedantic happier
(inc. h_plus removed from get_frac arguments in Aqueous_)
Shouldn't affect results

xxxxxxxx rv3_10_23 Dave 28th Feb 2012   xxxxxxxxxxxxxxxxxxxxxx


Dust_ml - safer for case when DUST_WANTED true, but not in extras array
          some tidy up

Mosaics_ml - now works if species (e.g. SEASALT) not found

SeaSalt_ml - safer for case when DUST_WANTED true, but not in extras array
          some tidy up

Timefactors_ml - small tidy up. Seems okay so far though.


ZCM_CRI_v2_R5/CRI_v2_R5.species - NRTN28O2 removed from OXN group,
   since code can't cope with short-lived species

xxxxxxxx rv3_10_22 Dave 28th Feb 2012   xxxxxxxxxxxxxxxxxxxxxx


BUG-FIX on SOA:   Fgas/Fpart were not being initialised right.
   Need to store Fgas in 3D array

Chem_ml  - added Fgas3D array

MassBudget_ml - modified to use PrintLog - copies results to RunLog

Runchem_ml - call to Init_OrganicAerosol at start of i,j loop -
   allocates Fgas3d on 1st call, and sets Fgas, Fpart on all
   calls(

ZD_VBS/My_SOA - modified to use Fgas3D
ZD_OZONE/My_SOA - dummy Init_OrganicAerosol added


xxxxxxxx rv3_10_21 Dave 23rd Feb 2012   xxxxxxxxxxxxxxxxxxxxxx

(Bug-fix on 22nd on GenChem.pl: formatting wrong in CM_EmisFiles)


GenChem- changes to allow easier use or exclusion of seasalt, dust,
   pollen, isotopes - ie the inert stuff that can be used by any
   chemical mechanism:

mk.GenChem

   Use of "extras" array extended to Isotopes, and to Boundary conditions
   (new "bics" array), so we have:

 ZCM_EmChem09: (added)

   Isotopes.species
   Isotopes.reactions

   EmChem09base.BoundaryConditions
   SeaSalt.BoundaryConditions
   Dust.BoundaryConditions

 ZCM_CB05:

   CB05.BoundaryConditions (was SAFE....)

  - these are called in as appropriate by mk.GenChem, and can be used
   from other chemical schemes

   - also changed APIN, BPIN to APINENE, BPINENE - simplifies emis output

Added:  ZCM_CRI_v2_R5/CRI_v2_R5.BoundaryConditions

 ** Deleted:

   ZCM_EmChem09/SAFE.CM_BoundaryConditions.inc
   ZCM_EmChem09soa/SAFE.CM_BoundaryConditions.inc
   ZCM_CB05/SAFE.CM_BoundaryConditions.inc
   ZCM_CRI_v2_R5/SAFE.CM_BoundaryConditions.inc


GenChem.pl - formatting in print_emisstuff adjusted to give same
   number of characters in CM_EmisSpec.inc and CM_EmisFiles.inc

DustProd_ml - uses find_index instead of hard-coded DUST_WB_F

Pollen_ml - Use of Pollen_b commented out. Thought I had done this earlier.

SeaSalt_ml -  use of SS_GROUP replaced by search for "SEASALT_" in names.
   Needed to allow runs without SeaSalt.species

ZD_OZONE/My_Aerosols - StopAll added in case of EQSAM, until we sort
   out SEASALT usage

ZD_OZONE/My_Outputs  -  Fake hr_out(06) added to avoid hard-coded Rb222
   index. This whole module should be removed....


xxxxxxxx rv3_10_20 Peter 21st Feb  2012  xxxxxxxxxxxxxxxxxxxxxx

Met_ml.f90 faster meteo reading

Preparations for SR. Compatibility for other compilers (gfortran or IBM xlf90):
ZD_VBS/My_SOA_ml.f90 ("," removed )
BLPhysics_ml: SigmaKz_2_m2s_scalar redefined as subroutine (was not used anyway)

CM_EmisSpec.inc all  EMIS_Specs should have the same number of characters (please put blanks to fill the spaces)

xxxxxxxx rv3_10_19 Peter 14th Feb  2012  xxxxxxxxxxxxxxxxxxxxxx

Output_ml, ModelConstants_ml: allow for separate hourly files every day or month.

For large grids, these where becoming excessively large.

NB:needs special attention to be used (i.e. set .true.) until newer libraries are installed!
Will not work well by default on Stallo because of library bugs (the code may crash).
Until this is fixed, you must compile with netcdf/4.1.3 and link and run with compiler 12.1.2


xxxxxxxx rv3_10_18 Birthe 13th Feb  2012  xxxxxxxxxxxxxxxxxxxxxx

Pollen_ml.f90 - The heatsum is calculated every metstep, and the birch forest
                 is reduced from 60 degrees north.

xxxxxxxx rv3_10_17 Peter 9th Feb  2012  xxxxxxxxxxxxxxxxxxxxxxx

Removed huges arrays from BoundaryConditions_ml. They were not necessary
and made the code explode for large grids.  Later the BC routines should
be merged with Nest_ml; this is not finished yet, but has to wait.

Should be faster too.

xxxxxxxx rv3_10_16 Peter 9th Feb  2012  xxxxxxxxxxxxxxxxxxxxxxx

The landuse must be defined before the metread (it was not).
Moved SetLandUse() before the met calls.

Moved call to InitLanduse() into SetLandUse()

Default value of nwp_sea(i,j) is set in InitLanduse, and overwritten by MetModel_LandUse if found.

Corrected a bug introduced in rv3_10_15 in RunChem (limax->li1)

The changes in rv3_10_15/16 will also change results, because it was wrong before:
If the landuse etc. are not defined in the outer frame, some routines (smoosp, extendarea) will use wrong data.
(The largest change are in the first day)

Modified:
Landuse_ml.f90
Met_ml.f90
Runchem_ml.f90
Unimod.f90

xxxxxxxx rv3_10_15 Peter 6th Feb  2012  xxxxxxxxxxxxxxxxxxxxxxx

Many changes in loops: replaced almost all "li0,li1" into "1,limax".
The idea is that we always compute for the whole domain, the exceptions are that we don't want do update the concentrations in xn_adv (and possibly in budgets).
Some small differences very close to the boundaries, I think they may come from the "landify"

moved everything which was in the "my_first_call" in SetLandUse, over to the InitLanduse subroutine. It seems more logical, and was necessary to get before the BC update.
(where landsea_nwp must be set for SeaSalt).
This also changed other concentrations I noticed: because "landify" uses "likely_coastal" which was not yet set before the first call to metdata.

Also commented out the link to rough.dat in run.pl: don't use it by default, as it is probably wrong anyway: it was wrong in EECCA, and is not defined for IFS anyway.

List of modules modified:
run.pl
Landuse_ml.f90 .
Met_ml.f90 .
Runchem_ml.f90 .
Volcanos_ml.f90 .
FUTURE_NH3Emis_variation_ml.f90 .
ForestFire_ml.f90 .
Emissions_ml.f90 .
Biogenics_ml.f90 .
DryDep_ml.f90 .
Io_Progs_ml.f90 .


xxxxxxxx rv3_10_14 Dave 6th Feb  2012  xxxxxxxxxxxxxxxxxxxxxxx

mk.GenChem   - simplified:
               added an array extras=( SeaSalt Dust Pollen )
               which can be used by all other schemes.
              (Also, Pollen isn't yet a default species, and
               none of these needed in SR runs for example. Now
               easily skipped using mk.GenChem)

Pollen_ml    - removed hard-coded Pollen_b, used ipoll and find_index
                 instead.

ZCM_CRI_v2_R5   - emissplit files added, from rv3_9_34chem_cri. Probably
need to edit the PM ones, but just added for now.

ZCM_EmChem09/GenIn.species removed --- they haven't been used for
   ages as mk.GenChem creates them

ZCM_EmChem09/GenIn.reactions removed --- they haven't been used for
   ages as mk.GenChem creates them

xxxxxxxx rv3_10_13  Svetlana 3rd Feb  2012  xxxxxxxxxxxxxxxxxxxxxxx

Bug for sea salt BICs in BoundaryConditions_ml.f90 corrected
(BIC is switched off when USE_SEASALT=false)

xxxxxxxx rv3_10_12  Svetlana 2nd Feb  2012  xxxxxxxxxxxxxxxxxxxxxxx
                  &  Peter

ST: Addition to EC ageing   - modified My_Derived_ml.f90

PW:
Modified the formula in  ReadField_CDF (rv3_10_11), as it was not safe.
(worked OK on Stallo, but not on Gardar).
i=i_local(nint(ir)) -> i=nint(ir)-gi0-IRUNBEG+2

xxxxxxxx rv3_10_11  Peter 1st Feb  2012  xxxxxxxxxxxxxxxxxxxxxxx
                  + Svetlana 31th Jan  2012

Bug in ReadField_CDF when converting from stereographic to lat lon.
Occurs only if you run in a rundomain which is smaller than fulldomain.
The BVOC will be wrong in this case.
bug introduced in rv3_10_5.


** EC ageing included:    EC_F_FFUEL_NEW   EC_F_FFUEL_AGE .....
ZCM_EmChem09soa/VBS_nonvolatile.species
ZCM_EmChem09soa/VBS_emissions_nonvolatilePOA_FromPM25.reactions

Aqueous_n_WetDep_ml.f90 - in-cloud scavenging for new EC is put to 5%

xxxxxxxx rv3_10_10  Birthe, David 20th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

*NEW* Pollen_ml introduced for calculating birch pollen emission
      Calculates pollen emission based on a code by Sofiev et al. (in prep)
** but ** Experimental! Needs to accumulate heat, so cannot start in eg May.
          Will likely use externally calculated heat-sums in future.

-Introduces a new species, pollen_b (birch pollen) in EmChem09
- Aero_Vds_ml.f90 - added pollen properties for diam, sigma and PMdens
- Aqueous_n_WetDep_ml.f90 -added a new wetdeposition CWDEP_POLLw
- Derived_ml.f90 - added output, and an output for pollen emission AreaPOLL.
- ModelConstants_ml.f90 - added USE_POLLEN and DEBUG_POLLEN
- MosaicOutputs_ml.f90 - added molweight of pollen
- Runchem_ml.f90 - calls for Pollen_ml
- Wesely_ml.f90 - added one dry aerosol, CDDEP_POLLd and AERO_SIZE
- My_Aerosols_ml.f90 - add NSIZE by 1 to NSIZE=5
- My_Derived_ml.f90 - added wetdep, drydep and SURF_ug_POLLEN_B
- mk.GenChem Pollen added to EmChem09



xxxxxxxx rv3_10_9  Peter, 20th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

Output_hourly.f90
Close the netcdf_hourly file after each hour.
Not closing seems to give a segmentation fault when opening the daily file
Probably due to a bug in the netcdf4/hdf5 library.

xxxxxxxx rv3_10_8  Robert, 19th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

Simplified EmChem09soa scheme.
   Removed many unused species and changed some component names.
   Reduced the level of detail for the stored ASOA and BSOA species;
   now only keep track of ASOA and BSOA (and not subgroups of these)
   [further reduction is possible to only store SOA (=ASOA+BSOA)].

The updated code should give close to identical results to the earlier version but note that to use the "research" version of the VBS-SOA scheme some editing of ZD_VBS/My_SOA_ml.f90 is necessary.

The new code is significantly faster than the old one (almost 20% in the first tests).

Updated files: mk.GenChem
               ZD_VBS/My_SOA_ml.f90
               ZD_OZONE/My_Derived_ml.f90
               ZCM_vbs_tests/VBS_partitioning.species
                             VBS_help.species
                             VBS_SOAageing.reactions
                             VBS_SOAformation.reactions
                             VBS_ASOAageing.reactions
               ZCM_EmChem09soa/VBS_nonvolatile.species
                               VBS_emissions_nonvolatilePOA_FromPM25.reactions
New files:     ZCM_vbs_tests/VBS_SOAageing_Detailed.reactions
                             VBS_SOAformation_Detailed.reactions
                             VBS_help_Detailed.species
                             VBS_partitioning_Detailed.species


xxxxxxxx rv3_10_7  Dave, 19th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx


Start of modified system for nesting external boundary and initial conditions.
Needed because we want to avoid chemistry-specific  (eg EmChem09) indices
in the main code, and to make it explicit to users that the BIC mapping
is very dependent on chem scheme and external data.

Nest_ml
          "chemistry"-dependent bits removed, functionality now
          through new files given below. Code much shorter
          since species mapping moved to external files, and
          some repetition of the same procedures unified.
          Now only needs NSPEC_ADV from GenSpecs_adv_ml.
          "print" changed to write.
          Prefix "Nest:" added to many write-outs, to make it easier to
          search log files.

Makefile.SRCS - add My_ExternalBICs_ml.f90

*** New:

File: ZD_OZONE/My_ExternalBICs_ml.f90  - a do-nothing file  for the usual case
        where the model uses the standard BICs. Copied along with other My* files

Directory: ZD_EXTRA
File: MOZART_EmChem09_ExternalBICs_ml.f90
File: README.txt - explains usage

The MOZART file is intended as a starter, but includes I think the same
functionality as the code in the previous Nest_ml. *NOT TESTED* except
for compilation (as ds has never used Nest_ml, and hence has nothing to
test with). If more complication is desired, then this can be done
within this module I hope, simply "use"-ing other modules to grab'
any needed information (such as date).


To-Do: *test* and update MOZART .f90
       * clean-up* Nest_ml, much code now commented out
        Should also make files for RCA, HTAP as appropriate. These will also
        be put in ZD_EXTRA

xxxxxxxx rv3_10_6b  Robert 18th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

Robert: Minor update of SOA aging reactions in "research-version" of VBS-SOA model version PAPA.
        Updated file: ZCM_vbs_tests/VBS_ASOAageing.reactions [Now identical to the version used in the EMEP-VBS paper submitted to ACPD]

        Note: Some other files may still not be updated. Will be fixed soon.

xxxxxxxx rv3_10_6  Dave, Peter 18th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

Peter - added Emissions_ml from _5 commit

Dave: Started to add CB05 chemistry, but maybe only partial commit. Will
continue

mk.GenChem - cb05 possible. No SOA though.

ZCM_CB05 files



xxxxxxxx rv3_10_5   Peter 16th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

New routine for direct interpolation from polar stereographic projection
Now zeroth-order interpolation needs Undef to be defined, or all values must be well defined.
This will slightly change the results.
In the future the file from MaxPosch+GLC2000 can be used for Landuse. GLC2000 input still needs some improvements(?).

Modified:
NetCDF_ml
GridValuse_ml
Landuse_ml.f90
Biogenics_ml
Emissions_ml
run.pl

File annualNdep.nc temporarily copied to $DataDir as annualNdep_tmp.nc.

Met:ml: timeunit(1:19)

xxxxxxxx rv3_10_4  Dave 13th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxxxx

run.pl - uses LAndInputs_Jan2012
          Higher (20m) trees and some small changes in land-defs
          Will change results a bit, by increasing deposition


xxxxxxxx rv3_10_3   Peter 10th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

NetCDF_ml.f90:
Netcdf output file in compressed netcdf-4 format.
For postprocessing, if you get error messages, make sure you use libraries linked to netcdf-4
(for example by writing module load netcdf, module load nco).


Landuse_ml.f90:
Started to include new landuse reading (experimental so far, not default).


xxxxxxxx rv3_10_2   Peter 6th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

Nest_ml with MODE=100 option. Use monthly BC. Experimental so far.to be merged with Global_BC_ml

made great_circle_distance in InterpolationRoutines_ml private, as it is already defined in Functions_ml


!
xxxxxxxx rv3_10_1   Peter 4th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

Small bug in extendarea (Met_ml):
   iif=limax and    jjf=ljmax (instead of using size, which gives maxlimax)

Small effet on results, but can give sightly different results for different number of CPUs

fac_min was defined only for MasterProc (in Timefactors_ml). Redefined it after the broadcast in Emission_ml.
Slightly different definition, since now defined after renormalization.
Relatively small differences in results since this is only used for sector 2.

Finally same results on a 2 days test with 8x4 and 2x16 processor partition

xxxxxxxx rv3_10   Dave 3rd Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

new label, since 37 seemed a bit high, and since rv3:9_36 was anyway
a result-change from other rv3_9_xx series. Another result
change here:

ChemFunctions_ml.f90 - now uses aerosol radius in VOLFACs
consistent with that used in dry-deposition, namely number
median radius 68nm instead of 34.

xxxxxxxx rv3_9_36 Dave 31st Dec 2011  xxxxxxxxxxxxxxxxxxxxxxx

Various "bug-fixes" (or doing things as intended)

Biogenics_ml
  Added temperature variation to soil-NO  from crops

ModelConstants_ml
 Set NO_CROPNH3DEP true

SubMet_ml
 Set z0 = min( z0, 1.0) instead of 0.5


run.pl
  uses LandInputs_Dec2011   - higher trees



xxxxxxxx rv3_9_35 Alvaro, Dave 21th Dec 2011  xxxxxxxxxxxxxxxxxxxxxxx

Alvaro, 21st Dec:
Output_hourly.f90:
Wrong PM water content on multi-level hourly output.
This bug was introduced on rv3_7beta7, fixed on rv3_9_22,
and re-introduced in rv3_9_23. It is specially relevant on FORECAST mode.

Dave, 20th Dec.
Bug-fix, but luckily they cancelled out
The 1st bug was that L%is_crop wasn't set
The 2nd bug was that L%is_crop was used for all gases, not just NH3

the net effect was that the intended setting of Rsur to high values for
NH3 over crops never happened.

Submited fix now sets NO

  ModelConstants_ml:
   NO_CROPNH3DEP      = .false.   - set false now to keep same results

   Rsurface_ml - NO_CROPNH3DEP only aplied for NH3

   SubMet_ml - set L%is_crop

xxxxxxxx rv3_9_34 Dave/Peter 19th Dec 2011  xxxxxxxxxxxxxxxxxxxxxxx

Peter:

   ReadTime: include the proleptic_gregorian calendar

   Nest_ml: for 3D IC files with different vertical levels was wrong.
    replaced
    forall (k=1:KMAX_ext, j=1:ljmax, i=1:limax)
    with
    forall (k=1:KMAX_MID, j=1:ljmax, i=1:limax)

Dave:

  run.pl - Modrun11 set as default.

  ForestFires_ml - only print to RunLog in first call

  ZCM_CRI_v2_R5
     commnted out APIN in RCBIO
     added soil NO

xxxxxxxx rv3_9_33   Dave       16th Dec 2011  xxxxxxxxxxxxxxxxxxxxxxx

BUG-fix ... for years prior to 2008 (EECCA) the deep soil water
was incorrectly set when the data weren't found. Now defaults
to fSW = 1.0 if no data found, and prints warning to RunLog.

xxxxxxxx rv3_9_32   Dave       15th Dec 2011  xxxxxxxxxxxxxxxxxxxxxxx

Output_hourly.f90 - bug fix, but results don't change for normal usage
   (showed up with DEBUG_OUT_HOUR true, debug in Makefile)

ZD_OZONE/My_Derived_ml - added SoilNO emissions
ZD_OZONE/My_Outputs_ml - added SoilNO emissions

xxxxxxxx rv3_9_31   Svetlana           14th Dec, retag 15th 2011  xxxxxxxxxxxxxxxxxxxxxxx

Natural dust is split to WB (windblown) and SAH (Saharan):
DustProd_ml.f90, My_Derived_ml.f90
ZCM_EmChem09/Dust.species and Dust.reactions,
SAFE.CM_BoundaryConditions.inc in ZCM_EmChem09 and ZCM_EmChem09soa

xxxxxxxx rv3_9_30   Robert             14th Dec 2011  xxxxxxxxxxxxxxxxxxxxxxx

Bug-fix   ZD_VBS/My_SOA_ml.f90 - Factor of 12 too low OM-concentrations stored in netcdf-files for
                                 FFIREOA25_OM, WOODOA25_OM and FFUELOA25_OM in earlier versions (only affects
                                 stored "help" species, that is no change in the "real" model species)

xxxxxxxx rv3_9_29   Peter               7th Dec 2011  xxxxxxxxxxxxxxxxxxxxxxx

+ (Dave, 11th Dec)
rtagged

** Also **  8th Dec 2011, Met files were corrected for ice and snow in EECCA and GLOBAL were corrected. Results will change.

Bug in Convection_ml. BC where modified by the routine. No effect for global runs, becase they don't have BC.


xxxxxxxx rv3_9_28   Dave/Robert               30th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

Bug-fix   some POC_ components that were a part of PART_OM_F were  included  also
included  in PMFINE, resulting in some double count.

Fixed in ZCM_EmChem09soa files

Also, "WOOD" EC, OC emissions removed in ZCM_EmChem09soa/EMISSPLIT files since they
were basically fake. Better zero than low values that will one day confuse somebody.


Met_ml DEBUG_Kz added, but we have print again. Why? This was changed below?

Timefactors_ml - debug cleanup

mk.GenChem - defaulted to EmChem09soa (but users should check!
)

PMFINE label removed from:
ZCM_EmChem09soa/VBS_nonvolatil

WOOD removed from
ZCM_EmChem09soa/EMISSPLIT/emissplit.defaults.pm25
ZCM_EmChem09soa/EMISSPLIT/emissplit.defaults.pmco

My_Derived_ml - commented out WOOD outputs (to precent future
  confusion. All organics are now called FFUEL, which is also
  confusing, but zero wood should give a hint.)



xxxxxxxx rv3_9_27c  Dave                      29th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx


Added ZCM_CRI_v2_R5 for those wanting something a bit heavier :-)

    (Chemistry is about 3 times larger than EmChem09.)


xxxxxxxx rv3_9_27b  Robert                    29th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

My_Derived_ml.f90 - Removed some non-used species corrected the names of some OA-group components

xxxxxxxx rv3_9_27 Svetlana, Dave              29th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

ST:
Dust outputs in My_Derived_ml.f90
(SURF_ug_) DUST_NAT_F, DUST_NAT_C, and DUST

DS:
Met_ml - prints changed to write in Met_ml (these were already write in rv3_9_20
 - some reversal of code?). Some more use of DEBUG_Kz

Timefactors - also just tidy up of print/write


xxxxxxxx rv3_9_26hdd      Dave     28th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

*** Needs pre-processed file with daily DegreeDays. Currently
     in mifads directory for 2009. Easy to generate -  run
    ~mifads/bin/DegreeDayFac  to see usage
    (code in /Work/EMEP_Projects/DegreeDay/DegreeDayFac.f90)

Added option to use degree-days to calculate emission variation.

 EmisDef_ml - add ISNAP_DOM  =  2

 Emissions_ml - uses Gridded_SNAP2_Factors. DegreeDayFactors etc.

 ForestFire_ml - reduced outputs except on debug

 Met_ml make Getmeteofield public

 ModelConstants_ml - USE_DEGREEDAY_FACTORS

 Timefactors -  uses Gridded_SNAP2_Factors. DegreeDayFactors etc.

 run.pl - link to DegreeDayFac-${GRID}-$yy


xxxxxxxx rv3_9_26  Svetlana, Dave, Robert      28th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

Robert:
ForestFire_ml.f90 - Updated the reading of FINN emissions (interpol='mass_conservative'
                    instead of 'conservative', should give correct scaling factor)
                    Changed assumed OM/OC ratio from 1.3 to 1.7 for FFIRE POA
                    Started updating the GFED handling (but probably still not working properly!!!)

ZCM_EmChem09soa/BiomassBurning_FINNv1_to_EmChem09soa.inc - Changed OM/OC ratio to 1.7 for FFIRE emissions
                BiomassBurning_GFED_to_EmChem09soa.inc - Updated OM/OC ratio and some other parameters
                VBS_nonvolatile.species - Introducing new groups NVFFUELOC10

ZD_VBS/My_SOA_ml.f90 - Introduced split of NVFFUELOC into NVFFUELOC25 and NVFFUELOC10,
                       updated storing to handle both partitioning and nonvolatile POA
                       in a similar way [NOTE some hardcoding of OM/OC ratios!!!
                       Assumes OM/OC=1.25 for FFUEL POA and 1.7 for WOOD POA and FFIRE POA]

ZCM_vbs_tests/VBS_help.species & VBS_nonvolatile.species - Added the number 25 to some
                       group names (to indicate that they are in PM2.5)
                       added NONVOL_FFUELOC10 (as well as NONVOL_FFUELOC25)
              VBS_partitioning.species - Added the number 25 to some group names

Svetlana:

PM water calculations by MARS (instead of EQSAM): 3D for ambient conditions
and surface 2D for at Rh=50% (for comparison with obs):
Runchem_ml.f90 and My_Aerosol_ml.f90

Windblown dust is calculated now: DustProd_ml.f90 (also EmisDef_ml.f90, Solver.f90,
ModelConstants_ml.f90, mk.Genchem;  in ZCM_EmChem09: Dust.species, Dust.Reactions)

Introduces dry deposition velocities for coarse sea salt and dust: SSc and DUc
(Wesely_ml.f90, Aero_Vd_ml.f90, ZCM_EmChem09/SeaSalt.species)

Dave:

Riemer rate set back to original following riemer2 testing


xxxxxxxx rv3_9_25  Peter                       28th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

Changed DustProd_ml.f90 to use IFS threshold. Uses IFS soilmap and parameters.
Started to add Soil Moisture Index in Met_ml.f90 for deep soil water from IFS.
Switched on swich for Soilwater and Dust in ModelConstants_ml
changes also in MetFields_ml.f90,Met_ml.f90
SoilTypes_IFS.nc in run.pl

Birthe: Added output in Output_hourly.f90 for Phillipe runs. Should be commented
out when  done with these runs. Also changed from print to write, and rearranged
Debug for a DEBUG_OUT_HOUR in ModelConstants.f90


xxxxxxxx rv3_9_24  Dave                       27th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx


  ForestFire_ml ***  BUG FIX  ****

     A units conversion (e.g. 0.028 for CO) was applied twice, leading to far too
     low forest-fire emissions

  Derived_ml - AddDeriv for ws_10m  commented out, moved to My_Derived
               rh2m added

  Io_Progs_ml - added another datewrite to print up to 5 ints, then array of reals

  ModelConstants_ml. Small tidy up - alphabetical DEBUGs

   My_Derived - ws_10m and rh2m added here. RN222 and RNWATER commented out.

   My_Outputs - added ws_10m and rh2m for sites output.

xxxxxxxx rv3_9_23   Birthe/Dave               25th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

   Output_hourly and ZD_OZONE/My_Derivbed(?) changed, for sending
   test files to Phlippe. Does ws_10 need to be added?

   safety test - added SOA_MODULE_FLAG="VBS" in ZD_VBS/My_SOA_ml
     and = "NotUsed" in ZD_OZONE/My_SOA_ml.

   - should stop code if attempt is made to run VBS with OZONE My_SOA

   outputs adjusted for forest-fire associated OM and other
   NONVOL outputs (spotted by RObert)

xxxxxxxx rv3_9_22     Svetlana & Alvaro       24th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

Runchem_ml.f90:
PM25_water_rh50 will be calculated every time step and averaged
(was calculated at the end of a day - do not remember why)

Output_hourly.f90:
Wrong PM water content on multi-level hourly output.
This bug was introduced on rv3_7beta7. It is specially relevant on FORECAST mode.

The PMwater hourly output type (introduced on rv3_6_1) should
output PM water content at model mid-levels (PM25_water). Instead it outputted
surface values (PM25_water_rh50) which were updated only once a day at END_OF_EMEPDAY
(Aero_water call on runchem).

Now, by default PMwater outputs PM25_water for model mid-levels.
If SELECT_LEVELS_HOURLY (My_Outputs_ml, used in FORECAST mode)
PMwater outputs PM25_water_rh50 for surface level and PM25_water form model mid-levels.
The new hourly output type PMwaterSRF will provide PM25_water_rh50 regardless
of the level selected.


SeaSalt_ml
   - reduced assumed salt and hence emissions over Baltic sea


xxxxxxxx rv3_9_21         Dave     23d Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx


EMISPSLIT - new emissplit.specials.pm25 and defaults.pmco

The pmco is kept simple, and no attempt is made to produce a specials
file for that.

The pm25 is calculated from IIASA's EC, OC - as sent earlier
to Agnes/Svetlana. I have used OM=1.25*OC (which is consistent
with the SOA scheme assumption that POM is CH3-like. When this
exceeds 99%, I rescale (at least 1% other is then enforced.) See
~mifads/D_Emis/EmisSplitNov2010/PM_EMISSPLITS_RESCALING/mkp.EmisSplit

The effect should be to increase SOA a little, since OA condensation
is proportional to the avaialble mass of OM.

My_Derived_ml - set some OM outputs to monthly (M) instead if
   daily, to reduce file size

ModelConsants
    USE_DUST set .false.
    comments to discourage use of Ln95, SOILNH3

ZCM_EmChem09, ZCM_EmChem09soa:
      SEASALT_G removed from SAFE_CM.Boundar..


xxxxxxxx rv3_9_20ss       Svetlana 23d Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

Sea salt is back to 2-size fractions representation, fine and coarse.
In Aero_Vd_ml: fine MMD is the same for as for all aerosols,
introduced coarse MMD = 4um for sea salt (dry dep. as SSc in SeaSalt.species)
Annual mean bias is 2% for 2009 (-12% to 14% seasonally)

xxxxxxxx rv3_9_20landify  Dave 21st Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

ModelConstants_ml, Met_ml.f90 - "landify"

  if LANDIFY_MET = .false. , no change
  if LANDIFY_MET = .true. ,  then meteorology for coastal sites (where
   NWP_sea is true, but land exists) is created from neighboring
   land grid-squares.  Improves model performance for some coastal
   sites a lot with PARLAM met. Seems to have less effect for IFS
   but checking continues.


mk.GenChem - ammended with if-test for $run. Saves having to
  uncomment spcs and rcns each time.

My_Derived_ml
   - now copes with missing groups
   ***  removed from ZD_VBS ****  (SOA groups can be kept in the
    ZD_OZONE versions anyway now.)

EmisGet_ml - more helpful error message for EmisSplit

run.pl - lines for 2009 added

SubMet_ml - use of LANDIFY

xxxxxxxx rv3_9_20soa, Dave  20th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

Main changes:

1) SOA ZCM_EmChem09soa directory added. Use when VBS wanted for policy runs

2) Stopped dry-dep of NH3 over growing crops

3) Also,Vds(N) = 3*vds(S), not 2

4) Derived and My_Derived. Started process to simplify, but needs
   more work. For now....

4a) ZD_VBS/My_Derived and ZD_OZONE/My_Derived now identical. Will merge
into one soon.  Note that now it is okay to ask for things that will
not be found, so we can ask for SOA, but will only get it if present.

mk.GenChem modified for above directory

GenChem.pl now allows emission names of lengt 30, not 12

EmisGet - removed need for emissplit.specials.voc if FOREST_FIRES used

Rsurface_ml - very high Rsur for NH3 over crops (when LAI > 0.1)

Biogenics_ml - commented out some USE_SOILNH3 lines.

ISSUES? Just check Weidinm. for OMbb assumption,also ACET?

xxxxxxxx rv3_9_20ff, Dave  20th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

ForestFires_ml -

  .... continued work with the  new forest-fires routine

 --  re-arranged to avoid older use of snapemis and to
 just work directly with rcemis.

New include files:

 ZCM_EmChem09/BiomassBuring_FINNv1_toEmChem09
 ZCM_EmChem09/BiomassBuring_FINNv1_toEmChem09

 ... which mk.GenChem copies to CM_BBtoEmChem09.

mk.GenChem - copies BiomassBurning files as noted above

ZD_OZONE/My_Derived_ml -added PPM25_FIRE

xxxxxxxx rv3_9_20, Dave  20th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

Soil NO emissions added  (working version for EECCA/EMEP)

Soil NH3 "placeholder" emissions added. Do not use!!!!
      (but arrays exist in case anybody wants to experiment)


SOIL NOx ISSUES -

This versions works for European soil-NO emissions, but work still
needed on a few issues for e.g. global usage, or NH3

    (1) Soil-NO needs maps of annual N-deposition. Temporary 1-year average
        set now. Need to make proper system, e.g. with 5-year avg.
        Also need to consider "trends" for future scenarios

        Currently map is in hard-coded mifads directory. Will move to mifapw
        when procedure files.

    (2) Can now have either the hourly calculations or the monthly
        global fields. Ideal is probably hourly for Europe and
        monthly outside.

    (3) Not sure the global soil works, since now rcbio is used
        check

    (4) NH3 should be in reactions too?


Biogenic_ml -  soil emissions added here

Derived_ml - has USE_SOILNOX, USE_SOILNH3 etc.

Emissions_ml - Reads map of Annual N-deposition, or if USE_GLOBAL_SOILNOX
      reads global soil NO as before. (Will move all to Biogenics in
      another step.)

PhyChem_ml  added call Set_SoilNOx(I)
RunChem_ml - added rcbio, BIO_SOILNO
Setup_1d_ml - sets rcemis for soils only if USE_GLOBAL_SOILNOX
    (was if USE_SOILNOX)
Solver_ml - BIO_SOILNO

ZCM_EmChem09/EmChem09base.reactions - added rcbio(BIO_SOILNO,k)
ZD_OZONE/My_Derived_ml - added Emis_mgm2_SoilNNNN possibilities

Misc:

  Dust_ml - printout testing of dry_period

xxxxxxxx rv3_9_19, Peter 17th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

ForestFire emissions from "FINN":
http://bai.acd.ucar.edu/Data/fire/

Put new files in DataDir (Global, 2002 to March 2011, 0.1 degrees res).
NB: these files are produced with netcdf compression (needs netcdf version 4 to be read)

Modified:
ForestFire_ml
run.pl
(SubMet_ml)

xxxxxxxx rv3_9_18, Peter 17th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

Use new version of NetCDF
Change Makefile and Makefile_stallo
Some cleaning of makefiles also.

Remember to do a make clean or make depend.

Note: this version links to the dynamic library (.so , i.e. is linked at runtime). (The static 4.1.1
library (.a) on Stallo is broken now.)
The new version of netcdf allows onthefly (de)compression of data.
You must use a new version of ncview/ncdump to look at "compressed" data.
Update your path to ncview and ncdump to
/global/apps/netcdf/4.1.1/ncview-2.0b4/bin/ncview
/global/apps/netcdf/4.1.1/bin/ncdump
(or do a module load netcdf)

Small change in NetCDF_ml (ReadField_CDF, larger maxlat for safety).



xxxxxxxx rv3_9_17, Robert 16th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

Bug fix in organic aerosol (VBS) model. Earlier version had too low BSOA yield from terpene oxidation in low-NOx conditions. Increased VBS-yields by a factor 1.5 for TERPPEROXY+HO2 reaction.

   Updated file:
   ZCM_vbs_tests/VBS_SOAformation.reactions

run.pl (Dave) - added 2 directory checks to lessen confusion

xxxxxxxx rv3_9_16, Peter   14th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

NetCDF_ml:
Bug in ReadField_CDF /= corrected from >:
              if ( Rvalues(ijkn(k) )  /= FillValue ) then


!----------------------------------------------------------
xxxxxxxx rv3_9_15, Dave   14th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

Safer setting of debug_proc, through new subroutine in GridValues
(since best setting needed li0, li1, etc., and this info
only becomes available after Topology called.)

GridValues_ml - debug_proc code moved to separate subroutine

ModelConstants_ml - added DEBUG_GRIDVALUES

Unimod.f90 - call to DefDebugProc added


xxxxxxxx rv3_9_14, Robert 14th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

Updating GenChem.pl to use REAL values for molar weights rather than INTEGER.
         Important for the OA model version.

   ZCM_vbs_tests/VBS_SOAageing.reactions
      and
   ZCM_vbs_tests/VBS_partitioning.species
     - Added O_ASOA and O_BSOA species to the VBS-chemistry to keep track of extra oxygen added in
       aging reactions of SOA.


xxxxxxxx rv3_9_13, Dave, 11th Nov  2011 xxxxxxxxxxxxxxxxxxxxxxx

Bug-fixes

  Aqueous_n_WetDep_ml.f90 - small re-arrangement to stop use of
    negative kcloudtop as index  - caught by debug options in Makefile

  BLPhysics_ml.f90
      - added Kdef as required input to JericevicKz and BrostWyngaardKz
        Kz set to Kdef above Hmix
        (should optimise later, as subroutine probably)

   Met_ml
      - pass Kz_m2 (as calculated by Pielke/Blackader) as Kdef, see
        BLPhysics comments
        * Kz previously seems to have become undefined, or strange values




Extensions


  BLPhysics_ml.f90
     VogelezangHoltslag_Hmix added as option
     FluxPROFILE parameter added

  CellMet_ml,    USE_ZREF added - allows reference height to be
     different to lowest z_mid

  Derived_ml - start to simplify outputs, e.g. for HMIX, T2m, etc.
  My_Derived_ml - start to simplify outputs, e.g. for HMIX, T2m, etc.

  DryDep - small debug changes

  GridValues - small debug changes (as some code, and me, is getting
    confused by li0 vs. 1, etc.)

  Landuse_ml
     - added likely_coastal as logical
     - renamed rater_cover to more accurate water_fraction

   LocalVariables_ml - added z_ref as well as z_mid

   Met_ml
      - added "landify" - some in-testing code (commented out)
        may be used in future to ensure that grids with land-cover
        but defined as nwp_sea get their parameters from neighboroughing
        land

   MicroMet_ml
      - added Launiainen1995 possibility  - as default
        (avoids iteration in SubMet)

  ModelConstants_ml -  added USE_ZREF, see CellMet

  SeaSalt_ml - just changed name water_fraction
  Setup_1d_ml - just changed name water_fraction
  SoilWater_ml - just changed name water_fraction

  SubMet_ml - added use of FluxPROFILE == Ln1995 for testing
    (default is still iteration)


  Unimod.f90 - moved call to Topology before MeteoGridRead(cyclicgrid)

xxxxxxxx rv3_9_12, Robert 27th Oct 2011 xxxxxxxxxxxxxxxxxxxxxxx

Minor update of aging reactions for POA in VBS-model (slight increase
of Oxygen-addition for aged Wood Burning and Wildfire OA)

xxxxxxxx rv3_9_11, Hilde 19th Oct 2011 xxxxxxxxxxxxxxxxxxxxxxx

(rv3_9_10 accidently used earlier for rv3_7_10. Skip to 11 here)


Timefactors  - use iyr_trend instead of year

xxxxxxxx rv3_9_9, Robert 18th Oct 2011 xxxxxxxxxxxxxxxxxxxxxxx

  ZCM_EmChem09/EmChem09base.reactions - Changed the amount of RO2H formed in
  some RO2 + HO2 reactions to take into account formation of SOA

xxxxxxxx rv3_9_8, Hilde 18th Oct 2011 xxxxxxxxxxxxxxxxxxxxxxx
3 changes: 1)Explicit pH calculation (using ion balance, also including CO2-HCO3)
+ 2) change of seasonality of emissions + 3) use MARS for equilibrium

Aqueous_n_WetDep_ml.f90: pH calculation included
Timefactors: 10% change in summer/winter ratio over 10 years for SNAP 1 (Grennfelt&Hov)
My_Aerosols_ml.f90: call MARS instead of EQSAM
ModelConstants_ml: DEBUG_pH

xxxxxxxx rv3_9_7, Alvaro 17th Oct 2011 xxxxxxxxxxxxxxxxxxxxxxx

Output_hourly: Missing unit conversion (%unitconv) on COLUMN output type.
Only hourly column output for single species are affected.

xxxxxxxx rv3_9_6, Robert 17th Oct 2011 xxxxxxxxxxxxxxxxxxxxxxx

  ZCM_vbs_tests/VBS_SOAformation.reactions - Updated RO2 + HO2 reaction rates in the VBS-based SOA forming reactions (to be the same as in the EmChem09 photochemistry scheme), only influence the PCM model

xxxxxxxx rv3_9_5, Hilde, Dave 7th Oct 2011 xxxxxxxxxxxxxxxxxxxxxxx

  ZD_Ozone/My_Derived - set to re-include  some standard outputs

  GridValues_ml  - another change to stop debug_proc happening on
                   two processors

xxxxxxxx rv3_9_4, Dave   28th Sep    2011 xxxxxxxxxxxxxxxxxxxxxxx

   GridValues_ml: changed loop in GridValues to find debug_proc.
                  (old version found .true. on 2 processors, presumably
                   due to the overlap of domains)

vxxxxxxx rv3_9_3, Peter,23 September 2011  xxxxxxxxxxxxxxxxxxxxxxx

Minibug in error message ZD_OZONE/My_Outputs
(more changes to come)

xxxxxxxx rv3_9_2, Robert,23th August 2011 xxxxxxxxxxxxxxxxxxxxxxx

Minor update in SOA-model. Now include vegetation fire BC (FFIRE_BC) in the EC_f group.

xxxxxxxx rv3_9_1, Peter, 19th August 2011 xxxxxxxxxxxxxxxxxxxxxxx

T
NetCDF_ml
ModelConstants_ml
Nest_ml
OutputChem_ml
ALL the parameters (variables) are defined (created) in the NetCDF file before the data
is written in the first record.
Because of the way the netcdf is stored, all the data has to be copied each time a new variable is defined,
therefore it is very inefficient to add and write new variables succesively. See
http://www.unidata.ucar.edu/software/netcdf/docs/netcdf/Parts-of-a-NetCDF-Classic-File.html#Parts-of-a-NetCDF-Classic-File

This will not improve performance much in yearly runs, but will significantly help short runs: testing, CWF etc.


xxxxxxxx rv3_9beta, Dave, Peter, Robert, 9th - 11th August 2011 xxxxxxxxxxxxxxxxxxxxxxx

rtagged now - accumulates changes from   rv3_8_7 as listed below.


xxxxxxxx rv3_9_0beta?[not finished yet]  Robert, 11th August 2011 xxxxxxxxxxxxxxxxxxxxxxx

NOTE! This version is expected to give slightly changed results compared to
earlier versions (so should be given a new revision number)

ForestFire_ml: Changed the "assumed mass" for particulate OC emissions from wildfires from 0 to 12,
which has a big impact on forest fire OM emissions if the non-C part is modelled!
Important for partitioning OA-models!

Minor bug fix in Biogenics_ml (MW of isoprene changed from 64 to 68)
   -> Will give slightly different isoprene emissions

Updating mk.GenChem with new SOA scheme options (VBS)
   - Added a number of files in ZCM_vbs_tests (VBS_*.reactions and VBS_*.species, used by mk.GenChem to generate the VBS based chemistry schemes)

Many (still preliminary) changes in the VBS versions of My_SOA_ml and My_Derived_ml (in the ZCM_vbs_tests/ directory). Changed names for many of the help species and added possibility to store a number of new fields.

xxxxxxxx rv3_8_7d?  Peter, 10th August 2011 xxxxxxxxxxxxxxxxxxxxxxx

Problem in Nest_ml when nesting lon-lat grids. The debuggers show an error in:
call check(nf90_get_var(ncFileID, varID, lat_ext(1,:) ))
corrected into a safer version


xxxxxxxx rv3_8_7c  Dave, 9th August 2011 xxxxxxxxxxxxxxxxxxxxxxx
(We can merge all these changes into one rtagged cvs once we are
 done. I am not rtagging each one yet.)

GenChem.pl - now works even without seasalt. Unimod doesn't though :-(

run.pl - ProgDir added for CM_emislist.csv, CM_chempackages.txt

Nest_ml - RCA stuff commented out. Not consistent with CRI

xxxxxxxx rv3_8_7b  Robert, 9th August 2011 xxxxxxxxxxxxxxxxxxxxxxx

One major (only influencing VBS-model) and one minor correction/bug fix.

Updating the EMISSPLIT files for OC-emissions in the VBS-scheme.
     Earlier versions had an error in the MASS_ASSUMED.
     Now MASS_ASSUMED = 12 (emissions are assumed given in units of C)

Minor bug fix (should only influence the Log-files)

EmisGet_ml: Earlier version gave erroneous (too large) national total emissions
  in the log files if the same grid point occurs more than once in a given emission file.


xxxxxxxx rv3_8_7   Dave, 9th August 2011 xxxxxxxxxxxxxxxxxxxxxxx

FILE CHANGES!!!

   - mk.GenChem and GenChem  do more work :-)
   - No GenIn.reactions or GenIn.species
   - Instead, have sub-sets of these, e.g. EmChem09base, PMmass, ...
   - creates CM_emislist.csv and CM_chempackages.txt to be used
     in run.pl
   - Now, use mk.GenChem to select sub-sets of chemical schemes.
   - run.pl simpler for user because of these changes (no need to set emislist).

FILES REMOVED:
     My_Emis_ml   - not needed now. GenChem figures it out.
     GenIn.species, GenIn.reactions
     ZCM_vbs_tests/GenIn.reactions, GenIn.species  CM_BoundaryConditions.inc
      (the latter should be identical to the EmChem09.)

FILES ADDED:

Other small changes:

 EMIS_NAME becomes EMIS_FILE throughout code. (Easier for GenChem)

 Io_Progs_ml  datewrite formated extended to es11.3. Former 10.3
 merged with negative numbers.

 ZD_OZONE/My_Derived_ml - some CityZen outputs commented out.

 ZD_VBS/My_SOA_ml -  use of NVABSOM. In progress


xxxxxxxx rv3_8_6   Dave, Agnes,Mike  14th-15th July 2011 xxxxxxxxxxxxxxxxxxxxxxx

CityZen updates  (using ZCM_Eucaari_trends and Z_VBS directories)


   Country_ml
    Added countries 170, 171 for extended area

   DustProd_ml
    Moved DEBUG_DUST to ModelConstants_ml
    use CheckStop, not stop (avoids MPI problems)

   ZCM_Eucaari_trends
   ------------------
    Harmonise BICs:
    copied ZCM_EmChem09/SAFE- ... BICs to ZCM_Eucaari_Trends *and* ZCM_vbs_tests

    Changes in GenIn.species:
     Added AER_OM_F as helper species
     removed PM10, PMFINE groups from all SOA species. Only specify
     these groups for AER_OM_F and various EC components.

     Used PMGIANT group for SEASALT_G instead of PMCO - that is for
     the MMD=2.5um particles.

      EMISSPLIT - "_NEW" suffix dropped on emissplit.defaults.ecfi

   ZD_VBS
   -------

   My_Emis_ml added as default for VBS, with ocfi, ecfi. This is a temporary
   measure until GenChem sorts out which emissions are needed.

   My_SOA_ml:  use of AER_OM_F, ECFINE added

   My_Derived_ml: use of AER_OM_F. Commented out some ugN outputs, added
   ug/m3 and some cityzen requests.

   ZD_OZONE
   --------
     hr_out only for O3 as default.

xxxxxxxx rv3_8_5     Dave  10th July 2011 xxxxxxxxxxxxxxxxxxxxxxx

  Derived_ml - comment line corrected

  EmisGet - improved error messages (needed!)

xxxxxxxx rv3_8_4     Dave   9th July 2011 xxxxxxxxxxxxxxxxxxxxxxx

  BICs re-instated for C2H6 and CH3CHO (had ben dropped at some stage), but
  not with much lower CH3CHO than before - 0.3 ppb instead of 2ppb.
  Small effect on concentrations, with only PAN being slightly higher now.

  Another small bug found, we had a reaction [OH] + C2H6  which
  should have been [OH] + C2H6_BIC in old code, now deleted

  SUGGEST FOR OPEN-SOURCE

xxxxxxxx rv3_8_3  ...Peter  6th July 2011 xxxxxxxxxxxxxxxxxxxxxxx
                     Dave  22nd June 2011 (minor)

Two (small) bugs in the interpolation routines for the Aircraft emissions. (ReadField_CDF in NetCDF_ml)
When the surface pressure of standard atmosphere is smaller than the pressure read from SurfacePressure.nc, the standard surface pressure was modified for all cells in the subdomain, giving a dependence on the number of procs. The differences have only numerical significance.
Also changed the definition of "maxlon" in the routine as, this also could potentially lead to (small) errors.

NB: we still have as default:  USE_AIRCRAFT_EMIS  = .false.


Met_ml -- minor change, > changed to >= for JericevizKz (presumably
   v. little diff, if any.)

Rsurface - comments improved for HNO3 low-temp correction


xxxxxxxx rv3_8_2,  Dave/Svetlana/Birthe 20th June 2011 xxxxxxxxxxxxxxxxxxxxxxx

                                      *******************************
 USED FOR SOURCE RECEPTOR JUNE 2011   = EMEP/MSC-W version v.2011-06
                                      *******************************

io_min set to IOU_YEAR is SOURCE_RECEPTOR

xxxxxxxx rv3_8_1,  Dave/Svetlana 19th June 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

  *** BUG fixed and BUG found (not solved!) ***

  *** If USE_AIRCRAFT_EMIS is set .true. the results are slightly
      processor dependent. If false, they aren't. Set as .false.
      for now.
      Previous runs also seem to have only had aircraft emissions in
      bottom 6 levels of model, so pretty low-flying aircraft in any
      case.

Biogenic_ml - extra initialise (not needed I think, but safe)
              use limax instead of MAXLIMAX
              small tidy-ups

BoundaryConditions_ml - special treatment for sea-salt added. Set BICs to 1%
               over land areas.
               Various safety debugging added datewrite

Emissions_ml - problems found, not fully resolved. airn was set from
    KEMISTOP to KMAXMID, whereas it should from KCHEMTOP.

GlobalBCs_ml - * bug-fix * Removed Grid%is_NWPsea code.
                 small extra comments on sea-salt.

My_Derived_ml -  change PM25 to PMFINE, since PM25=PMFINE+0.5*PMCO
               (density removed from My_DerivFunc call - not used)

Sites_ml - added PM25 = PMFINE + 0.5*PMCO

ZCM_EmChem09/
   GenIn.species - removed CO_BIC, C2H6_BIC,
                   ** change PM25 to PMFINE, since PM25=PMFINE+0.5*PMCO
                   removed "anthro" groups
   GenIn.reactions - removed CO_BIC
   SAFE_BoundaryConditions.inc - removed CO_BIC, C2H6_BIC

Small clean-up after gfortran pedantic check:
   (mainly removing unused variables.)
    ChemFunctions_ml
    DefPhotolysis
    Derived_ml (density removed from My_DerivFunc call - not used)
    DustProd_ml
    Ecosystem_ml
    LandPFT_ml
    MassBudget_ml
    Met_ml
    Nest_ml
    NetCDF_ml
    Setup_1d_ml (initialised some rc rates also)
    Solver_ml


xxxxxxxx rv3.8s,  Dave       15th June 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

(s= back to simpler kaero, after many many tests)

Aero_Vds:
New Dp for coarse aerosol, Dp=2.5um. Hence 50% in PM25, 50% in PMco

ZCM_EmChem09/GenIn.reactions:
Decided on kaero in  HNO3 -> NO3_c

xxxxxxxx rv3.8,              24th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

 PUBLIC-DOMAIN RELEASE :-)

 Input.tex small change (for dust module) from Svetlana

xxxxxxxx rv3_7_10, Dave      24th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

CellMet_ml: fixed snowice following query of Guus Velders

ChemFunctions_ml:

    Riemer - included NO3_c (for robustness) and reduced rate by factor
    2 for OA effect (RIemer et al., 2009)

    kaero2 - only over sea squares, and mainly for levels  k=16..20

    ***  =>  results do change ****


EmisGet_ml:  added explanation of possible need for SEAFIX in checkstop
    comment

xxxxxxxx rv3_7_9b Svetlana,  24th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxx

Some fixing in DustProd_ml.f90

xxxxxxxx rv3_7_9b Robert,    20th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Added emissplit files for TNO/EUCAARI style EC/OC emissions

xxxxxxxx rv3_7_9 Dave,    20th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


mk.OpenSource added - ** prelim ** script to automate generation of
    OpenSource directory
    (only partially working. creates directory okay and compiles.
     Need to add inputs directory later also)

gpl.txt added to directory
Makefile.Open added (copied from OpenSource)

xxxxxxxx rv3_7_8 Peter,   12th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Upgrade of the Nest_ml routines.
Can use non-emep netcdf files for BC/IC; flexibilities introduced for nesting:
-vertical coordinates can be hybrid, downwards or upwards, possibly defined in an ad-hoc file (ifs-mozart)
-number of records in each file can be: 1 (RCA), some (mozart), all (emep), variable (transphorm)
-time can be defined with any "days since" date
-time can be defined in a 365days convention, but still use 29th of February (mozart!)
-IC and BC files can be different
-chemical components to be nested can be selected and to some degrees added together
-units can be PPB
-short accepted

The number of opportunities for bugs is huge...

NetCDF_ml: ReadTime more general. Compatible with 365 days calendar
SmallUtils_ml: wordsplit with ":" as sepaparator and an optional separator as input (dates need "-" as separator)
Met_ml: allow to read ustar_nwp instead of tau (for WRF)
PhyChem_ml: thour defined as = current_date (was shifted by 0.5 dt_advec before) NB: this will slightly modify results!
            timings for nesting read and write

Tove/Dave, 11th May 2011
(Small change for vbs only)

ZCM_vbs_tests/My_Derived  use My_Emis_ml instead of  EmisDef_ml

xxxxxxxx rv3_7_7 Peter,   9th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug in Nest_ml, when the IC file is different from the BC file (allocated to small ndays_ext).

xxxxxxxx rv3_7_6 Dave,   6th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

   ***** New emissions setup in GenIn.reactions etc.

   ** My_Emis_ml  is now back, but hopefully easier than before.
   ** CM_Emis.inc removed
   ** CM_EmisSpec.inc created by GenChem
   ** run.pl now uses MonthlyFac.pm25 for unknown emissions labels,
      removing earlier usage of ocfile, ocffl, etc.

   ** Emissions are now at lower heights.


   EmisDef - lower heights for emissions
   EmisGet - deals with new emissions, and checks that we have all
             that are needed (compares emissplit files to CM_EmisSpec list).
   GenChem.pl - changed for new rcemis
   Makefile.SRCS added My_Emis_ml.f90

   ZCM_EmChem09 files adapted for above
   ZCM_vbs_tests files adapted for above for PM25 usage
   ** EMISSPLIT directory added to ZCM_vbs_tests
      (All $Chem should have an EMISSPLIT directory, see below)


  Explanation of main change
  ---------------------------
  In the GenIn.reactions files we now use e.g.:

  rcemis:POC_FFUEL_f =

  then GenChem will make a list of the species which are wanted in
  CM_EmisSpecs.inc, here POC_FFUEL_f.  (the old system needed the name
  of the emission  file, which here was sometimes pm25, sometimes ocfile,
  sometimes ocffl.)

  If the run.pl provides PM25 emissions, the emissplit.defaults.pm25 (which
  should be part of the ZCM_ directory) needs to have POC_FFUEL_f. If
  run.pl provided POC emissions, then emissplit.defaults.ocff would need
  to include the POC_FFUEL_f.

  Thus we let GenChem tell the code which species it needs, and the user
  has to make sure that for that chemistry there are appropriate emissplit
  files.

  EMISSPLIT directories should contain all the emissplit.default etc. files.
  Note that we can have emissplits for many different "grid" files, they do
  not have to be used. Thus, we can have emissplit for "PM25" in the case
  that we run gridPM25, and also an emissplit.defaults.ocfile in case we
  are running with gridOCfine. No need to change GenIn. files or Unimod :-)

xxxxxxxx rv3_7_5 Agnes, Robert 5th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Agnes:
Mace Head correction for 2009 is included in GlobalBCs_ml.f90

Robert:
Changed the SOA (VBS) scheme. Now using higher SOA yields from AVOCs and include aging of ASOA, BSOA and POA.
                              Also include dry deposition of gaseous fraction of semi-volatile OOA (ASOA, BSOA and OPOA).

Modified: ZCM_vbs_tests/GenIn.species
          ZCM_vbs_tests/GenIn.reactions

xxxxxxxx rv3_7_4 Svetlana  4th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

More Bugs fixed:
1. Double declaration of DO_SAHARA in ModelConstants_ml.f90 and GlobalBCs_ml.f90 - Deleted from GlobalBCs.
2. In NetCDF_ml.f90 - correction for number of levels for hourly 3D and columns outputs  [KMAXcdf =min(KMAXcdf ,NLEVELS_HOURLY)]

xxxxxxxx rv3_7_3 Dave  4th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

    ***** MAJOR BUG fixed *******

    - IBC_CO   reset to 125 from 5 ppb. Bug introduced in rv3_7rc6 - do
    not use any of the versions after that, including the open-source!

xxxxxxxx rv3_7_2 Robert 13-15th April xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Very minor update:
Modified the SOA (VBS) code slightly. Replaced the NONVOLOC_GROUP and NONVOLEC_GROUP by NONVOLPCM_GROUP (since these groups are only used for partitioning semivolatile OA between gas and particle phases)

Modified: ZCM_vbs_tests/GenIn.species
          ZD_VBS/My_SOA_ml.f90

Updating the SOA (VBS) scheme to include EmChem09 chemistry (earlier versions based on EmChem03)
First test runs: After a bug fix in ZD_VBS/My_Derived_ml.f90 the SOA-code runs. More bugs are still likely. So check results carefully if you run the SOA-model!

Updates should only affect the SOA version of the model.

Modified: ZCM_vbs_tests/GenIn.reactions, GenIn.species, CM_BoundaryConditions.inc
          ZD_VBS/My_Derived_ml.f90, My_SOA_ml.f90

xxxxxxxx rv3_7_1  Peter 12th April xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

First version of a Nesting with general vertical coordinates. Can use external BIC files such as
MOZART or TRANSPHORM. Needs still some testing and filenames are hardcoded for now.
When new external file are included, more flexibility can be introduced.
Should be backwards compatible. The vertical coordinates are read from the info in the netcdf files,
or an external file in the case they are not found (MOZART).

Modified: Nest_ml, ModelConstants_ml,NetCDF_ml.

xxxxxxxx rv3_7rc12 Peter 8th April xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

My_Outputs_ml: output the entire grid (old was for emep grid, not eecca)
EmisGet and EcoSystem: changed write to screen format for compatibility with gfortran

xxxxxxxx rv3_7rc11 Dave and Peter 31th March xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Repaired massbudget; temporary fix.
The wdep was no longer calculated in Aqueous_n_WetDep

DEBUG_i= 0, DEBUG_j= 0 in ModelConstants to remove debug outputs.

xxxxxxxx rv3_7rc10 Dave 30th March xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SEAFIX_GEA_NEEDED - logical replaces previous fix for GEA data. (Used
to be if ( DomainName == "HIRHAM" .and. IIFULLDOM == 182 ) ...
Changes to: Country_ml, ModelConstants_ml

MassBudget_ml - printout of fracmass hidden in EXTENDEDMASSBUDGET test,
                 since the calculation is broken somewhere

My_Derived_ml - many outputs removed, including 3d

Formatting in GetEmis_ml, remove Reimer from Solver_ml,
   copyright -2011 in  many routines.

xxxxxxxx rv3_7rc9 Peter 25-28-29th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Cleaning the standard output (screen output)
Modified (at least):
EmisGet_ml.f90 Landuse_ml.f90 EcoSystem_ml.f90 Derived_ml.f90
Aqueous_n_WetDep_ml.f90 Io_Progs_ml.f90 Sites_ml.f90 Emissions_ml.f90
AirEmis_ml.f90 BoundaryConditions_ml.f90 NetCDF_ml.f90 MassBudget_ml.f90
GlobalBCs_ml.f90 Met_ml.f90 Biogenics_ml.f90 DryDep_ml.f90 Advection_ml.f90
ModelConstants_ml.f90 Unimod.f90 PhyChem_ml.f90 CheckStop_ml.f90

Model stops if no specials 'voc'.and.USE_FOREST_FIRES
printCDF overwrites any existing file (i.e. only one field can be saved)

xxxxxxxx rv3_7rc8 Dave 25th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

USE_CONVECTION = .false.


xxxxxxxx rv3_7rc7 Dave/Birthe 24-25th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave:


BVOC inputs changed. Just now run.pl hard-coded to read from mifads directory.
Will recode when benchmarked

Biogenics_ml       - Small re-write to cope with latest EMEP_EuroBVOC.nc
                     now copes with BVOC from wetlands, tundra.

DryDep_ml          - cleanup (could be improved)

Met_ml             - StopAll called if soil water attempt on IFS meteorology

ModelConstants_ml  - USE_CONVECTION set true - regretted later!

Rsurface_ml        - cleanup (could be improved)

run.pl             - points to Inputs_Mar2011 for Inputs*csv
                     and EMEP_EuroBVOC.nc

SubMet_ml          - NITER set to 1 again. Simpler

Birthe:
DOC changes

xxxxxxxx rv3_7rc6 Svetlana Mar 22th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
More improvement on sea salt:

Aero_Vds_ml.f90             - diameter of 'giant' particle
BoundaryConditions_ml.f90   - BICs for 3 size fractions of sea salt
GlobalBCs_ml.f90            -  --   #  ---- # ----- # ----
ZD_OZONE/My_Derived_ml.f90  - SEASALT_G is in
ZCM_EmChem09/SAFE.CM_BoundaryConditions.inc - BICs for 3 sizes of sea salt

xxxxxxxx rv3_7rc5 Dave Mar 16th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

BLPhysics - small tidy
BoundaryConditions_ml  & GlobalBCs_ml
  - replaced uneeded OH and CH3COO2 stuff with SEASALT_F,C
   (skip G for now. They don't travel far)
ChemFunctions_ml - added kero2 with slower rates  and limit to k>=10
ModelConstants_ml - sets USE_SOILWATER false. IFS stuff too hard for now!
Setup_1d_ml - mini clean up
Setup_1dfields_ml - clean up

ZCM_EmChem09/GenIn.reactions - use kaero2
ZCM_EmChem09/SAFE.CM_BoundaryConditions.inc - added sea salt
ZCM_EmChem09/EMISSPLIT - voc files re-commented

xxxxxxxx rv3_7rc4  Alvaro, Dave, Peter  Mar 15 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave+Peter:
More soil water changes + bug-fix for ws_10m

Landuse_ml - water_cover_set flag added. Needed since water_cover not
     available until nterm > 2

Met_ml .... further manipulation of SoilWater_deep values:

       ! Take a 5x5 average of the land-weighted values for SW. Seems
       !  best not to "believe" NWP models too much for this param, and
       !  the variation in a grid is so big anyway. We aim at the broad
      !  effect. (Alternattve might be to find max values?)

       Also, shallow soil water "switched off" if units /= "m". Seemed
       safest for OpenSource2011

       bug-fix on sw_10m

ModelConstants_ml - smal re-arrangement (alphabetical debugs)

Mosaics_ml  - DEBUG added in "MOS f2D" output

SoilWater_ml, simplified since code now in Met_ml

run.pl  $MetDir added to RunLog outputs. Source of met for 2008 was getting
        confusing!

Alvaro's changes:

Treatment of NetCDF output on FORECAST & SOURCE_RECEPTOR modes:
  - NetCDF files: create only when necesary
  - SOURCE_RECEPTOR mode: no IOU_DAY output
  - FORECAST mode: only IOU_DAY & IOU_HOUR output

run.pl: Small bugx-fix in FORECAST mode

Derived_ml: New public variables iou_min & iou_max contain the min & max
  admisible values for def%iotype to be written out:
  - by defount this correspond to the minval & maxval of f_2d%iotype & f_23%iotype
  - in SOURCE_RECEPTOR mode iou_max=IOU_MON
  - in FORECAST mode iou_min=IOU_DAY

OutputChem_ml: new logical function wanted_iou, to determine if a particular
  def%iotype is to be written out:
  - wanted_iou uses of iou_min & iou_max
  - Output_f2d & Output_f3d use wanted_iou
  - use date2string (TimeDate_ExtraUtil_ml) to generate monthly (ASCII) filenames
  - Additional indent & code formatting

Unimod: use wanted_iou to determine if a particular NetCDF file is needed

xxxxxxxx rv3_7rc3  Peter, Dave     Mar 14-15 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxx

ERF removed from Functions_ml

Bug corrected 15 March in Met_ml: ws_10 no more high.
INTERIM version. ws_10m seems high

Met_ml.f90: read units and transform deep_soil_water
Met_ml, MetFields_ml, FUTURE_NH3Emis_variation_ml: read wind speed at 10 meters
   into ws_10m removed the parts that defined u10 and v10 separately.

   Added subroutine extendarea to get an array containing neighbours beyond
   MAXLIMAX, MAXLJMAX. Used in SoilWater_ml to average over 3x3 area

Met_ml : dave added temp2 while trying to figure out why sw_10m is so high.
         Should be removed once explanation found!

SeaSalt_ml - modified to use ws_10m, but this ws_10m v. high compared to u_ref
             bug in ws_10m?

SoilWater_ml - now works with IFS and 3x3 average values. The latter needed
            to cope with coastal areas, and adds some robustness (hopefully)

Solver_ml : now switches off Reactions1 if DEBUG_DRYRUN = .true.
            saves some CPU when testing e.g. soil-water or sea-salt
            (sea-salt calcs are in Reactions2)


xxxxxxxx rv3_7rc2  Dave           Mar 13 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxx

Biogenics_ml corrected and cleaned. Notation updated.
  No BVOC_2010 option now - this is the only method. IQ_DMS moved to
  EmisDef_ml, first_dms_read moved to Emissions_ml
  Replaces ExportBIO routine with calls to new printCDF routine

Aqueous_ml - some print-outs moved to DEBUG

Derived_ml - cleanup and DEBUG changes

DryDep_ml  - NO2fac re-instated (for now, until we get a proper soil-NO
              treatment)
             Tidy-up, use of SO2 instead of IXADV_SHL+IADV_SO2 etc.

EmisDef_ml - IQ_DMS added

Emissions_ml - first_dms_read put here

MetFields_ml - small extra tidy-up

ModelConstants_ml - no BVOC_2010 option.

NetCDF_ml  - printCDF added - for "easy" output to cdf in e.g. debugging,
               call printCDF("Example,array,"ugS/m3")

Rurface_ml - small tidy up. Still could do with more (snow)

SeaSalt_ml - changed copyright dates

SetUp_1d_ml - cleaned
Unimod.f90 - BVOC_2010 stuff removed.

run.pl - Inputs.BVOC line removed

ZD_OZONE/My_Derived_ml - DEBUG change

ZCM_EmChem09 - reme kaero HNO3 -> NO3_c reaction. Seems to do
   more harm than good.

xxxxxxxx rv3_7rc1  ALL            Mar 11 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxx

labelled for Benchmark, for comparison to earlier.
End of changes for this busy week I think!

xxxxxxxx h18:15    Svetlana       Mar 11 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxx

Final version of SeaSalt_ml.f90 with 'giant' bin and
adjusted giant diameter Aero_Vds_ml.f90

xxxxxxxx h16:14      Peter      Mar 11 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

put an older version of Met_ml as the present one had wrongly replaced integer*2 with integer

xxxxxxxx h15:35      Svetlana       Mar 11 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

ERF function is removed from Functions_ml.f90 and DustProd_ml.f90

xxxxxxxx h15:20      Peter       Mar 11 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

run.pl: landsea_mask.dat, lightning$mm.dat
AirEmis: lightning.mm.dat
modrun.sh

xxxxxxxx h14:00      Peter       Mar 11 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

ModelConstants_ml: defined EECCA as domain and rundomain (and 8*4 procs)
GlobalBCs_ml:  added case (IBC_H2O2, IBC_OH, IBC_CH3COO2)     bc_rawdata=1.0E-25
(these were not set at all)

run.pl:
link EMEP_EuroBVOC_KRS09.nc to  EMEP_EuroBVOC.nc
link GLOBAL_O3.nc to GLOBAL_O3.nc (instead of GLOBAL_Boundary_and_Initial_Conditions.nc)

Cleaned by Joffen: Aqueous_n_WetDep_ml.f90, Convection_ml.f90

xxxxxxxx h11:00      Svetlana       Mar 11 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

In ModelConstants_ml.f90
logical, public, parameter :: USE_SEASALT      = .true.
logical, public, parameter :: USE_AOD          = .false.
logical, public, parameter :: USE_FOREST_FIRES = .false.
Correspondent modifications in Runchem_ml.f90, Solver.f90, Setup_1d_ml.f90
........................................

Aero_water_ml.f90 changed to MARS_Aero_water_ml.f90 (as it had the same name
as subroutine Aero_water() in My_Aerosols_ml.f90)
Correspondent changes in MARS_ml.f90 and Makefile.SRCS

ForestFires_ml.f90: len=TXTLEN_SHORT is assigned to emep_poll, gfed_poll
instead of too short len=10

xxxxxxxx h23:15       Alvaro       Mar 10 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

My_Outputs_ml,OwnDataTypes_ml,Output_hourly:
  - Move Asc2D data type from My_Outputs_ml to OwnDataTypes_ml
  - Extennd lenght of Asc2D%name,type,unit from TXTLEN_NAME
    TXTLEN_DERIV,TXTLEN_SHORT,TXTLEN_SHORT respectively
  - remove unused variables from use,only statements.
  - Additional indent & gFortran-pedantic cleanup.

Setup_1d_ml:
  - remove unused BGN_2D variable from use,only statement.

TimeDate_ExtraUtil_ml:
  - add ncdate2string function for nctime (seconds/days since ...) to formatted
    string conversion.

BoundaryConditions_ml
  - use PPB parameter from Model_Constants_ml instead of local variables.
  - remove unused variables from use,only statements.
  - replace WRITE by PRINT statements on debut printpouts.
  - replace me==0 by MasterProc

GlobalBCs_ml
  - replace USso2trend,USnoxtrend,USnh4trend by a own data type to shorten
    its definition.
  - replace UStrend & macehead_O3 if/else definitions by a select/case statement.
  - use date2string (TimeDate_ExtraUtil_ml) to generate monthly filenames.
  - replace WRITE by PRINT statements on debut printpouts.
  - remove unused variables from use,only statements.
  - Indent & gFortran-pedantic cleanup.

LocalVariables_ml:
  - Indent & gFortran-pedantic cleanup.

Unimod:
  - replace newseason if/else definition by a select/case statement.
  - replace WRITE by PRINT statements on debut printpouts.
  - remove unused variables from use,only statements.
  - Indent & gFortran-pedantic cleanup.

Volcanos_ml:
  - replace WRITE by PRINT statements on debut printpouts.
  - replace hardcoded 64.0 by species(SO2)%molwt.
  - remove unused variables from use,only statements
  - Indent & gFortran-pedantic cleanup.

xxxxxxxx rv3_7beta32  ALL - cleanup by 17:30 on Mar 10th xxxxxxxxxxxxxxxxxxxxxxx

rtagged for safety and benchmark

xxxxxxxx h08:45       Dave       Mar 10 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Add USE_AIRCRAFT_NOX; USE_LIGHTNING_NOX to ModelConstants_ml
  Changes in Unimod.f90, Setup_ml, Airnox_ml

xxxxxxxx rv3_7beta31  Anna/Dave  Mar 9 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Interim, but changes committed due to impending cleanup! Results may change
because of snow/ice !

Main changes: Usage of old climatology files removed. Left as !ACB comments
    for now, but will clean those out after testing

    files: CellMet_ml, DryDep_ml, DustProd_ml, Emissions_ml, Io_Nums_ml,
           LocalVariables_ml,  MetFields_ml, Rsurface_ml

Science change: ice_nwo now used! Was a bug that it wasn't used before!
                 Still needs thought in DryDep module, but should be okay
                 in SeaSalt_ml

Derived_ml, My_Derived_ml

  Snow_m added as output


  Renaming of variables: most modules have changes!!!
  -----------------------

  my %swaps = (
    gl_fdom => "glon_fdom"
   ,gb_fdom => "glat_fdom"
   ,gb      => "glat"
   ,gl      => "glon"
   ,ice     => "ice_nwp"
   ,water_fraction     => "water_cover"
   ,snow     => "snow_flag"
  );

xxxxxxxx rv3_7beta30  Svetlana   Mar 9 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Introduced an extra size bin ('giant') for sea salt
SeaSalt_ml.f90                - extra 'giant' size bin
Aero_Vds_ml.f90               - Vd for giant size (d=8.8 um)
Aqueous_n_WetDep_ml.f90       - scavenging ratio for SSg
My_Aerosols_ml.f90            - NSIZE = 3
Wesely_ml.f90                 - new CDDEP_PMg = 15 and AERO_SIZE=3
EmisDef_ml.f90                - QSSGI index
Solver.f90
-----
ZCM_EmChem09/GenIn.species
             GenIn.reactions

xxxxxxxx rv3_7beta29  Alvaro   Mar 8 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Small bug fixes

run.pl
  - Re-introduced small bug fix from rv3_7beta14, which got lost in rv3_7beta18.
    On SR runs, only AL was reduced.

Output_hourly:
  - Bug fix introduced in rv3_7beta18.
    COLUMNgroup hourly output type was wrongly calculated.
  - Scale factor (f_2d(ispec)%scale) was not used for D2D hourly output type.

Setup_1d_ml:
  - small bug fix regarding rh(k) min & max values, introduced in rv3_7beta24.

Unimod:
  - Fix bug regarding D2D hourly output:
    D2D output fail to find correct index based on f_2d%name.
    The reason is that set_output_defs was called before Init_Derived.
    Therefore, f_2d was not defined when f_2d%name was searched.

Nest_ml & ModelConsants_ml:
  - NEST_MODE introduced in rv3_7beta25 was not being used on Nest_ml.
    Now NEST_MODE is declared as a public parameter in ModelConsants_ml,
    and is used in Nest_ml (ModelConsants_ml, only: ...MODE=>NEST_MODE...).

Nest_ml:
  - type(deriv) components inst, month, year, day where still "in unuse"
    in wrtxn. The lines where commented with !FEB2011 and replaced
    with the corresponding iotype.

Hourly accumulated Dry & Wet depositions available trough D2D hourly output type.
All accumulated D2D variables are now outputted as Hourly accumulated values,
instead of instantaneous values (previous behavior).

ModelConsants_ml:
  - Introduce IOU_HOUR_PREVIOUS=5 (ModelConsants_ml)

Derived_ml:
  - Introduce explicit dependence between LENOUTxD and IOU_*.
    Define LENOUT2D = IOU_HOUR_PREVIOUS and LENOUT3D = IOU_DAY.

Output_hourly:
  - modify D2D hourly output type
    - non accumulated D2D variables (f_2d%avg) are access trough IOU_INST.
      This was the behavior for all D2D variables until version rv3_7_beta21.
    - accumulated variables (.not.f_2d%avg) are now calculated as the
      difference between IOU_YEAR and IOU_HOUR_PREVIOUS.
    - if(hr_out%unit=="")f_2d%unit is used
    - f_2d%scale is always used in conjunction of hr_out%unitconv

My_Outputs_ml:
  - add "sox_wdep" variable to standard hourly output,
    in order to test D2D hourly output type. The max difference between
    WDEP_SOX from fullrun sox_wdep (hourly accumulated variable) and
    is ~1e-4 mgS/m2. This additional variable can be commented on future versions.

Modified handling of start/end dates to allow multi-year runs.
This feature is needed in FORECAST mode, but it is also available for non forecasts.

run.pl:
  - replace $startyear/month/day & $endmonth/day variables for $startdate and $enddate.
    Each $start/$enddate is a string in "YYYY MM DD" format.
    In non FORECAST runs both the YYYY fraction of $startdate and $enddate
    have the same value ($year). In forecast runs $start/$enddate are set
    accordingly to $CWFDATE[1] (forecast start date) and $CWFDATE[2] (end date)
  - remove calc_nterm

Unimod:
  - modify reading of start/endate arrays, so each date is read from a single line.

New module TimeDate_ExtraUtil_ml
this new module contains more specific utilities than TimeDate_ml, such as:
   * assign_NTERM:  previously in TimeDate_ml)
   * dayssince1900: previously in NetCDF_ml
   * datefromdayssince1900: previously in NetCDF_ml, Nest_ml & Met_ml

TimeDate_ExtraUtil_ml, Makefile.SRCS:
  - new module TimeDate_ExtraUtil_ml
  - re-write assign_NTERM, *date/scondssince* procedures
    to take advantage already defined time tools (TimeDate_ml)
    such as tdif_secs. New assign_NTERM code can deal with multi rear runs.
  - nctime2date and date2nctime interfaces take advantage from the
    fact that the current time variable in our netCDF files
    (dayssince1900) is a real variable, while the old one
    (secondssince1970) was an integer variable.
  - date to string conversion function based on string keywords:
    date2string replaces several text keywords by the corresponding
    year, momnt, day, ... for a given date, e.g.
    create a file name from a date2string:
      filename_read_BC=date2string('EMEP_IN_BC_YYYYMMDD.nc',indate)
    time stamp an error message
      call CheckStop( mod((ihh-1)*METSTEP+nhour_first,24), ndate(4),  &
          date2string("NetCDF_ml: wrong meteo hour YYYY-MM-DD hh",ndate))

TimeDate_ml:
  - Add tdif_days & add_days functions
  - move assign_NTERM to TimeDate_ExtraUtil_ml (new module)

NetCDF_ml:
  - move dayssince1900 & secondssince1970 to TimeDate_ExtraUtil_ml,
    and use general date2nctime interface instead
  - remove datefromdayssince1900, which was unused

Nest_ml & Met_ml:
  - move datefromdayssince1900 & datefromsecondssince1970 to TimeDate_ExtraUtil_ml,
    and use general nctime2idate interface instead

Io_Progs_ml:
  - Include an optional input variable (txt_pattern) into datewrite,
    which indicates if the input text is to be phrased trough str_pattern.
    E.g. the "standard" datewrite call:
      call datewrite("Test", (/ a1, T2, rh /) )
    can be extended into:
      call datewrite("Test YYYY-MM-DD hh:mm:ss",&
                     (/ a1, T2, rh /), txt_pattern=.true.) ! extended call

Unimod, Nest_ml & Met_ml:
  - use date2string for time stamping CWF-dump messages (Unimod),
    obtaining the BC file name on FORECAST mode (Nest_ml) &
    adding date information to error messages.

Other Updates

My_Outputs_ml, Output_hourly:
  - use groups system: chemgroups instead of GROUP_ARRAY & INDEX_XXX_GROUP.

Open Source Clean-ups:

SmallUtils_ml:
  - add optional option 'debug' to find_index & find_indices,
    in order to printout additional debug information.
  - Indent & gFortran-pedantic cleanup.

TimeDate_ml
  - re-write leapyear and Init_nmdays in a simpler fashion
  - a default result was added to y4dig
  - Indent & gFortran-pedantic cleanup

Output_hourly:
  - Remove/update old comments, indent & gFortran-pedantic cleanup

Nest_ml:
  - replace me==0 by MasterProc
  - Indent & gFortran-pedantic cleanup

Io_Progs_ml:
  - Indent & gFortran-pedantic cleanup

ModelConstants_ml
  - Indent & cleanup code

xxxxxxxx rv3_7beta28 Mar  1 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Main change is usage of iotype in f_2d Deriv arrays. Changes lablled with
FEB2011, pending merge with Alvaro's version and checks for FORECAST mode.

Derived_ml,

   Replaced inst, month, year, day logicals in Derived_ml by integer iotype
   Changes marked with !FEB2011 for now. Will clean up once more changes
   made

My_Derived_ml
    Similar changes, also Mosaic outputs had one extra field for units.
    (now typ_s5i)

Ecosystem_ml - iotype

Mosaics_ml

    Init_MosaicOutputs routine removed. Hardly did anything!
    typ_s5i replaces typ_s4 (am iterating towards full Deriv type!)
    iotype used as input arg to subroutines -set in My_Derived
    find_MosaicLC function added to assign correct LC index,
    acccounting for FULL_GRID=0 (Grid or EU cases)

NetCDF_ml
    iotype usage added
    more error messages in check calls
    commented out def1% inst, month, year, day   - anyway not used

OutputChem_ml
    iotype usage added
    QUERY - need to check usage for FORECAST especially

Unimod.f90
     iotype usage added.

Biogenics_ml, ForestFire_ml, Nest_ml
   commented out def1% inst, month, year, day   - anyway not used

xxxxxxxx rv3_7beta27 Feb 28 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Removed NTERM from run.pl. Instead endday and endmonth are defined and
NTERM is calculated in the model.
Also removed NASS, which was not used anyway.

Note: if enddate is before startdate, 3-hour run is performed.
      if endday is larger than the number of days in the month (for example
        endday=33), it is set as the number of days of the month; this is
        to avoid thinking about leap years etc.
      The new code will not work with old run.pl, since the variables read in have changed.

NB: CWF runs are broken now. run.pl is not yet updated for CWF!

Unimod.f90: call assign_NTERM(NTERM). Better comments when wrong number of PROCS.
TimeDate_ml:defined assign_NTERM(NTERM) and moved startdate,enddate there.
Met_ml: moved startdate,enddate out of this module
ModelConstants_ml and MassBudget_ml: defined EXTENDEDMASSBUDGET to be set
                        as true if all the massbalance output is required

modrun.pl: completely changed and simplified

xxxxxxxx rv3_7beta26 Feb 28 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Derived_ml - bug fix***  Emis_mg_xxxx now factor of 3 lower. Had wrong
   setting for dt-scale

OutputChem_ml


xxxxxxxx rv3_7beta25 Feb 24 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

NEST_MODE moved to ModelConstants_ml from Nest_ml

Small tidy ups:

EmisGet_ml.f90
Emissions_ml.f90
ForestFire_ml ( changes to prevent many printouts if < 2000 or > 2007)
MosaicOutputs_ml.f90
OwnDatTypes_ml.f90
Tmp_Met_ml.f90

xxxxxxxx rv3_7beta24  Dave   Feb 20 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Clean-up list added to Log.changes - please use!

N2O5_hydrolysis_ml removed - was not being used!

Setup_ml - added max (RH; 1.0e-5) - stops negative RH! (Maybe doesn't
affect results since eg N2O5 usage is only for RH>0.4).

Small tidy-ups:

Aqueous_n_WetDep_ml
ChemFunctions_ml - made VOLFACs public
ModelConstants_ml - added DEBUG_SOLVER, DEBUG_AEROSOL
My_Aerosols_ml
My_Outputs_ml (also added PAN to default SONDE outputs)
Runchem_ml  -  also has some extra debugging code, which I wil remove
               later after implementing N2O5 hydrolysis changes.
Solver_ml   -  also has some extra debugging code, which I wil remove
               later after implementing N2O5 hydrolysis changes.


Log.changes - added tidy-up list above

xxxxxxxx rv3_7beta23  Dave   Feb 10 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

New (again!) groups system!   Removal of My_WetDep_ml :-)

1. New chemgroups array added in CM_ChemGroups_ml, with pointers to the
   different group arrays, see below.

2. CM_ChemGroups_ml.f90 now kept as separate file, not in CM_ChemSpecs_ml

3. GenChem.pl re-written for the above changes

4. GenChem also makes groups for wet and dry dep automatically, e.g. it
   will figure out WDEP_PM10 or WDEP_DUST  ... the user only has to have
   these properly set in GenIn.species

5. My_WetDep_ml merged with Aqueous_ml - > Aqueous_n_WetDep_ml. All chemistry
   dependencies are now through the imported CM_WetDep.inc file.


These changes also make "older" code like ZCM_Eucaari_Trends, or newer
code like CRI_v2_R5, work again since we have avoided the need for
hard-coded groups.

More on the new group system:

from before we had something like:
 integer, public, target, save, dimension(2) :: &
             NOX_GROUP     = (/ NO,NO2 /)

and which could be accessed by searching for "NOX_GROUP" in the (messy!) GROUP_ARRAY, as something like:
, gtype( "NOX", 2, (/ NO,NO2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 /) ) &

Now we use an array chemgroups which uses pointers. For example, "NOX" in
chemgroups is specified with:

 p => NOX_GROUP
 chemgroups(8) = typ_sp("NOX", p )

Search for NOx and you get the full array of NOX_GROUP.

Much easier!

So far I have only implemented this for wet deposition, so look there for examples.


Other changes:

Derived_ml
   clean-out of old and unneeded code - e.g. old GROUP stuff

My_Derived_ml:
    WDEP_WANTED now used typ_s3 for both groups and species

My_WetDep_ml - deleted :-)

    Functionality moved to Aqeuos_n_WetDep_ml.

OwnDataTypes_ml - added new types

SmallUtils_ml, added txt to outputs

Unimod.f90 - small changes for new files

gfortran-pedantic clean for

DryDep_ml
MosaicOutputs_ml

xxxxxxxx rv3_7beta22  Dave   Feb 10 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

 ** BUG fix ** My_WetDep_ml
    NaCl wet deposition output: now use fSS, not fN

Derived_ml.f90 &
Ecosystem_ml.f90
MosaicOutputs_ml.f90

  FULL_GRID now called either FULL_ECOGRID or FULL_LCGRID to avoid confusing the two

LocalVariables_ml
  Sub array now starts at zero, which is used for full grid (FULL_LCGRID=0)

My_Derived_ml
  seasalt Vg added while testing NaCl

OwnDataTypes_ml
   typ_sp with name and pointer introduced (for experiments so far)

xxxxxxxx rv3_7beta21  Dave   Feb 6 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

My_Derived_ml
  OutputConcs array created for  2d and 3d concentrations and groups
  Further simplifications in Derived_ml - simplifcation

Derived_ml

  OutputConcs array used  for  2d and 3d concentrations and groups
  ( Old D3_PPB, D3_UG stuff replaced by OutputConcs processing.
    Hard-coded groups such as D3_ug_PM25 removed. Such groups
    should now be asked for in OutputConcs. )
  WDEP_SSALT added

OwnDataTypes_ml: typ_s5i added - used for OutputConcs


Biogenics_ml.
    - some extra safety measures and tidy-up

GenChem.pl
   seagroup dep arrays added for sea-salt

Io_Progs_ml
   small format change in datewrite

My_WetDep_ml
   wdepss added for sea-salt

Unimod.f90
   USE_BVOC_2010 added to printlog



xxxxxxxx rv3_7beta20  Alvaro Feb 2 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Output_hourly:
  - Bug fix introduced in rv3_7beta18.
    All levels on BCV* output types (model level output)
    where wrongly claculated as ADV* output types (surface level output).
    All BCV* output types where affected.
  - gFortran pedantic: Different CHARACTER lengths in array constructor

xxxxxxxx rv3_7beta19  Dave code simplification xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

My_Derived

 - 100 lines shorter :-)
 - type_s4 now used to specify wanted Vg, Rs
 - Add_NewMosaics replaces Add_MosaicVg, Add_MosaicRG
 - WDEP_CONCS now specifies eg SO2, NH3 ... for WDEP outputs
 - SURF_GROUPS now specifies OXN, .... etc.
 - misc_xn subroutine - removed OX, NOX, NOZ, TRDN, tNO3, ssalt - all
   such groupings are now handed using the GROUPS feature of GenChem
 - last function, for FRNITR moved into MyDeriv_Func

Derived

 - 50 lines shorter :-)
 - WDEP_CONCS now specifies eg SO2, NH3 ... for WDEP outputs
 - SURF_GROUPS now specifies OXN, .... etc.
 - suboutine Units_Scale added to return scaling and unit txts
 - density calculation movied outside of loop - only used as
    appropriate now anyway
 - so test for ppb in MAXADV and MAXSHL
 - ADV, TADV lines removed
 - OXNGROUP NOXGROUP etc. lines removed for 2d stuff. Shoud do same
   for 3d soon....

Mosaics_ml
 - Add_NewMosaics replaces Add_MosaicVg, Add_MosaicRG
   (will rename from "New" once process finished)


OwnDataTypes
 - Deriv - removed rho and atw

rho, atw removed also in:

Biogenics_ml
EcoSystem_ml
ForestFire_ml
Nest_ml
NetCDF_ml


Some tidy-ups, small changes:

 Aqueous_ml
 LandDefs_ml
 My_WetDep_ml

xxxxxxxx rv3_7beta18  Anna, Jan Eiof, Svetlana & Alvaro Jan 28 2010 xxxxxxxxxx

Update of hourly (netCDF) output routines

My_Outputs_ml:
  Set FORECAST default output in an IF, instead of commented code.
  Full model domain is to be outputed for 10 pre-defined variables.

Output_hourly:
  group COLUMN calculations

My_Outputs_ml, Output_hourly:
  - use INDEX_*_GROUP (from ChemGroups_ml) for identification of groups
  - Partial/Full COLUMN/COLUMgroup calculations:
    hr_out%nk indecate the number of levels in the column,
      1<%nk<KMAX_MID  ==>  Partial column: %nk lowermost levels
         oterwise     ==>  Full column: all model levels
  - cleanup: gFortran pedantic; removal of old comments & old commented code

My_Outputs_ml, Sites_ml:
  - replace SITE_XTRA/SITE_XTRA_CODE by SITE_EXTRA_MISC/SITE_EXTRA_D2D
    in order to avoid the multiple "D2D" commented liles
  - Imprrove print/write formats in Sites_ml
  - cleanup: gFortran pedantic; removal of old comments & old commented code

ZCM_EmChem09/GenIn.species:
  - DUST_NAT_C repeated in PM10 group
  - Same kind of fix for other commented aerosol components  (EC_f/c_new/age)

Makefile_gfortran:
  Ubuntu 10.04 (Lucid) stings

Makefile_titan:
  No optimization options in LDFLAGS if DEBUG_FLAGS is defined

run.pl:
 - Update titan directories
 - Paralell SR runs (one country per Job task) option also available in titan.
   Multiple tasks are submitted (e.g. arrayrun 1-56 run.sh).
   The variable $ENV{'TASK_ID'} is used to select one element of @countries.
 - Inclaude MACC02 Benchmark set

Unimod, Derived_ml:
  clean AMVB comments

xxxxxxxxxxxxxx rv3_7beta17  Dave  Jan 26 2010 xxxxxxxxxxxxxxxxxxxxx
               (not rtagged, but essentially same as beta18)

Major re-write of AOT, POD, VEGO3_OUTPUTS and associated simplification
of Derived system

 *** needs new input files for DO3SE  *********

 - AOTnPOD_ml - replaces AOTx_ml.
   This module now collects together much of the code for
   processing AOTs and fluxes (PODs). Includes O3cl type which
   defines allowed outputs. e.g.

    VEGO3_DEFS    =  (/ &
   O3cl( "POD1_IAM_DF   ",   "POD", 1.0,  "- ", "IAM_DF",F,0,999 ), &
   O3cl( "POD0_IAM_DF   ",   "POD", 0.0,  "- ", "IAM_DF",F,0,999 ), &
   O3cl( "MMAOT40_TC    ","AOT", 40.0, "MM", "TC    ",F,0,999 ), &

 so that My_Derived  just needs to give the names wanted, e.g. POD1_IAM_DF

   Accumulation period for calculation defined in this array, so
   older (and inflexible!) WheatGrowingSeason removed.

 -  My_Derived_ml - see new O3cl types

 -  DO3SE_ml changed, also with extra input param: VPDcrit

  associated changes in

   Derived_ml  (Threshold removed from Deriv type, SOMO changed, ..)
                accumlate_2dyear removed

   Ecosystems_ml
   Makefile.SRCS - AOTnPOD_ml replaces AOTx_ml
   ModelConstants_ml  - removed need for STO_FLUXES
   MosaicOutputs

   StoFLux_ml
      - use of VPDcrit

 - Unimod - more timing calls added

Some gfortran pedantic cleanups in

    DryDep_ml
    LandDefs_ml
    Landuse_ml
    SoilWater_ml - Alvaro's change

And run.pl changed to use Modrun10 emissions for "EMEP" Benchmarks
 %BENCHMARK = (grid=>"EMEP" ,year=>2006,emis=>"Modrun10/EMEP_trend_2000-2008/2006");

xxxxxxxxxxxxxx rv3_7beta16  Peter, Jan 24 2010 xxxxxxxxxxxxxxxxxxxxx

Retabished the original way of making the last met record in run.pl (see rv3_7beta15)
and instead changed Met_ml:
When the first record when starting a new year is not found, use the same value
for metdata as in 31 December (21:00 values instead of 00:00 next day).

Changed also calc_nterm in run.pl, to take into account the first day (dd1).


xxxxxxxxxxxxxx rv3_7beta15  Dave, Jan 22 2010 xxxxxxxxxxxxxxxxxxxxx

Clean-up code changes, single-year run.pl,  and 1 bug fix.....

 *** Bug-fix ***  in Volcanoes_ml - coordinates were wrong for
        EMEP/EECCA cases
        Also, DEBUG_VOLC moved to ModelConstants_ml

 *** code cleaned/removed ***

  1)  My_Derived_ml, Derived_ml  - simpler outputs :-)

      Now use the one array SURF_CONCS to specify outputs, with
      desired unit. Replaces SURF_UG_S, SURF_UG_N, SURF_UG_C,
      SURF_UG and SURF_PPB. Now say e.g.:

     type(typ_ss), public, parameter, dimension(26) :: &
           SURF_CONC = (/ typ_ss("SO2", "ugS"),&
                          typ_ss("SO4", "ugS"),&
                          typ_ss("NO", "ugN"),&
                          typ_ss("O3", "ppb"),&
           .....

     Associated changes in:
      OwnDerivedTypes_ml ... added typ_ss for pair of text strings


  2)  My_DryDep_ml - deleted :-)

      Not needed now since CM_DryDep.ninc has all the important information -
      now this is imported to DryDep

      Associated changes in:

       DryDep_ml
       MassBudget_ml
       ModelConstants_ml  - now has USE_STO_FLUXES
       Sto_Fluxes_ml


 *** safer run.pl ***********

     run.pl changed to avoid taking data from next year (in principal we need
     a few hours from 1st Jan of $yy + 1. Very very easy to not have this.)

xxxxxxxxxxxxxx rv3_7beta14  Anna, Semmena & Alvaro   Jan 20 2010 xxxxxxxxxxxxxxxxxxxxx

Small changes concerning FORECAST & FORECAST-SR modes

run.pl: - Naming for Nest-IC/re-start (dump) files under FORECAST-SR mode
        - Small bug fixes on the Perl code for SR mode

Nest_ml: Bug fix on FORECAST mode. The Nest-BC (IFS-Mozart) files where not found/read.
  The BC variables were searched on the Nest-BC files
  before the filenames where set to the corresponding date.
  Therefore, the Nest-BC file and all of its variables where considered missing.

Makefile_titan: homogenize with Makefile_stallo
  - MPI: use openmpi library as in stallo.
    This replaces the scampi library, which will be discontinued in June 2011.
  - IFORT: use same options than Makefile_stallo.
    Because of the -shared-intel option it is of VITAL IMPORTANCE to have
    the same modules available for compilation and run.
    In titan this is done by the following command line:
      module load intel/11.1u8 openmpi/1.4.3.intel

xxxxxxxxxxxxxx rv3_7beta13  Peter        Dec 21 2010 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


the -recursive option seems to be useful for the compiler. If omitted it may give this
kind of error messsages for large grids:
   Ammonium_ml.f90:(.text+0x3b): relocation truncated to fit: R_X86_64_32S against symbol `set...

Remodified Makefile and Makefile_stallo

xxxxxxxxxxxxxx rv3_7beta12  Peter        Dec 15 2010 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Generate 3D precipitation if it is missing. Use 2D precipitations and 3D cloudwater.
If Cloudwater is missing use relative humidity (derived from specific humidity) instead.
Units are assumed as in EECCA/metdata_EC, i.e. m/s for surface precipitation and kg/kg for cloudwater

ToDo: consider replacing lwc (computed from cc3d) with cw (read from metdata)

(removed -recursive from Makefile: it is no more required)

Modified: Met_ml, MetFields_ml, ModelConstants_ml, Makefile, Makefile_stallo (, run.pl)

xxxxxxxxxxxxxx rv3_7beta11 Semeena, Peter        Dec 2 2010 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Convection routine moved in own file (no change in results)
Modified:
Convection_ml.f90 (new file)
Makefile.SRCS
Advection_ml
(GridValues_ml: just a comment modified)

xxxxxxxxxxxxxx rv3_7beta10 Dave        Nov 29 2010 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug fixes for SoilNO  (no effect unless USE_SOILNO = .true.)

Emissions_ml
Setup_1d_ml


xxxxxxxxxxxxxx rv3_7beta9  Dave        Nov 27 2010 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Fixed run.pl
    Dust switched off for "EMEP" grid since we don't have the data file
    yet. (Solution will be to netcdf the files, not to have one in each
    LOCAL_DATA dir.)

Added pm25 and pmco files to ZCM_EmChem09/EMISSPLIT

(Not updated in Eucaari directory yet. Need to decide how much detail
with which to split pm25.)

More use of PrintLog in Unimod.f90 - to record which switches were used in RunLog.

Dust changes

   - USE_DUST and DO_SAHARA put in ModelConstants_ml (where
    similar switches are kept). Makes it easier to switch off for EMEP domain.

   RunChem_ml and Dust_ml only if USE_DUST

   ZD_OZONE/MyAerosols - DUST logical replaced by USE_DUST from ModelConstants

   GlobalBCs_ml - DO_SAHARA from ModelConstants


xxxxxxxxxxxxxx rv3_7beta8  Dave+Peter  Nov 23 2010 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

New group system started --- not finished!

  Changes to handle groups better, and get rid of hard-coding in Derived_ml
  (The rv3_7eucaari version would not compile with EmChem09 chemistry.)

GenChem.pl now produces extra group info in CM_ChemSpecs_ml, with
   a new type gtype, e.g.

    type(gtype), public, parameter, dimension(18) :: &
       GROUP_ARRAY = (/ &
 gtype( "SOX", 2, (/ SO2,SO4,0,0,0,0,0,0,0,0,0,0,0,0,0,0 /) ) &
  ......

My_Derived_ml:   now has SURF_UG_GROUP = (/ "SIA", "PM25",  ....

   - works the same way as for SURF_UG = (/ "SO2", .....

   - BUT - I haven't had time to make SURF_UG_N_GROUP, SURF_PPB_GROUP etc.
     [Note: Should redesign again with units specified with name,
       eg SURF_GROUP = (/ pair( "SIA", "ugm3"), pair("OXN", "ugNm3"), &
                          pair("NOX", "ppb") /) or similar....    ]

   - outouts called SURFGRP_UGM3_SOX etc.... [Note: Will rename to just SURF_
     once the older SURF stuff is erased for groups.

   - D2_PM removed. Functionality in above or elsewhere

   Thus the former SOX_GROUP is not needed, but just the character array "SOX".
   This avoids compilation problems where groups do note exist (eg "BSOA")
   and allows looping.


Derived_ml

   - all groups that are defined in SURF_UG_GROUP now removed from
   Derived_ml. Instead we use AddNewDeriv for SURF_UG_GROUP similar
   to for SURF_UG. Gets rid of lots of lines (currently commented
   out with !GRPD

   - flex_uggroup_calc routine removed. All can be done with the original uggroup_calc

Also
   Dust_ml : MasterProc used to limit outputs (should use in
    preference to me == 0 anyway.)

   NetCDF_ml - bug fix on ReadField_CDF:
        if(imax==1)imax=dims(1)!covered entire circle


xxxxxxxxxxxxxx rv3_7eucaari xxxxx Many authors !! 21 Nov 2010 xxxxxxxxxxxxxxxx

   *New directory*

    ZCM_Eucaari_Trends - use instead of EmChem09 for EUCAARI work.

    Has VBS SOA chemistry from Robert.  Note that instead of EC_f_new we
    now have EC_f_FFUEL_new, EC_f_WOOD_new, etc. Not perfect (as we don't
    have wood emissions) but it limits the number of SOA schemes used.

    Has changed  GenIn.species for SOA (DryDep fom Robert has gas-phase dep
    of SOA)

    Contains EMISSPLIT -  split files


  Other:

  Advection_ml - added min(ps3d) safety checks

  Biogenic_ml - * fixed bug * for terpene emissions. Added EmisNat for BIO_TERP
    - reset to 2003-style emissions to keep consistent with Robert's SOA
      clearer coding of differences I hope

  Derived_ml - Idirect, Idiffuse, T2m and *lots* of 3D options added
  My_Derived_ml - Idirect, Idiffuse, T2m options added
                - outputs reduced for EUCAARI runs. (still v. many)

  run.pl - various EUCAARI options.

  ModelConstants_ml - added HIRHAM and DRYRUN flag
                    - switched on deep soil water :-)
                    - added Payerne as HIRHAM debug coords

  Sites_ml,   just renamed CALL to call. Was looking ofr lat/long "LL"

    xxxxxxxxxxxxxx ....  (Peter 23/11-2010)xxxxxxxxxxxxxxxx
    new bug in ReadField_CDF: special case when imax=360 because the area covers all longitudes (was set to 1)

    xxxxxxxxxxxxxx .... SoilNOx  (Peter 11/11-2010)xxxxxxxxxxxxxxxx
   set USE_SOIL_NOX=.true. in ModelConstants_ml to get soil nox

Corrected a bug in ReadField_CDF (a few values were set to undef/0 when latitude start from north poles in the datafile.)
Changed test for ps3d in Advection_ml, to avoid unnecessary warnings.

Changes in:
ModelConstants_ml
NetCDF_ml
Emissions_ml
Setup1d_ml
Advection_ml
run.pl

   xxxxxxxxxxxxxx .... with VolcanoesLL (Peter 1/11-2010)xxxxxxxxxxxxxxxx
    Included a lon lat description for Volcanoes:
    /global/work/mifapw/emep/Data/VolcanoesLL.dat
    NB:emission values and positions should be updated

    It is used if  VOLCANOES_LL  = .true. in EmisDef
    Then the volcanoes from gridSOX and Vocanos.dat are not used!

    NB: femis.dat reductions will not work anymore on country=28 (volcanoes)

    The conversion to grid coordinates should be automatic.

    Changes in:
    Volcanos_ml, Emissions_ml, emisGet_ml, EmisDef_ml, Setup1d_ml, run.pl

    Note that Volcanoes_found is a local variable (different value on different processors)
    There are still some back and forth i,j conversion which should be removed once.

    11th November: corrected small bug    (character(len=20), dimension(5) :: Headers )

xxxxxxxxxxxxxx rv3_7beta7b Robert Oct 30 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Minor update in vbs-SOA scheme. Adding EC aging.

xxxxxxxxxxxxxx rv3_7beta7 Svetlana (+minor updates by Robert) Oct 29 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Main changes:
1. Introduction of fine EC and POC from primary emissions
   EC is split to EC_f_new (fresh) and EC_f_age (aged)
   ChemFunctions_ml.f90:  function ec_ageing_rate() result(rate)

2. Changed names aNO3_f to NO3_f;  pNO3_c to NO3_c;  aNH4 to NH4_f

3. Implemented natural dust: DUST_NAT_f and DUST_NAT_c
   windblown - DustProd_ml.f90
   Saharan BIC

4. AOD calculation: AOD_PM_ml.f90
----------------------------------------

          Affected modules:
    --------------------------
My_Aerosols_ml.f90
My_Derived_ml.f90
My_DryDep_ml.f90
My_Outputs_ml.f90
My_WetDep_ml.f90

Ammonium_ml.f90
BoundaryConditions_ml.f90
ChemFunctions_ml.f90
Chem_ml.f90
Derived_ml.f90
EmisDef_ml.f90
Functions_ml.f90
GlobalBCs_ml.f90
Io_Nums_ml.f90
MetFields_ml.f90
Met_ml.f90
ModelConstants_ml.f90
Runchem_ml.f90
Setup_1d_ml.f90
Setup_1dfields_ml.f90
____________
   New:
-----------
DustProd_ml.f90
AOD_PM_ml.f90

_______________
   From GenChem
---------------
CM_ChemSpecs_ml.f90
CM_ChemRates_ml.f90
CM_WetDep.inc
CM_Reactions1.inc
CM_Emis.inc
CM_DryDep.inc
CM_BoundaryConditions.inc

  In ZCM_EmChem09/
GenIn.species
GenIn.reactions
GenIn.shorthand
SAFE.CM_BoundaryConditions.inc

  In ZCM_vbs_tests/
GenIn.species
GenIn.reactions
SAFE.CM_BoundaryConditions.inc


------------------------
Makefile.SRCS


xxxxxxxxxxxxxx rv3_7beta6 Dave Oct 29 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Biogenics_ml:

Switch on BVOC_2010 methods, uses file EMEP_Euro
Add terpene emissions (only BVOC_2010 so far, older 2003 stuff not updated)

ZCM_EmChem09/GenIn.species: added for testing  rcbio(BIO_TERP,k)   = APINENE ;
ZCM_EmChem09/GenIn.reactions:
  added for testing  APINENE emissions, [OH] + OC_FIRE reaction

run.pl: use new BVOC file EMEP_EuroBVOC_KRS09.nc

xxxxxxxxxxxxxx rv3_7beta5 Robert/Dave  Oct 28th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

ModelConstants_ml - Minor update, now use TXTLEN_NAME to set length of some strings that used to be hard coded as 12 characters (now TXTLEN_NAME is set to 20 to allow for slightly longer chemical species names) TXTLEN_NAME is used in My_Outputs_ml, EmisGet_ml and MassBudget_ml

Also updated/revised the SOA scheme to a simpler version treating all primary OA from fossil fuel as nonvolatile (not yet decided if this is the "best" default SOA scheme)

Add PPM25_FIRE, + CO_FIRE to GenIn.species

run.pl - switched to "JAN" directory for emissplit - as this has the fire components

xxxxxxxxxxxxxx rv3_7beta4 Dave  Oct 26th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Aero_Vds_ml - small increase in rates (0.006 -> 0.008)

DryDep_ml -  removed special treatment of NO2, and added higher deposition rates
for nitrate-like particles

GenChem.pl - now outputs RO2POOL line in CM_Reactions1.inc if needed

mk.GenChem - copies SAFE.CM_BoundaryConditions_ml.f90 to CM_BoundaryConditions_ml.f90

(make sit easier to do rm CM_* in ZCM_EmChem09)

Solver_ml - now uses RO2_GROUP

Wesely_ml - added PMfS, PMfS distinction and AERO_SIZE

ZCM_EmChem09/GenIn.species - use PMfS or PMfN for sulphur-like (non-dissociating
) or nitrate-like (dissoctating) particles


xxxxxxxxxxxxxx rv3_7beta3 Dave  Oct 21st xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Small changes:

  Derived_ml   POD, AOT added in case statement

  My_Derived_ml SOMO0 added

  CoDep - small format change

xxxxxxxxxxxxxx rv3_7beta2 Dave  Oct 18th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Re-coded AOT treatment, also to get EU AOT from 3m grid ozone

AOTx_ml: now takes Sub(iL)%cano3_ppb, or Griod%surf_o3_ppb as appropriate

Biogenics_ml : some changes connected to BVOC_2010 methods.

Derived_ml: AOT changes

DryDep_ml: AOT changes

Inputs_LandDefs changed - extra variables

LandDefs_ml - BiomassD added. Also new Inputs_LandDefs.csv

LocalVariables_ml - added surf_o3_ppb, O3factor

ModelConstants_ml : DEBUG_ii etc introduced to ease change from EMEP to EECA

MosaicOutputs_ml: AOT+POD changes

OwnDataTypes_ml: renamed LC to TXTLC to help rember this is a string

run.pl:   dd1 introduced.... start day

xxxxxxxxxxxxxx rv3_7beta1 Dave  Sep 30th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Quite large changes - mainly to simplify and clean up, partly in preparation
for new BVOC + soil water systems. The switch to "beta" is to emphasise that
now we are working towards the rv3_7 public domain release. Clean ups and
simplification are encouraged ;-)

Two new modules:

    DerivedFields_ml - stores f_2d, d_2d here (avoided circularity problems)
    MosaicsOutputs_ml

      Much moved to MosaicOutputs_ml
      Much removed and replaced by use of Grid% Sub(iL)%
      (ie much cleaner I hope!)

Changes in AOT, Fst calculations.

AOTx_ml  - simpler because of new o3cl types

Biogenics_ml - much changed. A work in progress

CellMet_ml -  small additions

DerivedFields_ml added - stores f_2d, d_2d here (avoided circularity problems)

Derived_ml - changes mainly due to DerivedFields_ml

DryDep_ml  - ** bug fix ** on cano3

DO3SE_ml   - mainly changed lu to iLC. Will try to keep same index throughout
             Unimod.

Io_Progs_ml : added datewrite - simplifies printout of current_date plus
              other data.

ModelConstants_ml - several new DEBUGs

MosaicOutputs_ml - moved loads of code from My_DryDep and DryDep_ml here
                   Still too messy, but most in one place at least.

   DryDep_ml     - much shorter because of above
   My_DryDep_ml  - *very* much shorter because of above. Almost nothing left :-)
   My_Derived_ml - *very* much shorter because of above.

OwnDataTypes : type o3cl added t cope with AOTX, PODY

PhyChe: extra debug coding - added subroutine debug_concs to save some lines

Setup_1d_ml: some  changes because of Bioegenic work. A work in progress

StoFlux_ml :  cleanup


xxxxxxxxxxxxxx rv3_6_24 Semeena, Anna & Alvaro Sep 09 2010 xxxxxxxxxxxxxxxxxxx
SR on FORECAST mode: script changes & bug fix

run.pl:
  * SR on FORECAST mode: allow SR & CWF options to coexist.
    Modify EMEP::Sr::getScenario to create CWF-SR scenarios.
    Use different dump files for different SR ensemble members.
  * One country per Job task: If multiple tasks are submitted (e.g. #PBS -t 1-56),
    use $ENV{'PBS_ARRAYID'} to select one element of @countries.
    This removes the need for multiple scripts for parallel partial-SR runs,
    as each country is handled by a single task and each task dealt
    independently by the pbs-job-loader.
  * MOZART-IFS BC in forecast mode: Use previous day BC if the file is not
    not yet available for the base-date.
  * Formatting/indentation.

Sites_ml: Fix SOURCE_RECEPTOR bug.
  Crash only on SR runs with message "SITES D2D NOT FOUND HMIX".
  This was because, on SR runs, D2_EXTRA is not added to wanted_deriv2d
  by Init_My_Deriv (My_Derived_ml). Therefore "HMIX" is not wanted,
  but is still required by SITE_XTRA_CODE (My_Outputs_ml).
  The impasse was solved by processing SITE_XTRA/SITE_XTRA_CODE only
  if(.not.SOURCE_RECEPTOR).

PhyChem_ml: No hourly, site & sonde outputs for SR runs.
  Though it says in the code that hourly and daily are not written out
  in the SR case, hourly output was still produced.
  Now hourly will be produced for FORECAST-SR runs.
  Hindcast SR runs will not produce hourly output.
  Site & sonde outputs will not be produced for SR runs

My_Derived_ml: Controlling the output variables.
  Not writing out the emissions, deposition velocities,
  resistances for different landuses and 3D variables.

SoilWater_ml, Nest_ml: gFortran pedantic fix for logical statements

xxxxxxxxxxxxxx rv3_6_23 Dave Peter  Aug 27 2010 xxxxxxxxxxxxxxxxxxxxxxxxx

xxxxxxxxxxxxxx rv3_6_23 Dave Peter  Aug 27 2010 xxxxxxxxxxxxxxxxxxxxxxxxx

Peter:
NetCDF_ml: comments put in beginning of interpolation routines  ReadField_CDF and Read_Inter_CDF

Dave:
GenChem.pl - length of species%name extended from 12 to 22

DryDep_ml, Landuse_ml: LU_cdf variable removed - not used

DryDep_ml, StoFLux_ml:  debug statements re-formatted to fit < 78 chars per line.


xxxxxxxxxxxxxx rv3_6_22 Dave          Aug 23 2010 xxxxxxxxxxxxxxxxxxxxxxxxx

More  GenChem and SOA-related changes

GenChem.pl  --- now used to set NEMIS_FILES and EMIS_FILES. Add wanted
emission file as prefix to rcemis, e.g.:

    nox:rcemis(NO,k)                           = NO    ;
    nox:rcemis(NO2,k)                          = NO2    ;
    sox:rcemis(SO2,k)                          = SO2    ;
    sox:rcemis(SO4,k)                          = SO4    ;
    co:rcemis(CO,k)                           = CO    ;
    voc:rcemis(C2H6,k)                         = C2H6    ;
    voc:rcemis(NC4H10,k)                       = NC4H10    ;

With modified:
   ZD_xx/GenIn.reactions
   (also cleaned up - commented-out dry dep lines removed)


NOTE: these prefixes are only used for the standard gridded emissions files
 - the ones that were in EMIS_FILES. We also have rcbio and possibly rcnh3
for isoprene, terpene, etc.

SOA_ml removed!!
 REplaced by ZD_OZONE/My_SOA_ml  or ZD_VBS/My_SOA_ml

ZD_VBS added

ZD_VBS/My_SOA_ml - now uses PCM_GROUP, PCM_HELP_GROUP from GenIn.species

ZCM_vbs_tests added - just for testing by Robert/Dave.

My_Aerosols_ml : ORGANIC_AEROSOLS flag removed. Moved to My_SOA_ml

EmisDef - now uses CM_Emis.inc  -- hence is chemistry independent :-)

Use modified rcbio:
  Runchem_ml - uses modified rcbio
  Setup_1d_ml - uses modified rcbio
  Setup_1dfields_ - stores modified rcbio
  Solver_ml


xxxxxxxxxxxxxx rv3_6_21 Dave/Robert   Aug 20 2010 xxxxxxxxxxxxxxxxxxxxxxxxx

More SOA consistency and modified soilwater handling when USE_SOILWATER
set true --- this *will* change results! Lower DryDep when soil
is dry -> more O3, etc. in Southern Europe


Aqueous_ml - modified for consistency with SOA module - uses
      Fpart for semivolatile species. Small changes in notation
      also

CellMet_ml - added fSW, Grid%fSW

Derived_ml - used BVOC array t set NatEmis Derived, instead of hard-coded C5H10.
             changed old write_debug to write_debugadv
            added simpler write_debug for other components than adv

DO3SE_ml - uses new fSW instead of older DO3SE method.
           Added debug_flag to g_stomatal + f_SW in DEBUG outputs

DryDep_ml  - modified for consistency with SOA module - uses Fpart for semivolatile species.
      Added fSW to prepare for soil-water changes.
      Small changes in notation also.

GenChem.pl - modified for SOA treatment. Use typ=2 in GenIn.species
  and add SOA, ASOA etc. in groups to get e.g. SOA_GROUP in CM_ChemSpecs_ml.
  Uses FIRST_SEMIVOL instead of FIRST_SOA, same for LAST

  Note that the DeltaH and Cstar info is now part of chemicals%

LocalVariables_ml - added fSW

mk.GenChem - removed CM_SOA_ml

ModelConstants_ml: Added USE_SOILWATER

Rsurface_ml - more debug options

run.pl - sets USER from $ENV{"USER"} - easier and safer!

Sites_ml - improved debug options

SOA_ml - uses FIRST_SEMIVOL instead of FIRST_SOA, same for LAST

SoilWater_ml - start of "real" soil-water handling, generating fSW
    from SoilWater_deep. Not used yet.
     (HIRLAM-tested only)

StoFlux.f90 - bug fix on evapotranspiration calculation - avoid div  by zero

ZCM_EmChem09/GenIn.species - some fake species added to test SOA+GenChem.
   Commented out for now, just uncomment to try.


xxxxxxxxxxxxxx rv3_6_20      Alvaro  18th Aug 2010

MOZART-IFS BC in forecast mode: Use top boundary from BC file.

Nest_ml:
  * Use top boundary from BC file.
    The new logical parameter TOP_BC controles this feature.
    Top boundary is read into new variable xn_adv_bndt.
  * Bug fix. Lateral BC were wrongly set to zero.
    Subroutine read_newdata_LATERAL read boundary values into local variables,
    instead of global ones of the same name (xn_adv_bnd{w,e,s,n}).
  * Bug fix. The assignment itime=Next/itime=Next_BC after the time finding
    loop on reset_3D/read_newdata_LATERAL) causes that the wrong record to be read
    when the "right date-time" is not found.
    When there is no "right date-time" on the IC/BC file the index 'n'
    is outside of the valid range for records, and therefore the program crashes
    when trying to read beyond the last record.
  * Boundary variables (xn_adv_bnd{w,e,s,n,t}) are only allocated on the processors
    that will use them
  * New interer variables iw, ie, js, jn & kt contain the indexes corresponding
    to the west, east, south north and top boundaries.
  * Clean up & indentation.

ModelConstants_ml:
  * Correct string lenght for DomainName="EMEPCWF-0.25degEurope"
  * Clean up & indentation.

xxxxxxxxxxxxxx rv3_6_19   Dave  17th Aug 2010


Bug-fixes again .... old ones (rv3_5_15!) which somehow got lost

Derived_ml:

   BUG fix: somo_calc. SOMO35 was calculated incorrectly (somo_calc used index, wereas
   XYCL should be used, to get the 35.). Added debug_flag to somo_calc also.
   debug flags added to somo_calc

AOTx_ml: BUG_fix: scaling with dt_advec/3600 removed. dt-scale does this.


xxxxxxxxxxxxxx rv3_6_18   Dave  16th Aug 2010

Bug-fixes! WDEP and DDEP of groups didn't include all species.
(bug started from rv3_5_27 probably)

Aqueous_ml - added debug_flag to WetDeposition call

Derived_ml - IsSurf replaced by ik==0

GenChem.pl -  bug fixed. Hadn't spotetd that aNH4 was same as ANH4 for wdep groups - now
     now uses sub spec_equal

ModelConstants_ml
   - added DEBUG_WETDEP, DEBUG_MY_WETDEP

ZCM_EmChem09/GenIn.reactions - added rcnh3 in GenIn.reactions, used for Haldis's
     system (was in CM_Reactions2.inc. Remember - stuff in CM_ is generated by
     mk.GenChem, so new equations should be written in GenIn.reactions, not
     CM files.)

ZD_OZONE/My_WetDep_ml - added debug_flag

xxxxxxxxxxxxxx rv3_6_16      Alvaro  16th Aug 2010

Use MOZART-IFS BC in forecast mode

Derived_ml.f90 - bug-fix on uggroup outputs

Nest_ml:
  * Add 'bc' and 'bc_set' types to expicitelly define which bc's are needed
  * Additonally, some do-->forall replaces and gfortran-pedantic fixes

ModelConstants_ml:
  * Add DEBUG_NEST_ICBC parameter

run.pl:
  * Additional code for handeling forecast BC files from MOZART-IFS

xxxxxxxxxxxxxx rv3_6_15      Peter   11th Aug 2010

Some changes to make the model portable to different machine/compilers
(and some cleaning)

Advection_ml:
Some simplifications to test for allowed dt_advec.
Cleaning/commenting of convection_pstar

Met_ml:
"readneighbors" is made MPI_safe (could hang for very large grids).

NetCDF_ml:
recursive ReadField_CDF (so we don't need to use compiler options)

Derived_ml:
splitted "if(present(iIs3D).and.Is3D)", as xlf (IBM/njord) seems to
test Is3D before looking if it is present

Unimod.f90:
Moved call parinit upward, because parinit defines MaterProc, which was used before it was set.



xxxxxxxxxxxxxx rv3_6_14      Dave   9th Aug 2010

Derived_ml: XYCL renamed to Threshold :-)
            EVAP, SoilWater, PREC_WDEP outputs added as Derived

DryDep_ml: MMC_GSTO added

LocalVariables_ml:  EvapTransp added

ModelConstants_ml: DEBUG_SOILWATER added

OwnDataTypes: XYCL renamed to Threshold, extra outputs in print

Sites_ml: SITE_XTRA_INDEX, SONDE_XTRA_INDEX commented out - not used
and a pain!

StoFlux_ml: Evapotranspiration added  (1st attempt, should be optimised)

My_Derived_ml: outputs for POD for ex-post analysis, + EVAP, SoilWater

               Code for "NOX" commented out. Have both NO and NO2 as
               outputs anyway, and should treat NOX as just another
               group.

My_Outputs_ml: ITE_XTRA_INDEX, SONDE_XTRA_INDEX commented out

ZD_OZONE/NH3variables_ml   removed. Use version in Unimod main directory
ZD_OZONE/NH3variables_m_variation_ml removed. Use version in Unimod main directory
ZD_OZONE/Tmp_Met_ml removed. Use version in Unimod main directory

run.pl  TREND_RUNS added to get consistent time-series


xxxxxxxxxxxxxx rv3_6_13      Alvaro,     4rd Aug    2010

run.pl: pre-defined  benchmark datasets

The benchmark sets indicate the grid, time period (full year)
and emissions to use.
There are, so far, two benchmark sets (my %BENCHMARK):
  %BENCHMARK = (grid=>"EMEP" , year=>2005,
                emis=>"Modrun07/OpenSourceEmis"     );
  %BENCHMARK = (grid=>"EECCA", year=>2007,
                emis=>"Modrun09/2009-Trend2007-CEIP");

There are two additional keys to fine tune the benchmark behaviour:
  $BENCHMARK{'debug'}   = 0;  # chech if all debug flags are .false.
  $BENCHMARK{'archive'} = 0;  # save summary info in $DataDir

if $BENCHMARK{'archive'}, summary info is copied to:
  $DataDir/Benchmark/$GRID.$year/BM_$testv-$Chem.$USER

You can find such info for rv3_6_10-EmChem09 (run in titan)
for both EMEP.2005 and EECCA.2007 benchmarks in:
  titan  $DataDir=/xanadu/project/metno/emep/Data/Benchmark/
  stallo $DataDir=/global/work/mifapw/emep/Data/Benchmark/

Makefile_titan: minor update

xxxxxxxxxxxxxx rv3_6_12      Dave,       3rd Aug    2010

preliminary SoilWater outputs added for testing

Derived_ml - changed EcoArea handling

OwnDataTypes_ml - extended size of TXTLEN_SHORT to 18

PhyChem_ml - calls Set_SoilWater

Some extra debugs added for BVOC work, e.g. BIODZ in Emissions


xxxxxxxxxxxxxx rv3_6_11     Alvaro,  2nd (committed 4th) August 2010

Updates relted to the forecast mode

Unimod & PhyChem_ml:
  Bug fix in forecast mode. The hourly output for the "zero hour" was wrong.

ModelConstants_ml:
  Add GEMS 0.25 extended (Eyjafjallaj\"okull) and MACC 0.20 domain definitions.

Derived_ml:
  Allow daily output for SOURCE_RECEPTOR calculations in FORECAST mode

Nest_ml:
  only 1 FORECAST_NDUMP (re-start file) by default

Advection_ml:
  advection timestep (dt_advec) set assign_dtadvec according to grid resolution
  also in FORECAST mode. Before it was set to 10 min, independently of the
  grid resolution. Now it is set as for non FORECAST runs.
  GEMS025 domain 0.25 deg resol --> GRIDWIDTH_M~=27.8 km --> dt_advec=20 min
  MACC02  domain 0.20 deg resol --> GRIDWIDTH_M~=22.2 km --> dt_advec=20 min

Output_hourly:
 -Only postive hr_out%max values will be check for excedance.
 -New hourly output types (hr_out%type)
    BCVugXX     ug/m3, ugC/m3, ugS/m3, ugN/m3 at model mid-levels
    ADVugXXg    GROUP output in ug/m3 at the surface
    BCVugXXg    GROUP output in ug/m3 at model mid-levels
    PMwater     PM water content (PM_water) at model mid-levels
    COLUMN      Column output in ug/m3, ugC/m3, ugS/m3, ugN/m3 or molec/cm2

My_Outputs_ml:
 -Add standard forecast houtly output hr_out (commented).
 -Define to_ug_S and to_ug_N as arrays, matching to_ug_ADV definition
  for ug output ("ADVugXX" hourly output type).
  Add to_ug_C, to_molec_cm3 and to_molec_cm2 conversions.

My_Outputs_ml, Output_hourly & NetCDF_ml: selected model levels on hourly output
 -New parameters SELECT_LEVELS_HOURLY (logical) and
  LEVELS_HOURLY (array of level indexes) indicate if and which levels
  to output (My_Outputs_ml).
 -Modify hourly_out (Output_hourly), Init_new_netCDF and CreatenetCDFfile (NetCDF_ml)
  to allow feature. CreatenetCDFfile has a new optional parameter 'KLEVcdf'
  to hold levels to be outputed.
 -Backwards comptability provided by SELECT_LEVELS_HOURLY=.false. (default).

NH3variables_ml.f90: gFortran compliance...

xxxxxxxxxxxxxx rv3_6_10    Dave,       3rd Aug    2010

FOREST_FIRES reset to false in EmisDef. Robert has noticed that
   results depend on processor number, so there must be a bug.

NH3EMIS_VAR test added before linking NH3 sector data in run.pl

NB - there is no read permission on Haldis's sector NH3 file, so
the code won't  run with NH3EMIS_VAR anyway. Will fix once
Haldis returns.

xxxxxxxxxxxxxx rv3_6_9     Haldis,    22st July   2010

New temporal ammonia emissions, only for a restricted area.
Default is set as the old ammonia emission,
new temporalemissions can be choosen by setting NH3EMIS_VAR=true in EmisDef
and in run.pl
This method requires 10m wind from meteorology, this exist in meteofields for
2006 and 2008

New modules:
NH3Emis_variation_ml.f90:
                sets up scaled emissionfactors, so they are never higher
                than 1. Uses then the potential emission factor from
                Tmp_ml.f90

Tmp_Met_ml.f90 (contains temporary reading of meteorology and reading of
                emissions):
                -sets up the potential emission factor in each grid at each
                 timestep
                -calculates the time for maximums in the gauss functions
                -reads the NH3 emissions, and make them equal to the reported
                 emissions (from EmisDef_ml and EmisGet_ml), scale them to 50km
                 grid and surface fluxes instead of tonn pr year
                -reads in T2m and 10m winds from meteofiles
NH3variables_ml.f90 (contains variables used in Tmp_Met and NH3Emis_variation)

Minor changes in the following files:
Unimod.f90
Setup_1d_ml.f90
Setup_1dfields_ml.f90
Runchem_ml.f90
Par_ml.f90
Io_Nums_ml.f90
EmisGet_ml.f90
EmisDef_ml.f90
MetFields_ml.f90
Met_ml.f90
Makefile.SRCS
Solver.f90
CM_Reactions2.inc
Country_ml.f90
ModelConstants_ml.f90
run.pl


xxxxxxxxxxxxxx rv3_6_8     Alvaro,    21st July   2010

Fix PM in ppb bug in Sites_ml and Derived_ml (rv3_5_26), additional changes.
Small bug fix for Read_Inter_CDF.  Wrong data projection from file
Small bug fix in forecast mode

Derived_ml & My_Derived_ml:
  use D3_OTHER to select additional D3 output.

NetCDF_ml: Wrong data projection from file (Read_Inter_CDF)
  data_projection might get non-pritable after the end of word
  when not inializes. Set default value for data_projection="".

run.pl:
 -Small bug fix in forecast mode. The dump (re-start) file name was wrong.
 -Update $emisdir to MACC02 version.

Makefile_titan:
  add debug flags

xxxxxxxxxxxxxx rv3_6_7     Alvaro,    19th July   2010

Fix PM in ppb bug in Sites_ml and Derived_ml (rv3_5_26)

Sites_ml & My_Outputs_ml:
  use to_ug_ADV (My_Outputs_ml) to calculate "PM25" and  "PMco"
  from SONDE_XTRA.

Derived_ml:
  - Define D3_ug_PM25 and D3_ug_PMc according its SURF_ug equivalents
    in subroutine Define_Derived.
  - Extend uggroup_calc to 3D or 2D(surface) ussage.
  - Add "PM25GROUP" and "PMcGROUP" 3D tyes to subroutine Derived.

Makefile_gfortran:
  - add option -ffree-line-length-none so gfortran-4.2 (Ubuntu 8.04)
    can deal with long lines from GenChem.
  - improve 'depend' target

xxxxxxxxxxxxxx rv3_6_5     Peter, Dave,    9th June   2010

Advection_ml: Bug in rv3_6_2 correction:should not multiply bi ps-PT too!

NetCDF_ml - deallocate added for Nvalues, small debug change

NetCDF_ml: added "recursive" for ReadField_CDF routine

xxxxxxxxxxxxxx rv3_6_4     Dave,    9th June   2010

Advection_ml returned to former, otherwise normal runs give NaN
   I have added the new suggestion as a commented ourt block though
   awaiting attention from Peter
   see "QUERY" bit.

NetCDF_ml modified

   known_projection added as optional. Allows user to
   specify e.g. MEGAN data as "lon lat", without need
   to modify original MEGAN files.

   Lots of debug statements added! Will reduce later

   FillValues treatment extended+safer  (hope Peter agrees!)

Interpolation_ml - more

xxxxxxxxxxxxxx rv3_6_3     Dave,    9th June   2010

CM_WetDep.inc added to ZCM_EmChem09.  Note that in principal
this isn't needed. One gets these files by typing mk.GenChem.
Will clean up this behaviour one day, and just keep
GenIn files rather than the CM_ outputs.


xxxxxxxxxxxxxx rv3_6_2     Peter,   8th June   2010

Advection_ml: divide xn_advec by max(1,ps3d) instead of ps3d also if no convection is used.
This will put a very small value for the concentrations, instead of NaN, in the case where
wind fields are very divergent.
(Joffen reported that the advection gave NaN on north pole)

xxxxxxxxxxxxxx rv3_6_1     Dave,   4th June   2010

New Module: InterpolationRoutines_ml

 - created as merge of bilinear code from Functions_ml and Peter's
  grid2grid_coeff. Small caller routine Nearest4 added, as well as
  test-code which can be uncommented for stand-alone testing.

xxxxxxxxxxxxxx rv3_6        XXXXXXXXX TO BE BACK_ADDED XXXXXXXXXXXXXXXXX

REPORT 1/2010 version will be added as a branch. Note that rv3_6 was
really based upon rv3_5_25, so things got a bit confused here. Still,
no worries ;-)


xxxxxxxxxxxxxx rv3_5_27    Dave,  28th May   2010

GenChem.pl changes:   GenIn.species is now a comma-separated file which
  can be edited in gnumeric, and contains details of the dry and wet dep,
  also other params such as extinction coefficient and VBS details.

ZCM_EmChem09:
    GenIn_species.csv created as above
    GenIn.Reactions - deposition stuff removed

Derived_ml     - extended for more groups (tNO3, OXN...)

GlobalBCs_ml   - test about ZD_OZONE removed

ModelConsants_ml - model changed to EMEP-MSC-W instead of ZD_OZONE

ChemSpecs_bgn_ml, Chem_ml: Content of ChemSpecs_bgn_ml moved into Chem_ml

xxxxxxxxxxxxxx rv3_5_26    Dave,  26th May   2010

More GenChem enabled, with use of "groups" to avoid hard-coded indices:

GenChem.pl and mk.GenChem  now in Unimod directory. Edit the ZCM_xxx/GenIn files
to change reactions, depositions, etc.

mk.GenChem - runs GenChem.pl and copies CM to current directory.

GenChem.pl

   1) Dep changes:
   GenChem now produces CM_WetDep_ml

   Define which species are deposited in GenIn.reactions, e.g.

     DRY_NO2    -           NO2      =    ;
     DRY_SO2    WET_SO2     SO2      =    ;
     DRY_FIN    WET_SO4     SO4      =    ;
     DRY_FIN    WET_PMf     aNH4     =    ;
     DRY_FIN    WET_PMf     pNO3_f   =    ;

  The idea is that we have some "CALC" compounds defined in My_WetDep_ml,
  My_DryDep_ml, and can give the deposition rates of the species in terms
  of these. Thus, we can use the WET_PMf rate for any fine particle,
  we just need to define it once.

  Aqueous_ml - rewritten to use the new CM_WetDep_ml approach.

  DryDep_ml - rewritten to use the slightly renamed CM_DetDep_ml indices

   2) Groups
   Groups are defined in GenIn.species, e.g.

     SO4   1  SO4        -  8.5  0  0      PM25,SIA,SOX,AOD  !

   - adds SO4 to PM25_GROUP, SIA_GROUP, SOX_GROUP, AOD_GROUP
    These groups can then be used in the rest of the code, so that
    now we can get things like PM25 as the sum of all species in
    PM25_GROUP; Avoids lots of lijnes with IXADV_PPM25, IXADV_SO4 ..
    etc.

   - the 8.5 0 0 are for AOD and VBS calculations. Will refine one day,
     but these numbers are now added as species(..)%extC, %Cstar, %DeltaH
     in CM_ChemSpecs_ml

  Derived_ml changed with such group calculations. See pmgroup_calc
  routine.

  Also:

    spotted outputs of PM in ppb, which has to be wrong. PM c an only have
    mass output since we don't know the mol. wt.

    Affects Derived_ml (3d outputs) and Sites_ml

Name changes (provisional)

  aNO3 -> pNO3_f
  pNO3 -> pNO3_c
  SSFi -> SeaSalt_f
  SSCO -> SeaSalt_c

In Ammonium_ml,

xxxxxxxxxxxxxx rv3_5_25    Peter  28th April 2010

New version of ReadField_CDF. Simpler and more robust (when FL are below surface).


xxxxxxxxxxxxxx rv3_5_24    Peter  27th April 2010

In order to be able to read the aircraft emissions given in flight levels, the
ReadField_CDF routine has been adapted for this very specific task.
It must use monthly surface pressure average. This is given in a separate file,
which is produce from IFS 0.2 degrees 2008.
The Makefile must be adapted for recursive calls.
Gives slightly different results, since topography is taken into account now

Files modified:
NetCDF_ml.f90, Emissions_ml.f90, run.pl, Makefile, Makefile_stallo, Functions_ml.f90,ModelConstants_ml
(put NPROCX=4, since there are only advantges running on stallo with 8 compred to 6 CPU)


xxxxxxxxxxxxxx rv3_5_23    Peter, Dave  23rd April 2010

ReadField_CDF:
Can read latlon fields with undefined values. Define UnDef to give value put into
 the gridcells which are not defined.

PhysicalConstants_ml: earthradius


xxxxxxxxxxxxxx rv3_5_22    Dave,  22nd April 2010

DryDep, My_DryDep, My_Derived

Bug-fix needed when reducing number of Derived outputs:

  Hard-coded numbers (1..3) in Mosaic_Met for RTH replaved by MMC_RH
  MMC_USTAR etc.  Prevents assignment when variables now asked for in My_Derived

Also number of default outputs reduced. Will continue this process further
one day. Use of d_2d and EXTRA_SITES in My_Outputs also very crude - should
really be improved,... one day.

xxxxxxxxxxxxxx rv3_5_21    Peter, Alvaro,   21st April 2010

Two bugs found by Alvaro (CWF):
Nest_ml: istart,jstart,iend,jend, was wrongly defined in mode 11,12 or forecast

NetCDF_ml:"if((abs(rdays-rdays_time(1))>0.00001))"
replaced "<" with ">". Used when outputting 3D on a limited number of levels.


xxxxxxxxxxxxxx rv3_5_20    Agnes,   19th April 2010

GlobalBCs_ml   - updated for 2008 data, also default of 1998-2008 average

xxxxxxxxxxxxxx rv3_5_19    Peter,   15th April 2010

Cleaned the  ReadField_CDF routine

xxxxxxxxxxxxxx rv3_5_18    Dave,   14th April 2010

run.pl

    -- modified to do some checks which will avoid the previously
    unhelpful crash of the code with missing rough.dat error. This
    was 99% of the time casued by $GRID being set to one domain in
    run.pl, but the ModelConstants_ml had an other domain.

    We now check the x-dimension of ModelConstants, and in  run.pl:

 die "Domain mis-match Model: $XDIM Grid $GRID" if (
    ( $GRID eq "EMEP" && $XDIM != 170 ) or
    ( $GRID eq "EECCA" && $XDIM != 132 ) or
    ( $GRID eq "GLOBAL" && $XDIM != 360 ) );

In addition, run.pl now compares the CM_ChemSpec file in your
Unimod directory with that in ZCM_$Chem. This might help if we have an EmChem09RF
version for example. The $Chem variable is added to runlabel2 and so
stored in the netcdf files also.

  $runlabel2 = "${testv}_${Chem}_${scenario}_$year\_Trend$iyr_trend";

xxxxxxxxxxxxxx rv3_5_17    Peter,  13th April 2010

Met_ml: bug in def of gl_fdom when lon lat gl_fdom(i,j) -> gl_fdom(i,1)
NetCDF_ml: ReadField_CDF also accep files without time dimension

xxxxxxxxxxxxxx rv3_5_16    Peter,  12th April 2010

Convection: (Advection_ml), bug in flux limitation (only used with 2008 meteo)

Aircraft emissions: assume k coordinates as first index in airn (more efficient,
but not compatible with the syntax of most other arrays)

NetCDF_ml: Can  read any projection, given lat and lon of each gridcell.
First (primitive version...)

xxxxxxxxxxxxxx rv3_5_15    Dave,  11th April 2010

Derived_ml

   BUG fix. SOMO35 was calculated incorrectly (somo_calc used index, wereas
   XYCL should be used, to get the 35.). Added debug_flag to somo_calc also.

My_Derived_ml. Just some comments updated

xxxxxxxxxxxxxx rv3_5_14    Peter

Upgrade of ReadField_CDF.
1) Can read 3D data (but no interpolation in vertical yet).
(In progress: 2) Can  read any projection, given lat and lon of each gridcell.)

Also corrected two bugs (wrote in Rvar with 1st dimension limax instead of
maxlimax and omitted IRUNBEG)

NetCDF_ml
ForestFire
LandPFT
Emissions
Par_ml

Aircraft: new emission file
run.pl
    $ifile{"$DataDir/AircraftEmis.nc"} = "AircraftEmis.nc";

Unimod.f90

Setup1d_ml:
Bug in AIRNOX (introduced in rv3_4? Effect: no AIRNOX below KCHEMTOP).
if ( AIRNOX  ) then k=KCHEMTOP,KEMISTOP,KMAX_MID

Why is AVOG   = 6.023e23 (instead of 6.02214179e23)?

 + Dave....

swapped  gl_glob => gl_fdom, gb_glob => gb_fdom, affects:

GlobalBCs_ml.f90
GridValues_ml.f90
Landuse_ml.f90Met_ml.f90
Met_ml.f90
NetCDF_ml.f90

xxxxxxxxxxxxxx rv3_5_13  Dave/Peter  Apr 6th  2010

** Bug ** in Country_ml: The default country (index 67), had timezone=0 (meaning GMT),
should be -100 (meaning longitude determined).
This has been introduced in rv2_7_1 (in 2007, when introducing a lot of "shipping" countries)
Should affect mostly (only?) global runs.

Derived_ml:

  SURF_ppbC_VOC added in Derived_ml.
  Older Setup_VOC code moved into Setups()

My_Derived_ml : SURF_ppbC_VOC added

ModelConstants_ml : re-arranged to put FFULLDOM.. and RUNDOMAIN
  closer together - will hopefully help to stop errors (e.g. missing
  rough.dat) caused by mis-matched domain sizes.


xxxxxxxxxxxxxx rv3_5_12  Dave   Mar 31st  2010

Small corrections:

1) to continue use of logical dt_scale instead of real:

My_Derived_ml
EcoSystem_ml

2) tidy-ups spotted by gfortran's pedantic mode:

Emissions_ml - tabs  and some unused variables removed

LandPFT_ml - space added in "Emt_ "
Met_ml     - very long line (<130 chars) shortened. Should try for < 78
My_Outputs_ml - spaces in SONDE_XTRA init

xxxxxxxxxxxxxx rv3_5_11  Peter  Mar 29th  2010

Convection routines included. Not used by default.
must set use_convection=.true. in ModelConstants_ml to be used
Modified:
MetFields_ml
Met_ml
Advection_ml
ModelConstants_ml

Not tested!

xxxxxxxxxxxxxx rv3_5_10  Dave  Mar 25th  2010

Main change:
Emissions added as standard netcdf outputs. Done so far for
"Grid" emissions and isoprene. Not yet aircraft,forest-fires
etc.

Preparatory changes: some code for use of LPJ landcover data


Emissions-associated changes:
-----------------------------
Biogenics_ml:   EmisNat array added to store emissions

Derived_ml:  processing of EmisNat and SumSnapEmis added with
            NatEmis and SnapEmis types.

            dt_scale now changed to logical. If set true
            the outputs are mutliplied by dt_advec*scale, if
            false just by scale.

            Some tidy-ups

Emissions_ml : SnapEmis processing added

GridValues_ml:  Array GridArea_m2 added  ( = GRIDWIDTH_M*GRIDWIDTH_M*xmd(i,j)


OwnDataTypes_ml: dt_scale now changed to logical.

Setup_1d_ml:  EmisNat processing added


PFT (plant-functional-type)/LPJ changes:
----------------------------------------

** LandPFT_ml ** added to read LPJ/PFT

DO3SE_ml: more debug options

DryDep_ml -  Call SetLandUse moved to Unimd.f90
             Possibility of LU_cdf removed for now

LandDefs_ml - added %has_lpj and %pft to LandType defs and
              Inputs_LandDefs.csv

Landuse_ml - uses LandPFTs - just for preliminary testing and
             comparison so far. Many debug statements.

ModelConstants_ml : DEBUG_LANDPFTS added

Unimod -  Call SetLandUse moved here from DryDep

Other
-----

My_Outputs - some of the column outputs commented out


xxxxxxxxxxxxxx rv3_5_9  Peter  Mar 23rd  2010

Small change in ForestFire_ml:
do not use forestfire if year>2007 (we don't have data yet).
Landuse_ml: do not "use" Read_Local_Inter_CDF

xxxxxxxxxxxxxx rv3_5_8  Dave  Mar 22nd  2010

Interim-change while modifying landuse changes:

NetCDF_ml: debug_flag added to ReadField_CDF
           stop replaced by StopAll

           Read_Local_Inter_CDF commented out for now - not used
           wit current system. Reconsider later

xxxxxxxxxxxxxx rv3_5_7  Dave  Mar 15th  2010

(Peter:)Bug in ReadField_CDF (NetCDF_ml) : did not work if file is not 1 degree resolution

Bug-fix - added HONO dry dep into system (was missing)

Needs attention: Shoud give 2nd look to molwt for PPM25_FIRE

*** Main change **** (Works with EmChem09 only so far!!)

Added grouping-ability to GenChem, which now extends CM_ChemSpecs_ml
with e.g.:

 integer, public, parameter, dimension(2) :: &
             PMCO_GROUP     = (/ PNO3,PPMCO /)

  integer, public, parameter, dimension(2) :: &
             SOX_GROUP     = (/ SO2,SO4 /)
..
  integer, public, parameter, dimension(4) :: &
             SIA_GROUP     = (/ SO4,PNO3,ANH4,ANO3 /)

  integer, public, parameter, dimension(6) :: &
             PM25_GROUP     = (/ SO4,ANH4,ANO3,PPM25,PPM25_FIRE,SSFI /)

! ------- Dry dep      species ------------------
  integer, public, parameter, dimension(6) :: &
               DDEP_OXNGROUP = (/ HNO3,PAN,NO2,ANO3,MPAN,PNO3 /)
  integer, public, parameter, dimension(2) :: &
               DDEP_SOXGROUP = (/ SO2,SO4 /)
  integer, public, parameter, dimension(2) :: &
               DDEP_RDNGROUP = (/ NH3,ANH4 /)

These "groups" are to be "use"d in the rest of Unimod,  so that one
doesn't have to hard code the indices separately.  btw I haven't added
a PM10 group, since that is the sum of PM25 and PMCO. We should think
how to code some of these supergroups to avoid uncessessary operations
in the model.

I have just managed to re-instate one of the older groups so far,
SIA which is now SURF_ug_SIA. Other groups, e.g. PM25 can be
quickly added following this pattern though.

Background: defining such "groups" in the GenIn.species file and letting
Genchem handle them automatically has many advantages.  Not least, we can
change chemical scheme without breaking the code or making errors. For
example, the old code for PM25 defined just a few species. In future
we may want to add seveal new species such as OC, EC, from fires, or
SOA. Or we may want to use a carbon-bond scheme or CRI.

The principal being aimed at is that GenChem needs to know about the
chemistry, Unimod shouldn't.


xxxxxxxxxxxxxx rv3_5_6  Peter  Mar 12th  2010

Advection_ml (PhyChem_ml):
Use always the advecdiff_poles routines. (until now it was only used in the global runs,
in other runs advecdiff was used).
advecdiff will be completely removed later (after a test period to see that we don't need it).

advecdiff_poles is also slightly changed:
no renormaliztion with ps-PT between x, y and vertical advection.
division by max(psi,1.0) instead of psi. NB: bad winddata will not crash the model anymore,
and therefore we won't get any warning.

ForestFire/NetCDF: safer interpolation routine


xxxxxxxxxxxxxx rv3_5_5  Dave  Mar 9th  2010

BLPhysics

    - added routines for O'Brien, Jericivic Kz, Seibert Kz and Hmix
    - parameters to switch Kz, Hmnix routines
    - parameters for e.g. USTAR_

    default options give:
      Hmix from Jericevic Rb method
      Pielke/Blackater Kz outside PBL
      Kz from O'Brien for unstable conditions
      Kz from Jericevic/Grisogono for stable conditions

   with DEBUG_BLM true, the log file will compare Hmix and
   Kz from all routines for the debug cell.

Met_ml

  Big rewrite of tiphys, now called BLPhysics

  met_derived now has nt argument (1 or nr as appropriate),

  More documentation at start

  Removed most Kz, Hmix calculations - now done by routines from BLPhysics_ml.

  Code could be optimised further, but is only called every 3 hours so
  should be okay. Should delete 3D Kz though and keep just SigmaKz as
  3-D fields.

MetFields_ml

   - invL_nwp added. Query on limits, also ustar?
   - limit on ustar over land > 0.1 m/s (or MIN_USTAR_LAND)

ModelConstants_ml

    OFFSET_X, OFFSET_Y introduced to make coordinates match
     EMEP or EECCA grids. (Set to zero for EMEP, -35,-11 for EECCA


xxxxxxxxxxxxxx rv3_5_4  Haldis/Dave  Feb 28rd 2010

Start of NWP_Kz work and testing of other Kz options

  Met_ml, MetFields_ml now deals with Kz read in from met

  BLPhysics - Brost+Wynaarg  formula added for testing
              SigmaKz-

  Derived_ml.f90  AddNewDeriv( "D3_Kz", ....

  GlobalBCs_ml.f90  Macehead O3 added as 2008=2007

  My_Derived_ml.f90   D3_OTHER  = (/ "D3_Kz          " /) added

  My_Outputs_ml.f90  SONDE_XTRA=  ....  "xksig"  added


  Rename:  xksig becomes  Kz_m2s
           skh   becomes  SigmaKz  (Kz in sigma coords)

xxxxxxxxxxxxxx rv3_5_3  Dave  Feb 22nd 2010

*** MetFields_ml ***  now has all met fields defined here

  Bug spotted?? Not understood though - SST was defined as
  3d (:,:,KMAX:MID) field, but setting to 2d (:,:,NMET)
  doesn't change results. Don't know why.

BLPhysics - several Hmix options added. Results for "TI" physics
      zi checked  and identical to those of tiphys routine. Will
      replace completely soon, getting rid of several routines.
      For now the routines in BLPhysics are waiting for use.

ChemFunctions_ml, EPSIL in friemer for safety
      - div by zero spotted by Peter

GridValues_ml
      A, B replaced by A_bnd, B_bnd

Various small tidy ups

xxxxxxxxxxxxxx rv3_5_2  Dave  Feb 18th 2010

Met_ml   - Bug-fix  (many years old bug!!!)
           real winds used in Ri dvdz calculation.
           New arrays u_mid, v_mid used, and u_ref simplified too.

*** MetFields_ml **** new. Will gradually move most met fields here, and
       keep Met_ml for subroutines and processing.


*** felt stuff removed :-)   (100s lines gone, double :-)

 changes in many modules to use MetFields for wind, ps, sdot


xxxxxxxxxxxxxx rv3_5_1  Dave  Feb 18th 2010

My_DryDep_ml -- Bug-fix!! (first_vgr_call didn't work as expected)

And renaming of wind fields to u_xmj, v_xmi
(Peter's suggestion - these have not really physical meaning, they are actually divided by the mapping factor in the perpendicular direction).

NOTE: The many-year old problem with Ri being calculated with the wrong winds is
still not corrected. I've added some !WAIT marks to relevent bits of the code to
help remind about this.....

xxxxxxxxxxxxxx rv3_5  Dave  Feb 15th 2010

Dry deposition finally settles down .., so I stop the beta's and move
straighy to rv3_5.

New module:

BLPhysics_ml.f90 ---  Intended as a place to put calculation of Hmix, Kz, etc.
  Will move more of tiphys here in future. Currently the model contains some
  code for testing Amela's Hmix ideas. Not used except in DEBUG mode.

AeroVds

  - Now use GPF_Vds300f for forests and Wesely300 for other land-classes.
    Hopefully a reasonable and consistent set of Vds for PM2.5 calculations

xxxxxxxxxxxxxx rv3_5beta5  Dave  FEb 3rd 2010

run.pl - Revert to NOV2009 emispslit files, which do not contain PPM25_FIRE.
Will re-implement fire shortly...

xxxxxxxxxxxxxx rv3_5beta4  Dave  Jan 21th 2010

PPM25_Fire added to species, changing CM_ChemSpecs_ml and
            CM_Reactions in ZCM_EmChem09

SPLITS_JAN10 now used for input speciationinstead of SPLITS_NOV09

   - same, but with forest-fire emissions added to country 101, sector 11,
     in specials file.


xxxxxxxxxxxxxx rv3_5beta3  Peter Jan 20th 2010

Changes to prepare for flexible vertical coordinates.

GridValues: defined A and B, parameters vertical coordinates to be
read from metfile later
ModelConstants: Pref= 101325.0  Reference pressure in Pa

Replaced Pressure expressions from sigma to eta nomenclature in:
Aqueous_ml, DryDep_ml, Sites_ml, Setup_1d_ml, GlobalBCs_ml


And other small changes:

run.pl: link without "ifile" for BIC, so that the script does not check if the file exists:
it can do without local BIC, by interpolating the global BIC file.

ForestFire_ml: use GLOBAL_ForestFireEmis.nc instead of ForestFireEmis.nc. They are equal, but
I prefer to have as many non gridspecific files as possible in DataDir.

Nest_ml: Allow the BC and the IC files to be different. (required by Alvaro). Not tested yet.

None of the changes before change the results.


xxxxxxxxxxxxxx rv3_5beta2  Robert Jan 15th 2010

ZCM_EmChem09/CM_ChemRates_ml.f90: bug fix, rate of O+O2+M -> O3

xxxxxxxxxxxxxx rv3_5beta1  Joffen, Peter, Svetlana, Dave Jan 13th 2010

 **NEW**  ForestFire_ml introduced. Most of the work done here. Called
     from Setup_1d_ml

 Note also new "PrintLog" routine in Io_ml - hopefully to be used
    more in future to help write a neat log file.

Biogenics_ml - use NBVOC instead of 2 for ReadSDN. Allows NBVOC to be
    set to one for some runs

Country_ml : Biomass-burning (Wild-fires etc.) allocated to a country-number
    integer, parameter, public :: IC_BB  =  101

EmisDef_ml.f90: logical  FOREST_FIRES added

EmisGet_ml.f90   FOREST_FIRES debug Checking

Io_Progs_ml    PrintLog subroutine added

Makefile.SRCS ForestFire_ml added

ModelConstants_ml.f90 DEBUG_FORESTFIRE added

NetCDF_ml - reinstated print for missing variable ReadField_CDF

Unimod.f90 FF added.

Volcanoes_ml   NMAX extended to 12 (is this enough for global)

My_ some extra column outputs added for a project I'd doing. Should be
   removed in future, but for now it helps me (DS).

xxxxxxxxxxxxxx rv3_4_13 Peter,    14 Dec. 2009 xxxxxxxxxxxxxxxx

Bug in ReadField_CDF in NetCDF_ml (read of ForestFire).
Include a safer area when Poles are nearby.


xxxxxxxxxxxxxx rv3_4_12 Dave,    11 Dec. 2009 xxxxxxxxxxxxxxxx

AOTx_ml now extended with more code from Derived_ml.

       -  for grids AOT calc now done in AOTx_ml, function Calc_GridAOTx

       - also setaccumulate_2dyear.

      (** NOTE ** though - the accumulation periods have not been taken care
       of yet, so be careful to use monthly outputs if needed. Still,
       these Grid-average data are hardly needed any more, except for
       comparison to older results and measurement-derived AOTs.
       The newer Mapping manual requires vegetation-specific AOTs)

IOU_ indices moved to ModelConstants_ml, to reduce dependencies
   in NetCDF_ml --- > small changes in many modules

xxxxxxxxxxxxxx rv3_4_11 Haldis,  10 Dec. 2009 xxxxxxxxxxxxxxxx

3-D My_Derived outputs reinstated using new Deriv system. Now
     have D3_PPB and D3_OTHER possibilities

(+ some small tidy ups,
+ BUG-fix for ugS to ugN concentration outputs (N-compounds)
  in Derived_ml, Dave)

xxxxxxxxxxxxxx rv3_4_10 Dave,     5 Dec. 2009 xxxxxxxxxxxxxxxx

Changes made while implementing clover as an option for Fst outputs
 - also includes some general tidy-ups

AOTx_ml - no real change, but a draft clover growing period added
          as comment

Derived_ml - column data now uses vertical starting level, to allow
           use against mountain sites

EcoSystem_ml - dt_scale added - see below

EmisGet_ml - small tidy up

LandDefs_ml - iLC_grass defined for clover usage

LocalVariables_ml - use FstO3 instead of leaf_o3flux

ModelConstants_ml - Added DEBUG_CLOVER

My_Derived_ml - VPD, FST added to MMC_ possibilities.
                More Fst output.
                dt_scale set

My_DryDep_ml.f90 - outout for ozone flux (FST) added

My_Outputs_ml - examples of landcovermet, e.g. RH_GR

OwnDataTypes - dt_scale added - will inform prog of scalin factor
         needed to get from instantaneous d2_  value to accumulated,
         assuming values multiplied by dt_advec
         e.g. for AOT, we need to multiply by dt_advec/3600.0 to
         get ppb.h, so we set dt_scale = 1.0/3600.0

PhyChem.f90 - small tidy up

StoFlux - clover coding added. Clover pots take their O3 from the
         grassland class (which therefore needs to be set 1st)

xxxxxxxxxxxxxx rv3_4_9  Dave,    28 Nov. 2009 xxxxxxxxxxxxxxxx

**New** module AOTx_ml.f90 - a place to keep definitions of AOT

CellMet_ml  - ResetSub added to ensure proper reset at start of each i,j
Derived_ml  - small format changes

DryDep_ml - uses METCONC_AT
               remove call to Init_StoFlux, fewer parameters in
          call Add_MosaicOutput

LandDefs_ml - use LandType()%flux_wanted
Landuse_ml  - iam_wheat code removed (not functioning)
LocalVariables - added cano3_ppb, leaf_o3flux, ResetSub
ModelConstants_ml - added DEBUG_STOFLUX
Setup_1d_ml - added my_first_call to limit number of volcano printouts
StoFlux_ml -   uses Sub(iL)%leaf_o3flux %cano3_ppb instead of
               c_hvegppb array
               remove sub Init_StoFlux
TimeDate_ml - added effectivedate here

My_Derived_ml - changed AOT system
                Allow MMAOT, EUAOT
                Added CanopyRH and RH to possible Mosaic outputs
My_DryDep_ml - adapted to new AOT system
               use of lossfrac removed
               tidy up of "select case" options - use of Calc_AOTx
My_Outputs_ml - examples with e.g. VPD_GR, CanopyO3_GR

xxxxxxxxxxxxxx rv3_4_8  Peter,   25 Nov. 2009 xxxxxxxxxxxxxxxx

Met_ml: does not stop if rh2m is not found, but set it to a meaningless value

xxxxxxxxxxxxxx rv3_4_7   Dave,   19 Nov. 2009 xxxxxxxxxxxxxxxx

CellMet_ml - rh2m replaces rh for grid met

Derived_ml, som replaced by somo, SOM by SOMO.

DryDep - zero index allowed for Mosaic_Met, to collect grid-values

My_DryDep - zero index allowed for Mosaic_Met, to collect grid-values

Met_ml  - relative_humidity_2m read from metcdf files (for tests
   and possible replacement of mosaic rh calculation)

Global change, tabs replaced by 4 spaces
(might mess up some code-indentation in a few files. Please fix
when seen!)

pedantic changes for DryDep - removed or commented out (dsVDS)
unused variables.

xxxxxxxxxxxxxx rv3_4_6   Dave,   15 Nov. 2009 xxxxxxxxxxxxxxxx


Re-write of many Derived fields and usage. This work is only
partly complete, and so some "old" derived fields aren't
yet in the new system. Still, many of them need re-thinking
anywa, and many need to be included in a cleaner "SURF_UG"
type approach.

All use an expanded "Deriv" data type,

Derived_ml

   - many simplifications
   - AddDeriv and AddNewDeriv replace AddDef
   - nMosaic, MosaicOutput includes all of what used to be
        nOutDDEP, OutDDep, nOutVg, Out.... etc.

DryDep_ml

    - call to Add_MosaicOutput replaces Add_Vg, Add_RG, Add_LCC

EcoSystem_ml

    - small changes (TXTLEN_UNIT -> TXTLEN_SHORT
    - use of new Deriv for DepEcoSystem

EmisGet_ml:  internal read of MassValue%value changed to MassValue(1)%value to
EmisGet_ml:  internal read of MassValue%value changed to MassValue(1)%value to
  satisfy older gfortran.

My_Derived_ml:

    - use of new MosaicOutput and Deriv type.
    - Note, not all outputs have been converted to new system yet. Just
      commented out for now.

My_DryDep_ml:

    - use of new MosaicOutput and Deriv type.
    - subroutine Add_MosaicOutput replaces Add_Vg, Add_RG, Add_LCC

OwnDataTypes - expand Deriv type, replace print_dep_type with
   print_deriv_type, remove "dep_type"

Sites_ml

    - "hmix" special case removed. Use "HMIX" and "D2D" in My_Outputs instead


xxxxxxxxxxxxxx rv3_4_5   Alvaro, 10 Nov. 2009 xxxxxxxxxxxxxxxx

run.pl - corrected bugs introdiced on rv3_4_2

Makefile_titan - small change for linking rule (makedepf90/Depend/.depend)

xxxxxxxxxxxxxx rv3_4_4   Peter, 9 Nov. 2009 xxxxxxxxxxxxxxxx

GridValues_ml.f90,Met_ml.f90,PhyChem_ml.f90: use Pole_included instead of Poles.
Should make the global model work also when NPROCY >2 (but still in an inefficient way).

Nest_ml : use dayssince1900 for nesting.

run.pl: linked monthly gridded emissions if GLOBAL

xxxxxxxxxxxxxx rv3_4_3   Alvaro, 6 Nov. 2009 xxxxxxxxxxxxxxxx

Advection_ml - corrected bug introdiced on rv3_4_2

xxxxxxxxxxxxxx rv3_4_2   Alvaro, 6 Nov. 2009 xxxxxxxxxxxxxxxx

Makefile_titan - added file: titan.uio.no version of Makefile

Makefile_gfortran - added Ubuntu 8.04 pedantic setting for INCL, LLIB & LDFLAGS

OutputChem_ml - avoid double output when End_of_Run==END_OF_EMEPDAY
              - pedantic: remove unused variables icmp and scale (Wrtchem)

EmisDef_ml - increase FNCMAX to 20

ModelConstants_ml - added FORECAST logical variable to enforce FORECAST run mode
                  - added (commented) definitions for GEMS/MACC domain
                  - cleanup, alignment and formatting of comments

Derived_ml - only dayly (and hourly) output on FORECAST mode

Advection_ml - enforce dt_advec=600.0 on FORECAST mode
         - ycmax minimum value consistent to xcmax definition
         - replace amin1/amax1 by min/max intrinsics
         - uniform names for Add_2timing calls
         - cleanup, alignment and formatting of code & comments
         - pedantic: remove the following unused variables
             adv_var    dhskmax,ulmin,ulmax,vlmin,vlmax,
                        sdotmink,sdotmax,sdotmin,sdotmaxk
             preadvx    request1,request2
             preadvx2   request1,request2
             preadvy    request1,request2
             preadvy2   request1,request2
             advx       x3,nn
             advy       x3
             advvdifvk  adif,bdif,cdif,e1,n
             vgrid      i,j
             advecdiff  n,l,dtsave,dhskmax,
                        sdotmin,sdotmax,sdotmink,sdotmaxk,sdotmaxadv,
                        ulmin,ulmax,vlmin,vlmax,ucmax,vcmax,
                        inadvst,firstcall,lvertsplit,sum,
                        numt,idebug,jdebug,i_fdom,j_fdom,pwdebug
             advecdiff_poles  l,dhskmax,c_max,dtsave,inadvst,lvertsplit,
                        sdotmax,sdotmin,sdotmaxk,sdotmink,sdotmaxadv,sum,
                        ulmin,ulmax,vlmin,vlmax,ucmax,vcmax,
                        dt_xysmax,dt_xymax,dt_xys,dt_xy,
                        numt,idebug,jdebug,i_fdom,j_fdom,pwdebug,
                        hours,houre,houra,date_ad,iterxy,niterxy

PhyChem_ml - use advecdiff_poles on FORECAST mode even if poles are
             not contained on the model domain

GlobalBCs_ml - use 10-yr average Mace-Head correction on FORECAST mode
             - pedantic: remove tabs and the following unused variables
                 GetGlobalData  buf_lon,buf_lat,bufi,bufj,val,oldmonth
                 setgl_actarray i1
             - pedantic: initialize variables
                 real:: USso2trend=1.0,USnoxtrend=1.0,USnh4trend=1.0

NetCDF_ml - time units "time at end of period" for hourly output

Met_ml - ensure positive precipitation

Nest_ml - nested input/output on FORECAST mode:
          Read nested input (all ADV variables) at start of the run
          and write nested output (all ADV variables) one/two date-times.
          The first nested output will be used to start next day forecast.
          The second nested output can be used for NMC statistics.

Unimod.f90 - open only output netCDF files if needed
           - hourly output for hour "zero" on FORECAST mode
           - write 'modelrun.finished' file to flag the end of the FORECAST
           - nested input/output on FORECAST mode
           - pedantic: remove unused variables fileName & iotyp

run.pl - add titan setup
       - add Forecast mode (CWF) and FORECAST grid

xxxxxxxxxxxxxx rv3_4_1    Peter  6 Nov 2009 xxxxxxxxxxxxxxxx

New routine ReadField_CDF , which reads a global lat-lon file with data and
interpolates into subdomain. Note that all CPUs read the same file simultaneously.
In the future this can be developed into explicit parallel reads.
This routine will soon be used for reading forest fires emissions.

Met_ml: more robust definition of gl_stagg (staggered longitude)

run.pl: link to global forest fire emission file.

xxxxxxxxxxxxxx rv3_4     Dave, Robert  6 Nov 2009 xxxxxxxxxxxxxxxx

Small corrections to ZCM_EmChem09. EXTRA_ITER=1 in Solver_ml

xxxxxxxxxxxxxx rv3_4beta Dave, Robert  5 Nov 2009 xxxxxxxxxxxxxxxx

Signficant change in handling of emissions.  New chemistry.
-----------------------------------------------------------

1) Emissions

No need to specify in advance NEMIS_PLAIN, NEMIS_SPLIT etc. Instead,
the code (EmisGet) figures out from the new emissplit.defaults.xxxx
files how many species each emission consists of. Every pollutant now
has to have an emissplit.defaults file, with headers.  Eliminates a lot
of code and confusion (IMHO) :-)

The emissplit files also contain a MASS_ASSUMED variable. Set to
zero if the code can just figure out the emissions from the real
species. For NOx as NO2, we set 46, for SOx as SO2, set 64.

My_Emis_ml --- ** deleted **

EmisDef - now simpler. Define your emission files here.

EmisGet_ml now does more work, but doesn't need to worry about PLAIN
versus SPLIT.

Setup_1d_ml
Setup_1dfields_ml

run.pl  - now uses $SplitDir = $DATA_LOCAL/SPLITS_NOV2009/BASE_MAR2004
(CLE case not done yet)

Io_Progs_ml - small improvements (for safety)
RunChem_ml  - small changes
Solver_ml - small change (Fgas moved)
Timefactors - mainly use of NEMIS_FILES
Volcanos_ml  --NOTE - used hard-coded MW=64 here. Ran out of energy..
(and such info should be in Volcano input file)


2) Chemistry
ZCM_EmChem09 introduced. Uses rate-updates fro Robert/Conny (2008 work)
plus other improvements arising from chemistry comparison with
Garry Hayman. This '09 version is now the default chemistry.

Plus (Alvaro)
My_Derived_ml - made compatable with older gfortran through use of
tag_name (gfortran or gcc bug, solved for those with Ubuntu Jaunty
of Karmic, affects Hardy, in which   "AAA" // "BBB" wasn't accepted for
strings in AddArray.

xxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3_3 Dave,  24  Oct. 2009 xxxxxxxxxxxxxxxx

Log.changes : all equals signs changed to xxxx, as cvs seems to
be confusing these lines with conflict indicators. Will have
caused some strange lines where equations had a real =, but life
will be easier from now on.

EmisGet_ml - reformat of vocsplit write-out

SmallUtils_ml - errmsg added to AddArray

My_Derived - errmsg in AddArray, and CheckStop - prevents wanted_deriv2d
             exceeding MAX_NUM_DERIV2D (x200 which is a lot anyway!)
           - also just use HNO3 by default in NNDRYDEP -
           - and SO2, SO4 in WETDEP -
           - explicit write_condition added

My_Outputs - all SHL species by default for sites

xxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3_2 Dave,  18  Oct. 2009 xxxxxxxxxxxxxxxx

QRCISOP replaced by QRCC5H8 for consistency across chemical schemes
rcbio changed to simple 1-d array (rcbio(NBVOC), public from Setup_ml
setup_rcemis now adds the biogenic rcbio() to the posisbly anthropogenic
rcemis(QRCC5H8,:) arrays. CM_Reactions uses the latter.

CM_ files changed to reflect C5H8

Small formatting changes (numerous in CM files)


xxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3_1 Peter, 12  Oct. 2009 xxxxxxxxxxxxxxxx

Bug in dayssince1900 (NetCDF_ml). Timestamps were wrong

Dave - re-committed My_DryDep, My_Derived mls, hopefully.  (Some confusion
in cvs here.)

xxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3 Dave, 11  Oct. 2009 xxxxxxxxxxxxxxxx

New *EcoSystem_ml* introduced to include definitions for EcoDep
  new netcdf outputs of e.g. Area_Grid_km2, Area_Conif_Frac

-> CHanges in Derived_ml, My_Derived, Unimod.f90, My_DryDep, DryDep
    (maybe others...)

RO2POOL introduced in Solver to cope with CRI chemistry

Makefile_gfortran added. Code compiles with stricted flags (although
  with lots of warning!)

 !!!!****** ZD_ACID removed ****!!!!
 Functionality must be created through GenChem system now.


xxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3beta5, Garry/Dave,  9  Oct. 2009xxxxxx

Changes from Garry to enable g95 compilation - mainly needing lengths
of strings in initialisations to be the same.

My_DryDep_ml
My_Outputs_ml
My_Derived_ml

I also made some minor tidy-ups in My_Derived_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3beta4, Dave,  9  Oct. 2009xxxxxx

Changes to ease compilation with gfortran, and execution on PC.

Derived_ml.f90 :  f_3d -associated code changed to make it easier to skip
                  this. Needed for PC runs (at least on my PC):

                  Some unused arguments removed also from functions


Also some unused variables (spotted by pedantic gfortran option) removed
   Timing_ml, Unimod.f90, Ammonium_ml, GridValues_ml, NetCDF_ml, PhyChem_ml,
   Sites_ml


Note that in Solver_ml, EXTRA_ITER is set to 3, not 1. This is for safety while
testing different chemical schemes, and can hopefully be reduced back to 1 soon.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3beta3, Dave,  7  Oct. 2009xxxxxx

Derived_ml: AOTs restored, to some extent anyway.
    AOTs and fluxes now treated in same VEGO3 methodology

My_Derived_ml - lots of changes to get AOT, VEGO3 etc.

My_DryDep_ml  - lots of changes to get AOT, VEGO3 etc.

ChemFunctions_ml: kmt3 added

EmisGet - small extra debug output

RunChem_ml - removed QRCISOP from printout line. Not is all CM versions now.

+fixed some forgotten commits from last-version (My_files weren't updated
in ZD_OZONE, and OwnDataTypes_ml)

Many changes now marked with !Oct09 or !DSGC. The comments mess up the code
and will be cleaned out in a revision ort two.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3beta2, Dave,  5  Oct. 2009xxxxxx

GenChem enabled EMEP chemistries, almost done?

New file-labelling system and directories:

ZCM_EmChem03 - contains chemical-mechanism (CM) files for EMEP 2003
chemistry vocsplit files are also chemistry dependent, so for now we
keep them with the code.

ZCM_EmChem03 directory:
----------------------
CM_BoundaryConditions.inc  CM_Reactions1.inc  vocsplit.defaults.EmChem03
CM_ChemRates_ml.f90        CM_Reactions2.inc  vocsplit.special.EmChem03
CM_ChemSpecs_ml.f90        CM_VOC_MW.inc
CM_DryDep.inc              CM_VOC_QRC.inc


The above replaces many of the  My_ files. The latter are now mainly used
to specify desired outputs, and the aerosol schemes. Thus, ZCM_EmChem03
gives the chemistry, ZD_OZONE gives whatever else is needed, and
ZD_ACID should be deleted in the near future. (ZD_ACID should be
replaced by a ZCM_ directory for acid chemistry. Somebody would need
to check over how O3 and stuff are handled though).

Thus, from Unimod.rv3_3,do:
   cp ZCM_EmChem03/CM*
   cp ZD_OZONE/My* .

GenXXXX -> ChemXXXX

In the code, "GenXXX" modules are replaced with ChemXXX modules, thus
GenSpec_adv_tot now becomes ChemSpec_adv_tot. Seemed more logical.

Note, CM_Reactions1 replaces My_FastReactions, CM_Reactions2 replaces
My_SlowReactions since the distinction was really between chemicals that
needed to be in the iteration scheme or not (as they reacted further),
not just speed.


Chemical schemes can be swapped with the mk.GenChem script, which will
be added in CVS somewhere very soon. So far have one "working" sheme (EmChem03),
and one almost-working, EmChem09. Will soon add carbon-bond, CRI, and others

More  changes to make it easier to swap chemistry (coming soon...) :

  My_Derived_ml - uses groups from ChemGroups_ml, removes hard-coded OXN etc.

  My_DryDep_ml - now includes "CM_DryDep.inc" from GenChem's ZCM_EmChem03 directory

  CM_ .... files now from GenChem's ZCM_EmChem03 directory

Plus:

  COLUMN-data added to Derived and My_Derived_ml, simplified calculation

  **New** OwnDataTypes_ml created to store user-defined types. Mainly
  intended to make My_* files shorter. Used so for dep_type, Deriv, SOA-VBST

  Causes modifications (and small tidy-ups) to:
      Derived_ml, My_Derived_ml, NetCDF_ml, Nest_ml

Status and ToDo
-----------------
I think that the GenChem-associated changes are basically done (though of
course I am sure changes will be needed!).

The code still needs work to recover some outputs, notably AOT40, which were
omitted during the changes to Derived and My_Derived (rv3_2_13 onwards).
All gas-phase and deposition outputs look fine, afaics.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3beta, Dave,  1  Oct. 2009xxxxxx

 GenChem enabled EMEP chemistries
 Caveat: New code seems to work fine, but the numerics  of all rv3_2.. are
 slightly less optimised compared to rv3_1 versions (I removed Peter's
 hard-coded linking of equations in My_FastReactions). The linking
 could be re-introduced for a SR version, but for normal use I recommend
 testing with different chemistry time-steps. (So far my tests show a
 very stable system though)

Introduced ** new directory :: :

 ZD_EmChem03 -  to keep EMEP 2003 chemistry outputs from GenChem.

More  changes to make it easier to swap chemistry (coming soon...) :

  My_BoundaryConditions_ml.f90 **removed**. Some code moved to BoundaryConditions_ml

  My_BoundaryConditions.inc **added**.  Will vary with chemical scheme.

  My_MassBudget **removed**. Equivalent (simpler) lines added to My_Emis_ml
     and Setup_1d_ml

  My_ChemSpecs - module GenGroups_ml **added**, provides:

     OXNGROUP x (/ NO,NO2,PAN,MPAN,NO3,N2O5,HNO3,PNO3,ANO3 /)

     DDEP_OXNGROUP x (/ HNO3,NO2,PAN,MPAN,PNO3 /)

   ... and avoids having to hard-code these in rest of code. Please use!

  My_Outputs_ml  "&" added to please gfortran

  Sites_ml - modifed to make use of OXNGROUP

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_31, Dave,  1  Oct. 2009xxxxxx

Some changes to make it easier to swap chemistry (coming soon...) :

  Derived_ml - hard-coding for CH3CHO, MAX3DADV of CH3COO2, PHNO3 removed

  EmisGet_ml - extra safety printouts for  VOC speciation

  OutputChem_ml - uses MasterProc and more debug output with My_DEBUG


Plus....   Some changes to solve small problems spotted by gfortran:

  BoundaryConditions_ml.f90 - debug_proc removed from ModelConstants use

  CellMet_ml.f90: -1* instead of -Grid%Hd

  GridValues_ml.f90: changes of real, integer defintions

  NetCDF_ml.f90: small re-code

  ReadField_ml.f90: Use .eqv., not xx in any (cell_set .eqv. .false. )

  Solver.f90: double-def of rct removed

  My_ChemRates_ml.f90: rcmisc line split. Not sure why gfortgran complained, except
    it doesn't seem to like long lines


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_30, Dave,    1  Oct. 2009xxxxxx

Bug-fix!
My_Derived_ml index problem fixed. This bug didn't affect the model runs,
but caused the wrong output in DDEP_SOX etc. Introduced in
rv3_2_11. New code seems to work fine, but more checks would be useful

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_29, Peter,   17 Sep. 2009xxxxxx

removed -mieee-fp from Makefile and Makefile_stallo
This options made the floating point operations ieee compliant, but are now slowing down the computation
quite a lot, and even more (30% diff) with the next intel compiler version (11.1, to come on stallo in October)
If one wish to compare results between diferent machines (stallo and njord for example it may be useful
to put the option back)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_28, Dave,   16 Sep. 2009xxxxxx

My_Reactions omitted - code moved into Solver_ml
My_SlowReactions.inc added

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_27, Peter,  10 Sep. 2009xxxxxx

Changes to comply with the rotated spherical projections and new definition/units for time:
now in days since year 1900. The seconds used earlier do not run after 2037 or so and we
need to run later for climate studies.
NBNB: if you have postprocesing scripts which make use of the date read from the netcdf
files, make sure to update these!

NetCDF_ml and Met_ml are changed

Dave changed Functions_ml also, to use sin instead of sind (for gfortran
compliance), and removed 360 term.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_26, Dave,  4 Sep. 2009xxxxxx

INTERIM version - the concentrations look fine, but for some
reason WDEP, DDEP is different to older (rv3_1) results. Needs
investigating!
(Differences *not* due to changes here, likely those from
some revisions ago)

Main change: My_Chem files all come  *directly* from GenChem output
Some small change in reactions introduced here, but doesn't affect
air concentrations very much.

My_ChemSpecs_ml
My_FastReactions

*** note, since these files are from GenChem, we have lost some of
the optimisations which Peter introduced. This can one day be
coded into GenChem, or done by hand again.
   On the oter hand, GenChem got rid of some of the bugs introduced
by hand-coding ;-)

Solver_ml:  use NUM_INITCHEM, DT_INITCHEM etc., to try to make
  timestep values easier to change. Values printed out to IO_LOG


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_25, Dave, 11 July 2009xxxxxx

Some changes to make the code "safer" I hope, after being caught out by
unexpected input files when changing domain.

Input files expected:  Now expect rough.dat and Inputs.2BVOC
xxxxxxxxxxxxxxxxxxxx

Met_ml now requires rough.dat, not rough.170. The new "fill_needed"
parameter is used to ensure that this data fills the grid. Unlike
the zero sized rough.170 in the EECCA data-directory ;-)

Biogenics_ml -  now looks for Inputs.2BVOC, not Inputs.BVOC. the
reason is tat the terpene emission factors were all -999.999 in
the EECCA directory. No problem for standard runs, but a major
problem for SOA runs.
Now checks that terpene emission factor is positive, at least if NBVOC > 1


Io_Progs_ml - extra debug stuff

ModelConstants_ml - extra lines for EECCA domains, and more debug options

ReadField_ml  - optional "fill_needed" parameter added to
readfield_r and readfield_i routines.  CheckStop will stop the run if
fill_needed is true, if the domain isn't filled.

New Inputs.2BVOC file created for EECCA

run.pl - now has $GRID which can be EMEP, GLOBAL, EECCA etc.

MassBudget_ml: small format change

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_23, Alvaro, Haldis 6 July 2009xxxxxx


Changes to My_Outputs_ml.f90 and Output_hourly.f90 to solve bug with units
(ugSm3 etc.). General ADVugXX used for all mass-based outputs in Outputs_ml,
with units to be chosen in My_Outputs_ml.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_22, Peter 30th June 2009xxxxxx

GridValues_ml, NetCDF_ml, et_ml:
Defined "rotated_latitude_longitude" projection following CF-1.0 convention.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_21, Dave, 24-26th xxxxxx

found_ind2d, found_ind3d added to Derived_ml to esnure that we
don't try to define the same variable twice.

Comma removed in GLobal_ml, needed to compile

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_20, Peter, 24th June 2009xxxxxx

GridValues_ml:
Added the general case in lb2ij, which gives (i,j) values (as real numbers) given
longitude and latitude for any grid projection.
Used for sites/sondes given as lonlat.

Function_ml, Nest_ml:
Moved great_circle_distance into Functions_ml.


Note: The new default compiler on stallo (ifort 11.0), gives a segmentation fault
on line 711 in NetCDF_ml, when compiled with debug options. After closer look, this is most probably due to
a bug in the compiler...


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_19, Peter, 2nd June 2009xxxxxx

Small change for compatibility with rotated spherical projection (H20)

Met_ml:
-180<gl_glob<180

NetCDF:
Compatibility with GLOBAL_BIC (see rv3_2_4)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_18, Agnes, 1st June 2009xxxxxx

GlobalBCs_ml:

update of Mace-Head ozone values, now with average from 1998-2007. Also
recalculated the 2006 and 2007 Mace Head values with the new 10-year
average.

Commented out the +3 (4.5) ppb scaling for future years (2010 and later),
so the 1998-2007 10-year average will be used for these years.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_17, Peter, 28th May 2009xxxxxx

Solver.f90:
nchem is now set to 10 when dt_advecx600

Advection_ml:
Larger dt_advec for fine resolution

Functions_ml, NetCDF_ml:
Move "inside_1234" into Functions_ml

My_Reactions.inc:
We go back to the "toiter(k)" loop; with the new compiler this is the fastest (though only a few %)
and it is neater too.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_16, Agnes, 20th May 2009xxxxxx

MaceHead correction for 2007 added.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_15, Dave,  20th May 2009xxxxxx

Functions_ml : troe removed, and moved (as troeInlog) to:

New module: ChemFunctions_ml - with troe, RiemerN2O5, kaero functions

Added modules: My_ChemSpecs_ml My_ChemRates_ml

  - split from old My_Chem_ml, to make use of GenChem easier
  - RiemerN2O5, kaero now done in ChemFunctions
  - tabulation of rate constants switched off for now.
    ( Surprisingly, ** No CPU cost **. Time for chemistry almost
      identical )

Removed modules: My_Chem_ml,  OrganicAerosol_ml

    (the latter not needed, as we have SOA_ml)

Setup_1d_ml, Setup_1dfields_ml
   - removed Rimer stuff, some re-organisation because of My_Chem changes

Solver_ml - has EXTRA_ITER to allow
            ONLY_NIGHT code removed

Unimod.f90 - no need for Init_mychem



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_14, Dave,  16th May 2009xxxxxx

Changes to make switch to global model easier, plus some tidy-ups

IS_GLOBAL added to ModelConstants_ml

Emissions_ml : sets MonthlyEmis x IS_GLOBAL
  (keeps all Global - EMEP changes in ModelConstants)
   Tidy-up

run.pl: My $GLOBAL added as switch
   sitesLL.dat, sondesLL.dat added as defaults in $DataDir - suggest
    only use long/lat files in future.

My_Outputs_ml
   removed D2_AFST... etc., and dependency on Derived

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_13, Dave,  15th May 2009xxxxxx

Working changes::: AOT outputs have been commented out. Will re-appear
soon!

LandDefs_ml
New functions for Check_LandCoverPresent added.

My_Derived_ml
  AFST now dealt with using "OutXX" system, as for VG, RG

My_Derived_ml
  AFST now dealt with using "OutXX" system, as for VG, RG
  Gets rid of iam_wheat, D2_AFST... etc. type indices
  check_vals now not needed.:wq

Derived_ml
  -- more changes to cope with AFST and Out variables

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_12b, Peter  14th May 2009xxxxxx

ReadField, Landuse, Met_ml:
Use landuse to define nwp_sea when rough file is missing


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_12, Peter  14th May 2009xxxxxx



ReadField_ml:
Optional parameter when the field is not needed

Met_ml:
rough is set to 0 if not needed
snow is not required when read from metdata

Sites:
sites.dat and sondes.dat are not required.
(the code was hanging when this happened)

Rsurface_ml: if ice is missing, but sdepth is present, take sdepth instead of snow.(IS THIS OK?)
    if ( .not. foundsdepth)then
       fsnowxG%snow !snow from climatology files, 1 or 0
    endif

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_11, Dave,  14th May 2009xxxxxx

Changes to allow for possibility of new landuse codes, or of
old landuse codes (e.g. "CF" not being recognied with new
systems)

Unimod.f90 - Init_Derived now moved after Init_landuse, so that
  the My_derived code knows about the available Land_codes

My_Derived_ml - check added for MET_LCS to see if the LC actually
  exists. If not, nOutMET will be zero. Note that for other
  outputs the code will crash if a non-existant land-code is given.
  The user can keep it working by only havinbg "Grid" in the arrays,
  e.g. for RG_LCS x (/ "Grid" /)

  Also, some slight tidy-up to reduce clutter

SmallUtils:  find_index again returns NOT_FOUND (-999) instead of 1
    also, trim() added to txt strings

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_10, Peter  13th May 2009xxxxxx

First version of a grid flexible Landuse input

GridValues and Met_ml: defined gb_stagg and gl_stagg (staggered lon and lat)

NetCDF:
 Read_Local_Inter_CDF, to read and interpoalte landuse from raw data.
Under construction!

Landuse_ml: call to Read_Local_Inter_CDF when Input.Landuse is not found

Replaced all NLANDUSE with NLANDUSEMAX: used for array declaration and is the max allowed,
NLanduse_DEF is the actual number of landuse defined.
DO3SE_ml,DryDep,LandDef,StoFlux_ml,NetCDF,LocalVariables_ml

LandDefs_ml: NLanduse_DEF number of landuse defined
NLANDUSE_EMEPx19. To check data from Input.Landuse.
StoFlux_ml: use NLanduse_DEF instead of NLANDUSE.
DryDep_ml: InitDO3SE called only if not already read by Read_Local_Inter_CDF

ModelConstants:NLANDUSE    x 23 ! MAXIMUM Number of land use types

SmallUtils_ml: NB: provisory!!
!    Index x  NOT_FOUND
    Index x  1

run.pl: link to landuseGLC2000_INT1.nc

NB: The new landuses system is still under developement.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_9, Dave  8th May 2009xxxxxx

Derived_ml, My_Derived_ml:

SURF_UG_C, SURF_UG and SURF_PPB added

Also write_debug routine added in Derived_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_8, Dave  8th May 2009xxxxxx

Derived_ml, My_Derived_ml

Start of move to simpler system, where wanted surface concentrations
can be specified with their index, e.g to get ug(N)/m3 NO2
use SURF_UG_N x (/ ...., NO2, .... /)
 - removes need for character "D2_NO2" and index D2_NO2 and allows
Derived to be specified with simple loop over SURF_UG_N. Similar
system in place for SURF_UG_S, and will later implement SURF_PPB


Derived, My_DryDep
AOT30 outputs removed. (Whole AOT system should also be replaced. Usage
of e.g. D2_AOT30 in My_DryDep caused hard-to-find bug in d_2d when AOT30 removed
from Derived system)

My_Chem_ml   - use PPM25 instead of PM25 for primary  PM25. Ditto for PMco
My_WetDep_ml -  ditto
Sites_ml     -  ditto

My_DryDep_ml
   AOT30 stuff removed. (Hard-coded D2_AOT30 variables caused hard-to-find
    problem in d_2d index. Hard-coding of numbers proved bad once again....)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_7, Dave  5th May 2009xxxxxx

** Bugs found and fixed **
-  bugs were in old  My_WetDep_ml code, but luckily not for
anything we have reported. wepdeppm25 and wdeppmco were wrong.
WDEP_NH3 and WDEP_aNH4 were mixed up, but WDEP_RDN was okay.


Aqueous_ml - loop over SO4LIKE once wet dep loss rate for SO4
  calculated.
  uses wdeploss frm MassBudget instead of old sumloss
  now sets wdeploss using indices, e.g. wdeploss(SO2)

Io_ml - added IO_DEBUG to allow printout to separate file (just fort.26 for now)

My_WetDep_ml:
  use array SO4LIKE to contain other fine particles
  now sets wdeploss using indices, e.g. wdeploss(SO2)
  (slower I guess, but clearer and safer!)

Runchem_ml:
  modified to use new WetDeposition, SOA_ml
  - pretty messy with DEVUG statements. Will tidy up another day

SOA_ml:
  debug_flag added

(These changes are a step towards SOA, where many species will need
to be handled by the dep routines, but all as SO4-like.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_6, Dave  4th May 2009xxxxxx
Emissions_ml
Replacement of if(mexx0) with  if(MasterProc)

Replaced the calls to MPI_ABORT with CheckStop calls. I hope these do the
same thing, and they help to keep the code shorter. Look for "!dsx" bits
to check this. (We can delete these lines once we are sure all is okay).

ModelConstants_ml
-- added extra DEBUG constants

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_5, Peter 4th May 2009xxxxxx
NetCDF_ml:
Bug: Removed a test which stops the code.

run.pl:
defined($country_nums{$cc}) and ALL x> 0 for selecting all countries



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_4, Peter 22nd April 2009xxxxxx

Flexible BIC:
If the "Boundary_and_Initial_Conditions.nc" file is not found, it will interpolate the data from
"GLOBAL_Boundary_and_Initial_Conditions.nc".
"GLOBAL_Boundary_and_Initial_Conditions.nc" should be written with global run results (not yet done).

NetCDF_ml:
 GetCDF is now very general, it does not assume anything about the dimensions. You can use this to read any Netcdf file.
new routine "Read_Inter_CDF". It reads data from a lon lat grid and interpolates to the model grid. (not in parallel, should be called by mex0 only)

run.pl: link to "GLOBAL_Boundary_and_Initial_Conditions.nc"


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_3, Peter 3rd April 2009xxxxxx

Updates for the Global model

Solver.f90
nchemx15 for gridwidth larger than 60km.
Still this value should be tested.

Met_ml:
Improved default value for sdot.

Emissions_ml:
Introduced a "MONTHLY_GRIDEMIS" parameter for easier use in global runs.

My_Chem_ml:
species%sulphurx0 for ISONO3,ISNI and ISNIR (bug)

Landuse_ml:
NLUMAX x 19

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_2, Dave 27th Mar 2009xxxxxx

Some small tidy-ups, and extensions:

Country_ml:  IC_INTSHIPS x 350 added for TNO emissions

EmisDef_ml: extended to deal with TNO EC/OC emissions

EmisGet_ml: extended to allow for more emission entries

Emissions_ml: tidy up of DEBUG stuff.

ModelConstants_ml: more DEBUG added

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_1 20th Mar 2009xxxxxx

Various DEBUG variables changed, See new logicals in ModelConstants_ml

Sites_ml  - ascii output set to 10 columns rather than 8 (easier to
count!). Also, outputs excluded when site is on domain boundary


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2 Hilde/Dave  19th Mar 2009xxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
MAJOR CHANGES SINCE RV3_1

Done - rv3_2 now has new co-dep routine, new aerosol deposition, and
 more land-cover output possibilities in Derived. See various beta
 changes below...., this has been a long process!

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta18 Dave, 16th Mar 2009xxxxxx
(Skipped 16,17 ...)

Major change in aerosol deposition calculations, designed to simplify.
Aero_Vds_ml replaces Aero_Rb_ml, and will serve as a collection point
of alternative algorithms. For this version use a simple formula ('GPF'x
generalised Petroff fit) for forests
derived from Petroff et al's papers, as function of ustar, SAI and invL.
Use Nemitz(2004) for all else. SubMet also changed to reflect findings of
various ustar tests against CarboEurope data and offline testing.

Also note new way of specifying DEBUG in ModelConstants - applied
to just a few routines so far. (Intended to make if faster to
switch debuggung on and off, and to save those occasions where
MY_DEBUG in SubMet_ml didn't help as the poor user had forgotten
that this one needed DEBUG in RUnChem_ml switched on too. (Otherwise
debug_flag was never set true)

Derived system modified again, to allow landuse-specif met
params to be output, just invL and ustar so far. Still should
be improved and made more efficient - a work in progress.

Module changes:

CellMet

  Grid%is_allNWPsea added -  used to identify all-sea squares

  Following Branko's comments, we limit u* to a physically plausible value,
  0.1 m/s to prevent numerical problems in stable BLs

CoDep_ml - just write "First CoDep" for MasterProc

Derived_ml - makes use of  DEBUG_DERIVED, and OutMET added. Also
            USTAR_NWP.

DryDep_ml
 Large changes!
 replace Aero_Rb with Aero_Vds, and use new formula for forests,
 Wesely for all else. Settling velocity calc moved in Aero_vds_ml
 also.  Limit settling velocity (Vs) to 2 cm/s

LocalVariables_ml.f90
  logical :: is_allNWPsea   !  Only sea in grid-square

ModelConstants_ml
  new DEBUG_RUNCHEM etc.

Rsurface_ml -  max 10 s/m for HNO3 re-introduced

Runchem_ml - uses DEBUG_RUNCHEM

SubMet_ml
   Many changes - Increased iterations for neutral, unstable,
   just one for stable.

   We restrict z0 to max 0.5m, since comparison with CarboEurope
   results shows that this provides the best u* values for forests.

    ! We use the same restriction on z0 as in Berge, 1990 (Tellus,42B,389-407)
        Sub(iL)%z0 x max( Sub(iL)%z0 ,1.5e-5)

    Uses DEBUG_SUBMET

Rsurface_ml
 - reimplement Vg limitation for HNO3. 10 cm/s max is enough anyway!

run.pl
  New input files, shorter veg in general
 $ifile{"$DataDir/Inputs_LandDefs.csv_05.12.2008"} x "Inputs_LandDefs.csv";
 $ifile{"$DataDir/Inputs_LandDefs.csv_25.02.2009"} x "Inputs_LandDefs.csv";

ZD_OZONE/My_Derived
  changes for new met outputs
  tidy up for OutVg, OutRG

ZD_OZONE/My_DryDep
    Uses DEBUG_MY_DRYDEP
    OutMET added


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta15 Hilde, 25th Feb 2009xxxxxx
New run.pl with:
   Inputs_DO3SE.csv_25.02.2009 (Surface resistance for RgsS for ice set to 1000). No effect on results
   Inputs_LandDefs.csv_25.02.2009  - reduced height for forests and med. Scrub. Will change results

   SubMet_ml:
      revised ustar, invL, with more iterations for unstable
      z0 limit changed slightly, to match Berge 1990 value
      CellMet-ml -in troduced 0.1 m/s limit on ustar for Grid%ustar

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta14 Dave/Svetlana, 11th Feb 2009xxxxxx

SubMet_ml - bug corrected on z0 for sea-areas (big effect?!)
    new (still experimental) limit on forest z0 x 0.5m

PhysicalConstants_ml - Charnock set to 0.0144 instead of 0.036


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta13 Peter,   4th Feb 2009xxxxxx


Met_ml:
New method of deriving sigma_dot when it is missing.
Hopefully this can be a usable alternative, which will avoid most of the prostprosessing
problems of the metdata (mass filtering etc).

Will not changes results in case sigma_dot is found.

Small change in Output_hourly (only debug printing).
            if ( hr_out(ih)%type(1:3) xx "ADV" ) then



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta12 Dave,   3rd Feb 2009xxxxxx

MasterProc introduced in:
  ModelConstants
  Par_ml
  LandDefs
  Io_Progs_ml

 Use "if (MasterProc)" instead of "if (me xx 0)", which needs use ModelConstants
instead of use Par_ml. Easier for box-model type codes.

Also:

LandDefs_ml made F-complaint
PhysicalConstants_ml: R removed, only use RGAS_KG
  Met_ml: R replaced by RGAS_KG.
(I think single letter parameters are too hard to search for.)

SubMet_ml   made F-complaint

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta11 Hilde,   29nd Jan 2009xxxxxx
Bug in Output_hourly.f90:
Units wrong for case ( "ADVugm3" ).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta10 Peter,   22nd Jan 2009xxxxxx

Bug in Met_ml introduced 20th Nov 2008: when a metfield was not found the routine GetCDF_short
returns without closing the file.
If the number of open files exceeds 4096, the program will stop.
No differences if you haven't noticed.

Bug in Log.changes: Jan 2008 was Jan 2009 :-)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta9 Hilde,   20th Jan 2009xxxxxx

DAY_NIGHTx0.6 in Timefactors_ml for sector 10. This means that the agricultural emissions will be 1.4/0.6 times larger in day time than in night.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta8 Dave,   12th Jan 2009xxxxxx

fixed bug in CoDep, which I thought had been fixed in beta7 :-(

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta7 Dave,   12th Jan 2009xxxxxx

CoDep has a small bug-fix (for IRHx0, F4) and more debug options
 + includes Hilde's bug-fix for MAX_SN

Derived_ml + My_Derived_ml
  now has OutRG as merge of OutR and OutG terms

DryDep + My_DryDep

landuse-specific, *and* grid-average, deposition (Vg),  resistance (R)
and conductance (G) variables now stored in "Mosaic_xx" arrays in
DryDep. Using landcover indexx0 gives grid average

Deleted old arrays, Grid_Vg_ref, Vg_ref_iL etc.

DRYDEP_CALC  renamed to DRYDEP_GASES
NDRYDEP_CALC renamed to NDRYDEP_GASES
NDRYDEP_TOT  renamed to NDRYDEP_CALC - ie back to original intention

Area(:) renamed to EcoArea



OutR, outG merged into outRG
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta6 Hilde,  17th Dec 2008xxxxxx

Derived_ml: small change (only effect is that less 'warnings' written out, there was a problem with undef values)
CoDep_ml:a_SN_24hrxso2/nh3,a_SNxso2/nh3, both capped at so2/nh3x3.0, Switch off debug flag
Rsurface_ml: fsnow x2.0 *G%sdepth/Sdmax (before G%sdepth/Sdmax)

Changing a_SN_24hr from 0.6*so2/nh3 to so2/nh3 has only minor effect on so2/nh3 in 2006
(average increase from 0.8 to 0.81, 1% to 3% higher than obs)

Changing fsnow from G%sdepth/Sdmax to 2.0*G%sdepth/Sdmax
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta5 Hilde,   8th Dec 2008xxxxxx
CoDep_ml: cap on minimum value on nh3conc (to avoid numerical problems
when nh3 conc is zero - like it is in the beginning)

Derived_ml: Outputted so2nh3_ratio capped at 3 to avoid unrealistic values in the average.
Anyway so2nh3ratio_24hr is effectively capped at 3 in the Rns calculation, so this will show
how it is used.

DryDep_ml: changed dimensions
My_DryDep_ml: small change in output for Rns since it is not defined for all landuses always

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta4 Hilde,   8th Dec 2008xxxxxx
PhyChem_ml: call to make so2nh3_24hr! Was forgotten committed, so so2nh3 was
effectively set to 0 everywhere after new CoDep routine added...

run.pl: New links Inputs_LandDefs.csv_05.12.2008 and Inputs_DO3SE.csv_05.12.2008
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta3 Hilde,   5th Dec 2008xxxxxx
added Snow and so2nh3_24hr to old output system and committed Derived and My_Derived again.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta2 Hilde,   5th Dec 2008xxxxxx
Output system for  Rs, Rns and Gns added for ecosystems
Snow and so2nh3_24hr added to old output system.
Changes in

  My_Derived_ml
  My_DryDep_ml
  Derived_ml
  Rsurface_ml
  DryDep_ml
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta Hilde,   4th Dec 2008xxxxxx
Change version number to reflect that this model version has new
deposition scheme compared to rv3_1 series...
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_10  Hilde,   4th Dec 2008xxxxxx
Met_ml: read snow,ice, foundsdepth, foundice
CellMet_ml : use sdepth,ice snow from Met_ml
Chem_ml: defined  so2nh3_24hr and Grid_snow
DryDep_ml : define Grid%so2nh3ratio24hr, remove Rsur_dry/wet + change call
CoDep_ml.f90: new method for Rns_SO2. Changes also for Rns_NH3. (Was also bug in Rlow here,
it was added both here and in Rsurface_ml)
Rsurface_ml.f90: Re-written so that Rdry and Rwet no longer needed (due to new method for Rns_SO2).
Added new method for snow, for SO2 and O3 (affecting all).

GlobalBCs_ml.f90: added reference to Hicks et al 2002


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_9  Dave,   3rd Dec 2008xxxxxx

New system started for Derived components, working for DDEP and
VG outputs. Gets rid of need for hard-coded indices such as DDEP_SOX,
etc., and makes it faster to specify landuse and species options.
(
Changes in:

  My_Derived_ml
  My_DryDep_ml
  My_WetDep_ml   ! Still uses old-scheme, but now has SO2, SO4 etc.
  Derived_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_8  Dave,   3rd Dec 2008xxxxxx

CoDep_ml - bug found! This will change results for depositions of
   all components!
ModelConstants_ml - 2 extra DEBUG  sites added
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_7  Hilde,  2nd Dec 2008xxxxxx
LocalVariables: Added is_veg,is_ice, sdepth, ice so2nh3ratio24hr
SubMet_ml: is_veg and is_ice set

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_6  Hilde,  2nd Dec 2008xxxxxx
Set New meteorology directories (Parlam-PS with snowdepths and ice fraction) in run.pl.
Bug in LandDefs (is_veg) fixed.Mostly affects dry dep velocities of coarse particles over urban areas.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_5  Dave,  1st Dec 2008xxxxxx

NetCDF_ml, small change to allow longer variable names, e.g.
DDEP_aNO3_m2Conif:

   !dsDec08 character*18 :: varname
   character(lenxlen(def1%name)) :: varname

and some extra use of MYDEBUG
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_4  Peter,  20th Nov 2008xxxxxx

Only minor changes:

Met_ml: "validity" returned from Getmeteofield gets the value "field_not_found" if the field is not found.
This can be used to set foundSSTx.false. for example, or to stop cleanly.

Solver: removed dt_tot, which was not used anyway.(requested by Martin Schultz)

Functions_ml.f90:  in Exner_nd replaced "ix1 x x1" with "ix1 x floor(x1)"
It is somewhat clearer, and works also for negative pressure :-)

run.pl: "#PBS -lpmemx2000MB" , gives higher queue priority on stallo.

My_DryDep: Switched off debug flag

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_3  Dave,  8th Nov 2008xxxxxx

Ecosystem dry deps changed, to be per m2 of ecosystem

** Note - this changes the values, since before they were per m2 of Grid,
          not of ecosystem!  No need now to scale anything with landuse
          data.

*Note change of output names:
   DDEP_SOX   is now  DDEP_SOX_m2Grid
   DDEP_OXSCF is now  DDEP_SOX_m2CF
 etc.

My_DryDep - use of AreaCF, AreaDF, etc., plus new names
My_Derived_ml  - Use of new names
Derived_ml     - Use of new names

DryDep_ml  - added arguments to call to Add_ddep
Cellmet_ml - set %coverage, LAI etc to zero before assigning .. safety measure
to allow use of full array from 1..NLANDUSE.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_2  Svetlana,  8th Oct 2008xxxxxx

My_outputs_ml, Sites_ml changed to allow outputs of d_2d variables.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_1 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

First bug fixes:
  sign of Hd test and GRAV changed for wstar calculation - bug spotted
  by Massimo


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


 As used for 2008 EMEP Reports

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_0_7 10th june, Dave xxxxxxxxxxxxxx

Removed dead-code (MACHO refs!) from Tabulations_ml
ONLY commented-out lines removed.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_0_6 4th june, Hilde xxxxxxxxxxxxxx
Country_ml.f90 updated with the new country codes from Agnes (EECCA countries)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3.0.5, Peter,  Apr 15th 2008  xxxxxxxxxxxxxx

Output_hourly: put the vertical coordinate for hourly output right.
           If 20 level are requested the lowest level has kx20 (as usual)
           If less than 20 levels are requested the lowest level has kx1
           Also corrected ist etc. to be compatible with the nesting changes
           made in rv3.0.4

Makefile is now Makefile_stallo

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3.0.4, Peter,  Apr 4th 2008  xxxxxxxxxxxxxx

Hourly cdf output: put timestamp at end of period
Nesting: istart etc coordinates relative to large domain instead of small domain.
LandDefs_ml: dimension of Header put to 15
Advection_ml: improved the ADVEC_TYPEx2 option (not the default value) for exact mass conservation
Sites_ml: allow sites/sondes on model boundaries (needed for poles in global runs)
Timing_ml: use MPI_WTIME to measure walltime

None of these changes should affect the results of "standard" runs.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3.0.3, Dave,  Mar 18th 2008  xxxxxxxxxxxxxx

GlobalBCs_ml
added 2006 O3 backgroud, using data from Derwent et al. (2007) paper

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3.0.2, Peter,  Mar 3rd 2008  xxxxxxxxxxxxxx

Just additional comments in the code.
In ZD_OZONE/MyDerived_ml !NB: do not remove without removing from My_DryDep too
In ModelConstants_ml PT x 1.0e+4    ! Top of model region x 10000 Pa x 100 hPa


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3.0.1, Dave,  Mar 1st 2008  xxxxxxxxxxxxxx

Io_Progs_ml  -  bug fix to remove text trailing # in HEADER line  (doesn't
     matter to results though)

Landuse_ml - small formatting change

NetCDF_ml and Nest_ml reset to rv3beta13 status


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3      2008  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st OPEN SOURCE CODE ON WEB!!!

End of rv3 series. Almost identical to rv3 as given on web, but

(Had to reset Nest_ml and NetCDF_ml to slightly older code. Will
update again as 3.1.

** modrun.pl is still different in rv3 and on web-version. Too many
differences to bother about here.)

xxxxxxxxxxxxxx rv3beta13  feb 6  2008  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter
Small bug: current_date declared twice in NetCDF_ml (does not influence
output, but pgi compiler complains).

xxxxxxxxxxxxxx rv3beta12  feb 2  2008  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter
New update of adv_var: the previous version seemed to hang on stallo in some situations (global model)

xxxxxxxxxxxxxx rv3beta11  Jan 31  2008  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

copied the new Inputs_LandDefs.csv into DataDir and corrected a bug
introduced in run.pl from rv3beta9 when runnning on snykov.

run.pl, modrun.pl - modified to use renamed Inputs_LandDefs.csv


xxxxxxxxxxxxxx rv3beta10  Jan 31  2008  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave

DO3SE system simplified to remove various special features. Effect of
old needles removed, and replaced by simply setting lower fphen in
Inputs_DO3SE.csv.

Treatment of Astart, Aend now automatic also - special code removed

Inputs.LandDefs now renamed Inputs_LandDefs.csv, and values changed

Inputs_DO3SE.csv values changed
   - both to reflect revisions to mapping manual, and  recent work

Wesely_ml - tidied up some comments about NH3


SHOULD USE NEW INPUT FILES ALSO!

xxxxxxxxxxxxxx rv3beta9  Jan 16-17  2008  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Stallo version of run.pl and Makefile_stallo.
Just set STALLOx1. Choose USER, ProgDir,WorkDir, Emissions etc. as usual.
32 procs choosen in ModelConstants_ml.

Put an  MPI_BARRIER in Io_Progs_ml: OpenMPI becomes crazy (huge memory
leak->node crashes) because each line was is in separate buffers to all nodes,
 before they were received.


xxxxxxxxxxxxxx rv3beta8  Jan 8-9..11  2008  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter, Svetlana

End of run dates for "fullrun" in NetCDF_ml.
Removed "initnetcdf" routine from Unimod and NetCDF_ml (was never used).

Defined veg_month in DryDep. Seemed not to be defined before? Does it work now??
Initialized veg_monthx1 in DO3SE_ml

Changed definition of LandType in LandDefs_ml:
            LandType(n)%is_water  x  LandInput%code xx "W"
            LandType(n)%is_ice    x  LandInput%code xx "ICE"
            LandType(n)%is_iam    x  LandInput%code(1:4) xx "IAM_"

            LandType(n)%is_forest x  &
                ( LandInput%type xx "ECF" .or. LandInput%type xx "EDF" )
            LandType(n)%is_conif x ( LandInput%type xx "ECF"  )
            LandType(n)%is_decid x ( LandInput%type xx "EDF"  )
            LandType(n)%is_crop  x ( LandInput%type xx "ECR"  )
            LandType(n)%is_seminat  x ( LandInput%type xx "SNL"  )
            LandType(n)%is_bulk   x  LandInput%type xx "BLK"
            LandType(n)%is_veg    x  LandInput%type /x "U" .and. &
                  LandInput%hveg_max > 0.01   ! Excludes water, ice, desert

NB:Water defined with type "BLK" in  /home/mifapw/emep_common/Data/Inputs.LandDefs
BUT NOT IN ~mifads/Unify/Data/EMEP/Inputs.LandDefs
Copied also the other input files from ~mifads/Unify/Data/EMEP/ over to /home/mifapw/emep_common/Data and
/home/mifapw/emep_common/Data/EMEP
Changed run.pl to take into account these changes

Uncommented a system call in Nest_ml: can cause problems in combination with OpenMPI (problems appeared on Stallo).

xxxxxxxxxxxxxx rv3beta7  Nov 16  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave

 GPL added to TimeDate_ml

xxxxxxxxxxxxxx rv3beta6  Nov 12  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave

My_FastReactions.inc added, and included in My_Reactions.inc
-- saves having identical code 3 times in My_Reactions


xxxxxxxxxxxxxx rv3beta5  Nov 7-8  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter
Met_ml: non-blocking MPI_ISEND for wind speeds in metvar.
        Uses dedicated arrays for receive buffers.
    Was giving worng results with -O3 option (!?)

SubMet_ml: Sub(iL)%rh x min(1.0,Sub(iL)%rh)! keeps rh <x 1
       instead of e x min(esat,e)
           Is mathematically identical, but gave slightly different results with -O3 option.

Dave
CellMet_ml: wetarea change to avoid numerical problems.
  !   .... we allow a small build-up phase, with
  !   linear increase from wetareax0 to wetarea x cc3dmax for values of
  !   prec between 1.0e-8 (near-zero!) to 0.01.

Svetlana:
  Added foundSST x true for cdf met reads

xxxxxxxxxxxxxx rv3beta4  Nov 5-6  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Hilde, Svetlana
Files cleaned for unnecessary output. Changed files are:

Unimod.f90
Emissions_ml.f90
Landuse_ml.f90
Met_ml.f90 (also with Svetlanas reading of SST)
Derived_ml.f90
Timefactors_ml.f90
EmisGet_ml.f90
My_BoundConditions_ml.f90
BoundaryConditions_ml.f90
GlobalBCs_ml.f90
Runchem_ml.f90
Advection_ml.f90
PhyChem_ml.f90
Biogenics_ml.f90
Volcanos_ml.f90
Io_Progs_ml.f90
NetCDF_ml.f90
AirEmis_ml.f90
EQSAM_ml.f90
DryDep_ml.f90
OutputChem_ml.f90



Makefile and Makefile_snow:
replaced the -O3 compiler option with:
-O2 -mieee-fp -ftz

xxxxxxxxxxxxxx rv3beta3, Oct 26  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave, Svetlana

GPL added

modrun.pl added - simpler (snykov only) version of run.pl for distribution
  with Web model

Bug-fix: 2nd open of IO_TMP removed in  LandDefs_ml

SeaSalt_ml :  default Tw changed to T2 (not 283) for cases where no SST
               (involves bug-fix for SSfi with netcdf).
Met_ml:       foundSST added  to say if SST available. (** not ** available in
                netcdf files!)

xxxxxxxxxxxxxx DELETED TAG: rv3, Oct 24  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Just one commented-out line removed from SeaSalt_ml

xxxxxxxxxxxxxx rv3beta2, Oct 1  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SeaSalt_ml added from Svetlana

Sites_ml - slight format changes

Unimod.f90 - cleaning, Dave

run.pl netCDF option added

xxxxxxxxxxxxxx Dave, rv_Beta30 30 Sep  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx


New modules:
xxxxxxxxxxxx
CellMet_ml - sets met params for lower grid cell, call SubMet
CoDep_ml   - for SO2/NH3
DO3SE_ml   - reads in and set sto. conductance stuff
LandDefs_ml -
LocalVariables_ml   - grid met in Grid%, sub-met in Sub(iL)%
Rb_ml  - for Rb...
StoFlux_ml


Some changes:
Deleted               Replacement
xxxxxxxxx             xxxxxxxxxxxxxxx
DepVariables_ml       LocalVariables_ml
UKsetup_ml            LandDefs_ml.f90
JUN06_gfac1.dat       Inputs_DO3SE.csv
JUN06_gfac2.dat          "      "
JUN06_biomass.dat     Inputs.LandDefs


Changes due to new system:
xxxxxxxxxxxxxxxxxxxxxxxxxxx
Aero_Rb_ml uses LandType
DefPhotolysis_ml - uses Grid%izen
DryDep - *** major re-write ***
Functions_ml - MicroMet stuff removed
Landuse_ml - *** major rewrite ***
Makefile.SRCS - new files, some deletions
Met_ml - invL calc moved to CellMet
Radiation_ml (albedo removed from PAR calc.)
Rsurface_ml
Runchem_ml
SubMet_ml - *** major rewrite ***
My_DryDep_ml

SeaSalt - JUST A FAKE FOR NOW!

Cleanups:
xxxxxxxxxx
Chem_ml
Derived_ml
Emissions_ml
GridValues_ml
Io_Nums_ml
OrganicAerosol_ml
PAR_ml
PhyChe
Setup_1d_ml
Setup_1dfields_ml
Unimod.f90   (now outputs Base_fullrun.nc, not Base_year.nc)
My_Chem_ml
My_Reactions_ml
My_Derived_ml
My_Emis_ml
My_WetDep

Minor (due to renamed modules)
xxxxxxxxxxxxxxxxxxxxxxxxx
MassBudget_ml
ModelConstants_ml
Solver_ml


xxxxxxxxxxxxxx rv2_9_16, Sept.  28th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave:
Bug-fix for old_gsun in DryDep_ml

Svetlana:
Cleanup of Runchem_ml, My_Aerosol

yxxxxxxxxxxxxx Dave, rv2_9_15, Sept.  27th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

d_2d initialised to zero in PhyChem for all components
(check by Svetlana)

Bug-fix in SubMet_ml, as test for water was wrong

DryDep - modified for above + clean up (in case this is the last version).


xxxxxxxxxxxxxx rv2_9_14, (also 13?) Sept.  27th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave
Sites_ml.   2nd Bug-fix for sondes --- for now excluding values from domain boundary.
   Was giving e+254 type values .....


Hilde+Heiko
run.pl corrected so that SR runs works
TimeDate_ml.f90,GlobalBCs_ml.f90,BoundaryConditions_ml.f90 cleaned

xxxxxxxxxxxxxx Dave, rv2_9_12, Sept.  26th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


MicroMet properly added (cvs add)

Sites_ml.   Bug-fix for sondes

xxxxxxxxxxxxxx rv2_9_11, Sept.  25th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave:
MicroMet_ml introduced - has MM functions from Functions_ml
DryDep  - now use MicroMet_ml

chmod a-x *.f90 etc. applied..

NLANDUSE now only from ModelConstants_ml, (old NNLANDUSE dropped)
DepVariables now "uses" ModelConstants_ml

gc_com_for_1proc deleted

Semeena:
DOC updates

xxxxxxxxxxxxxx rv2_9_10, Sept.  25th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Hilde:
PhyChem:
Precipitation initialized(bug corrected)


Updates related to N2O5 hydrolysis:

N2O5_hydrolysis_ml : added
Setup_1dfields_ml.f90: f_Riemer moved to N2O5_hydrolysis_ml
Setup_1d_ml.f90:  f_Riemer  from N2O5_hydrolysis_ml
Solver.f90: f_Riemer,VOLFAC from N2O5_hydrolysis_ml
ModelConstants_ml.f90: VOLFAC moved to N2O5_hydrolysis_ml
My_Chem_ml: bug in rcmisc(8,k). This bug makes the new reaction rate (for the N2O5 hydrolysis) 4-8 times smaller

Svetlana:
Out_restri_ml removed, also in Unimod, Makefile.SRCS., My_Outputs_ml, OutChem_ml.f90
Some cleanups in those modules.
EmisGet_ml - cleanup

Dave:
Cleanup in My_Chem_ml, PhyChem


xxxxxxxxxxxxxx Semeena, Heiko, rv2_9_9, Sept.  23rd 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Updates to documentation

New run.pl with SR stuff placed near end of file.
  (SR functionality not yet tested though!)


xxxxxxxxxxxxxx Peter, Svetlana, rv2_9_8, Sept.  21th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

run.pl $linex~ s/!.*//;
    for cases where NPROCX has been uncommented

Solver_ml - cleanup

xxxxxxxxxxxxxx Dave, Michael,  rv2_9_7, Sept.  20th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Io_Progs - extra options added to check that required key-value pairs exist.

run.pl   -  Michael's user corrected, and location of sites/sondes redefined.

Sites_ml.f90   --- now expects sites.dat and sondes.dat to have formatted headers.
                   + cleanup

SmallUtils - small update (trim used)

xxxxxxxxxxxxxx Peter, rv2_9_6, Sept.  19th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Setup_1d_ml: checkstop when a NaN is detected
             removed: use MyChem_ml,  only :  Set_2dBgnd

Met_ml: CheckStop(nhour/x0 .and. nhour /x3..) for netcdf metinput

EmisGet : removed stop when country "N/A" is detected

run.pl: changed the crash message
        included $METformat to switch to necdf for netcdf metdata
    changed -lnodesx16 to be compatible with ModelConstants

xxxxxxxxxxxxxx Dave, rv2_9_5, Sept.  15th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

CheckStop added into find_index - to catch cases where the index isn't
   found (was used to track down D2_indices which were not set in
   My_Derived).

My_Derived changed to force use of the hard-coded D2_ values (e.g. D2_AFSTDF16).
  (Should modify rest of code to be more flexible).

Landuse_ml -- commented out lc_water, lc_ice to remove problems.  Will be
  fixed in forthcoming version.

xxxxxxxxxxxxxx Dave, rv2_9_4, August 30th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Biogenics_ml re-written to simply read in BVOC emission potentials, rather than
   calculate them. Now same procedure for EMEP domain, GLOBAL and HEMIS.

  Associated changes and small tidy-ups in Emissions_ml,  Setup_1d_ml,
     Setup_1dfields_ml, Unimod.f90

Derived_ml --- debugging now uses debug_proc etc. from GridValues. Small bug-fix
    which caused WARNINGS for PR/DEP.

Io_Progs_ml, optional argument CheckValues added to ReadSDN, to let user specify
   key-value pairs that must be included in input file.

Landuse_ml   - slight rename of Inputs.Landuse
My_Emis_ml   - removed MY_MODEL
Met_ml       - small tidy-up
TimeDate_ml  - small tidy-up

run.pl --  $NDATA points to new Inputs directory.
           prog.exe now added into Remove.sh

Inputs: new inputs directory, ~mifads/Data/EMEP (GLOBAL + HEMIS) created while
  new style data being created (with headers and key-values)

cvs DELETED::  UiO_ml  Wrtchem_ml

xxxxxxxxxxxxxx Peter, rv2_9_3, August 28th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Unimod.f90: Removed call to DefGrid (moved into Met_ml)
        Read input parameters using read_line

Met_ml.f90: call to infield(1) and DefGrid in the MeteoGridRead routine,
            for the case where felt files are used.


xxxxxxxxxxxxxx Dave,  rv2_9_2, July 26th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

More variable name changes, for i_glob, j_glob. Full list of recent
changes is:

    ISMBEG x> "IRUNBEG"
   ,JSMBEG x> "JRUNBEG"
   ,IILARDOM x> "IILARGEDOM"
   ,JJLARDOM x> "JJLARGEDOM"
    IILARGEDOM  x> "IIFULLDOM",
   ,JJLARGEDOM  x> "JJFULLDOM"
   ,i_glob  x> "i_fdom"
   ,j_glob  x> "j_fdom"

 The idea is to prevent confusion between global as in for the
World and the computer-concept of global for the full domain.
In future I think global should refer to the World-scale.


DOCS/Manual.tex - changed with suggestion of Part A, Part B
     Outputs.tex - new description of derived outputs
     Input.tex -  small change for input files (DO3SEinputs.csv
            will be introduced soon in place of old MM_biomass, gfac etc.)


xxxxxxxxxxxxxx Dave,  rv2_9_1, July 20th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Major change - rewrite of Derived and My_Derived

      - should now be much easier to add or remove params from list to be
        included -- just give names (e.g. "DDEP_OXN"). No need to count :-)
        Also, now there is just 2d and 3d  stuff, no more ddep_ and wdep_.
        No need of DUMMY either in 3d output.
        Arrays are allocated as needed.


SmallUtils - added AddArray and LenArray to add arrays, and to count number of
    allocated elements (not allocated define with NOT_SET_STRING

Included Svetlana's OutputChem_ml, a wrapper containing Wrtchem.f90 and other
   subroutines

Deleted: Wrtchem.f90 - now in OutputChem_ml

run.pl - check now added that the number of processors in run.pl matches
   the number in ModelConstants_ml.f90

TO-BE-DONE

 Changes need to be transferred to ACID version

xxxxxxxxxxxxxx Dave,  rv2_9, July 19th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Major change:

 Par_ml.pat   -- deleted! -- now set RUNDOMAIN, and NPROC stuff in ModelConstants
 Par_ml.f90   --  now a normal file, not changed between runs

 ModelConstants - now has:

    RUNDOMAIN x (/  36, 167, 12, 122 /)     ! EMEP domain
    NPROCX      x   4       & ! Actual number of processors in longitude
  , NPROCY      x   4       & ! Actual number of processors in latitude
  , NPROC       x NPROCX * NPROCY

    DomainName x "EMEP-50kmEurope"

  i.e. run.pl does *not* set the model domains any longer, only the year, NTERM, etc.
  Note also --   need to set lnodes correcly in run.pl - but now check values from
  ModelConstants_ml. In future may be able to make this automatic, but not so far.


  Some renaming:

      Instead of using the terms global domain and small domain, I am trying to
      move to full domain (170x133 or global if it really is a global model!)
      and "run" domain.

        ISMBEG ->    IRUNBEG
        JSMBEG ->    IRUNBEG
        IILARDOM  -> IIFULLDOM
        JJLARDOM  -> JJFULLDOM


   Some re-arrangements:

    All "use" statements moved to top of some modules
    Started putting "use" statements  in alphabetical order - much
     easier to find now. Except --  Start lists with My_ modules.
    Thus,

       use My_Chem_ml

       use CheckStop_ml
       use ModelConstants_ml


 Emissions_ml   - very small tidfy up

 Io_Progs_ml      Read2D added

 + probably some other small tidy-ups.


xxxxxxxxxxxxxx  rv2_8_1,  July 2nd  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Provisional - needs to be tested still!!!!!!!


Met_ml:  Cleaned(Jan Eiof), also  some extra Met params made available
           (RH2m, Soil water --- but both seem to have problems!)

DOCS/cookbook + other :  Cookbook  1st darft added, Semeena. Now have
     both a cookbook for new users, and a Manual for programmers.
     Do either of:

         latex cookbook
         latex Manual

GridValues_ml: dependence on Io_ml removed (ds)

Io_Progs_ml:   read2DN added (ds) - "fast"  read of New-style input data for
       a file with x, y, z1..z2 type data.


Landuse_ml:  Uses read2DN (ds). Saved 50 lines :-)


xxxxxxxxxxxxxx  rv2_8,  July 2nd  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

As used in year 2007 EMEP report work, for SR etc,.

As rv2_7_10, but:

new run.pl from Heiko - replaces earlier run.pl, SRrun.pl,  etc.

GridValues_ml, Landuse_ml, KeyValue_ml, Volcanos_ml - DEBUG switched off


xxxxxxxxxxxxxx Hilde, Dave, Svetlana, rv2_7_10,  Jun 12-25  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Country_ml  - Serbia and Montenegro added properly

EmisGet_ml  - added safety check on country codes

ReadField_ml  - corrected bug (not initialising integer fields, e.g. snow)

Volcanos_ml  - corrected bug in coordinate systems. Started move to i_local

xxxxxxxxxxxxxx Misc, rv2_7_10,  Jun 7  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


Svetlana :
      found (non-fatal) bug in CheckStop in BoundaryConditions_ml

Dave:
      Rsurface_ml - Swapped Idir, Idiff, removed albedo

Michael:
      Aqueous_ml - cleaned

xxxxxxxxxxxxxx Misc, rv2_7_9,  May 30 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave:

    Major changes xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

      Io_Progs_ml added -  new system for reading input files. Simpler (I hope!)
             syntax, requirement for descriptive headers and lines in input

      Io_Nums_ml added - just integer values
             file. See Manual for description.

      Io_ml now just wrapper for Io_Nums_ml, Io_Progs_ml

      KeyValue_ml - NEW - simple routines for dealing with a fortran equivalent
         of a key-value pair - a crude attempt to redproduce
         some of the nice features of perl's hashes or python's dictionary

      Landuse_ml - recoded to use new inputs format, Read_Headers, read_line
          and simpler syntax

      SmallUtils_ml - NEW -  module for small utilities. find-index stuff and wordcount
           moved here, and WriteArray added.

      UK_ml, now renamed DepLanduse_ml and recoded as above

      DOCS/Manual/Inputs.tex - started description of new input formats
      DOCS/Manual/Domains.tex - added description of coordinate systems,
           which have confused me for years!

  NEW - Usage of Self_Test in some modules - highly encouraged!!

    Small changes xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
      CheckStop_ml - added test for CheckStop( string1, string2, info )

      DepVariables_ml - lc_water, lc_ice added - no effect for now, but
           start of recoding

      DryDep_ml - just renaming, UK_ml to Landuse_ml, etc.
      EmisGet - small changes
      GridAllocate_ml -  small changes

      GridValues_ml  -  some tidy up, and table created for various coordinates
          (prints out li0,li1,limax, etc..... for each me )

          i_local, j_local arrays created (reverse of i_glob, j_glob)

      Makefile.SRCS - updated
      MassBudget_ml - small changes
      Par_ml.pat - CheckStop
      SeaSalt_ml -  just renaming UK_ml
      Setup_1d_ml -  renaming UK_ml + small tidy up
      Sites_ml    -  errmsg added
      Unimod.f90 - smnall changes

+ Landuse.MAY07 created - essentially landuse.JUN06 but with new formatting
+ changed in run.pl

xxxxxxxxxxxxxx Misc, rv2_7_8,  May 21 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Fixed various problems with 2_7_7

Plus, Cleanups and CheckStop from Michael:

     Sites_ml
     Solver_ml
     Output_hourly
     ZD_OZONE/My_Outputs

xxxxxxxxxxxxxx Misc, rv2_7_7,  May 16 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave:  Makefile.SRCS added - list of .f90 files, included from all
        other Makefiles.

      CheckStop_ml : Changed name of confusing is_true to is_error

      Moved GridAllocate from Functions to GridAllocate_ml
      - changes in EmisGet,  UK_ml

      Added Self_Test routine in GridAllocate_ml

      UK_ml - cleaned from CheckStop comments


Hilde: CheckStop added in: BoundaryCOnditions_ml
                           Derived_ml
                           GlobalBCs_ml
                           RunChem_ml


Svetlana: Cleaned up Timefactors_ml


xxxxxxxxxxxxxx Misc, rv2_7_6,  May 11 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave: Added new module CheckStop,  to simplify error-testing and
       calls to MPI_ABORT. Can now do e.g.

              call CheckStop( lu<0,"UKdep lu problem"), or,
              call Check(errmsg,"Something fishy here...") , or, ...

        - there are five possibilities.

       Functions_ml - small cleanup

       ReadField_ml, implicit none added! BUG fixed, CheckStop added,
         + new subroutine to read 3D fields

       Unimod.f90 - check digits(1.0) - that compilation uses double precision

Peter: CheckStop in NetCDF_ml

Svetlana: CheckStop in Emissions_ml
                       Met_ml
                       Volcanoes_ml
                       Par_ml

Jan Eiof: CheckStop in EmisGet_ml
                       DefPhotolysis_ml
                       Biogenics_ml
                       ReadField_ml (+ Dave's changes above)

Semeena: Cleaned:      MassBudget_ml


xxxxxxxxxxxxxx Misc, rv2_7_5, Apr 19 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

April 10th, Dave:

  removed Dates_ml from Makefiles.

  modified ReadField_ml, to allow more than one input line per i,j coord
                         + fewer write statements

April 18th, Peter/Semeena:

    Updated NetCDF_ml such that:
    1) Output is CF-1.0 compilant for the vertical coordinates
    2) Corrected a bug when 3D hourly output is required

    Derived_mland My_Derived: renamed D2_PS as PS, to be more compatible
    with what other use (PS is used in the definition of the vertical levels)

    run.pl: put lpmemx200MB


xxxxxxxxxxxxxx Misc, rv2_7_4, Mar 30 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Cleanups:

Michael: Aero_water.f90

Svetlana: Volcanos_ml.f90


xxxxxxxxxxxxxx Misc, rv2_7_3, Mar 29 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Hilde: Dates_ml replaced by TimeDate_ml (TimeDate corrected for bug). Changes in:

 (calc daynumber) Derived_ml.f90
 (daynumber) DryDep_ml.f90
 (nydays) Emissions_ml.f90
 (daynumber)GlobalBCs_ml.f90
 Met_ml.f90
 (date type) Nest_ml.f90
 NetCDF_ml.f90
 Timefactors_ml.f90
 (daynumber) Unimod.f90
 Wrtchem.f90

Minor changes in:
 Advection_ml.f90
 ModelConstants_ml.f90
 PhyChem_ml.f90
 My_Chem_ml.f90
 My_Outputs_ml.f90
 UK_ml.f90
 Setup_1d_ml.f90


Peter: Output_hourly: reversed/corrected order of k-levels in Output_hourly
       (for Semeena's work)

Semeena:  AirEmis_ml cleaned and documented



xxxxxxxxxxxxxx Misc, rv2_7_2 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Peter: Advection_ml: more robust advection for global model.
       UK_ml: bug in effectivdaynumberxdaynumber (no consequences in practice)

       Met_ml: bug in my gc/MPI changes (rv2_7): gb,gl,gb_glob and gl_glob may be wrong
               on nodes different from mexx0.

       Added comment in Emissions_ml (newmonth):units are ktonnes PER YEAR
       Comment:shouldn't we define emissions as ktonnes per 365 days?
       A leap year has more 1 day more DMS emissions than a 365 days year...

Dave: xRgsO corrected in Rsurface_ml for snow. Will change results slightly.


xxxxxxxxxxxxxx Misc, rv2_7_1  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Peter:
   Nest_ml - Modex12, for read 3D at start of run and write at end
         and corrected bug in lat lon nesting.
   Makefile_snow, Makefile_njord - replaced Polinat_ml with Trajectory_ml

Joffen:
 Country_ml - cleaned, March 6 2007. This version includes the
  division of ship emissions into inside/outside the 12 mz, EU/ROW flags,
  Ferries/cargo ships as this is supposed to be the "strategy" for the
  future.

  EmisDef_ml.f90: Cleaned by Joffen, March 6th 2007.
   With the division of the ship emissions in Country_ml,
   lots of new "countries are defined in the same grid. thus the
   number of countries allowed in one grid has to be increased (to 10)
   in EmisDef_ml.f90

  Emissions_ml.f90: Modified for use of timefac_index from Country_ml

  Trajectory_ml - replaces Polinat_ml (mainly name change)
  PhyChem_ml    - now refers to trajectory_out


Dave:
  ModelConstanstants_ml - removed assign_nmax, assign_tdadvec

  Advection_ml - placed assign_nmax, assign_tdadvec here


Misc:
  Unimod.f90 - changed to accomodate above changes in routines/modules
    (+ close(IO_TMP) added. Bug!)



xxxxxxxxxxxxxx Peter 5/3 rv2_7 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

All gc_ routines removed! They are replaced by the standard MPI routines.
Affect most of the files.
You can find an overview of the MPI routines for example at:
http://www.llnl.gov/computing/tutorials/mpi/

My_Outputs_ml: Hourly_ASCII x .false. (seriously slows down the program if /global/work is used)
UK_ml.f90: define "effectivdaynumber" for treating Growing Season in Southern Hemisphere
Runchem_ml and Solver: removed dt,reset_chem and Niter, which were not used and may create confusion.
Added Par_ml.f90. It allows to compile without script.

Only numerical changes (<1.E-6) on results.


xxxxxxxxxxxxxx Peter, Dave   rv2_6_6  6/2...31..23..25/2/2007 xxxxxxxxxxxxxxxxxxxxxx

Advection_ml: renormalization between horizontal and vertical advections in  advecdiff_poles

Dates_ml: extended to 2006, but only MaceHead to 2005 in global yet.

Functions_ml:
Some minima criteria in Ra removed to prevent problems in extreme stable cases

GlobalBCs_ml - updated to 2005

Nest_ml (and Unimod.f90 ,PhyChem_ml):
Mode 10,11 for warm start option and corrected bug ("idimid") when writing in lat lon

NetCDF_ml:
allocate a real*4 array instead of real*8. Avoids possible underflow errors and saves some memory.


XM_MAX_ADVEC removed from Met_ml and Model_constants (was not used)

Met_ml:
small change in definition of "cyclicgrid"

Rsurface_ml:
Some minima criteria removed to prevent problems in extreme stable cases

run.pl
Simplified, especially for input files.
Included Tareq in run.pl USERS.

Removed srun.pl, nrun.pl, local2global.f, global2local.f, gc_com.f from cvs

xxxxxxxxxxxxxx Peter   rv2_6_5    19/1/2007 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

New common run.pl script for njord and snykov. NB: It also use /global/work on snykov.
Use this one as it will simplify maintenance to have
fewer scripts. Not yet made for SR runs (should also be done with the same script).
Choose  $NJORDx1 or $SNYKOVx1 in the script.


Derived_ml:
Changed units written in outputs for all depositions (ug/m2  was written instead of ugS/m2)

Small changes for the global version: (does not affect other runs)

Advection_ml: 2 old "bugs" corrected.
    preadvx(2): did not work if west neighbour x east neighbour (possible in cyclic grid)
    adv_var: nonblocking sends. Otherwise may hang if extremely large grids are used.

Met_ml:
Defined poles when lat > 88 degrees.
Small changes in the extrapolation of xm outside the grid.

Country_ml:
country 67 -> timezonex-100. For unknown countries

xxxxxxxxxxxxxx Peter   rv2_6_4    13-30/11/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dates_ml - extended LAST_SDYEAR to 2006, Dave

15th Nov put  if(Ascii3D_WANTED)then around the 3d ascii output in Wrtchem.f90
Derived_ml :PS units in hPA

15th Nov Advection_ml "else where" replaced by  "elsewhere" to stop Njords f90 comlpaining

Makefile_njord
Use /home/ntnu/usrlocal/netcdf/netcdf-3.6.1 instead of mifapw's library
Changed -O4 into -O3 -qarchxpwr5 -qtunexpwr5 , because of compiler error during IPA, when compiling the HEMIS grid.


xxxxxxxxxxxxxx Dave   rv2_6_3    3/11/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

On request of Peter, removed *.f files (except gc_fcon_for_1proc.f)

xxxxxxxxxxxxxx Peter  rv2_6_2   27/10/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Version compatible with "njord", IBM p575+ 16-way nodes, AIX , Load Leveler

gc_com,local2global,global2local set to f90

MARS_ml.f90 line 864 1.d0 changed to 1.0
TimeDate_ml: line 53 reduced month length to 10
Derived_ml.f90 : case ( "MAXADV" ) changed forall (program crashes with segmentation fault otherwise??)
Advection_ml: changed hel1/hel2 into hel1/(hel2+1.0E-100)
          because of overflow otherwise (compiler weakness, works without if only -O2 is used)
removed all *.f files (gc_com.f,local2global.f,global2local.f)
new nrun.pl and nSRrun.pl (n for njord)

Makefile_njord created
Makefile_snow updated (.f removed or replaced with .f90)

Put values in the "k" og the Boundary_and_Initial_Conditions.nc


xxxxxxxxxxxxxx Heiko  rv2_6_1  25/10/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

 I just found a problem in the Makefile_snow, it included

 clean:
     rm ... \
     touch ... \
     make depend


 The last one did thus run 'make depend' instead of 'make -f
 Makefile_snow depend'. This is fixed in the cvs'd file.

xxxxxxxxxxxxxx Peter  rv2_6   23/8/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Included Nesting options.
Not enough tested but needed for ENEA delivery: 3D BC 3-hourly all components.
For a nest run: Set MODE and istart,jstart,iend,jend

Nest_ml: completely revised
NetCDF_ml: secondssince1970 public,
           not time at middle of period for instant data (like BC).
PhyChem_ml: moved wrtxn call.
ZD_OZONE/My_Derived: SR x false "consistent"
srun.pl :small changes


xxxxxxxxxxxxxx   rv2_5   11/7/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Also version used for Jul 2006 SR runs for IIASA


xxxxxxxxxxxxxx   Hilde   11/7/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Mace head correction for 2004

xxxxxxxxxxxxxx   Peter rv2_5beta2   1/7/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SRx0 should work too  (SRrun.pl)

Changed My_Reactions so that it is fast on snowstorm (and embla).
The old one has been put into My_Reactions.inc_blizz


xxxxxxxxxxxxxx  Anna, Peter, Hilde rv2_5beta2   30/6/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SRx0 should work too

SRx1 moved higher up in SRrun.pl (was bug: $iyr_trend was never set to 2010)
$iyr_trend x "2020" if $SR  in SRrun.pl


SRrun.pl changed to include PM_ADDED. mkp.pmemis_from_nox changed (and new name), do not include Azerbaijan anymore - we have those PM emissions.
Country_ml.f90: ATX now seax1

noxsplit.special.2000 should not have been there, the default split should be used for all years before 2010. File removed from datadirectory.

xxxxxxxxxxxxxx  Anna, Peter, Dave rv2_5beta2   28-29/6/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SR version

My_Derived:
SOURCE_RECEPTOR x .true.
NDERIV_3D x  0

Global_BC:
macehead for iyr_trend > 2010 set to +4.5 (was set +3+4.5x7.5!)

DEBUG options set to false in rv2_5beta

SRrun.pl created to look after SR runs
ATX defined as part of ATL and RUX as part of RU (in femis)

iyr_trend added to RunLog output


SEASALT set to .false.

xxxxxxxxxxxxxx Dave, rv2_5beta   27/6/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

New flux parameters slightly re-defined. MMAOT30 and MMAOT40 added - AOTs according to
 new Mapping Manual approaches.
 Now:
    D2_AFSTDF0, D2_AFSTDF16, D2_AFSTBF0, D2_AFSTBF16, &
    D2_AFSTCR0, D2_AFSTCR3, D2_AFSTCR6,&
    D2_MMAOT30, D2_MMAOT40

Country_ml - updated from Heiko

Derived_ml - new flux stuff added

DryDep_ml - SumVPD limitations added for IAM_WHEAT

UK_ml - safety checks added on SGS, EGS
        InGrowingSeason array defined to simplify MMAOT calculation


xxxxxxxxxxxxxx Dave, rv2_4_8   25/6/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Ooops.... forgot to copy My files form main directory into ZD_OZONE before cvs commit.
Done now....
xxxxxxxxxxxxxx Dave, rv2_4_7   22/6/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

New flux parameters defined,  see JUN06 changes
    D2_AFSTDF0, D2_AFSTDF16, D2_AFSTBF0, D2_AFSTBF16, &
    D2_AFSTCR0, D2_AFSTWCR, D2_AFSTCR6,&
    D2_AFSTCN0, D2_AFSTCN3, D2_AFSTCN6,&

New landuse setup files - in JUN06_biomass.dat etc.
  - results in different growing seasons and depositions for forests
    (e.g. reduced deposition in summer in Mediterranean)

New landuse map - some small corrections, and 3 IAM categories.

Used 4.5 ppb for iyr_trend >x 2010 - quick fix for JUN06 IAM runs.

$MAKE added in srun.pl, to call Makefile_snow if needed. Check if it
       works for others, and usage of .depend!!!

xxxxxxxxxxxxxx Peter v2_4_6_1, 14/6/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Updated srun.pl: corrected bug (see rv2_4_5). Include "Africa"
Added: Makefile_snow

xxxxxxxxxxxxxx Joffen v2_4_6, 30/5/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

noxsplit changes - splits NO and NO2 similar to VOC. Use "2000" files to get default
9:95% split that we had before

... and from Dave : srun.pl added to cvs, for UiT use.

xxxxxxxxxxxxxx Peter rv2_4_5, 15/5/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug in grun.pl put in version 2_4_3. Wrong meteo link.
Sometimes the first day of a month is linked to the 1/1/ of next year.
The program will notice this and crash.


xxxxxxxxxxxxxx Peter,Heiko rv2_4_5, 19/4/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Added gc_com.f into the CVS repository. Seems to be missing. It should have been added when Peter removed gc_com.F


xxxxxxxxxxxxxx Peter rv2_4_4, 15/2/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Accept any projection in CF-1.0 convention.

NetCDF accept "general projection"
Met_ml  accept "general projection"
moved some "use Gridvalues :sigma" (the SGI compiler didn't like variables
                        to be send as argument and defines with "use")
GridValues AN calculated in GlobalPosition
Derived_ml daily D3_THx.False.
Dates_ml: included 2004

xxxxxxxxxxxxxx Peter rv2_4_3, 16/12/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Better Global version. In case of lon-lat grid and poles, special advection
routines are used.

grun.pl includes a parameter   $HEMIS which (whenx1) makes the script link to
the hemispherical input data. (this script is however quite messy...)
meteo year must be 2001 then.
(put also READBVOCx.true. in Biogenics_ml for improved BVOC emissions)

Meteorology for a whole year can be found at (met.no):
/fou2/emep2/Meteorology/ERA-40/2001_HEMIS_PS/

or (blizzard):
/home/peterw/emep/work/metdata/ERA_2001_HEMIS/


No changes of results in "normal" runs, except that in Country_ml, Russia (42)
 is defined with timezone -100, which means that longitude time is used.
(can be changed in the file if wanted)


ModelConstants_ml, Unimod.f90,Solver: dt_advec is set according to gridwidth

EmisGet_ml: use country%index to interpret country mumbers in emis
files and femis.dat

Country_ml: 193 countries defined (country index semi-official: defined by Heiko)

Met_ml: bug: should broadcast projection (concern only netcdf met input)

AirEmis_ml: bug when longitude close to 360 degrees or when latitudex90

Emissions_ml: bug in "daytime_longitude"

Advection_ml: new subroutines for advection used in case of lat-lon
grid. Less good treatment of the xy time splitting, but faster and
can cope with singularity at Poles.
Changed also adv_var, so that it can treat the
case when a subdomain is its own neighbor (cyclic grid).
For best efficiency of advection it is recommended to use NDYx2 (or
NDYx1) in case lat-lon and poles are included in the domain.


PhyChem_ml: calls  advecdiff_poles instead of advecdiff when necessary

GridValues_ml,Met_ml,Unimod.f90:: removed jmin_advec, jmax_advec, put Poles into GridValues

GlobalBC_ml,GridValues_ml: redefined lb2ij

Sites_ml: can read files in lon-lat coordinates. The file must be
called sondesLL.dat or sitesLL.dat. Height is always set to KMAX_MID.

Biogenics_ml: Includes an option to read BVOC.dat directly
    (temporary solution)


xxxxxxxxxxxxxx Peter rv2_4_2, 22/11/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

EmisGet changed to include VOC sector 10 by default (perviously excluded).
Now only sector 11 is exlcuded.

xxxxxxxxxxxxxx Peter rv2_4_1, 22/11/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

GLOBAL version of the model

Lat lon grid possible (defined through mapping factors xm_i and xm_j)

Cyclic grid in i direction

Special treatment at poles:
    -.no "neighbors", but not an outer boundary
    -.special treatment of advection

Emission_ml includes an option to choose that the local time
 (used for the day/night timefactor) is determined by the longitude
instead of the timezone defined in "Countries_ml". This option is selected when timezonex-100.
This should be better at least for countries which cover many
timezones (Russia, USA ...)
 (This also avoids defining timezones for hundreds of countries :-)

splitted parinit into two subroutines, one for subdomain sizes and the
other for neighbors and BC definitions

Removed the last optional argument from CloudAtten in Radiation_ml:
it produced a compiler error in PhyChem_ml, even if I didn't change
PhyChem nor Radiation !?

EmisGet keep VOC from sector 10 (it was removed in earlier versions)

Modified: Unimod.f90, Model_Constants, GridValues_ml, Met_ml,
Boundary_Conditions, Par_ml.pat,NetCDF_ml, Advection_ml,
Emissions_ml, My_Output_ml, Radiation_ml, EmisGet_ml

Still the results are not affected by these changes (!)
Yearly results compared to rv2_1 by Joffen.



xxxxxxx
xxxxxxxxxxxxxx Peter rv2_4, 2/11/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
(These are same. dave changed number since the changes are substantial

xxxxxxxxxxxxxx Peter rv2_3_3, 26/10/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Major clean up of binary output and all the .F files. As a consequence several parts of
the Makefile got also cleaner.

Removed:
Output_binary_ml,rmycop.c,getflti2.f,getflti2.F,putflti2.f,putflti2.F,outchem_restri.f,
put_restri_i2.f,put_restri_i2.F, gc_com.F

Modified: Met_ml, NetCDF_ml, Wrtchem.f90, Output_hourly.f90 Makefile

Parts of Output_binary are moved into Wrtchem.
Parts of getflti2.f are put into Met_ml in order to still be able to read the met files in binary.

Results are not affected by these changes

xxxxxxxxxxxxxx Peter & Joffen (+Maarten+Dave)  rv2_3_2, 6/10/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

New AirEmis from Joffen. More general: can use any grid. Some differences
in results can be expected (due to different vertical interpolation).

Changes in GlobalBC Macehead corrections.
The macehead correction uses now lat lon coordinates instead of "i,j".
This will however make a difference on the results, since the "Macehead sector" is now
defined with lon lat borders. I choosed these rather arbitrarily.
A small test for 2001 shows the following for the "O3fix" correction:
jan: old O3fixx-6.903 ; newO3fixx-6.635
aug: old O3fixx-4.871 ; newO3fixx-4.876

In the future we should also introduce an option (as an input parameter)
to skip the Macehead correction


Changed Par_ml.pat so that also the large domain is set by grun.pl
Changed grun.pl sp that it sets the large domain in Par_ml.
The date of start is now read in by the model.
The program tries now first to find at NetCDF meteo input file, if it does
not find it it reads the old felt files.
NB: You MUST update grun.pl


Changed definition of xm_i and xm_j: now it is directly the mapping factor
at the boundary of two gridcells.

Changed slightly Timefactors: if just "fname" is declared the values of "an" (from GridValues)
is overwritten(!!!). If instead fname2 and fname0  are declared (as done now) there seems to be
no problems(!). Very strange. Most probably a compiler error. The strange behaviour don't appear
when all the debugger options are on.

NetCDF_ml: We go over to CF-1.0 convention.

Output_binary: corrected an old bug
     !character(lenxsize(f_2d(1)%class)) :: typ  !  See defs of f_2d
     character(lenxlen(f_2d(1)%class)) :: typ  !  See defs of f_2d

Modified: NetCDF_ml, AirEmis,Met_ml,Par_ml.pat,GlobalBC,Log.changes,GridValues,
Unimod.f90,Timefactors_ml,grun.pl,Output_binary


xxxxxxxxxxxxxx Peter,   rv2_3_1, 5/10/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
NetCDF input for BIC.

Changed GlobalBCs_ml.f90 so that it can read the BIC from a netCDF file.
The file should be named "Boundary_and_Initial_Conditions.nc" (for now).
If the file or component is not found it looks for the "old" BIC files (D3_O3.01 etc).

An example of BIC file is given in /noserc2/emep/BIC/BIC.nc
Using this file should give the same results as before.
It contains also O3 data constructed from sattellite data. (This data needs to be more tested/ developed)

In the future the BIC.nc file should be global and the fields are to be interpolated to the required grid.

Some changes in NetCDF_ml and corresponding changes in Output_binary and Output_hourly.

Included xm_i and xm_j: the directional map factors. These are equal for a Polar Stereographic projection. (not yet tested in another grid)
(GridValues_ml and Met_ml)


xxxxxxxxxxxxxx Dave,   rv2_3, 11/7/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


Re-labelling only, for EMEP report writing process.......


xxxxxxxxxxxxxx Dave/Hilde,   rv2_2_14 , 14/6/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

.depend:      Removed from CVS. Not needed, as gmake depend generates it, and
              it complicates cvs commit.

DryDep_ml:    Tidy up (interim), plus some commented out code marker for
              EXTRA_LU outputs added - often used, but has no effect as coded
              now. Can be used to call user-generated include files if
              uncommented.

GlobalBCs_ml: Small correction to Mace head correction

GridValues_ml:  New DEBUG system introduced. GridValues now works out immediately
        which processor the DEBUG_i, DEBUG_j coordinates apply to (new logical
        debug_proc set true), and then calculates the local coordinates
       (debug_li, debug_lj). Other modules may now printout debug info with
       a system such as :


           if ( debug_proc )  then
              write(*,*) "Debuuging ", some_data(debug_li,debug_lj,KMAX_MID)
           end if

         ... instead of having to test i_glob, j_glob against DEBUG_i, DEBUG_j
          as before.  ( See the new PhyChem_ml for other examples)

         Request: please switch modules you work on to this new system - it is
         cleaner and faster.


PhyChem_ml.f90 - replaces phyche.f. Finally f90 !!!!!!!! ;-)

           Code tidied up. Makes use of DEBUG_i, DEBUG_j

phyche.f   ..... history !


Setup_1d_fields_ml - removed unused Idrctt, Idffuse

Unimod.f90         - uses PhyChem_ml, tidied up "use statements"



xxxxxxxxxxxxxx Hilde,   rv2_2_13 , 10/6/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Mace head correction for 2003 updated

xxxxxxxxxxxxxx Dave,   rv2_2_12 , 20/5/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

DryDep_ml.f90 - bug fix on SAIadd(WHEAT)

My_Reactions - bug fix on Rn222

My_WetDep    - renamed adv to itot since the index is for the xn_2d arrays, not ADV

Aqueous_ml   - renamed adv to itot since the index is for the xn_2d arrays, not ADV


xxxxxxxxxxxxxx Dave,   rv2_2_11 , 11/5/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Small changes in Met_ml and where iclass used:

iclass array replaced by more descriptive nwp_sea logical - we only
ever checked if iclass xx 0 anyway.

r_class  - declared simply, not with allocatable.

xxxxxxxxxxxxxx Dave,   rv2_2_10 , 22/4/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

psurf replaced by ps throughout. Small error in placement of psurf now hopefully
avoided.

xxxxxxxxxxxxxx Hilde,  rv2_2_9  , 14/4/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
My_chem_ml: small bug
My_Reactions.inc: production rate of Pb210 corrected
Setup_1d_ml: rc_Rn222 should be initialized for all levels. z_bnd converted to cm (from m)

Pb210 changes added to ACID as well (My_Chem, My_Reactions)

xxxxxxxxxxxxxx Dave,  rv2_2_8  , 11/4/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Rn222 and Pb210 added (for CARBOSOL, but a useful general tracer)
Quite crude addition. Should probably be harmonised with
other surface emissions  such as BVOC or Sea-Salt. ToDo.

My_Chem_ml            - Pb210 added
DepVariables_ml       - LU_ICE added
Setup_1d_ml.f90       - rc_Pb210 added
Setup_1dfields_ml.f90 - rc_Pb210 added
(Changes labelled with Pb210)


Met_ml  - small correction from Peter

UK_ml   -   water_fraction  and ice_fraction added


Some general tidy-ups

xxxxxxxxxxxxxx Hilde,  rv2_2_7 , 08/4/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Small errors in ZD_ACIDs My_BoundCondition and My_Outputs corrected

xxxxxxxxxxxxxx Dave,  rv2_2_6 , 08/4/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


New (simpler?) arrangements for calculations of ustar, Obukhov length, Exner
Less confusing use and conversions between temperature (t2_nwp) and
potential temperature (TPot2m).


Some new notations:

       tau     - was fm
       t2_nwp  - was t2
       TPot2m  - was th2m
       ustar_nwp - was ustar
       invL_nwp  - was invL

   The _nwp is used where variables are appropriate to the whole grid. When
   sub-grid procedurs are applied then different values of e.g. ustar may
   be different for different landuses.

Functions_ml
     - Exner function subroutines, and conversion functions between T and Tpot
         - causes changes in Met_ml, Sites_ml, DryDep, .....
       Note that sometimes we need Exner_nd(p) and sometimes CP*Exner_nd(p)

Met_ml
     - tau (was fm) - now created for MM5-type inputs from ustar, on assumption
       that it is better to linearly interpolate tau in metint than ustar.
       (Since tau ~ ustar**2 is proportional to energy.)

     - Surface temp is now t2_nwp. Multiple conversions to old th2m now
       removed. Tpot2m (was th2m)  now done in met_deriv

     - Exner_ml used

SeaSalt
     - use of new ustar_nwp. Moved "use" statements to start of module (should
       be done for all modules)

Tabulations_ml
       Exner stuff removed. Only tab_esat remains!

Also - ZD_ACID/My_Chem changes for new Radiation_ml treatment: zen, radzen
       ZD_ACID/My_Outputs corrected for N_NOy.

DOCS:
    - Corrected figure of Arakaw u,v grid locations, based upon plot from Peter
    - Added new rule in Progrules.tex, suggested by Peter


xxxxxxxxxxxxxx Dave,  rv2_2_5 , 5/4/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Re-write of Radiation_ml and associated handling

**** NEW *****
TimeDate_ml.f90 - added. Much nicer date calculations! (Will supercede Dates_ml
                    in future code)
**** NEW *****

Radiation_ml - subdivided with new routines and re-arranged. Now doesn't need Par_ml.
               Uses elemntal routines to allow use in both 1-d models and EMEP

               Some changes
                 SolarSetup  subroutine
                 Ashrea table ......
                 ZenithAngle sub
                 etc.-

Causes small changes in many routines which used radiation, zen, etc., inc:

   Met_ml - now used to store Idirect, Idiffuse
   PhysicalConstants_ml - DAY_ZEN, DAY_COSZEN added
   phyche.f -  subroutine calls changed

xxxxxxxxxxxxxx Hilde, rv2_2_4  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
GlobalBCs_ml - BC for so2,nox,nh4 allowed for year>2003. Trend BCs also for NO,NO2,PAN
My_BoundConditions, ACID - no3, nh4 bcs added

xxxxxxxxxxxxxx Dave,  rv2_2_3 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

DryDep_ml    - "call ReadLanduse" moved to Unimod.f90
Emissions_ml - some dead code removed
UK_ml        - ukdep_init called on all nodes. Removed  need for man gc_rbcast lines
Unimod.f90   - "call readLandUse" moved here.
Wrtchem      - AOT output removed.

xxxxxxxxxxxxxx Peter, rv2_2_2 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Redefined u_ref into Met_ml including the map factor:
NB: Will influence the depositions rates,
specially in Southern areas (15% higher deposition rate in Greece?).
Concentrations and depositions may change by several % in Southern areas.


I propose the following principle for variables derived from
meteo variables in Met_ml:

one routine (metvar) controls the variables derived from the meteofields
after every meteoread (every METSTEP)

one routine (metint) redefines (interpolates) the meteo fields between
each meteoread (every dt_advec)

one routine (met_derived (new)) derives the meteofields after each
interpolation (i.e. met_derived is called from or after metint)

In this logic tiphys is called from metvar  and u_ref is defined
in met_derived

metvar needs some cleaning. Volunteers?


xxxxxxxxxxxxxx Peter, rv2_2_1 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Defined "ref_latitude" which is latitude for true distances (60 for PARLAM-PS)

GlobalBCs_ml: defined IGLOB x IILARDOM and JGLOB x JJLARDOM (resulting values
are the same as before, but in new grids these will change)

Removed part in ReadField for non-EMEP grid.

xxxxxxxxxxxxxx Peter, rv2_2_0 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Included a new routine into Met_ml which is able to read meteo fields
in NetCDF format. Still under development.
The old one is still used as default.

Some cleaning. Removed some meteo fields which are not often used,
but kept SST for Svetlana)

xxxxxxxxxxxxxx Dave, rv2_1_10  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

UniMan added!
        - intended as guide for new users, and reminder for old ones.


Met_ml - some tidy up ot tkediff subroutine, to follow coding suggestions
         of User guide.

xxxxxxxxxxxxxx Joffen (Peter) 7/3-2005       , rv2_1_9 xxxxxxxxxxxxxxxxxxxxx

Additional meteo prameters are read: cloud convection and sea surface temp (ccc and sst)

Gutas parameterization of the boundary layer turbulaence and the old parameterization are both included. To choose between them the logical parameter  TKE_DIFF has to be set.

In addition some cleaning up of outdated programming has been done, as
do xxx i x 1, iend


xxx continue

where xxx is a number

has been replaced by
do i x 1,iend

end do


xxxxxxxxxxxxxx Peter 21/2-2005            , rv2_1_8 xxxxxxxxxxxxxxxxxxxxx

Moved the parameter NTDAY from Derived_ml into ModelConstant_ml.
Added some comments.
Changed a comment in Advection_ml.

xxxxxxxxxxxxxx Hilde/Dave 18/2-2005            , rv2_1_7 xxxxxxxxxxxxxxxxxxxxx

Submitted Hilde's changes to BCs for historical runs.


xxxxxxxxxxxxxx Dave  17/2-2005            , rv2_1_6 xxxxxxxxxxxxxxxxxxxxx


ReadField_ml
  -Initialisation to zero added, so now we do not need to input an array which
   covers the whole domain.

   Also, print used instead of write for error messages, and
   errmsg more explicit now.

Sites_ml: Fix for Embla/Gridur bug,  where printouts of numbers < 1.0e-99
            were messed up.

          Also, N_NIT renamed to N_NOy, and sum_NIT renamed to sum_NOy, since
          NIT is confusing with nitrate, which NOy isn't.

ZD_.../My_Outputs:   N_NIT -> N_NOy

         Also, max NSITES_MAX and NSONDES_MAX increased to 99.
         (Temporary. Will make arrays allocatable soon....)

xxxxxxxxxxxxxx Peter, 9/2-2005            , rv2_1_5 xxxxxxxxxxxxxxxxxxxxx

N_NIT was not defined in ZD_ACID
Updated ZD_ACID/My_Ouputs_ml so that it is compatible with the ZD_OZONE
changes.I defined N_NITx1. If necessary please define differently.
(Also changed to NHOURLY_OUT x 1, since clouds do not seem to be defined.)

xxxxxxxxxxxxxx Hilde, 3/1-2005            , rv2_1_4  xxxxxxxxxxxxxxxxxxxxx

grun.pl updated also

xxxxxxxxxxxxxx Hilde, 3/1-2005            , rv2_1_3  xxxxxxxxxxxxxxxxxxxxx

Sites_ml.f90: increased nmax_sonde
3D fields for pressures etc, from joffen: Derived_ml.f90, My_Derived
Changes for trend output:My_Outputs_ml.f90
Name on 3D ouput changed: Wrtchem.f90

xxxxxxxxxxxxxx Hilde, 15/12-2004            , rv2_1_2  xxxxxxxxxxxxxxxxxxxxx

BC trends 1980-2003 for S and N based on EPA emissions for 1980-2003 added in
GlobalBCs_ml. For NH4 the trend is based on 2/3SO2 +1/3NOx

Also, PhiH added to Functions_ml, Dave

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    rv2.1 x rv2_0_8   same as used for SR matrix work for IIASA, Oct 2004
            but rv2_0_9 has no numerical change, so we rtag the code here.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


xxxxxxxxxxxxxx Peter, 29/10-2004            , rv2_0_9  xxxxxxxxxxxxxxxxxxxxx

added file gc_com_for_1_proc.f
This can be used as a "fake" gc_com.f in the cases where
NPROCx1 and no mpi compiler is available.
To use it: replace gc_com.f with gc_com_for_1_proc.f and remove the
preprocessing of gc_com.F from Makefile


xxxxxxxxxxxxxx Peter, 5/10-2004            , rv2_0_9  xxxxxxxxxxxxxxxxxxxxx

in grun.pl:  $BCDIRO3    x "$HILDE/BC_data/LOGAN_O3_DATA/50Data_900mbar_mixratio_firstline"

xxxxxxxxxxxxxx Dave, 29/9-2004            , rv2_0_8  xxxxxxxxxxxxxxxxxxxxx

skipx1 on open_file in Global_ml

xxxxxxxxxxxxxx Dave, 29/9-2004            , rv2_0_8  xxxxxxxxxxxxxxxxxxxxx

maceheadxmacehead+3 ppb  for 2010 runs


xxxxxxxxxxxxxx Svetlana, Peter  28/09-2004, rv2_0_7  xxxxxxxxxxxxxxxxxxxxx
SeaSalt_ml.f90 used "rough.170" to find sea areas (iclas x 0)
Now it has been changed to identify sea areas using "landuse.mars2004" data
and scales the sea salt emissions with the water area fraction in the grid.

New grun.pl with extra RunLog info.

xxxxxxxxxxxxxx Peter,Dave;Hilde  24-28/09-2004, rv2_0_6  xxxxxxxxxxxxxxxxxxxxx

grun.pl: Redefined BC from Logan for O3 for OZONE
Defined SOMO0 in Derived_ml
DryDep - modified for safer flux calculations
UK_ml - luflux_wanted set true for decid forests and wheat only.
Makefile without debug options

xxxxxxxxxxxxxx Peter,Svetlana,Dave  24/09-2004, rv2_0_5  xxxxxxxxxxxxxxxxxxxxx

ZD_ACID/,ZD_OZONE/My_Aerosols_ml:
     t20(:)  x 293.  (instead of  t20(:)  x 283.)

molwt defined as real in My_Chem_ml

xxxxxxxxxxxxxxxxxxx Peter,  23/09-2004, rv2_0_4  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Modified Setup_1d and Met_ml: subtracted 1.E-9 from u,v, it2m and itemp.
This should not change results, but is there in order to avoid
rounding differences on gridur and cluster.

xxxxxxxxxxxxxxxxxxx Peter,  17/09-2004, rv2_0_4  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Derived_ml and ZD_OZONE/My_Derived_ml:
five new d_2d ("D2_SOMO35","D2_AOT30f",D2_AOT40f","D2_AOT60f","D2_AOT40c").

NB: the definition of SOMO35 is slightly different than in "hourlyozone2ramot35":
1)the running average is done over 20 minutes intervalles
2)period 16-24 also taken into account (was not in in the first version of ramot35)
Note that the end of SOMO35 day is at midnight (not end_of_emepdayx06:00)

Derived_ml
Introduced new "averaging" for yearly and monthly output of AOTXXc, AOTXXf, SOMO35, D2_MAXO3, D2_MAXOH, D2_EUXXX og D2_UNXXX.

NB: the D2_MAXO3 obtained in the yearly output is slightly different than that obtained using "hourlyozone2ramot35" on hourly output, because in the yearly the max is taken on EMEP_day, while "hourlyozone2ramot35" uses 00:00-24:00.

Dry_Dep_ml: bug corrected (small effect (<1%) on results) in def of SAIadd

My_BoundaryConditions_ml: removed a double declaration of IXADV_H2O2 (compiler on blizzard don't like that)

small changes in grun.pl

xxxxxxxxxxxxxxxxxxx Hilde,  27/08/2004, rv2_0_3  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

GlobalBCs_ml
 My_Chem_ml and My_BoundConditions_ml in OZONE

 H2O2 and CH3COO2 BC corrected for H2O2 and CH3COO2.
 OH BCs in OZONE taken out.

 Hilde 27/8/2004

Output_hourly  -- cfac comments fixed to 50m->3m

xxxxxxxxxxxxxxxxxxx Dave,              6-11/07/2004, rv2_0_2  xxxxxxxxxxxxxxxx

GlobalBCs_ml: 2002 and 2003 added to mace_head. Preliminary values needed for
   EMEP report, derived from Mace Head obs data for CFCs

My_Derived_ml: Warnings only written once now in My_Derived, to avoid huge log
    files (only done in ACID so far)

My_Outputs: Cloud added as example.  (only done in ACID so far)

Output_hourly: "Cloud" added as option for Output_hourly

grun.pl: no bzip2 of hourly.nc file. Some emisdir changes. Alsop BCDIR moved so that
    OZONE always uses 1997 stuff. (BCDIR is only really needed for ACID, since it
    is intended that BCDIR contains the output of OZONE mode runs).

xxxxxxxxxxxxxxxxxxx Hilde,               01/06/2004, rv2_0_1  xxxxxxxxxxxxxxxxxxxxxxxxxx
ACID and OZONE changes to include BCs from OZONE (OH,CH3COO2,H2O2, O3(acid)). For OZONE, this will have
 effect only when a smaller domain than 170*133 is used.
Link to Logan files in mixing ratio.
Some SR-My_Derived stuff that should not have been put into ACID removed.
Files changed:
grun.pl
GlobalBCs_ml
My_BoundConditions_ml
My_Derived_ml, only for ACID
My_DryDep_ml
Setup_1d_ml
My_Chem_ml

xxxxxxxxxxxxxxxxxx Peter/Dave               01/04/2004, rv2_0beta  xxxxxxxxxxxxxxxxxxxxxxxxxx

New grun.pl which also runs SR if required.

new vocsplit data, obtained from a mxiture of IIASA emissions and IER speciation,
for  year 2000 and year 2010.

bunzip2 bug fixed

Biogenics_ml.f90 forests.tf2 renamed to forests.dat


xxxxxxxxxxxxxxxxxx Peter/Dave               01/04/2004, rv1_9_34   xxxxxxxxxxxxxxxxxxxxxxxxxx

grun.pl added  ja and ja -s to give resource use info in the output

New forest and landuse input data


xxxxxxxxxxxxxxxxxx Hilde,               01/04/2004, rv1_9_33   xxxxxxxxxxxxxxxxxxxxxxxxxx
Pseudo H2O2 concentrations introduced in ACID to account for ox. limitations.
Solver and My_Reactions.inc (ZD_ACID) changed.

xxxxxxxxxxxxxxxxxx Peter,               31/03/2004/ 01/04/2004, rv1_9_33   xxxxxxxxxxxxxxxxxxxxxxxxxx
small changes in grun.pl:
    sites.* are tared: tar cvf ${runlabel1}.sites sites.*
    RunLog is renamed ${runlabel1}_RunLog
    bzip2 is made parallell: to compress files just add them into  @bigfile_list
ZD_OZONE/My_Output: only O3 as hourly output

some removal of double declarations
removed version attribute from Netcdf files. (use runlabel instead)

SeaSalt_ml: replaced vind10 ** (3.41) by exp(log(vind10) * (3.41))


xxxxxxxxxxxxxxxxxx Dave,               31/03/2004, rv1_9_32   xxxxxxxxxxxxxxxxxxxxxxxxxx

 My_Derived_ml:

  !ds 24/3/2004:
  !dsNSR - new system for distinguishing source-receptor (SR) stuff from model
  !        evaluation.  The SR runs should use as few as possible outputs
  !        to keep CPU and disc-requirements down. We define first then the
  !        minimum list of outputs for use in SR ("NSR_2D"), then define an extra list
  !        of parameters (dimesnion NEXTRA_"2D) needed in model evaluation, or even
  !        for the base-case  of SR runs.

  Also define SOURCE_RECPEPTOR in My_Derived. Used in Derived to set all daily
  outputs to false if .true.

  Also defined two new params: NOXxNO+NO2, NOZxlots of NOxzy thingies

 Derived_ml:

  Consistency_check in Derived now checks that if SOURCE_RECPETORx.true. then
  dimension of NDERIV_2D xx NSR_2D

  FST30 added to def_2d. Other FSTs renumbered

  Also defined two new params: NOXxNO+NO2, NOZxlots of NOxzy thingies

 DepVariables_ml

     ECO_SEMINAT redefined to include more categories

  My_DryDep_ml

     Depositions to water and wetlands removed.


private added to:
Dates_ml.f90
ModelConstants_ml.f90


And, for information, the file Sorted.Deriv is now in my Unify directory - it
gives the numbers used in the Derived fields. Makes it easy to find some
free numbers for new variables.

xxxxxxxxxxxxxxxxxx Svetlana/Peter,     24/03/2004, rv1_9_31   xxxxxxxxxxxxxxxxxxxxxxxxxx

SeaSalt included into PM10, PM25, PMco

Added some "fake" declarations into ZD_ACID

xxxxxxxxxxxxxxxxxx Svetlana/Peter,     23/03/2004, rv1_9_29   xxxxxxxxxxxxxxxxxxxxxxxxxx
Inclusion of Sea salt

Dates_ml: LAST_SDYEAR x 2003


xxxxxxxxxxxxxxxxxx Dave,     17/03/2004, rv1_9_28   xxxxxxxxxxxxxxxxxxxxxxxxxx

Derived_ml: Many changes

    Bug-fix i_glob defined ,locally
    Deriv for new 3D fields added
        d_3d for new 3D fields added, inc use of End_of_Day
        gc_abort  added if 3d type not found

DryDep_ml
        Fixed bug in SAIadd found by Peter
        changed g_pot to 1.0 for wheat
Runchem
        Test output of OH, H2O2, (TMP)
UK_ml
        debug_i x> DEBUG_i
Wrtchem
        Allows ascii 3D output, for BCs

ZD_OZONE/My_Chem_ml
        NSPEC_SHL has 1 added for Hilde's IXSHL_PHNO3, PHNO3
        Affects all NSPEC_TOT numbers

ZD_OZONE/My_Reactions:_ml
        PHNO3 added.
        Slightly CPU-faster lines for VOLFAC stuff.

ZD_OZONE/My_Derived
        with extra 3D. Also renamed D2_H2O to D2_PM25_H2O

ZD_OZONE/My_Outputs
        Ascii_3D_WANTED added - generates 3D BCs if set
        some extra ouputs (TMP!)


xxxxxxxxxxxxxxxxxx Peter,     5/03/2004, rv1_9_27   xxxxxxxxxxxxxxxxxxxxxxxxxx

Version compatible with Intel and Lahey compiler on IBM cluster (blizzard)

NB: change in grun.pl: will not work with old grun.pl

Several modules: Removed double declarations,
             Removed lines containing only a continuation line (&) (compiler bug)

Advection_ml: preadvx,preadvy:
         small bug in array size declaration (preadvx only)
             non-blocking send with buffered arrays
BoundaryConditions_ml:
        allocate also when sizex0
            forall with mask replaced by loop

Dates_ml: small bug in add_2dates (newdate%month could be > 12 at some intermediate stage)

EmisGet: test of intext with "any" crashed: replaced by a loop

Emissions_ml: initialisations

MARS_ml: molnu,phimult defined as intent(in)

Radiation_ml: initialize coszenx0. ( (?)so that it can be used in
        "real, dimension(size(coszen,1),size(coszen,2)) :: expa, catten, Idrctn")

Sites_ml: added fmtx" " in write(xxx,fmtx" " )

Unimod.f90: read input parameters from file (INPUT.PARA) instead of from standard input
        The file INPUT.PARA is produced by grun.pl

grun.pl: produce INPUT.PARA to be read by Unimod.f90

Makefile: commented out debug option

xxxxxxxxxxxxxxxxxx Svetlana,     4/03/2004, rv1_9_26 xxxxxxxxxxxxxxxxxxxxxxxxxx
PM Water added to aerosols for OZONE.  Needs extension to ACID but to be done.....
commited by Dave, so changes need to be filled in later.  From Sevtlana:

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Hi, Dave and Peter

I put PM_water (parameter 662) to ACID/OZONE_rv.1.9.25
I've made one-day runs with ACID and OZONE. The values for water
looked reasonable

Everuthing  is on ~mifast/Unified__rv.1.9.25/Unimod.

New lines are marked with  "!water".

The modules affected are:
  phyche.f
  Runchem_ml      (calls Aero_water when daily output)
  Derived_ml
  Chem_ml

and  My_Aerosols_ml      (got new subroutine Aero_water)
         My_Derived_ml

I've also attached for Peter my earlier e-mail ( see below).
I reckon you, guys, can decide between yourself on how to procede.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


AFRIC_ADDED bit (non-serious bug) fixed in grun.pl



xxxxxxxxxxxxxxxxxx Dave,        20/02/2004, rv1_9_25 xxxxxxxxxxxxxxxxxxxxxxxxxx

GlobalBCs_ml     ... bug fixed: SpecBC needs to be set for all used species
                    (H2O2 wasn't) check for this added

PhysicalConstants_ml ...   RAD2DEG added

Radiation_ml.f90 --- Bug found! 1900 wrongly added to year. Gives small
                      shift in equation of time (e.g. 8 mins for Jul 1st), hence
                      declention angle and zenith angle.

                 --- solarnoon and daylength calculation added. Useful in ACID

xxxxxxxxxxxxxxxxxx Peter,        17/02/2004, rv1_9_24 xxxxxxxxxxxxxxxxxxxxxxxxxx
NetCDF_ml: Out_netCDF, optional input parameter "fileName_given", can be
    used to explicitely give the name of an output file.
    The use of fileName_given is probably slower than the implicit
    filename used by defining iotyp. Use it only if a "non-standard"
    output (i.e. not out_year.nc etc.) is needed

Met_ml: defined case(-11) to define sdot when it is given at level
    boundaries instead of midlevels. (ident(6)x-11 is pw defined)

xxxxxxxxxxxxxxxxxx Dave,        29/01/2004, rv1_9_23 xxxxxxxxxxxxxxxxxxxxxxxxxx

RunChem_ml ... debug_flag set false before DEBUG tests
grun.pl  - now chooses sonde file depending on SR or not - fewer stations
           used for SR runs.

xxxxxxxxxxxxxxxxxx Dave,        21/01/2004, rv1_9_22 xxxxxxxxxxxxxxxxxxxxxxxxxx

GlobalBCs_ml   - add close(IO_GLOBBC)  statements after read. Maybe it doesn't
                 matter, but it feels safer!

grun.pl - add OHDIR for acid if $SR
        - remove any .nc files prsent in WORKDIR
        - add new small domain for extended OSPAR
        - compresses day.nc and hour.nc files with bzip2
        - Hilde on u6, not u5 now.

xxxxxxxxxxxxxxxxxx Dave,        17/01/2004, rv1_9_21 xxxxxxxxxxxxxxxxxxxxxxxxxx

New Derived system added for ACID also. See comments on OZONE introduction
below.

Bug-fix: ddep needed initialisations for ecosystem stuff!


xxxxxxxxxxxxxxxxxx Dave,        13/01/2004, rv1_9_20 xxxxxxxxxxxxxxxxxxxxxxxxxx

Derived_ml -- added T for month in D2_MAXO3


xxxxxxxxxxxxxxxxxx Dave,         7/01/2004, rv1_9_19 xxxxxxxxxxxxxxxxxxxxxxxxxx

Changes to fix initialisation bug for AOT found by Peter:

Derived_ml
My_DryDep_ml

grun.pl domain extended beyond OSPAR to East, but only to jx7 in
south, because of BC problems (especially with rainfall from
jx1..7).

xxxxxxxxxxxxxxxxxx Dave,        26/12/2003, rv1_9_18 xxxxxxxxxxxxxxxxxxxxxxxxxx

DryDep_ml   - leaf_flux initialised to zero for each landuse
NetCDF_ml   - write used instead of print. (Reason: write output is buffered
              whereas print is not. Hence, for normal use, write is better.
              For trapping errors (e.g. before gc_abortx, print is better.


xxxxxxxxxxxxxxxxxx Dave,     21-22/12/2003, rv1_9_17 xxxxxxxxxxxxxxxxxxxxxxxxxx

New Derived system!! Changes in many routines. Main idea is to
set variables by name in My_Derived_ml, and let Derived_ml work
out what these are. "Master" lists of derived variables are kept
in def_xx variables which correspond to the used f_xx (i.e.
def_ddep contains the full list of possible f_ddep).

In other routines, most changes are to "use Derived" instead of
"use My_Derived".

BUG-FIX - c_hveg O3 calculation improved in DryDep_ml

BUG-FIX -  grun.pl improved for usage of mkp.pmadd

NetCDF_ml: write NetCDF output files
       new definition of projection_params
       Instantaneous concentration file

Many changes in Nest_ml

Met_ml: Test ident(17) for defining xp,yp
        (not used yet but available: calculate sigmadot from a mass
                                     conserving principle)

Read_Field: In case of non-EMEP grid transform fields to grid (bug corrected)

Solver: do fewer iterations when dt_advec<520 seconds


xxxxxxxxxxxxxxxxxxxDave, 23  Sep 2003  1_8       xxxxxxxxxxxxxxxxxxx

Rtagged as rv1.8. The "official" version.



xxxxxxxxxxxxxxxxxxxHilde , 3 Sep 2003  1_8beta3  xxxxxxxxxxxxxxxxxxx
Mace_head O3 for 2001 in GlobalBCs_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, Peter  1st Sep. 2003  rv1_8beta2 xxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter spotted bug in Met_ml. KZ_MINIMUM was not used! Fixed!


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave,  1st Sep. 2003  rv1_8beta xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
MODEL AS DOCUMENTED!! (Except need to change from tf2_ to new files)
in Preport 1/2003, Part 1

Changes made while documenting model:

DryDep_ml.f90
    -- Bug fix: SAIadd moved here from UK_ml
GlobalBCs_ml
    -- vmin fixed for HNO3, SO2
Met_ml
    -- zs1 renamed to zs_bnd
    -- new params and variables:
       real, parameter :: KZ_MINIMUM x 0.001   ! m2/s
       real, parameter :: KZ_MAXIMUM x 1.0e3 ! m2/s - as old kzmax
       real, parameter :: KZ_SBL_LIMIT x 0.1 ! m2/s - Defines stable BL height
       real :: h100 ! Top of lowest layer - replaces 100.0
PhysicalConstants_ml.f90
    -- KARMAN x 0.41  (more consistent with Garratt)
UK_ml
    -- Bug fix: SAIadd moved to DryDep
ZD_OZONE/My_Reactions.inc
  -- GLYOX photolysis products changed
ZD_OZONE/My_WetDep_ml.f90
ZD_ACID/My_WetDep_ml.f90
  -- WScav for pNO3 changed.

+ small tidy ups in DefPhotolysis

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 24th Aug.  rv1_7_4 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

ZD_OZONE: My_Reactions_ml
   --  Bug fix: changed products of glyoxal photolysis to be HO2 + 2 CO
       instead of HO2 + CO.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 19th Aug.  rv1_7_3 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Derived_ml:
--  Subroutines Consistency_checks and Consistency_count added to search
     for duplicate entries in derived fields.

ZD_OZONE/My_Derived_ml:
--   Renumbered ecosystem-entires to avoid collision of numbers (had 541 for
     both WDEP_SOX and DDEP_RDNWE
--   Added AOT30.

grun.pl
-- modified to point to latest emission files (after bug-fix from Heiko).
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 1st Aug.  rv1_7_2 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Met_ml.f90
-- replaced older Businger+Iversen/Nordeng  \Phi with same Garratt function
as used in deposition scheme.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 1st Aug.  rv1_7_1 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

BoundaryConditions_ml.f90
-- tidy up.
-- replaced old Rorvik stuff with use of DEBUG_i,j

GlobalBCs_ml.f90
-- Bug fixes:
   1) 2*PI instead of 4.0 * atan(1.0) for twopi_yr

   2) bc_rawdata(kx20) set to specified BCs, not kx1 !!
   (the BCs were upside down !)

-- Improved vertical scaling - now  uses physical height instead of sigma index
-- mace_head iyr_trend /x year option.


Functions_ml.f90

-- added function StandardAtmos_kPa_2_km to convert model's pressure
   level to standard height.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 1st Aug.  rv1_7rep2003 xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

    ****** THE REPORT VERSION ********


REPORT 1 2003, Part II (model performance) used rv1.6.12. Couldn't tag
as rv1.7 as this tag had been mistakenly applied before.  Use rv1_7rep2003
instead.

Only changes to - this file
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 18th June, rv1.6.12 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Derived_ml - added defintions of ecosystems: ECO_CONIF_FOREST, etc.
Changed My_DryDep in ZD_OZONE to make use of these. (Needs same
change in ZD_ACID still)

grun.pl - added check for ProgDir
Makefile: touch depend removed from clean
Output_hourly - Idirectt, Idiffuse added as options

My_Outputs_ml - SITE_XTRA_INDEX, SONDE_XTRA_INDEX introduced to simplify
      access to data from d_2d, d_3d  arrays.
Sites_ml - d2index, d3index introduced to simplify
      access to data from d_2d, d_3d  arrays. Removes need for explicit
      FSTCF0 cases etc.
ZD_ACID/
    My_Derived - added NOUTPUT_ABS_HEIGHTS - no effect but allows compilation
    My_DryDep  - added c_hveg to Add_ddep
    My_Outputs - as above
ZD_OZONE/
    My_Outputs     - as above
    My_Derived_ml  - new definations for ddep and ecosystem-specific stuff
    My_DryDep      - added use of ECO_ arrays

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Hilde, Dave, 11th June, rv1.6.11 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
SO2/NH3 dependence for NH3 dry dep included in Rsurface_ml.f90

Dates_ml changed to use FIRST_SDYEARx1980, LAST_SDYEARx2001
  Timefactors_ml modified to use these also.

iyr_ytrend introduced - allows "trend" year to get BCs outside the
   normal 1990-2000 range, e.g. for 1980 or 2050.
   Changes in:
        BoundaryConditions, ZD_XX/My_BoundaryCOnditions, Global_ml.f90,
        grun.pl, ModelConstants_ml, Unimod.f90

** Specify iyr_trend in grun.pl **

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 11th June, rv1.6.10 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Need to account for trends in runs from 1980..2000 :-(
Changed BoundaryConditions_ml to pass year to Set_mybc
Changed ZD_OZONE/My_Bound..   to allow trend_year to set CH4
  Trends introduced for 1990-2000 so far
  (CH4 increased anyway for 1990, from 1760 to 1780)
Fixed bug in grun.pl (2 emisdirs), My_Derived
Changed source of sites.rep03 to $DataDir in grun.pl

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 11th June, rv1.6.9  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
My_WetDep_ml, increased scavenging ratios
Sites_ml extended to include height of site, based upon Joffen's trotrep work
landuse.tfw used instead of landuse.tf2 (small change)
metdata, emissions, files updated in grun.pl
My_Outputs - some D_2D outputs removed while considering errors
My_Derived - only O3 and H2O2 as 3D

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 10th June, rv1.6.8  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Biogenics_ml.f90
Biogenic emissions now derived from landuse.tf2 and using
isoprene emissions factors of Simpson et al., 1999
grun.pl now uses DataDir/forests.tf2, not forest.pcnt

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 10th June, rv1.6.7  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Light factors added to isoprene emissions:
Radiation_ml, Setup_1d_ml, phyche.f

removed 300 ppb limit for O3 in GLobalBCs_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 10th June, rv1.6.6  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
DryDep_ml.f90
IXADV_O3 replaced by FLUX_ADV
Neutral stability assumed when we have land in a grid,  but Hirlam thinks it
is a sea-square.

Met_ml.f90
Pielke's Kz instead of Iversen+Nordeng variety

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 5th June, rv1.6.5  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Changed to SEI_based landuse, and added new-style (Fst) flux calculations.
Changes in DryDep, UK_ml, outouts, etc.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 4th June, rv1.6.4  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
grun.pl changed to use ds-fix for UK emissions
New GLobalBCs_ml, using Mace Head BCs correction to Logan
(Needs current_date%year to be passed in Unimod.f90 and BoundaryConditions_ml also).
Makefile reset to not use -g as default

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 4th June  2003, rv1.6.3t xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Makefile changed to default without -g option.
Small change to grun.pl to use trends_2003 emissions
(Not model changes, but committed to keep coming comparisons simpler)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 29-29 May 2003, rv1.6.3  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Real Output_hourly changes (as should have been done for rv1.6.2)

Idrctt, Idfuse added to Setup_1Dfields_ml - allows use by other
routines.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 27-28 May 2003, rv1.6.2  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Output_hourly, and My_Outputs_ml.f90 modified to add headers to outputs,
including number, names, etc. - should make it easier to write and use
processing programs.

Aqueous_ml .. small printout bug fixed

Met_ml - added field surface_precip x rainfall direc from HIRLAM in mm/hr

DryDep_ml, Rsurface_ml, uses surface_precip and logical is_wet instead
of pr_acc

xxxxxxxxxxxxxxxxxxx Hilde 27th of May rv1.6.1 xxxxxxxxxxxxxxxxxxxxxxxxxx
Aqueous_ml changed with consistent, tabulated lwc
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Svetlana, 8th May  2003, rv1.6  xxxxxxxxxxxxxxxxxxxxxxxxxx

grun.pl is updated to include PMco emissions.
PM emissions are read from ~svetlana/Unify/MyData/emission/em2000 (instead of emis99)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Svetlana, 7th May  2003, rv1.6  xxxxxxxxxxxxxxxxxxxxxxxxxx


Primary PM25 and PMco are included in OZONE version. Files modified are:
My_Chem_ml.f90,  My_Emis_ml.f90,  My_DryDep_ml.f90,
My_WetDep_ml.f90, My_MassBudget_ml.f90, My_Derived_ml.f90, My_Reactions

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Hilde, 7th MAy  2003, rv1.6  xxxxxxxxxxxxxxxxxxxxxxxxxxxx
My_Reaction.inc : Added H2O2 loss due to SO2 ox
My_Derived_ml.f90: Fixed D3_names (before all was D3_NO2)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Peter, 14th April  2003, rv1.5.3  xxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave,  24th April  2003, rv1.5.3  xxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

corrected name of PPM25 and PPMco in ZD_ACID/My_Derived (affects only Net_CDF output )
Used 600 instead of 619 for aNH4 in ZD_ACID & ZD_OZONE /My_Derived

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Peter, 2nd April  2003, rv1.5.2  xxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Increased maxsize of Deriv%name to 15 characters in My_Derived and redefined some names

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 1st April  2003, rv1.5.1  xxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug fix for So2->SO4 rates in ZD_OZONE/My_Reactions.inc


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 28th March 2003, rv1.5  xxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Stable (?) version fir TFMM runs.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde/Joffen/Dave  28th March 2003, rv1.4.29   xxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Units changed to tot. mass in My_Outputs_ml.f90
ADVppbv, ADVugm3, SHLmcm3 now used for Hourly outputs
Output heights put to 3m (or top of tree, er, too difficult to explain, so say 3m )
 - spo use Vg_3m in DryDep and Ra_3m in SubMet_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  27th March 2003, rv1.4.29   xxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ZD_ACID: My_Reactions re-corrected for old errors which seemed to come back!
         : HNO3 mssing from pNO3 production, aqrck(ICL3 missing from SO4
grun.pl - now calls "gmake depend" and "gmake" instead of just "make".
    This creates the .depend file

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  27th March 2003, rv1.4.28   xxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
DEBUG_AERO set false in DryDep_ml
OZONE:NDERIV_2D corrected for bug spotted by Peter (tNO3 line)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde 26th March 2003, rv1.4.27   xxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ACID:My_DryDep_ml.f90:
N_OXN and OXN array and corrected
OZONE:NDERIV_2D corrected
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde 26th March 2003, rv1.4.26   xxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
My_Derived_ml:
Parameter number for aNH4 changed as it overwrote NO2
Parameter numbers for NH3 set equal in both ACID and OZONE
tNO3 included in OZONE
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Svetlana/Dave 25th March 2003, rv1.4.25   xxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Aero_Rb_ml added to enable particle deposition rates to be used.
Fine and coarse rates for So4, aNO3, pNO3, etc.
+ pw bug fix (not changing results?) for no2fac usage in DryDep_ml.
+ reset INORGANIC_AEROSLS true, RUN_EQSAM false in My_Aerosols.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde/Dave 24th 2003, rv1.4.24  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

ZD_ACID/My_WetDep changed to remove wet dep of PM
ZD_OZONE/My_Reactions changed to include aqrck for OH, HO2
.depend and Makefile  introduced - new system suggested by Heiko.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  24th 2003, rv1.4.23  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug fixes found by Hilde in ZD_ACID/My_WetDep_ml, My_Reactions, My_DryDep.
Bug fix in DryDep_ml (max in so2nh3ratio), Dave
Logicals vegetation, urban, added to DepVariables_ml, UK_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  21th 2003, rv1.4.22  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SO2/NH3 ratio  REALLY working!  As I (ds) had put so2nh3ratio as intent(in)
the compiler didn't accept it being multiplied by 0.6. Now so2nh3 is used
for the product.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde, Dave  21th 2003, rv1.4.21  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SO2/NH3 ratio  REALLY introduced! rv1.4.20 had RHlim function only.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde, Dave  21th 2003, rv1.4.20  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SO2/NH3 ratio used in DryDep and Rsurface. Also Rhlim function.
(with RH<1 !)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave,  March 21th 2003, rv1.4.19  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Fixed My_Reactions for "old" SO2, new pNO3
Extensive stomatal flux  changes in DryDep
Many outputs in My_Derived, My_Outputs, etc.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Peter, March 21th 2003, rv1.4.18  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Included variable timestep in Solver.f90
"Decoupled" variables in ZD_OZONE/My_Reactions.inc:
(PAN,CH3COO2) ,(MPAN,MACRO2), (NO3,N2O5)
ModelConstants: declared dt_advec as a parameter
Dchem is now rate of changes during last dt_advec, instead of absolute change during dt.
Net_CDF: removed a "+" in units attributes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave, March 21th 2003, rv1.4.17  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Met_ml bug fixed.
SO2-> SO4 treatment unified in OZONE and ACID
(SO2+CH3O2 reaction removed from OZONE as part of this, Fe-reaction added to both).
pNO3 introduced - coarse mode nitrate
Forgot to say earlier: New NO2 deposition method, FNO2 x Vg. max(NO2-4,0)
assumed compensation point of 4 ppb NO2.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave, Svetlana, March 10th 2003, rv1.4.16  xxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Primary PM added into ACID version. This slows down ACID a bit, but removes
the need for a separate PM directory. Also, S-R matrices can be done
for PM and ACID substances at the same time - since they are independant.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Peter ,  Feb. 27th 2003, rv1.4.15  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  ,  Feb. 27th 2003,           xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
pw: Improved netCDF output.
ds: New style of BC specification, with ACID and OZONE in grun.pl
ds: O3fix removed from My_Chem_ml
ds: My_Chem_ml not needed for Global... in Makefile
(Hilde has changed names of files in BC_data also, to make consistent system).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Peter ,  Feb.  7th 2003, rv1.4.14  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ZD_ACID/My_Derived_ml: I forgot to define name and unit for D2_ACCSU. (Thanks Dave!)
Restarted daily netCDF output. Corrected small imperfection.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Peter ,  Feb.  7th 2003, rv1.4.13  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Removed daily netCDF output: too slow at present

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Peter ,  Feb.  7th 2003, rv1.4.12  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Output_binary: daily, monthly and yearly netCDF output
NetCDF_ml: more attributes
My_Derived: additional "Deriv" attributes
Met_ml: smoosp in tiphys, parallel smoosp

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxx
xxxxxxxxxxx Dave ,  Feb.  7th 2003, rv1.4.11  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Corrected Makefile - otherwise as rv1.4.10

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave ,  Feb.  6th 2003, rv1.4.10  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
STO_FLUX, unit_flux, lai_flux  lines added into DryDep, in preperation for
ecosystem modelling. Rsur(NO2) doubled - temporary soln until a better
way of allowing for 2-way NO2 fluxes is found (compensation points one
day, perhaps).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde,  Jan. 31st 2003, rv1.4.9  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Aqueous chemistry for SO2->SO4 ox. re-introduced. All BCs read from file are now 50*50km2.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave,  Jan. 27nd 2003, rv1.4.8  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

CEH-derived Rns used  in Rsurface_ml, and wetarea set in DryDep.
RH-based correction to Gns added

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave,  Jan. 24nd 2003, rv1.4.7  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Crude adjustment of BCs (+10 ppb ozone) added in Global_BCs, so that clean
air masses have same ozone as Mace Head.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave,  Jan. 22nd 2003, rv1.4.6  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

BUG-fix -- SAIadd was defined locally in UK_ml, so the SIAadd
from DepVariables never got set.  Fixed.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave,  Jan. 22nd 2003, rv1.4.5  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Added r_water from CEH/ Hilde's code for NH3 to Rsurface_ml.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave,  Jan. 21st 2003, rv1.4.4  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Changed Wesely_ml : increased H* for NH3

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave,  Jan. 21st 2003, rv1.4.3  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

New MonthlyFac and DailyFac introduced - pollutant specific.
(Changes in Timefactors_ml, grun.pl)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Peter , January 2003, rv1.4.2  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

1)DryDep_ml:
    use amk
    confac2x... /amk(KMAX_MID)
        ds-Bug created whewn xn_2d used instead of xn_adv (when put inside i,j loop ?)

2)NetCDF_ml: new module
3)Unimod.f90: call to netCDF_ml
4)Output_binary_ml: call to NetCDF_ml

3)GridValues_ml: added routine coordzero (used by NetCDF_ml)

4)ReadCDF_ml: not used by the model, but contains routines that can read the
    NetCDF output.

5)Makefile:
    LIBS x -lmpi -lnetcdf
    INCL x -I/home/u4/mifahik/netcdf/include
    LLIB x -L/home/u4/mifahik/netcdf/lib64


6)My_Derived: included /max(1E-80, (xn_adv(...))) in order to avoid division by zero for 0 concentrations.


7)./ZD_ACID/My_Derived_ml:      (was done in ZD_OZONE, but not in ZD_ACID)
     wdep( :,:,:,:) x 0.0
      ddep( :,:,:,:) x 0.0
      d_2d( :,:,:,:) x 0.0
      d_3d( :,:,:,:,:) x 0.0


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave, 14 Jan 2003  rv1.4.1  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Made Ox. rate SO2->SO4 same (argx4) in OZONE as in ACID

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde, Joffen, Peter, sub. Dave, 14 Jan 2003  rv1.4    xxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Corrected Logan's data. grun.pl refers to new location.
Timefactors_ml bug corrected  (Hilde had done this already, so rv1.3.1
                               was okay)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde   2nd Jan 2003  rv1.3.1   xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

From forum:
Reply #3 Posted at Thu Jan 2 13:41:23 2003    Revision 1.3.1
Drydep inside loop in Runchem.
Kz_min lifted one layer.
Budget error discovered by jej fixed.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde   2nd Jan 2003  rv1.3     xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

From forum:
  Reply #2 Posted at Thu Jan 2 12:47:55 2003
Last Modified at Thu Jan 2 13:17:58 2003 by David Simpson Revision rv1.3
New ammoium and nitrate indexes, eq models rewritten/added.

Indexes have been changed so that AMSU and AMNI do not exist anymore. Intead we have aNO3 (aerosol nitrae) and aNH4(aerosol ammonium). The Ammonium routine is rewritten to handle the new indexes. MARS and EQSAM can be run instead of Ammoniun by setting true/false in My_Aerosols_ml.
EQSAM is set as 'default'.



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  , Dec   2   2002, rv1.2.1  xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug found by Svetlana fixed, Setup_1d_ml now uses KEMISTOP, noit
KMAX_MID-3. ModelConstants_ml also fixed.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  , Nov   26  2002, rv1.2  xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Fixed (non-influencing?) bugs found by Hilde, Peter, in ZD_ACID version,
My_Chem_ml and  My_MassBalance_ml.


xxxxxxxxxxx Dave  , Nov   18  2002, xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug-fixes - pr_acc instead of pr in DryDep and Rsurface
            wasinword in Io_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  , Oct.  24  2002, emep1.2  xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Wrtchem changed to correct problems with daily binary output.
Small other changes.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  , Oct.  22  2002, emep1.2helcomU  xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Some small bug-changes compared to 1.2helcomF


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  , Sept. 27  2002, emep1.2helcomF  xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Version used for Helcom runs.
Added ij Hilde's stack table, but used NEMISLAYERS in EmisDef instead of
KEMISTOP in ModelConstants, to keep emission definitions in Emis files.
Added crude effect of wetness on RextS in Rsurface_ml.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  , Sept. 26  2002, emep1.2helcom2  xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Peter corrected Output_binary
Dave  corrected nadv  for ecosystem-specific dep.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  , Sept.  2002, emep1.2beta2 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

0) Started this Log.changes file. Please add your changes here as appropriate.
  Of course, now the code is under CVS control, differences between releases
  can be easily obtained, but a simple Log file is also helpful.

1) Merged Peter's, Hilde's and my changes in emep1.2beta2, plus

  EmisDef_ml- ANTROP_SECTORS added
  EmisGet_ml- ANTROP_SECTORS added

2) Fixed bugs listed on forum
  Derived_ml - fixed timefrac

3) Re-coded DryDep model to work for ACID

4) ACID version update and tested

5) Merged inpar, in_isnowc and (commented out SetZ0) into MetModel_LandUSe
   in Met_ml. The idea is to keep all HIRLAM/mm5 met data in the same place

6) Moved V_RAIn to ModelCOnstants. Put DEBUG_i, DEBUG_j into ModelConstants -
   used to specifiy which grid square print-outs are wanted for.

7) Setup_1d_ml.f90 - max(1,izen) added
                - In trotrep version xn_shl was reset
  to xn_2d. In emep1.2beta this wasn't done. The 2beta
  version is therefore faster, but this reset allows
  stats such as max_oh to be calculated. Therefore trotrep
  version adopted.

8) Ecosystem-specific deposition added for OXN over seas and forests, for
   Jurek's HELCOM request.

9) INTERACTIVE option added to grun.pl - useful when preparing code for
    running with totalview.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Peter , summer 2002  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1)Added a test in ReadField_ml, to see if we use the
 EMEP map. If not the field is transformed into the current map.

2)Included routines ij2lb, lb2ij and ij2ij in GridValues_ml.

3)Moved routine inpar and array iclass from GridValues to DryDep

4)Moved  "call inpar" from GridValues to Unimod.f90

5)inpar: explicit loop instead of (:)

6)Commented out routine and call SetZ0 (never used)

7)Changed formula for precipitations (pr) when not found (MM5 case),
  defined V_RAIN in PhysicalConstants_ml

8)Changed 2 last decimals of PI in PhysicalConstants_ml

9)Dates_ml: add_dates_s : Allow to add 3600 seconds (before 3599 was
  largest allowed).

10)Print max Courant number in Advection_ml

11)(Changed by Hilde) Loop for skh in Met_ml kx2,KMAX (instead of kx1,KMAX), and z_mid(i,j,k-1)

12)Tabulations : use T0 from PhysicalConstants

13)Rsurface.f90 :(Changed by Dave) /D_i instead of /diffc

14)grun.pl Included an if test in loop for meteo files

15)included a DEBUG compiler option in Makefile

16)commented out a declaration (amax,amin)

17)Commented out call to smoosp. The routine is not well parallelized.

18)replaced izen x int ( zen(i,j) + 0.5 ) by  izen x max(1,int ( zen(i,j) + 0.5 )) in Setup_1d_ml

19)Jej: My_derived_ml commented out O3x ... !/ (roa ...)

20)Corrected a small bug in advvk in Advection_ml

21)Removed an amax1(.,.) in tiphys (Met_ml)

22)Include  -TARG:exc_minxOZV as compiler option. This will stop the execution if
   wrong operations are done (such as 0/0 , NaN ).
