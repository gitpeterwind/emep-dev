
IMPORTANT NOTE:

  * Instructions to run *
    check out clean version of Unimod (safest as there are several new files)
    edit mk.GenChem, set "run" to  EmChem09 as standard, can be Eucaari_Trends
    mk.GenChem
    cp ZD_OZONE/My* .
  [option: if Eucaari_Trends, do also:
    cp ZD_VBS/My* .          # gets MySOA_ml and My_Derived including SOA
  ]
    make clean
    make
    edit run.pl for year, Chem etc.

SOIL NOx ISSUES - Mainly think about (1) for policy

This versions works for European soil-NO emissions, but work still
needed on a few issues for e.g. global usage, or NH3

    (1) Soil-NO needs maps of annual N-deposition. Temporary 1-year average
        set now. Need to make proper system, e.g. with 5-year avg.
        Also need to consider "trends" for future scenarios

        Currently map is in hard-coded mifads directory. Will move to mifapw
        when procedure files.

    (2) Can now have either the hourly calculations or the monthly
        global fields. Ideal is probably hourly for Europe and
        monthly outside.

    (3) Not sure the global soil works, since now rcbio is used
        check

    (4) NH3 should be in reactions too?

KNOWN PROBLEMS

Some jobs needed after Mar-11th tests (ds will do)
  - Decide SoilMoisture
  - SoilWater - should implement readneightbour routine

None?
I (DS) have re-writting My_Derived and Derived to use the array
OutputConcs.  This harmonises 2d and 3d, ppb, ug, ugN, etc., and
has either simple species or groups.  No problems known, but this
re-write will continue, and should be harmonised with the hourly
outputs in some way (at some stage).


IMPORTANT NOTE:

The latest code does now CM_Emis.inc in CVS. This is generated from
mk.GenChem, which reads the emissions needed from GenIn.reactions.

Run mk.GenChem!!!!

NOTE: Now all all CM_ files are removed from the cvs system. You have to
run GenChem!!!

Also - GenChem makes femis.defaults in the ZCM_... directory

CLEAN-UP: all code should be checked to remove old comments before
the public release. Ideally compile code on PC with gfortran's
pedantic debug switches (see Makefile_gfortran) - gives loads of
info on unused variables, etc.
Will keep list here near top of Log.changes.

!----------------------------------------------------------
Files and cleanup status.

-- indicates in-progress, otherwise mark done.
!----------------------------------------------------------

st pw     Advection_ml.f90
st done   Aero_Vds_ml.f90
st done   Aero_water_ml.f90
an done   AirEmis_ml.f90 - can delete aircraft_nox subroutine !
                          (& rename as Lightning_ml) NOT DONE!!!
ds done   Ammonium_ml.f90
st done   AOD_PM_ml.f90
ds done   AOTnPOD_ml.f90
jej done  Aqueous_n_WetDep_ml.f90
ds done   Biogenics_ml.f90
mg done   BLPhysics_ml.f90
av done   BoundaryConditions_ml.f90
ds done   CellMet_ml.f90
ds done   CheckStop_ml.f90
ds done   ChemFunctions_ml.f90
          Chem_ml.f90
ds done   CoDep_ml.f90
jej done  Convection_ml.f90
an done   Country_ml.f90
jej done  DefPhotolysis_ml.f90
an done   DerivedFields_ml.f90
ds avdone Derived_ml.f90
          DO3SE_ml.f90
ds done   DryDep_ml.f90
          DustProd_ml.f90
mg done   EcoSystem_ml.f90
an done   EmisDef_ml.f90
an done   EmisGet_ml.f90
an done   Emissions_ml.f90
st done   EQSAM_ml.f90
st done   ForestFire_ml.f90
ab done   Functions_ml.f90
jej done  global2local.f90
av done   GlobalBCs_ml.f90
mg done   GridAllocate_ml.f90
mg done   GridValues_ml.f90
pw done   InterpolationRoutines_ml.f90
st done   Io_ml.f90
st done   Io_Nums_ml.f90
av done   Io_Progs_ml.f90
mg done   KeyValue_ml.f90
ds done   LandDefs_ml.f90
ds done   LandPFT_ml.f90
mg done   Landuse_ml.f90
jej done  local2global.f90
av done   LocalVariables_ml.f90
st done   MARS_ml.f90
pw done   MassBudget_ml.f90
ab done   MetFields_ml.f90
pw done   Met_ml.f90
ds done   MicroMet_ml.f90
pw done   ModelConstants_ml.f90   st changes (see below)
jej done  MosaicOutputs_ml.f90
av done   Nest_ml.f90
pw done   NetCDF_ml.f90
mg done   NH3Emis_variation_ml.f90 - ds moved to FUTURE_NH3Emis_variation_ml.f90
mg done   NH3variables_ml.f90 - ds  moved to FUTURE_NH3variables_ml.f90
jej done  OutputChem_ml.f90
av done   Output_hourly.f90
ds done   OwnDataTypes_ml.f90
pw done   Par_ml.f90 - ab deleted i,j not used
pw done   PhyChem_ml.f90
ab done   PhysicalConstants_ml.f90
jej done  Radiation_ml.f90
ds done   Rb_ml.f90
an done   ReadField_ml.f90
ds done   Rsurface_ml.f90
an done   Runchem_ml.f90
st ds done   SeaSalt_ml.f90      - finel small shanges are possible today
ab done   Setup_1dfields_ml.f90
ds done   Setup_1d_ml.f90
mg done   Sites_ml.f90
ab done   SmallUtils_ml.f90
ds done   SoilWater_ml.f90
ds done   Solver.f90       - st small changes (see below)
ds done   StoFlux_ml.f90
ds done   SubMet_ml.f90
jej done  Tabulations_ml.f90
av done   TimeDate_ml.f90
an done   Timefactors_ml.f90
jej done  Timing_ml.f90
ds moved   Tmp_Met_ml.f90  - ds moved to FUTURE_Tmp_Met_ml.f90
ab done   Trajectory_ml.f90
av/ds done Unimod.f90
av done   Volcanos_ml.f90
pw done   Wesely_ml.f90

ZD_OZONE/

ds done   My_Aerosols_ml.f90     - st small changes (see below)
ds done   My_Derived_ml.f90
ds done   My_Outputs_ml.f90
ds done   My_SOA_ml.f90

xxxxxxxx rv3_10_17 Peter 9th Feb  2012  xxxxxxxxxxxxxxxxxxxxxxx

Removed huges arrays from BoundaryConditions_ml. They were not necessary and made the code explode for large grids.
Later the BC routines should be merged with Nest_ml; this is not finished yet, but has to wait.

Should be faster too.

Pollen_ml.f90 - The heatsum is calculated every metstep, and the birch forest is reduced from 60 degrees north. Birthe

xxxxxxxx rv3_10_16 Peter 9th Feb  2012  xxxxxxxxxxxxxxxxxxxxxxx

The landuse must be defined before the metread (it was not).
Moved SetLandUse() before the met calls.

Moved call to InitLanduse() into SetLandUse()

Default value of nwp_sea(i,j) is set in InitLanduse, and overwritten by MetModel_LandUse if found.

Corrected a bug introduced in rv3_10_15 in RunChem (limax->li1)

The changes in rv3_10_15/16 will also change results, because it was wrong before:
If the landuse etc. are not defined in the outer frame, some routines (smoosp, extendarea) will use wrong data.
(The largest change are in the first day)

Modified:
Landuse_ml.f90
Met_ml.f90
Runchem_ml.f90 
Unimod.f90

xxxxxxxx rv3_10_15 Peter 6th Feb  2012  xxxxxxxxxxxxxxxxxxxxxxx

Many changes in loops: replaced almost all "li0,li1" into "1,limax".
The idea is that we always compute for the whole domain, the exceptions are that we don't want do update the concentrations in xn_adv (and possibly in budgets).
Some small differences very close to the boundaries, I think they may come from the "landify"

moved everything which was in the "my_first_call" in SetLandUse, over to the InitLanduse subroutine. It seems more logical, and was necessary to get before the BC update.
(where landsea_nwp must be set for SeaSalt). 
This also changed other concentrations I noticed: because "landify" uses "likely_coastal" which was not yet set before the first call to metdata.

Also commented out the link to rough.dat in run.pl: don't use it by default, as it is probably wrong anyway: it was wrong in EECCA, and is not defined for IFS anyway.

List of modules modified:
run.pl
Landuse_ml.f90 .
Met_ml.f90 .
Runchem_ml.f90 .
Volcanos_ml.f90 .
FUTURE_NH3Emis_variation_ml.f90 .
ForestFire_ml.f90 .
Emissions_ml.f90 .
Biogenics_ml.f90 .
DryDep_ml.f90 .
Io_Progs_ml.f90 .


xxxxxxxx rv3_10_14 Dave 6th Feb  2012  xxxxxxxxxxxxxxxxxxxxxxx

mk.GenChem   - simplified:
               added an array extras=( SeaSalt Dust Pollen )
               which can be used by all other schemes.
              (Also, Pollen isn't yet a default species, and
               none of these needed in SR runs for example. Now
               easily skipped using mk.GenChem)

Pollen_ml    - removed hard-coded Pollen_b, used ipoll and find_index
                 instead.

ZCM_CRI_v2_R5   - emissplit files added, from rv3_9_34chem_cri. Probably
need to edit the PM ones, but just added for now.

ZCM_EmChem09/GenIn.species removed --- they haven't been used for
   ages as mk.GenChem creates them

ZCM_EmChem09/GenIn.reactions removed --- they haven't been used for
   ages as mk.GenChem creates them

xxxxxxxx rv3_10_13  Svetlana 3rd Feb  2012  xxxxxxxxxxxxxxxxxxxxxxx

Bug for sea salt BICs in BoundaryConditions_ml.f90 corrected
(BIC is switched off when USE_SEASALT=false)                  

xxxxxxxx rv3_10_12  Svetlana 2nd Feb  2012  xxxxxxxxxxxxxxxxxxxxxxx
                  &  Peter 

ST: Addition to EC ageing   - modified My_Derived_ml.f90

PW:
Modified the formula in  ReadField_CDF (rv3_10_11), as it was not safe.
(worked OK on Stallo, but not on Gardar).
i=i_local(nint(ir)) -> i=nint(ir)-gi0-IRUNBEG+2

xxxxxxxx rv3_10_11  Peter 1st Feb  2012  xxxxxxxxxxxxxxxxxxxxxxx
                  + Svetlana 31th Jan  2012 

Bug in ReadField_CDF when converting from stereographic to lat lon.
Occurs only if you run in a rundomain which is smaller than fulldomain.
The BVOC will be wrong in this case.
bug introduced in rv3_10_5.


** EC ageing included:    EC_F_FFUEL_NEW   EC_F_FFUEL_AGE .....
ZCM_EmChem09soa/VBS_nonvolatile.species
ZCM_EmChem09soa/VBS_emissions_nonvolatilePOA_FromPM25.reactions

Aqueous_n_WetDep_ml.f90 - in-cloud scavenging for new EC is put to 5%

xxxxxxxx rv3_10_10  Birthe, David 20th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

*NEW* Pollen_ml introduced for calculating birch pollen emission
      Calculates pollen emission based on a code by Sofiev et al. (in prep)
** but ** Experimental! Needs to accumulate heat, so cannot start in eg May.
          Will likely use externally calculated heat-sums in future.

-Introduces a new species, pollen_b (birch pollen) in EmChem09
- Aero_Vds_ml.f90 - added pollen properties for diam, sigma and PMdens
- Aqueous_n_WetDep_ml.f90 -added a new wetdeposition CWDEP_POLLw
- Derived_ml.f90 - added output, and an output for pollen emission AreaPOLL.
- ModelConstants_ml.f90 - added USE_POLLEN and DEBUG_POLLEN
- MosaicOutputs_ml.f90 - added molweight of pollen
- Runchem_ml.f90 - calls for Pollen_ml
- Wesely_ml.f90 - added one dry aerosol, CDDEP_POLLd and AERO_SIZE
- My_Aerosols_ml.f90 - add NSIZE by 1 to NSIZE=5
- My_Derived_ml.f90 - added wetdep, drydep and SURF_ug_POLLEN_B
- mk.GenChem Pollen added to EmChem09



xxxxxxxx rv3_10_9  Peter, 20th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

Output_hourly.f90
Close the netcdf_hourly file after each hour.
Not closing seems to give a segmentation fault when opening the daily file
Probably due to a bug in the netcdf4/hdf5 library.

xxxxxxxx rv3_10_8  Robert, 19th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

Simplified EmChem09soa scheme. 
   Removed many unused species and changed some component names. 
   Reduced the level of detail for the stored ASOA and BSOA species; 
   now only keep track of ASOA and BSOA (and not subgroups of these) 
   [further reduction is possible to only store SOA (=ASOA+BSOA)]. 
 
The updated code should give close to identical results to the earlier version but note that to use the "research" version of the VBS-SOA scheme some editing of ZD_VBS/My_SOA_ml.f90 is necessary.

The new code is significantly faster than the old one (almost 20% in the first tests).

Updated files: mk.GenChem
               ZD_VBS/My_SOA_ml.f90
               ZD_OZONE/My_Derived_ml.f90
               ZCM_vbs_tests/VBS_partitioning.species
                             VBS_help.species
                             VBS_SOAageing.reactions
                             VBS_SOAformation.reactions
                             VBS_ASOAageing.reactions                          
               ZCM_EmChem09soa/VBS_nonvolatile.species
                               VBS_emissions_nonvolatilePOA_FromPM25.reactions
New files:     ZCM_vbs_tests/VBS_SOAageing_Detailed.reactions
                             VBS_SOAformation_Detailed.reactions
                             VBS_help_Detailed.species
                             VBS_partitioning_Detailed.species
  

xxxxxxxx rv3_10_7  Dave, 19th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx


Start of modified system for nesting external boundary and initial conditions.
Needed because we want to avoid chemistry-specific  (eg EmChem09) indices
in the main code, and to make it explicit to users that the BIC mapping
is very dependent on chem scheme and external data.

Nest_ml
          "chemistry"-dependent bits removed, functionality now
          through new files given below. Code much shorter
          since species mapping moved to external files, and
          some repetition of the same procedures unified.
          Now only needs NSPEC_ADV from GenSpecs_adv_ml.
          "print" changed to write.
          Prefix "Nest:" added to many write-outs, to make it easier to
          search log files.

Makefile.SRCS - add My_ExternalBICs_ml.f90

*** New: 

File: ZD_OZONE/My_ExternalBICs_ml.f90  - a do-nothing file  for the usual case
        where the model uses the standard BICs. Copied along with other My* files

Directory: ZD_EXTRA
File: MOZART_EmChem09_ExternalBICs_ml.f90
File: README.txt - explains usage

The MOZART file is intended as a starter, but includes I think the same
functionality as the code in the previous Nest_ml. *NOT TESTED* except
for compilation (as ds has never used Nest_ml, and hence has nothing to
test with). If more complication is desired, then this can be done
within this module I hope, simply "use"-ing other modules to grab'
any needed information (such as date).


To-Do: *test* and update MOZART .f90
       * clean-up* Nest_ml, much code now commented out
        Should also make files for RCA, HTAP as appropriate. These will also
        be put in ZD_EXTRA

xxxxxxxx rv3_10_6b  Robert 18th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

Robert: Minor update of SOA aging reactions in "research-version" of VBS-SOA model version PAPA. 
        Updated file: ZCM_vbs_tests/VBS_ASOAageing.reactions [Now identical to the version used in the EMEP-VBS paper submitted to ACPD] 

        Note: Some other files may still not be updated. Will be fixed soon.

xxxxxxxx rv3_10_6  Dave, Peter 18th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

Peter - added Emissions_ml from _5 commit

Dave: Started to add CB05 chemistry, but maybe only partial commit. Will
continue

mk.GenChem - cb05 possible. No SOA though.

ZCM_CB05 files



xxxxxxxx rv3_10_5   Peter 16th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

New routine for direct interpolation from polar stereographic projection
Now zeroth-order interpolation needs Undef to be defined, or all values must be well defined.
This will slightly change the results. 
In the future the file from MaxPosch+GLC2000 can be used for Landuse. GLC2000 input still needs some improvements(?).

Modified:
NetCDF_ml
GridValuse_ml
Landuse_ml.f90
Biogenics_ml
Emissions_ml
run.pl

File annualNdep.nc temporarily copied to $DataDir as annualNdep_tmp.nc.

Met:ml: timeunit(1:19)

xxxxxxxx rv3_10_4  Dave 13th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxxxx

run.pl - uses LAndInputs_Jan2012
          Higher (20m) trees and some small changes in land-defs
          Will change results a bit, by increasing deposition


xxxxxxxx rv3_10_3   Peter 10th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

NetCDF_ml.f90:
Netcdf output file in compressed netcdf-4 format. 
For postprocessing, if you get error messages, make sure you use libraries linked to netcdf-4 
(for example by writing module load netcdf, module load nco).


Landuse_ml.f90:
Started to include new landuse reading (experimental so far, not default).


xxxxxxxx rv3_10_2   Peter 6th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

Nest_ml with MODE=100 option. Use monthly BC. Experimental so far.to be merged with Global_BC_ml

made great_circle_distance in InterpolationRoutines_ml private, as it is already defined in Functions_ml 


!
xxxxxxxx rv3_10_1   Peter 4th Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

Small bug in extendarea (Met_ml):
   iif=limax and    jjf=ljmax (instead of using size, which gives maxlimax)

Small effet on results, but can give sightly different results for different number of CPUs

fac_min was defined only for MasterProc (in Timefactors_ml). Redefined it after the broadcast in Emission_ml.
Slightly different definition, since now defined after renormalization.
Relatively small differences in results since this is only used for sector 2.

Finally same results on a 2 days test with 8x4 and 2x16 processor partition

xxxxxxxx rv3_10   Dave 3rd Jan  2012  xxxxxxxxxxxxxxxxxxxxxxx

new label, since 37 seemed a bit high, and since rv3:9_36 was anyway
a result-change from other rv3_9_xx series. Another result 
change here:

ChemFunctions_ml.f90 - now uses aerosol radius in VOLFACs 
consistent with that used in dry-deposition, namely number
median radius 68nm instead of 34.

xxxxxxxx rv3_9_36 Dave 31st Dec 2011  xxxxxxxxxxxxxxxxxxxxxxx

Various "bug-fixes" (or doing things as intended)

Biogenics_ml
  Added temperature variation to soil-NO  from crops

ModelConstants_ml
 Set NO_CROPNH3DEP true

SubMet_ml
 Set z0 = min( z0, 1.0) instead of 0.5


run.pl
  uses LandInputs_Dec2011   - higher trees
 


xxxxxxxx rv3_9_35 Alvaro, Dave 21th Dec 2011  xxxxxxxxxxxxxxxxxxxxxxx

Alvaro, 21st Dec:
Output_hourly.f90:
Wrong PM water content on multi-level hourly output.
This bug was introduced on rv3_7beta7, fixed on rv3_9_22,
and re-introduced in rv3_9_23. It is specially relevant on FORECAST mode.

Dave, 20th Dec.
Bug-fix, but luckily they cancelled out
The 1st bug was that L%is_crop wasn't set
The 2nd bug was that L%is_crop was used for all gases, not just NH3

the net effect was that the intended setting of Rsur to high values for
NH3 over crops never happened.

Submited fix now sets NO

  ModelConstants_ml:
   NO_CROPNH3DEP      = .false.   - set false now to keep same results

   Rsurface_ml - NO_CROPNH3DEP only aplied for NH3

   SubMet_ml - set L%is_crop

xxxxxxxx rv3_9_34 Dave/Peter 19th Dec 2011  xxxxxxxxxxxxxxxxxxxxxxx

Peter:

   ReadTime: include the proleptic_gregorian calendar

   Nest_ml: for 3D IC files with different vertical levels was wrong.
	replaced
	forall (k=1:KMAX_ext, j=1:ljmax, i=1:limax)
    with
	forall (k=1:KMAX_MID, j=1:ljmax, i=1:limax)

Dave:

  run.pl - Modrun11 set as default.

  ForestFires_ml - only print to RunLog in first call

  ZCM_CRI_v2_R5
     commnted out APIN in RCBIO
     added soil NO

xxxxxxxx rv3_9_33   Dave       16th Dec 2011  xxxxxxxxxxxxxxxxxxxxxxx

BUG-fix ... for years prior to 2008 (EECCA) the deep soil water
was incorrectly set when the data weren't found. Now defaults
to fSW = 1.0 if no data found, and prints warning to RunLog.

xxxxxxxx rv3_9_32   Dave       15th Dec 2011  xxxxxxxxxxxxxxxxxxxxxxx

Output_hourly.f90 - bug fix, but results don't change for normal usage
   (showed up with DEBUG_OUT_HOUR true, debug in Makefile)

ZD_OZONE/My_Derived_ml - added SoilNO emissions
ZD_OZONE/My_Outputs_ml - added SoilNO emissions

xxxxxxxx rv3_9_31   Svetlana           14th Dec, retag 15th 2011  xxxxxxxxxxxxxxxxxxxxxxx

Natural dust is split to WB (windblown) and SAH (Saharan):
DustProd_ml.f90, My_Derived_ml.f90
ZCM_EmChem09/Dust.species and Dust.reactions,
SAFE.CM_BoundaryConditions.inc in ZCM_EmChem09 and ZCM_EmChem09soa

xxxxxxxx rv3_9_30   Robert             14th Dec 2011  xxxxxxxxxxxxxxxxxxxxxxx

Bug-fix   ZD_VBS/My_SOA_ml.f90 - Factor of 12 too low OM-concentrations stored in netcdf-files for
                                 FFIREOA25_OM, WOODOA25_OM and FFUELOA25_OM in earlier versions (only affects
                                 stored "help" species, that is no change in the "real" model species)

xxxxxxxx rv3_9_29   Peter               7th Dec 2011  xxxxxxxxxxxxxxxxxxxxxxx

+ (Dave, 11th Dec)
rtagged

** Also **  8th Dec 2011, Met files were corrected for ice and snow in EECCA and GLOBAL were corrected. Results will change.

Bug in Convection_ml. BC where modified by the routine. No effect for global runs, becase they don't have BC.


xxxxxxxx rv3_9_28   Dave/Robert               30th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

Bug-fix   some POC_ components that were a part of PART_OM_F were  included  also
included  in PMFINE, resulting in some double count.

Fixed in ZCM_EmChem09soa files

Also, "WOOD" EC, OC emissions removed in ZCM_EmChem09soa/EMISSPLIT files since they
were basically fake. Better zero than low values that will one day confuse somebody.


Met_ml DEBUG_Kz added, but we have print again. Why? This was changed below?

Timefactors_ml - debug cleanup

mk.GenChem - defaulted to EmChem09soa (but users should check!
)

PMFINE label removed from:
ZCM_EmChem09soa/VBS_nonvolatil

WOOD removed from
ZCM_EmChem09soa/EMISSPLIT/emissplit.defaults.pm25
ZCM_EmChem09soa/EMISSPLIT/emissplit.defaults.pmco

My_Derived_ml - commented out WOOD outputs (to precent future
  confusion. All organics are now called FFUEL, which is also
  confusing, but zero wood should give a hint.)



xxxxxxxx rv3_9_27c  Dave                      29th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx


Added ZCM_CRI_v2_R5 for those wanting something a bit heavier :-)

    (Chemistry is about 3 times larger than EmChem09.)


xxxxxxxx rv3_9_27b  Robert                    29th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

My_Derived_ml.f90 - Removed some non-used species corrected the names of some OA-group components

xxxxxxxx rv3_9_27 Svetlana, Dave              29th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

ST:
Dust outputs in My_Derived_ml.f90
(SURF_ug_) DUST_NAT_F, DUST_NAT_C, and DUST

DS:
Met_ml - prints changed to write in Met_ml (these were already write in rv3_9_20
 - some reversal of code?). Some more use of DEBUG_Kz

Timefactors - also just tidy up of print/write


xxxxxxxx rv3_9_26hdd      Dave     28th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

*** Needs pre-processed file with daily DegreeDays. Currently
     in mifads directory for 2009. Easy to generate -  run
    ~mifads/bin/DegreeDayFac  to see usage
    (code in /Work/EMEP_Projects/DegreeDay/DegreeDayFac.f90)

Added option to use degree-days to calculate emission variation.

 EmisDef_ml - add ISNAP_DOM  =  2

 Emissions_ml - uses Gridded_SNAP2_Factors. DegreeDayFactors etc.

 ForestFire_ml - reduced outputs except on debug

 Met_ml make Getmeteofield public

 ModelConstants_ml - USE_DEGREEDAY_FACTORS

 Timefactors -  uses Gridded_SNAP2_Factors. DegreeDayFactors etc.

 run.pl - link to DegreeDayFac-${GRID}-$yy


xxxxxxxx rv3_9_26  Svetlana, Dave, Robert      28th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

Robert:
ForestFire_ml.f90 - Updated the reading of FINN emissions (interpol='mass_conservative'
                    instead of 'conservative', should give correct scaling factor)
                    Changed assumed OM/OC ratio from 1.3 to 1.7 for FFIRE POA
                    Started updating the GFED handling (but probably still not working properly!!!)

ZCM_EmChem09soa/BiomassBurning_FINNv1_to_EmChem09soa.inc - Changed OM/OC ratio to 1.7 for FFIRE emissions
                BiomassBurning_GFED_to_EmChem09soa.inc - Updated OM/OC ratio and some other parameters
                VBS_nonvolatile.species - Introducing new groups NVFFUELOC10

ZD_VBS/My_SOA_ml.f90 - Introduced split of NVFFUELOC into NVFFUELOC25 and NVFFUELOC10,
                       updated storing to handle both partitioning and nonvolatile POA
                       in a similar way [NOTE some hardcoding of OM/OC ratios!!!
                       Assumes OM/OC=1.25 for FFUEL POA and 1.7 for WOOD POA and FFIRE POA]

ZCM_vbs_tests/VBS_help.species & VBS_nonvolatile.species - Added the number 25 to some
                       group names (to indicate that they are in PM2.5)
                       added NONVOL_FFUELOC10 (as well as NONVOL_FFUELOC25)
              VBS_partitioning.species - Added the number 25 to some group names

Svetlana:

PM water calculations by MARS (instead of EQSAM): 3D for ambient conditions
and surface 2D for at Rh=50% (for comparison with obs):
Runchem_ml.f90 and My_Aerosol_ml.f90

Windblown dust is calculated now: DustProd_ml.f90 (also EmisDef_ml.f90, Solver.f90,
ModelConstants_ml.f90, mk.Genchem;  in ZCM_EmChem09: Dust.species, Dust.Reactions)

Introduces dry deposition velocities for coarse sea salt and dust: SSc and DUc
(Wesely_ml.f90, Aero_Vd_ml.f90, ZCM_EmChem09/SeaSalt.species)

Dave:

Riemer rate set back to original following riemer2 testing


xxxxxxxx rv3_9_25  Peter                       28th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

Changed DustProd_ml.f90 to use IFS threshold. Uses IFS soilmap and parameters.
Started to add Soil Moisture Index in Met_ml.f90 for deep soil water from IFS.
Switched on swich for Soilwater and Dust in ModelConstants_ml
changes also in MetFields_ml.f90,Met_ml.f90
SoilTypes_IFS.nc in run.pl

Birthe: Added output in Output_hourly.f90 for Phillipe runs. Should be commented
out when  done with these runs. Also changed from print to write, and rearranged
Debug for a DEBUG_OUT_HOUR in ModelConstants.f90


xxxxxxxx rv3_9_24  Dave                       27th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx


  ForestFire_ml ***  BUG FIX  ****

     A units conversion (e.g. 0.028 for CO) was applied twice, leading to far too
     low forest-fire emissions

  Derived_ml - AddDeriv for ws_10m  commented out, moved to My_Derived
               rh2m added

  Io_Progs_ml - added another datewrite to print up to 5 ints, then array of reals

  ModelConstants_ml. Small tidy up - alphabetical DEBUGs

   My_Derived - ws_10m and rh2m added here. RN222 and RNWATER commented out.

   My_Outputs - added ws_10m and rh2m for sites output.

xxxxxxxx rv3_9_23   Birthe/Dave               25th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

   Output_hourly and ZD_OZONE/My_Derivbed(?) changed, for sending
   test files to Phlippe. Does ws_10 need to be added?

   safety test - added SOA_MODULE_FLAG="VBS" in ZD_VBS/My_SOA_ml
     and = "NotUsed" in ZD_OZONE/My_SOA_ml.

   - should stop code if attempt is made to run VBS with OZONE My_SOA

   outputs adjusted for forest-fire associated OM and other
   NONVOL outputs (spotted by RObert)

xxxxxxxx rv3_9_22     Svetlana & Alvaro       24th Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

Runchem_ml.f90:
PM25_water_rh50 will be calculated every time step and averaged
(was calculated at the end of a day - do not remember why)

Output_hourly.f90:
Wrong PM water content on multi-level hourly output.
This bug was introduced on rv3_7beta7. It is specially relevant on FORECAST mode.

The PMwater hourly output type (introduced on rv3_6_1) should
output PM water content at model mid-levels (PM25_water). Instead it outputted
surface values (PM25_water_rh50) which were updated only once a day at END_OF_EMEPDAY
(Aero_water call on runchem).

Now, by default PMwater outputs PM25_water for model mid-levels.
If SELECT_LEVELS_HOURLY (My_Outputs_ml, used in FORECAST mode)
PMwater outputs PM25_water_rh50 for surface level and PM25_water form model mid-levels.
The new hourly output type PMwaterSRF will provide PM25_water_rh50 regardless
of the level selected.


SeaSalt_ml
   - reduced assumed salt and hence emissions over Baltic sea


xxxxxxxx rv3_9_21         Dave     23d Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx


EMISPSLIT - new emissplit.specials.pm25 and defaults.pmco

The pmco is kept simple, and no attempt is made to produce a specials
file for that.

The pm25 is calculated from IIASA's EC, OC - as sent earlier
to Agnes/Svetlana. I have used OM=1.25*OC (which is consistent
with the SOA scheme assumption that POM is CH3-like. When this
exceeds 99%, I rescale (at least 1% other is then enforced.) See
~mifads/D_Emis/EmisSplitNov2010/PM_EMISSPLITS_RESCALING/mkp.EmisSplit

The effect should be to increase SOA a little, since OA condensation
is proportional to the avaialble mass of OM.

My_Derived_ml - set some OM outputs to monthly (M) instead if
   daily, to reduce file size

ModelConsants
    USE_DUST set .false.
    comments to discourage use of Ln95, SOILNH3

ZCM_EmChem09, ZCM_EmChem09soa:
      SEASALT_G removed from SAFE_CM.Boundar..


xxxxxxxx rv3_9_20ss       Svetlana 23d Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

Sea salt is back to 2-size fractions representation, fine and coarse.
In Aero_Vd_ml: fine MMD is the same for as for all aerosols,
introduced coarse MMD = 4um for sea salt (dry dep. as SSc in SeaSalt.species)
Annual mean bias is 2% for 2009 (-12% to 14% seasonally)

xxxxxxxx rv3_9_20landify  Dave 21st Nov 2011  xxxxxxxxxxxxxxxxxxxxxxx

ModelConstants_ml, Met_ml.f90 - "landify"

  if LANDIFY_MET = .false. , no change
  if LANDIFY_MET = .true. ,  then meteorology for coastal sites (where
   NWP_sea is true, but land exists) is created from neighboring
   land grid-squares.  Improves model performance for some coastal
   sites a lot with PARLAM met. Seems to have less effect for IFS
   but checking continues.


mk.GenChem - ammended with if-test for $run. Saves having to
  uncomment spcs and rcns each time.

My_Derived_ml
   - now copes with missing groups
   ***  removed from ZD_VBS ****  (SOA groups can be kept in the
    ZD_OZONE versions anyway now.)

EmisGet_ml - more helpful error message for EmisSplit

run.pl - lines for 2009 added

SubMet_ml - use of LANDIFY

xxxxxxxx rv3_9_20soa, Dave  20th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

Main changes:

1) SOA ZCM_EmChem09soa directory added. Use when VBS wanted for policy runs

2) Stopped dry-dep of NH3 over growing crops

3) Also,Vds(N) = 3*vds(S), not 2

4) Derived and My_Derived. Started process to simplify, but needs
   more work. For now....

4a) ZD_VBS/My_Derived and ZD_OZONE/My_Derived now identical. Will merge
into one soon.  Note that now it is okay to ask for things that will
not be found, so we can ask for SOA, but will only get it if present.

mk.GenChem modified for above directory

GenChem.pl now allows emission names of lengt 30, not 12

EmisGet - removed need for emissplit.specials.voc if FOREST_FIRES used

Rsurface_ml - very high Rsur for NH3 over crops (when LAI > 0.1)

Biogenics_ml - commented out some USE_SOILNH3 lines.

ISSUES? Just check Weidinm. for OMbb assumption,also ACET?

xxxxxxxx rv3_9_20ff, Dave  20th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

ForestFires_ml -

  .... continued work with the  new forest-fires routine

 --  re-arranged to avoid older use of snapemis and to
 just work directly with rcemis.

New include files:

 ZCM_EmChem09/BiomassBuring_FINNv1_toEmChem09
 ZCM_EmChem09/BiomassBuring_FINNv1_toEmChem09

 ... which mk.GenChem copies to CM_BBtoEmChem09.

mk.GenChem - copies BiomassBurning files as noted above

ZD_OZONE/My_Derived_ml -added PPM25_FIRE

xxxxxxxx rv3_9_20, Dave  20th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

Soil NO emissions added  (working version for EECCA/EMEP)

Soil NH3 "placeholder" emissions added. Do not use!!!!
      (but arrays exist in case anybody wants to experiment)


SOIL NOx ISSUES -

This versions works for European soil-NO emissions, but work still
needed on a few issues for e.g. global usage, or NH3

    (1) Soil-NO needs maps of annual N-deposition. Temporary 1-year average
        set now. Need to make proper system, e.g. with 5-year avg.
        Also need to consider "trends" for future scenarios

        Currently map is in hard-coded mifads directory. Will move to mifapw
        when procedure files.

    (2) Can now have either the hourly calculations or the monthly
        global fields. Ideal is probably hourly for Europe and
        monthly outside.

    (3) Not sure the global soil works, since now rcbio is used
        check

    (4) NH3 should be in reactions too?


Biogenic_ml -  soil emissions added here

Derived_ml - has USE_SOILNOX, USE_SOILNH3 etc.

Emissions_ml - Reads map of Annual N-deposition, or if USE_GLOBAL_SOILNOX
      reads global soil NO as before. (Will move all to Biogenics in
      another step.)

PhyChem_ml  added call Set_SoilNOx(I)
RunChem_ml - added rcbio, BIO_SOILNO
Setup_1d_ml - sets rcemis for soils only if USE_GLOBAL_SOILNOX
    (was if USE_SOILNOX)
Solver_ml - BIO_SOILNO

ZCM_EmChem09/EmChem09base.reactions - added rcbio(BIO_SOILNO,k)
ZD_OZONE/My_Derived_ml - added Emis_mgm2_SoilNNNN possibilities

Misc:

  Dust_ml - printout testing of dry_period

xxxxxxxx rv3_9_19, Peter 17th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

ForestFire emissions from "FINN":
http://bai.acd.ucar.edu/Data/fire/

Put new files in DataDir (Global, 2002 to March 2011, 0.1 degrees res).
NB: these files are produced with netcdf compression (needs netcdf version 4 to be read)

Modified:
ForestFire_ml
run.pl
(SubMet_ml)

xxxxxxxx rv3_9_18, Peter 17th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

Use new version of NetCDF
Change Makefile and Makefile_stallo
Some cleaning of makefiles also.

Remember to do a make clean or make depend.

Note: this version links to the dynamic library (.so , i.e. is linked at runtime). (The static 4.1.1
library (.a) on Stallo is broken now.)
The new version of netcdf allows onthefly (de)compression of data.
You must use a new version of ncview/ncdump to look at "compressed" data.
Update your path to ncview and ncdump to
/global/apps/netcdf/4.1.1/ncview-2.0b4/bin/ncview
/global/apps/netcdf/4.1.1/bin/ncdump
(or do a module load netcdf)

Small change in NetCDF_ml (ReadField_CDF, larger maxlat for safety).



xxxxxxxx rv3_9_17, Robert 16th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

Bug fix in organic aerosol (VBS) model. Earlier version had too low BSOA yield from terpene oxidation in low-NOx conditions. Increased VBS-yields by a factor 1.5 for TERPPEROXY+HO2 reaction.

   Updated file:
   ZCM_vbs_tests/VBS_SOAformation.reactions

run.pl (Dave) - added 2 directory checks to lessen confusion

xxxxxxxx rv3_9_16, Peter   14th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

NetCDF_ml:
Bug in ReadField_CDF /= corrected from >:
              if ( Rvalues(ijkn(k) )  /= FillValue ) then


!----------------------------------------------------------
xxxxxxxx rv3_9_15, Dave   14th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

Safer setting of debug_proc, through new subroutine in GridValues
(since best setting needed li0, li1, etc., and this info
only becomes available after Topology called.)

GridValues_ml - debug_proc code moved to separate subroutine

ModelConstants_ml - added DEBUG_GRIDVALUES

Unimod.f90 - call to DefDebugProc added


xxxxxxxx rv3_9_14, Robert 14th Nov 2011 xxxxxxxxxxxxxxxxxxxxxxx

Updating GenChem.pl to use REAL values for molar weights rather than INTEGER.
         Important for the OA model version.

   ZCM_vbs_tests/VBS_SOAageing.reactions
      and
   ZCM_vbs_tests/VBS_partitioning.species
     - Added O_ASOA and O_BSOA species to the VBS-chemistry to keep track of extra oxygen added in
       aging reactions of SOA.


xxxxxxxx rv3_9_13, Dave, 11th Nov  2011 xxxxxxxxxxxxxxxxxxxxxxx

Bug-fixes

  Aqueous_n_WetDep_ml.f90 - small re-arrangement to stop use of
    negative kcloudtop as index  - caught by debug options in Makefile

  BLPhysics_ml.f90
      - added Kdef as required input to JericevicKz and BrostWyngaardKz
        Kz set to Kdef above Hmix
        (should optimise later, as subroutine probably)

   Met_ml
      - pass Kz_m2 (as calculated by Pielke/Blackader) as Kdef, see
        BLPhysics comments
        * Kz previously seems to have become undefined, or strange values




Extensions


  BLPhysics_ml.f90
     VogelezangHoltslag_Hmix added as option
     FluxPROFILE parameter added

  CellMet_ml,    USE_ZREF added - allows reference height to be
     different to lowest z_mid

  Derived_ml - start to simplify outputs, e.g. for HMIX, T2m, etc.
  My_Derived_ml - start to simplify outputs, e.g. for HMIX, T2m, etc.

  DryDep - small debug changes

  GridValues - small debug changes (as some code, and me, is getting
    confused by li0 vs. 1, etc.)

  Landuse_ml
     - added likely_coastal as logical
     - renamed rater_cover to more accurate water_fraction

   LocalVariables_ml - added z_ref as well as z_mid

   Met_ml
      - added "landify" - some in-testing code (commented out)
        may be used in future to ensure that grids with land-cover
        but defined as nwp_sea get their parameters from neighboroughing
        land

   MicroMet_ml
      - added Launiainen1995 possibility  - as default
        (avoids iteration in SubMet)

  ModelConstants_ml -  added USE_ZREF, see CellMet

  SeaSalt_ml - just changed name water_fraction
  Setup_1d_ml - just changed name water_fraction
  SoilWater_ml - just changed name water_fraction

  SubMet_ml - added use of FluxPROFILE == Ln1995 for testing
    (default is still iteration)


  Unimod.f90 - moved call to Topology before MeteoGridRead(cyclicgrid)

xxxxxxxx rv3_9_12, Robert 27th Oct 2011 xxxxxxxxxxxxxxxxxxxxxxx

Minor update of aging reactions for POA in VBS-model (slight increase
of Oxygen-addition for aged Wood Burning and Wildfire OA)

xxxxxxxx rv3_9_11, Hilde 19th Oct 2011 xxxxxxxxxxxxxxxxxxxxxxx

(rv3_9_10 accidently used earlier for rv3_7_10. Skip to 11 here)


Timefactors  - use iyr_trend instead of year

xxxxxxxx rv3_9_9, Robert 18th Oct 2011 xxxxxxxxxxxxxxxxxxxxxxx

  ZCM_EmChem09/EmChem09base.reactions - Changed the amount of RO2H formed in
  some RO2 + HO2 reactions to take into account formation of SOA

xxxxxxxx rv3_9_8, Hilde 18th Oct 2011 xxxxxxxxxxxxxxxxxxxxxxx
3 changes: 1)Explicit pH calculation (using ion balance, also including CO2-HCO3)
+ 2) change of seasonality of emissions + 3) use MARS for equilibrium

Aqueous_n_WetDep_ml.f90: pH calculation included
Timefactors: 10% change in summer/winter ratio over 10 years for SNAP 1 (Grennfelt&Hov)
My_Aerosols_ml.f90: call MARS instead of EQSAM
ModelConstants_ml: DEBUG_pH

xxxxxxxx rv3_9_7, Alvaro 17th Oct 2011 xxxxxxxxxxxxxxxxxxxxxxx

Output_hourly: Missing unit conversion (%unitconv) on COLUMN output type.
Only hourly column output for single species are affected.

xxxxxxxx rv3_9_6, Robert 17th Oct 2011 xxxxxxxxxxxxxxxxxxxxxxx

  ZCM_vbs_tests/VBS_SOAformation.reactions - Updated RO2 + HO2 reaction rates in the VBS-based SOA forming reactions (to be the same as in the EmChem09 photochemistry scheme), only influence the PCM model

xxxxxxxx rv3_9_5, Hilde, Dave 7th Oct 2011 xxxxxxxxxxxxxxxxxxxxxxx

  ZD_Ozone/My_Derived - set to re-include  some standard outputs

  GridValues_ml  - another change to stop debug_proc happening on
                   two processors

xxxxxxxx rv3_9_4, Dave   28th Sep    2011 xxxxxxxxxxxxxxxxxxxxxxx

   GridValues_ml: changed loop in GridValues to find debug_proc.
                  (old version found .true. on 2 processors, presumably
                   due to the overlap of domains)

vxxxxxxx rv3_9_3, Peter,23 September 2011  xxxxxxxxxxxxxxxxxxxxxxx

Minibug in error message ZD_OZONE/My_Outputs
(more changes to come)

xxxxxxxx rv3_9_2, Robert,23th August 2011 xxxxxxxxxxxxxxxxxxxxxxx

Minor update in SOA-model. Now include vegetation fire BC (FFIRE_BC) in the EC_f group.

xxxxxxxx rv3_9_1, Peter, 19th August 2011 xxxxxxxxxxxxxxxxxxxxxxx

T
NetCDF_ml
ModelConstants_ml
Nest_ml
OutputChem_ml
ALL the parameters (variables) are defined (created) in the NetCDF file before the data
is written in the first record.
Because of the way the netcdf is stored, all the data has to be copied each time a new variable is defined,
therefore it is very inefficient to add and write new variables succesively. See
http://www.unidata.ucar.edu/software/netcdf/docs/netcdf/Parts-of-a-NetCDF-Classic-File.html#Parts-of-a-NetCDF-Classic-File

This will not improve performance much in yearly runs, but will significantly help short runs: testing, CWF etc.


xxxxxxxx rv3_9beta, Dave, Peter, Robert, 9th - 11th August 2011 xxxxxxxxxxxxxxxxxxxxxxx

rtagged now - accumulates changes from   rv3_8_7 as listed below.


xxxxxxxx rv3_9_0beta?[not finished yet]  Robert, 11th August 2011 xxxxxxxxxxxxxxxxxxxxxxx

NOTE! This version is expected to give slightly changed results compared to
earlier versions (so should be given a new revision number)

ForestFire_ml: Changed the "assumed mass" for particulate OC emissions from wildfires from 0 to 12,
which has a big impact on forest fire OM emissions if the non-C part is modelled!
Important for partitioning OA-models!

Minor bug fix in Biogenics_ml (MW of isoprene changed from 64 to 68)
   -> Will give slightly different isoprene emissions

Updating mk.GenChem with new SOA scheme options (VBS)
   - Added a number of files in ZCM_vbs_tests (VBS_*.reactions and VBS_*.species, used by mk.GenChem to generate the VBS based chemistry schemes)

Many (still preliminary) changes in the VBS versions of My_SOA_ml and My_Derived_ml (in the ZCM_vbs_tests/ directory). Changed names for many of the help species and added possibility to store a number of new fields.

xxxxxxxx rv3_8_7d?  Peter, 10th August 2011 xxxxxxxxxxxxxxxxxxxxxxx

Problem in Nest_ml when nesting lon-lat grids. The debuggers show an error in:
call check(nf90_get_var(ncFileID, varID, lat_ext(1,:) ))
corrected into a safer version


xxxxxxxx rv3_8_7c  Dave, 9th August 2011 xxxxxxxxxxxxxxxxxxxxxxx
(We can merge all these changes into one rtagged cvs once we are
 done. I am not rtagging each one yet.)

GenChem.pl - now works even without seasalt. Unimod doesn't though :-(

run.pl - ProgDir added for CM_emislist.csv, CM_chempackages.txt

Nest_ml - RCA stuff commented out. Not consistent with CRI

xxxxxxxx rv3_8_7b  Robert, 9th August 2011 xxxxxxxxxxxxxxxxxxxxxxx

One major (only influencing VBS-model) and one minor correction/bug fix.

Updating the EMISSPLIT files for OC-emissions in the VBS-scheme.
     Earlier versions had an error in the MASS_ASSUMED.
     Now MASS_ASSUMED = 12 (emissions are assumed given in units of C)

Minor bug fix (should only influence the Log-files)

EmisGet_ml: Earlier version gave erroneous (too large) national total emissions
  in the log files if the same grid point occurs more than once in a given emission file.


xxxxxxxx rv3_8_7   Dave, 9th August 2011 xxxxxxxxxxxxxxxxxxxxxxx

FILE CHANGES!!!

   - mk.GenChem and GenChem  do more work :-)
   - No GenIn.reactions or GenIn.species
   - Instead, have sub-sets of these, e.g. EmChem09base, PMmass, ...
   - creates CM_emislist.csv and CM_chempackages.txt to be used
     in run.pl
   - Now, use mk.GenChem to select sub-sets of chemical schemes.
   - run.pl simpler for user because of these changes (no need to set emislist).

FILES REMOVED:
     My_Emis_ml   - not needed now. GenChem figures it out.
     GenIn.species, GenIn.reactions
     ZCM_vbs_tests/GenIn.reactions, GenIn.species  CM_BoundaryConditions.inc
      (the latter should be identical to the EmChem09.)

FILES ADDED:

Other small changes:

 EMIS_NAME becomes EMIS_FILE throughout code. (Easier for GenChem)

 Io_Progs_ml  datewrite formated extended to es11.3. Former 10.3
 merged with negative numbers.

 ZD_OZONE/My_Derived_ml - some CityZen outputs commented out.

 ZD_VBS/My_SOA_ml -  use of NVABSOM. In progress


xxxxxxxx rv3_8_6   Dave, Agnes,Mike  14th-15th July 2011 xxxxxxxxxxxxxxxxxxxxxxx

CityZen updates  (using ZCM_Eucaari_trends and Z_VBS directories)


   Country_ml
    Added countries 170, 171 for extended area

   DustProd_ml
    Moved DEBUG_DUST to ModelConstants_ml
    use CheckStop, not stop (avoids MPI problems)

   ZCM_Eucaari_trends
   ------------------
    Harmonise BICs:
    copied ZCM_EmChem09/SAFE- ... BICs to ZCM_Eucaari_Trends *and* ZCM_vbs_tests

    Changes in GenIn.species:
     Added AER_OM_F as helper species
     removed PM10, PMFINE groups from all SOA species. Only specify
     these groups for AER_OM_F and various EC components.

     Used PMGIANT group for SEASALT_G instead of PMCO - that is for
     the MMD=2.5um particles.

      EMISSPLIT - "_NEW" suffix dropped on emissplit.defaults.ecfi

   ZD_VBS
   -------

   My_Emis_ml added as default for VBS, with ocfi, ecfi. This is a temporary
   measure until GenChem sorts out which emissions are needed.

   My_SOA_ml:  use of AER_OM_F, ECFINE added

   My_Derived_ml: use of AER_OM_F. Commented out some ugN outputs, added
   ug/m3 and some cityzen requests.

   ZD_OZONE
   --------
     hr_out only for O3 as default.

xxxxxxxx rv3_8_5     Dave  10th July 2011 xxxxxxxxxxxxxxxxxxxxxxx

  Derived_ml - comment line corrected

  EmisGet - improved error messages (needed!)

xxxxxxxx rv3_8_4     Dave   9th July 2011 xxxxxxxxxxxxxxxxxxxxxxx

  BICs re-instated for C2H6 and CH3CHO (had ben dropped at some stage), but
  not with much lower CH3CHO than before - 0.3 ppb instead of 2ppb.
  Small effect on concentrations, with only PAN being slightly higher now.

  Another small bug found, we had a reaction [OH] + C2H6  which
  should have been [OH] + C2H6_BIC in old code, now deleted

  SUGGEST FOR OPEN-SOURCE

xxxxxxxx rv3_8_3  ...Peter  6th July 2011 xxxxxxxxxxxxxxxxxxxxxxx
                     Dave  22nd June 2011 (minor)

Two (small) bugs in the interpolation routines for the Aircraft emissions. (ReadField_CDF in NetCDF_ml)
When the surface pressure of standard atmosphere is smaller than the pressure read from SurfacePressure.nc, the standard surface pressure was modified for all cells in the subdomain, giving a dependence on the number of procs. The differences have only numerical significance.
Also changed the definition of "maxlon" in the routine as, this also could potentially lead to (small) errors.

NB: we still have as default:  USE_AIRCRAFT_EMIS  = .false.


Met_ml -- minor change, > changed to >= for JericevizKz (presumably
   v. little diff, if any.)

Rsurface - comments improved for HNO3 low-temp correction


xxxxxxxx rv3_8_2,  Dave/Svetlana/Birthe 20th June 2011 xxxxxxxxxxxxxxxxxxxxxxx

                                      *******************************
 USED FOR SOURCE RECEPTOR JUNE 2011   = EMEP/MSC-W version v.2011-06
                                      *******************************

io_min set to IOU_YEAR is SOURCE_RECEPTOR

xxxxxxxx rv3_8_1,  Dave/Svetlana 19th June 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

  *** BUG fixed and BUG found (not solved!) ***

  *** If USE_AIRCRAFT_EMIS is set .true. the results are slightly
      processor dependent. If false, they aren't. Set as .false.
      for now.
      Previous runs also seem to have only had aircraft emissions in
      bottom 6 levels of model, so pretty low-flying aircraft in any
      case.

Biogenic_ml - extra initialise (not needed I think, but safe)
              use limax instead of MAXLIMAX
              small tidy-ups

BoundaryConditions_ml - special treatment for sea-salt added. Set BICs to 1%
               over land areas.
               Various safety debugging added datewrite

Emissions_ml - problems found, not fully resolved. airn was set from
    KEMISTOP to KMAXMID, whereas it should from KCHEMTOP.

GlobalBCs_ml - * bug-fix * Removed Grid%is_NWPsea code.
                 small extra comments on sea-salt.

My_Derived_ml -  change PM25 to PMFINE, since PM25=PMFINE+0.5*PMCO
               (density removed from My_DerivFunc call - not used)

Sites_ml - added PM25 = PMFINE + 0.5*PMCO

ZCM_EmChem09/
   GenIn.species - removed CO_BIC, C2H6_BIC,
                   ** change PM25 to PMFINE, since PM25=PMFINE+0.5*PMCO
                   removed "anthro" groups
   GenIn.reactions - removed CO_BIC
   SAFE_BoundaryConditions.inc - removed CO_BIC, C2H6_BIC

Small clean-up after gfortran pedantic check:
   (mainly removing unused variables.)
    ChemFunctions_ml
    DefPhotolysis
    Derived_ml (density removed from My_DerivFunc call - not used)
    DustProd_ml
    Ecosystem_ml
    LandPFT_ml
    MassBudget_ml
    Met_ml
    Nest_ml
    NetCDF_ml
    Setup_1d_ml (initialised some rc rates also)
    Solver_ml


xxxxxxxx rv3.8s,  Dave       15th June 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

(s= back to simpler kaero, after many many tests)

Aero_Vds:
New Dp for coarse aerosol, Dp=2.5um. Hence 50% in PM25, 50% in PMco

ZCM_EmChem09/GenIn.reactions:
Decided on kaero in  HNO3 -> NO3_c

xxxxxxxx rv3.8,              24th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

 PUBLIC-DOMAIN RELEASE :-)

 Input.tex small change (for dust module) from Svetlana

xxxxxxxx rv3_7_10, Dave      24th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

CellMet_ml: fixed snowice following query of Guus Velders

ChemFunctions_ml:

    Riemer - included NO3_c (for robustness) and reduced rate by factor
    2 for OA effect (RIemer et al., 2009)

    kaero2 - only over sea squares, and mainly for levels  k=16..20

    ***  =>  results do change ****


EmisGet_ml:  added explanation of possible need for SEAFIX in checkstop
    comment

xxxxxxxx rv3_7_9b Svetlana,  24th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxx

Some fixing in DustProd_ml.f90

xxxxxxxx rv3_7_9b Robert,    20th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Added emissplit files for TNO/EUCAARI style EC/OC emissions

xxxxxxxx rv3_7_9 Dave,    20th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


mk.OpenSource added - ** prelim ** script to automate generation of
    OpenSource directory
    (only partially working. creates directory okay and compiles.
     Need to add inputs directory later also)

gpl.txt added to directory
Makefile.Open added (copied from OpenSource)

xxxxxxxx rv3_7_8 Peter,   12th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Upgrade of the Nest_ml routines.
Can use non-emep netcdf files for BC/IC; flexibilities introduced for nesting:
-vertical coordinates can be hybrid, downwards or upwards, possibly defined in an ad-hoc file (ifs-mozart)
-number of records in each file can be: 1 (RCA), some (mozart), all (emep), variable (transphorm)
-time can be defined with any "days since" date
-time can be defined in a 365days convention, but still use 29th of February (mozart!)
-IC and BC files can be different
-chemical components to be nested can be selected and to some degrees added together
-units can be PPB
-short accepted

The number of opportunities for bugs is huge...

NetCDF_ml: ReadTime more general. Compatible with 365 days calendar
SmallUtils_ml: wordsplit with ":" as sepaparator and an optional separator as input (dates need "-" as separator)
Met_ml: allow to read ustar_nwp instead of tau (for WRF)
PhyChem_ml: thour defined as = current_date (was shifted by 0.5 dt_advec before) NB: this will slightly modify results!
            timings for nesting read and write

Tove/Dave, 11th May 2011
(Small change for vbs only)

ZCM_vbs_tests/My_Derived  use My_Emis_ml instead of  EmisDef_ml

xxxxxxxx rv3_7_7 Peter,   9th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug in Nest_ml, when the IC file is different from the BC file (allocated to small ndays_ext).

xxxxxxxx rv3_7_6 Dave,   6th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

   ***** New emissions setup in GenIn.reactions etc.

   ** My_Emis_ml  is now back, but hopefully easier than before.
   ** CM_Emis.inc removed
   ** CM_EmisSpec.inc created by GenChem
   ** run.pl now uses MonthlyFac.pm25 for unknown emissions labels,
      removing earlier usage of ocfile, ocffl, etc.

   ** Emissions are now at lower heights.


   EmisDef - lower heights for emissions
   EmisGet - deals with new emissions, and checks that we have all
             that are needed (compares emissplit files to CM_EmisSpec list).
   GenChem.pl - changed for new rcemis
   Makefile.SRCS added My_Emis_ml.f90

   ZCM_EmChem09 files adapted for above
   ZCM_vbs_tests files adapted for above for PM25 usage
   ** EMISSPLIT directory added to ZCM_vbs_tests
      (All $Chem should have an EMISSPLIT directory, see below)


  Explanation of main change
  ---------------------------
  In the GenIn.reactions files we now use e.g.:

  rcemis:POC_FFUEL_f =

  then GenChem will make a list of the species which are wanted in
  CM_EmisSpecs.inc, here POC_FFUEL_f.  (the old system needed the name
  of the emission  file, which here was sometimes pm25, sometimes ocfile,
  sometimes ocffl.)

  If the run.pl provides PM25 emissions, the emissplit.defaults.pm25 (which
  should be part of the ZCM_ directory) needs to have POC_FFUEL_f. If
  run.pl provided POC emissions, then emissplit.defaults.ocff would need
  to include the POC_FFUEL_f.

  Thus we let GenChem tell the code which species it needs, and the user
  has to make sure that for that chemistry there are appropriate emissplit
  files.

  EMISSPLIT directories should contain all the emissplit.default etc. files.
  Note that we can have emissplits for many different "grid" files, they do
  not have to be used. Thus, we can have emissplit for "PM25" in the case
  that we run gridPM25, and also an emissplit.defaults.ocfile in case we
  are running with gridOCfine. No need to change GenIn. files or Unimod :-)

xxxxxxxx rv3_7_5 Agnes, Robert 5th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Agnes:
Mace Head correction for 2009 is included in GlobalBCs_ml.f90

Robert:
Changed the SOA (VBS) scheme. Now using higher SOA yields from AVOCs and include aging of ASOA, BSOA and POA.
                              Also include dry deposition of gaseous fraction of semi-volatile OOA (ASOA, BSOA and OPOA).

Modified: ZCM_vbs_tests/GenIn.species
          ZCM_vbs_tests/GenIn.reactions

xxxxxxxx rv3_7_4 Svetlana  4th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

More Bugs fixed:
1. Double declaration of DO_SAHARA in ModelConstants_ml.f90 and GlobalBCs_ml.f90 - Deleted from GlobalBCs.
2. In NetCDF_ml.f90 - correction for number of levels for hourly 3D and columns outputs  [KMAXcdf =min(KMAXcdf ,NLEVELS_HOURLY)]

xxxxxxxx rv3_7_3 Dave  4th May 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

    ***** MAJOR BUG fixed *******

    - IBC_CO   reset to 125 from 5 ppb. Bug introduced in rv3_7rc6 - do
    not use any of the versions after that, including the open-source!

xxxxxxxx rv3_7_2 Robert 13-15th April xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Very minor update:
Modified the SOA (VBS) code slightly. Replaced the NONVOLOC_GROUP and NONVOLEC_GROUP by NONVOLPCM_GROUP (since these groups are only used for partitioning semivolatile OA between gas and particle phases)

Modified: ZCM_vbs_tests/GenIn.species
          ZD_VBS/My_SOA_ml.f90

Updating the SOA (VBS) scheme to include EmChem09 chemistry (earlier versions based on EmChem03)
First test runs: After a bug fix in ZD_VBS/My_Derived_ml.f90 the SOA-code runs. More bugs are still likely. So check results carefully if you run the SOA-model!

Updates should only affect the SOA version of the model.

Modified: ZCM_vbs_tests/GenIn.reactions, GenIn.species, CM_BoundaryConditions.inc
          ZD_VBS/My_Derived_ml.f90, My_SOA_ml.f90

xxxxxxxx rv3_7_1  Peter 12th April xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

First version of a Nesting with general vertical coordinates. Can use external BIC files such as
MOZART or TRANSPHORM. Needs still some testing and filenames are hardcoded for now.
When new external file are included, more flexibility can be introduced.
Should be backwards compatible. The vertical coordinates are read from the info in the netcdf files,
or an external file in the case they are not found (MOZART).

Modified: Nest_ml, ModelConstants_ml,NetCDF_ml.

xxxxxxxx rv3_7rc12 Peter 8th April xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

My_Outputs_ml: output the entire grid (old was for emep grid, not eecca)
EmisGet and EcoSystem: changed write to screen format for compatibility with gfortran

xxxxxxxx rv3_7rc11 Dave and Peter 31th March xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Repaired massbudget; temporary fix.
The wdep was no longer calculated in Aqueous_n_WetDep

DEBUG_i= 0, DEBUG_j= 0 in ModelConstants to remove debug outputs.

xxxxxxxx rv3_7rc10 Dave 30th March xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SEAFIX_GEA_NEEDED - logical replaces previous fix for GEA data. (Used
to be if ( DomainName == "HIRHAM" .and. IIFULLDOM == 182 ) ...
Changes to: Country_ml, ModelConstants_ml

MassBudget_ml - printout of fracmass hidden in EXTENDEDMASSBUDGET test,
                 since the calculation is broken somewhere

My_Derived_ml - many outputs removed, including 3d

Formatting in GetEmis_ml, remove Reimer from Solver_ml,
   copyright -2011 in  many routines.

xxxxxxxx rv3_7rc9 Peter 25-28-29th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Cleaning the standard output (screen output)
Modified (at least):
EmisGet_ml.f90 Landuse_ml.f90 EcoSystem_ml.f90 Derived_ml.f90
Aqueous_n_WetDep_ml.f90 Io_Progs_ml.f90 Sites_ml.f90 Emissions_ml.f90
AirEmis_ml.f90 BoundaryConditions_ml.f90 NetCDF_ml.f90 MassBudget_ml.f90
GlobalBCs_ml.f90 Met_ml.f90 Biogenics_ml.f90 DryDep_ml.f90 Advection_ml.f90
ModelConstants_ml.f90 Unimod.f90 PhyChem_ml.f90 CheckStop_ml.f90

Model stops if no specials 'voc'.and.USE_FOREST_FIRES
printCDF overwrites any existing file (i.e. only one field can be saved)

xxxxxxxx rv3_7rc8 Dave 25th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

USE_CONVECTION = .false.


xxxxxxxx rv3_7rc7 Dave/Birthe 24-25th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave:


BVOC inputs changed. Just now run.pl hard-coded to read from mifads directory.
Will recode when benchmarked

Biogenics_ml       - Small re-write to cope with latest EMEP_EuroBVOC.nc
                     now copes with BVOC from wetlands, tundra.

DryDep_ml          - cleanup (could be improved)

Met_ml             - StopAll called if soil water attempt on IFS meteorology

ModelConstants_ml  - USE_CONVECTION set true - regretted later!

Rsurface_ml        - cleanup (could be improved)

run.pl             - points to Inputs_Mar2011 for Inputs*csv
                     and EMEP_EuroBVOC.nc

SubMet_ml          - NITER set to 1 again. Simpler

Birthe:
DOC changes

xxxxxxxx rv3_7rc6 Svetlana Mar 22th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
More improvement on sea salt:

Aero_Vds_ml.f90             - diameter of 'giant' particle
BoundaryConditions_ml.f90   - BICs for 3 size fractions of sea salt
GlobalBCs_ml.f90            -  --   #  ---- # ----- # ----
ZD_OZONE/My_Derived_ml.f90  - SEASALT_G is in
ZCM_EmChem09/SAFE.CM_BoundaryConditions.inc - BICs for 3 sizes of sea salt

xxxxxxxx rv3_7rc5 Dave Mar 16th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

BLPhysics - small tidy
BoundaryConditions_ml  & GlobalBCs_ml
  - replaced uneeded OH and CH3COO2 stuff with SEASALT_F,C
   (skip G for now. They don't travel far)
ChemFunctions_ml - added kero2 with slower rates  and limit to k>=10
ModelConstants_ml - sets USE_SOILWATER false. IFS stuff too hard for now!
Setup_1d_ml - mini clean up
Setup_1dfields_ml - clean up

ZCM_EmChem09/GenIn.reactions - use kaero2
ZCM_EmChem09/SAFE.CM_BoundaryConditions.inc - added sea salt
ZCM_EmChem09/EMISSPLIT - voc files re-commented

xxxxxxxx rv3_7rc4  Alvaro, Dave, Peter  Mar 15 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave+Peter:
More soil water changes + bug-fix for ws_10m

Landuse_ml - water_cover_set flag added. Needed since water_cover not
     available until nterm > 2

Met_ml .... further manipulation of SoilWater_deep values:

       ! Take a 5x5 average of the land-weighted values for SW. Seems
       !  best not to "believe" NWP models too much for this param, and
       !  the variation in a grid is so big anyway. We aim at the broad
      !  effect. (Alternattve might be to find max values?)

       Also, shallow soil water "switched off" if units /= "m". Seemed
       safest for OpenSource2011

       bug-fix on sw_10m

ModelConstants_ml - smal re-arrangement (alphabetical debugs)

Mosaics_ml  - DEBUG added in "MOS f2D" output

SoilWater_ml, simplified since code now in Met_ml

run.pl  $MetDir added to RunLog outputs. Source of met for 2008 was getting
        confusing!

Alvaro's changes:

Treatment of NetCDF output on FORECAST & SOURCE_RECEPTOR modes:
  - NetCDF files: create only when necesary
  - SOURCE_RECEPTOR mode: no IOU_DAY output
  - FORECAST mode: only IOU_DAY & IOU_HOUR output

run.pl: Small bugx-fix in FORECAST mode

Derived_ml: New public variables iou_min & iou_max contain the min & max
  admisible values for def%iotype to be written out:
  - by defount this correspond to the minval & maxval of f_2d%iotype & f_23%iotype
  - in SOURCE_RECEPTOR mode iou_max=IOU_MON
  - in FORECAST mode iou_min=IOU_DAY

OutputChem_ml: new logical function wanted_iou, to determine if a particular
  def%iotype is to be written out:
  - wanted_iou uses of iou_min & iou_max
  - Output_f2d & Output_f3d use wanted_iou
  - use date2string (TimeDate_ExtraUtil_ml) to generate monthly (ASCII) filenames
  - Additional indent & code formatting

Unimod: use wanted_iou to determine if a particular NetCDF file is needed

xxxxxxxx rv3_7rc3  Peter, Dave     Mar 14-15 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxx

ERF removed from Functions_ml

Bug corrected 15 March in Met_ml: ws_10 no more high.
INTERIM version. ws_10m seems high

Met_ml.f90: read units and transform deep_soil_water
Met_ml, MetFields_ml, FUTURE_NH3Emis_variation_ml: read wind speed at 10 meters
   into ws_10m removed the parts that defined u10 and v10 separately.

   Added subroutine extendarea to get an array containing neighbours beyond
   MAXLIMAX, MAXLJMAX. Used in SoilWater_ml to average over 3x3 area

Met_ml : dave added temp2 while trying to figure out why sw_10m is so high.
         Should be removed once explanation found!

SeaSalt_ml - modified to use ws_10m, but this ws_10m v. high compared to u_ref
             bug in ws_10m?

SoilWater_ml - now works with IFS and 3x3 average values. The latter needed
            to cope with coastal areas, and adds some robustness (hopefully)

Solver_ml : now switches off Reactions1 if DEBUG_DRYRUN = .true.
            saves some CPU when testing e.g. soil-water or sea-salt
            (sea-salt calcs are in Reactions2)


xxxxxxxx rv3_7rc2  Dave           Mar 13 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxx

Biogenics_ml corrected and cleaned. Notation updated.
  No BVOC_2010 option now - this is the only method. IQ_DMS moved to
  EmisDef_ml, first_dms_read moved to Emissions_ml
  Replaces ExportBIO routine with calls to new printCDF routine

Aqueous_ml - some print-outs moved to DEBUG

Derived_ml - cleanup and DEBUG changes

DryDep_ml  - NO2fac re-instated (for now, until we get a proper soil-NO
              treatment)
             Tidy-up, use of SO2 instead of IXADV_SHL+IADV_SO2 etc.

EmisDef_ml - IQ_DMS added

Emissions_ml - first_dms_read put here

MetFields_ml - small extra tidy-up

ModelConstants_ml - no BVOC_2010 option.

NetCDF_ml  - printCDF added - for "easy" output to cdf in e.g. debugging,
               call printCDF("Example,array,"ugS/m3")

Rurface_ml - small tidy up. Still could do with more (snow)

SeaSalt_ml - changed copyright dates

SetUp_1d_ml - cleaned
Unimod.f90 - BVOC_2010 stuff removed.

run.pl - Inputs.BVOC line removed

ZD_OZONE/My_Derived_ml - DEBUG change

ZCM_EmChem09 - reme kaero HNO3 -> NO3_c reaction. Seems to do
   more harm than good.

xxxxxxxx rv3_7rc1  ALL            Mar 11 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxx

labelled for Benchmark, for comparison to earlier.
End of changes for this busy week I think!

xxxxxxxx h18:15    Svetlana       Mar 11 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxx

Final version of SeaSalt_ml.f90 with 'giant' bin and
adjusted giant diameter Aero_Vds_ml.f90

xxxxxxxx h16:14      Peter      Mar 11 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

put an older version of Met_ml as the present one had wrongly replaced integer*2 with integer

xxxxxxxx h15:35      Svetlana       Mar 11 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

ERF function is removed from Functions_ml.f90 and DustProd_ml.f90

xxxxxxxx h15:20      Peter       Mar 11 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

run.pl: landsea_mask.dat, lightning$mm.dat
AirEmis: lightning.mm.dat
modrun.sh

xxxxxxxx h14:00      Peter       Mar 11 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

ModelConstants_ml: defined EECCA as domain and rundomain (and 8*4 procs)
GlobalBCs_ml:  added case (IBC_H2O2, IBC_OH, IBC_CH3COO2)     bc_rawdata=1.0E-25
(these were not set at all)

run.pl:
link EMEP_EuroBVOC_KRS09.nc to  EMEP_EuroBVOC.nc
link GLOBAL_O3.nc to GLOBAL_O3.nc (instead of GLOBAL_Boundary_and_Initial_Conditions.nc)

Cleaned by Joffen: Aqueous_n_WetDep_ml.f90, Convection_ml.f90

xxxxxxxx h11:00      Svetlana       Mar 11 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

In ModelConstants_ml.f90
logical, public, parameter :: USE_SEASALT      = .true.
logical, public, parameter :: USE_AOD          = .false.
logical, public, parameter :: USE_FOREST_FIRES = .false.
Correspondent modifications in Runchem_ml.f90, Solver.f90, Setup_1d_ml.f90
........................................

Aero_water_ml.f90 changed to MARS_Aero_water_ml.f90 (as it had the same name
as subroutine Aero_water() in My_Aerosols_ml.f90)
Correspondent changes in MARS_ml.f90 and Makefile.SRCS

ForestFires_ml.f90: len=TXTLEN_SHORT is assigned to emep_poll, gfed_poll
instead of too short len=10

xxxxxxxx h23:15       Alvaro       Mar 10 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

My_Outputs_ml,OwnDataTypes_ml,Output_hourly:
  - Move Asc2D data type from My_Outputs_ml to OwnDataTypes_ml
  - Extennd lenght of Asc2D%name,type,unit from TXTLEN_NAME
    TXTLEN_DERIV,TXTLEN_SHORT,TXTLEN_SHORT respectively
  - remove unused variables from use,only statements.
  - Additional indent & gFortran-pedantic cleanup.

Setup_1d_ml:
  - remove unused BGN_2D variable from use,only statement.

TimeDate_ExtraUtil_ml:
  - add ncdate2string function for nctime (seconds/days since ...) to formatted
    string conversion.

BoundaryConditions_ml
  - use PPB parameter from Model_Constants_ml instead of local variables.
  - remove unused variables from use,only statements.
  - replace WRITE by PRINT statements on debut printpouts.
  - replace me==0 by MasterProc

GlobalBCs_ml
  - replace USso2trend,USnoxtrend,USnh4trend by a own data type to shorten
    its definition.
  - replace UStrend & macehead_O3 if/else definitions by a select/case statement.
  - use date2string (TimeDate_ExtraUtil_ml) to generate monthly filenames.
  - replace WRITE by PRINT statements on debut printpouts.
  - remove unused variables from use,only statements.
  - Indent & gFortran-pedantic cleanup.

LocalVariables_ml:
  - Indent & gFortran-pedantic cleanup.

Unimod:
  - replace newseason if/else definition by a select/case statement.
  - replace WRITE by PRINT statements on debut printpouts.
  - remove unused variables from use,only statements.
  - Indent & gFortran-pedantic cleanup.

Volcanos_ml:
  - replace WRITE by PRINT statements on debut printpouts.
  - replace hardcoded 64.0 by species(SO2)%molwt.
  - remove unused variables from use,only statements
  - Indent & gFortran-pedantic cleanup.

xxxxxxxx rv3_7beta32  ALL - cleanup by 17:30 on Mar 10th xxxxxxxxxxxxxxxxxxxxxxx

rtagged for safety and benchmark

xxxxxxxx h08:45       Dave       Mar 10 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Add USE_AIRCRAFT_NOX; USE_LIGHTNING_NOX to ModelConstants_ml
  Changes in Unimod.f90, Setup_ml, Airnox_ml

xxxxxxxx rv3_7beta31  Anna/Dave  Mar 9 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Interim, but changes committed due to impending cleanup! Results may change
because of snow/ice !

Main changes: Usage of old climatology files removed. Left as !ACB comments
    for now, but will clean those out after testing

    files: CellMet_ml, DryDep_ml, DustProd_ml, Emissions_ml, Io_Nums_ml,
           LocalVariables_ml,  MetFields_ml, Rsurface_ml

Science change: ice_nwo now used! Was a bug that it wasn't used before!
                 Still needs thought in DryDep module, but should be okay
                 in SeaSalt_ml

Derived_ml, My_Derived_ml

  Snow_m added as output


  Renaming of variables: most modules have changes!!!
  -----------------------

  my %swaps = (
    gl_fdom => "glon_fdom"
   ,gb_fdom => "glat_fdom"
   ,gb      => "glat"
   ,gl      => "glon"
   ,ice     => "ice_nwp"
   ,water_fraction     => "water_cover"
   ,snow     => "snow_flag"
  );

xxxxxxxx rv3_7beta30  Svetlana   Mar 9 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Introduced an extra size bin ('giant') for sea salt
SeaSalt_ml.f90                - extra 'giant' size bin
Aero_Vds_ml.f90               - Vd for giant size (d=8.8 um)
Aqueous_n_WetDep_ml.f90       - scavenging ratio for SSg
My_Aerosols_ml.f90            - NSIZE = 3
Wesely_ml.f90                 - new CDDEP_PMg = 15 and AERO_SIZE=3
EmisDef_ml.f90                - QSSGI index
Solver.f90
-----
ZCM_EmChem09/GenIn.species
             GenIn.reactions

xxxxxxxx rv3_7beta29  Alvaro   Mar 8 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Small bug fixes

run.pl
  - Re-introduced small bug fix from rv3_7beta14, which got lost in rv3_7beta18.
    On SR runs, only AL was reduced.

Output_hourly:
  - Bug fix introduced in rv3_7beta18.
    COLUMNgroup hourly output type was wrongly calculated.
  - Scale factor (f_2d(ispec)%scale) was not used for D2D hourly output type.

Setup_1d_ml:
  - small bug fix regarding rh(k) min & max values, introduced in rv3_7beta24.

Unimod:
  - Fix bug regarding D2D hourly output:
    D2D output fail to find correct index based on f_2d%name.
    The reason is that set_output_defs was called before Init_Derived.
    Therefore, f_2d was not defined when f_2d%name was searched.

Nest_ml & ModelConsants_ml:
  - NEST_MODE introduced in rv3_7beta25 was not being used on Nest_ml.
    Now NEST_MODE is declared as a public parameter in ModelConsants_ml,
    and is used in Nest_ml (ModelConsants_ml, only: ...MODE=>NEST_MODE...).

Nest_ml:
  - type(deriv) components inst, month, year, day where still "in unuse"
    in wrtxn. The lines where commented with !FEB2011 and replaced
    with the corresponding iotype.

Hourly accumulated Dry & Wet depositions available trough D2D hourly output type.
All accumulated D2D variables are now outputted as Hourly accumulated values,
instead of instantaneous values (previous behavior).

ModelConsants_ml:
  - Introduce IOU_HOUR_PREVIOUS=5 (ModelConsants_ml)

Derived_ml:
  - Introduce explicit dependence between LENOUTxD and IOU_*.
    Define LENOUT2D = IOU_HOUR_PREVIOUS and LENOUT3D = IOU_DAY.

Output_hourly:
  - modify D2D hourly output type
    - non accumulated D2D variables (f_2d%avg) are access trough IOU_INST.
      This was the behavior for all D2D variables until version rv3_7_beta21.
    - accumulated variables (.not.f_2d%avg) are now calculated as the
      difference between IOU_YEAR and IOU_HOUR_PREVIOUS.
    - if(hr_out%unit=="")f_2d%unit is used
    - f_2d%scale is always used in conjunction of hr_out%unitconv

My_Outputs_ml:
  - add "sox_wdep" variable to standard hourly output,
    in order to test D2D hourly output type. The max difference between
    WDEP_SOX from fullrun sox_wdep (hourly accumulated variable) and
    is ~1e-4 mgS/m2. This additional variable can be commented on future versions.

Modified handling of start/end dates to allow multi-year runs.
This feature is needed in FORECAST mode, but it is also available for non forecasts.

run.pl:
  - replace $startyear/month/day & $endmonth/day variables for $startdate and $enddate.
    Each $start/$enddate is a string in "YYYY MM DD" format.
    In non FORECAST runs both the YYYY fraction of $startdate and $enddate
    have the same value ($year). In forecast runs $start/$enddate are set
    accordingly to $CWFDATE[1] (forecast start date) and $CWFDATE[2] (end date)
  - remove calc_nterm

Unimod:
  - modify reading of start/endate arrays, so each date is read from a single line.

New module TimeDate_ExtraUtil_ml
this new module contains more specific utilities than TimeDate_ml, such as:
   * assign_NTERM:  previously in TimeDate_ml)
   * dayssince1900: previously in NetCDF_ml
   * datefromdayssince1900: previously in NetCDF_ml, Nest_ml & Met_ml

TimeDate_ExtraUtil_ml, Makefile.SRCS:
  - new module TimeDate_ExtraUtil_ml
  - re-write assign_NTERM, *date/scondssince* procedures
    to take advantage already defined time tools (TimeDate_ml)
    such as tdif_secs. New assign_NTERM code can deal with multi rear runs.
  - nctime2date and date2nctime interfaces take advantage from the
    fact that the current time variable in our netCDF files
    (dayssince1900) is a real variable, while the old one
    (secondssince1970) was an integer variable.
  - date to string conversion function based on string keywords:
    date2string replaces several text keywords by the corresponding
    year, momnt, day, ... for a given date, e.g.
    create a file name from a date2string:
      filename_read_BC=date2string('EMEP_IN_BC_YYYYMMDD.nc',indate)
    time stamp an error message
      call CheckStop( mod((ihh-1)*METSTEP+nhour_first,24), ndate(4),  &
          date2string("NetCDF_ml: wrong meteo hour YYYY-MM-DD hh",ndate))

TimeDate_ml:
  - Add tdif_days & add_days functions
  - move assign_NTERM to TimeDate_ExtraUtil_ml (new module)

NetCDF_ml:
  - move dayssince1900 & secondssince1970 to TimeDate_ExtraUtil_ml,
    and use general date2nctime interface instead
  - remove datefromdayssince1900, which was unused

Nest_ml & Met_ml:
  - move datefromdayssince1900 & datefromsecondssince1970 to TimeDate_ExtraUtil_ml,
    and use general nctime2idate interface instead

Io_Progs_ml:
  - Include an optional input variable (txt_pattern) into datewrite,
    which indicates if the input text is to be phrased trough str_pattern.
    E.g. the "standard" datewrite call:
      call datewrite("Test", (/ a1, T2, rh /) )
    can be extended into:
      call datewrite("Test YYYY-MM-DD hh:mm:ss",&
                     (/ a1, T2, rh /), txt_pattern=.true.) ! extended call

Unimod, Nest_ml & Met_ml:
  - use date2string for time stamping CWF-dump messages (Unimod),
    obtaining the BC file name on FORECAST mode (Nest_ml) &
    adding date information to error messages.

Other Updates

My_Outputs_ml, Output_hourly:
  - use groups system: chemgroups instead of GROUP_ARRAY & INDEX_XXX_GROUP.

Open Source Clean-ups:

SmallUtils_ml:
  - add optional option 'debug' to find_index & find_indices,
    in order to printout additional debug information.
  - Indent & gFortran-pedantic cleanup.

TimeDate_ml
  - re-write leapyear and Init_nmdays in a simpler fashion
  - a default result was added to y4dig
  - Indent & gFortran-pedantic cleanup

Output_hourly:
  - Remove/update old comments, indent & gFortran-pedantic cleanup

Nest_ml:
  - replace me==0 by MasterProc
  - Indent & gFortran-pedantic cleanup

Io_Progs_ml:
  - Indent & gFortran-pedantic cleanup

ModelConstants_ml
  - Indent & cleanup code

xxxxxxxx rv3_7beta28 Mar  1 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Main change is usage of iotype in f_2d Deriv arrays. Changes lablled with
FEB2011, pending merge with Alvaro's version and checks for FORECAST mode.

Derived_ml,

   Replaced inst, month, year, day logicals in Derived_ml by integer iotype
   Changes marked with !FEB2011 for now. Will clean up once more changes
   made

My_Derived_ml
    Similar changes, also Mosaic outputs had one extra field for units.
    (now typ_s5i)

Ecosystem_ml - iotype

Mosaics_ml

    Init_MosaicOutputs routine removed. Hardly did anything!
    typ_s5i replaces typ_s4 (am iterating towards full Deriv type!)
    iotype used as input arg to subroutines -set in My_Derived
    find_MosaicLC function added to assign correct LC index,
    acccounting for FULL_GRID=0 (Grid or EU cases)

NetCDF_ml
    iotype usage added
    more error messages in check calls
    commented out def1% inst, month, year, day   - anyway not used

OutputChem_ml
    iotype usage added
    QUERY - need to check usage for FORECAST especially

Unimod.f90
     iotype usage added.

Biogenics_ml, ForestFire_ml, Nest_ml
   commented out def1% inst, month, year, day   - anyway not used

xxxxxxxx rv3_7beta27 Feb 28 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Removed NTERM from run.pl. Instead endday and endmonth are defined and
NTERM is calculated in the model.
Also removed NASS, which was not used anyway.

Note: if enddate is before startdate, 3-hour run is performed.
      if endday is larger than the number of days in the month (for example
        endday=33), it is set as the number of days of the month; this is
        to avoid thinking about leap years etc.
      The new code will not work with old run.pl, since the variables read in have changed.

NB: CWF runs are broken now. run.pl is not yet updated for CWF!

Unimod.f90: call assign_NTERM(NTERM). Better comments when wrong number of PROCS.
TimeDate_ml:defined assign_NTERM(NTERM) and moved startdate,enddate there.
Met_ml: moved startdate,enddate out of this module
ModelConstants_ml and MassBudget_ml: defined EXTENDEDMASSBUDGET to be set
                        as true if all the massbalance output is required

modrun.pl: completely changed and simplified

xxxxxxxx rv3_7beta26 Feb 28 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Derived_ml - bug fix***  Emis_mg_xxxx now factor of 3 lower. Had wrong
   setting for dt-scale

OutputChem_ml


xxxxxxxx rv3_7beta25 Feb 24 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

NEST_MODE moved to ModelConstants_ml from Nest_ml

Small tidy ups:

EmisGet_ml.f90
Emissions_ml.f90
ForestFire_ml ( changes to prevent many printouts if < 2000 or > 2007)
MosaicOutputs_ml.f90
OwnDatTypes_ml.f90
Tmp_Met_ml.f90

xxxxxxxx rv3_7beta24  Dave   Feb 20 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Clean-up list added to Log.changes - please use!

N2O5_hydrolysis_ml removed - was not being used!

Setup_ml - added max (RH; 1.0e-5) - stops negative RH! (Maybe doesn't
affect results since eg N2O5 usage is only for RH>0.4).

Small tidy-ups:

Aqueous_n_WetDep_ml
ChemFunctions_ml - made VOLFACs public
ModelConstants_ml - added DEBUG_SOLVER, DEBUG_AEROSOL
My_Aerosols_ml
My_Outputs_ml (also added PAN to default SONDE outputs)
Runchem_ml  -  also has some extra debugging code, which I wil remove
               later after implementing N2O5 hydrolysis changes.
Solver_ml   -  also has some extra debugging code, which I wil remove
               later after implementing N2O5 hydrolysis changes.


Log.changes - added tidy-up list above

xxxxxxxx rv3_7beta23  Dave   Feb 10 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

New (again!) groups system!   Removal of My_WetDep_ml :-)

1. New chemgroups array added in CM_ChemGroups_ml, with pointers to the
   different group arrays, see below.

2. CM_ChemGroups_ml.f90 now kept as separate file, not in CM_ChemSpecs_ml

3. GenChem.pl re-written for the above changes

4. GenChem also makes groups for wet and dry dep automatically, e.g. it
   will figure out WDEP_PM10 or WDEP_DUST  ... the user only has to have
   these properly set in GenIn.species

5. My_WetDep_ml merged with Aqueous_ml - > Aqueous_n_WetDep_ml. All chemistry
   dependencies are now through the imported CM_WetDep.inc file.


These changes also make "older" code like ZCM_Eucaari_Trends, or newer
code like CRI_v2_R5, work again since we have avoided the need for
hard-coded groups.

More on the new group system:

from before we had something like:
 integer, public, target, save, dimension(2) :: &
             NOX_GROUP     = (/ NO,NO2 /)

and which could be accessed by searching for "NOX_GROUP" in the (messy!) GROUP_ARRAY, as something like:
, gtype( "NOX", 2, (/ NO,NO2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 /) ) &

Now we use an array chemgroups which uses pointers. For example, "NOX" in
chemgroups is specified with:

 p => NOX_GROUP
 chemgroups(8) = typ_sp("NOX", p )

Search for NOx and you get the full array of NOX_GROUP.

Much easier!

So far I have only implemented this for wet deposition, so look there for examples.


Other changes:

Derived_ml
   clean-out of old and unneeded code - e.g. old GROUP stuff

My_Derived_ml:
    WDEP_WANTED now used typ_s3 for both groups and species

My_WetDep_ml - deleted :-)

    Functionality moved to Aqeuos_n_WetDep_ml.

OwnDataTypes_ml - added new types

SmallUtils_ml, added txt to outputs

Unimod.f90 - small changes for new files

gfortran-pedantic clean for

DryDep_ml
MosaicOutputs_ml

xxxxxxxx rv3_7beta22  Dave   Feb 10 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

 ** BUG fix ** My_WetDep_ml
    NaCl wet deposition output: now use fSS, not fN

Derived_ml.f90 &
Ecosystem_ml.f90
MosaicOutputs_ml.f90

  FULL_GRID now called either FULL_ECOGRID or FULL_LCGRID to avoid confusing the two

LocalVariables_ml
  Sub array now starts at zero, which is used for full grid (FULL_LCGRID=0)

My_Derived_ml
  seasalt Vg added while testing NaCl

OwnDataTypes_ml
   typ_sp with name and pointer introduced (for experiments so far)

xxxxxxxx rv3_7beta21  Dave   Feb 6 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

My_Derived_ml
  OutputConcs array created for  2d and 3d concentrations and groups
  Further simplifications in Derived_ml - simplifcation

Derived_ml

  OutputConcs array used  for  2d and 3d concentrations and groups
  ( Old D3_PPB, D3_UG stuff replaced by OutputConcs processing.
    Hard-coded groups such as D3_ug_PM25 removed. Such groups
    should now be asked for in OutputConcs. )
  WDEP_SSALT added

OwnDataTypes_ml: typ_s5i added - used for OutputConcs


Biogenics_ml.
    - some extra safety measures and tidy-up

GenChem.pl
   seagroup dep arrays added for sea-salt

Io_Progs_ml
   small format change in datewrite

My_WetDep_ml
   wdepss added for sea-salt

Unimod.f90
   USE_BVOC_2010 added to printlog



xxxxxxxx rv3_7beta20  Alvaro Feb 2 2011 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Output_hourly:
  - Bug fix introduced in rv3_7beta18.
    All levels on BCV* output types (model level output)
    where wrongly claculated as ADV* output types (surface level output).
    All BCV* output types where affected.
  - gFortran pedantic: Different CHARACTER lengths in array constructor

xxxxxxxx rv3_7beta19  Dave code simplification xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

My_Derived

 - 100 lines shorter :-)
 - type_s4 now used to specify wanted Vg, Rs
 - Add_NewMosaics replaces Add_MosaicVg, Add_MosaicRG
 - WDEP_CONCS now specifies eg SO2, NH3 ... for WDEP outputs
 - SURF_GROUPS now specifies OXN, .... etc.
 - misc_xn subroutine - removed OX, NOX, NOZ, TRDN, tNO3, ssalt - all
   such groupings are now handed using the GROUPS feature of GenChem
 - last function, for FRNITR moved into MyDeriv_Func

Derived

 - 50 lines shorter :-)
 - WDEP_CONCS now specifies eg SO2, NH3 ... for WDEP outputs
 - SURF_GROUPS now specifies OXN, .... etc.
 - suboutine Units_Scale added to return scaling and unit txts
 - density calculation movied outside of loop - only used as
    appropriate now anyway
 - so test for ppb in MAXADV and MAXSHL
 - ADV, TADV lines removed
 - OXNGROUP NOXGROUP etc. lines removed for 2d stuff. Shoud do same
   for 3d soon....

Mosaics_ml
 - Add_NewMosaics replaces Add_MosaicVg, Add_MosaicRG
   (will rename from "New" once process finished)


OwnDataTypes
 - Deriv - removed rho and atw

rho, atw removed also in:

Biogenics_ml
EcoSystem_ml
ForestFire_ml
Nest_ml
NetCDF_ml


Some tidy-ups, small changes:

 Aqueous_ml
 LandDefs_ml
 My_WetDep_ml

xxxxxxxx rv3_7beta18  Anna, Jan Eiof, Svetlana & Alvaro Jan 28 2010 xxxxxxxxxx

Update of hourly (netCDF) output routines

My_Outputs_ml:
  Set FORECAST default output in an IF, instead of commented code.
  Full model domain is to be outputed for 10 pre-defined variables.

Output_hourly:
  group COLUMN calculations

My_Outputs_ml, Output_hourly:
  - use INDEX_*_GROUP (from ChemGroups_ml) for identification of groups
  - Partial/Full COLUMN/COLUMgroup calculations:
    hr_out%nk indecate the number of levels in the column,
      1<%nk<KMAX_MID  ==>  Partial column: %nk lowermost levels
         oterwise     ==>  Full column: all model levels
  - cleanup: gFortran pedantic; removal of old comments & old commented code

My_Outputs_ml, Sites_ml:
  - replace SITE_XTRA/SITE_XTRA_CODE by SITE_EXTRA_MISC/SITE_EXTRA_D2D
    in order to avoid the multiple "D2D" commented liles
  - Imprrove print/write formats in Sites_ml
  - cleanup: gFortran pedantic; removal of old comments & old commented code

ZCM_EmChem09/GenIn.species:
  - DUST_NAT_C repeated in PM10 group
  - Same kind of fix for other commented aerosol components  (EC_f/c_new/age)

Makefile_gfortran:
  Ubuntu 10.04 (Lucid) stings

Makefile_titan:
  No optimization options in LDFLAGS if DEBUG_FLAGS is defined

run.pl:
 - Update titan directories
 - Paralell SR runs (one country per Job task) option also available in titan.
   Multiple tasks are submitted (e.g. arrayrun 1-56 run.sh).
   The variable $ENV{'TASK_ID'} is used to select one element of @countries.
 - Inclaude MACC02 Benchmark set

Unimod, Derived_ml:
  clean AMVB comments

xxxxxxxxxxxxxx rv3_7beta17  Dave  Jan 26 2010 xxxxxxxxxxxxxxxxxxxxx
               (not rtagged, but essentially same as beta18)

Major re-write of AOT, POD, VEGO3_OUTPUTS and associated simplification
of Derived system

 *** needs new input files for DO3SE  *********

 - AOTnPOD_ml - replaces AOTx_ml.
   This module now collects together much of the code for
   processing AOTs and fluxes (PODs). Includes O3cl type which
   defines allowed outputs. e.g.

    VEGO3_DEFS    =  (/ &
   O3cl( "POD1_IAM_DF   ",   "POD", 1.0,  "- ", "IAM_DF",F,0,999 ), &
   O3cl( "POD0_IAM_DF   ",   "POD", 0.0,  "- ", "IAM_DF",F,0,999 ), &
   O3cl( "MMAOT40_TC    ","AOT", 40.0, "MM", "TC    ",F,0,999 ), &

 so that My_Derived  just needs to give the names wanted, e.g. POD1_IAM_DF

   Accumulation period for calculation defined in this array, so
   older (and inflexible!) WheatGrowingSeason removed.

 -  My_Derived_ml - see new O3cl types

 -  DO3SE_ml changed, also with extra input param: VPDcrit

  associated changes in

   Derived_ml  (Threshold removed from Deriv type, SOMO changed, ..)
                accumlate_2dyear removed

   Ecosystems_ml
   Makefile.SRCS - AOTnPOD_ml replaces AOTx_ml
   ModelConstants_ml  - removed need for STO_FLUXES
   MosaicOutputs

   StoFLux_ml
      - use of VPDcrit

 - Unimod - more timing calls added

Some gfortran pedantic cleanups in

    DryDep_ml
    LandDefs_ml
    Landuse_ml
    SoilWater_ml - Alvaro's change

And run.pl changed to use Modrun10 emissions for "EMEP" Benchmarks
 %BENCHMARK = (grid=>"EMEP" ,year=>2006,emis=>"Modrun10/EMEP_trend_2000-2008/2006");

xxxxxxxxxxxxxx rv3_7beta16  Peter, Jan 24 2010 xxxxxxxxxxxxxxxxxxxxx

Retabished the original way of making the last met record in run.pl (see rv3_7beta15)
and instead changed Met_ml:
When the first record when starting a new year is not found, use the same value
for metdata as in 31 December (21:00 values instead of 00:00 next day).

Changed also calc_nterm in run.pl, to take into account the first day (dd1).


xxxxxxxxxxxxxx rv3_7beta15  Dave, Jan 22 2010 xxxxxxxxxxxxxxxxxxxxx

Clean-up code changes, single-year run.pl,  and 1 bug fix.....

 *** Bug-fix ***  in Volcanoes_ml - coordinates were wrong for
        EMEP/EECCA cases
        Also, DEBUG_VOLC moved to ModelConstants_ml

 *** code cleaned/removed ***

  1)  My_Derived_ml, Derived_ml  - simpler outputs :-)

      Now use the one array SURF_CONCS to specify outputs, with
      desired unit. Replaces SURF_UG_S, SURF_UG_N, SURF_UG_C,
      SURF_UG and SURF_PPB. Now say e.g.:

     type(typ_ss), public, parameter, dimension(26) :: &
           SURF_CONC = (/ typ_ss("SO2", "ugS"),&
                          typ_ss("SO4", "ugS"),&
                          typ_ss("NO", "ugN"),&
                          typ_ss("O3", "ppb"),&
           .....

     Associated changes in:
      OwnDerivedTypes_ml ... added typ_ss for pair of text strings


  2)  My_DryDep_ml - deleted :-)

      Not needed now since CM_DryDep.ninc has all the important information -
      now this is imported to DryDep

      Associated changes in:

       DryDep_ml
       MassBudget_ml
       ModelConstants_ml  - now has USE_STO_FLUXES
       Sto_Fluxes_ml


 *** safer run.pl ***********

     run.pl changed to avoid taking data from next year (in principal we need
     a few hours from 1st Jan of $yy + 1. Very very easy to not have this.)

xxxxxxxxxxxxxx rv3_7beta14  Anna, Semmena & Alvaro   Jan 20 2010 xxxxxxxxxxxxxxxxxxxxx

Small changes concerning FORECAST & FORECAST-SR modes

run.pl: - Naming for Nest-IC/re-start (dump) files under FORECAST-SR mode
        - Small bug fixes on the Perl code for SR mode

Nest_ml: Bug fix on FORECAST mode. The Nest-BC (IFS-Mozart) files where not found/read.
  The BC variables were searched on the Nest-BC files
  before the filenames where set to the corresponding date.
  Therefore, the Nest-BC file and all of its variables where considered missing.

Makefile_titan: homogenize with Makefile_stallo
  - MPI: use openmpi library as in stallo.
    This replaces the scampi library, which will be discontinued in June 2011.
  - IFORT: use same options than Makefile_stallo.
    Because of the -shared-intel option it is of VITAL IMPORTANCE to have
    the same modules available for compilation and run.
    In titan this is done by the following command line:
      module load intel/11.1u8 openmpi/1.4.3.intel

xxxxxxxxxxxxxx rv3_7beta13  Peter        Dec 21 2010 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


the -recursive option seems to be useful for the compiler. If omitted it may give this
kind of error messsages for large grids:
   Ammonium_ml.f90:(.text+0x3b): relocation truncated to fit: R_X86_64_32S against symbol `set...

Remodified Makefile and Makefile_stallo

xxxxxxxxxxxxxx rv3_7beta12  Peter        Dec 15 2010 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Generate 3D precipitation if it is missing. Use 2D precipitations and 3D cloudwater.
If Cloudwater is missing use relative humidity (derived from specific humidity) instead.
Units are assumed as in EECCA/metdata_EC, i.e. m/s for surface precipitation and kg/kg for cloudwater

ToDo: consider replacing lwc (computed from cc3d) with cw (read from metdata)

(removed -recursive from Makefile: it is no more required)

Modified: Met_ml, MetFields_ml, ModelConstants_ml, Makefile, Makefile_stallo (, run.pl)

xxxxxxxxxxxxxx rv3_7beta11 Semeena, Peter        Dec 2 2010 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Convection routine moved in own file (no change in results)
Modified:
Convection_ml.f90 (new file)
Makefile.SRCS
Advection_ml
(GridValues_ml: just a comment modified)

xxxxxxxxxxxxxx rv3_7beta10 Dave        Nov 29 2010 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug fixes for SoilNO  (no effect unless USE_SOILNO = .true.)

Emissions_ml
Setup_1d_ml


xxxxxxxxxxxxxx rv3_7beta9  Dave        Nov 27 2010 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Fixed run.pl
    Dust switched off for "EMEP" grid since we don't have the data file
    yet. (Solution will be to netcdf the files, not to have one in each
    LOCAL_DATA dir.)

Added pm25 and pmco files to ZCM_EmChem09/EMISSPLIT

(Not updated in Eucaari directory yet. Need to decide how much detail
with which to split pm25.)

More use of PrintLog in Unimod.f90 - to record which switches were used in RunLog.

Dust changes

   - USE_DUST and DO_SAHARA put in ModelConstants_ml (where
    similar switches are kept). Makes it easier to switch off for EMEP domain.

   RunChem_ml and Dust_ml only if USE_DUST

   ZD_OZONE/MyAerosols - DUST logical replaced by USE_DUST from ModelConstants

   GlobalBCs_ml - DO_SAHARA from ModelConstants


xxxxxxxxxxxxxx rv3_7beta8  Dave+Peter  Nov 23 2010 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

New group system started --- not finished!

  Changes to handle groups better, and get rid of hard-coding in Derived_ml
  (The rv3_7eucaari version would not compile with EmChem09 chemistry.)

GenChem.pl now produces extra group info in CM_ChemSpecs_ml, with
   a new type gtype, e.g.

    type(gtype), public, parameter, dimension(18) :: &
       GROUP_ARRAY = (/ &
 gtype( "SOX", 2, (/ SO2,SO4,0,0,0,0,0,0,0,0,0,0,0,0,0,0 /) ) &
  ......

My_Derived_ml:   now has SURF_UG_GROUP = (/ "SIA", "PM25",  ....

   - works the same way as for SURF_UG = (/ "SO2", .....

   - BUT - I haven't had time to make SURF_UG_N_GROUP, SURF_PPB_GROUP etc.
     [Note: Should redesign again with units specified with name,
       eg SURF_GROUP = (/ pair( "SIA", "ugm3"), pair("OXN", "ugNm3"), &
                          pair("NOX", "ppb") /) or similar....    ]

   - outouts called SURFGRP_UGM3_SOX etc.... [Note: Will rename to just SURF_
     once the older SURF stuff is erased for groups.

   - D2_PM removed. Functionality in above or elsewhere

   Thus the former SOX_GROUP is not needed, but just the character array "SOX".
   This avoids compilation problems where groups do note exist (eg "BSOA")
   and allows looping.


Derived_ml

   - all groups that are defined in SURF_UG_GROUP now removed from
   Derived_ml. Instead we use AddNewDeriv for SURF_UG_GROUP similar
   to for SURF_UG. Gets rid of lots of lines (currently commented
   out with !GRPD

   - flex_uggroup_calc routine removed. All can be done with the original uggroup_calc

Also
   Dust_ml : MasterProc used to limit outputs (should use in
    preference to me == 0 anyway.)

   NetCDF_ml - bug fix on ReadField_CDF:
        if(imax==1)imax=dims(1)!covered entire circle


xxxxxxxxxxxxxx rv3_7eucaari xxxxx Many authors !! 21 Nov 2010 xxxxxxxxxxxxxxxx

   *New directory*

    ZCM_Eucaari_Trends - use instead of EmChem09 for EUCAARI work.

    Has VBS SOA chemistry from Robert.  Note that instead of EC_f_new we
    now have EC_f_FFUEL_new, EC_f_WOOD_new, etc. Not perfect (as we don't
    have wood emissions) but it limits the number of SOA schemes used.

    Has changed  GenIn.species for SOA (DryDep fom Robert has gas-phase dep
    of SOA)

    Contains EMISSPLIT -  split files


  Other:

  Advection_ml - added min(ps3d) safety checks

  Biogenic_ml - * fixed bug * for terpene emissions. Added EmisNat for BIO_TERP
    - reset to 2003-style emissions to keep consistent with Robert's SOA
      clearer coding of differences I hope

  Derived_ml - Idirect, Idiffuse, T2m and *lots* of 3D options added
  My_Derived_ml - Idirect, Idiffuse, T2m options added
                - outputs reduced for EUCAARI runs. (still v. many)

  run.pl - various EUCAARI options.

  ModelConstants_ml - added HIRHAM and DRYRUN flag
                    - switched on deep soil water :-)
                    - added Payerne as HIRHAM debug coords

  Sites_ml,   just renamed CALL to call. Was looking ofr lat/long "LL"

    xxxxxxxxxxxxxx ....  (Peter 23/11-2010)xxxxxxxxxxxxxxxx
	new bug in ReadField_CDF: special case when imax=360 because the area covers all longitudes (was set to 1)

    xxxxxxxxxxxxxx .... SoilNOx  (Peter 11/11-2010)xxxxxxxxxxxxxxxx
   set USE_SOIL_NOX=.true. in ModelConstants_ml to get soil nox

Corrected a bug in ReadField_CDF (a few values were set to undef/0 when latitude start from north poles in the datafile.)
Changed test for ps3d in Advection_ml, to avoid unnecessary warnings.

Changes in:
ModelConstants_ml
NetCDF_ml
Emissions_ml
Setup1d_ml
Advection_ml
run.pl

   xxxxxxxxxxxxxx .... with VolcanoesLL (Peter 1/11-2010)xxxxxxxxxxxxxxxx
    Included a lon lat description for Volcanoes:
    /global/work/mifapw/emep/Data/VolcanoesLL.dat
    NB:emission values and positions should be updated

    It is used if  VOLCANOES_LL  = .true. in EmisDef
    Then the volcanoes from gridSOX and Vocanos.dat are not used!

    NB: femis.dat reductions will not work anymore on country=28 (volcanoes)

    The conversion to grid coordinates should be automatic.

    Changes in:
    Volcanos_ml, Emissions_ml, emisGet_ml, EmisDef_ml, Setup1d_ml, run.pl

    Note that Volcanoes_found is a local variable (different value on different processors)
    There are still some back and forth i,j conversion which should be removed once.

	11th November: corrected small bug    (character(len=20), dimension(5) :: Headers )

xxxxxxxxxxxxxx rv3_7beta7b Robert Oct 30 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Minor update in vbs-SOA scheme. Adding EC aging.

xxxxxxxxxxxxxx rv3_7beta7 Svetlana (+minor updates by Robert) Oct 29 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Main changes:
1. Introduction of fine EC and POC from primary emissions
   EC is split to EC_f_new (fresh) and EC_f_age (aged)
   ChemFunctions_ml.f90:  function ec_ageing_rate() result(rate)

2. Changed names aNO3_f to NO3_f;  pNO3_c to NO3_c;  aNH4 to NH4_f

3. Implemented natural dust: DUST_NAT_f and DUST_NAT_c
   windblown - DustProd_ml.f90
   Saharan BIC

4. AOD calculation: AOD_PM_ml.f90
----------------------------------------

          Affected modules:
    --------------------------
My_Aerosols_ml.f90
My_Derived_ml.f90
My_DryDep_ml.f90
My_Outputs_ml.f90
My_WetDep_ml.f90

Ammonium_ml.f90
BoundaryConditions_ml.f90
ChemFunctions_ml.f90
Chem_ml.f90
Derived_ml.f90
EmisDef_ml.f90
Functions_ml.f90
GlobalBCs_ml.f90
Io_Nums_ml.f90
MetFields_ml.f90
Met_ml.f90
ModelConstants_ml.f90
Runchem_ml.f90
Setup_1d_ml.f90
Setup_1dfields_ml.f90
____________
   New:
-----------
DustProd_ml.f90
AOD_PM_ml.f90

_______________
   From GenChem
---------------
CM_ChemSpecs_ml.f90
CM_ChemRates_ml.f90
CM_WetDep.inc
CM_Reactions1.inc
CM_Emis.inc
CM_DryDep.inc
CM_BoundaryConditions.inc

  In ZCM_EmChem09/
GenIn.species
GenIn.reactions
GenIn.shorthand
SAFE.CM_BoundaryConditions.inc

  In ZCM_vbs_tests/
GenIn.species
GenIn.reactions
SAFE.CM_BoundaryConditions.inc


------------------------
Makefile.SRCS


xxxxxxxxxxxxxx rv3_7beta6 Dave Oct 29 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Biogenics_ml:

Switch on BVOC_2010 methods, uses file EMEP_Euro
Add terpene emissions (only BVOC_2010 so far, older 2003 stuff not updated)

ZCM_EmChem09/GenIn.species: added for testing  rcbio(BIO_TERP,k)   = APINENE ;
ZCM_EmChem09/GenIn.reactions:
  added for testing  APINENE emissions, [OH] + OC_FIRE reaction

run.pl: use new BVOC file EMEP_EuroBVOC_KRS09.nc

xxxxxxxxxxxxxx rv3_7beta5 Robert/Dave  Oct 28th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

ModelConstants_ml - Minor update, now use TXTLEN_NAME to set length of some strings that used to be hard coded as 12 characters (now TXTLEN_NAME is set to 20 to allow for slightly longer chemical species names) TXTLEN_NAME is used in My_Outputs_ml, EmisGet_ml and MassBudget_ml

Also updated/revised the SOA scheme to a simpler version treating all primary OA from fossil fuel as nonvolatile (not yet decided if this is the "best" default SOA scheme)

Add PPM25_FIRE, + CO_FIRE to GenIn.species

run.pl - switched to "JAN" directory for emissplit - as this has the fire components

xxxxxxxxxxxxxx rv3_7beta4 Dave  Oct 26th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Aero_Vds_ml - small increase in rates (0.006 -> 0.008)

DryDep_ml -  removed special treatment of NO2, and added higher deposition rates
for nitrate-like particles

GenChem.pl - now outputs RO2POOL line in CM_Reactions1.inc if needed

mk.GenChem - copies SAFE.CM_BoundaryConditions_ml.f90 to CM_BoundaryConditions_ml.f90

(make sit easier to do rm CM_* in ZCM_EmChem09)

Solver_ml - now uses RO2_GROUP

Wesely_ml - added PMfS, PMfS distinction and AERO_SIZE

ZCM_EmChem09/GenIn.species - use PMfS or PMfN for sulphur-like (non-dissociating
) or nitrate-like (dissoctating) particles


xxxxxxxxxxxxxx rv3_7beta3 Dave  Oct 21st xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Small changes:

  Derived_ml   POD, AOT added in case statement

  My_Derived_ml SOMO0 added

  CoDep - small format change

xxxxxxxxxxxxxx rv3_7beta2 Dave  Oct 18th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Re-coded AOT treatment, also to get EU AOT from 3m grid ozone

AOTx_ml: now takes Sub(iL)%cano3_ppb, or Griod%surf_o3_ppb as appropriate

Biogenics_ml : some changes connected to BVOC_2010 methods.

Derived_ml: AOT changes

DryDep_ml: AOT changes

Inputs_LandDefs changed - extra variables

LandDefs_ml - BiomassD added. Also new Inputs_LandDefs.csv

LocalVariables_ml - added surf_o3_ppb, O3factor

ModelConstants_ml : DEBUG_ii etc introduced to ease change from EMEP to EECA

MosaicOutputs_ml: AOT+POD changes

OwnDataTypes_ml: renamed LC to TXTLC to help rember this is a string

run.pl:   dd1 introduced.... start day

xxxxxxxxxxxxxx rv3_7beta1 Dave  Sep 30th xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Quite large changes - mainly to simplify and clean up, partly in preparation
for new BVOC + soil water systems. The switch to "beta" is to emphasise that
now we are working towards the rv3_7 public domain release. Clean ups and
simplification are encouraged ;-)

Two new modules:

    DerivedFields_ml - stores f_2d, d_2d here (avoided circularity problems)
    MosaicsOutputs_ml

      Much moved to MosaicOutputs_ml
      Much removed and replaced by use of Grid% Sub(iL)%
      (ie much cleaner I hope!)

Changes in AOT, Fst calculations.

AOTx_ml  - simpler because of new o3cl types

Biogenics_ml - much changed. A work in progress

CellMet_ml -  small additions

DerivedFields_ml added - stores f_2d, d_2d here (avoided circularity problems)

Derived_ml - changes mainly due to DerivedFields_ml

DryDep_ml  - ** bug fix ** on cano3

DO3SE_ml   - mainly changed lu to iLC. Will try to keep same index throughout
             Unimod.

Io_Progs_ml : added datewrite - simplifies printout of current_date plus
              other data.

ModelConstants_ml - several new DEBUGs

MosaicOutputs_ml - moved loads of code from My_DryDep and DryDep_ml here
                   Still too messy, but most in one place at least.

   DryDep_ml     - much shorter because of above
   My_DryDep_ml  - *very* much shorter because of above. Almost nothing left :-)
   My_Derived_ml - *very* much shorter because of above.

OwnDataTypes : type o3cl added t cope with AOTX, PODY

PhyChe: extra debug coding - added subroutine debug_concs to save some lines

Setup_1d_ml: some  changes because of Bioegenic work. A work in progress

StoFlux_ml :  cleanup


xxxxxxxxxxxxxx rv3_6_24 Semeena, Anna & Alvaro Sep 09 2010 xxxxxxxxxxxxxxxxxxx
SR on FORECAST mode: script changes & bug fix

run.pl:
  * SR on FORECAST mode: allow SR & CWF options to coexist.
    Modify EMEP::Sr::getScenario to create CWF-SR scenarios.
    Use different dump files for different SR ensemble members.
  * One country per Job task: If multiple tasks are submitted (e.g. #PBS -t 1-56),
    use $ENV{'PBS_ARRAYID'} to select one element of @countries.
    This removes the need for multiple scripts for parallel partial-SR runs,
    as each country is handled by a single task and each task dealt
    independently by the pbs-job-loader.
  * MOZART-IFS BC in forecast mode: Use previous day BC if the file is not
    not yet available for the base-date.
  * Formatting/indentation.

Sites_ml: Fix SOURCE_RECEPTOR bug.
  Crash only on SR runs with message "SITES D2D NOT FOUND HMIX".
  This was because, on SR runs, D2_EXTRA is not added to wanted_deriv2d
  by Init_My_Deriv (My_Derived_ml). Therefore "HMIX" is not wanted,
  but is still required by SITE_XTRA_CODE (My_Outputs_ml).
  The impasse was solved by processing SITE_XTRA/SITE_XTRA_CODE only
  if(.not.SOURCE_RECEPTOR).

PhyChem_ml: No hourly, site & sonde outputs for SR runs.
  Though it says in the code that hourly and daily are not written out
  in the SR case, hourly output was still produced.
  Now hourly will be produced for FORECAST-SR runs.
  Hindcast SR runs will not produce hourly output.
  Site & sonde outputs will not be produced for SR runs

My_Derived_ml: Controlling the output variables.
  Not writing out the emissions, deposition velocities,
  resistances for different landuses and 3D variables.

SoilWater_ml, Nest_ml: gFortran pedantic fix for logical statements

xxxxxxxxxxxxxx rv3_6_23 Dave Peter  Aug 27 2010 xxxxxxxxxxxxxxxxxxxxxxxxx

xxxxxxxxxxxxxx rv3_6_23 Dave Peter  Aug 27 2010 xxxxxxxxxxxxxxxxxxxxxxxxx

Peter:
NetCDF_ml: comments put in beginning of interpolation routines  ReadField_CDF and Read_Inter_CDF

Dave:
GenChem.pl - length of species%name extended from 12 to 22

DryDep_ml, Landuse_ml: LU_cdf variable removed - not used

DryDep_ml, StoFLux_ml:  debug statements re-formatted to fit < 78 chars per line.


xxxxxxxxxxxxxx rv3_6_22 Dave          Aug 23 2010 xxxxxxxxxxxxxxxxxxxxxxxxx

More  GenChem and SOA-related changes

GenChem.pl  --- now used to set NEMIS_FILES and EMIS_FILES. Add wanted
emission file as prefix to rcemis, e.g.:

    nox:rcemis(NO,k)                           = NO    ;
    nox:rcemis(NO2,k)                          = NO2    ;
    sox:rcemis(SO2,k)                          = SO2    ;
    sox:rcemis(SO4,k)                          = SO4    ;
    co:rcemis(CO,k)                           = CO    ;
    voc:rcemis(C2H6,k)                         = C2H6    ;
    voc:rcemis(NC4H10,k)                       = NC4H10    ;

With modified:
   ZD_xx/GenIn.reactions
   (also cleaned up - commented-out dry dep lines removed)


NOTE: these prefixes are only used for the standard gridded emissions files
 - the ones that were in EMIS_FILES. We also have rcbio and possibly rcnh3
for isoprene, terpene, etc.

SOA_ml removed!!
 REplaced by ZD_OZONE/My_SOA_ml  or ZD_VBS/My_SOA_ml

ZD_VBS added

ZD_VBS/My_SOA_ml - now uses PCM_GROUP, PCM_HELP_GROUP from GenIn.species

ZCM_vbs_tests added - just for testing by Robert/Dave.

My_Aerosols_ml : ORGANIC_AEROSOLS flag removed. Moved to My_SOA_ml

EmisDef - now uses CM_Emis.inc  -- hence is chemistry independent :-)

Use modified rcbio:
  Runchem_ml - uses modified rcbio
  Setup_1d_ml - uses modified rcbio
  Setup_1dfields_ - stores modified rcbio
  Solver_ml


xxxxxxxxxxxxxx rv3_6_21 Dave/Robert   Aug 20 2010 xxxxxxxxxxxxxxxxxxxxxxxxx

More SOA consistency and modified soilwater handling when USE_SOILWATER
set true --- this *will* change results! Lower DryDep when soil
is dry -> more O3, etc. in Southern Europe


Aqueous_ml - modified for consistency with SOA module - uses
      Fpart for semivolatile species. Small changes in notation
      also

CellMet_ml - added fSW, Grid%fSW

Derived_ml - used BVOC array t set NatEmis Derived, instead of hard-coded C5H10.
             changed old write_debug to write_debugadv
            added simpler write_debug for other components than adv

DO3SE_ml - uses new fSW instead of older DO3SE method.
           Added debug_flag to g_stomatal + f_SW in DEBUG outputs

DryDep_ml  - modified for consistency with SOA module - uses Fpart for semivolatile species.
      Added fSW to prepare for soil-water changes.
      Small changes in notation also.

GenChem.pl - modified for SOA treatment. Use typ=2 in GenIn.species
  and add SOA, ASOA etc. in groups to get e.g. SOA_GROUP in CM_ChemSpecs_ml.
  Uses FIRST_SEMIVOL instead of FIRST_SOA, same for LAST

  Note that the DeltaH and Cstar info is now part of chemicals%

LocalVariables_ml - added fSW

mk.GenChem - removed CM_SOA_ml

ModelConstants_ml: Added USE_SOILWATER

Rsurface_ml - more debug options

run.pl - sets USER from $ENV{"USER"} - easier and safer!

Sites_ml - improved debug options

SOA_ml - uses FIRST_SEMIVOL instead of FIRST_SOA, same for LAST

SoilWater_ml - start of "real" soil-water handling, generating fSW
    from SoilWater_deep. Not used yet.
     (HIRLAM-tested only)

StoFlux.f90 - bug fix on evapotranspiration calculation - avoid div  by zero

ZCM_EmChem09/GenIn.species - some fake species added to test SOA+GenChem.
   Commented out for now, just uncomment to try.


xxxxxxxxxxxxxx rv3_6_20      Alvaro  18th Aug 2010

MOZART-IFS BC in forecast mode: Use top boundary from BC file.

Nest_ml:
  * Use top boundary from BC file.
    The new logical parameter TOP_BC controles this feature.
    Top boundary is read into new variable xn_adv_bndt.
  * Bug fix. Lateral BC were wrongly set to zero.
    Subroutine read_newdata_LATERAL read boundary values into local variables,
    instead of global ones of the same name (xn_adv_bnd{w,e,s,n}).
  * Bug fix. The assignment itime=Next/itime=Next_BC after the time finding
    loop on reset_3D/read_newdata_LATERAL) causes that the wrong record to be read
    when the "right date-time" is not found.
    When there is no "right date-time" on the IC/BC file the index 'n'
    is outside of the valid range for records, and therefore the program crashes
    when trying to read beyond the last record.
  * Boundary variables (xn_adv_bnd{w,e,s,n,t}) are only allocated on the processors
    that will use them
  * New interer variables iw, ie, js, jn & kt contain the indexes corresponding
    to the west, east, south north and top boundaries.
  * Clean up & indentation.

ModelConstants_ml:
  * Correct string lenght for DomainName="EMEPCWF-0.25degEurope"
  * Clean up & indentation.

xxxxxxxxxxxxxx rv3_6_19   Dave  17th Aug 2010


Bug-fixes again .... old ones (rv3_5_15!) which somehow got lost

Derived_ml:

   BUG fix: somo_calc. SOMO35 was calculated incorrectly (somo_calc used index, wereas
   XYCL should be used, to get the 35.). Added debug_flag to somo_calc also.
   debug flags added to somo_calc

AOTx_ml: BUG_fix: scaling with dt_advec/3600 removed. dt-scale does this.


xxxxxxxxxxxxxx rv3_6_18   Dave  16th Aug 2010

Bug-fixes! WDEP and DDEP of groups didn't include all species.
(bug started from rv3_5_27 probably)

Aqueous_ml - added debug_flag to WetDeposition call

Derived_ml - IsSurf replaced by ik==0

GenChem.pl -  bug fixed. Hadn't spotetd that aNH4 was same as ANH4 for wdep groups - now
     now uses sub spec_equal

ModelConstants_ml
   - added DEBUG_WETDEP, DEBUG_MY_WETDEP

ZCM_EmChem09/GenIn.reactions - added rcnh3 in GenIn.reactions, used for Haldis's
     system (was in CM_Reactions2.inc. Remember - stuff in CM_ is generated by
     mk.GenChem, so new equations should be written in GenIn.reactions, not
     CM files.)

ZD_OZONE/My_WetDep_ml - added debug_flag

xxxxxxxxxxxxxx rv3_6_16      Alvaro  16th Aug 2010

Use MOZART-IFS BC in forecast mode

Derived_ml.f90 - bug-fix on uggroup outputs

Nest_ml:
  * Add 'bc' and 'bc_set' types to expicitelly define which bc's are needed
  * Additonally, some do-->forall replaces and gfortran-pedantic fixes

ModelConstants_ml:
  * Add DEBUG_NEST_ICBC parameter

run.pl:
  * Additional code for handeling forecast BC files from MOZART-IFS

xxxxxxxxxxxxxx rv3_6_15      Peter   11th Aug 2010

Some changes to make the model portable to different machine/compilers
(and some cleaning)

Advection_ml:
Some simplifications to test for allowed dt_advec.
Cleaning/commenting of convection_pstar

Met_ml:
"readneighbors" is made MPI_safe (could hang for very large grids).

NetCDF_ml:
recursive ReadField_CDF (so we don't need to use compiler options)

Derived_ml:
splitted "if(present(iIs3D).and.Is3D)", as xlf (IBM/njord) seems to
test Is3D before looking if it is present

Unimod.f90:
Moved call parinit upward, because parinit defines MaterProc, which was used before it was set.



xxxxxxxxxxxxxx rv3_6_14      Dave   9th Aug 2010

Derived_ml: XYCL renamed to Threshold :-)
            EVAP, SoilWater, PREC_WDEP outputs added as Derived

DryDep_ml: MMC_GSTO added

LocalVariables_ml:  EvapTransp added

ModelConstants_ml: DEBUG_SOILWATER added

OwnDataTypes: XYCL renamed to Threshold, extra outputs in print

Sites_ml: SITE_XTRA_INDEX, SONDE_XTRA_INDEX commented out - not used
and a pain!

StoFlux_ml: Evapotranspiration added  (1st attempt, should be optimised)

My_Derived_ml: outputs for POD for ex-post analysis, + EVAP, SoilWater

               Code for "NOX" commented out. Have both NO and NO2 as
               outputs anyway, and should treat NOX as just another
               group.

My_Outputs_ml: ITE_XTRA_INDEX, SONDE_XTRA_INDEX commented out

ZD_OZONE/NH3variables_ml   removed. Use version in Unimod main directory
ZD_OZONE/NH3variables_m_variation_ml removed. Use version in Unimod main directory
ZD_OZONE/Tmp_Met_ml removed. Use version in Unimod main directory

run.pl  TREND_RUNS added to get consistent time-series


xxxxxxxxxxxxxx rv3_6_13      Alvaro,     4rd Aug    2010

run.pl: pre-defined  benchmark datasets

The benchmark sets indicate the grid, time period (full year)
and emissions to use.
There are, so far, two benchmark sets (my %BENCHMARK):
  %BENCHMARK = (grid=>"EMEP" , year=>2005,
                emis=>"Modrun07/OpenSourceEmis"     );
  %BENCHMARK = (grid=>"EECCA", year=>2007,
                emis=>"Modrun09/2009-Trend2007-CEIP");

There are two additional keys to fine tune the benchmark behaviour:
  $BENCHMARK{'debug'}   = 0;  # chech if all debug flags are .false.
  $BENCHMARK{'archive'} = 0;  # save summary info in $DataDir

if $BENCHMARK{'archive'}, summary info is copied to:
  $DataDir/Benchmark/$GRID.$year/BM_$testv-$Chem.$USER

You can find such info for rv3_6_10-EmChem09 (run in titan)
for both EMEP.2005 and EECCA.2007 benchmarks in:
  titan  $DataDir=/xanadu/project/metno/emep/Data/Benchmark/
  stallo $DataDir=/global/work/mifapw/emep/Data/Benchmark/

Makefile_titan: minor update

xxxxxxxxxxxxxx rv3_6_12      Dave,       3rd Aug    2010

preliminary SoilWater outputs added for testing

Derived_ml - changed EcoArea handling

OwnDataTypes_ml - extended size of TXTLEN_SHORT to 18

PhyChem_ml - calls Set_SoilWater

Some extra debugs added for BVOC work, e.g. BIODZ in Emissions


xxxxxxxxxxxxxx rv3_6_11     Alvaro,  2nd (committed 4th) August 2010

Updates relted to the forecast mode

Unimod & PhyChem_ml:
  Bug fix in forecast mode. The hourly output for the "zero hour" was wrong.

ModelConstants_ml:
  Add GEMS 0.25 extended (Eyjafjallaj\"okull) and MACC 0.20 domain definitions.

Derived_ml:
  Allow daily output for SOURCE_RECEPTOR calculations in FORECAST mode

Nest_ml:
  only 1 FORECAST_NDUMP (re-start file) by default

Advection_ml:
  advection timestep (dt_advec) set assign_dtadvec according to grid resolution
  also in FORECAST mode. Before it was set to 10 min, independently of the
  grid resolution. Now it is set as for non FORECAST runs.
  GEMS025 domain 0.25 deg resol --> GRIDWIDTH_M~=27.8 km --> dt_advec=20 min
  MACC02  domain 0.20 deg resol --> GRIDWIDTH_M~=22.2 km --> dt_advec=20 min

Output_hourly:
 -Only postive hr_out%max values will be check for excedance.
 -New hourly output types (hr_out%type)
    BCVugXX     ug/m3, ugC/m3, ugS/m3, ugN/m3 at model mid-levels
    ADVugXXg    GROUP output in ug/m3 at the surface
    BCVugXXg    GROUP output in ug/m3 at model mid-levels
    PMwater     PM water content (PM_water) at model mid-levels
    COLUMN      Column output in ug/m3, ugC/m3, ugS/m3, ugN/m3 or molec/cm2

My_Outputs_ml:
 -Add standard forecast houtly output hr_out (commented).
 -Define to_ug_S and to_ug_N as arrays, matching to_ug_ADV definition
  for ug output ("ADVugXX" hourly output type).
  Add to_ug_C, to_molec_cm3 and to_molec_cm2 conversions.

My_Outputs_ml, Output_hourly & NetCDF_ml: selected model levels on hourly output
 -New parameters SELECT_LEVELS_HOURLY (logical) and
  LEVELS_HOURLY (array of level indexes) indicate if and which levels
  to output (My_Outputs_ml).
 -Modify hourly_out (Output_hourly), Init_new_netCDF and CreatenetCDFfile (NetCDF_ml)
  to allow feature. CreatenetCDFfile has a new optional parameter 'KLEVcdf'
  to hold levels to be outputed.
 -Backwards comptability provided by SELECT_LEVELS_HOURLY=.false. (default).

NH3variables_ml.f90: gFortran compliance...

xxxxxxxxxxxxxx rv3_6_10    Dave,       3rd Aug    2010

FOREST_FIRES reset to false in EmisDef. Robert has noticed that
   results depend on processor number, so there must be a bug.

NH3EMIS_VAR test added before linking NH3 sector data in run.pl

NB - there is no read permission on Haldis's sector NH3 file, so
the code won't  run with NH3EMIS_VAR anyway. Will fix once
Haldis returns.

xxxxxxxxxxxxxx rv3_6_9     Haldis,    22st July   2010

New temporal ammonia emissions, only for a restricted area.
Default is set as the old ammonia emission,
new temporalemissions can be choosen by setting NH3EMIS_VAR=true in EmisDef
and in run.pl
This method requires 10m wind from meteorology, this exist in meteofields for
2006 and 2008

New modules:
NH3Emis_variation_ml.f90:
                sets up scaled emissionfactors, so they are never higher
                than 1. Uses then the potential emission factor from
                Tmp_ml.f90

Tmp_Met_ml.f90 (contains temporary reading of meteorology and reading of
                emissions):
                -sets up the potential emission factor in each grid at each
                 timestep
                -calculates the time for maximums in the gauss functions
                -reads the NH3 emissions, and make them equal to the reported
                 emissions (from EmisDef_ml and EmisGet_ml), scale them to 50km
                 grid and surface fluxes instead of tonn pr year
                -reads in T2m and 10m winds from meteofiles
NH3variables_ml.f90 (contains variables used in Tmp_Met and NH3Emis_variation)

Minor changes in the following files:
Unimod.f90
Setup_1d_ml.f90
Setup_1dfields_ml.f90
Runchem_ml.f90
Par_ml.f90
Io_Nums_ml.f90
EmisGet_ml.f90
EmisDef_ml.f90
MetFields_ml.f90
Met_ml.f90
Makefile.SRCS
Solver.f90
CM_Reactions2.inc
Country_ml.f90
ModelConstants_ml.f90
run.pl


xxxxxxxxxxxxxx rv3_6_8     Alvaro,    21st July   2010

Fix PM in ppb bug in Sites_ml and Derived_ml (rv3_5_26), additional changes.
Small bug fix for Read_Inter_CDF.  Wrong data projection from file
Small bug fix in forecast mode

Derived_ml & My_Derived_ml:
  use D3_OTHER to select additional D3 output.

NetCDF_ml: Wrong data projection from file (Read_Inter_CDF)
  data_projection might get non-pritable after the end of word
  when not inializes. Set default value for data_projection="".

run.pl:
 -Small bug fix in forecast mode. The dump (re-start) file name was wrong.
 -Update $emisdir to MACC02 version.

Makefile_titan:
  add debug flags

xxxxxxxxxxxxxx rv3_6_7     Alvaro,    19th July   2010

Fix PM in ppb bug in Sites_ml and Derived_ml (rv3_5_26)

Sites_ml & My_Outputs_ml:
  use to_ug_ADV (My_Outputs_ml) to calculate "PM25" and  "PMco"
  from SONDE_XTRA.

Derived_ml:
  - Define D3_ug_PM25 and D3_ug_PMc according its SURF_ug equivalents
    in subroutine Define_Derived.
  - Extend uggroup_calc to 3D or 2D(surface) ussage.
  - Add "PM25GROUP" and "PMcGROUP" 3D tyes to subroutine Derived.

Makefile_gfortran:
  - add option -ffree-line-length-none so gfortran-4.2 (Ubuntu 8.04)
    can deal with long lines from GenChem.
  - improve 'depend' target

xxxxxxxxxxxxxx rv3_6_5     Peter, Dave,    9th June   2010

Advection_ml: Bug in rv3_6_2 correction:should not multiply bi ps-PT too!

NetCDF_ml - deallocate added for Nvalues, small debug change

NetCDF_ml: added "recursive" for ReadField_CDF routine

xxxxxxxxxxxxxx rv3_6_4     Dave,    9th June   2010

Advection_ml returned to former, otherwise normal runs give NaN
   I have added the new suggestion as a commented ourt block though
   awaiting attention from Peter
   see "QUERY" bit.

NetCDF_ml modified

   known_projection added as optional. Allows user to
   specify e.g. MEGAN data as "lon lat", without need
   to modify original MEGAN files.

   Lots of debug statements added! Will reduce later

   FillValues treatment extended+safer  (hope Peter agrees!)

Interpolation_ml - more

xxxxxxxxxxxxxx rv3_6_3     Dave,    9th June   2010

CM_WetDep.inc added to ZCM_EmChem09.  Note that in principal
this isn't needed. One gets these files by typing mk.GenChem.
Will clean up this behaviour one day, and just keep
GenIn files rather than the CM_ outputs.


xxxxxxxxxxxxxx rv3_6_2     Peter,   8th June   2010

Advection_ml: divide xn_advec by max(1,ps3d) instead of ps3d also if no convection is used.
This will put a very small value for the concentrations, instead of NaN, in the case where
wind fields are very divergent.
(Joffen reported that the advection gave NaN on north pole)

xxxxxxxxxxxxxx rv3_6_1     Dave,   4th June   2010

New Module: InterpolationRoutines_ml

 - created as merge of bilinear code from Functions_ml and Peter's
  grid2grid_coeff. Small caller routine Nearest4 added, as well as
  test-code which can be uncommented for stand-alone testing.

xxxxxxxxxxxxxx rv3_6        XXXXXXXXX TO BE BACK_ADDED XXXXXXXXXXXXXXXXX

REPORT 1/2010 version will be added as a branch. Note that rv3_6 was
really based upon rv3_5_25, so things got a bit confused here. Still,
no worries ;-)


xxxxxxxxxxxxxx rv3_5_27    Dave,  28th May   2010

GenChem.pl changes:   GenIn.species is now a comma-separated file which
  can be edited in gnumeric, and contains details of the dry and wet dep,
  also other params such as extinction coefficient and VBS details.

ZCM_EmChem09:
    GenIn_species.csv created as above
    GenIn.Reactions - deposition stuff removed

Derived_ml     - extended for more groups (tNO3, OXN...)

GlobalBCs_ml   - test about ZD_OZONE removed

ModelConsants_ml - model changed to EMEP-MSC-W instead of ZD_OZONE

ChemSpecs_bgn_ml, Chem_ml: Content of ChemSpecs_bgn_ml moved into Chem_ml

xxxxxxxxxxxxxx rv3_5_26    Dave,  26th May   2010

More GenChem enabled, with use of "groups" to avoid hard-coded indices:

GenChem.pl and mk.GenChem  now in Unimod directory. Edit the ZCM_xxx/GenIn files
to change reactions, depositions, etc.

mk.GenChem - runs GenChem.pl and copies CM to current directory.

GenChem.pl

   1) Dep changes:
   GenChem now produces CM_WetDep_ml

   Define which species are deposited in GenIn.reactions, e.g.

     DRY_NO2    -           NO2      =    ;
     DRY_SO2    WET_SO2     SO2      =    ;
     DRY_FIN    WET_SO4     SO4      =    ;
     DRY_FIN    WET_PMf     aNH4     =    ;
     DRY_FIN    WET_PMf     pNO3_f   =    ;

  The idea is that we have some "CALC" compounds defined in My_WetDep_ml,
  My_DryDep_ml, and can give the deposition rates of the species in terms
  of these. Thus, we can use the WET_PMf rate for any fine particle,
  we just need to define it once.

  Aqueous_ml - rewritten to use the new CM_WetDep_ml approach.

  DryDep_ml - rewritten to use the slightly renamed CM_DetDep_ml indices

   2) Groups
   Groups are defined in GenIn.species, e.g.

     SO4   1  SO4        -  8.5  0  0      PM25,SIA,SOX,AOD  !

   - adds SO4 to PM25_GROUP, SIA_GROUP, SOX_GROUP, AOD_GROUP
    These groups can then be used in the rest of the code, so that
    now we can get things like PM25 as the sum of all species in
    PM25_GROUP; Avoids lots of lijnes with IXADV_PPM25, IXADV_SO4 ..
    etc.

   - the 8.5 0 0 are for AOD and VBS calculations. Will refine one day,
     but these numbers are now added as species(..)%extC, %Cstar, %DeltaH
     in CM_ChemSpecs_ml

  Derived_ml changed with such group calculations. See pmgroup_calc
  routine.

  Also:

    spotted outputs of PM in ppb, which has to be wrong. PM c an only have
    mass output since we don't know the mol. wt.

    Affects Derived_ml (3d outputs) and Sites_ml

Name changes (provisional)

  aNO3 -> pNO3_f
  pNO3 -> pNO3_c
  SSFi -> SeaSalt_f
  SSCO -> SeaSalt_c

In Ammonium_ml,

xxxxxxxxxxxxxx rv3_5_25    Peter  28th April 2010

New version of ReadField_CDF. Simpler and more robust (when FL are below surface).


xxxxxxxxxxxxxx rv3_5_24    Peter  27th April 2010

In order to be able to read the aircraft emissions given in flight levels, the
ReadField_CDF routine has been adapted for this very specific task.
It must use monthly surface pressure average. This is given in a separate file,
which is produce from IFS 0.2 degrees 2008.
The Makefile must be adapted for recursive calls.
Gives slightly different results, since topography is taken into account now

Files modified:
NetCDF_ml.f90, Emissions_ml.f90, run.pl, Makefile, Makefile_stallo, Functions_ml.f90,ModelConstants_ml
(put NPROCX=4, since there are only advantges running on stallo with 8 compred to 6 CPU)


xxxxxxxxxxxxxx rv3_5_23    Peter, Dave  23rd April 2010

ReadField_CDF:
Can read latlon fields with undefined values. Define UnDef to give value put into
 the gridcells which are not defined.

PhysicalConstants_ml: earthradius


xxxxxxxxxxxxxx rv3_5_22    Dave,  22nd April 2010

DryDep, My_DryDep, My_Derived

Bug-fix needed when reducing number of Derived outputs:

  Hard-coded numbers (1..3) in Mosaic_Met for RTH replaved by MMC_RH
  MMC_USTAR etc.  Prevents assignment when variables now asked for in My_Derived

Also number of default outputs reduced. Will continue this process further
one day. Use of d_2d and EXTRA_SITES in My_Outputs also very crude - should
really be improved,... one day.

xxxxxxxxxxxxxx rv3_5_21    Peter, Alvaro,   21st April 2010

Two bugs found by Alvaro (CWF):
Nest_ml: istart,jstart,iend,jend, was wrongly defined in mode 11,12 or forecast

NetCDF_ml:"if((abs(rdays-rdays_time(1))>0.00001))"
replaced "<" with ">". Used when outputting 3D on a limited number of levels.


xxxxxxxxxxxxxx rv3_5_20    Agnes,   19th April 2010

GlobalBCs_ml   - updated for 2008 data, also default of 1998-2008 average

xxxxxxxxxxxxxx rv3_5_19    Peter,   15th April 2010

Cleaned the  ReadField_CDF routine

xxxxxxxxxxxxxx rv3_5_18    Dave,   14th April 2010

run.pl

    -- modified to do some checks which will avoid the previously
    unhelpful crash of the code with missing rough.dat error. This
    was 99% of the time casued by $GRID being set to one domain in
    run.pl, but the ModelConstants_ml had an other domain.

    We now check the x-dimension of ModelConstants, and in  run.pl:

 die "Domain mis-match Model: $XDIM Grid $GRID" if (
    ( $GRID eq "EMEP" && $XDIM != 170 ) or
    ( $GRID eq "EECCA" && $XDIM != 132 ) or
    ( $GRID eq "GLOBAL" && $XDIM != 360 ) );

In addition, run.pl now compares the CM_ChemSpec file in your
Unimod directory with that in ZCM_$Chem. This might help if we have an EmChem09RF
version for example. The $Chem variable is added to runlabel2 and so
stored in the netcdf files also.

  $runlabel2 = "${testv}_${Chem}_${scenario}_$year\_Trend$iyr_trend";

xxxxxxxxxxxxxx rv3_5_17    Peter,  13th April 2010

Met_ml: bug in def of gl_fdom when lon lat gl_fdom(i,j) -> gl_fdom(i,1)
NetCDF_ml: ReadField_CDF also accep files without time dimension

xxxxxxxxxxxxxx rv3_5_16    Peter,  12th April 2010

Convection: (Advection_ml), bug in flux limitation (only used with 2008 meteo)

Aircraft emissions: assume k coordinates as first index in airn (more efficient,
but not compatible with the syntax of most other arrays)

NetCDF_ml: Can  read any projection, given lat and lon of each gridcell.
First (primitive version...)

xxxxxxxxxxxxxx rv3_5_15    Dave,  11th April 2010

Derived_ml

   BUG fix. SOMO35 was calculated incorrectly (somo_calc used index, wereas
   XYCL should be used, to get the 35.). Added debug_flag to somo_calc also.

My_Derived_ml. Just some comments updated

xxxxxxxxxxxxxx rv3_5_14    Peter

Upgrade of ReadField_CDF.
1) Can read 3D data (but no interpolation in vertical yet).
(In progress: 2) Can  read any projection, given lat and lon of each gridcell.)

Also corrected two bugs (wrote in Rvar with 1st dimension limax instead of
maxlimax and omitted IRUNBEG)

NetCDF_ml
ForestFire
LandPFT
Emissions
Par_ml

Aircraft: new emission file
run.pl
    $ifile{"$DataDir/AircraftEmis.nc"} = "AircraftEmis.nc";

Unimod.f90

Setup1d_ml:
Bug in AIRNOX (introduced in rv3_4? Effect: no AIRNOX below KCHEMTOP).
if ( AIRNOX  ) then k=KCHEMTOP,KEMISTOP,KMAX_MID

Why is AVOG   = 6.023e23 (instead of 6.02214179e23)?

 + Dave....

swapped  gl_glob => gl_fdom, gb_glob => gb_fdom, affects:

GlobalBCs_ml.f90
GridValues_ml.f90
Landuse_ml.f90Met_ml.f90
Met_ml.f90
NetCDF_ml.f90

xxxxxxxxxxxxxx rv3_5_13  Dave/Peter  Apr 6th  2010

** Bug ** in Country_ml: The default country (index 67), had timezone=0 (meaning GMT),
should be -100 (meaning longitude determined).
This has been introduced in rv2_7_1 (in 2007, when introducing a lot of "shipping" countries)
Should affect mostly (only?) global runs.

Derived_ml:

  SURF_ppbC_VOC added in Derived_ml.
  Older Setup_VOC code moved into Setups()

My_Derived_ml : SURF_ppbC_VOC added

ModelConstants_ml : re-arranged to put FFULLDOM.. and RUNDOMAIN
  closer together - will hopefully help to stop errors (e.g. missing
  rough.dat) caused by mis-matched domain sizes.


xxxxxxxxxxxxxx rv3_5_12  Dave   Mar 31st  2010

Small corrections:

1) to continue use of logical dt_scale instead of real:

My_Derived_ml
EcoSystem_ml

2) tidy-ups spotted by gfortran's pedantic mode:

Emissions_ml - tabs  and some unused variables removed

LandPFT_ml - space added in "Emt_ "
Met_ml     - very long line (<130 chars) shortened. Should try for < 78
My_Outputs_ml - spaces in SONDE_XTRA init

xxxxxxxxxxxxxx rv3_5_11  Peter  Mar 29th  2010

Convection routines included. Not used by default.
must set use_convection=.true. in ModelConstants_ml to be used
Modified:
MetFields_ml
Met_ml
Advection_ml
ModelConstants_ml

Not tested!

xxxxxxxxxxxxxx rv3_5_10  Dave  Mar 25th  2010

Main change:
Emissions added as standard netcdf outputs. Done so far for
"Grid" emissions and isoprene. Not yet aircraft,forest-fires
etc.

Preparatory changes: some code for use of LPJ landcover data


Emissions-associated changes:
-----------------------------
Biogenics_ml:   EmisNat array added to store emissions

Derived_ml:  processing of EmisNat and SumSnapEmis added with
            NatEmis and SnapEmis types.

            dt_scale now changed to logical. If set true
            the outputs are mutliplied by dt_advec*scale, if
            false just by scale.

            Some tidy-ups

Emissions_ml : SnapEmis processing added

GridValues_ml:  Array GridArea_m2 added  ( = GRIDWIDTH_M*GRIDWIDTH_M*xmd(i,j)


OwnDataTypes_ml: dt_scale now changed to logical.

Setup_1d_ml:  EmisNat processing added


PFT (plant-functional-type)/LPJ changes:
----------------------------------------

** LandPFT_ml ** added to read LPJ/PFT

DO3SE_ml: more debug options

DryDep_ml -  Call SetLandUse moved to Unimd.f90
             Possibility of LU_cdf removed for now

LandDefs_ml - added %has_lpj and %pft to LandType defs and
              Inputs_LandDefs.csv

Landuse_ml - uses LandPFTs - just for preliminary testing and
             comparison so far. Many debug statements.

ModelConstants_ml : DEBUG_LANDPFTS added

Unimod -  Call SetLandUse moved here from DryDep

Other
-----

My_Outputs - some of the column outputs commented out


xxxxxxxxxxxxxx rv3_5_9  Peter  Mar 23rd  2010

Small change in ForestFire_ml:
do not use forestfire if year>2007 (we don't have data yet).
Landuse_ml: do not "use" Read_Local_Inter_CDF

xxxxxxxxxxxxxx rv3_5_8  Dave  Mar 22nd  2010

Interim-change while modifying landuse changes:

NetCDF_ml: debug_flag added to ReadField_CDF
           stop replaced by StopAll

           Read_Local_Inter_CDF commented out for now - not used
           wit current system. Reconsider later

xxxxxxxxxxxxxx rv3_5_7  Dave  Mar 15th  2010

(Peter:)Bug in ReadField_CDF (NetCDF_ml) : did not work if file is not 1 degree resolution

Bug-fix - added HONO dry dep into system (was missing)

Needs attention: Shoud give 2nd look to molwt for PPM25_FIRE

*** Main change **** (Works with EmChem09 only so far!!)

Added grouping-ability to GenChem, which now extends CM_ChemSpecs_ml
with e.g.:

 integer, public, parameter, dimension(2) :: &
             PMCO_GROUP     = (/ PNO3,PPMCO /)

  integer, public, parameter, dimension(2) :: &
             SOX_GROUP     = (/ SO2,SO4 /)
..
  integer, public, parameter, dimension(4) :: &
             SIA_GROUP     = (/ SO4,PNO3,ANH4,ANO3 /)

  integer, public, parameter, dimension(6) :: &
             PM25_GROUP     = (/ SO4,ANH4,ANO3,PPM25,PPM25_FIRE,SSFI /)

! ------- Dry dep      species ------------------
  integer, public, parameter, dimension(6) :: &
               DDEP_OXNGROUP = (/ HNO3,PAN,NO2,ANO3,MPAN,PNO3 /)
  integer, public, parameter, dimension(2) :: &
               DDEP_SOXGROUP = (/ SO2,SO4 /)
  integer, public, parameter, dimension(2) :: &
               DDEP_RDNGROUP = (/ NH3,ANH4 /)

These "groups" are to be "use"d in the rest of Unimod,  so that one
doesn't have to hard code the indices separately.  btw I haven't added
a PM10 group, since that is the sum of PM25 and PMCO. We should think
how to code some of these supergroups to avoid uncessessary operations
in the model.

I have just managed to re-instate one of the older groups so far,
SIA which is now SURF_ug_SIA. Other groups, e.g. PM25 can be
quickly added following this pattern though.

Background: defining such "groups" in the GenIn.species file and letting
Genchem handle them automatically has many advantages.  Not least, we can
change chemical scheme without breaking the code or making errors. For
example, the old code for PM25 defined just a few species. In future
we may want to add seveal new species such as OC, EC, from fires, or
SOA. Or we may want to use a carbon-bond scheme or CRI.

The principal being aimed at is that GenChem needs to know about the
chemistry, Unimod shouldn't.


xxxxxxxxxxxxxx rv3_5_6  Peter  Mar 12th  2010

Advection_ml (PhyChem_ml):
Use always the advecdiff_poles routines. (until now it was only used in the global runs,
in other runs advecdiff was used).
advecdiff will be completely removed later (after a test period to see that we don't need it).

advecdiff_poles is also slightly changed:
no renormaliztion with ps-PT between x, y and vertical advection.
division by max(psi,1.0) instead of psi. NB: bad winddata will not crash the model anymore,
and therefore we won't get any warning.

ForestFire/NetCDF: safer interpolation routine


xxxxxxxxxxxxxx rv3_5_5  Dave  Mar 9th  2010

BLPhysics

    - added routines for O'Brien, Jericivic Kz, Seibert Kz and Hmix
    - parameters to switch Kz, Hmnix routines
    - parameters for e.g. USTAR_

    default options give:
      Hmix from Jericevic Rb method
      Pielke/Blackater Kz outside PBL
      Kz from O'Brien for unstable conditions
      Kz from Jericevic/Grisogono for stable conditions

   with DEBUG_BLM true, the log file will compare Hmix and
   Kz from all routines for the debug cell.

Met_ml

  Big rewrite of tiphys, now called BLPhysics

  met_derived now has nt argument (1 or nr as appropriate),

  More documentation at start

  Removed most Kz, Hmix calculations - now done by routines from BLPhysics_ml.

  Code could be optimised further, but is only called every 3 hours so
  should be okay. Should delete 3D Kz though and keep just SigmaKz as
  3-D fields.

MetFields_ml

   - invL_nwp added. Query on limits, also ustar?
   - limit on ustar over land > 0.1 m/s (or MIN_USTAR_LAND)

ModelConstants_ml

    OFFSET_X, OFFSET_Y introduced to make coordinates match
     EMEP or EECCA grids. (Set to zero for EMEP, -35,-11 for EECCA


xxxxxxxxxxxxxx rv3_5_4  Haldis/Dave  Feb 28rd 2010

Start of NWP_Kz work and testing of other Kz options

  Met_ml, MetFields_ml now deals with Kz read in from met

  BLPhysics - Brost+Wynaarg  formula added for testing
              SigmaKz-

  Derived_ml.f90  AddNewDeriv( "D3_Kz", ....

  GlobalBCs_ml.f90  Macehead O3 added as 2008=2007

  My_Derived_ml.f90   D3_OTHER  = (/ "D3_Kz          " /) added

  My_Outputs_ml.f90  SONDE_XTRA=  ....  "xksig"  added


  Rename:  xksig becomes  Kz_m2s
           skh   becomes  SigmaKz  (Kz in sigma coords)

xxxxxxxxxxxxxx rv3_5_3  Dave  Feb 22nd 2010

*** MetFields_ml ***  now has all met fields defined here

  Bug spotted?? Not understood though - SST was defined as
  3d (:,:,KMAX:MID) field, but setting to 2d (:,:,NMET)
  doesn't change results. Don't know why.

BLPhysics - several Hmix options added. Results for "TI" physics
      zi checked  and identical to those of tiphys routine. Will
      replace completely soon, getting rid of several routines.
      For now the routines in BLPhysics are waiting for use.

ChemFunctions_ml, EPSIL in friemer for safety
      - div by zero spotted by Peter

GridValues_ml
      A, B replaced by A_bnd, B_bnd

Various small tidy ups

xxxxxxxxxxxxxx rv3_5_2  Dave  Feb 18th 2010

Met_ml   - Bug-fix  (many years old bug!!!)
           real winds used in Ri dvdz calculation.
           New arrays u_mid, v_mid used, and u_ref simplified too.

*** MetFields_ml **** new. Will gradually move most met fields here, and
       keep Met_ml for subroutines and processing.


*** felt stuff removed :-)   (100s lines gone, double :-)

 changes in many modules to use MetFields for wind, ps, sdot


xxxxxxxxxxxxxx rv3_5_1  Dave  Feb 18th 2010

My_DryDep_ml -- Bug-fix!! (first_vgr_call didn't work as expected)

And renaming of wind fields to u_xmj, v_xmi
(Peter's suggestion - these have not really physical meaning, they are actually divided by the mapping factor in the perpendicular direction).

NOTE: The many-year old problem with Ri being calculated with the wrong winds is
still not corrected. I've added some !WAIT marks to relevent bits of the code to
help remind about this.....

xxxxxxxxxxxxxx rv3_5  Dave  Feb 15th 2010

Dry deposition finally settles down .., so I stop the beta's and move
straighy to rv3_5.

New module:

BLPhysics_ml.f90 ---  Intended as a place to put calculation of Hmix, Kz, etc.
  Will move more of tiphys here in future. Currently the model contains some
  code for testing Amela's Hmix ideas. Not used except in DEBUG mode.

AeroVds

  - Now use GPF_Vds300f for forests and Wesely300 for other land-classes.
    Hopefully a reasonable and consistent set of Vds for PM2.5 calculations

xxxxxxxxxxxxxx rv3_5beta5  Dave  FEb 3rd 2010

run.pl - Revert to NOV2009 emispslit files, which do not contain PPM25_FIRE.
Will re-implement fire shortly...

xxxxxxxxxxxxxx rv3_5beta4  Dave  Jan 21th 2010

PPM25_Fire added to species, changing CM_ChemSpecs_ml and
            CM_Reactions in ZCM_EmChem09

SPLITS_JAN10 now used for input speciationinstead of SPLITS_NOV09

   - same, but with forest-fire emissions added to country 101, sector 11,
     in specials file.


xxxxxxxxxxxxxx rv3_5beta3  Peter Jan 20th 2010

Changes to prepare for flexible vertical coordinates.

GridValues: defined A and B, parameters vertical coordinates to be
read from metfile later
ModelConstants: Pref= 101325.0  Reference pressure in Pa

Replaced Pressure expressions from sigma to eta nomenclature in:
Aqueous_ml, DryDep_ml, Sites_ml, Setup_1d_ml, GlobalBCs_ml


And other small changes:

run.pl: link without "ifile" for BIC, so that the script does not check if the file exists:
it can do without local BIC, by interpolating the global BIC file.

ForestFire_ml: use GLOBAL_ForestFireEmis.nc instead of ForestFireEmis.nc. They are equal, but
I prefer to have as many non gridspecific files as possible in DataDir.

Nest_ml: Allow the BC and the IC files to be different. (required by Alvaro). Not tested yet.

None of the changes before change the results.


xxxxxxxxxxxxxx rv3_5beta2  Robert Jan 15th 2010

ZCM_EmChem09/CM_ChemRates_ml.f90: bug fix, rate of O+O2+M -> O3

xxxxxxxxxxxxxx rv3_5beta1  Joffen, Peter, Svetlana, Dave Jan 13th 2010

 **NEW**  ForestFire_ml introduced. Most of the work done here. Called
     from Setup_1d_ml

 Note also new "PrintLog" routine in Io_ml - hopefully to be used
    more in future to help write a neat log file.

Biogenics_ml - use NBVOC instead of 2 for ReadSDN. Allows NBVOC to be
    set to one for some runs

Country_ml : Biomass-burning (Wild-fires etc.) allocated to a country-number
    integer, parameter, public :: IC_BB  =  101

EmisDef_ml.f90: logical  FOREST_FIRES added

EmisGet_ml.f90   FOREST_FIRES debug Checking

Io_Progs_ml    PrintLog subroutine added

Makefile.SRCS ForestFire_ml added

ModelConstants_ml.f90 DEBUG_FORESTFIRE added

NetCDF_ml - reinstated print for missing variable ReadField_CDF

Unimod.f90 FF added.

Volcanoes_ml   NMAX extended to 12 (is this enough for global)

My_ some extra column outputs added for a project I'd doing. Should be
   removed in future, but for now it helps me (DS).

xxxxxxxxxxxxxx rv3_4_13 Peter,    14 Dec. 2009 xxxxxxxxxxxxxxxx

Bug in ReadField_CDF in NetCDF_ml (read of ForestFire).
Include a safer area when Poles are nearby.


xxxxxxxxxxxxxx rv3_4_12 Dave,    11 Dec. 2009 xxxxxxxxxxxxxxxx

AOTx_ml now extended with more code from Derived_ml.

       -  for grids AOT calc now done in AOTx_ml, function Calc_GridAOTx

       - also setaccumulate_2dyear.

      (** NOTE ** though - the accumulation periods have not been taken care
       of yet, so be careful to use monthly outputs if needed. Still,
       these Grid-average data are hardly needed any more, except for
       comparison to older results and measurement-derived AOTs.
       The newer Mapping manual requires vegetation-specific AOTs)

IOU_ indices moved to ModelConstants_ml, to reduce dependencies
   in NetCDF_ml --- > small changes in many modules

xxxxxxxxxxxxxx rv3_4_11 Haldis,  10 Dec. 2009 xxxxxxxxxxxxxxxx

3-D My_Derived outputs reinstated using new Deriv system. Now
     have D3_PPB and D3_OTHER possibilities

(+ some small tidy ups,
+ BUG-fix for ugS to ugN concentration outputs (N-compounds)
  in Derived_ml, Dave)

xxxxxxxxxxxxxx rv3_4_10 Dave,     5 Dec. 2009 xxxxxxxxxxxxxxxx

Changes made while implementing clover as an option for Fst outputs
 - also includes some general tidy-ups

AOTx_ml - no real change, but a draft clover growing period added
          as comment

Derived_ml - column data now uses vertical starting level, to allow
           use against mountain sites

EcoSystem_ml - dt_scale added - see below

EmisGet_ml - small tidy up

LandDefs_ml - iLC_grass defined for clover usage

LocalVariables_ml - use FstO3 instead of leaf_o3flux

ModelConstants_ml - Added DEBUG_CLOVER

My_Derived_ml - VPD, FST added to MMC_ possibilities.
                More Fst output.
                dt_scale set

My_DryDep_ml.f90 - outout for ozone flux (FST) added

My_Outputs_ml - examples of landcovermet, e.g. RH_GR

OwnDataTypes - dt_scale added - will inform prog of scalin factor
         needed to get from instantaneous d2_  value to accumulated,
         assuming values multiplied by dt_advec
         e.g. for AOT, we need to multiply by dt_advec/3600.0 to
         get ppb.h, so we set dt_scale = 1.0/3600.0

PhyChem.f90 - small tidy up

StoFlux - clover coding added. Clover pots take their O3 from the
         grassland class (which therefore needs to be set 1st)

xxxxxxxxxxxxxx rv3_4_9  Dave,    28 Nov. 2009 xxxxxxxxxxxxxxxx

**New** module AOTx_ml.f90 - a place to keep definitions of AOT

CellMet_ml  - ResetSub added to ensure proper reset at start of each i,j
Derived_ml  - small format changes

DryDep_ml - uses METCONC_AT
               remove call to Init_StoFlux, fewer parameters in
          call Add_MosaicOutput

LandDefs_ml - use LandType()%flux_wanted
Landuse_ml  - iam_wheat code removed (not functioning)
LocalVariables - added cano3_ppb, leaf_o3flux, ResetSub
ModelConstants_ml - added DEBUG_STOFLUX
Setup_1d_ml - added my_first_call to limit number of volcano printouts
StoFlux_ml -   uses Sub(iL)%leaf_o3flux %cano3_ppb instead of
               c_hvegppb array
               remove sub Init_StoFlux
TimeDate_ml - added effectivedate here

My_Derived_ml - changed AOT system
                Allow MMAOT, EUAOT
                Added CanopyRH and RH to possible Mosaic outputs
My_DryDep_ml - adapted to new AOT system
               use of lossfrac removed
               tidy up of "select case" options - use of Calc_AOTx
My_Outputs_ml - examples with e.g. VPD_GR, CanopyO3_GR

xxxxxxxxxxxxxx rv3_4_8  Peter,   25 Nov. 2009 xxxxxxxxxxxxxxxx

Met_ml: does not stop if rh2m is not found, but set it to a meaningless value

xxxxxxxxxxxxxx rv3_4_7   Dave,   19 Nov. 2009 xxxxxxxxxxxxxxxx

CellMet_ml - rh2m replaces rh for grid met

Derived_ml, som replaced by somo, SOM by SOMO.

DryDep - zero index allowed for Mosaic_Met, to collect grid-values

My_DryDep - zero index allowed for Mosaic_Met, to collect grid-values

Met_ml  - relative_humidity_2m read from metcdf files (for tests
   and possible replacement of mosaic rh calculation)

Global change, tabs replaced by 4 spaces
(might mess up some code-indentation in a few files. Please fix
when seen!)

pedantic changes for DryDep - removed or commented out (dsVDS)
unused variables.

xxxxxxxxxxxxxx rv3_4_6   Dave,   15 Nov. 2009 xxxxxxxxxxxxxxxx


Re-write of many Derived fields and usage. This work is only
partly complete, and so some "old" derived fields aren't
yet in the new system. Still, many of them need re-thinking
anywa, and many need to be included in a cleaner "SURF_UG"
type approach.

All use an expanded "Deriv" data type,

Derived_ml

   - many simplifications
   - AddDeriv and AddNewDeriv replace AddDef
   - nMosaic, MosaicOutput includes all of what used to be
        nOutDDEP, OutDDep, nOutVg, Out.... etc.

DryDep_ml

    - call to Add_MosaicOutput replaces Add_Vg, Add_RG, Add_LCC

EcoSystem_ml

    - small changes (TXTLEN_UNIT -> TXTLEN_SHORT
    - use of new Deriv for DepEcoSystem

EmisGet_ml:  internal read of MassValue%value changed to MassValue(1)%value to
EmisGet_ml:  internal read of MassValue%value changed to MassValue(1)%value to
  satisfy older gfortran.

My_Derived_ml:

    - use of new MosaicOutput and Deriv type.
    - Note, not all outputs have been converted to new system yet. Just
      commented out for now.

My_DryDep_ml:

    - use of new MosaicOutput and Deriv type.
    - subroutine Add_MosaicOutput replaces Add_Vg, Add_RG, Add_LCC

OwnDataTypes - expand Deriv type, replace print_dep_type with
   print_deriv_type, remove "dep_type"

Sites_ml

    - "hmix" special case removed. Use "HMIX" and "D2D" in My_Outputs instead


xxxxxxxxxxxxxx rv3_4_5   Alvaro, 10 Nov. 2009 xxxxxxxxxxxxxxxx

run.pl - corrected bugs introdiced on rv3_4_2

Makefile_titan - small change for linking rule (makedepf90/Depend/.depend)

xxxxxxxxxxxxxx rv3_4_4   Peter, 9 Nov. 2009 xxxxxxxxxxxxxxxx

GridValues_ml.f90,Met_ml.f90,PhyChem_ml.f90: use Pole_included instead of Poles.
Should make the global model work also when NPROCY >2 (but still in an inefficient way).

Nest_ml : use dayssince1900 for nesting.

run.pl: linked monthly gridded emissions if GLOBAL

xxxxxxxxxxxxxx rv3_4_3   Alvaro, 6 Nov. 2009 xxxxxxxxxxxxxxxx

Advection_ml - corrected bug introdiced on rv3_4_2

xxxxxxxxxxxxxx rv3_4_2   Alvaro, 6 Nov. 2009 xxxxxxxxxxxxxxxx

Makefile_titan - added file: titan.uio.no version of Makefile

Makefile_gfortran - added Ubuntu 8.04 pedantic setting for INCL, LLIB & LDFLAGS

OutputChem_ml - avoid double output when End_of_Run==END_OF_EMEPDAY
              - pedantic: remove unused variables icmp and scale (Wrtchem)

EmisDef_ml - increase FNCMAX to 20

ModelConstants_ml - added FORECAST logical variable to enforce FORECAST run mode
                  - added (commented) definitions for GEMS/MACC domain
                  - cleanup, alignment and formatting of comments

Derived_ml - only dayly (and hourly) output on FORECAST mode

Advection_ml - enforce dt_advec=600.0 on FORECAST mode
         - ycmax minimum value consistent to xcmax definition
         - replace amin1/amax1 by min/max intrinsics
         - uniform names for Add_2timing calls
         - cleanup, alignment and formatting of code & comments
         - pedantic: remove the following unused variables
             adv_var    dhskmax,ulmin,ulmax,vlmin,vlmax,
                        sdotmink,sdotmax,sdotmin,sdotmaxk
             preadvx    request1,request2
             preadvx2   request1,request2
             preadvy    request1,request2
             preadvy2   request1,request2
             advx       x3,nn
             advy       x3
             advvdifvk  adif,bdif,cdif,e1,n
             vgrid      i,j
             advecdiff  n,l,dtsave,dhskmax,
                        sdotmin,sdotmax,sdotmink,sdotmaxk,sdotmaxadv,
                        ulmin,ulmax,vlmin,vlmax,ucmax,vcmax,
                        inadvst,firstcall,lvertsplit,sum,
                        numt,idebug,jdebug,i_fdom,j_fdom,pwdebug
             advecdiff_poles  l,dhskmax,c_max,dtsave,inadvst,lvertsplit,
                        sdotmax,sdotmin,sdotmaxk,sdotmink,sdotmaxadv,sum,
                        ulmin,ulmax,vlmin,vlmax,ucmax,vcmax,
                        dt_xysmax,dt_xymax,dt_xys,dt_xy,
                        numt,idebug,jdebug,i_fdom,j_fdom,pwdebug,
                        hours,houre,houra,date_ad,iterxy,niterxy

PhyChem_ml - use advecdiff_poles on FORECAST mode even if poles are
             not contained on the model domain

GlobalBCs_ml - use 10-yr average Mace-Head correction on FORECAST mode
             - pedantic: remove tabs and the following unused variables
                 GetGlobalData  buf_lon,buf_lat,bufi,bufj,val,oldmonth
                 setgl_actarray i1
             - pedantic: initialize variables
                 real:: USso2trend=1.0,USnoxtrend=1.0,USnh4trend=1.0

NetCDF_ml - time units "time at end of period" for hourly output

Met_ml - ensure positive precipitation

Nest_ml - nested input/output on FORECAST mode:
          Read nested input (all ADV variables) at start of the run
          and write nested output (all ADV variables) one/two date-times.
          The first nested output will be used to start next day forecast.
          The second nested output can be used for NMC statistics.

Unimod.f90 - open only output netCDF files if needed
           - hourly output for hour "zero" on FORECAST mode
           - write 'modelrun.finished' file to flag the end of the FORECAST
           - nested input/output on FORECAST mode
           - pedantic: remove unused variables fileName & iotyp

run.pl - add titan setup
       - add Forecast mode (CWF) and FORECAST grid

xxxxxxxxxxxxxx rv3_4_1    Peter  6 Nov 2009 xxxxxxxxxxxxxxxx

New routine ReadField_CDF , which reads a global lat-lon file with data and
interpolates into subdomain. Note that all CPUs read the same file simultaneously.
In the future this can be developed into explicit parallel reads.
This routine will soon be used for reading forest fires emissions.

Met_ml: more robust definition of gl_stagg (staggered longitude)

run.pl: link to global forest fire emission file.

xxxxxxxxxxxxxx rv3_4     Dave, Robert  6 Nov 2009 xxxxxxxxxxxxxxxx

Small corrections to ZCM_EmChem09. EXTRA_ITER=1 in Solver_ml

xxxxxxxxxxxxxx rv3_4beta Dave, Robert  5 Nov 2009 xxxxxxxxxxxxxxxx

Signficant change in handling of emissions.  New chemistry.
-----------------------------------------------------------

1) Emissions

No need to specify in advance NEMIS_PLAIN, NEMIS_SPLIT etc. Instead,
the code (EmisGet) figures out from the new emissplit.defaults.xxxx
files how many species each emission consists of. Every pollutant now
has to have an emissplit.defaults file, with headers.  Eliminates a lot
of code and confusion (IMHO) :-)

The emissplit files also contain a MASS_ASSUMED variable. Set to
zero if the code can just figure out the emissions from the real
species. For NOx as NO2, we set 46, for SOx as SO2, set 64.

My_Emis_ml --- ** deleted **

EmisDef - now simpler. Define your emission files here.

EmisGet_ml now does more work, but doesn't need to worry about PLAIN
versus SPLIT.

Setup_1d_ml
Setup_1dfields_ml

run.pl  - now uses $SplitDir = $DATA_LOCAL/SPLITS_NOV2009/BASE_MAR2004
(CLE case not done yet)

Io_Progs_ml - small improvements (for safety)
RunChem_ml  - small changes
Solver_ml - small change (Fgas moved)
Timefactors - mainly use of NEMIS_FILES
Volcanos_ml  --NOTE - used hard-coded MW=64 here. Ran out of energy..
(and such info should be in Volcano input file)


2) Chemistry
ZCM_EmChem09 introduced. Uses rate-updates fro Robert/Conny (2008 work)
plus other improvements arising from chemistry comparison with
Garry Hayman. This '09 version is now the default chemistry.

Plus (Alvaro)
My_Derived_ml - made compatable with older gfortran through use of
tag_name (gfortran or gcc bug, solved for those with Ubuntu Jaunty
of Karmic, affects Hardy, in which   "AAA" // "BBB" wasn't accepted for
strings in AddArray.

xxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3_3 Dave,  24  Oct. 2009 xxxxxxxxxxxxxxxx

Log.changes : all equals signs changed to xxxx, as cvs seems to
be confusing these lines with conflict indicators. Will have
caused some strange lines where equations had a real =, but life
will be easier from now on.

EmisGet_ml - reformat of vocsplit write-out

SmallUtils_ml - errmsg added to AddArray

My_Derived - errmsg in AddArray, and CheckStop - prevents wanted_deriv2d
             exceeding MAX_NUM_DERIV2D (x200 which is a lot anyway!)
           - also just use HNO3 by default in NNDRYDEP -
           - and SO2, SO4 in WETDEP -
           - explicit write_condition added

My_Outputs - all SHL species by default for sites

xxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3_2 Dave,  18  Oct. 2009 xxxxxxxxxxxxxxxx

QRCISOP replaced by QRCC5H8 for consistency across chemical schemes
rcbio changed to simple 1-d array (rcbio(NBVOC), public from Setup_ml
setup_rcemis now adds the biogenic rcbio() to the posisbly anthropogenic
rcemis(QRCC5H8,:) arrays. CM_Reactions uses the latter.

CM_ files changed to reflect C5H8

Small formatting changes (numerous in CM files)


xxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3_1 Peter, 12  Oct. 2009 xxxxxxxxxxxxxxxx

Bug in dayssince1900 (NetCDF_ml). Timestamps were wrong

Dave - re-committed My_DryDep, My_Derived mls, hopefully.  (Some confusion
in cvs here.)

xxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3 Dave, 11  Oct. 2009 xxxxxxxxxxxxxxxx

New *EcoSystem_ml* introduced to include definitions for EcoDep
  new netcdf outputs of e.g. Area_Grid_km2, Area_Conif_Frac

-> CHanges in Derived_ml, My_Derived, Unimod.f90, My_DryDep, DryDep
    (maybe others...)

RO2POOL introduced in Solver to cope with CRI chemistry

Makefile_gfortran added. Code compiles with stricted flags (although
  with lots of warning!)

 !!!!****** ZD_ACID removed ****!!!!
 Functionality must be created through GenChem system now.


xxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3beta5, Garry/Dave,  9  Oct. 2009xxxxxx

Changes from Garry to enable g95 compilation - mainly needing lengths
of strings in initialisations to be the same.

My_DryDep_ml
My_Outputs_ml
My_Derived_ml

I also made some minor tidy-ups in My_Derived_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3beta4, Dave,  9  Oct. 2009xxxxxx

Changes to ease compilation with gfortran, and execution on PC.

Derived_ml.f90 :  f_3d -associated code changed to make it easier to skip
                  this. Needed for PC runs (at least on my PC):

                  Some unused arguments removed also from functions


Also some unused variables (spotted by pedantic gfortran option) removed
   Timing_ml, Unimod.f90, Ammonium_ml, GridValues_ml, NetCDF_ml, PhyChem_ml,
   Sites_ml


Note that in Solver_ml, EXTRA_ITER is set to 3, not 1. This is for safety while
testing different chemical schemes, and can hopefully be reduced back to 1 soon.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3beta3, Dave,  7  Oct. 2009xxxxxx

Derived_ml: AOTs restored, to some extent anyway.
    AOTs and fluxes now treated in same VEGO3 methodology

My_Derived_ml - lots of changes to get AOT, VEGO3 etc.

My_DryDep_ml  - lots of changes to get AOT, VEGO3 etc.

ChemFunctions_ml: kmt3 added

EmisGet - small extra debug output

RunChem_ml - removed QRCISOP from printout line. Not is all CM versions now.

+fixed some forgotten commits from last-version (My_files weren't updated
in ZD_OZONE, and OwnDataTypes_ml)

Many changes now marked with !Oct09 or !DSGC. The comments mess up the code
and will be cleaned out in a revision ort two.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3beta2, Dave,  5  Oct. 2009xxxxxx

GenChem enabled EMEP chemistries, almost done?

New file-labelling system and directories:

ZCM_EmChem03 - contains chemical-mechanism (CM) files for EMEP 2003
chemistry vocsplit files are also chemistry dependent, so for now we
keep them with the code.

ZCM_EmChem03 directory:
----------------------
CM_BoundaryConditions.inc  CM_Reactions1.inc  vocsplit.defaults.EmChem03
CM_ChemRates_ml.f90        CM_Reactions2.inc  vocsplit.special.EmChem03
CM_ChemSpecs_ml.f90        CM_VOC_MW.inc
CM_DryDep.inc              CM_VOC_QRC.inc


The above replaces many of the  My_ files. The latter are now mainly used
to specify desired outputs, and the aerosol schemes. Thus, ZCM_EmChem03
gives the chemistry, ZD_OZONE gives whatever else is needed, and
ZD_ACID should be deleted in the near future. (ZD_ACID should be
replaced by a ZCM_ directory for acid chemistry. Somebody would need
to check over how O3 and stuff are handled though).

Thus, from Unimod.rv3_3,do:
   cp ZCM_EmChem03/CM*
   cp ZD_OZONE/My* .

GenXXXX -> ChemXXXX

In the code, "GenXXX" modules are replaced with ChemXXX modules, thus
GenSpec_adv_tot now becomes ChemSpec_adv_tot. Seemed more logical.

Note, CM_Reactions1 replaces My_FastReactions, CM_Reactions2 replaces
My_SlowReactions since the distinction was really between chemicals that
needed to be in the iteration scheme or not (as they reacted further),
not just speed.


Chemical schemes can be swapped with the mk.GenChem script, which will
be added in CVS somewhere very soon. So far have one "working" sheme (EmChem03),
and one almost-working, EmChem09. Will soon add carbon-bond, CRI, and others

More  changes to make it easier to swap chemistry (coming soon...) :

  My_Derived_ml - uses groups from ChemGroups_ml, removes hard-coded OXN etc.

  My_DryDep_ml - now includes "CM_DryDep.inc" from GenChem's ZCM_EmChem03 directory

  CM_ .... files now from GenChem's ZCM_EmChem03 directory

Plus:

  COLUMN-data added to Derived and My_Derived_ml, simplified calculation

  **New** OwnDataTypes_ml created to store user-defined types. Mainly
  intended to make My_* files shorter. Used so for dep_type, Deriv, SOA-VBST

  Causes modifications (and small tidy-ups) to:
      Derived_ml, My_Derived_ml, NetCDF_ml, Nest_ml

Status and ToDo
-----------------
I think that the GenChem-associated changes are basically done (though of
course I am sure changes will be needed!).

The code still needs work to recover some outputs, notably AOT40, which were
omitted during the changes to Derived and My_Derived (rv3_2_13 onwards).
All gas-phase and deposition outputs look fine, afaics.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_3beta, Dave,  1  Oct. 2009xxxxxx

 GenChem enabled EMEP chemistries
 Caveat: New code seems to work fine, but the numerics  of all rv3_2.. are
 slightly less optimised compared to rv3_1 versions (I removed Peter's
 hard-coded linking of equations in My_FastReactions). The linking
 could be re-introduced for a SR version, but for normal use I recommend
 testing with different chemistry time-steps. (So far my tests show a
 very stable system though)

Introduced ** new directory :: :

 ZD_EmChem03 -  to keep EMEP 2003 chemistry outputs from GenChem.

More  changes to make it easier to swap chemistry (coming soon...) :

  My_BoundaryConditions_ml.f90 **removed**. Some code moved to BoundaryConditions_ml

  My_BoundaryConditions.inc **added**.  Will vary with chemical scheme.

  My_MassBudget **removed**. Equivalent (simpler) lines added to My_Emis_ml
     and Setup_1d_ml

  My_ChemSpecs - module GenGroups_ml **added**, provides:

     OXNGROUP x (/ NO,NO2,PAN,MPAN,NO3,N2O5,HNO3,PNO3,ANO3 /)

     DDEP_OXNGROUP x (/ HNO3,NO2,PAN,MPAN,PNO3 /)

   ... and avoids having to hard-code these in rest of code. Please use!

  My_Outputs_ml  "&" added to please gfortran

  Sites_ml - modifed to make use of OXNGROUP

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_31, Dave,  1  Oct. 2009xxxxxx

Some changes to make it easier to swap chemistry (coming soon...) :

  Derived_ml - hard-coding for CH3CHO, MAX3DADV of CH3COO2, PHNO3 removed

  EmisGet_ml - extra safety printouts for  VOC speciation

  OutputChem_ml - uses MasterProc and more debug output with My_DEBUG


Plus....   Some changes to solve small problems spotted by gfortran:

  BoundaryConditions_ml.f90 - debug_proc removed from ModelConstants use

  CellMet_ml.f90: -1* instead of -Grid%Hd

  GridValues_ml.f90: changes of real, integer defintions

  NetCDF_ml.f90: small re-code

  ReadField_ml.f90: Use .eqv., not xx in any (cell_set .eqv. .false. )

  Solver.f90: double-def of rct removed

  My_ChemRates_ml.f90: rcmisc line split. Not sure why gfortgran complained, except
    it doesn't seem to like long lines


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_30, Dave,    1  Oct. 2009xxxxxx

Bug-fix!
My_Derived_ml index problem fixed. This bug didn't affect the model runs,
but caused the wrong output in DDEP_SOX etc. Introduced in
rv3_2_11. New code seems to work fine, but more checks would be useful

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_29, Peter,   17 Sep. 2009xxxxxx

removed -mieee-fp from Makefile and Makefile_stallo
This options made the floating point operations ieee compliant, but are now slowing down the computation
quite a lot, and even more (30% diff) with the next intel compiler version (11.1, to come on stallo in October)
If one wish to compare results between diferent machines (stallo and njord for example it may be useful
to put the option back)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_28, Dave,   16 Sep. 2009xxxxxx

My_Reactions omitted - code moved into Solver_ml
My_SlowReactions.inc added

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_27, Peter,  10 Sep. 2009xxxxxx

Changes to comply with the rotated spherical projections and new definition/units for time:
now in days since year 1900. The seconds used earlier do not run after 2037 or so and we
need to run later for climate studies.
NBNB: if you have postprocesing scripts which make use of the date read from the netcdf
files, make sure to update these!

NetCDF_ml and Met_ml are changed

Dave changed Functions_ml also, to use sin instead of sind (for gfortran
compliance), and removed 360 term.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_26, Dave,  4 Sep. 2009xxxxxx

INTERIM version - the concentrations look fine, but for some
reason WDEP, DDEP is different to older (rv3_1) results. Needs
investigating!
(Differences *not* due to changes here, likely those from
some revisions ago)

Main change: My_Chem files all come  *directly* from GenChem output
Some small change in reactions introduced here, but doesn't affect
air concentrations very much.

My_ChemSpecs_ml
My_FastReactions

*** note, since these files are from GenChem, we have lost some of
the optimisations which Peter introduced. This can one day be
coded into GenChem, or done by hand again.
   On the oter hand, GenChem got rid of some of the bugs introduced
by hand-coding ;-)

Solver_ml:  use NUM_INITCHEM, DT_INITCHEM etc., to try to make
  timestep values easier to change. Values printed out to IO_LOG


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_25, Dave, 11 July 2009xxxxxx

Some changes to make the code "safer" I hope, after being caught out by
unexpected input files when changing domain.

Input files expected:  Now expect rough.dat and Inputs.2BVOC
xxxxxxxxxxxxxxxxxxxx

Met_ml now requires rough.dat, not rough.170. The new "fill_needed"
parameter is used to ensure that this data fills the grid. Unlike
the zero sized rough.170 in the EECCA data-directory ;-)

Biogenics_ml -  now looks for Inputs.2BVOC, not Inputs.BVOC. the
reason is tat the terpene emission factors were all -999.999 in
the EECCA directory. No problem for standard runs, but a major
problem for SOA runs.
Now checks that terpene emission factor is positive, at least if NBVOC > 1


Io_Progs_ml - extra debug stuff

ModelConstants_ml - extra lines for EECCA domains, and more debug options

ReadField_ml  - optional "fill_needed" parameter added to
readfield_r and readfield_i routines.  CheckStop will stop the run if
fill_needed is true, if the domain isn't filled.

New Inputs.2BVOC file created for EECCA

run.pl - now has $GRID which can be EMEP, GLOBAL, EECCA etc.

MassBudget_ml: small format change

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_23, Alvaro, Haldis 6 July 2009xxxxxx


Changes to My_Outputs_ml.f90 and Output_hourly.f90 to solve bug with units
(ugSm3 etc.). General ADVugXX used for all mass-based outputs in Outputs_ml,
with units to be chosen in My_Outputs_ml.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_22, Peter 30th June 2009xxxxxx

GridValues_ml, NetCDF_ml, et_ml:
Defined "rotated_latitude_longitude" projection following CF-1.0 convention.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_21, Dave, 24-26th xxxxxx

found_ind2d, found_ind3d added to Derived_ml to esnure that we
don't try to define the same variable twice.

Comma removed in GLobal_ml, needed to compile

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_20, Peter, 24th June 2009xxxxxx

GridValues_ml:
Added the general case in lb2ij, which gives (i,j) values (as real numbers) given
longitude and latitude for any grid projection.
Used for sites/sondes given as lonlat.

Function_ml, Nest_ml:
Moved great_circle_distance into Functions_ml.


Note: The new default compiler on stallo (ifort 11.0), gives a segmentation fault
on line 711 in NetCDF_ml, when compiled with debug options. After closer look, this is most probably due to
a bug in the compiler...


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_19, Peter, 2nd June 2009xxxxxx

Small change for compatibility with rotated spherical projection (H20)

Met_ml:
-180<gl_glob<180

NetCDF:
Compatibility with GLOBAL_BIC (see rv3_2_4)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_18, Agnes, 1st June 2009xxxxxx

GlobalBCs_ml:

update of Mace-Head ozone values, now with average from 1998-2007. Also
recalculated the 2006 and 2007 Mace Head values with the new 10-year
average.

Commented out the +3 (4.5) ppb scaling for future years (2010 and later),
so the 1998-2007 10-year average will be used for these years.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_17, Peter, 28th May 2009xxxxxx

Solver.f90:
nchem is now set to 10 when dt_advecx600

Advection_ml:
Larger dt_advec for fine resolution

Functions_ml, NetCDF_ml:
Move "inside_1234" into Functions_ml

My_Reactions.inc:
We go back to the "toiter(k)" loop; with the new compiler this is the fastest (though only a few %)
and it is neater too.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_16, Agnes, 20th May 2009xxxxxx

MaceHead correction for 2007 added.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_15, Dave,  20th May 2009xxxxxx

Functions_ml : troe removed, and moved (as troeInlog) to:

New module: ChemFunctions_ml - with troe, RiemerN2O5, kaero functions

Added modules: My_ChemSpecs_ml My_ChemRates_ml

  - split from old My_Chem_ml, to make use of GenChem easier
  - RiemerN2O5, kaero now done in ChemFunctions
  - tabulation of rate constants switched off for now.
    ( Surprisingly, ** No CPU cost **. Time for chemistry almost
      identical )

Removed modules: My_Chem_ml,  OrganicAerosol_ml

    (the latter not needed, as we have SOA_ml)

Setup_1d_ml, Setup_1dfields_ml
   - removed Rimer stuff, some re-organisation because of My_Chem changes

Solver_ml - has EXTRA_ITER to allow
            ONLY_NIGHT code removed

Unimod.f90 - no need for Init_mychem



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_14, Dave,  16th May 2009xxxxxx

Changes to make switch to global model easier, plus some tidy-ups

IS_GLOBAL added to ModelConstants_ml

Emissions_ml : sets MonthlyEmis x IS_GLOBAL
  (keeps all Global - EMEP changes in ModelConstants)
   Tidy-up

run.pl: My $GLOBAL added as switch
   sitesLL.dat, sondesLL.dat added as defaults in $DataDir - suggest
    only use long/lat files in future.

My_Outputs_ml
   removed D2_AFST... etc., and dependency on Derived

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_13, Dave,  15th May 2009xxxxxx

Working changes::: AOT outputs have been commented out. Will re-appear
soon!

LandDefs_ml
New functions for Check_LandCoverPresent added.

My_Derived_ml
  AFST now dealt with using "OutXX" system, as for VG, RG

My_Derived_ml
  AFST now dealt with using "OutXX" system, as for VG, RG
  Gets rid of iam_wheat, D2_AFST... etc. type indices
  check_vals now not needed.:wq

Derived_ml
  -- more changes to cope with AFST and Out variables

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_12b, Peter  14th May 2009xxxxxx

ReadField, Landuse, Met_ml:
Use landuse to define nwp_sea when rough file is missing


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_12, Peter  14th May 2009xxxxxx



ReadField_ml:
Optional parameter when the field is not needed

Met_ml:
rough is set to 0 if not needed
snow is not required when read from metdata

Sites:
sites.dat and sondes.dat are not required.
(the code was hanging when this happened)

Rsurface_ml: if ice is missing, but sdepth is present, take sdepth instead of snow.(IS THIS OK?)
    if ( .not. foundsdepth)then
       fsnowxG%snow !snow from climatology files, 1 or 0
    endif

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_11, Dave,  14th May 2009xxxxxx

Changes to allow for possibility of new landuse codes, or of
old landuse codes (e.g. "CF" not being recognied with new
systems)

Unimod.f90 - Init_Derived now moved after Init_landuse, so that
  the My_derived code knows about the available Land_codes

My_Derived_ml - check added for MET_LCS to see if the LC actually
  exists. If not, nOutMET will be zero. Note that for other
  outputs the code will crash if a non-existant land-code is given.
  The user can keep it working by only havinbg "Grid" in the arrays,
  e.g. for RG_LCS x (/ "Grid" /)

  Also, some slight tidy-up to reduce clutter

SmallUtils:  find_index again returns NOT_FOUND (-999) instead of 1
    also, trim() added to txt strings

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_10, Peter  13th May 2009xxxxxx

First version of a grid flexible Landuse input

GridValues and Met_ml: defined gb_stagg and gl_stagg (staggered lon and lat)

NetCDF:
 Read_Local_Inter_CDF, to read and interpoalte landuse from raw data.
Under construction!

Landuse_ml: call to Read_Local_Inter_CDF when Input.Landuse is not found

Replaced all NLANDUSE with NLANDUSEMAX: used for array declaration and is the max allowed,
NLanduse_DEF is the actual number of landuse defined.
DO3SE_ml,DryDep,LandDef,StoFlux_ml,NetCDF,LocalVariables_ml

LandDefs_ml: NLanduse_DEF number of landuse defined
NLANDUSE_EMEPx19. To check data from Input.Landuse.
StoFlux_ml: use NLanduse_DEF instead of NLANDUSE.
DryDep_ml: InitDO3SE called only if not already read by Read_Local_Inter_CDF

ModelConstants:NLANDUSE    x 23 ! MAXIMUM Number of land use types

SmallUtils_ml: NB: provisory!!
!    Index x  NOT_FOUND
    Index x  1

run.pl: link to landuseGLC2000_INT1.nc

NB: The new landuses system is still under developement.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_9, Dave  8th May 2009xxxxxx

Derived_ml, My_Derived_ml:

SURF_UG_C, SURF_UG and SURF_PPB added

Also write_debug routine added in Derived_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_8, Dave  8th May 2009xxxxxx

Derived_ml, My_Derived_ml

Start of move to simpler system, where wanted surface concentrations
can be specified with their index, e.g to get ug(N)/m3 NO2
use SURF_UG_N x (/ ...., NO2, .... /)
 - removes need for character "D2_NO2" and index D2_NO2 and allows
Derived to be specified with simple loop over SURF_UG_N. Similar
system in place for SURF_UG_S, and will later implement SURF_PPB


Derived, My_DryDep
AOT30 outputs removed. (Whole AOT system should also be replaced. Usage
of e.g. D2_AOT30 in My_DryDep caused hard-to-find bug in d_2d when AOT30 removed
from Derived system)

My_Chem_ml   - use PPM25 instead of PM25 for primary  PM25. Ditto for PMco
My_WetDep_ml -  ditto
Sites_ml     -  ditto

My_DryDep_ml
   AOT30 stuff removed. (Hard-coded D2_AOT30 variables caused hard-to-find
    problem in d_2d index. Hard-coding of numbers proved bad once again....)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_7, Dave  5th May 2009xxxxxx

** Bugs found and fixed **
-  bugs were in old  My_WetDep_ml code, but luckily not for
anything we have reported. wepdeppm25 and wdeppmco were wrong.
WDEP_NH3 and WDEP_aNH4 were mixed up, but WDEP_RDN was okay.


Aqueous_ml - loop over SO4LIKE once wet dep loss rate for SO4
  calculated.
  uses wdeploss frm MassBudget instead of old sumloss
  now sets wdeploss using indices, e.g. wdeploss(SO2)

Io_ml - added IO_DEBUG to allow printout to separate file (just fort.26 for now)

My_WetDep_ml:
  use array SO4LIKE to contain other fine particles
  now sets wdeploss using indices, e.g. wdeploss(SO2)
  (slower I guess, but clearer and safer!)

Runchem_ml:
  modified to use new WetDeposition, SOA_ml
  - pretty messy with DEVUG statements. Will tidy up another day

SOA_ml:
  debug_flag added

(These changes are a step towards SOA, where many species will need
to be handled by the dep routines, but all as SO4-like.)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_6, Dave  4th May 2009xxxxxx
Emissions_ml
Replacement of if(mexx0) with  if(MasterProc)

Replaced the calls to MPI_ABORT with CheckStop calls. I hope these do the
same thing, and they help to keep the code shorter. Look for "!dsx" bits
to check this. (We can delete these lines once we are sure all is okay).

ModelConstants_ml
-- added extra DEBUG constants

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_5, Peter 4th May 2009xxxxxx
NetCDF_ml:
Bug: Removed a test which stops the code.

run.pl:
defined($country_nums{$cc}) and ALL x> 0 for selecting all countries



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_4, Peter 22nd April 2009xxxxxx

Flexible BIC:
If the "Boundary_and_Initial_Conditions.nc" file is not found, it will interpolate the data from
"GLOBAL_Boundary_and_Initial_Conditions.nc".
"GLOBAL_Boundary_and_Initial_Conditions.nc" should be written with global run results (not yet done).

NetCDF_ml:
 GetCDF is now very general, it does not assume anything about the dimensions. You can use this to read any Netcdf file.
new routine "Read_Inter_CDF". It reads data from a lon lat grid and interpolates to the model grid. (not in parallel, should be called by mex0 only)

run.pl: link to "GLOBAL_Boundary_and_Initial_Conditions.nc"


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_3, Peter 3rd April 2009xxxxxx

Updates for the Global model

Solver.f90
nchemx15 for gridwidth larger than 60km.
Still this value should be tested.

Met_ml:
Improved default value for sdot.

Emissions_ml:
Introduced a "MONTHLY_GRIDEMIS" parameter for easier use in global runs.

My_Chem_ml:
species%sulphurx0 for ISONO3,ISNI and ISNIR (bug)

Landuse_ml:
NLUMAX x 19

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_2, Dave 27th Mar 2009xxxxxx

Some small tidy-ups, and extensions:

Country_ml:  IC_INTSHIPS x 350 added for TNO emissions

EmisDef_ml: extended to deal with TNO EC/OC emissions

EmisGet_ml: extended to allow for more emission entries

Emissions_ml: tidy up of DEBUG stuff.

ModelConstants_ml: more DEBUG added

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2_1 20th Mar 2009xxxxxx

Various DEBUG variables changed, See new logicals in ModelConstants_ml

Sites_ml  - ascii output set to 10 columns rather than 8 (easier to
count!). Also, outputs excluded when site is on domain boundary


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2 Hilde/Dave  19th Mar 2009xxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
MAJOR CHANGES SINCE RV3_1

Done - rv3_2 now has new co-dep routine, new aerosol deposition, and
 more land-cover output possibilities in Derived. See various beta
 changes below...., this has been a long process!

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta18 Dave, 16th Mar 2009xxxxxx
(Skipped 16,17 ...)

Major change in aerosol deposition calculations, designed to simplify.
Aero_Vds_ml replaces Aero_Rb_ml, and will serve as a collection point
of alternative algorithms. For this version use a simple formula ('GPF'x
generalised Petroff fit) for forests
derived from Petroff et al's papers, as function of ustar, SAI and invL.
Use Nemitz(2004) for all else. SubMet also changed to reflect findings of
various ustar tests against CarboEurope data and offline testing.

Also note new way of specifying DEBUG in ModelConstants - applied
to just a few routines so far. (Intended to make if faster to
switch debuggung on and off, and to save those occasions where
MY_DEBUG in SubMet_ml didn't help as the poor user had forgotten
that this one needed DEBUG in RUnChem_ml switched on too. (Otherwise
debug_flag was never set true)

Derived system modified again, to allow landuse-specif met
params to be output, just invL and ustar so far. Still should
be improved and made more efficient - a work in progress.

Module changes:

CellMet

  Grid%is_allNWPsea added -  used to identify all-sea squares

  Following Branko's comments, we limit u* to a physically plausible value,
  0.1 m/s to prevent numerical problems in stable BLs

CoDep_ml - just write "First CoDep" for MasterProc

Derived_ml - makes use of  DEBUG_DERIVED, and OutMET added. Also
            USTAR_NWP.

DryDep_ml
 Large changes!
 replace Aero_Rb with Aero_Vds, and use new formula for forests,
 Wesely for all else. Settling velocity calc moved in Aero_vds_ml
 also.  Limit settling velocity (Vs) to 2 cm/s

LocalVariables_ml.f90
  logical :: is_allNWPsea   !  Only sea in grid-square

ModelConstants_ml
  new DEBUG_RUNCHEM etc.

Rsurface_ml -  max 10 s/m for HNO3 re-introduced

Runchem_ml - uses DEBUG_RUNCHEM

SubMet_ml
   Many changes - Increased iterations for neutral, unstable,
   just one for stable.

   We restrict z0 to max 0.5m, since comparison with CarboEurope
   results shows that this provides the best u* values for forests.

    ! We use the same restriction on z0 as in Berge, 1990 (Tellus,42B,389-407)
        Sub(iL)%z0 x max( Sub(iL)%z0 ,1.5e-5)

    Uses DEBUG_SUBMET

Rsurface_ml
 - reimplement Vg limitation for HNO3. 10 cm/s max is enough anyway!

run.pl
  New input files, shorter veg in general
 $ifile{"$DataDir/Inputs_LandDefs.csv_05.12.2008"} x "Inputs_LandDefs.csv";
 $ifile{"$DataDir/Inputs_LandDefs.csv_25.02.2009"} x "Inputs_LandDefs.csv";

ZD_OZONE/My_Derived
  changes for new met outputs
  tidy up for OutVg, OutRG

ZD_OZONE/My_DryDep
    Uses DEBUG_MY_DRYDEP
    OutMET added


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta15 Hilde, 25th Feb 2009xxxxxx
New run.pl with:
   Inputs_DO3SE.csv_25.02.2009 (Surface resistance for RgsS for ice set to 1000). No effect on results
   Inputs_LandDefs.csv_25.02.2009  - reduced height for forests and med. Scrub. Will change results

   SubMet_ml:
      revised ustar, invL, with more iterations for unstable
      z0 limit changed slightly, to match Berge 1990 value
      CellMet-ml -in troduced 0.1 m/s limit on ustar for Grid%ustar

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta14 Dave/Svetlana, 11th Feb 2009xxxxxx

SubMet_ml - bug corrected on z0 for sea-areas (big effect?!)
    new (still experimental) limit on forest z0 x 0.5m

PhysicalConstants_ml - Charnock set to 0.0144 instead of 0.036


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta13 Peter,   4th Feb 2009xxxxxx


Met_ml:
New method of deriving sigma_dot when it is missing.
Hopefully this can be a usable alternative, which will avoid most of the prostprosessing
problems of the metdata (mass filtering etc).

Will not changes results in case sigma_dot is found.

Small change in Output_hourly (only debug printing).
            if ( hr_out(ih)%type(1:3) xx "ADV" ) then



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta12 Dave,   3rd Feb 2009xxxxxx

MasterProc introduced in:
  ModelConstants
  Par_ml
  LandDefs
  Io_Progs_ml

 Use "if (MasterProc)" instead of "if (me xx 0)", which needs use ModelConstants
instead of use Par_ml. Easier for box-model type codes.

Also:

LandDefs_ml made F-complaint
PhysicalConstants_ml: R removed, only use RGAS_KG
  Met_ml: R replaced by RGAS_KG.
(I think single letter parameters are too hard to search for.)

SubMet_ml   made F-complaint

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta11 Hilde,   29nd Jan 2009xxxxxx
Bug in Output_hourly.f90:
Units wrong for case ( "ADVugm3" ).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta10 Peter,   22nd Jan 2009xxxxxx

Bug in Met_ml introduced 20th Nov 2008: when a metfield was not found the routine GetCDF_short
returns without closing the file.
If the number of open files exceeds 4096, the program will stop.
No differences if you haven't noticed.

Bug in Log.changes: Jan 2008 was Jan 2009 :-)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta9 Hilde,   20th Jan 2009xxxxxx

DAY_NIGHTx0.6 in Timefactors_ml for sector 10. This means that the agricultural emissions will be 1.4/0.6 times larger in day time than in night.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta8 Dave,   12th Jan 2009xxxxxx

fixed bug in CoDep, which I thought had been fixed in beta7 :-(

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta7 Dave,   12th Jan 2009xxxxxx

CoDep has a small bug-fix (for IRHx0, F4) and more debug options
 + includes Hilde's bug-fix for MAX_SN

Derived_ml + My_Derived_ml
  now has OutRG as merge of OutR and OutG terms

DryDep + My_DryDep

landuse-specific, *and* grid-average, deposition (Vg),  resistance (R)
and conductance (G) variables now stored in "Mosaic_xx" arrays in
DryDep. Using landcover indexx0 gives grid average

Deleted old arrays, Grid_Vg_ref, Vg_ref_iL etc.

DRYDEP_CALC  renamed to DRYDEP_GASES
NDRYDEP_CALC renamed to NDRYDEP_GASES
NDRYDEP_TOT  renamed to NDRYDEP_CALC - ie back to original intention

Area(:) renamed to EcoArea



OutR, outG merged into outRG
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta6 Hilde,  17th Dec 2008xxxxxx

Derived_ml: small change (only effect is that less 'warnings' written out, there was a problem with undef values)
CoDep_ml:a_SN_24hrxso2/nh3,a_SNxso2/nh3, both capped at so2/nh3x3.0, Switch off debug flag
Rsurface_ml: fsnow x2.0 *G%sdepth/Sdmax (before G%sdepth/Sdmax)

Changing a_SN_24hr from 0.6*so2/nh3 to so2/nh3 has only minor effect on so2/nh3 in 2006
(average increase from 0.8 to 0.81, 1% to 3% higher than obs)

Changing fsnow from G%sdepth/Sdmax to 2.0*G%sdepth/Sdmax
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta5 Hilde,   8th Dec 2008xxxxxx
CoDep_ml: cap on minimum value on nh3conc (to avoid numerical problems
when nh3 conc is zero - like it is in the beginning)

Derived_ml: Outputted so2nh3_ratio capped at 3 to avoid unrealistic values in the average.
Anyway so2nh3ratio_24hr is effectively capped at 3 in the Rns calculation, so this will show
how it is used.

DryDep_ml: changed dimensions
My_DryDep_ml: small change in output for Rns since it is not defined for all landuses always

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta4 Hilde,   8th Dec 2008xxxxxx
PhyChem_ml: call to make so2nh3_24hr! Was forgotten committed, so so2nh3 was
effectively set to 0 everywhere after new CoDep routine added...

run.pl: New links Inputs_LandDefs.csv_05.12.2008 and Inputs_DO3SE.csv_05.12.2008
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta3 Hilde,   5th Dec 2008xxxxxx
added Snow and so2nh3_24hr to old output system and committed Derived and My_Derived again.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta2 Hilde,   5th Dec 2008xxxxxx
Output system for  Rs, Rns and Gns added for ecosystems
Snow and so2nh3_24hr added to old output system.
Changes in

  My_Derived_ml
  My_DryDep_ml
  Derived_ml
  Rsurface_ml
  DryDep_ml
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_2beta Hilde,   4th Dec 2008xxxxxx
Change version number to reflect that this model version has new
deposition scheme compared to rv3_1 series...
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_10  Hilde,   4th Dec 2008xxxxxx
Met_ml: read snow,ice, foundsdepth, foundice
CellMet_ml : use sdepth,ice snow from Met_ml
Chem_ml: defined  so2nh3_24hr and Grid_snow
DryDep_ml : define Grid%so2nh3ratio24hr, remove Rsur_dry/wet + change call
CoDep_ml.f90: new method for Rns_SO2. Changes also for Rns_NH3. (Was also bug in Rlow here,
it was added both here and in Rsurface_ml)
Rsurface_ml.f90: Re-written so that Rdry and Rwet no longer needed (due to new method for Rns_SO2).
Added new method for snow, for SO2 and O3 (affecting all).

GlobalBCs_ml.f90: added reference to Hicks et al 2002


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_9  Dave,   3rd Dec 2008xxxxxx

New system started for Derived components, working for DDEP and
VG outputs. Gets rid of need for hard-coded indices such as DDEP_SOX,
etc., and makes it faster to specify landuse and species options.
(
Changes in:

  My_Derived_ml
  My_DryDep_ml
  My_WetDep_ml   ! Still uses old-scheme, but now has SO2, SO4 etc.
  Derived_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_8  Dave,   3rd Dec 2008xxxxxx

CoDep_ml - bug found! This will change results for depositions of
   all components!
ModelConstants_ml - 2 extra DEBUG  sites added
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_7  Hilde,  2nd Dec 2008xxxxxx
LocalVariables: Added is_veg,is_ice, sdepth, ice so2nh3ratio24hr
SubMet_ml: is_veg and is_ice set

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_6  Hilde,  2nd Dec 2008xxxxxx
Set New meteorology directories (Parlam-PS with snowdepths and ice fraction) in run.pl.
Bug in LandDefs (is_veg) fixed.Mostly affects dry dep velocities of coarse particles over urban areas.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_5  Dave,  1st Dec 2008xxxxxx

NetCDF_ml, small change to allow longer variable names, e.g.
DDEP_aNO3_m2Conif:

   !dsDec08 character*18 :: varname
   character(lenxlen(def1%name)) :: varname

and some extra use of MYDEBUG
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_4  Peter,  20th Nov 2008xxxxxx

Only minor changes:

Met_ml: "validity" returned from Getmeteofield gets the value "field_not_found" if the field is not found.
This can be used to set foundSSTx.false. for example, or to stop cleanly.

Solver: removed dt_tot, which was not used anyway.(requested by Martin Schultz)

Functions_ml.f90:  in Exner_nd replaced "ix1 x x1" with "ix1 x floor(x1)"
It is somewhat clearer, and works also for negative pressure :-)

run.pl: "#PBS -lpmemx2000MB" , gives higher queue priority on stallo.

My_DryDep: Switched off debug flag

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_3  Dave,  8th Nov 2008xxxxxx

Ecosystem dry deps changed, to be per m2 of ecosystem

** Note - this changes the values, since before they were per m2 of Grid,
          not of ecosystem!  No need now to scale anything with landuse
          data.

*Note change of output names:
   DDEP_SOX   is now  DDEP_SOX_m2Grid
   DDEP_OXSCF is now  DDEP_SOX_m2CF
 etc.

My_DryDep - use of AreaCF, AreaDF, etc., plus new names
My_Derived_ml  - Use of new names
Derived_ml     - Use of new names

DryDep_ml  - added arguments to call to Add_ddep
Cellmet_ml - set %coverage, LAI etc to zero before assigning .. safety measure
to allow use of full array from 1..NLANDUSE.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_2  Svetlana,  8th Oct 2008xxxxxx

My_outputs_ml, Sites_ml changed to allow outputs of d_2d variables.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1_1 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

First bug fixes:
  sign of Hd test and GRAV changed for wstar calculation - bug spotted
  by Massimo


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_1 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


 As used for 2008 EMEP Reports

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_0_7 10th june, Dave xxxxxxxxxxxxxx

Removed dead-code (MACHO refs!) from Tabulations_ml
ONLY commented-out lines removed.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3_0_6 4th june, Hilde xxxxxxxxxxxxxx
Country_ml.f90 updated with the new country codes from Agnes (EECCA countries)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3.0.5, Peter,  Apr 15th 2008  xxxxxxxxxxxxxx

Output_hourly: put the vertical coordinate for hourly output right.
	       If 20 level are requested the lowest level has kx20 (as usual)
	       If less than 20 levels are requested the lowest level has kx1
	       Also corrected ist etc. to be compatible with the nesting changes
	       made in rv3.0.4

Makefile is now Makefile_stallo

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3.0.4, Peter,  Apr 4th 2008  xxxxxxxxxxxxxx

Hourly cdf output: put timestamp at end of period
Nesting: istart etc coordinates relative to large domain instead of small domain.
LandDefs_ml: dimension of Header put to 15
Advection_ml: improved the ADVEC_TYPEx2 option (not the default value) for exact mass conservation
Sites_ml: allow sites/sondes on model boundaries (needed for poles in global runs)
Timing_ml: use MPI_WTIME to measure walltime

None of these changes should affect the results of "standard" runs.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3.0.3, Dave,  Mar 18th 2008  xxxxxxxxxxxxxx

GlobalBCs_ml
added 2006 O3 backgroud, using data from Derwent et al. (2007) paper

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3.0.2, Peter,  Mar 3rd 2008  xxxxxxxxxxxxxx

Just additional comments in the code.
In ZD_OZONE/MyDerived_ml !NB: do not remove without removing from My_DryDep too
In ModelConstants_ml PT x 1.0e+4    ! Top of model region x 10000 Pa x 100 hPa


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3.0.1, Dave,  Mar 1st 2008  xxxxxxxxxxxxxx

Io_Progs_ml  -  bug fix to remove text trailing # in HEADER line  (doesn't
     matter to results though)

Landuse_ml - small formatting change

NetCDF_ml and Nest_ml reset to rv3beta13 status


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx rv3      2008  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1st OPEN SOURCE CODE ON WEB!!!

End of rv3 series. Almost identical to rv3 as given on web, but

(Had to reset Nest_ml and NetCDF_ml to slightly older code. Will
update again as 3.1.

** modrun.pl is still different in rv3 and on web-version. Too many
differences to bother about here.)

xxxxxxxxxxxxxx rv3beta13  feb 6  2008  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter
Small bug: current_date declared twice in NetCDF_ml (does not influence
output, but pgi compiler complains).

xxxxxxxxxxxxxx rv3beta12  feb 2  2008  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter
New update of adv_var: the previous version seemed to hang on stallo in some situations (global model)

xxxxxxxxxxxxxx rv3beta11  Jan 31  2008  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

copied the new Inputs_LandDefs.csv into DataDir and corrected a bug
introduced in run.pl from rv3beta9 when runnning on snykov.

run.pl, modrun.pl - modified to use renamed Inputs_LandDefs.csv


xxxxxxxxxxxxxx rv3beta10  Jan 31  2008  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave

DO3SE system simplified to remove various special features. Effect of
old needles removed, and replaced by simply setting lower fphen in
Inputs_DO3SE.csv.

Treatment of Astart, Aend now automatic also - special code removed

Inputs.LandDefs now renamed Inputs_LandDefs.csv, and values changed

Inputs_DO3SE.csv values changed
   - both to reflect revisions to mapping manual, and  recent work

Wesely_ml - tidied up some comments about NH3


SHOULD USE NEW INPUT FILES ALSO!

xxxxxxxxxxxxxx rv3beta9  Jan 16-17  2008  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Stallo version of run.pl and Makefile_stallo.
Just set STALLOx1. Choose USER, ProgDir,WorkDir, Emissions etc. as usual.
32 procs choosen in ModelConstants_ml.

Put an  MPI_BARRIER in Io_Progs_ml: OpenMPI becomes crazy (huge memory
leak->node crashes) because each line was is in separate buffers to all nodes,
 before they were received.


xxxxxxxxxxxxxx rv3beta8  Jan 8-9..11  2008  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter, Svetlana

End of run dates for "fullrun" in NetCDF_ml.
Removed "initnetcdf" routine from Unimod and NetCDF_ml (was never used).

Defined veg_month in DryDep. Seemed not to be defined before? Does it work now??
Initialized veg_monthx1 in DO3SE_ml

Changed definition of LandType in LandDefs_ml:
            LandType(n)%is_water  x  LandInput%code xx "W"
            LandType(n)%is_ice    x  LandInput%code xx "ICE"
            LandType(n)%is_iam    x  LandInput%code(1:4) xx "IAM_"

            LandType(n)%is_forest x  &
                ( LandInput%type xx "ECF" .or. LandInput%type xx "EDF" )
            LandType(n)%is_conif x ( LandInput%type xx "ECF"  )
            LandType(n)%is_decid x ( LandInput%type xx "EDF"  )
            LandType(n)%is_crop  x ( LandInput%type xx "ECR"  )
            LandType(n)%is_seminat  x ( LandInput%type xx "SNL"  )
            LandType(n)%is_bulk   x  LandInput%type xx "BLK"
            LandType(n)%is_veg    x  LandInput%type /x "U" .and. &
                  LandInput%hveg_max > 0.01   ! Excludes water, ice, desert

NB:Water defined with type "BLK" in  /home/mifapw/emep_common/Data/Inputs.LandDefs
BUT NOT IN ~mifads/Unify/Data/EMEP/Inputs.LandDefs
Copied also the other input files from ~mifads/Unify/Data/EMEP/ over to /home/mifapw/emep_common/Data and
/home/mifapw/emep_common/Data/EMEP
Changed run.pl to take into account these changes

Uncommented a system call in Nest_ml: can cause problems in combination with OpenMPI (problems appeared on Stallo).

xxxxxxxxxxxxxx rv3beta7  Nov 16  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave

 GPL added to TimeDate_ml

xxxxxxxxxxxxxx rv3beta6  Nov 12  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave

My_FastReactions.inc added, and included in My_Reactions.inc
-- saves having identical code 3 times in My_Reactions


xxxxxxxxxxxxxx rv3beta5  Nov 7-8  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter
Met_ml: non-blocking MPI_ISEND for wind speeds in metvar.
        Uses dedicated arrays for receive buffers.
	Was giving worng results with -O3 option (!?)

SubMet_ml: Sub(iL)%rh x min(1.0,Sub(iL)%rh)! keeps rh <x 1
	   instead of e x min(esat,e)
           Is mathematically identical, but gave slightly different results with -O3 option.

Dave
CellMet_ml: wetarea change to avoid numerical problems.
  !   .... we allow a small build-up phase, with
  !   linear increase from wetareax0 to wetarea x cc3dmax for values of
  !   prec between 1.0e-8 (near-zero!) to 0.01.

Svetlana:
  Added foundSST x true for cdf met reads

xxxxxxxxxxxxxx rv3beta4  Nov 5-6  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Hilde, Svetlana
Files cleaned for unnecessary output. Changed files are:

Unimod.f90
Emissions_ml.f90
Landuse_ml.f90
Met_ml.f90 (also with Svetlanas reading of SST)
Derived_ml.f90
Timefactors_ml.f90
EmisGet_ml.f90
My_BoundConditions_ml.f90
BoundaryConditions_ml.f90
GlobalBCs_ml.f90
Runchem_ml.f90
Advection_ml.f90
PhyChem_ml.f90
Biogenics_ml.f90
Volcanos_ml.f90
Io_Progs_ml.f90
NetCDF_ml.f90
AirEmis_ml.f90
EQSAM_ml.f90
DryDep_ml.f90
OutputChem_ml.f90



Makefile and Makefile_snow:
replaced the -O3 compiler option with:
-O2 -mieee-fp -ftz

xxxxxxxxxxxxxx rv3beta3, Oct 26  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Dave, Svetlana

GPL added

modrun.pl added - simpler (snykov only) version of run.pl for distribution
  with Web model

Bug-fix: 2nd open of IO_TMP removed in  LandDefs_ml

SeaSalt_ml :  default Tw changed to T2 (not 283) for cases where no SST
               (involves bug-fix for SSfi with netcdf).
Met_ml:       foundSST added  to say if SST available. (** not ** available in
                netcdf files!)

xxxxxxxxxxxxxx DELETED TAG: rv3, Oct 24  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Just one commented-out line removed from SeaSalt_ml

xxxxxxxxxxxxxx rv3beta2, Oct 1  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SeaSalt_ml added from Svetlana

Sites_ml - slight format changes

Unimod.f90 - cleaning, Dave

run.pl netCDF option added

xxxxxxxxxxxxxx Dave, rv_Beta30 30 Sep  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx


New modules:
xxxxxxxxxxxx
CellMet_ml - sets met params for lower grid cell, call SubMet
CoDep_ml   - for SO2/NH3
DO3SE_ml   - reads in and set sto. conductance stuff
LandDefs_ml -
LocalVariables_ml   - grid met in Grid%, sub-met in Sub(iL)%
Rb_ml  - for Rb...
StoFlux_ml


Some changes:
Deleted               Replacement
xxxxxxxxx             xxxxxxxxxxxxxxx
DepVariables_ml       LocalVariables_ml
UKsetup_ml            LandDefs_ml.f90
JUN06_gfac1.dat       Inputs_DO3SE.csv
JUN06_gfac2.dat          "      "
JUN06_biomass.dat     Inputs.LandDefs


Changes due to new system:
xxxxxxxxxxxxxxxxxxxxxxxxxxx
Aero_Rb_ml uses LandType
DefPhotolysis_ml - uses Grid%izen
DryDep - *** major re-write ***
Functions_ml - MicroMet stuff removed
Landuse_ml - *** major rewrite ***
Makefile.SRCS - new files, some deletions
Met_ml - invL calc moved to CellMet
Radiation_ml (albedo removed from PAR calc.)
Rsurface_ml
Runchem_ml
SubMet_ml - *** major rewrite ***
My_DryDep_ml

SeaSalt - JUST A FAKE FOR NOW!

Cleanups:
xxxxxxxxxx
Chem_ml
Derived_ml
Emissions_ml
GridValues_ml
Io_Nums_ml
OrganicAerosol_ml
PAR_ml
PhyChe
Setup_1d_ml
Setup_1dfields_ml
Unimod.f90   (now outputs Base_fullrun.nc, not Base_year.nc)
My_Chem_ml
My_Reactions_ml
My_Derived_ml
My_Emis_ml
My_WetDep

Minor (due to renamed modules)
xxxxxxxxxxxxxxxxxxxxxxxxx
MassBudget_ml
ModelConstants_ml
Solver_ml


xxxxxxxxxxxxxx rv2_9_16, Sept.  28th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave:
Bug-fix for old_gsun in DryDep_ml

Svetlana:
Cleanup of Runchem_ml, My_Aerosol

yxxxxxxxxxxxxx Dave, rv2_9_15, Sept.  27th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

d_2d initialised to zero in PhyChem for all components
(check by Svetlana)

Bug-fix in SubMet_ml, as test for water was wrong

DryDep - modified for above + clean up (in case this is the last version).


xxxxxxxxxxxxxx rv2_9_14, (also 13?) Sept.  27th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave
Sites_ml.   2nd Bug-fix for sondes --- for now excluding values from domain boundary.
   Was giving e+254 type values .....


Hilde+Heiko
run.pl corrected so that SR runs works
TimeDate_ml.f90,GlobalBCs_ml.f90,BoundaryConditions_ml.f90 cleaned

xxxxxxxxxxxxxx Dave, rv2_9_12, Sept.  26th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


MicroMet properly added (cvs add)

Sites_ml.   Bug-fix for sondes

xxxxxxxxxxxxxx rv2_9_11, Sept.  25th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave:
MicroMet_ml introduced - has MM functions from Functions_ml
DryDep  - now use MicroMet_ml

chmod a-x *.f90 etc. applied..

NLANDUSE now only from ModelConstants_ml, (old NNLANDUSE dropped)
DepVariables now "uses" ModelConstants_ml

gc_com_for_1proc deleted

Semeena:
DOC updates

xxxxxxxxxxxxxx rv2_9_10, Sept.  25th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Hilde:
PhyChem:
Precipitation initialized(bug corrected)


Updates related to N2O5 hydrolysis:

N2O5_hydrolysis_ml : added
Setup_1dfields_ml.f90: f_Riemer moved to N2O5_hydrolysis_ml
Setup_1d_ml.f90:  f_Riemer  from N2O5_hydrolysis_ml
Solver.f90: f_Riemer,VOLFAC from N2O5_hydrolysis_ml
ModelConstants_ml.f90: VOLFAC moved to N2O5_hydrolysis_ml
My_Chem_ml: bug in rcmisc(8,k). This bug makes the new reaction rate (for the N2O5 hydrolysis) 4-8 times smaller

Svetlana:
Out_restri_ml removed, also in Unimod, Makefile.SRCS., My_Outputs_ml, OutChem_ml.f90
Some cleanups in those modules.
EmisGet_ml - cleanup

Dave:
Cleanup in My_Chem_ml, PhyChem


xxxxxxxxxxxxxx Semeena, Heiko, rv2_9_9, Sept.  23rd 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Updates to documentation

New run.pl with SR stuff placed near end of file.
  (SR functionality not yet tested though!)


xxxxxxxxxxxxxx Peter, Svetlana, rv2_9_8, Sept.  21th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

run.pl $linex~ s/!.*//;
	for cases where NPROCX has been uncommented

Solver_ml - cleanup

xxxxxxxxxxxxxx Dave, Michael,  rv2_9_7, Sept.  20th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Io_Progs - extra options added to check that required key-value pairs exist.

run.pl   -  Michael's user corrected, and location of sites/sondes redefined.

Sites_ml.f90   --- now expects sites.dat and sondes.dat to have formatted headers.
                   + cleanup

SmallUtils - small update (trim used)

xxxxxxxxxxxxxx Peter, rv2_9_6, Sept.  19th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Setup_1d_ml: checkstop when a NaN is detected
             removed: use MyChem_ml,  only :  Set_2dBgnd

Met_ml: CheckStop(nhour/x0 .and. nhour /x3..) for netcdf metinput

EmisGet : removed stop when country "N/A" is detected

run.pl: changed the crash message
        included $METformat to switch to necdf for netcdf metdata
	changed -lnodesx16 to be compatible with ModelConstants

xxxxxxxxxxxxxx Dave, rv2_9_5, Sept.  15th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

CheckStop added into find_index - to catch cases where the index isn't
   found (was used to track down D2_indices which were not set in
   My_Derived).

My_Derived changed to force use of the hard-coded D2_ values (e.g. D2_AFSTDF16).
  (Should modify rest of code to be more flexible).

Landuse_ml -- commented out lc_water, lc_ice to remove problems.  Will be
  fixed in forthcoming version.

xxxxxxxxxxxxxx Dave, rv2_9_4, August 30th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Biogenics_ml re-written to simply read in BVOC emission potentials, rather than
   calculate them. Now same procedure for EMEP domain, GLOBAL and HEMIS.

  Associated changes and small tidy-ups in Emissions_ml,  Setup_1d_ml,
     Setup_1dfields_ml, Unimod.f90

Derived_ml --- debugging now uses debug_proc etc. from GridValues. Small bug-fix
    which caused WARNINGS for PR/DEP.

Io_Progs_ml, optional argument CheckValues added to ReadSDN, to let user specify
   key-value pairs that must be included in input file.

Landuse_ml   - slight rename of Inputs.Landuse
My_Emis_ml   - removed MY_MODEL
Met_ml       - small tidy-up
TimeDate_ml  - small tidy-up

run.pl --  $NDATA points to new Inputs directory.
           prog.exe now added into Remove.sh

Inputs: new inputs directory, ~mifads/Data/EMEP (GLOBAL + HEMIS) created while
  new style data being created (with headers and key-values)

cvs DELETED::  UiO_ml  Wrtchem_ml

xxxxxxxxxxxxxx Peter, rv2_9_3, August 28th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Unimod.f90: Removed call to DefGrid (moved into Met_ml)
	    Read input parameters using read_line

Met_ml.f90: call to infield(1) and DefGrid in the MeteoGridRead routine,
            for the case where felt files are used.


xxxxxxxxxxxxxx Dave,  rv2_9_2, July 26th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

More variable name changes, for i_glob, j_glob. Full list of recent
changes is:

    ISMBEG x> "IRUNBEG"
   ,JSMBEG x> "JRUNBEG"
   ,IILARDOM x> "IILARGEDOM"
   ,JJLARDOM x> "JJLARGEDOM"
    IILARGEDOM  x> "IIFULLDOM",
   ,JJLARGEDOM  x> "JJFULLDOM"
   ,i_glob  x> "i_fdom"
   ,j_glob  x> "j_fdom"

 The idea is to prevent confusion between global as in for the
World and the computer-concept of global for the full domain.
In future I think global should refer to the World-scale.


DOCS/Manual.tex - changed with suggestion of Part A, Part B
     Outputs.tex - new description of derived outputs
     Input.tex -  small change for input files (DO3SEinputs.csv
            will be introduced soon in place of old MM_biomass, gfac etc.)


xxxxxxxxxxxxxx Dave,  rv2_9_1, July 20th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Major change - rewrite of Derived and My_Derived

      - should now be much easier to add or remove params from list to be
        included -- just give names (e.g. "DDEP_OXN"). No need to count :-)
        Also, now there is just 2d and 3d  stuff, no more ddep_ and wdep_.
        No need of DUMMY either in 3d output.
        Arrays are allocated as needed.


SmallUtils - added AddArray and LenArray to add arrays, and to count number of
    allocated elements (not allocated define with NOT_SET_STRING

Included Svetlana's OutputChem_ml, a wrapper containing Wrtchem.f90 and other
   subroutines

Deleted: Wrtchem.f90 - now in OutputChem_ml

run.pl - check now added that the number of processors in run.pl matches
   the number in ModelConstants_ml.f90

TO-BE-DONE

 Changes need to be transferred to ACID version

xxxxxxxxxxxxxx Dave,  rv2_9, July 19th 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Major change:

 Par_ml.pat   -- deleted! -- now set RUNDOMAIN, and NPROC stuff in ModelConstants
 Par_ml.f90   --  now a normal file, not changed between runs

 ModelConstants - now has:

    RUNDOMAIN x (/  36, 167, 12, 122 /)     ! EMEP domain
    NPROCX      x   4       & ! Actual number of processors in longitude
  , NPROCY      x   4       & ! Actual number of processors in latitude
  , NPROC       x NPROCX * NPROCY

    DomainName x "EMEP-50kmEurope"

  i.e. run.pl does *not* set the model domains any longer, only the year, NTERM, etc.
  Note also --   need to set lnodes correcly in run.pl - but now check values from
  ModelConstants_ml. In future may be able to make this automatic, but not so far.


  Some renaming:

      Instead of using the terms global domain and small domain, I am trying to
      move to full domain (170x133 or global if it really is a global model!)
      and "run" domain.

        ISMBEG ->    IRUNBEG
        JSMBEG ->    IRUNBEG
        IILARDOM  -> IIFULLDOM
        JJLARDOM  -> JJFULLDOM


   Some re-arrangements:

    All "use" statements moved to top of some modules
    Started putting "use" statements  in alphabetical order - much
     easier to find now. Except --  Start lists with My_ modules.
    Thus,

       use My_Chem_ml

       use CheckStop_ml
       use ModelConstants_ml


 Emissions_ml   - very small tidfy up

 Io_Progs_ml      Read2D added

 + probably some other small tidy-ups.


xxxxxxxxxxxxxx  rv2_8_1,  July 2nd  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Provisional - needs to be tested still!!!!!!!


Met_ml:  Cleaned(Jan Eiof), also  some extra Met params made available
           (RH2m, Soil water --- but both seem to have problems!)

DOCS/cookbook + other :  Cookbook  1st darft added, Semeena. Now have
     both a cookbook for new users, and a Manual for programmers.
     Do either of:

         latex cookbook
         latex Manual

GridValues_ml: dependence on Io_ml removed (ds)

Io_Progs_ml:   read2DN added (ds) - "fast"  read of New-style input data for
       a file with x, y, z1..z2 type data.


Landuse_ml:  Uses read2DN (ds). Saved 50 lines :-)


xxxxxxxxxxxxxx  rv2_8,  July 2nd  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

As used in year 2007 EMEP report work, for SR etc,.

As rv2_7_10, but:

new run.pl from Heiko - replaces earlier run.pl, SRrun.pl,  etc.

GridValues_ml, Landuse_ml, KeyValue_ml, Volcanos_ml - DEBUG switched off


xxxxxxxxxxxxxx Hilde, Dave, Svetlana, rv2_7_10,  Jun 12-25  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Country_ml  - Serbia and Montenegro added properly

EmisGet_ml  - added safety check on country codes

ReadField_ml  - corrected bug (not initialising integer fields, e.g. snow)

Volcanos_ml  - corrected bug in coordinate systems. Started move to i_local

xxxxxxxxxxxxxx Misc, rv2_7_10,  Jun 7  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


Svetlana :
      found (non-fatal) bug in CheckStop in BoundaryConditions_ml

Dave:
      Rsurface_ml - Swapped Idir, Idiff, removed albedo

Michael:
      Aqueous_ml - cleaned

xxxxxxxxxxxxxx Misc, rv2_7_9,  May 30 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave:

    Major changes xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

      Io_Progs_ml added -  new system for reading input files. Simpler (I hope!)
             syntax, requirement for descriptive headers and lines in input

      Io_Nums_ml added - just integer values
             file. See Manual for description.

      Io_ml now just wrapper for Io_Nums_ml, Io_Progs_ml

      KeyValue_ml - NEW - simple routines for dealing with a fortran equivalent
         of a key-value pair - a crude attempt to redproduce
         some of the nice features of perl's hashes or python's dictionary

      Landuse_ml - recoded to use new inputs format, Read_Headers, read_line
          and simpler syntax

      SmallUtils_ml - NEW -  module for small utilities. find-index stuff and wordcount
           moved here, and WriteArray added.

      UK_ml, now renamed DepLanduse_ml and recoded as above

      DOCS/Manual/Inputs.tex - started description of new input formats
      DOCS/Manual/Domains.tex - added description of coordinate systems,
           which have confused me for years!

  NEW - Usage of Self_Test in some modules - highly encouraged!!

    Small changes xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
      CheckStop_ml - added test for CheckStop( string1, string2, info )

      DepVariables_ml - lc_water, lc_ice added - no effect for now, but
           start of recoding

      DryDep_ml - just renaming, UK_ml to Landuse_ml, etc.
      EmisGet - small changes
      GridAllocate_ml -  small changes

      GridValues_ml  -  some tidy up, and table created for various coordinates
          (prints out li0,li1,limax, etc..... for each me )

          i_local, j_local arrays created (reverse of i_glob, j_glob)

      Makefile.SRCS - updated
      MassBudget_ml - small changes
      Par_ml.pat - CheckStop
      SeaSalt_ml -  just renaming UK_ml
      Setup_1d_ml -  renaming UK_ml + small tidy up
      Sites_ml    -  errmsg added
      Unimod.f90 - smnall changes

+ Landuse.MAY07 created - essentially landuse.JUN06 but with new formatting
+ changed in run.pl

xxxxxxxxxxxxxx Misc, rv2_7_8,  May 21 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Fixed various problems with 2_7_7

Plus, Cleanups and CheckStop from Michael:

     Sites_ml
     Solver_ml
     Output_hourly
     ZD_OZONE/My_Outputs

xxxxxxxxxxxxxx Misc, rv2_7_7,  May 16 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave:  Makefile.SRCS added - list of .f90 files, included from all
        other Makefiles.

      CheckStop_ml : Changed name of confusing is_true to is_error

      Moved GridAllocate from Functions to GridAllocate_ml
      - changes in EmisGet,  UK_ml

      Added Self_Test routine in GridAllocate_ml

      UK_ml - cleaned from CheckStop comments


Hilde: CheckStop added in: BoundaryCOnditions_ml
                           Derived_ml
                           GlobalBCs_ml
                           RunChem_ml


Svetlana: Cleaned up Timefactors_ml


xxxxxxxxxxxxxx Misc, rv2_7_6,  May 11 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dave: Added new module CheckStop,  to simplify error-testing and
       calls to MPI_ABORT. Can now do e.g.

              call CheckStop( lu<0,"UKdep lu problem"), or,
              call Check(errmsg,"Something fishy here...") , or, ...

        - there are five possibilities.

       Functions_ml - small cleanup

       ReadField_ml, implicit none added! BUG fixed, CheckStop added,
         + new subroutine to read 3D fields

       Unimod.f90 - check digits(1.0) - that compilation uses double precision

Peter: CheckStop in NetCDF_ml

Svetlana: CheckStop in Emissions_ml
                       Met_ml
                       Volcanoes_ml
                       Par_ml

Jan Eiof: CheckStop in EmisGet_ml
                       DefPhotolysis_ml
                       Biogenics_ml
                       ReadField_ml (+ Dave's changes above)

Semeena: Cleaned:      MassBudget_ml


xxxxxxxxxxxxxx Misc, rv2_7_5, Apr 19 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

April 10th, Dave:

  removed Dates_ml from Makefiles.

  modified ReadField_ml, to allow more than one input line per i,j coord
                         + fewer write statements

April 18th, Peter/Semeena:

	Updated NetCDF_ml such that:
	1) Output is CF-1.0 compilant for the vertical coordinates
	2) Corrected a bug when 3D hourly output is required

	Derived_mland My_Derived: renamed D2_PS as PS, to be more compatible
	with what other use (PS is used in the definition of the vertical levels)

	run.pl: put lpmemx200MB


xxxxxxxxxxxxxx Misc, rv2_7_4, Mar 30 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Cleanups:

Michael: Aero_water.f90

Svetlana: Volcanos_ml.f90


xxxxxxxxxxxxxx Misc, rv2_7_3, Mar 29 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Hilde: Dates_ml replaced by TimeDate_ml (TimeDate corrected for bug). Changes in:

 (calc daynumber) Derived_ml.f90
 (daynumber) DryDep_ml.f90
 (nydays) Emissions_ml.f90
 (daynumber)GlobalBCs_ml.f90
 Met_ml.f90
 (date type) Nest_ml.f90
 NetCDF_ml.f90
 Timefactors_ml.f90
 (daynumber) Unimod.f90
 Wrtchem.f90

Minor changes in:
 Advection_ml.f90
 ModelConstants_ml.f90
 PhyChem_ml.f90
 My_Chem_ml.f90
 My_Outputs_ml.f90
 UK_ml.f90
 Setup_1d_ml.f90


Peter: Output_hourly: reversed/corrected order of k-levels in Output_hourly
       (for Semeena's work)

Semeena:  AirEmis_ml cleaned and documented



xxxxxxxxxxxxxx Misc, rv2_7_2 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Peter: Advection_ml: more robust advection for global model.
       UK_ml: bug in effectivdaynumberxdaynumber (no consequences in practice)

       Met_ml: bug in my gc/MPI changes (rv2_7): gb,gl,gb_glob and gl_glob may be wrong
               on nodes different from mexx0.

       Added comment in Emissions_ml (newmonth):units are ktonnes PER YEAR
       Comment:shouldn't we define emissions as ktonnes per 365 days?
       A leap year has more 1 day more DMS emissions than a 365 days year...

Dave: xRgsO corrected in Rsurface_ml for snow. Will change results slightly.


xxxxxxxxxxxxxx Misc, rv2_7_1  2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Peter:
   Nest_ml - Modex12, for read 3D at start of run and write at end
	     and corrected bug in lat lon nesting.
   Makefile_snow, Makefile_njord - replaced Polinat_ml with Trajectory_ml

Joffen:
 Country_ml - cleaned, March 6 2007. This version includes the
  division of ship emissions into inside/outside the 12 mz, EU/ROW flags,
  Ferries/cargo ships as this is supposed to be the "strategy" for the
  future.

  EmisDef_ml.f90: Cleaned by Joffen, March 6th 2007.
   With the division of the ship emissions in Country_ml,
   lots of new "countries are defined in the same grid. thus the
   number of countries allowed in one grid has to be increased (to 10)
   in EmisDef_ml.f90

  Emissions_ml.f90: Modified for use of timefac_index from Country_ml

  Trajectory_ml - replaces Polinat_ml (mainly name change)
  PhyChem_ml    - now refers to trajectory_out


Dave:
  ModelConstanstants_ml - removed assign_nmax, assign_tdadvec

  Advection_ml - placed assign_nmax, assign_tdadvec here


Misc:
  Unimod.f90 - changed to accomodate above changes in routines/modules
    (+ close(IO_TMP) added. Bug!)



xxxxxxxxxxxxxx Peter 5/3 rv2_7 2007  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

All gc_ routines removed! They are replaced by the standard MPI routines.
Affect most of the files.
You can find an overview of the MPI routines for example at:
http://www.llnl.gov/computing/tutorials/mpi/

My_Outputs_ml: Hourly_ASCII x .false. (seriously slows down the program if /global/work is used)
UK_ml.f90: define "effectivdaynumber" for treating Growing Season in Southern Hemisphere
Runchem_ml and Solver: removed dt,reset_chem and Niter, which were not used and may create confusion.
Added Par_ml.f90. It allows to compile without script.

Only numerical changes (<1.E-6) on results.


xxxxxxxxxxxxxx Peter, Dave   rv2_6_6  6/2...31..23..25/2/2007 xxxxxxxxxxxxxxxxxxxxxx

Advection_ml: renormalization between horizontal and vertical advections in  advecdiff_poles

Dates_ml: extended to 2006, but only MaceHead to 2005 in global yet.

Functions_ml:
Some minima criteria in Ra removed to prevent problems in extreme stable cases

GlobalBCs_ml - updated to 2005

Nest_ml (and Unimod.f90 ,PhyChem_ml):
Mode 10,11 for warm start option and corrected bug ("idimid") when writing in lat lon

NetCDF_ml:
allocate a real*4 array instead of real*8. Avoids possible underflow errors and saves some memory.


XM_MAX_ADVEC removed from Met_ml and Model_constants (was not used)

Met_ml:
small change in definition of "cyclicgrid"

Rsurface_ml:
Some minima criteria removed to prevent problems in extreme stable cases

run.pl
Simplified, especially for input files.
Included Tareq in run.pl USERS.

Removed srun.pl, nrun.pl, local2global.f, global2local.f, gc_com.f from cvs

xxxxxxxxxxxxxx Peter   rv2_6_5    19/1/2007 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

New common run.pl script for njord and snykov. NB: It also use /global/work on snykov.
Use this one as it will simplify maintenance to have
fewer scripts. Not yet made for SR runs (should also be done with the same script).
Choose  $NJORDx1 or $SNYKOVx1 in the script.


Derived_ml:
Changed units written in outputs for all depositions (ug/m2  was written instead of ugS/m2)

Small changes for the global version: (does not affect other runs)

Advection_ml: 2 old "bugs" corrected.
	preadvx(2): did not work if west neighbour x east neighbour (possible in cyclic grid)
	adv_var: nonblocking sends. Otherwise may hang if extremely large grids are used.

Met_ml:
Defined poles when lat > 88 degrees.
Small changes in the extrapolation of xm outside the grid.

Country_ml:
country 67 -> timezonex-100. For unknown countries

xxxxxxxxxxxxxx Peter   rv2_6_4    13-30/11/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Dates_ml - extended LAST_SDYEAR to 2006, Dave

15th Nov put  if(Ascii3D_WANTED)then around the 3d ascii output in Wrtchem.f90
Derived_ml :PS units in hPA

15th Nov Advection_ml "else where" replaced by  "elsewhere" to stop Njords f90 comlpaining

Makefile_njord
Use /home/ntnu/usrlocal/netcdf/netcdf-3.6.1 instead of mifapw's library
Changed -O4 into -O3 -qarchxpwr5 -qtunexpwr5 , because of compiler error during IPA, when compiling the HEMIS grid.


xxxxxxxxxxxxxx Dave   rv2_6_3    3/11/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

On request of Peter, removed *.f files (except gc_fcon_for_1proc.f)

xxxxxxxxxxxxxx Peter  rv2_6_2   27/10/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Version compatible with "njord", IBM p575+ 16-way nodes, AIX , Load Leveler

gc_com,local2global,global2local set to f90

MARS_ml.f90 line 864 1.d0 changed to 1.0
TimeDate_ml: line 53 reduced month length to 10
Derived_ml.f90 : case ( "MAXADV" ) changed forall (program crashes with segmentation fault otherwise??)
Advection_ml: changed hel1/hel2 into hel1/(hel2+1.0E-100)
	      because of overflow otherwise (compiler weakness, works without if only -O2 is used)
removed all *.f files (gc_com.f,local2global.f,global2local.f)
new nrun.pl and nSRrun.pl (n for njord)

Makefile_njord created
Makefile_snow updated (.f removed or replaced with .f90)

Put values in the "k" og the Boundary_and_Initial_Conditions.nc


xxxxxxxxxxxxxx Heiko  rv2_6_1  25/10/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

 I just found a problem in the Makefile_snow, it included

 clean:
 	rm ... \
 	touch ... \
 	make depend


 The last one did thus run 'make depend' instead of 'make -f
 Makefile_snow depend'. This is fixed in the cvs'd file.

xxxxxxxxxxxxxx Peter  rv2_6   23/8/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Included Nesting options.
Not enough tested but needed for ENEA delivery: 3D BC 3-hourly all components.
For a nest run: Set MODE and istart,jstart,iend,jend

Nest_ml: completely revised
NetCDF_ml: secondssince1970 public,
           not time at middle of period for instant data (like BC).
PhyChem_ml: moved wrtxn call.
ZD_OZONE/My_Derived: SR x false "consistent"
srun.pl :small changes


xxxxxxxxxxxxxx   rv2_5   11/7/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Also version used for Jul 2006 SR runs for IIASA


xxxxxxxxxxxxxx   Hilde   11/7/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Mace head correction for 2004

xxxxxxxxxxxxxx   Peter rv2_5beta2   1/7/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SRx0 should work too  (SRrun.pl)

Changed My_Reactions so that it is fast on snowstorm (and embla).
The old one has been put into My_Reactions.inc_blizz


xxxxxxxxxxxxxx  Anna, Peter, Hilde rv2_5beta2   30/6/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SRx0 should work too

SRx1 moved higher up in SRrun.pl (was bug: $iyr_trend was never set to 2010)
$iyr_trend x "2020" if $SR  in SRrun.pl


SRrun.pl changed to include PM_ADDED. mkp.pmemis_from_nox changed (and new name), do not include Azerbaijan anymore - we have those PM emissions.
Country_ml.f90: ATX now seax1

noxsplit.special.2000 should not have been there, the default split should be used for all years before 2010. File removed from datadirectory.

xxxxxxxxxxxxxx  Anna, Peter, Dave rv2_5beta2   28-29/6/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SR version

My_Derived:
SOURCE_RECEPTOR x .true.
NDERIV_3D x  0

Global_BC:
macehead for iyr_trend > 2010 set to +4.5 (was set +3+4.5x7.5!)

DEBUG options set to false in rv2_5beta

SRrun.pl created to look after SR runs
ATX defined as part of ATL and RUX as part of RU (in femis)

iyr_trend added to RunLog output


SEASALT set to .false.

xxxxxxxxxxxxxx Dave, rv2_5beta   27/6/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

New flux parameters slightly re-defined. MMAOT30 and MMAOT40 added - AOTs according to
 new Mapping Manual approaches.
 Now:
    D2_AFSTDF0, D2_AFSTDF16, D2_AFSTBF0, D2_AFSTBF16, &
    D2_AFSTCR0, D2_AFSTCR3, D2_AFSTCR6,&
    D2_MMAOT30, D2_MMAOT40

Country_ml - updated from Heiko

Derived_ml - new flux stuff added

DryDep_ml - SumVPD limitations added for IAM_WHEAT

UK_ml - safety checks added on SGS, EGS
        InGrowingSeason array defined to simplify MMAOT calculation


xxxxxxxxxxxxxx Dave, rv2_4_8   25/6/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Ooops.... forgot to copy My files form main directory into ZD_OZONE before cvs commit.
Done now....
xxxxxxxxxxxxxx Dave, rv2_4_7   22/6/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

New flux parameters defined,  see JUN06 changes
    D2_AFSTDF0, D2_AFSTDF16, D2_AFSTBF0, D2_AFSTBF16, &
    D2_AFSTCR0, D2_AFSTWCR, D2_AFSTCR6,&
    D2_AFSTCN0, D2_AFSTCN3, D2_AFSTCN6,&

New landuse setup files - in JUN06_biomass.dat etc.
  - results in different growing seasons and depositions for forests
    (e.g. reduced deposition in summer in Mediterranean)

New landuse map - some small corrections, and 3 IAM categories.

Used 4.5 ppb for iyr_trend >x 2010 - quick fix for JUN06 IAM runs.

$MAKE added in srun.pl, to call Makefile_snow if needed. Check if it
       works for others, and usage of .depend!!!

xxxxxxxxxxxxxx Peter v2_4_6_1, 14/6/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Updated srun.pl: corrected bug (see rv2_4_5). Include "Africa"
Added: Makefile_snow

xxxxxxxxxxxxxx Joffen v2_4_6, 30/5/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

noxsplit changes - splits NO and NO2 similar to VOC. Use "2000" files to get default
9:95% split that we had before

... and from Dave : srun.pl added to cvs, for UiT use.

xxxxxxxxxxxxxx Peter rv2_4_5, 15/5/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug in grun.pl put in version 2_4_3. Wrong meteo link.
Sometimes the first day of a month is linked to the 1/1/ of next year.
The program will notice this and crash.


xxxxxxxxxxxxxx Peter,Heiko rv2_4_5, 19/4/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Added gc_com.f into the CVS repository. Seems to be missing. It should have been added when Peter removed gc_com.F


xxxxxxxxxxxxxx Peter rv2_4_4, 15/2/2006 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Accept any projection in CF-1.0 convention.

NetCDF accept "general projection"
Met_ml  accept "general projection"
moved some "use Gridvalues :sigma" (the SGI compiler didn't like variables
                        to be send as argument and defines with "use")
GridValues AN calculated in GlobalPosition
Derived_ml daily D3_THx.False.
Dates_ml: included 2004

xxxxxxxxxxxxxx Peter rv2_4_3, 16/12/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Better Global version. In case of lon-lat grid and poles, special advection
routines are used.

grun.pl includes a parameter   $HEMIS which (whenx1) makes the script link to
the hemispherical input data. (this script is however quite messy...)
meteo year must be 2001 then.
(put also READBVOCx.true. in Biogenics_ml for improved BVOC emissions)

Meteorology for a whole year can be found at (met.no):
/fou2/emep2/Meteorology/ERA-40/2001_HEMIS_PS/

or (blizzard):
/home/peterw/emep/work/metdata/ERA_2001_HEMIS/


No changes of results in "normal" runs, except that in Country_ml, Russia (42)
 is defined with timezone -100, which means that longitude time is used.
(can be changed in the file if wanted)


ModelConstants_ml, Unimod.f90,Solver: dt_advec is set according to gridwidth

EmisGet_ml: use country%index to interpret country mumbers in emis
files and femis.dat

Country_ml: 193 countries defined (country index semi-official: defined by Heiko)

Met_ml: bug: should broadcast projection (concern only netcdf met input)

AirEmis_ml: bug when longitude close to 360 degrees or when latitudex90

Emissions_ml: bug in "daytime_longitude"

Advection_ml: new subroutines for advection used in case of lat-lon
grid. Less good treatment of the xy time splitting, but faster and
can cope with singularity at Poles.
Changed also adv_var, so that it can treat the
case when a subdomain is its own neighbor (cyclic grid).
For best efficiency of advection it is recommended to use NDYx2 (or
NDYx1) in case lat-lon and poles are included in the domain.


PhyChem_ml: calls  advecdiff_poles instead of advecdiff when necessary

GridValues_ml,Met_ml,Unimod.f90:: removed jmin_advec, jmax_advec, put Poles into GridValues

GlobalBC_ml,GridValues_ml: redefined lb2ij

Sites_ml: can read files in lon-lat coordinates. The file must be
called sondesLL.dat or sitesLL.dat. Height is always set to KMAX_MID.

Biogenics_ml: Includes an option to read BVOC.dat directly
	(temporary solution)


xxxxxxxxxxxxxx Peter rv2_4_2, 22/11/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

EmisGet changed to include VOC sector 10 by default (perviously excluded).
Now only sector 11 is exlcuded.

xxxxxxxxxxxxxx Peter rv2_4_1, 22/11/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

GLOBAL version of the model

Lat lon grid possible (defined through mapping factors xm_i and xm_j)

Cyclic grid in i direction

Special treatment at poles:
	-.no "neighbors", but not an outer boundary
	-.special treatment of advection

Emission_ml includes an option to choose that the local time
 (used for the day/night timefactor) is determined by the longitude
instead of the timezone defined in "Countries_ml". This option is selected when timezonex-100.
This should be better at least for countries which cover many
timezones (Russia, USA ...)
 (This also avoids defining timezones for hundreds of countries :-)

splitted parinit into two subroutines, one for subdomain sizes and the
other for neighbors and BC definitions

Removed the last optional argument from CloudAtten in Radiation_ml:
it produced a compiler error in PhyChem_ml, even if I didn't change
PhyChem nor Radiation !?

EmisGet keep VOC from sector 10 (it was removed in earlier versions)

Modified: Unimod.f90, Model_Constants, GridValues_ml, Met_ml,
Boundary_Conditions, Par_ml.pat,NetCDF_ml, Advection_ml,
Emissions_ml, My_Output_ml, Radiation_ml, EmisGet_ml

Still the results are not affected by these changes (!)
Yearly results compared to rv2_1 by Joffen.



xxxxxxx
xxxxxxxxxxxxxx Peter rv2_4, 2/11/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
(These are same. dave changed number since the changes are substantial

xxxxxxxxxxxxxx Peter rv2_3_3, 26/10/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Major clean up of binary output and all the .F files. As a consequence several parts of
the Makefile got also cleaner.

Removed:
Output_binary_ml,rmycop.c,getflti2.f,getflti2.F,putflti2.f,putflti2.F,outchem_restri.f,
put_restri_i2.f,put_restri_i2.F, gc_com.F

Modified: Met_ml, NetCDF_ml, Wrtchem.f90, Output_hourly.f90 Makefile

Parts of Output_binary are moved into Wrtchem.
Parts of getflti2.f are put into Met_ml in order to still be able to read the met files in binary.

Results are not affected by these changes

xxxxxxxxxxxxxx Peter & Joffen (+Maarten+Dave)  rv2_3_2, 6/10/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

New AirEmis from Joffen. More general: can use any grid. Some differences
in results can be expected (due to different vertical interpolation).

Changes in GlobalBC Macehead corrections.
The macehead correction uses now lat lon coordinates instead of "i,j".
This will however make a difference on the results, since the "Macehead sector" is now
defined with lon lat borders. I choosed these rather arbitrarily.
A small test for 2001 shows the following for the "O3fix" correction:
jan: old O3fixx-6.903 ; newO3fixx-6.635
aug: old O3fixx-4.871 ; newO3fixx-4.876

In the future we should also introduce an option (as an input parameter)
to skip the Macehead correction


Changed Par_ml.pat so that also the large domain is set by grun.pl
Changed grun.pl sp that it sets the large domain in Par_ml.
The date of start is now read in by the model.
The program tries now first to find at NetCDF meteo input file, if it does
not find it it reads the old felt files.
NB: You MUST update grun.pl


Changed definition of xm_i and xm_j: now it is directly the mapping factor
at the boundary of two gridcells.

Changed slightly Timefactors: if just "fname" is declared the values of "an" (from GridValues)
is overwritten(!!!). If instead fname2 and fname0  are declared (as done now) there seems to be
no problems(!). Very strange. Most probably a compiler error. The strange behaviour don't appear
when all the debugger options are on.

NetCDF_ml: We go over to CF-1.0 convention.

Output_binary: corrected an old bug
     !character(lenxsize(f_2d(1)%class)) :: typ  !  See defs of f_2d
     character(lenxlen(f_2d(1)%class)) :: typ  !  See defs of f_2d

Modified: NetCDF_ml, AirEmis,Met_ml,Par_ml.pat,GlobalBC,Log.changes,GridValues,
Unimod.f90,Timefactors_ml,grun.pl,Output_binary


xxxxxxxxxxxxxx Peter,   rv2_3_1, 5/10/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
NetCDF input for BIC.

Changed GlobalBCs_ml.f90 so that it can read the BIC from a netCDF file.
The file should be named "Boundary_and_Initial_Conditions.nc" (for now).
If the file or component is not found it looks for the "old" BIC files (D3_O3.01 etc).

An example of BIC file is given in /noserc2/emep/BIC/BIC.nc
Using this file should give the same results as before.
It contains also O3 data constructed from sattellite data. (This data needs to be more tested/ developed)

In the future the BIC.nc file should be global and the fields are to be interpolated to the required grid.

Some changes in NetCDF_ml and corresponding changes in Output_binary and Output_hourly.

Included xm_i and xm_j: the directional map factors. These are equal for a Polar Stereographic projection. (not yet tested in another grid)
(GridValues_ml and Met_ml)


xxxxxxxxxxxxxx Dave,   rv2_3, 11/7/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


Re-labelling only, for EMEP report writing process.......


xxxxxxxxxxxxxx Dave/Hilde,   rv2_2_14 , 14/6/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

.depend:      Removed from CVS. Not needed, as gmake depend generates it, and
              it complicates cvs commit.

DryDep_ml:    Tidy up (interim), plus some commented out code marker for
              EXTRA_LU outputs added - often used, but has no effect as coded
              now. Can be used to call user-generated include files if
              uncommented.

GlobalBCs_ml: Small correction to Mace head correction

GridValues_ml:  New DEBUG system introduced. GridValues now works out immediately
        which processor the DEBUG_i, DEBUG_j coordinates apply to (new logical
        debug_proc set true), and then calculates the local coordinates
       (debug_li, debug_lj). Other modules may now printout debug info with
       a system such as :


           if ( debug_proc )  then
              write(*,*) "Debuuging ", some_data(debug_li,debug_lj,KMAX_MID)
           end if

         ... instead of having to test i_glob, j_glob against DEBUG_i, DEBUG_j
          as before.  ( See the new PhyChem_ml for other examples)

         Request: please switch modules you work on to this new system - it is
         cleaner and faster.


PhyChem_ml.f90 - replaces phyche.f. Finally f90 !!!!!!!! ;-)

           Code tidied up. Makes use of DEBUG_i, DEBUG_j

phyche.f   ..... history !


Setup_1d_fields_ml - removed unused Idrctt, Idffuse

Unimod.f90         - uses PhyChem_ml, tidied up "use statements"



xxxxxxxxxxxxxx Hilde,   rv2_2_13 , 10/6/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Mace head correction for 2003 updated

xxxxxxxxxxxxxx Dave,   rv2_2_12 , 20/5/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

DryDep_ml.f90 - bug fix on SAIadd(WHEAT)

My_Reactions - bug fix on Rn222

My_WetDep    - renamed adv to itot since the index is for the xn_2d arrays, not ADV

Aqueous_ml   - renamed adv to itot since the index is for the xn_2d arrays, not ADV


xxxxxxxxxxxxxx Dave,   rv2_2_11 , 11/5/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Small changes in Met_ml and where iclass used:

iclass array replaced by more descriptive nwp_sea logical - we only
ever checked if iclass xx 0 anyway.

r_class  - declared simply, not with allocatable.

xxxxxxxxxxxxxx Dave,   rv2_2_10 , 22/4/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

psurf replaced by ps throughout. Small error in placement of psurf now hopefully
avoided.

xxxxxxxxxxxxxx Hilde,  rv2_2_9  , 14/4/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
My_chem_ml: small bug
My_Reactions.inc: production rate of Pb210 corrected
Setup_1d_ml: rc_Rn222 should be initialized for all levels. z_bnd converted to cm (from m)

Pb210 changes added to ACID as well (My_Chem, My_Reactions)

xxxxxxxxxxxxxx Dave,  rv2_2_8  , 11/4/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Rn222 and Pb210 added (for CARBOSOL, but a useful general tracer)
Quite crude addition. Should probably be harmonised with
other surface emissions  such as BVOC or Sea-Salt. ToDo.

My_Chem_ml            - Pb210 added
DepVariables_ml       - LU_ICE added
Setup_1d_ml.f90       - rc_Pb210 added
Setup_1dfields_ml.f90 - rc_Pb210 added
(Changes labelled with Pb210)


Met_ml  - small correction from Peter

UK_ml   -   water_fraction  and ice_fraction added


Some general tidy-ups

xxxxxxxxxxxxxx Hilde,  rv2_2_7 , 08/4/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Small errors in ZD_ACIDs My_BoundCondition and My_Outputs corrected

xxxxxxxxxxxxxx Dave,  rv2_2_6 , 08/4/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


New (simpler?) arrangements for calculations of ustar, Obukhov length, Exner
Less confusing use and conversions between temperature (t2_nwp) and
potential temperature (TPot2m).


Some new notations:

       tau     - was fm
       t2_nwp  - was t2
       TPot2m  - was th2m
       ustar_nwp - was ustar
       invL_nwp  - was invL

   The _nwp is used where variables are appropriate to the whole grid. When
   sub-grid procedurs are applied then different values of e.g. ustar may
   be different for different landuses.

Functions_ml
     - Exner function subroutines, and conversion functions between T and Tpot
         - causes changes in Met_ml, Sites_ml, DryDep, .....
       Note that sometimes we need Exner_nd(p) and sometimes CP*Exner_nd(p)

Met_ml
     - tau (was fm) - now created for MM5-type inputs from ustar, on assumption
       that it is better to linearly interpolate tau in metint than ustar.
       (Since tau ~ ustar**2 is proportional to energy.)

     - Surface temp is now t2_nwp. Multiple conversions to old th2m now
       removed. Tpot2m (was th2m)  now done in met_deriv

     - Exner_ml used

SeaSalt
     - use of new ustar_nwp. Moved "use" statements to start of module (should
       be done for all modules)

Tabulations_ml
       Exner stuff removed. Only tab_esat remains!

Also - ZD_ACID/My_Chem changes for new Radiation_ml treatment: zen, radzen
       ZD_ACID/My_Outputs corrected for N_NOy.

DOCS:
    - Corrected figure of Arakaw u,v grid locations, based upon plot from Peter
    - Added new rule in Progrules.tex, suggested by Peter


xxxxxxxxxxxxxx Dave,  rv2_2_5 , 5/4/2005 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Re-write of Radiation_ml and associated handling

**** NEW *****
TimeDate_ml.f90 - added. Much nicer date calculations! (Will supercede Dates_ml
                    in future code)
**** NEW *****

Radiation_ml - subdivided with new routines and re-arranged. Now doesn't need Par_ml.
               Uses elemntal routines to allow use in both 1-d models and EMEP

               Some changes
                 SolarSetup  subroutine
                 Ashrea table ......
                 ZenithAngle sub
                 etc.-

Causes small changes in many routines which used radiation, zen, etc., inc:

   Met_ml - now used to store Idirect, Idiffuse
   PhysicalConstants_ml - DAY_ZEN, DAY_COSZEN added
   phyche.f -  subroutine calls changed

xxxxxxxxxxxxxx Hilde, rv2_2_4  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
GlobalBCs_ml - BC for so2,nox,nh4 allowed for year>2003. Trend BCs also for NO,NO2,PAN
My_BoundConditions, ACID - no3, nh4 bcs added

xxxxxxxxxxxxxx Dave,  rv2_2_3 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

DryDep_ml    - "call ReadLanduse" moved to Unimod.f90
Emissions_ml - some dead code removed
UK_ml        - ukdep_init called on all nodes. Removed  need for man gc_rbcast lines
Unimod.f90   - "call readLandUse" moved here.
Wrtchem      - AOT output removed.

xxxxxxxxxxxxxx Peter, rv2_2_2 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Redefined u_ref into Met_ml including the map factor:
NB: Will influence the depositions rates,
specially in Southern areas (15% higher deposition rate in Greece?).
Concentrations and depositions may change by several % in Southern areas.


I propose the following principle for variables derived from
meteo variables in Met_ml:

one routine (metvar) controls the variables derived from the meteofields
after every meteoread (every METSTEP)

one routine (metint) redefines (interpolates) the meteo fields between
each meteoread (every dt_advec)

one routine (met_derived (new)) derives the meteofields after each
interpolation (i.e. met_derived is called from or after metint)

In this logic tiphys is called from metvar  and u_ref is defined
in met_derived

metvar needs some cleaning. Volunteers?


xxxxxxxxxxxxxx Peter, rv2_2_1 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Defined "ref_latitude" which is latitude for true distances (60 for PARLAM-PS)

GlobalBCs_ml: defined IGLOB x IILARDOM and JGLOB x JJLARDOM (resulting values
are the same as before, but in new grids these will change)

Removed part in ReadField for non-EMEP grid.

xxxxxxxxxxxxxx Peter, rv2_2_0 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Included a new routine into Met_ml which is able to read meteo fields
in NetCDF format. Still under development.
The old one is still used as default.

Some cleaning. Removed some meteo fields which are not often used,
but kept SST for Svetlana)

xxxxxxxxxxxxxx Dave, rv2_1_10  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

UniMan added!
        - intended as guide for new users, and reminder for old ones.


Met_ml - some tidy up ot tkediff subroutine, to follow coding suggestions
         of User guide.

xxxxxxxxxxxxxx Joffen (Peter) 7/3-2005       , rv2_1_9 xxxxxxxxxxxxxxxxxxxxx

Additional meteo prameters are read: cloud convection and sea surface temp (ccc and sst)

Gutas parameterization of the boundary layer turbulaence and the old parameterization are both included. To choose between them the logical parameter  TKE_DIFF has to be set.

In addition some cleaning up of outdated programming has been done, as
do xxx i x 1, iend


xxx continue

where xxx is a number

has been replaced by
do i x 1,iend

end do


xxxxxxxxxxxxxx Peter 21/2-2005            , rv2_1_8 xxxxxxxxxxxxxxxxxxxxx

Moved the parameter NTDAY from Derived_ml into ModelConstant_ml.
Added some comments.
Changed a comment in Advection_ml.

xxxxxxxxxxxxxx Hilde/Dave 18/2-2005            , rv2_1_7 xxxxxxxxxxxxxxxxxxxxx

Submitted Hilde's changes to BCs for historical runs.


xxxxxxxxxxxxxx Dave  17/2-2005            , rv2_1_6 xxxxxxxxxxxxxxxxxxxxx


ReadField_ml
  -Initialisation to zero added, so now we do not need to input an array which
   covers the whole domain.

   Also, print used instead of write for error messages, and
   errmsg more explicit now.

Sites_ml: Fix for Embla/Gridur bug,  where printouts of numbers < 1.0e-99
            were messed up.

          Also, N_NIT renamed to N_NOy, and sum_NIT renamed to sum_NOy, since
          NIT is confusing with nitrate, which NOy isn't.

ZD_.../My_Outputs:   N_NIT -> N_NOy

         Also, max NSITES_MAX and NSONDES_MAX increased to 99.
         (Temporary. Will make arrays allocatable soon....)

xxxxxxxxxxxxxx Peter, 9/2-2005            , rv2_1_5 xxxxxxxxxxxxxxxxxxxxx

N_NIT was not defined in ZD_ACID
Updated ZD_ACID/My_Ouputs_ml so that it is compatible with the ZD_OZONE
changes.I defined N_NITx1. If necessary please define differently.
(Also changed to NHOURLY_OUT x 1, since clouds do not seem to be defined.)

xxxxxxxxxxxxxx Hilde, 3/1-2005            , rv2_1_4  xxxxxxxxxxxxxxxxxxxxx

grun.pl updated also

xxxxxxxxxxxxxx Hilde, 3/1-2005            , rv2_1_3  xxxxxxxxxxxxxxxxxxxxx

Sites_ml.f90: increased nmax_sonde
3D fields for pressures etc, from joffen: Derived_ml.f90, My_Derived
Changes for trend output:My_Outputs_ml.f90
Name on 3D ouput changed: Wrtchem.f90

xxxxxxxxxxxxxx Hilde, 15/12-2004            , rv2_1_2  xxxxxxxxxxxxxxxxxxxxx

BC trends 1980-2003 for S and N based on EPA emissions for 1980-2003 added in
GlobalBCs_ml. For NH4 the trend is based on 2/3SO2 +1/3NOx

Also, PhiH added to Functions_ml, Dave

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    rv2.1 x rv2_0_8   same as used for SR matrix work for IIASA, Oct 2004
            but rv2_0_9 has no numerical change, so we rtag the code here.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


xxxxxxxxxxxxxx Peter, 29/10-2004            , rv2_0_9  xxxxxxxxxxxxxxxxxxxxx

added file gc_com_for_1_proc.f
This can be used as a "fake" gc_com.f in the cases where
NPROCx1 and no mpi compiler is available.
To use it: replace gc_com.f with gc_com_for_1_proc.f and remove the
preprocessing of gc_com.F from Makefile


xxxxxxxxxxxxxx Peter, 5/10-2004            , rv2_0_9  xxxxxxxxxxxxxxxxxxxxx

in grun.pl:  $BCDIRO3    x "$HILDE/BC_data/LOGAN_O3_DATA/50Data_900mbar_mixratio_firstline"

xxxxxxxxxxxxxx Dave, 29/9-2004            , rv2_0_8  xxxxxxxxxxxxxxxxxxxxx

skipx1 on open_file in Global_ml

xxxxxxxxxxxxxx Dave, 29/9-2004            , rv2_0_8  xxxxxxxxxxxxxxxxxxxxx

maceheadxmacehead+3 ppb  for 2010 runs


xxxxxxxxxxxxxx Svetlana, Peter  28/09-2004, rv2_0_7  xxxxxxxxxxxxxxxxxxxxx
SeaSalt_ml.f90 used "rough.170" to find sea areas (iclas x 0)
Now it has been changed to identify sea areas using "landuse.mars2004" data
and scales the sea salt emissions with the water area fraction in the grid.

New grun.pl with extra RunLog info.

xxxxxxxxxxxxxx Peter,Dave;Hilde  24-28/09-2004, rv2_0_6  xxxxxxxxxxxxxxxxxxxxx

grun.pl: Redefined BC from Logan for O3 for OZONE
Defined SOMO0 in Derived_ml
DryDep - modified for safer flux calculations
UK_ml - luflux_wanted set true for decid forests and wheat only.
Makefile without debug options

xxxxxxxxxxxxxx Peter,Svetlana,Dave  24/09-2004, rv2_0_5  xxxxxxxxxxxxxxxxxxxxx

ZD_ACID/,ZD_OZONE/My_Aerosols_ml:
     t20(:)  x 293.  (instead of  t20(:)  x 283.)

molwt defined as real in My_Chem_ml

xxxxxxxxxxxxxxxxxxx Peter,  23/09-2004, rv2_0_4  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Modified Setup_1d and Met_ml: subtracted 1.E-9 from u,v, it2m and itemp.
This should not change results, but is there in order to avoid
rounding differences on gridur and cluster.

xxxxxxxxxxxxxxxxxxx Peter,  17/09-2004, rv2_0_4  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Derived_ml and ZD_OZONE/My_Derived_ml:
five new d_2d ("D2_SOMO35","D2_AOT30f",D2_AOT40f","D2_AOT60f","D2_AOT40c").

NB: the definition of SOMO35 is slightly different than in "hourlyozone2ramot35":
1)the running average is done over 20 minutes intervalles
2)period 16-24 also taken into account (was not in in the first version of ramot35)
Note that the end of SOMO35 day is at midnight (not end_of_emepdayx06:00)

Derived_ml
Introduced new "averaging" for yearly and monthly output of AOTXXc, AOTXXf, SOMO35, D2_MAXO3, D2_MAXOH, D2_EUXXX og D2_UNXXX.

NB: the D2_MAXO3 obtained in the yearly output is slightly different than that obtained using "hourlyozone2ramot35" on hourly output, because in the yearly the max is taken on EMEP_day, while "hourlyozone2ramot35" uses 00:00-24:00.

Dry_Dep_ml: bug corrected (small effect (<1%) on results) in def of SAIadd

My_BoundaryConditions_ml: removed a double declaration of IXADV_H2O2 (compiler on blizzard don't like that)

small changes in grun.pl

xxxxxxxxxxxxxxxxxxx Hilde,  27/08/2004, rv2_0_3  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

GlobalBCs_ml
 My_Chem_ml and My_BoundConditions_ml in OZONE

 H2O2 and CH3COO2 BC corrected for H2O2 and CH3COO2.
 OH BCs in OZONE taken out.

 Hilde 27/8/2004

Output_hourly  -- cfac comments fixed to 50m->3m

xxxxxxxxxxxxxxxxxxx Dave,              6-11/07/2004, rv2_0_2  xxxxxxxxxxxxxxxx

GlobalBCs_ml: 2002 and 2003 added to mace_head. Preliminary values needed for
   EMEP report, derived from Mace Head obs data for CFCs

My_Derived_ml: Warnings only written once now in My_Derived, to avoid huge log
    files (only done in ACID so far)

My_Outputs: Cloud added as example.  (only done in ACID so far)

Output_hourly: "Cloud" added as option for Output_hourly

grun.pl: no bzip2 of hourly.nc file. Some emisdir changes. Alsop BCDIR moved so that
    OZONE always uses 1997 stuff. (BCDIR is only really needed for ACID, since it
    is intended that BCDIR contains the output of OZONE mode runs).

xxxxxxxxxxxxxxxxxxx Hilde,               01/06/2004, rv2_0_1  xxxxxxxxxxxxxxxxxxxxxxxxxx
ACID and OZONE changes to include BCs from OZONE (OH,CH3COO2,H2O2, O3(acid)). For OZONE, this will have
 effect only when a smaller domain than 170*133 is used.
Link to Logan files in mixing ratio.
Some SR-My_Derived stuff that should not have been put into ACID removed.
Files changed:
grun.pl
GlobalBCs_ml
My_BoundConditions_ml
My_Derived_ml, only for ACID
My_DryDep_ml
Setup_1d_ml
My_Chem_ml

xxxxxxxxxxxxxxxxxx Peter/Dave               01/04/2004, rv2_0beta  xxxxxxxxxxxxxxxxxxxxxxxxxx

New grun.pl which also runs SR if required.

new vocsplit data, obtained from a mxiture of IIASA emissions and IER speciation,
for  year 2000 and year 2010.

bunzip2 bug fixed

Biogenics_ml.f90 forests.tf2 renamed to forests.dat


xxxxxxxxxxxxxxxxxx Peter/Dave               01/04/2004, rv1_9_34   xxxxxxxxxxxxxxxxxxxxxxxxxx

grun.pl added  ja and ja -s to give resource use info in the output

New forest and landuse input data


xxxxxxxxxxxxxxxxxx Hilde,               01/04/2004, rv1_9_33   xxxxxxxxxxxxxxxxxxxxxxxxxx
Pseudo H2O2 concentrations introduced in ACID to account for ox. limitations.
Solver and My_Reactions.inc (ZD_ACID) changed.

xxxxxxxxxxxxxxxxxx Peter,               31/03/2004/ 01/04/2004, rv1_9_33   xxxxxxxxxxxxxxxxxxxxxxxxxx
small changes in grun.pl:
	sites.* are tared: tar cvf ${runlabel1}.sites sites.*
	RunLog is renamed ${runlabel1}_RunLog
	bzip2 is made parallell: to compress files just add them into  @bigfile_list
ZD_OZONE/My_Output: only O3 as hourly output

some removal of double declarations
removed version attribute from Netcdf files. (use runlabel instead)

SeaSalt_ml: replaced vind10 ** (3.41) by exp(log(vind10) * (3.41))


xxxxxxxxxxxxxxxxxx Dave,               31/03/2004, rv1_9_32   xxxxxxxxxxxxxxxxxxxxxxxxxx

 My_Derived_ml:

  !ds 24/3/2004:
  !dsNSR - new system for distinguishing source-receptor (SR) stuff from model
  !        evaluation.  The SR runs should use as few as possible outputs
  !        to keep CPU and disc-requirements down. We define first then the
  !        minimum list of outputs for use in SR ("NSR_2D"), then define an extra list
  !        of parameters (dimesnion NEXTRA_"2D) needed in model evaluation, or even
  !        for the base-case  of SR runs.

  Also define SOURCE_RECPEPTOR in My_Derived. Used in Derived to set all daily
  outputs to false if .true.

  Also defined two new params: NOXxNO+NO2, NOZxlots of NOxzy thingies

 Derived_ml:

  Consistency_check in Derived now checks that if SOURCE_RECPETORx.true. then
  dimension of NDERIV_2D xx NSR_2D

  FST30 added to def_2d. Other FSTs renumbered

  Also defined two new params: NOXxNO+NO2, NOZxlots of NOxzy thingies

 DepVariables_ml

     ECO_SEMINAT redefined to include more categories

  My_DryDep_ml

     Depositions to water and wetlands removed.


private added to:
Dates_ml.f90
ModelConstants_ml.f90


And, for information, the file Sorted.Deriv is now in my Unify directory - it
gives the numbers used in the Derived fields. Makes it easy to find some
free numbers for new variables.

xxxxxxxxxxxxxxxxxx Svetlana/Peter,     24/03/2004, rv1_9_31   xxxxxxxxxxxxxxxxxxxxxxxxxx

SeaSalt included into PM10, PM25, PMco

Added some "fake" declarations into ZD_ACID

xxxxxxxxxxxxxxxxxx Svetlana/Peter,     23/03/2004, rv1_9_29   xxxxxxxxxxxxxxxxxxxxxxxxxx
Inclusion of Sea salt

Dates_ml: LAST_SDYEAR x 2003


xxxxxxxxxxxxxxxxxx Dave,     17/03/2004, rv1_9_28   xxxxxxxxxxxxxxxxxxxxxxxxxx

Derived_ml: Many changes

	Bug-fix i_glob defined ,locally
	Deriv for new 3D fields added
        d_3d for new 3D fields added, inc use of End_of_Day
        gc_abort  added if 3d type not found

DryDep_ml
        Fixed bug in SAIadd found by Peter
        changed g_pot to 1.0 for wheat
Runchem
        Test output of OH, H2O2, (TMP)
UK_ml
        debug_i x> DEBUG_i
Wrtchem
        Allows ascii 3D output, for BCs

ZD_OZONE/My_Chem_ml
        NSPEC_SHL has 1 added for Hilde's IXSHL_PHNO3, PHNO3
        Affects all NSPEC_TOT numbers

ZD_OZONE/My_Reactions:_ml
        PHNO3 added.
        Slightly CPU-faster lines for VOLFAC stuff.

ZD_OZONE/My_Derived
        with extra 3D. Also renamed D2_H2O to D2_PM25_H2O

ZD_OZONE/My_Outputs
        Ascii_3D_WANTED added - generates 3D BCs if set
        some extra ouputs (TMP!)


xxxxxxxxxxxxxxxxxx Peter,     5/03/2004, rv1_9_27   xxxxxxxxxxxxxxxxxxxxxxxxxx

Version compatible with Intel and Lahey compiler on IBM cluster (blizzard)

NB: change in grun.pl: will not work with old grun.pl

Several modules: Removed double declarations,
	         Removed lines containing only a continuation line (&) (compiler bug)

Advection_ml: preadvx,preadvy:
		 small bug in array size declaration (preadvx only)
	         non-blocking send with buffered arrays
BoundaryConditions_ml:
		allocate also when sizex0
	        forall with mask replaced by loop

Dates_ml: small bug in add_2dates (newdate%month could be > 12 at some intermediate stage)

EmisGet: test of intext with "any" crashed: replaced by a loop

Emissions_ml: initialisations

MARS_ml: molnu,phimult defined as intent(in)

Radiation_ml: initialize coszenx0. ( (?)so that it can be used in
		"real, dimension(size(coszen,1),size(coszen,2)) :: expa, catten, Idrctn")

Sites_ml: added fmtx" " in write(xxx,fmtx" " )

Unimod.f90: read input parameters from file (INPUT.PARA) instead of from standard input
		The file INPUT.PARA is produced by grun.pl

grun.pl: produce INPUT.PARA to be read by Unimod.f90

Makefile: commented out debug option

xxxxxxxxxxxxxxxxxx Svetlana,     4/03/2004, rv1_9_26 xxxxxxxxxxxxxxxxxxxxxxxxxx
PM Water added to aerosols for OZONE.  Needs extension to ACID but to be done.....
commited by Dave, so changes need to be filled in later.  From Sevtlana:

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Hi, Dave and Peter

I put PM_water (parameter 662) to ACID/OZONE_rv.1.9.25
I've made one-day runs with ACID and OZONE. The values for water
looked reasonable

Everuthing  is on ~mifast/Unified__rv.1.9.25/Unimod.

New lines are marked with  "!water".

The modules affected are:
  phyche.f
  Runchem_ml      (calls Aero_water when daily output)
  Derived_ml
  Chem_ml

and  My_Aerosols_ml      (got new subroutine Aero_water)
         My_Derived_ml

I've also attached for Peter my earlier e-mail ( see below).
I reckon you, guys, can decide between yourself on how to procede.
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx


AFRIC_ADDED bit (non-serious bug) fixed in grun.pl



xxxxxxxxxxxxxxxxxx Dave,        20/02/2004, rv1_9_25 xxxxxxxxxxxxxxxxxxxxxxxxxx

GlobalBCs_ml     ... bug fixed: SpecBC needs to be set for all used species
                    (H2O2 wasn't) check for this added

PhysicalConstants_ml ...   RAD2DEG added

Radiation_ml.f90 --- Bug found! 1900 wrongly added to year. Gives small
                      shift in equation of time (e.g. 8 mins for Jul 1st), hence
                      declention angle and zenith angle.

                 --- solarnoon and daylength calculation added. Useful in ACID

xxxxxxxxxxxxxxxxxx Peter,        17/02/2004, rv1_9_24 xxxxxxxxxxxxxxxxxxxxxxxxxx
NetCDF_ml: Out_netCDF, optional input parameter "fileName_given", can be
	used to explicitely give the name of an output file.
	The use of fileName_given is probably slower than the implicit
	filename used by defining iotyp. Use it only if a "non-standard"
	output (i.e. not out_year.nc etc.) is needed

Met_ml: defined case(-11) to define sdot when it is given at level
	boundaries instead of midlevels. (ident(6)x-11 is pw defined)

xxxxxxxxxxxxxxxxxx Dave,        29/01/2004, rv1_9_23 xxxxxxxxxxxxxxxxxxxxxxxxxx

RunChem_ml ... debug_flag set false before DEBUG tests
grun.pl  - now chooses sonde file depending on SR or not - fewer stations
           used for SR runs.

xxxxxxxxxxxxxxxxxx Dave,        21/01/2004, rv1_9_22 xxxxxxxxxxxxxxxxxxxxxxxxxx

GlobalBCs_ml   - add close(IO_GLOBBC)  statements after read. Maybe it doesn't
                 matter, but it feels safer!

grun.pl - add OHDIR for acid if $SR
        - remove any .nc files prsent in WORKDIR
        - add new small domain for extended OSPAR
        - compresses day.nc and hour.nc files with bzip2
        - Hilde on u6, not u5 now.

xxxxxxxxxxxxxxxxxx Dave,        17/01/2004, rv1_9_21 xxxxxxxxxxxxxxxxxxxxxxxxxx

New Derived system added for ACID also. See comments on OZONE introduction
below.

Bug-fix: ddep needed initialisations for ecosystem stuff!


xxxxxxxxxxxxxxxxxx Dave,        13/01/2004, rv1_9_20 xxxxxxxxxxxxxxxxxxxxxxxxxx

Derived_ml -- added T for month in D2_MAXO3


xxxxxxxxxxxxxxxxxx Dave,         7/01/2004, rv1_9_19 xxxxxxxxxxxxxxxxxxxxxxxxxx

Changes to fix initialisation bug for AOT found by Peter:

Derived_ml
My_DryDep_ml

grun.pl domain extended beyond OSPAR to East, but only to jx7 in
south, because of BC problems (especially with rainfall from
jx1..7).

xxxxxxxxxxxxxxxxxx Dave,        26/12/2003, rv1_9_18 xxxxxxxxxxxxxxxxxxxxxxxxxx

DryDep_ml   - leaf_flux initialised to zero for each landuse
NetCDF_ml   - write used instead of print. (Reason: write output is buffered
              whereas print is not. Hence, for normal use, write is better.
              For trapping errors (e.g. before gc_abortx, print is better.


xxxxxxxxxxxxxxxxxx Dave,     21-22/12/2003, rv1_9_17 xxxxxxxxxxxxxxxxxxxxxxxxxx

New Derived system!! Changes in many routines. Main idea is to
set variables by name in My_Derived_ml, and let Derived_ml work
out what these are. "Master" lists of derived variables are kept
in def_xx variables which correspond to the used f_xx (i.e.
def_ddep contains the full list of possible f_ddep).

In other routines, most changes are to "use Derived" instead of
"use My_Derived".

BUG-FIX - c_hveg O3 calculation improved in DryDep_ml

BUG-FIX -  grun.pl improved for usage of mkp.pmadd

TSO4 removed from Derived list. This leaves compnr 620 for D2_SO4

FIX: landuse.dec2003 used instead of landuse.nov2003 - solves "line"
problem at ixx153


xxxxxxxxxxxxxxxxxx Dave,     19/12/2003, rv1_9_15 xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

DepVariables_ml   ... BEECH added

My_DryDep_ml  - to get FST for wheat, Beech (D2_FSTWH00, etc.)

My_Outputs_ml - NLEVELS_SONDE added - gives number of vertical levels for
                which sonde data are output.

                Also, Some text to comment in/out for MERLIN cities
                IMPORTANT - COMMENT OUT THE CORRECT BIT!
                (default should be non-merlin)

Sites_ml      - make uses of NLEVELS_SONDE.

Rsurface_ml: g_temp function changed.

UK_ml   - MM_gfac1.dat not lde_gfac1.

grun.pl - MM_gfac1.dat not lde_gfac1, and $MERLIN_CITIES option


xxxxxxxxxxxxxxxxxx Dave,     18/12/2003, rv1_9_14 xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

grun.pl changed - to add Afican emissions and PM emissions where needed


xxxxxxxxxxxxxxxxxx Peter     16/12/2003, rv1_9_13 xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

NB: Default is no binary (felt) output!

My_Outputs_ml: define Hourly_ASCIIx.false. and out_binaryx.false. in order
	       		to have only NetCDF output.
Output_hourly: ASCII Hourly files written only if Hourly_ASCIIxtrue.
	       netCDFName can be 120 characters
Output_binary: binary output only if out_binaryxtrue

NetCDF_ml:do not attepmt to write or create files if dimensions are <x0
	  do not write the _3D suffix in variable names
          use FREQ_HOURLY to find middle of hourly period

Unimod.f90 : Hourly netCDFfile not initiated here.

grun.pl : removed double definition of femis.dat
	  create a file RunLog.${runlabel1}.out

xxxxxxxxxxxxxxxxxx Dave     13/12/2003, rv1_9_12 xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug-fix. Submet_ml:
Svetlana found negative RH. Vapour pressure e now restricted to be
at least 0.1% of esat, and <x esat.

xxxxxxxxxxxxxxxxxx Hilde    12/12/2003, rv1_9_11 xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
NH4 and NO3 BCs added:
My_BoundConditions
GlobalBCs

N2O5 hydrolysis improved:
SOlver
My_Reactions.inc
ModelConstants
Setup_1d_ml
My_Chem

(Changes only in ZD_OZONE for the My_ files)

xxxxxxxxxxxxxxxxxxx Dave    6/12/2003, rv1_9_10 xxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Improved VOC definitions:
Derived_ml: Setup_VOC now uses carbon numbers to define VOC, excluding
            CO and CH4 by name.
ZD_OZONE/My_Chem_ml: Completed carbon numbers

xxxxxxxxxxxxxxxxxxx Peter  23/11/2003, rv1_9_9 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Increased max sizes for Netcdf filenames to 125

xxxxxxxxxxxxxxxxxxx Peter  23/11/2003, rv1_9_8 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Corrected Output_hourly.f90 such that runlabel1 is also written
for hourly output.

grun.pl : define runlabel also for ACID
NetCDF: corrected small bug for dates in monthly and yearly files.

xxxxxxxxxxxxxxxxxxx Dave  23/11/2003, rv1_9_7 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Correction! Use lde_biomass instead of tf2_biomass in grun.pl, UKsetup_ml
WHEAT used properly to set Wheat g_potx0.8 in DryDep_ml
grun.pl changes:
    $SR introduced - to help in setting iyr_trend and emisdir properly
    $emisyear removed, replaced by just $emisdir.

xxxxxxxxxxxxxxxxxxx Peter  20/11/2003, rv1_9_6 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

runlabel read in grun.pl used to "label" the output

Small Netcdf changes: use runlabel1 in file names.
	              CDF time is set to current time - half period
Unimod.f90: read runlabels
Emissions: inverted a do and a if loop
ModelConstants: define runlabel1 and runlabel2
grun.pl: define runlabel1 and runlabel

xxxxxxxxxxxxxxxxxxx Dave  18/11/2003, rv1_9_5 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Correction. WHEAT x 9, not 10!

xxxxxxxxxxxxxxxxxxx Dave  18/11/2003, rv1_9_4 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

*** New landuse.nov2003 used *****

Changes and cleanup in UK_ml.f90

And....

EQSAM_ml.f90 in Makefile, not EQSAM-v03d_ml.f90

Output to RunLog.out added (with IO_LOG) to provide output file with emissions.
(Maybe good for SR runs?)
   x> Changes in Emissions_ml, Unimod


WHEAT(x10) added to DepVariables.
Used in UK_ml  (to provide more obvious hard-coding   ;-)


xxxxxxxxxxxxxxxxxxx Dave  13/11/2003, rv1_9_3 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
EQSAM-v03d_ml.f90 moved to EQSAM_ml.f90. The former had't been "added"
to the CVS and anyway it is better to update old file names than
add new ones.

xxxxxxxxxxxxxxxxxxx Hilde 13/11/2003, rv1_9_2 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
EQSAM version v03d added to OZONE and ACID. Now used as default.

Files changed:
Setup_1d_ml.f90
Setup_1dfields_ml.f90
My_Aerosols_ml.f90 (both ACID and OZONE)
Makefile
EQSAM_v03d_ml.f90 added

xxxxxxxxxxxxxxxxxxx Joffen 13/11/2003, rv1_9_1 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Country numbers for REM, etc. corrected. NLAND extended to 69 with dummy values
for America, EU etc.

xxxxxxxxxxxxxxxxxxx Hilde, 12  Nov 2003, rv1_9 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
N2O5 changes added.

Setup_1d_ml,
Setup_1d_fields_ml
Solver
My_Reactions.inc

updated to include changes of N2O5 hydrolysis rate on fine particles. Now we use
the method of Riemer et al (2003) with a
'base' reaction probability of 0.02 (before 0.1) and then scaled with the realtive
mass of SO4 and NO3, SO4/(NO3+SO4). Only NO3 fine particles would led to a reaction
probability of 0.002.

xxxxxxxxxxxxxxxxxx Dave, 17  Oct 2003, rv1_8_5 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug-fix:
ZD_OZONE/My_Emis_ml: Order of QRC assigments should be same as in vocsplit files
(Of course, I could have changed the vocsplit files, but this was easier!)

xxxxxxxxxxxxxxxxxxx Peter, 17  Oct 2003, rv1_8_4 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
NetCDF_ml,Output_hourly:Allow choice of datatype

xxxxxxxxxxxxxxxxxxx Peter, 14  Oct 2003, rv1_8_3 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

My_Outputs_ml: Defined number of vertical levels in Asc2d%nk

Output_hourly: Allow hourly output in NetCDF format on a restricted
               domain and in a new file every month.

NetCDF_ml:Sizes of restricted domain can be given (horizontal and vertical).
          Create new files for example each month in Hourly output.
          EMEP coordinates and long lat given in output.

My_Derived_ml:defined IOU_HOURx5

GridValues_ml: Defined EMEP coordinate specifications (xp_EMEP etc.)
               ij2ij: interpolate (used in nesting)

xxxxxxxxxxxxxxxxxxx Dave, 25  Sep 2003, rv1_8_2 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ds rv1_8_2: Added possibility of multi-layer output. Specify

    NLEVELS_HOURLY in My_Outputs_ml, and in hr_out defs use either:

         ADVppbv to get surface concentrations (onyl relevant for
                 layer kx20 of course - gives meaningless  number f
                  or higher levels.
   Or,
         BCVppbv to get grid-centre concentrations (relevant for
         all layers.

Dave, 23/9/2003 - removed double definition of iland in Functions_ml

xxxxxxxxxxxxxxxxxxx Peter, 23 Sep 2003, 1.8.1 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Several changes for nesting purposes and netcdf.
	If you do only "usual" calculations: use EMEP grid
	and H50 meteo and you will not nest or use NetCDF output etc..
	then these changes do not affect the results.

Output_binary: bug for instantaneous output. Should not divide scale by nav
               if inst output

NetCDF_ml: write NetCDF output files
	   new definition of projection_params
	   Instantaneous concentration file

Many changes in Nest_ml

Met_ml: Test ident(17) for defining xp,yp
        (not used yet but available: calculate sigmadot from a mass
                                     conserving principle)

Read_Field: In case of non-EMEP grid transform fields to grid (bug corrected)

Solver: do fewer iterations when dt_advec<520 seconds


xxxxxxxxxxxxxxxxxxxDave, 23  Sep 2003  1_8       xxxxxxxxxxxxxxxxxxx

Rtagged as rv1.8. The "official" version.



xxxxxxxxxxxxxxxxxxxHilde , 3 Sep 2003  1_8beta3  xxxxxxxxxxxxxxxxxxx
Mace_head O3 for 2001 in GlobalBCs_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, Peter  1st Sep. 2003  rv1_8beta2 xxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Peter spotted bug in Met_ml. KZ_MINIMUM was not used! Fixed!


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave,  1st Sep. 2003  rv1_8beta xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
MODEL AS DOCUMENTED!! (Except need to change from tf2_ to new files)
in Preport 1/2003, Part 1

Changes made while documenting model:

DryDep_ml.f90
    -- Bug fix: SAIadd moved here from UK_ml
GlobalBCs_ml
    -- vmin fixed for HNO3, SO2
Met_ml
    -- zs1 renamed to zs_bnd
    -- new params and variables:
       real, parameter :: KZ_MINIMUM x 0.001   ! m2/s
       real, parameter :: KZ_MAXIMUM x 1.0e3 ! m2/s - as old kzmax
       real, parameter :: KZ_SBL_LIMIT x 0.1 ! m2/s - Defines stable BL height
       real :: h100 ! Top of lowest layer - replaces 100.0
PhysicalConstants_ml.f90
    -- KARMAN x 0.41  (more consistent with Garratt)
UK_ml
    -- Bug fix: SAIadd moved to DryDep
ZD_OZONE/My_Reactions.inc
  -- GLYOX photolysis products changed
ZD_OZONE/My_WetDep_ml.f90
ZD_ACID/My_WetDep_ml.f90
  -- WScav for pNO3 changed.

+ small tidy ups in DefPhotolysis

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 24th Aug.  rv1_7_4 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

ZD_OZONE: My_Reactions_ml
   --  Bug fix: changed products of glyoxal photolysis to be HO2 + 2 CO
       instead of HO2 + CO.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 19th Aug.  rv1_7_3 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Derived_ml:
--  Subroutines Consistency_checks and Consistency_count added to search
     for duplicate entries in derived fields.

ZD_OZONE/My_Derived_ml:
--   Renumbered ecosystem-entires to avoid collision of numbers (had 541 for
     both WDEP_SOX and DDEP_RDNWE
--   Added AOT30.

grun.pl
-- modified to point to latest emission files (after bug-fix from Heiko).
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 1st Aug.  rv1_7_2 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Met_ml.f90
-- replaced older Businger+Iversen/Nordeng  \Phi with same Garratt function
as used in deposition scheme.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 1st Aug.  rv1_7_1 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

BoundaryConditions_ml.f90
-- tidy up.
-- replaced old Rorvik stuff with use of DEBUG_i,j

GlobalBCs_ml.f90
-- Bug fixes:
   1) 2*PI instead of 4.0 * atan(1.0) for twopi_yr

   2) bc_rawdata(kx20) set to specified BCs, not kx1 !!
   (the BCs were upside down !)

-- Improved vertical scaling - now  uses physical height instead of sigma index
-- mace_head iyr_trend /x year option.


Functions_ml.f90

-- added function StandardAtmos_kPa_2_km to convert model's pressure
   level to standard height.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 1st Aug.  rv1_7rep2003 xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

    ****** THE REPORT VERSION ********


REPORT 1 2003, Part II (model performance) used rv1.6.12. Couldn't tag
as rv1.7 as this tag had been mistakenly applied before.  Use rv1_7rep2003
instead.

Only changes to - this file
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 18th June, rv1.6.12 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Derived_ml - added defintions of ecosystems: ECO_CONIF_FOREST, etc.
Changed My_DryDep in ZD_OZONE to make use of these. (Needs same
change in ZD_ACID still)

grun.pl - added check for ProgDir
Makefile: touch depend removed from clean
Output_hourly - Idirectt, Idiffuse added as options

My_Outputs_ml - SITE_XTRA_INDEX, SONDE_XTRA_INDEX introduced to simplify
      access to data from d_2d, d_3d  arrays.
Sites_ml - d2index, d3index introduced to simplify
      access to data from d_2d, d_3d  arrays. Removes need for explicit
      FSTCF0 cases etc.
ZD_ACID/
    My_Derived - added NOUTPUT_ABS_HEIGHTS - no effect but allows compilation
    My_DryDep  - added c_hveg to Add_ddep
    My_Outputs - as above
ZD_OZONE/
    My_Outputs     - as above
    My_Derived_ml  - new definations for ddep and ecosystem-specific stuff
    My_DryDep      - added use of ECO_ arrays

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Hilde, Dave, 11th June, rv1.6.11 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
SO2/NH3 dependence for NH3 dry dep included in Rsurface_ml.f90

Dates_ml changed to use FIRST_SDYEARx1980, LAST_SDYEARx2001
  Timefactors_ml modified to use these also.

iyr_ytrend introduced - allows "trend" year to get BCs outside the
   normal 1990-2000 range, e.g. for 1980 or 2050.
   Changes in:
        BoundaryConditions, ZD_XX/My_BoundaryCOnditions, Global_ml.f90,
        grun.pl, ModelConstants_ml, Unimod.f90

** Specify iyr_trend in grun.pl **

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 11th June, rv1.6.10 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Need to account for trends in runs from 1980..2000 :-(
Changed BoundaryConditions_ml to pass year to Set_mybc
Changed ZD_OZONE/My_Bound..   to allow trend_year to set CH4
  Trends introduced for 1990-2000 so far
  (CH4 increased anyway for 1990, from 1760 to 1780)
Fixed bug in grun.pl (2 emisdirs), My_Derived
Changed source of sites.rep03 to $DataDir in grun.pl

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 11th June, rv1.6.9  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
My_WetDep_ml, increased scavenging ratios
Sites_ml extended to include height of site, based upon Joffen's trotrep work
landuse.tfw used instead of landuse.tf2 (small change)
metdata, emissions, files updated in grun.pl
My_Outputs - some D_2D outputs removed while considering errors
My_Derived - only O3 and H2O2 as 3D

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 10th June, rv1.6.8  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Biogenics_ml.f90
Biogenic emissions now derived from landuse.tf2 and using
isoprene emissions factors of Simpson et al., 1999
grun.pl now uses DataDir/forests.tf2, not forest.pcnt

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 10th June, rv1.6.7  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Light factors added to isoprene emissions:
Radiation_ml, Setup_1d_ml, phyche.f

removed 300 ppb limit for O3 in GLobalBCs_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 10th June, rv1.6.6  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
DryDep_ml.f90
IXADV_O3 replaced by FLUX_ADV
Neutral stability assumed when we have land in a grid,  but Hirlam thinks it
is a sea-square.

Met_ml.f90
Pielke's Kz instead of Iversen+Nordeng variety

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 5th June, rv1.6.5  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Changed to SEI_based landuse, and added new-style (Fst) flux calculations.
Changes in DryDep, UK_ml, outouts, etc.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 4th June, rv1.6.4  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
grun.pl changed to use ds-fix for UK emissions
New GLobalBCs_ml, using Mace Head BCs correction to Logan
(Needs current_date%year to be passed in Unimod.f90 and BoundaryConditions_ml also).
Makefile reset to not use -g as default

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 4th June  2003, rv1.6.3t xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Makefile changed to default without -g option.
Small change to grun.pl to use trends_2003 emissions
(Not model changes, but committed to keep coming comparisons simpler)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 29-29 May 2003, rv1.6.3  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Real Output_hourly changes (as should have been done for rv1.6.2)

Idrctt, Idfuse added to Setup_1Dfields_ml - allows use by other
routines.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 27-28 May 2003, rv1.6.2  xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Output_hourly, and My_Outputs_ml.f90 modified to add headers to outputs,
including number, names, etc. - should make it easier to write and use
processing programs.

Aqueous_ml .. small printout bug fixed

Met_ml - added field surface_precip x rainfall direc from HIRLAM in mm/hr

DryDep_ml, Rsurface_ml, uses surface_precip and logical is_wet instead
of pr_acc

xxxxxxxxxxxxxxxxxxx Hilde 27th of May rv1.6.1 xxxxxxxxxxxxxxxxxxxxxxxxxx
Aqueous_ml changed with consistent, tabulated lwc
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Svetlana, 8th May  2003, rv1.6  xxxxxxxxxxxxxxxxxxxxxxxxxx

grun.pl is updated to include PMco emissions.
PM emissions are read from ~svetlana/Unify/MyData/emission/em2000 (instead of emis99)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Svetlana, 7th May  2003, rv1.6  xxxxxxxxxxxxxxxxxxxxxxxxxx


Primary PM25 and PMco are included in OZONE version. Files modified are:
My_Chem_ml.f90,  My_Emis_ml.f90,  My_DryDep_ml.f90,
My_WetDep_ml.f90, My_MassBudget_ml.f90, My_Derived_ml.f90, My_Reactions

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Hilde, 7th MAy  2003, rv1.6  xxxxxxxxxxxxxxxxxxxxxxxxxxxx
My_Reaction.inc : Added H2O2 loss due to SO2 ox
My_Derived_ml.f90: Fixed D3_names (before all was D3_NO2)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Peter, 14th April  2003, rv1.5.3  xxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave,  24th April  2003, rv1.5.3  xxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

corrected name of PPM25 and PPMco in ZD_ACID/My_Derived (affects only Net_CDF output )
Used 600 instead of 619 for aNH4 in ZD_ACID & ZD_OZONE /My_Derived

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Peter, 2nd April  2003, rv1.5.2  xxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Increased maxsize of Deriv%name to 15 characters in My_Derived and redefined some names

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 1st April  2003, rv1.5.1  xxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug fix for So2->SO4 rates in ZD_OZONE/My_Reactions.inc


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxx Dave, 28th March 2003, rv1.5  xxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Stable (?) version fir TFMM runs.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde/Joffen/Dave  28th March 2003, rv1.4.29   xxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Units changed to tot. mass in My_Outputs_ml.f90
ADVppbv, ADVugm3, SHLmcm3 now used for Hourly outputs
Output heights put to 3m (or top of tree, er, too difficult to explain, so say 3m )
 - spo use Vg_3m in DryDep and Ra_3m in SubMet_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  27th March 2003, rv1.4.29   xxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ZD_ACID: My_Reactions re-corrected for old errors which seemed to come back!
         : HNO3 mssing from pNO3 production, aqrck(ICL3 missing from SO4
grun.pl - now calls "gmake depend" and "gmake" instead of just "make".
	This creates the .depend file

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  27th March 2003, rv1.4.28   xxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
DEBUG_AERO set false in DryDep_ml
OZONE:NDERIV_2D corrected for bug spotted by Peter (tNO3 line)
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde 26th March 2003, rv1.4.27   xxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ACID:My_DryDep_ml.f90:
N_OXN and OXN array and corrected
OZONE:NDERIV_2D corrected
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde 26th March 2003, rv1.4.26   xxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
My_Derived_ml:
Parameter number for aNH4 changed as it overwrote NO2
Parameter numbers for NH3 set equal in both ACID and OZONE
tNO3 included in OZONE
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Svetlana/Dave 25th March 2003, rv1.4.25   xxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Aero_Rb_ml added to enable particle deposition rates to be used.
Fine and coarse rates for So4, aNO3, pNO3, etc.
+ pw bug fix (not changing results?) for no2fac usage in DryDep_ml.
+ reset INORGANIC_AEROSLS true, RUN_EQSAM false in My_Aerosols.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde/Dave 24th 2003, rv1.4.24  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

ZD_ACID/My_WetDep changed to remove wet dep of PM
ZD_OZONE/My_Reactions changed to include aqrck for OH, HO2
.depend and Makefile  introduced - new system suggested by Heiko.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  24th 2003, rv1.4.23  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug fixes found by Hilde in ZD_ACID/My_WetDep_ml, My_Reactions, My_DryDep.
Bug fix in DryDep_ml (max in so2nh3ratio), Dave
Logicals vegetation, urban, added to DepVariables_ml, UK_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  21th 2003, rv1.4.22  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SO2/NH3 ratio  REALLY working!  As I (ds) had put so2nh3ratio as intent(in)
the compiler didn't accept it being multiplied by 0.6. Now so2nh3 is used
for the product.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde, Dave  21th 2003, rv1.4.21  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SO2/NH3 ratio  REALLY introduced! rv1.4.20 had RHlim function only.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde, Dave  21th 2003, rv1.4.20  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

SO2/NH3 ratio used in DryDep and Rsurface. Also Rhlim function.
(with RH<1 !)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave,  March 21th 2003, rv1.4.19  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Fixed My_Reactions for "old" SO2, new pNO3
Extensive stomatal flux  changes in DryDep
Many outputs in My_Derived, My_Outputs, etc.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Peter, March 21th 2003, rv1.4.18  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Included variable timestep in Solver.f90
"Decoupled" variables in ZD_OZONE/My_Reactions.inc:
(PAN,CH3COO2) ,(MPAN,MACRO2), (NO3,N2O5)
ModelConstants: declared dt_advec as a parameter
Dchem is now rate of changes during last dt_advec, instead of absolute change during dt.
Net_CDF: removed a "+" in units attributes

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave, March 21th 2003, rv1.4.17  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Met_ml bug fixed.
SO2-> SO4 treatment unified in OZONE and ACID
(SO2+CH3O2 reaction removed from OZONE as part of this, Fe-reaction added to both).
pNO3 introduced - coarse mode nitrate
Forgot to say earlier: New NO2 deposition method, FNO2 x Vg. max(NO2-4,0)
assumed compensation point of 4 ppb NO2.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave, Svetlana, March 10th 2003, rv1.4.16  xxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Primary PM added into ACID version. This slows down ACID a bit, but removes
the need for a separate PM directory. Also, S-R matrices can be done
for PM and ACID substances at the same time - since they are independant.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Peter ,  Feb. 27th 2003, rv1.4.15  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  ,  Feb. 27th 2003,           xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
pw: Improved netCDF output.
ds: New style of BC specification, with ACID and OZONE in grun.pl
ds: O3fix removed from My_Chem_ml
ds: My_Chem_ml not needed for Global... in Makefile
(Hilde has changed names of files in BC_data also, to make consistent system).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Peter ,  Feb.  7th 2003, rv1.4.14  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ZD_ACID/My_Derived_ml: I forgot to define name and unit for D2_ACCSU. (Thanks Dave!)
Restarted daily netCDF output. Corrected small imperfection.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Peter ,  Feb.  7th 2003, rv1.4.13  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Removed daily netCDF output: too slow at present

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Peter ,  Feb.  7th 2003, rv1.4.12  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Output_binary: daily, monthly and yearly netCDF output
NetCDF_ml: more attributes
My_Derived: additional "Deriv" attributes
Met_ml: smoosp in tiphys, parallel smoosp

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxx
xxxxxxxxxxx Dave ,  Feb.  7th 2003, rv1.4.11  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Corrected Makefile - otherwise as rv1.4.10

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave ,  Feb.  6th 2003, rv1.4.10  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
STO_FLUX, unit_flux, lai_flux  lines added into DryDep, in preperation for
ecosystem modelling. Rsur(NO2) doubled - temporary soln until a better
way of allowing for 2-way NO2 fluxes is found (compensation points one
day, perhaps).

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde,  Jan. 31st 2003, rv1.4.9  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
Aqueous chemistry for SO2->SO4 ox. re-introduced. All BCs read from file are now 50*50km2.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave,  Jan. 27nd 2003, rv1.4.8  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

CEH-derived Rns used  in Rsurface_ml, and wetarea set in DryDep.
RH-based correction to Gns added

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave,  Jan. 24nd 2003, rv1.4.7  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Crude adjustment of BCs (+10 ppb ozone) added in Global_BCs, so that clean
air masses have same ozone as Mace Head.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave,  Jan. 22nd 2003, rv1.4.6  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

BUG-fix -- SAIadd was defined locally in UK_ml, so the SIAadd
from DepVariables never got set.  Fixed.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave,  Jan. 22nd 2003, rv1.4.5  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Added r_water from CEH/ Hilde's code for NH3 to Rsurface_ml.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave,  Jan. 21st 2003, rv1.4.4  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Changed Wesely_ml : increased H* for NH3

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave,  Jan. 21st 2003, rv1.4.3  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

New MonthlyFac and DailyFac introduced - pollutant specific.
(Changes in Timefactors_ml, grun.pl)

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Peter , January 2003, rv1.4.2  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

1)DryDep_ml:
	use amk
	confac2x... /amk(KMAX_MID)
        ds-Bug created whewn xn_2d used instead of xn_adv (when put inside i,j loop ?)

2)NetCDF_ml: new module
3)Unimod.f90: call to netCDF_ml
4)Output_binary_ml: call to NetCDF_ml

3)GridValues_ml: added routine coordzero (used by NetCDF_ml)

4)ReadCDF_ml: not used by the model, but contains routines that can read the
	NetCDF output.

5)Makefile:
	LIBS x -lmpi -lnetcdf
	INCL x -I/home/u4/mifahik/netcdf/include
	LLIB x -L/home/u4/mifahik/netcdf/lib64


6)My_Derived: included /max(1E-80, (xn_adv(...))) in order to avoid division by zero for 0 concentrations.


7)./ZD_ACID/My_Derived_ml:      (was done in ZD_OZONE, but not in ZD_ACID)
	 wdep( :,:,:,:) x 0.0
      ddep( :,:,:,:) x 0.0
      d_2d( :,:,:,:) x 0.0
      d_3d( :,:,:,:,:) x 0.0


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave, 14 Jan 2003  rv1.4.1  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Made Ox. rate SO2->SO4 same (argx4) in OZONE as in ACID

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde, Joffen, Peter, sub. Dave, 14 Jan 2003  rv1.4    xxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Corrected Logan's data. grun.pl refers to new location.
Timefactors_ml bug corrected  (Hilde had done this already, so rv1.3.1
                               was okay)


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde   2nd Jan 2003  rv1.3.1   xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

From forum:
Reply #3 Posted at Thu Jan 2 13:41:23 2003    Revision 1.3.1
Drydep inside loop in Runchem.
Kz_min lifted one layer.
Budget error discovered by jej fixed.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Hilde   2nd Jan 2003  rv1.3     xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

From forum:
  Reply #2 Posted at Thu Jan 2 12:47:55 2003
Last Modified at Thu Jan 2 13:17:58 2003 by David Simpson Revision rv1.3
New ammoium and nitrate indexes, eq models rewritten/added.

Indexes have been changed so that AMSU and AMNI do not exist anymore. Intead we have aNO3 (aerosol nitrae) and aNH4(aerosol ammonium). The Ammonium routine is rewritten to handle the new indexes. MARS and EQSAM can be run instead of Ammoniun by setting true/false in My_Aerosols_ml.
EQSAM is set as 'default'.



xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  , Dec   2   2002, rv1.2.1  xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug found by Svetlana fixed, Setup_1d_ml now uses KEMISTOP, noit
KMAX_MID-3. ModelConstants_ml also fixed.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  , Nov   26  2002, rv1.2  xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Fixed (non-influencing?) bugs found by Hilde, Peter, in ZD_ACID version,
My_Chem_ml and  My_MassBalance_ml.


xxxxxxxxxxx Dave  , Nov   18  2002, xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Bug-fixes - pr_acc instead of pr in DryDep and Rsurface
            wasinword in Io_ml

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  , Oct.  24  2002, emep1.2  xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Wrtchem changed to correct problems with daily binary output.
Small other changes.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  , Oct.  22  2002, emep1.2helcomU  xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Some small bug-changes compared to 1.2helcomF


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  , Sept. 27  2002, emep1.2helcomF  xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Version used for Helcom runs.
Added ij Hilde's stack table, but used NEMISLAYERS in EmisDef instead of
KEMISTOP in ModelConstants, to keep emission definitions in Emis files.
Added crude effect of wetness on RextS in Rsurface_ml.


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  , Sept. 26  2002, emep1.2helcom2  xxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

Peter corrected Output_binary
Dave  corrected nadv  for ecosystem-specific dep.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Dave  , Sept.  2002, emep1.2beta2 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

0) Started this Log.changes file. Please add your changes here as appropriate.
  Of course, now the code is under CVS control, differences between releases
  can be easily obtained, but a simple Log file is also helpful.

1) Merged Peter's, Hilde's and my changes in emep1.2beta2, plus

  EmisDef_ml- ANTROP_SECTORS added
  EmisGet_ml- ANTROP_SECTORS added

2) Fixed bugs listed on forum
  Derived_ml - fixed timefrac

3) Re-coded DryDep model to work for ACID

4) ACID version update and tested

5) Merged inpar, in_isnowc and (commented out SetZ0) into MetModel_LandUSe
   in Met_ml. The idea is to keep all HIRLAM/mm5 met data in the same place

6) Moved V_RAIn to ModelCOnstants. Put DEBUG_i, DEBUG_j into ModelConstants -
   used to specifiy which grid square print-outs are wanted for.

7) Setup_1d_ml.f90 - max(1,izen) added
                - In trotrep version xn_shl was reset
  to xn_2d. In emep1.2beta this wasn't done. The 2beta
  version is therefore faster, but this reset allows
  stats such as max_oh to be calculated. Therefore trotrep
  version adopted.

8) Ecosystem-specific deposition added for OXN over seas and forests, for
   Jurek's HELCOM request.

9) INTERACTIVE option added to grun.pl - useful when preparing code for
    running with totalview.

xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxx Peter , summer 2002  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
1)Added a test in ReadField_ml, to see if we use the
 EMEP map. If not the field is transformed into the current map.

2)Included routines ij2lb, lb2ij and ij2ij in GridValues_ml.

3)Moved routine inpar and array iclass from GridValues to DryDep

4)Moved  "call inpar" from GridValues to Unimod.f90

5)inpar: explicit loop instead of (:)

6)Commented out routine and call SetZ0 (never used)

7)Changed formula for precipitations (pr) when not found (MM5 case),
  defined V_RAIN in PhysicalConstants_ml

8)Changed 2 last decimals of PI in PhysicalConstants_ml

9)Dates_ml: add_dates_s : Allow to add 3600 seconds (before 3599 was
  largest allowed).

10)Print max Courant number in Advection_ml

11)(Changed by Hilde) Loop for skh in Met_ml kx2,KMAX (instead of kx1,KMAX), and z_mid(i,j,k-1)

12)Tabulations : use T0 from PhysicalConstants

13)Rsurface.f90 :(Changed by Dave) /D_i instead of /diffc

14)grun.pl Included an if test in loop for meteo files

15)included a DEBUG compiler option in Makefile

16)commented out a declaration (amax,amin)

17)Commented out call to smoosp. The routine is not well parallelized.

18)replaced izen x int ( zen(i,j) + 0.5 ) by  izen x max(1,int ( zen(i,j) + 0.5 )) in Setup_1d_ml

19)Jej: My_derived_ml commented out O3x ... !/ (roa ...)

20)Corrected a small bug in advvk in Advection_ml

21)Removed an amax1(.,.) in tiphys (Met_ml)

22)Include  -TARG:exc_minxOZV as compiler option. This will stop the execution if
   wrong operations are done (such as 0/0 , NaN ).

