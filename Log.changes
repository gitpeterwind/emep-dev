=========================== rv3_3 Dave, 11  Oct. 2009 ================

New *EcoSystem_ml* introduced to include definitions for EcoDep
  new netcdf outputs of e.g. Area_Grid_km2, Area_Conif_Frac

-> CHanges in Derived_ml, My_Derived, Unimod.f90, My_DryDep, DryDep
    (maybe others...)

RO2POOL introduced in Solver to cope with CRI chemistry


 !!!!****** ZD_ACID removed ****!!!! 
 Functionality must be created through GenChem system now.


=========================== rv3_3beta5, Garry/Dave,  9  Oct. 2009======

Changes from Garry to enable g95 compilation - mainly needing lengths
of strings in initialisations to be the same.

My_DryDep_ml
My_Outputs_ml
My_Derived_ml

I also made some minor tidy-ups in My_Derived_ml

================================ rv3_3beta4, Dave,  9  Oct. 2009======

Changes to ease compilation with gfortran, and execution on PC.

Derived_ml.f90 :  f_3d -associated code changed to make it easier to skip 
                  this. Needed for PC runs (at least on my PC):

                  Some unused arguments removed also from functions


Also some unused variables (spotted by pedantic gfortran option) removed
   Timing_ml, Unimod.f90, Ammonium_ml, GridValues_ml, NetCDF_ml, PhyChem_ml,
   Sites_ml


Note that in Solver_ml, EXTRA_ITER is set to 3, not 1. This is for safety while
testing different chemical schemes, and can hopefully be reduced back to 1 soon.

================================ rv3_3beta3, Dave,  7  Oct. 2009======

Derived_ml: AOTs restored, to some extent anyway.
    AOTs and fluxes now treated in same VEGO3 methodology

My_Derived_ml - lots of changes to get AOT, VEGO3 etc.

My_DryDep_ml  - lots of changes to get AOT, VEGO3 etc.

ChemFunctions_ml: kmt3 added 

EmisGet - small extra debug output

RunChem_ml - removed QRCISOP from printout line. Not is all CM versions now.

+fixed some forgotten commits from last-version (My_files weren't updated
in ZD_OZONE, and OwnDataTypes_ml)

Many changes now marked with !Oct09 or !DSGC. The comments mess up the code
and will be cleaned out in a revision ort two.

================================ rv3_3beta2, Dave,  5  Oct. 2009======

GenChem enabled EMEP chemistries, almost done? 

New file-labelling system and directories:

ZCM_EmChem03 - contains chemical-mechanism (CM) files for EMEP 2003
chemistry vocsplit files are also chemistry dependent, so for now we
keep them with the code.

ZCM_EmChem03 directory:
----------------------
CM_BoundaryConditions.inc  CM_Reactions1.inc  vocsplit.defaults.EmChem03
CM_ChemRates_ml.f90        CM_Reactions2.inc  vocsplit.special.EmChem03
CM_ChemSpecs_ml.f90        CM_VOC_MW.inc
CM_DryDep.inc              CM_VOC_QRC.inc


The above replaces many of the  My_ files. The latter are now mainly used
to specify desired outputs, and the aerosol schemes. Thus, ZCM_EmChem03
gives the chemistry, ZD_OZONE gives whatever else is needed, and
ZD_ACID should be deleted in the near future. (ZD_ACID should be
replaced by a ZCM_ directory for acid chemistry. Somebody would need
to check over how O3 and stuff are handled though).

Thus, from Unimod.rv3_3,do:
   cp ZCM_EmChem03/CM* 
   cp ZD_OZONE/My* .

GenXXXX -> ChemXXXX

In the code, "GenXXX" modules are replaced with ChemXXX modules, thus
GenSpec_adv_tot now becomes ChemSpec_adv_tot. Seemed more logical.

Note, CM_Reactions1 replaces My_FastReactions, CM_Reactions2 replaces
My_SlowReactions since the distinction was really between chemicals that
needed to be in the iteration scheme or not (as they reacted further),
not just speed.


Chemical schemes can be swapped with the mk.GenChem script, which will
be added in CVS somewhere very soon. So far have one "working" sheme (EmChem03),
and one almost-working, EmChem09. Will soon add carbon-bond, CRI, and others

More  changes to make it easier to swap chemistry (coming soon...) :

  My_Derived_ml - uses groups from ChemGroups_ml, removes hard-coded OXN etc.

  My_DryDep_ml - now includes "CM_DryDep.inc" from GenChem's ZCM_EmChem03 directory
  
  CM_ .... files now from GenChem's ZCM_EmChem03 directory

Plus:

  COLUMN-data added to Derived and My_Derived_ml, simplified calculation

  **New** OwnDataTypes_ml created to store user-defined types. Mainly
  intended to make My_* files shorter. Used so for dep_type, Deriv, SOA-VBST

  Causes modifications (and small tidy-ups) to:
      Derived_ml, My_Derived_ml, NetCDF_ml, Nest_ml

Status and ToDo
-----------------
I think that the GenChem-associated changes are basically done (though of
course I am sure changes will be needed!). 

The code still needs work to recover some outputs, notably AOT40, which were
omitted during the changes to Derived and My_Derived (rv3_2_13 onwards).
All gas-phase and deposition outputs look fine, afaics.

================================ rv3_3beta, Dave,  1  Oct. 2009======

 GenChem enabled EMEP chemistries
 Caveat: New code seems to work fine, but the numerics  of all rv3_2.. are
 slightly less optimised compared to rv3_1 versions (I removed Peter's
 hard-coded linking of equations in My_FastReactions). The linking
 could be re-introduced for a SR version, but for normal use I recommend
 testing with different chemistry time-steps. (So far my tests show a
 very stable system though)

Introduced ** new directory :: :

 ZD_EmChem03 -  to keep EMEP 2003 chemistry outputs from GenChem.

More  changes to make it easier to swap chemistry (coming soon...) :

  My_BoundaryConditions_ml.f90 **removed**. Some code moved to BoundaryConditions_ml

  My_BoundaryConditions.inc **added**.  Will vary with chemical scheme.

  My_MassBudget **removed**. Equivalent (simpler) lines added to My_Emis_ml
     and Setup_1d_ml

  My_ChemSpecs - module GenGroups_ml **added**, provides:

     OXNGROUP = (/ NO,NO2,PAN,MPAN,NO3,N2O5,HNO3,PNO3,ANO3 /)

     DDEP_OXNGROUP = (/ HNO3,NO2,PAN,MPAN,PNO3 /)

   ... and avoids having to hard-code these in rest of code. Please use!

  My_Outputs_ml  "&" added to please gfortran

  Sites_ml - modifed to make use of OXNGROUP

================================ rv3_2_31, Dave,  1  Oct. 2009======

Some changes to make it easier to swap chemistry (coming soon...) :

  Derived_ml - hard-coding for CH3CHO, MAX3DADV of CH3COO2, PHNO3 removed

  EmisGet_ml - extra safety printouts for  VOC speciation

  OutputChem_ml - uses MasterProc and more debug output with My_DEBUG


Plus....   Some changes to solve small problems spotted by gfortran:

  BoundaryConditions_ml.f90 - debug_proc removed from ModelConstants use

  CellMet_ml.f90: -1* instead of -Grid%Hd

  GridValues_ml.f90: changes of real, integer defintions

  NetCDF_ml.f90: small re-code

  ReadField_ml.f90: Use .eqv., not == in any (cell_set .eqv. .false. )

  Solver.f90: double-def of rct removed

  My_ChemRates_ml.f90: rcmisc line split. Not sure why gfortgran complained, except
    it doesn't seem to like long lines


================================ rv3_2_30, Dave,    1  Oct. 2009======

Bug-fix!
My_Derived_ml index problem fixed. This bug didn't affect the model runs,
but caused the wrong output in DDEP_SOX etc. Introduced in
rv3_2_11. New code seems to work fine, but more checks would be useful

================================ rv3_2_29, Peter,   17 Sep. 2009======

removed -mieee-fp from Makefile and Makefile_stallo
This options made the floating point operations ieee compliant, but are now slowing down the computation 
quite a lot, and even more (30% diff) with the next intel compiler version (11.1, to come on stallo in October)
If one wish to compare results between diferent machines (stallo and njord for example it may be useful 
to put the option back)


================================ rv3_2_28, Dave,   16 Sep. 2009======

My_Reactions omitted - code moved into Solver_ml
My_SlowReactions.inc added

================================ rv3_2_27, Peter,  10 Sep. 2009======

Changes to comply with the rotated spherical projections and new definition/units for time:
now in days since year 1900. The seconds used earlier do not run after 2037 or so and we 
need to run later for climate studies.
NBNB: if you have postprocesing scripts which make use of the date read from the netcdf 
files, make sure to update these!

NetCDF_ml and Met_ml are changed

Dave changed Functions_ml also, to use sin instead of sind (for gfortran
compliance), and removed 360 term.


================================ rv3_2_26, Dave,  4 Sep. 2009======

INTERIM version - the concentrations look fine, but for some
reason WDEP, DDEP is different to older (rv3_1) results. Needs
investigating!
(Differences *not* due to changes here, likely those from
some revisions ago)

Main change: My_Chem files all come  *directly* from GenChem output
Some small change in reactions introduced here, but doesn't affect
air concentrations very much.

My_ChemSpecs_ml
My_FastReactions

*** note, since these files are from GenChem, we have lost some of
the optimisations which Peter introduced. This can one day be
coded into GenChem, or done by hand again. 
   On the oter hand, GenChem got rid of some of the bugs introduced
by hand-coding ;-)

Solver_ml:  use NUM_INITCHEM, DT_INITCHEM etc., to try to make
  timestep values easier to change. Values printed out to IO_LOG


================================ rv3_2_25, Dave, 11 July 2009======

Some changes to make the code "safer" I hope, after being caught out by
unexpected input files when changing domain.

Input files expected:  Now expect rough.dat and Inputs.2BVOC
====================

Met_ml now requires rough.dat, not rough.170. The new "fill_needed" 
parameter is used to ensure that this data fills the grid. Unlike
the zero sized rough.170 in the EECCA data-directory ;-)

Biogenics_ml -  now looks for Inputs.2BVOC, not Inputs.BVOC. the
reason is tat the terpene emission factors were all -999.999 in
the EECCA directory. No problem for standard runs, but a major
problem for SOA runs.
Now checks that terpene emission factor is positive, at least if NBVOC > 1


Io_Progs_ml - extra debug stuff

ModelConstants_ml - extra lines for EECCA domains, and more debug options

ReadField_ml  - optional "fill_needed" parameter added to
readfield_r and readfield_i routines.  CheckStop will stop the run if
fill_needed is true, if the domain isn't filled.

New Inputs.2BVOC file created for EECCA

run.pl - now has $GRID which can be EMEP, GLOBAL, EECCA etc.

MassBudget_ml: small format change

================================ rv3_2_23, Alvaro, Haldis 6 July 2009======


Changes to My_Outputs_ml.f90 and Output_hourly.f90 to solve bug with units
(ugSm3 etc.). General ADVugXX used for all mass-based outputs in Outputs_ml,
with units to be chosen in My_Outputs_ml.

================================ rv3_2_22, Peter 30th June 2009======

GridValues_ml, NetCDF_ml, et_ml:
Defined "rotated_latitude_longitude" projection following CF-1.0 convention.

================================ rv3_2_21, Dave, 24-26th ======

found_ind2d, found_ind3d added to Derived_ml to esnure that we 
don't try to define the same variable twice.

Comma removed in GLobal_ml, needed to compile

================================ rv3_2_20, Peter, 24th June 2009======

GridValues_ml:
Added the general case in lb2ij, which gives (i,j) values (as real numbers) given
longitude and latitude for any grid projection.
Used for sites/sondes given as lonlat.

Function_ml, Nest_ml:
Moved great_circle_distance into Functions_ml.


Note: The new default compiler on stallo (ifort 11.0), gives a segmentation fault 
on line 711 in NetCDF_ml, when compiled with debug options. After closer look, this is most probably due to
a bug in the compiler...


================================ rv3_2_19, Peter, 2nd June 2009======

Small change for compatibility with rotated spherical projection (H20)

Met_ml:
-180<gl_glob<180

NetCDF:
Compatibility with GLOBAL_BIC (see rv3_2_4)

================================ rv3_2_18, Agnes, 1st June 2009======

GlobalBCs_ml:

update of Mace-Head ozone values, now with average from 1998-2007. Also
recalculated the 2006 and 2007 Mace Head values with the new 10-year
average.

Commented out the +3 (4.5) ppb scaling for future years (2010 and later),
so the 1998-2007 10-year average will be used for these years.

================================ rv3_2_17, Peter, 28th May 2009======

Solver.f90:
nchem is now set to 10 when dt_advec=600

Advection_ml:
Larger dt_advec for fine resolution

Functions_ml, NetCDF_ml:
Move "inside_1234" into Functions_ml

My_Reactions.inc:
We go back to the "toiter(k)" loop; with the new compiler this is the fastest (though only a few %)
and it is neater too.


================================ rv3_2_16, Agnes, 20th May 2009======

MaceHead correction for 2007 added.

================================ rv3_2_15, Dave,  20th May 2009======

Functions_ml : troe removed, and moved (as troeInlog) to:

New module: ChemFunctions_ml - with troe, RiemerN2O5, kaero functions

Added modules: My_ChemSpecs_ml My_ChemRates_ml

  - split from old My_Chem_ml, to make use of GenChem easier
  - RiemerN2O5, kaero now done in ChemFunctions
  - tabulation of rate constants switched off for now. 
    ( Surprisingly, ** No CPU cost **. Time for chemistry almost
      identical )

Removed modules: My_Chem_ml,  OrganicAerosol_ml

    (the latter not needed, as we have SOA_ml)

Setup_1d_ml, Setup_1dfields_ml
   - removed Rimer stuff, some re-organisation because of My_Chem changes

Solver_ml - has EXTRA_ITER to allow 
            ONLY_NIGHT code removed

Unimod.f90 - no need for Init_mychem



================================ rv3_2_14, Dave,  16th May 2009======

Changes to make switch to global model easier, plus some tidy-ups

IS_GLOBAL added to ModelConstants_ml

Emissions_ml : sets MonthlyEmis = IS_GLOBAL
  (keeps all Global - EMEP changes in ModelConstants)
   Tidy-up

run.pl: My $GLOBAL added as switch
   sitesLL.dat, sondesLL.dat added as defaults in $DataDir - suggest
    only use long/lat files in future.

My_Outputs_ml
   removed D2_AFST... etc., and dependency on Derived

================================ rv3_2_13, Dave,  15th May 2009======

Working changes::: AOT outputs have been commented out. Will re-appear
soon!

LandDefs_ml
New functions for Check_LandCoverPresent added.

My_Derived_ml
  AFST now dealt with using "OutXX" system, as for VG, RG

My_Derived_ml
  AFST now dealt with using "OutXX" system, as for VG, RG
  Gets rid of iam_wheat, D2_AFST... etc. type indices
  check_vals now not needed.:wq

Derived_ml
  -- more changes to cope with AFST and Out variables

================================ rv3_2_12b, Peter  14th May 2009======

ReadField, Landuse, Met_ml:
Use landuse to define nwp_sea when rough file is missing


================================ rv3_2_12, Peter  14th May 2009======



ReadField_ml:
Optional parameter when the field is not needed

Met_ml:
rough is set to 0 if not needed
snow is not required when read from metdata

Sites:
sites.dat and sondes.dat are not required.
(the code was hanging when this happened)

Rsurface_ml: if ice is missing, but sdepth is present, take sdepth instead of snow.(IS THIS OK?)
    if ( .not. foundsdepth)then
       fsnow=G%snow !snow from climatology files, 1 or 0
    endif

================================ rv3_2_11, Dave,  14th May 2009======

Changes to allow for possibility of new landuse codes, or of
old landuse codes (e.g. "CF" not being recognied with new
systems)

Unimod.f90 - Init_Derived now moved after Init_landuse, so that
  the My_derived code knows about the available Land_codes

My_Derived_ml - check added for MET_LCS to see if the LC actually
  exists. If not, nOutMET will be zero. Note that for other
  outputs the code will crash if a non-existant land-code is given.
  The user can keep it working by only havinbg "Grid" in the arrays,
  e.g. for RG_LCS = (/ "Grid" /)

  Also, some slight tidy-up to reduce clutter

SmallUtils:  find_index again returns NOT_FOUND (-999) instead of 1
    also, trim() added to txt strings

================================ rv3_2_10, Peter  13th May 2009======

First version of a grid flexible Landuse input

GridValues and Met_ml: defined gb_stagg and gl_stagg (staggered lon and lat)

NetCDF:
 Read_Local_Inter_CDF, to read and interpoalte landuse from raw data.
Under construction!

Landuse_ml: call to Read_Local_Inter_CDF when Input.Landuse is not found

Replaced all NLANDUSE with NLANDUSEMAX: used for array declaration and is the max allowed,
NLanduse_DEF is the actual number of landuse defined.
DO3SE_ml,DryDep,LandDef,StoFlux_ml,NetCDF,LocalVariables_ml

LandDefs_ml: NLanduse_DEF number of landuse defined
NLANDUSE_EMEP=19. To check data from Input.Landuse.
StoFlux_ml: use NLanduse_DEF instead of NLANDUSE.
DryDep_ml: InitDO3SE called only if not already read by Read_Local_Inter_CDF

ModelConstants:NLANDUSE    = 23 ! MAXIMUM Number of land use types

SmallUtils_ml: NB: provisory!!
!    Index =  NOT_FOUND
    Index =  1

run.pl: link to landuseGLC2000_INT1.nc

NB: The new landuses system is still under developement.

================================ rv3_2_9, Dave  8th May 2009======

Derived_ml, My_Derived_ml:

SURF_UG_C, SURF_UG and SURF_PPB added 

Also write_debug routine added in Derived_ml

================================ rv3_2_8, Dave  8th May 2009======

Derived_ml, My_Derived_ml

Start of move to simpler system, where wanted surface concentrations
can be specified with their index, e.g to get ug(N)/m3 NO2
use SURF_UG_N = (/ ...., NO2, .... /)
 - removes need for character "D2_NO2" and index D2_NO2 and allows
Derived to be specified with simple loop over SURF_UG_N. Similar
system in place for SURF_UG_S, and will later implement SURF_PPB


Derived, My_DryDep 
AOT30 outputs removed. (Whole AOT system should also be replaced. Usage
of e.g. D2_AOT30 in My_DryDep caused hard-to-find bug in d_2d when AOT30 removed
from Derived system)

My_Chem_ml   - use PPM25 instead of PM25 for primary  PM25. Ditto for PMco
My_WetDep_ml -  ditto
Sites_ml     -  ditto

My_DryDep_ml
   AOT30 stuff removed. (Hard-coded D2_AOT30 variables caused hard-to-find
    problem in d_2d index. Hard-coding of numbers proved bad once again....)

================================ rv3_2_7, Dave  5th May 2009======

** Bugs found and fixed **
-  bugs were in old  My_WetDep_ml code, but luckily not for 
anything we have reported. wepdeppm25 and wdeppmco were wrong.
WDEP_NH3 and WDEP_aNH4 were mixed up, but WDEP_RDN was okay.


Aqueous_ml - loop over SO4LIKE once wet dep loss rate for SO4
  calculated. 
  uses wdeploss frm MassBudget instead of old sumloss
  now sets wdeploss using indices, e.g. wdeploss(SO2)

Io_ml - added IO_DEBUG to allow printout to separate file (just fort.26 for now)

My_WetDep_ml:
  use array SO4LIKE to contain other fine particles
  now sets wdeploss using indices, e.g. wdeploss(SO2)
  (slower I guess, but clearer and safer!)

Runchem_ml:
  modified to use new WetDeposition, SOA_ml
  - pretty messy with DEVUG statements. Will tidy up another day

SOA_ml:
  debug_flag added

(These changes are a step towards SOA, where many species will need
to be handled by the dep routines, but all as SO4-like.)

================================ rv3_2_6, Dave  4th May 2009======
Emissions_ml
Replacement of if(me==0) with  if(MasterProc)

Replaced the calls to MPI_ABORT with CheckStop calls. I hope these do the
same thing, and they help to keep the code shorter. Look for "!dsx" bits
to check this. (We can delete these lines once we are sure all is okay).

ModelConstants_ml
-- added extra DEBUG constants

================================ rv3_2_5, Peter 4th May 2009======
NetCDF_ml:
Bug: Removed a test which stops the code.

run.pl:
defined($country_nums{$cc}) and ALL => 0 for selecting all countries



================================ rv3_2_4, Peter 22nd April 2009======

Flexible BIC:
If the "Boundary_and_Initial_Conditions.nc" file is not found, it will interpolate the data from
"GLOBAL_Boundary_and_Initial_Conditions.nc".
"GLOBAL_Boundary_and_Initial_Conditions.nc" should be written with global run results (not yet done).

NetCDF_ml:
 GetCDF is now very general, it does not assume anything about the dimensions. You can use this to read any Netcdf file.
new routine "Read_Inter_CDF". It reads data from a lon lat grid and interpolates to the model grid. (not in parallel, should be called by me=0 only)

run.pl: link to "GLOBAL_Boundary_and_Initial_Conditions.nc"


================================ rv3_2_3, Peter 3rd April 2009======

Updates for the Global model

Solver.f90
nchem=15 for gridwidth larger than 60km.
Still this value should be tested.

Met_ml:
Improved default value for sdot.

Emissions_ml:
Introduced a "MONTHLY_GRIDEMIS" parameter for easier use in global runs.

My_Chem_ml:
species%sulphur=0 for ISONO3,ISNI and ISNIR (bug)

Landuse_ml:
NLUMAX = 19 

================================ rv3_2_2, Dave 27th Mar 2009======

Some small tidy-ups, and extensions:

Country_ml:  IC_INTSHIPS = 350 added for TNO emissions

EmisDef_ml: extended to deal with TNO EC/OC emissions

EmisGet_ml: extended to allow for more emission entries

Emissions_ml: tidy up of DEBUG stuff.

ModelConstants_ml: more DEBUG added

================================ rv3_2_1 20th Mar 2009======

Various DEBUG variables changed, See new logicals in ModelConstants_ml

Sites_ml  - ascii output set to 10 columns rather than 8 (easier to
count!). Also, outputs excluded when site is on domain boundary


======================================================================
================================ rv3_2 Hilde/Dave  19th Mar 2009======
======================================================================
MAJOR CHANGES SINCE RV3_1

Done - rv3_2 now has new co-dep routine, new aerosol deposition, and
 more land-cover output possibilities in Derived. See various beta
 changes below...., this has been a long process!

================================ rv3_2beta18 Dave, 16th Mar 2009======
(Skipped 16,17 ...)

Major change in aerosol deposition calculations, designed to simplify.
Aero_Vds_ml replaces Aero_Rb_ml, and will serve as a collection point
of alternative algorithms. For this version use a simple formula ('GPF'=
generalised Petroff fit) for forests
derived from Petroff et al's papers, as function of ustar, SAI and invL.
Use Nemitz(2004) for all else. SubMet also changed to reflect findings of
various ustar tests against CarboEurope data and offline testing.

Also note new way of specifying DEBUG in ModelConstants - applied
to just a few routines so far. (Intended to make if faster to
switch debuggung on and off, and to save those occasions where
MY_DEBUG in SubMet_ml didn't help as the poor user had forgotten
that this one needed DEBUG in RUnChem_ml switched on too. (Otherwise
debug_flag was never set true)

Derived system modified again, to allow landuse-specif met
params to be output, just invL and ustar so far. Still should
be improved and made more efficient - a work in progress.

Module changes:

CellMet

  Grid%is_allNWPsea added -  used to identify all-sea squares

  Following Branko's comments, we limit u* to a physically plausible value,
  0.1 m/s to prevent numerical problems in stable BLs

CoDep_ml - just write "First CoDep" for MasterProc

Derived_ml - makes use of  DEBUG_DERIVED, and OutMET added. Also
            USTAR_NWP.

DryDep_ml
 Large changes!
 replace Aero_Rb with Aero_Vds, and use new formula for forests,
 Wesely for all else. Settling velocity calc moved in Aero_vds_ml
 also.  Limit settling velocity (Vs) to 2 cm/s

LocalVariables_ml.f90
  logical :: is_allNWPsea   !  Only sea in grid-square

ModelConstants_ml
  new DEBUG_RUNCHEM etc.

Rsurface_ml -  max 10 s/m for HNO3 re-introduced

Runchem_ml - uses DEBUG_RUNCHEM

SubMet_ml
   Many changes - Increased iterations for neutral, unstable,
   just one for stable.

   We restrict z0 to max 0.5m, since comparison with CarboEurope
   results shows that this provides the best u* values for forests.

    ! We use the same restriction on z0 as in Berge, 1990 (Tellus,42B,389-407)
        Sub(iL)%z0 = max( Sub(iL)%z0 ,1.5e-5)

    Uses DEBUG_SUBMET

Rsurface_ml
 - reimplement Vg limitation for HNO3. 10 cm/s max is enough anyway!

run.pl
  New input files, shorter veg in general
 $ifile{"$DataDir/Inputs_LandDefs.csv_05.12.2008"} = "Inputs_LandDefs.csv";
 $ifile{"$DataDir/Inputs_LandDefs.csv_25.02.2009"} = "Inputs_LandDefs.csv";

ZD_OZONE/My_Derived
  changes for new met outputs
  tidy up for OutVg, OutRG

ZD_OZONE/My_DryDep
    Uses DEBUG_MY_DRYDEP
    OutMET added


================================ rv3_2beta15 Hilde, 25th Feb 2009======
New run.pl with:
   Inputs_DO3SE.csv_25.02.2009 (Surface resistance for RgsS for ice set to 1000). No effect on results
   Inputs_LandDefs.csv_25.02.2009  - reduced height for forests and med. Scrub. Will change results

   SubMet_ml:
      revised ustar, invL, with more iterations for unstable
      z0 limit changed slightly, to match Berge 1990 value
      CellMet-ml -in troduced 0.1 m/s limit on ustar for Grid%ustar

================================ rv3_2beta14 Dave/Svetlana, 11th Feb 2009======

SubMet_ml - bug corrected on z0 for sea-areas (big effect?!)
    new (still experimental) limit on forest z0 = 0.5m

PhysicalConstants_ml - Charnock set to 0.0144 instead of 0.036


================================ rv3_2beta13 Peter,   4th Feb 2009======


Met_ml:
New method of deriving sigma_dot when it is missing.
Hopefully this can be a usable alternative, which will avoid most of the prostprosessing 
problems of the metdata (mass filtering etc).

Will not changes results in case sigma_dot is found.

Small change in Output_hourly (only debug printing).
            if ( hr_out(ih)%type(1:3) == "ADV" ) then



================================ rv3_2beta12 Dave,   3rd Feb 2009======

MasterProc introduced in:
  ModelConstants
  Par_ml
  LandDefs
  Io_Progs_ml

 Use "if (MasterProc)" instead of "if (me == 0)", which needs use ModelConstants
instead of use Par_ml. Easier for box-model type codes.

Also: 

LandDefs_ml made F-complaint
PhysicalConstants_ml: R removed, only use RGAS_KG
  Met_ml: R replaced by RGAS_KG. 
(I think single letter parameters are too hard to search for.)

SubMet_ml   made F-complaint

================================ rv3_2beta11 Hilde,   29nd Jan 2009======
Bug in Output_hourly.f90:
Units wrong for case ( "ADVugm3" ).

================================ rv3_2beta10 Peter,   22nd Jan 2009======

Bug in Met_ml introduced 20th Nov 2008: when a metfield was not found the routine GetCDF_short 
returns without closing the file.
If the number of open files exceeds 4096, the program will stop.
No differences if you haven't noticed.

Bug in Log.changes: Jan 2008 was Jan 2009 :-)

================================ rv3_2beta9 Hilde,   20th Jan 2009======

DAY_NIGHT=0.6 in Timefactors_ml for sector 10. This means that the agricultural emissions will be 1.4/0.6 times larger in day time than in night.

================================ rv3_2beta8 Dave,   12th Jan 2009======

fixed bug in CoDep, which I thought had been fixed in beta7 :-(

================================ rv3_2beta7 Dave,   12th Jan 2009======

CoDep has a small bug-fix (for IRH=0, F4) and more debug options
 + includes Hilde's bug-fix for MAX_SN

Derived_ml + My_Derived_ml 
  now has OutRG as merge of OutR and OutG terms

DryDep + My_DryDep

landuse-specific, *and* grid-average, deposition (Vg),  resistance (R)
and conductance (G) variables now stored in "Mosaic_xx" arrays in
DryDep. Using landcover index=0 gives grid average

Deleted old arrays, Grid_Vg_ref, Vg_ref_iL etc.

DRYDEP_CALC  renamed to DRYDEP_GASES
NDRYDEP_CALC renamed to NDRYDEP_GASES
NDRYDEP_TOT  renamed to NDRYDEP_CALC - ie back to original intention

Area(:) renamed to EcoArea



OutR, outG merged into outRG 
================================ rv3_2beta6 Hilde,  17th Dec 2008======

Derived_ml: small change (only effect is that less 'warnings' written out, there was a problem with undef values)
CoDep_ml:a_SN_24hr=so2/nh3,a_SN=so2/nh3, both capped at so2/nh3=3.0, Switch off debug flag
Rsurface_ml: fsnow =2.0 *G%sdepth/Sdmax (before G%sdepth/Sdmax)

Changing a_SN_24hr from 0.6*so2/nh3 to so2/nh3 has only minor effect on so2/nh3 in 2006 
(average increase from 0.8 to 0.81, 1% to 3% higher than obs)

Changing fsnow from G%sdepth/Sdmax to 2.0*G%sdepth/Sdmax
================================ rv3_2beta5 Hilde,   8th Dec 2008======
CoDep_ml: cap on minimum value on nh3conc (to avoid numerical problems
when nh3 conc is zero - like it is in the beginning)

Derived_ml: Outputted so2nh3_ratio capped at 3 to avoid unrealistic values in the average.
Anyway so2nh3ratio_24hr is effectively capped at 3 in the Rns calculation, so this will show
how it is used.

DryDep_ml: changed dimensions
My_DryDep_ml: small change in output for Rns since it is not defined for all landuses always

================================= rv3_2beta4 Hilde,   8th Dec 2008======
PhyChem_ml: call to make so2nh3_24hr! Was forgotten committed, so so2nh3 was 
effectively set to 0 everywhere after new CoDep routine added...

run.pl: New links Inputs_LandDefs.csv_05.12.2008 and Inputs_DO3SE.csv_05.12.2008
================================= rv3_2beta3 Hilde,   5th Dec 2008======
added Snow and so2nh3_24hr to old output system and committed Derived and My_Derived again.
================================= rv3_2beta2 Hilde,   5th Dec 2008======
Output system for  Rs, Rns and Gns added for ecosystems
Snow and so2nh3_24hr added to old output system.
Changes in

  My_Derived_ml
  My_DryDep_ml
  Derived_ml
  Rsurface_ml
  DryDep_ml
================================= rv3_2beta Hilde,   4th Dec 2008======
Change version number to reflect that this model version has new
deposition scheme compared to rv3_1 series...
================================= rv3_1_10  Hilde,   4th Dec 2008======
Met_ml: read snow,ice, foundsdepth, foundice
CellMet_ml : use sdepth,ice snow from Met_ml
Chem_ml: defined  so2nh3_24hr and Grid_snow
DryDep_ml : define Grid%so2nh3ratio24hr, remove Rsur_dry/wet + change call
CoDep_ml.f90: new method for Rns_SO2. Changes also for Rns_NH3. (Was also bug in Rlow here,
it was added both here and in Rsurface_ml)
Rsurface_ml.f90: Re-written so that Rdry and Rwet no longer needed (due to new method for Rns_SO2).
Added new method for snow, for SO2 and O3 (affecting all).

GlobalBCs_ml.f90: added reference to Hicks et al 2002


================================= rv3_1_9  Dave,   3rd Dec 2008======

New system started for Derived components, working for DDEP and
VG outputs. Gets rid of need for hard-coded indices such as DDEP_SOX,
etc., and makes it faster to specify landuse and species options.
(
Changes in:

  My_Derived_ml
  My_DryDep_ml
  My_WetDep_ml   ! Still uses old-scheme, but now has SO2, SO4 etc.
  Derived_ml

================================= rv3_1_8  Dave,   3rd Dec 2008======

CoDep_ml - bug found! This will change results for depositions of
   all components!
ModelConstants_ml - 2 extra DEBUG  sites added
================================= rv3_1_7  Hilde,  2nd Dec 2008======
LocalVariables: Added is_veg,is_ice, sdepth, ice so2nh3ratio24hr
SubMet_ml: is_veg and is_ice set

================================= rv3_1_6  Hilde,  2nd Dec 2008======
Set New meteorology directories (Parlam-PS with snowdepths and ice fraction) in run.pl.
Bug in LandDefs (is_veg) fixed.Mostly affects dry dep velocities of coarse particles over urban areas.

================================= rv3_1_5  Dave,  1st Dec 2008======

NetCDF_ml, small change to allow longer variable names, e.g.
DDEP_aNO3_m2Conif:

   !dsDec08 character*18 :: varname
   character(len=len(def1%name)) :: varname

and some extra use of MYDEBUG
================================= rv3_1_4  Peter,  20th Nov 2008======

Only minor changes:

Met_ml: "validity" returned from Getmeteofield gets the value "field_not_found" if the field is not found.
This can be used to set foundSST=.false. for example, or to stop cleanly.

Solver: removed dt_tot, which was not used anyway.(requested by Martin Schultz)

Functions_ml.f90:  in Exner_nd replaced "ix1 = x1" with "ix1 = floor(x1)"
It is somewhat clearer, and works also for negative pressure :-)

run.pl: "#PBS -lpmem=2000MB" , gives higher queue priority on stallo.

My_DryDep: Switched off debug flag

================================= rv3_1_3  Dave,  8th Nov 2008======

Ecosystem dry deps changed, to be per m2 of ecosystem

** Note - this changes the values, since before they were per m2 of Grid,
          not of ecosystem!  No need now to scale anything with landuse
          data.

*Note change of output names: 
   DDEP_SOX   is now  DDEP_SOX_m2Grid
   DDEP_OXSCF is now  DDEP_SOX_m2CF
 etc.

My_DryDep - use of AreaCF, AreaDF, etc., plus new names
My_Derived_ml  - Use of new names
Derived_ml     - Use of new names

DryDep_ml  - added arguments to call to Add_ddep
Cellmet_ml - set %coverage, LAI etc to zero before assigning .. safety measure
to allow use of full array from 1..NLANDUSE.


================================= rv3_1_2  Svetlana,  8th Oct 2008======

My_outputs_ml, Sites_ml changed to allow outputs of d_2d variables.

================================= rv3_1_1 ==============================

First bug fixes:
  sign of Hd test and GRAV changed for wstar calculation - bug spotted
  by Massimo

  
================================= rv3_1 ================================


 As used for 2008 EMEP Reports 

================================= rv3_0_7 10th june, Dave ==============

Removed dead-code (MACHO refs!) from Tabulations_ml
ONLY commented-out lines removed.

================================= rv3_0_6 4th june, Hilde ==============
Country_ml.f90 updated with the new country codes from Agnes (EECCA countries)

================================= rv3.0.5, Peter,  Apr 15th 2008  ==============

Output_hourly: put the vertical coordinate for hourly output right.
	       If 20 level are requested the lowest level has k=20 (as usual)
	       If less than 20 levels are requested the lowest level has k=1
	       Also corrected ist etc. to be compatible with the nesting changes 
	       made in rv3.0.4

Makefile is now Makefile_stallo

================================= rv3.0.4, Peter,  Apr 4th 2008  ==============

Hourly cdf output: put timestamp at end of period
Nesting: istart etc coordinates relative to large domain instead of small domain.
LandDefs_ml: dimension of Header put to 15
Advection_ml: improved the ADVEC_TYPE=2 option (not the default value) for exact mass conservation 
Sites_ml: allow sites/sondes on model boundaries (needed for poles in global runs)
Timing_ml: use MPI_WTIME to measure walltime

None of these changes should affect the results of "standard" runs.

================================= rv3.0.3, Dave,  Mar 18th 2008  ==============

GlobalBCs_ml 
added 2006 O3 backgroud, using data from Derwent et al. (2007) paper

================================= rv3.0.2, Peter,  Mar 3rd 2008  ==============

Just additional comments in the code.
In ZD_OZONE/MyDerived_ml !NB: do not remove without removing from My_DryDep too
In ModelConstants_ml PT = 1.0e+4    ! Top of model region = 10000 Pa = 100 hPa


================================= rv3.0.1, Dave,  Mar 1st 2008  ==============

Io_Progs_ml  -  bug fix to remove text trailing # in HEADER line  (doesn't 
     matter to results though)

Landuse_ml - small formatting change

NetCDF_ml and Nest_ml reset to rv3beta13 status


==============================================================================
================================= rv3      2008  =============================
==============================================================================
1st OPEN SOURCE CODE ON WEB!!!

End of rv3 series. Almost identical to rv3 as given on web, but

(Had to reset Nest_ml and NetCDF_ml to slightly older code. Will
update again as 3.1. 

** modrun.pl is still different in rv3 and on web-version. Too many
differences to bother about here.)

============== rv3beta13  feb 6  2008  =============================
Peter
Small bug: current_date declared twice in NetCDF_ml (does not influence 
output, but pgi compiler complains).

============== rv3beta12  feb 2  2008  =============================
Peter
New update of adv_var: the previous version seemed to hang on stallo in some situations (global model)

============== rv3beta11  Jan 31  2008  =============================

copied the new Inputs_LandDefs.csv into DataDir and corrected a bug 
introduced in run.pl from rv3beta9 when runnning on snykov.

run.pl, modrun.pl - modified to use renamed Inputs_LandDefs.csv


============== rv3beta10  Jan 31  2008  =============================
Dave

DO3SE system simplified to remove various special features. Effect of
old needles removed, and replaced by simply setting lower fphen in
Inputs_DO3SE.csv.

Treatment of Astart, Aend now automatic also - special code removed

Inputs.LandDefs now renamed Inputs_LandDefs.csv, and values changed

Inputs_DO3SE.csv values changed
   - both to reflect revisions to mapping manual, and  recent work

Wesely_ml - tidied up some comments about NH3


SHOULD USE NEW INPUT FILES ALSO!

============== rv3beta9  Jan 16-17  2008  =============================

Stallo version of run.pl and Makefile_stallo.
Just set STALLO=1. Choose USER, ProgDir,WorkDir, Emissions etc. as usual.
32 procs choosen in ModelConstants_ml.

Put an  MPI_BARRIER in Io_Progs_ml: OpenMPI becomes crazy (huge memory 
leak->node crashes) because each line was is in separate buffers to all nodes,
 before they were received.


============== rv3beta8  Jan 8-9..11  2008  =============================
Peter, Svetlana

End of run dates for "fullrun" in NetCDF_ml.
Removed "initnetcdf" routine from Unimod and NetCDF_ml (was never used).

Defined veg_month in DryDep. Seemed not to be defined before? Does it work now??
Initialized veg_month=1 in DO3SE_ml

Changed definition of LandType in LandDefs_ml:
            LandType(n)%is_water  =  LandInput%code == "W" 
            LandType(n)%is_ice    =  LandInput%code == "ICE" 
            LandType(n)%is_iam    =  LandInput%code(1:4) == "IAM_" 

            LandType(n)%is_forest =  &
                ( LandInput%type == "ECF" .or. LandInput%type == "EDF" )
            LandType(n)%is_conif = ( LandInput%type == "ECF"  )
            LandType(n)%is_decid = ( LandInput%type == "EDF"  )
            LandType(n)%is_crop  = ( LandInput%type == "ECR"  )
            LandType(n)%is_seminat  = ( LandInput%type == "SNL"  )
            LandType(n)%is_bulk   =  LandInput%type == "BLK" 
            LandType(n)%is_veg    =  LandInput%type /= "U" .and. &
                  LandInput%hveg_max > 0.01   ! Excludes water, ice, desert 

NB:Water defined with type "BLK" in  /home/mifapw/emep_common/Data/Inputs.LandDefs
BUT NOT IN ~mifads/Unify/Data/EMEP/Inputs.LandDefs
Copied also the other input files from ~mifads/Unify/Data/EMEP/ over to /home/mifapw/emep_common/Data and 
/home/mifapw/emep_common/Data/EMEP
Changed run.pl to take into account these changes

Uncommented a system call in Nest_ml: can cause problems in combination with OpenMPI (problems appeared on Stallo).

============== rv3beta7  Nov 16  2007  =============================
Dave

 GPL added to TimeDate_ml

============== rv3beta6  Nov 12  2007  =============================
Dave

My_FastReactions.inc added, and included in My_Reactions.inc
-- saves having identical code 3 times in My_Reactions


============== rv3beta5  Nov 7-8  2007  =============================
Peter
Met_ml: non-blocking MPI_ISEND for wind speeds in metvar. 
        Uses dedicated arrays for receive buffers. 
	Was giving worng results with -O3 option (!?)

SubMet_ml: Sub(iL)%rh = min(1.0,Sub(iL)%rh)! keeps rh <= 1
	   instead of e = min(esat,e) 	
           Is mathematically identical, but gave slightly different results with -O3 option.	

Dave
CellMet_ml: wetarea change to avoid numerical problems.
  !   .... we allow a small build-up phase, with
  !   linear increase from wetarea=0 to wetarea = cc3dmax for values of
  !   prec between 1.0e-8 (near-zero!) to 0.01.

Svetlana:
  Added foundSST = true for cdf met reads

============== rv3beta4  Nov 5-6  2007  =============================
Hilde, Svetlana
Files cleaned for unnecessary output. Changed files are:

Unimod.f90
Emissions_ml.f90
Landuse_ml.f90
Met_ml.f90 (also with Svetlanas reading of SST)
Derived_ml.f90
Timefactors_ml.f90
EmisGet_ml.f90
My_BoundConditions_ml.f90
BoundaryConditions_ml.f90
GlobalBCs_ml.f90
Runchem_ml.f90
Advection_ml.f90
PhyChem_ml.f90
Biogenics_ml.f90
Volcanos_ml.f90
Io_Progs_ml.f90
NetCDF_ml.f90
AirEmis_ml.f90
EQSAM_ml.f90
DryDep_ml.f90
OutputChem_ml.f90



Makefile and Makefile_snow:
replaced the -O3 compiler option with:
-O2 -mieee-fp -ftz 

============== rv3beta3, Oct 26  2007  =============================
Dave, Svetlana

GPL added

modrun.pl added - simpler (snykov only) version of run.pl for distribution
  with Web model

Bug-fix: 2nd open of IO_TMP removed in  LandDefs_ml

SeaSalt_ml :  default Tw changed to T2 (not 283) for cases where no SST
               (involves bug-fix for SSfi with netcdf).
Met_ml:       foundSST added  to say if SST available. (** not ** available in
                netcdf files!)

============== DELETED TAG: rv3, Oct 24  2007  =============================

Just one commented-out line removed from SeaSalt_ml

============== rv3beta2, Oct 1  2007  =============================

SeaSalt_ml added from Svetlana

Sites_ml - slight format changes

Unimod.f90 - cleaning, Dave

run.pl netCDF option added

============== Dave, rv_Beta30 30 Sep  2007  =============================


New modules:
============
CellMet_ml - sets met params for lower grid cell, call SubMet
CoDep_ml   - for SO2/NH3
DO3SE_ml   - reads in and set sto. conductance stuff
LandDefs_ml - 
LocalVariables_ml   - grid met in Grid%, sub-met in Sub(iL)%
Rb_ml  - for Rb...
StoFlux_ml


Some changes:
Deleted               Replacement
=========             ===============
DepVariables_ml       LocalVariables_ml
UKsetup_ml            LandDefs_ml.f90
JUN06_gfac1.dat       Inputs_DO3SE.csv
JUN06_gfac2.dat          "      "       
JUN06_biomass.dat     Inputs.LandDefs


Changes due to new system:
===========================
Aero_Rb_ml uses LandType
DefPhotolysis_ml - uses Grid%izen
DryDep - *** major re-write ***
Functions_ml - MicroMet stuff removed
Landuse_ml - *** major rewrite ***
Makefile.SRCS - new files, some deletions
Met_ml - invL calc moved to CellMet
Radiation_ml (albedo removed from PAR calc.)
Rsurface_ml
Runchem_ml
SubMet_ml - *** major rewrite ***
My_DryDep_ml

SeaSalt - JUST A FAKE FOR NOW!

Cleanups:
==========
Chem_ml
Derived_ml 
Emissions_ml
GridValues_ml
Io_Nums_ml
OrganicAerosol_ml
PAR_ml
PhyChe
Setup_1d_ml
Setup_1dfields_ml
Unimod.f90   (now outputs Base_fullrun.nc, not Base_year.nc)
My_Chem_ml
My_Reactions_ml
My_Derived_ml
My_Emis_ml
My_WetDep

Minor (due to renamed modules)
=========================
MassBudget_ml
ModelConstants_ml
Solver_ml


============== rv2_9_16, Sept.  28th 2007  =============================

Dave:
Bug-fix for old_gsun in DryDep_ml

Svetlana:
Cleanup of Runchem_ml, My_Aerosol

y============= Dave, rv2_9_15, Sept.  27th 2007  =============================

d_2d initialised to zero in PhyChem for all components
(check by Svetlana)

Bug-fix in SubMet_ml, as test for water was wrong

DryDep - modified for above + clean up (in case this is the last version).


============== rv2_9_14, (also 13?) Sept.  27th 2007  =============================

Dave
Sites_ml.   2nd Bug-fix for sondes --- for now excluding values from domain boundary.
   Was giving e+254 type values ..... 


Hilde+Heiko
run.pl corrected so that SR runs works
TimeDate_ml.f90,GlobalBCs_ml.f90,BoundaryConditions_ml.f90 cleaned 

============== Dave, rv2_9_12, Sept.  26th 2007  ==============================================


MicroMet properly added (cvs add)

Sites_ml.   Bug-fix for sondes

============== rv2_9_11, Sept.  25th 2007  ==============================================

Dave:
MicroMet_ml introduced - has MM functions from Functions_ml
DryDep  - now use MicroMet_ml

chmod a-x *.f90 etc. applied..

NLANDUSE now only from ModelConstants_ml, (old NNLANDUSE dropped)
DepVariables now "uses" ModelConstants_ml

gc_com_for_1proc deleted

Semeena:
DOC updates

============== rv2_9_10, Sept.  25th 2007  ==============================================
Hilde:
PhyChem:
Precipitation initialized(bug corrected)


Updates related to N2O5 hydrolysis:

N2O5_hydrolysis_ml : added
Setup_1dfields_ml.f90: f_Riemer moved to N2O5_hydrolysis_ml
Setup_1d_ml.f90:  f_Riemer  from N2O5_hydrolysis_ml
Solver.f90: f_Riemer,VOLFAC from N2O5_hydrolysis_ml
ModelConstants_ml.f90: VOLFAC moved to N2O5_hydrolysis_ml
My_Chem_ml: bug in rcmisc(8,k). This bug makes the new reaction rate (for the N2O5 hydrolysis) 4-8 times smaller

Svetlana:
Out_restri_ml removed, also in Unimod, Makefile.SRCS., My_Outputs_ml, OutChem_ml.f90
Some cleanups in those modules.
EmisGet_ml - cleanup

Dave:
Cleanup in My_Chem_ml, PhyChem


============== Semeena, Heiko, rv2_9_9, Sept.  23rd 2007  =================================

Updates to documentation

New run.pl with SR stuff placed near end of file.
  (SR functionality not yet tested though!)


============== Peter, Svetlana, rv2_9_8, Sept.  21th 2007  =================================

run.pl $line=~ s/!.*//;
	for cases where NPROCX has been uncommented 

Solver_ml - cleanup

============== Dave, Michael,  rv2_9_7, Sept.  20th 2007  =================================

Io_Progs - extra options added to check that required key-value pairs exist.

run.pl   -  Michael's user corrected, and location of sites/sondes redefined.

Sites_ml.f90   --- now expects sites.dat and sondes.dat to have formatted headers.
                   + cleanup

SmallUtils - small update (trim used)

============== Peter, rv2_9_6, Sept.  19th 2007  =================================

Setup_1d_ml: checkstop when a NaN is detected 
             removed: use MyChem_ml,  only :  Set_2dBgnd

Met_ml: CheckStop(nhour/=0 .and. nhour /=3..) for netcdf metinput

EmisGet : removed stop when country "N/A" is detected

run.pl: changed the crash message
        included $METformat to switch to necdf for netcdf metdata
	changed -lnodes=16 to be compatible with ModelConstants

============== Dave, rv2_9_5, Sept.  15th 2007  =================================

CheckStop added into find_index - to catch cases where the index isn't
   found (was used to track down D2_indices which were not set in
   My_Derived).

My_Derived changed to force use of the hard-coded D2_ values (e.g. D2_AFSTDF16).
  (Should modify rest of code to be more flexible).

Landuse_ml -- commented out lc_water, lc_ice to remove problems.  Will be
  fixed in forthcoming version.

============== Dave, rv2_9_4, August 30th 2007  =================================

Biogenics_ml re-written to simply read in BVOC emission potentials, rather than
   calculate them. Now same procedure for EMEP domain, GLOBAL and HEMIS.

  Associated changes and small tidy-ups in Emissions_ml,  Setup_1d_ml, 
     Setup_1dfields_ml, Unimod.f90

Derived_ml --- debugging now uses debug_proc etc. from GridValues. Small bug-fix
    which caused WARNINGS for PR/DEP.

Io_Progs_ml, optional argument CheckValues added to ReadSDN, to let user specify
   key-value pairs that must be included in input file.

Landuse_ml   - slight rename of Inputs.Landuse
My_Emis_ml   - removed MY_MODEL
Met_ml       - small tidy-up
TimeDate_ml  - small tidy-up

run.pl --  $NDATA points to new Inputs directory.
           prog.exe now added into Remove.sh

Inputs: new inputs directory, ~mifads/Data/EMEP (GLOBAL + HEMIS) created while 
  new style data being created (with headers and key-values)

cvs DELETED::  UiO_ml  Wrtchem_ml

============== Peter, rv2_9_3, August 28th 2007  =================================

Unimod.f90: Removed call to DefGrid (moved into Met_ml)
	    Read input parameters using read_line

Met_ml.f90: call to infield(1) and DefGrid in the MeteoGridRead routine, 
            for the case where felt files are used.


============== Dave,  rv2_9_2, July 26th 2007  =================================

More variable name changes, for i_glob, j_glob. Full list of recent
changes is:

    ISMBEG => "IRUNBEG"
   ,JSMBEG => "JRUNBEG"
   ,IILARDOM => "IILARGEDOM"
   ,JJLARDOM => "JJLARGEDOM"
    IILARGEDOM  => "IIFULLDOM",
   ,JJLARGEDOM  => "JJFULLDOM"
   ,i_glob  => "i_fdom"
   ,j_glob  => "j_fdom"

 The idea is to prevent confusion between global as in for the
World and the computer-concept of global for the full domain.
In future I think global should refer to the World-scale.


DOCS/Manual.tex - changed with suggestion of Part A, Part B
     Outputs.tex - new description of derived outputs
     Input.tex -  small change for input files (DO3SEinputs.csv
            will be introduced soon in place of old MM_biomass, gfac etc.)


============== Dave,  rv2_9_1, July 20th 2007  =================================

Major change - rewrite of Derived and My_Derived

      - should now be much easier to add or remove params from list to be
        included -- just give names (e.g. "DDEP_OXN"). No need to count :-)
        Also, now there is just 2d and 3d  stuff, no more ddep_ and wdep_.
        No need of DUMMY either in 3d output.
        Arrays are allocated as needed.

 
SmallUtils - added AddArray and LenArray to add arrays, and to count number of
    allocated elements (not allocated define with NOT_SET_STRING
      
Included Svetlana's OutputChem_ml, a wrapper containing Wrtchem.f90 and other
   subroutines

Deleted: Wrtchem.f90 - now in OutputChem_ml
 
run.pl - check now added that the number of processors in run.pl matches
   the number in ModelConstants_ml.f90

TO-BE-DONE

 Changes need to be transferred to ACID version

============== Dave,  rv2_9, July 19th 2007  =================================

Major change:

 Par_ml.pat   -- deleted! -- now set RUNDOMAIN, and NPROC stuff in ModelConstants
 Par_ml.f90   --  now a normal file, not changed between runs

 ModelConstants - now has:

    RUNDOMAIN = (/  36, 167, 12, 122 /)     ! EMEP domain
    NPROCX      =   4       & ! Actual number of processors in longitude
  , NPROCY      =   4       & ! Actual number of processors in latitude
  , NPROC       = NPROCX * NPROCY

    DomainName = "EMEP-50kmEurope"

  i.e. run.pl does *not* set the model domains any longer, only the year, NTERM, etc.
  Note also --   need to set lnodes correcly in run.pl - but now check values from
  ModelConstants_ml. In future may be able to make this automatic, but not so far.


  Some renaming:

      Instead of using the terms global domain and small domain, I am trying to
      move to full domain (170x133 or global if it really is a global model!)
      and "run" domain.

        ISMBEG ->    IRUNBEG
        JSMBEG ->    IRUNBEG
        IILARDOM  -> IIFULLDOM
        JJLARDOM  -> JJFULLDOM


   Some re-arrangements:

    All "use" statements moved to top of some modules
    Started putting "use" statements  in alphabetical order - much
     easier to find now. Except --  Start lists with My_ modules.
    Thus,

       use My_Chem_ml

       use CheckStop_ml
       use ModelConstants_ml


 Emissions_ml   - very small tidfy up
 
 Io_Progs_ml      Read2D added

 + probably some other small tidy-ups.


==============  rv2_8_1,  July 2nd  2007  =================================

Provisional - needs to be tested still!!!!!!!


Met_ml:  Cleaned(Jan Eiof), also  some extra Met params made available
           (RH2m, Soil water --- but both seem to have problems!)

DOCS/cookbook + other :  Cookbook  1st darft added, Semeena. Now have 
     both a cookbook for new users, and a Manual for programmers.  
     Do either of:

         latex cookbook
         latex Manual

GridValues_ml: dependence on Io_ml removed (ds)

Io_Progs_ml:   read2DN added (ds) - "fast"  read of New-style input data for
       a file with x, y, z1..z2 type data.


Landuse_ml:  Uses read2DN (ds). Saved 50 lines :-)


==============  rv2_8,  July 2nd  2007  =================================

As used in year 2007 EMEP report work, for SR etc,.

As rv2_7_10, but:

new run.pl from Heiko - replaces earlier run.pl, SRrun.pl,  etc.

GridValues_ml, Landuse_ml, KeyValue_ml, Volcanos_ml - DEBUG switched off


============== Hilde, Dave, Svetlana, rv2_7_10,  Jun 12-25  2007  =================================

Country_ml  - Serbia and Montenegro added properly

EmisGet_ml  - added safety check on country codes

ReadField_ml  - corrected bug (not initialising integer fields, e.g. snow)

Volcanos_ml  - corrected bug in coordinate systems. Started move to i_local 

============== Misc, rv2_7_10,  Jun 7  2007  =================================


Svetlana :
      found (non-fatal) bug in CheckStop in BoundaryConditions_ml

Dave: 
      Rsurface_ml - Swapped Idir, Idiff, removed albedo

Michael:
      Aqueous_ml - cleaned

============== Misc, rv2_7_9,  May 30 2007  =================================

Dave: 
      
    Major changes =======================================================

      Io_Progs_ml added -  new system for reading input files. Simpler (I hope!)
             syntax, requirement for descriptive headers and lines in input
 
      Io_Nums_ml added - just integer values
             file. See Manual for description.

      Io_ml now just wrapper for Io_Nums_ml, Io_Progs_ml

      KeyValue_ml - NEW - simple routines for dealing with a fortran equivalent
         of a key-value pair - a crude attempt to redproduce
         some of the nice features of perl's hashes or python's dictionary

      Landuse_ml - recoded to use new inputs format, Read_Headers, read_line
          and simpler syntax

      SmallUtils_ml - NEW -  module for small utilities. find-index stuff and wordcount
           moved here, and WriteArray added.

      UK_ml, now renamed DepLanduse_ml and recoded as above

      DOCS/Manual/Inputs.tex - started description of new input formats
      DOCS/Manual/Domains.tex - added description of coordinate systems,
           which have confused me for years!

  NEW - Usage of Self_Test in some modules - highly encouraged!! 

    Small changes =======================================================
      CheckStop_ml - added test for CheckStop( string1, string2, info )

      DepVariables_ml - lc_water, lc_ice added - no effect for now, but
           start of recoding

      DryDep_ml - just renaming, UK_ml to Landuse_ml, etc.
      EmisGet - small changes
      GridAllocate_ml -  small changes

      GridValues_ml  -  some tidy up, and table created for various coordinates
          (prints out li0,li1,limax, etc..... for each me ) 
  
          i_local, j_local arrays created (reverse of i_glob, j_glob)

      Makefile.SRCS - updated
      MassBudget_ml - small changes
      Par_ml.pat - CheckStop
      SeaSalt_ml -  just renaming UK_ml
      Setup_1d_ml -  renaming UK_ml + small tidy up
      Sites_ml    -  errmsg added
      Unimod.f90 - smnall changes

+ Landuse.MAY07 created - essentially landuse.JUN06 but with new formatting
+ changed in run.pl

============== Misc, rv2_7_8,  May 21 2007  =================================

Fixed various problems with 2_7_7

Plus, Cleanups and CheckStop from Michael:

     Sites_ml
     Solver_ml
     Output_hourly
     ZD_OZONE/My_Outputs

============== Misc, rv2_7_7,  May 16 2007  =================================

Dave:  Makefile.SRCS added - list of .f90 files, included from all
        other Makefiles.

      CheckStop_ml : Changed name of confusing is_true to is_error 

      Moved GridAllocate from Functions to GridAllocate_ml
      - changes in EmisGet,  UK_ml

      Added Self_Test routine in GridAllocate_ml

      UK_ml - cleaned from CheckStop comments


Hilde: CheckStop added in: BoundaryCOnditions_ml
                           Derived_ml
                           GlobalBCs_ml
                           RunChem_ml


Svetlana: Cleaned up Timefactors_ml


============== Misc, rv2_7_6,  May 11 2007  =================================

Dave: Added new module CheckStop,  to simplify error-testing and
       calls to MPI_ABORT. Can now do e.g. 

              call CheckStop( lu<0,"UKdep lu problem"), or, 
              call Check(errmsg,"Something fishy here...") , or, ...

        - there are five possibilities.

       Functions_ml - small cleanup

       ReadField_ml, implicit none added! BUG fixed, CheckStop added,
         + new subroutine to read 3D fields

       Unimod.f90 - check digits(1.0) - that compilation uses double precision

Peter: CheckStop in NetCDF_ml

Svetlana: CheckStop in Emissions_ml
                       Met_ml
                       Volcanoes_ml
                       Par_ml

Jan Eiof: CheckStop in EmisGet_ml
                       DefPhotolysis_ml
                       Biogenics_ml
                       ReadField_ml (+ Dave's changes above)

Semeena: Cleaned:      MassBudget_ml


============== Misc, rv2_7_5, Apr 19 2007  ================================ 

April 10th, Dave:

  removed Dates_ml from Makefiles.

  modified ReadField_ml, to allow more than one input line per i,j coord
                         + fewer write statements

April 18th, Peter/Semeena:

	Updated NetCDF_ml such that:
	1) Output is CF-1.0 compilant for the vertical coordinates
	2) Corrected a bug when 3D hourly output is required
	
	Derived_mland My_Derived: renamed D2_PS as PS, to be more compatible 
	with what other use (PS is used in the definition of the vertical levels)

	run.pl: put lpmem=200MB 


============== Misc, rv2_7_4, Mar 30 2007  ================================ 

Cleanups:

Michael: Aero_water.f90

Svetlana: Volcanos_ml.f90


============== Misc, rv2_7_3, Mar 29 2007  ================================ 

Hilde: Dates_ml replaced by TimeDate_ml (TimeDate corrected for bug). Changes in: 

 (calc daynumber) Derived_ml.f90
 (daynumber) DryDep_ml.f90
 (nydays) Emissions_ml.f90
 (daynumber)GlobalBCs_ml.f90
 Met_ml.f90
 (date type) Nest_ml.f90
 NetCDF_ml.f90
 Timefactors_ml.f90
 (daynumber) Unimod.f90
 Wrtchem.f90

Minor changes in:
 Advection_ml.f90
 ModelConstants_ml.f90
 PhyChem_ml.f90
 My_Chem_ml.f90
 My_Outputs_ml.f90
 UK_ml.f90
 Setup_1d_ml.f90


Peter: Output_hourly: reversed/corrected order of k-levels in Output_hourly
       (for Semeena's work)

Semeena:  AirEmis_ml cleaned and documented



============== Misc, rv2_7_2 2007  ================================ 

Peter: Advection_ml: more robust advection for global model.
       UK_ml: bug in effectivdaynumber=daynumber (no consequences in practice)

       Met_ml: bug in my gc/MPI changes (rv2_7): gb,gl,gb_glob and gl_glob may be wrong 
               on nodes different from me==0.

       Added comment in Emissions_ml (newmonth):units are ktonnes PER YEAR
       Comment:shouldn't we define emissions as ktonnes per 365 days? 
       A leap year has more 1 day more DMS emissions than a 365 days year...

Dave: xRgsO corrected in Rsurface_ml for snow. Will change results slightly.
	

============== Misc, rv2_7_1  2007  ================================ 

Peter:
   Nest_ml - Mode=12, for read 3D at start of run and write at end
	     and corrected bug in lat lon nesting.
   Makefile_snow, Makefile_njord - replaced Polinat_ml with Trajectory_ml

Joffen:
 Country_ml - cleaned, March 6 2007. This version includes the 
  division of ship emissions into inside/outside the 12 mz, EU/ROW flags, 
  Ferries/cargo ships as this is supposed to be the "strategy" for the 
  future. 

  EmisDef_ml.f90: Cleaned by Joffen, March 6th 2007.
   With the division of the ship emissions in Country_ml,
   lots of new "countries are defined in the same grid. thus the
   number of countries allowed in one grid has to be increased (to 10)
   in EmisDef_ml.f90

  Emissions_ml.f90: Modified for use of timefac_index from Country_ml

  Trajectory_ml - replaces Polinat_ml (mainly name change)
  PhyChem_ml    - now refers to trajectory_out
  

Dave:
  ModelConstanstants_ml - removed assign_nmax, assign_tdadvec
  
  Advection_ml - placed assign_nmax, assign_tdadvec here


Misc:
  Unimod.f90 - changed to accomodate above changes in routines/modules
    (+ close(IO_TMP) added. Bug!)



============== Peter 5/3 rv2_7 2007  ================================ 

All gc_ routines removed! They are replaced by the standard MPI routines.
Affect most of the files.
You can find an overview of the MPI routines for example at:
http://www.llnl.gov/computing/tutorials/mpi/

My_Outputs_ml: Hourly_ASCII = .false. (seriously slows down the program if /global/work is used)
UK_ml.f90: define "effectivdaynumber" for treating Growing Season in Southern Hemisphere
Runchem_ml and Solver: removed dt,reset_chem and Niter, which were not used and may create confusion.
Added Par_ml.f90. It allows to compile without script.

Only numerical changes (<1.E-6) on results.


============== Peter, Dave   rv2_6_6  6/2...31..23..25/2/2007 ======================

Advection_ml: renormalization between horizontal and vertical advections in  advecdiff_poles

Dates_ml: extended to 2006, but only MaceHead to 2005 in global yet.

Functions_ml:
Some minima criteria in Ra removed to prevent problems in extreme stable cases

GlobalBCs_ml - updated to 2005

Nest_ml (and Unimod.f90 ,PhyChem_ml): 
Mode 10,11 for warm start option and corrected bug ("idimid") when writing in lat lon 

NetCDF_ml: 
allocate a real*4 array instead of real*8. Avoids possible underflow errors and saves some memory.


XM_MAX_ADVEC removed from Met_ml and Model_constants (was not used)

Met_ml:
small change in definition of "cyclicgrid"

Rsurface_ml:
Some minima criteria removed to prevent problems in extreme stable cases

run.pl
Simplified, especially for input files.
Included Tareq in run.pl USERS.

Removed srun.pl, nrun.pl, local2global.f, global2local.f, gc_com.f from cvs

============== Peter   rv2_6_5    19/1/2007 ================================================

New common run.pl script for njord and snykov. NB: It also use /global/work on snykov.
Use this one as it will simplify maintenance to have 
fewer scripts. Not yet made for SR runs (should also be done with the same script).
Choose  $NJORD=1 or $SNYKOV=1 in the script.


Derived_ml:
Changed units written in outputs for all depositions (ug/m2  was written instead of ugS/m2)

Small changes for the global version: (does not affect other runs)

Advection_ml: 2 old "bugs" corrected. 
	preadvx(2): did not work if west neighbour = east neighbour (possible in cyclic grid)
	adv_var: nonblocking sends. Otherwise may hang if extremely large grids are used.

Met_ml:
Defined poles when lat > 88 degrees.
Small changes in the extrapolation of xm outside the grid.

Country_ml:
country 67 -> timezone=-100. For unknown countries

============== Peter   rv2_6_4    13-30/11/2006 ================================================

Dates_ml - extended LAST_SDYEAR to 2006, Dave

15th Nov put  if(Ascii3D_WANTED)then around the 3d ascii output in Wrtchem.f90
Derived_ml :PS units in hPA

15th Nov Advection_ml "else where" replaced by  "elsewhere" to stop Njords f90 comlpaining

Makefile_njord
Use /home/ntnu/usrlocal/netcdf/netcdf-3.6.1 instead of mifapw's library
Changed -O4 into -O3 -qarch=pwr5 -qtune=pwr5 , because of compiler error during IPA, when compiling the HEMIS grid.


============== Dave   rv2_6_3    3/11/2006 ================================================

On request of Peter, removed *.f files (except gc_fcon_for_1proc.f)

============== Peter  rv2_6_2   27/10/2006 ================================================

Version compatible with "njord", IBM p575+ 16-way nodes, AIX , Load Leveler

gc_com,local2global,global2local set to f90

MARS_ml.f90 line 864 1.d0 changed to 1.0
TimeDate_ml: line 53 reduced month length to 10
Derived_ml.f90 : case ( "MAXADV" ) changed forall (program crashes with segmentation fault otherwise??)
Advection_ml: changed hel1/hel2 into hel1/(hel2+1.0E-100) 
	      because of overflow otherwise (compiler weakness, works without if only -O2 is used)
removed all *.f files (gc_com.f,local2global.f,global2local.f)
new nrun.pl and nSRrun.pl (n for njord)

Makefile_njord created
Makefile_snow updated (.f removed or replaced with .f90) 

Put values in the "k" og the Boundary_and_Initial_Conditions.nc


============== Heiko  rv2_6_1  25/10/2006 ================================================

 I just found a problem in the Makefile_snow, it included
 
 clean:
 	rm ... \
 	touch ... \
 	make depend
 
 
 The last one did thus run 'make depend' instead of 'make -f 
 Makefile_snow depend'. This is fixed in the cvs'd file.

============== Peter  rv2_6   23/8/2006 ================================================

Included Nesting options. 
Not enough tested but needed for ENEA delivery: 3D BC 3-hourly all components.
For a nest run: Set MODE and istart,jstart,iend,jend

Nest_ml: completely revised
NetCDF_ml: secondssince1970 public, 
           not time at middle of period for instant data (like BC).
PhyChem_ml: moved wrtxn call.
ZD_OZONE/My_Derived: SR = false "consistent"
srun.pl :small changes


==============   rv2_5   11/7/2006 ================================================

Also version used for Jul 2006 SR runs for IIASA


==============   Hilde   11/7/2006 ================================================
Mace head correction for 2004

==============   Peter rv2_5beta2   1/7/2006 ================================================

SR=0 should work too  (SRrun.pl)

Changed My_Reactions so that it is fast on snowstorm (and embla).
The old one has been put into My_Reactions.inc_blizz


==============  Anna, Peter, Hilde rv2_5beta2   30/6/2006 ================================================

SR=0 should work too

SR=1 moved higher up in SRrun.pl (was bug: $iyr_trend was never set to 2010)
$iyr_trend = "2020" if $SR  in SRrun.pl


SRrun.pl changed to include PM_ADDED. mkp.pmemis_from_nox changed (and new name), do not include Azerbaijan anymore - we have those PM emissions.
Country_ml.f90: ATX now sea=1

noxsplit.special.2000 should not have been there, the default split should be used for all years before 2010. File removed from datadirectory.

==============  Anna, Peter, Dave rv2_5beta2   28-29/6/2006 ================================================

SR version

My_Derived:
SOURCE_RECEPTOR = .true.
NDERIV_3D =  0

Global_BC:
macehead for iyr_trend > 2010 set to +4.5 (was set +3+4.5=7.5!)

DEBUG options set to false in rv2_5beta

SRrun.pl created to look after SR runs
ATX defined as part of ATL and RUX as part of RU (in femis)

iyr_trend added to RunLog output


SEASALT set to .false.

============== Dave, rv2_5beta   27/6/2006 ================================================

New flux parameters slightly re-defined. MMAOT30 and MMAOT40 added - AOTs according to
 new Mapping Manual approaches.
 Now:
    D2_AFSTDF0, D2_AFSTDF16, D2_AFSTBF0, D2_AFSTBF16, & 
    D2_AFSTCR0, D2_AFSTCR3, D2_AFSTCR6,&
    D2_MMAOT30, D2_MMAOT40

Country_ml - updated from Heiko

Derived_ml - new flux stuff added

DryDep_ml - SumVPD limitations added for IAM_WHEAT

UK_ml - safety checks added on SGS, EGS
        InGrowingSeason array defined to simplify MMAOT calculation


============== Dave, rv2_4_8   25/6/2006 ================================================

Ooops.... forgot to copy My files form main directory into ZD_OZONE before cvs commit.
Done now....
============== Dave, rv2_4_7   22/6/2006 ================================================

New flux parameters defined,  see JUN06 changes
    D2_AFSTDF0, D2_AFSTDF16, D2_AFSTBF0, D2_AFSTBF16, & 
    D2_AFSTCR0, D2_AFSTWCR, D2_AFSTCR6,&
    D2_AFSTCN0, D2_AFSTCN3, D2_AFSTCN6,&

New landuse setup files - in JUN06_biomass.dat etc.
  - results in different growing seasons and depositions for forests
    (e.g. reduced deposition in summer in Mediterranean)

New landuse map - some small corrections, and 3 IAM categories.

Used 4.5 ppb for iyr_trend >= 2010 - quick fix for JUN06 IAM runs.

$MAKE added in srun.pl, to call Makefile_snow if needed. Check if it
       works for others, and usage of .depend!!!

============== Peter v2_4_6_1, 14/6/2006 ================================================

Updated srun.pl: corrected bug (see rv2_4_5). Include "Africa"
Added: Makefile_snow

============== Joffen v2_4_6, 30/5/2006 ================================================

noxsplit changes - splits NO and NO2 similar to VOC. Use "2000" files to get default
9:95% split that we had before

... and from Dave : srun.pl added to cvs, for UiT use.

============== Peter rv2_4_5, 15/5/2006 ================================================

Bug in grun.pl put in version 2_4_3. Wrong meteo link.
Sometimes the first day of a month is linked to the 1/1/ of next year.
The program will notice this and crash.


============== Peter,Heiko rv2_4_5, 19/4/2006 ================================================

Added gc_com.f into the CVS repository. Seems to be missing. It should have been added when Peter removed gc_com.F


============== Peter rv2_4_4, 15/2/2006 ================================================

Accept any projection in CF-1.0 convention.

NetCDF accept "general projection"
Met_ml  accept "general projection"
moved some "use Gridvalues :sigma" (the SGI compiler didn't like variables 
                        to be send as argument and defines with "use")
GridValues AN calculated in GlobalPosition
Derived_ml daily D3_TH=.False.
Dates_ml: included 2004

============== Peter rv2_4_3, 16/12/2005 ================================================
Better Global version. In case of lon-lat grid and poles, special advection 
routines are used.

grun.pl includes a parameter   $HEMIS which (when=1) makes the script link to 
the hemispherical input data. (this script is however quite messy...)
meteo year must be 2001 then.
(put also READBVOC=.true. in Biogenics_ml for improved BVOC emissions)

Meteorology for a whole year can be found at (met.no):
/fou2/emep2/Meteorology/ERA-40/2001_HEMIS_PS/

or (blizzard):
/home/peterw/emep/work/metdata/ERA_2001_HEMIS/


No changes of results in "normal" runs, except that in Country_ml, Russia (42)
 is defined with timezone -100, which means that longitude time is used. 
(can be changed in the file if wanted)


ModelConstants_ml, Unimod.f90,Solver: dt_advec is set according to gridwidth

EmisGet_ml: use country%index to interpret country mumbers in emis
files and femis.dat

Country_ml: 193 countries defined (country index semi-official: defined by Heiko)

Met_ml: bug: should broadcast projection (concern only netcdf met input)

AirEmis_ml: bug when longitude close to 360 degrees or when latitude=90

Emissions_ml: bug in "daytime_longitude"

Advection_ml: new subroutines for advection used in case of lat-lon
grid. Less good treatment of the xy time splitting, but faster and 
can cope with singularity at Poles. 
Changed also adv_var, so that it can treat the
case when a subdomain is its own neighbor (cyclic grid).
For best efficiency of advection it is recommended to use NDY=2 (or
NDY=1) in case lat-lon and poles are included in the domain. 


PhyChem_ml: calls  advecdiff_poles instead of advecdiff when necessary

GridValues_ml,Met_ml,Unimod.f90:: removed jmin_advec, jmax_advec, put Poles into GridValues

GlobalBC_ml,GridValues_ml: redefined lb2ij

Sites_ml: can read files in lon-lat coordinates. The file must be
called sondesLL.dat or sitesLL.dat. Height is always set to KMAX_MID.

Biogenics_ml: Includes an option to read BVOC.dat directly
	(temporary solution)


============== Peter rv2_4_2, 22/11/2005 ================================================

EmisGet changed to include VOC sector 10 by default (perviously excluded).
Now only sector 11 is exlcuded.

============== Peter rv2_4_1, 22/11/2005 ================================================

GLOBAL version of the model

Lat lon grid possible (defined through mapping factors xm_i and xm_j)

Cyclic grid in i direction

Special treatment at poles: 
	-.no "neighbors", but not an outer boundary
	-.special treatment of advection

Emission_ml includes an option to choose that the local time
 (used for the day/night timefactor) is determined by the longitude
instead of the timezone defined in "Countries_ml". This option is selected when timezone=-100.
This should be better at least for countries which cover many 
timezones (Russia, USA ...)
 (This also avoids defining timezones for hundreds of countries :-) 

splitted parinit into two subroutines, one for subdomain sizes and the 
other for neighbors and BC definitions

Removed the last optional argument from CloudAtten in Radiation_ml:
it produced a compiler error in PhyChem_ml, even if I didn't change
PhyChem nor Radiation !? 

EmisGet keep VOC from sector 10 (it was removed in earlier versions)

Modified: Unimod.f90, Model_Constants, GridValues_ml, Met_ml, 
Boundary_Conditions, Par_ml.pat,NetCDF_ml, Advection_ml, 
Emissions_ml, My_Output_ml, Radiation_ml, EmisGet_ml

Still the results are not affected by these changes (!)
Yearly results compared to rv2_1 by Joffen.



=======
============== Peter rv2_4, 2/11/2005 ================================================
(These are same. dave changed number since the changes are substantial

============== Peter rv2_3_3, 26/10/2005 ================================================

Major clean up of binary output and all the .F files. As a consequence several parts of
the Makefile got also cleaner.

Removed:
Output_binary_ml,rmycop.c,getflti2.f,getflti2.F,putflti2.f,putflti2.F,outchem_restri.f,
put_restri_i2.f,put_restri_i2.F, gc_com.F

Modified: Met_ml, NetCDF_ml, Wrtchem.f90, Output_hourly.f90 Makefile

Parts of Output_binary are moved into Wrtchem.
Parts of getflti2.f are put into Met_ml in order to still be able to read the met files in binary.

Results are not affected by these changes

============== Peter & Joffen (+Maarten+Dave)  rv2_3_2, 6/10/2005 ================================================

New AirEmis from Joffen. More general: can use any grid. Some differences 
in results can be expected (due to different vertical interpolation).

Changes in GlobalBC Macehead corrections.
The macehead correction uses now lat lon coordinates instead of "i,j".
This will however make a difference on the results, since the "Macehead sector" is now
defined with lon lat borders. I choosed these rather arbitrarily.
A small test for 2001 shows the following for the "O3fix" correction:
jan: old O3fix=-6.903 ; newO3fix=-6.635
aug: old O3fix=-4.871 ; newO3fix=-4.876

In the future we should also introduce an option (as an input parameter) 
to skip the Macehead correction


Changed Par_ml.pat so that also the large domain is set by grun.pl
Changed grun.pl sp that it sets the large domain in Par_ml.
The date of start is now read in by the model.
The program tries now first to find at NetCDF meteo input file, if it does 
not find it it reads the old felt files.
NB: You MUST update grun.pl

 
Changed definition of xm_i and xm_j: now it is directly the mapping factor
at the boundary of two gridcells.

Changed slightly Timefactors: if just "fname" is declared the values of "an" (from GridValues)
is overwritten(!!!). If instead fname2 and fname0  are declared (as done now) there seems to be
no problems(!). Very strange. Most probably a compiler error. The strange behaviour don't appear
when all the debugger options are on.

NetCDF_ml: We go over to CF-1.0 convention.

Output_binary: corrected an old bug
     !character(len=size(f_2d(1)%class)) :: typ  !  See defs of f_2d
     character(len=len(f_2d(1)%class)) :: typ  !  See defs of f_2d

Modified: NetCDF_ml, AirEmis,Met_ml,Par_ml.pat,GlobalBC,Log.changes,GridValues,
Unimod.f90,Timefactors_ml,grun.pl,Output_binary


============== Peter,   rv2_3_1, 5/10/2005 ================================================
NetCDF input for BIC.

Changed GlobalBCs_ml.f90 so that it can read the BIC from a netCDF file.
The file should be named "Boundary_and_Initial_Conditions.nc" (for now).
If the file or component is not found it looks for the "old" BIC files (D3_O3.01 etc).

An example of BIC file is given in /noserc2/emep/BIC/BIC.nc
Using this file should give the same results as before.
It contains also O3 data constructed from sattellite data. (This data needs to be more tested/ developed)

In the future the BIC.nc file should be global and the fields are to be interpolated to the required grid.

Some changes in NetCDF_ml and corresponding changes in Output_binary and Output_hourly.

Included xm_i and xm_j: the directional map factors. These are equal for a Polar Stereographic projection. (not yet tested in another grid)
(GridValues_ml and Met_ml)


============== Dave,   rv2_3, 11/7/2005 ================================================


Re-labelling only, for EMEP report writing process.......


============== Dave/Hilde,   rv2_2_14 , 14/6/2005 ======================================

.depend:      Removed from CVS. Not needed, as gmake depend generates it, and
              it complicates cvs commit.

DryDep_ml:    Tidy up (interim), plus some commented out code marker for 
              EXTRA_LU outputs added - often used, but has no effect as coded 
              now. Can be used to call user-generated include files if 
              uncommented.

GlobalBCs_ml: Small correction to Mace head correction 

GridValues_ml:  New DEBUG system introduced. GridValues now works out immediately
        which processor the DEBUG_i, DEBUG_j coordinates apply to (new logical
        debug_proc set true), and then calculates the local coordinates
       (debug_li, debug_lj). Other modules may now printout debug info with
       a system such as :


           if ( debug_proc )  then
              write(*,*) "Debuuging ", some_data(debug_li,debug_lj,KMAX_MID)
           end if

         ... instead of having to test i_glob, j_glob against DEBUG_i, DEBUG_j
          as before.  ( See the new PhyChem_ml for other examples)

         Request: please switch modules you work on to this new system - it is
         cleaner and faster. 


PhyChem_ml.f90 - replaces phyche.f. Finally f90 !!!!!!!! ;-)

           Code tidied up. Makes use of DEBUG_i, DEBUG_j

phyche.f   ..... history !


Setup_1d_fields_ml - removed unused Idrctt, Idffuse

Unimod.f90         - uses PhyChem_ml, tidied up "use statements"
 


============== Hilde,   rv2_2_13 , 10/6/2005 ======================================
Mace head correction for 2003 updated

============== Dave,   rv2_2_12 , 20/5/2005 ======================================

DryDep_ml.f90 - bug fix on SAIadd(WHEAT)

My_Reactions - bug fix on Rn222

My_WetDep    - renamed adv to itot since the index is for the xn_2d arrays, not ADV

Aqueous_ml   - renamed adv to itot since the index is for the xn_2d arrays, not ADV


============== Dave,   rv2_2_11 , 11/5/2005 ======================================

Small changes in Met_ml and where iclass used:

iclass array replaced by more descriptive nwp_sea logical - we only
ever checked if iclass == 0 anyway.

r_class  - declared simply, not with allocatable.

============== Dave,   rv2_2_10 , 22/4/2005 ======================================

psurf replaced by ps throughout. Small error in placement of psurf now hopefully
avoided. 

============== Hilde,  rv2_2_9  , 14/4/2005 ======================================
My_chem_ml: small bug
My_Reactions.inc: production rate of Pb210 corrected
Setup_1d_ml: rc_Rn222 should be initialized for all levels. z_bnd converted to cm (from m)

Pb210 changes added to ACID as well (My_Chem, My_Reactions)

============== Dave,  rv2_2_8  , 11/4/2005 ======================================

Rn222 and Pb210 added (for CARBOSOL, but a useful general tracer)
Quite crude addition. Should probably be harmonised with
other surface emissions  such as BVOC or Sea-Salt. ToDo.

My_Chem_ml            - Pb210 added
DepVariables_ml       - LU_ICE added
Setup_1d_ml.f90       - rc_Pb210 added
Setup_1dfields_ml.f90 - rc_Pb210 added
(Changes labelled with Pb210)


Met_ml  - small correction from Peter

UK_ml   -   water_fraction  and ice_fraction added


Some general tidy-ups

============== Hilde,  rv2_2_7 , 08/4/2005 ======================================
Small errors in ZD_ACIDs My_BoundCondition and My_Outputs corrected

============== Dave,  rv2_2_6 , 08/4/2005 ======================================


New (simpler?) arrangements for calculations of ustar, Obukhov length, Exner
Less confusing use and conversions between temperature (t2_nwp) and 
potential temperature (TPot2m). 


Some new notations:

       tau     - was fm
       t2_nwp  - was t2
       TPot2m  - was th2m
       ustar_nwp - was ustar
       invL_nwp  - was invL

   The _nwp is used where variables are appropriate to the whole grid. When
   sub-grid procedurs are applied then different values of e.g. ustar may
   be different for different landuses.

Functions_ml
     - Exner function subroutines, and conversion functions between T and Tpot
         - causes changes in Met_ml, Sites_ml, DryDep, .....
       Note that sometimes we need Exner_nd(p) and sometimes CP*Exner_nd(p)
      
Met_ml 
     - tau (was fm) - now created for MM5-type inputs from ustar, on assumption
       that it is better to linearly interpolate tau in metint than ustar.
       (Since tau ~ ustar**2 is proportional to energy.)

     - Surface temp is now t2_nwp. Multiple conversions to old th2m now
       removed. Tpot2m (was th2m)  now done in met_deriv

     - Exner_ml used

SeaSalt 
     - use of new ustar_nwp. Moved "use" statements to start of module (should
       be done for all modules)

Tabulations_ml
       Exner stuff removed. Only tab_esat remains!

Also - ZD_ACID/My_Chem changes for new Radiation_ml treatment: zen, radzen
       ZD_ACID/My_Outputs corrected for N_NOy.

DOCS:
    - Corrected figure of Arakaw u,v grid locations, based upon plot from Peter
    - Added new rule in Progrules.tex, suggested by Peter


============== Dave,  rv2_2_5 , 5/4/2005 ======================================

Re-write of Radiation_ml and associated handling

**** NEW *****
TimeDate_ml.f90 - added. Much nicer date calculations! (Will supercede Dates_ml
                    in future code)
**** NEW *****

Radiation_ml - subdivided with new routines and re-arranged. Now doesn't need Par_ml. 
               Uses elemntal routines to allow use in both 1-d models and EMEP

               Some changes 
                 SolarSetup  subroutine
                 Ashrea table ......
                 ZenithAngle sub
                 etc.-

Causes small changes in many routines which used radiation, zen, etc., inc:

   Met_ml - now used to store Idirect, Idiffuse
   PhysicalConstants_ml - DAY_ZEN, DAY_COSZEN added
   phyche.f -  subroutine calls changed

============== Hilde, rv2_2_4  =================================================
GlobalBCs_ml - BC for so2,nox,nh4 allowed for year>2003. Trend BCs also for NO,NO2,PAN
My_BoundConditions, ACID - no3, nh4 bcs added

============== Dave,  rv2_2_3 =================================================

DryDep_ml    - "call ReadLanduse" moved to Unimod.f90
Emissions_ml - some dead code removed
UK_ml        - ukdep_init called on all nodes. Removed  need for man gc_rbcast lines
Unimod.f90   - "call readLandUse" moved here.
Wrtchem      - AOT output removed.

============== Peter, rv2_2_2 =================================================

Redefined u_ref into Met_ml including the map factor: 
NB: Will influence the depositions rates,
specially in Southern areas (15% higher deposition rate in Greece?).
Concentrations and depositions may change by several % in Southern areas.


I propose the following principle for variables derived from
meteo variables in Met_ml:

one routine (metvar) controls the variables derived from the meteofields 
after every meteoread (every METSTEP)

one routine (metint) redefines (interpolates) the meteo fields between 
each meteoread (every dt_advec)

one routine (met_derived (new)) derives the meteofields after each 
interpolation (i.e. met_derived is called from or after metint)

In this logic tiphys is called from metvar  and u_ref is defined 
in met_derived

metvar needs some cleaning. Volunteers?


============== Peter, rv2_2_1 =================================================

Defined "ref_latitude" which is latitude for true distances (60 for PARLAM-PS)

GlobalBCs_ml: defined IGLOB = IILARDOM and JGLOB = JJLARDOM (resulting values 
are the same as before, but in new grids these will change)

Removed part in ReadField for non-EMEP grid.

============== Peter, rv2_2_0 =================================================

Included a new routine into Met_ml which is able to read meteo fields 
in NetCDF format. Still under development. 
The old one is still used as default.

Some cleaning. Removed some meteo fields which are not often used, 
but kept SST for Svetlana)

============== Dave, rv2_1_10  =============================================

UniMan added!
        - intended as guide for new users, and reminder for old ones.
        

Met_ml - some tidy up ot tkediff subroutine, to follow coding suggestions
         of User guide.

============== Joffen (Peter) 7/3-2005       , rv2_1_9 =====================

Additional meteo prameters are read: cloud convection and sea surface temp (ccc and sst)

Gutas parameterization of the boundary layer turbulaence and the old parameterization are both included. To choose between them the logical parameter  TKE_DIFF has to be set.

In addition some cleaning up of outdated programming has been done, as
do xxx i = 1, iend


xxx continue

where xxx is a number

has been replaced by
do i = 1,iend

end do


============== Peter 21/2-2005            , rv2_1_8 =====================

Moved the parameter NTDAY from Derived_ml into ModelConstant_ml.
Added some comments.
Changed a comment in Advection_ml.

============== Hilde/Dave 18/2-2005            , rv2_1_7 =====================

Submitted Hilde's changes to BCs for historical runs.


============== Dave  17/2-2005            , rv2_1_6 =====================


ReadField_ml
  -Initialisation to zero added, so now we do not need to input an array which
   covers the whole domain. 

   Also, print used instead of write for error messages, and
   errmsg more explicit now.

Sites_ml: Fix for Embla/Gridur bug,  where printouts of numbers < 1.0e-99
            were messed up.

          Also, N_NIT renamed to N_NOy, and sum_NIT renamed to sum_NOy, since
          NIT is confusing with nitrate, which NOy isn't.

ZD_.../My_Outputs:   N_NIT -> N_NOy

         Also, max NSITES_MAX and NSONDES_MAX increased to 99. 
         (Temporary. Will make arrays allocatable soon....)

============== Peter, 9/2-2005            , rv2_1_5 =====================

N_NIT was not defined in ZD_ACID 
Updated ZD_ACID/My_Ouputs_ml so that it is compatible with the ZD_OZONE 
changes.I defined N_NIT=1. If necessary please define differently.
(Also changed to NHOURLY_OUT = 1, since clouds do not seem to be defined.)

============== Hilde, 3/1-2005            , rv2_1_4  =====================

grun.pl updated also

============== Hilde, 3/1-2005            , rv2_1_3  =====================

Sites_ml.f90: increased nmax_sonde
3D fields for pressures etc, from joffen: Derived_ml.f90, My_Derived
Changes for trend output:My_Outputs_ml.f90
Name on 3D ouput changed: Wrtchem.f90

============== Hilde, 15/12-2004            , rv2_1_2  =====================

BC trends 1980-2003 for S and N based on EPA emissions for 1980-2003 added in 
GlobalBCs_ml. For NH4 the trend is based on 2/3SO2 +1/3NOx
 
Also, PhiH added to Functions_ml, Dave

============================================================================
============================================================================
    rv2.1 = rv2_0_8   same as used for SR matrix work for IIASA, Oct 2004
            but rv2_0_9 has no numerical change, so we rtag the code here.
============================================================================
============================================================================


============== Peter, 29/10-2004            , rv2_0_9  =====================

added file gc_com_for_1_proc.f
This can be used as a "fake" gc_com.f in the cases where 
NPROC=1 and no mpi compiler is available. 
To use it: replace gc_com.f with gc_com_for_1_proc.f and remove the 
preprocessing of gc_com.F from Makefile


============== Peter, 5/10-2004            , rv2_0_9  =====================

in grun.pl:  $BCDIRO3    = "$HILDE/BC_data/LOGAN_O3_DATA/50Data_900mbar_mixratio_firstline"

============== Dave, 29/9-2004            , rv2_0_8  =====================

skip=1 on open_file in Global_ml

============== Dave, 29/9-2004            , rv2_0_8  =====================

macehead=macehead+3 ppb  for 2010 runs


============== Svetlana, Peter  28/09-2004, rv2_0_7  =====================
SeaSalt_ml.f90 used "rough.170" to find sea areas (iclas = 0)
Now it has been changed to identify sea areas using "landuse.mars2004" data 
and scales the sea salt emissions with the water area fraction in the grid.

New grun.pl with extra RunLog info.

============== Peter,Dave;Hilde  24-28/09-2004, rv2_0_6  =====================

grun.pl: Redefined BC from Logan for O3 for OZONE
Defined SOMO0 in Derived_ml
DryDep - modified for safer flux calculations
UK_ml - luflux_wanted set true for decid forests and wheat only.
Makefile without debug options

============== Peter,Svetlana,Dave  24/09-2004, rv2_0_5  =====================

ZD_ACID/,ZD_OZONE/My_Aerosols_ml:
     t20(:)  = 293.  (instead of  t20(:)  = 283.)

molwt defined as real in My_Chem_ml 

=================== Peter,  23/09-2004, rv2_0_4  =============================

Modified Setup_1d and Met_ml: subtracted 1.E-9 from u,v, it2m and itemp.
This should not change results, but is there in order to avoid 
rounding differences on gridur and cluster.

=================== Peter,  17/09-2004, rv2_0_4  =============================

Derived_ml and ZD_OZONE/My_Derived_ml: 
five new d_2d ("D2_SOMO35","D2_AOT30f",D2_AOT40f","D2_AOT60f","D2_AOT40c").

NB: the definition of SOMO35 is slightly different than in "hourlyozone2ramot35":
1)the running average is done over 20 minutes intervalles
2)period 16-24 also taken into account (was not in in the first version of ramot35)
Note that the end of SOMO35 day is at midnight (not end_of_emepday=06:00)

Derived_ml
Introduced new "averaging" for yearly and monthly output of AOTXXc, AOTXXf, SOMO35, D2_MAXO3, D2_MAXOH, D2_EUXXX og D2_UNXXX.

NB: the D2_MAXO3 obtained in the yearly output is slightly different than that obtained using "hourlyozone2ramot35" on hourly output, because in the yearly the max is taken on EMEP_day, while "hourlyozone2ramot35" uses 00:00-24:00.

Dry_Dep_ml: bug corrected (small effect (<1%) on results) in def of SAIadd
	    
My_BoundaryConditions_ml: removed a double declaration of IXADV_H2O2 (compiler on blizzard don't like that)

small changes in grun.pl

=================== Hilde,  27/08/2004, rv2_0_3  =============================

GlobalBCs_ml
 My_Chem_ml and My_BoundConditions_ml in OZONE
 
 H2O2 and CH3COO2 BC corrected for H2O2 and CH3COO2.
 OH BCs in OZONE taken out.
 
 Hilde 27/8/2004

Output_hourly  -- cfac comments fixed to 50m->3m

=================== Dave,              6-11/07/2004, rv2_0_2  ================

GlobalBCs_ml: 2002 and 2003 added to mace_head. Preliminary values needed for 
   EMEP report, derived from Mace Head obs data for CFCs

My_Derived_ml: Warnings only written once now in My_Derived, to avoid huge log
    files (only done in ACID so far)

My_Outputs: Cloud added as example.  (only done in ACID so far)

Output_hourly: "Cloud" added as option for Output_hourly

grun.pl: no bzip2 of hourly.nc file. Some emisdir changes. Alsop BCDIR moved so that
    OZONE always uses 1997 stuff. (BCDIR is only really needed for ACID, since it
    is intended that BCDIR contains the output of OZONE mode runs).

=================== Hilde,               01/06/2004, rv2_0_1  ==========================
ACID and OZONE changes to include BCs from OZONE (OH,CH3COO2,H2O2, O3(acid)). For OZONE, this will have
 effect only when a smaller domain than 170*133 is used.  
Link to Logan files in mixing ratio.
Some SR-My_Derived stuff that should not have been put into ACID removed.
Files changed:
grun.pl
GlobalBCs_ml
My_BoundConditions_ml
My_Derived_ml, only for ACID
My_DryDep_ml
Setup_1d_ml
My_Chem_ml

================== Peter/Dave               01/04/2004, rv2_0beta  ==========================

New grun.pl which also runs SR if required.

new vocsplit data, obtained from a mxiture of IIASA emissions and IER speciation,
for  year 2000 and year 2010.

bunzip2 bug fixed

Biogenics_ml.f90 forests.tf2 renamed to forests.dat


================== Peter/Dave               01/04/2004, rv1_9_34   ==========================

grun.pl added  ja and ja -s to give resource use info in the output

New forest and landuse input data


================== Hilde,               01/04/2004, rv1_9_33   ==========================
Pseudo H2O2 concentrations introduced in ACID to account for ox. limitations.
Solver and My_Reactions.inc (ZD_ACID) changed.

================== Peter,               31/03/2004/ 01/04/2004, rv1_9_33   ==========================
small changes in grun.pl:
	sites.* are tared: tar cvf ${runlabel1}.sites sites.*
	RunLog is renamed ${runlabel1}_RunLog
	bzip2 is made parallell: to compress files just add them into  @bigfile_list
ZD_OZONE/My_Output: only O3 as hourly output

some removal of double declarations
removed version attribute from Netcdf files. (use runlabel instead)

SeaSalt_ml: replaced vind10 ** (3.41) by exp(log(vind10) * (3.41))


================== Dave,               31/03/2004, rv1_9_32   ==========================

 My_Derived_ml:

  !ds 24/3/2004:
  !dsNSR - new system for distinguishing source-receptor (SR) stuff from model
  !        evaluation.  The SR runs should use as few as possible outputs
  !        to keep CPU and disc-requirements down. We define first then the
  !        minimum list of outputs for use in SR ("NSR_2D"), then define an extra list
  !        of parameters (dimesnion NEXTRA_"2D) needed in model evaluation, or even 
  !        for the base-case  of SR runs.

  Also define SOURCE_RECPEPTOR in My_Derived. Used in Derived to set all daily
  outputs to false if .true.

  Also defined two new params: NOX=NO+NO2, NOZ=lots of NOxzy thingies

 Derived_ml:

  Consistency_check in Derived now checks that if SOURCE_RECPETOR=.true. then
  dimension of NDERIV_2D == NSR_2D

  FST30 added to def_2d. Other FSTs renumbered

  Also defined two new params: NOX=NO+NO2, NOZ=lots of NOxzy thingies

 DepVariables_ml

     ECO_SEMINAT redefined to include more categories

  My_DryDep_ml

     Depositions to water and wetlands removed.


private added to:
Dates_ml.f90
ModelConstants_ml.f90


And, for information, the file Sorted.Deriv is now in my Unify directory - it
gives the numbers used in the Derived fields. Makes it easy to find some
free numbers for new variables.

================== Svetlana/Peter,     24/03/2004, rv1_9_31   ==========================

SeaSalt included into PM10, PM25, PMco

Added some "fake" declarations into ZD_ACID

================== Svetlana/Peter,     23/03/2004, rv1_9_29   ==========================
Inclusion of Sea salt

Dates_ml: LAST_SDYEAR = 2003


================== Dave,     17/03/2004, rv1_9_28   ==========================

Derived_ml: Many changes

	Bug-fix i_glob defined ,locally
	Deriv for new 3D fields added
        d_3d for new 3D fields added, inc use of End_of_Day
        gc_abort  added if 3d type not found

DryDep_ml
        Fixed bug in SAIadd found by Peter
        changed g_pot to 1.0 for wheat
Runchem
        Test output of OH, H2O2, (TMP)
UK_ml
        debug_i => DEBUG_i
Wrtchem
        Allows ascii 3D output, for BCs

ZD_OZONE/My_Chem_ml
        NSPEC_SHL has 1 added for Hilde's IXSHL_PHNO3, PHNO3
        Affects all NSPEC_TOT numbers

ZD_OZONE/My_Reactions:_ml
        PHNO3 added.
        Slightly CPU-faster lines for VOLFAC stuff.

ZD_OZONE/My_Derived
        with extra 3D. Also renamed D2_H2O to D2_PM25_H2O

ZD_OZONE/My_Outputs
        Ascii_3D_WANTED added - generates 3D BCs if set
        some extra ouputs (TMP!)


================== Peter,     5/03/2004, rv1_9_27   ==========================

Version compatible with Intel and Lahey compiler on IBM cluster (blizzard)

NB: change in grun.pl: will not work with old grun.pl

Several modules: Removed double declarations,
	         Removed lines containing only a continuation line (&) (compiler bug)

Advection_ml: preadvx,preadvy:
		 small bug in array size declaration (preadvx only)
	         non-blocking send with buffered arrays 
BoundaryConditions_ml:
		allocate also when size=0
	        forall with mask replaced by loop

Dates_ml: small bug in add_2dates (newdate%month could be > 12 at some intermediate stage)

EmisGet: test of intext with "any" crashed: replaced by a loop

Emissions_ml: initialisations

MARS_ml: molnu,phimult defined as intent(in)

Radiation_ml: initialize coszen=0. ( (?)so that it can be used in
		"real, dimension(size(coszen,1),size(coszen,2)) :: expa, catten, Idrctn")

Sites_ml: added fmt=" " in write(xxx,fmt=" " )

Unimod.f90: read input parameters from file (INPUT.PARA) instead of from standard input
		The file INPUT.PARA is produced by grun.pl

grun.pl: produce INPUT.PARA to be read by Unimod.f90

Makefile: commented out debug option

================== Svetlana,     4/03/2004, rv1_9_26 ==========================
PM Water added to aerosols for OZONE.  Needs extension to ACID but to be done.....
commited by Dave, so changes need to be filled in later.  From Sevtlana:

======================================
Hi, Dave and Peter

I put PM_water (parameter 662) to ACID/OZONE_rv.1.9.25
I've made one-day runs with ACID and OZONE. The values for water
looked reasonable

Everuthing  is on ~mifast/Unified__rv.1.9.25/Unimod.

New lines are marked with  "!water". 

The modules affected are:
  phyche.f
  Runchem_ml      (calls Aero_water when daily output)
  Derived_ml
  Chem_ml

and  My_Aerosols_ml      (got new subroutine Aero_water)
         My_Derived_ml

I've also attached for Peter my earlier e-mail ( see below).
I reckon you, guys, can decide between yourself on how to procede.
======================================


AFRIC_ADDED bit (non-serious bug) fixed in grun.pl



================== Dave,        20/02/2004, rv1_9_25 ==========================

GlobalBCs_ml     ... bug fixed: SpecBC needs to be set for all used species 
                    (H2O2 wasn't) check for this added

PhysicalConstants_ml ...   RAD2DEG added

Radiation_ml.f90 --- Bug found! 1900 wrongly added to year. Gives small
                      shift in equation of time (e.g. 8 mins for Jul 1st), hence
                      declention angle and zenith angle.

                 --- solarnoon and daylength calculation added. Useful in ACID

================== Peter,        17/02/2004, rv1_9_24 ==========================
NetCDF_ml: Out_netCDF, optional input parameter "fileName_given", can be 
	used to explicitely give the name of an output file. 
	The use of fileName_given is probably slower than the implicit 
	filename used by defining iotyp. Use it only if a "non-standard" 
	output (i.e. not out_year.nc etc.) is needed

Met_ml: defined case(-11) to define sdot when it is given at level 
	boundaries instead of midlevels. (ident(6)=-11 is pw defined)

================== Dave,        29/01/2004, rv1_9_23 ==========================

RunChem_ml ... debug_flag set false before DEBUG tests
grun.pl  - now chooses sonde file depending on SR or not - fewer stations
           used for SR runs.

================== Dave,        21/01/2004, rv1_9_22 ==========================

GlobalBCs_ml   - add close(IO_GLOBBC)  statements after read. Maybe it doesn't 
                 matter, but it feels safer!

grun.pl - add OHDIR for acid if $SR
        - remove any .nc files prsent in WORKDIR
        - add new small domain for extended OSPAR
        - compresses day.nc and hour.nc files with bzip2
        - Hilde on u6, not u5 now.

================== Dave,        17/01/2004, rv1_9_21 ==========================

New Derived system added for ACID also. See comments on OZONE introduction
below.

Bug-fix: ddep needed initialisations for ecosystem stuff!


================== Dave,        13/01/2004, rv1_9_20 ==========================

Derived_ml -- added T for month in D2_MAXO3 


================== Dave,         7/01/2004, rv1_9_19 ==========================

Changes to fix initialisation bug for AOT found by Peter:

Derived_ml
My_DryDep_ml

grun.pl domain extended beyond OSPAR to East, but only to j=7 in
south, because of BC problems (especially with rainfall from
j=1..7).

================== Dave,        26/12/2003, rv1_9_18 ==========================

DryDep_ml   - leaf_flux initialised to zero for each landuse
NetCDF_ml   - write used instead of print. (Reason: write output is buffered
              whereas print is not. Hence, for normal use, write is better.
              For trapping errors (e.g. before gc_abort=, print is better.


================== Dave,     21-22/12/2003, rv1_9_17 ==========================

New Derived system!! Changes in many routines. Main idea is to
set variables by name in My_Derived_ml, and let Derived_ml work
out what these are. "Master" lists of derived variables are kept
in def_xx variables which correspond to the used f_xx (i.e.
def_ddep contains the full list of possible f_ddep).

In other routines, most changes are to "use Derived" instead of 
"use My_Derived".

BUG-FIX - c_hveg O3 calculation improved in DryDep_ml

BUG-FIX -  grun.pl improved for usage of mkp.pmadd

TSO4 removed from Derived list. This leaves compnr 620 for D2_SO4

FIX: landuse.dec2003 used instead of landuse.nov2003 - solves "line"
problem at ix=153


================== Dave,     19/12/2003, rv1_9_15 =============================

DepVariables_ml   ... BEECH added

My_DryDep_ml  - to get FST for wheat, Beech (D2_FSTWH00, etc.)

My_Outputs_ml - NLEVELS_SONDE added - gives number of vertical levels for
                which sonde data are output.

                Also, Some text to comment in/out for MERLIN cities
                IMPORTANT - COMMENT OUT THE CORRECT BIT!
                (default should be non-merlin)

Sites_ml      - make uses of NLEVELS_SONDE. 

Rsurface_ml: g_temp function changed.

UK_ml   - MM_gfac1.dat not lde_gfac1.

grun.pl - MM_gfac1.dat not lde_gfac1, and $MERLIN_CITIES option


================== Dave,     18/12/2003, rv1_9_14 =============================

grun.pl changed - to add Afican emissions and PM emissions where needed


================== Peter     16/12/2003, rv1_9_13 =============================

NB: Default is no binary (felt) output!

My_Outputs_ml: define Hourly_ASCII=.false. and out_binary=.false. in order
	       		to have only NetCDF output.
Output_hourly: ASCII Hourly files written only if Hourly_ASCII=true.
	       netCDFName can be 120 characters
Output_binary: binary output only if out_binary=true

NetCDF_ml:do not attepmt to write or create files if dimensions are <=0
	  do not write the _3D suffix in variable names
          use FREQ_HOURLY to find middle of hourly period

Unimod.f90 : Hourly netCDFfile not initiated here.

grun.pl : removed double definition of femis.dat
	  create a file RunLog.${runlabel1}.out
 
================== Dave     13/12/2003, rv1_9_12 =============================

Bug-fix. Submet_ml:
Svetlana found negative RH. Vapour pressure e now restricted to be
at least 0.1% of esat, and <= esat.

================== Hilde    12/12/2003, rv1_9_11 =============================
NH4 and NO3 BCs added:
My_BoundConditions
GlobalBCs

N2O5 hydrolysis improved:
SOlver
My_Reactions.inc
ModelConstants
Setup_1d_ml
My_Chem

(Changes only in ZD_OZONE for the My_ files)

=================== Dave    6/12/2003, rv1_9_10 =============================

Improved VOC definitions:
Derived_ml: Setup_VOC now uses carbon numbers to define VOC, excluding
            CO and CH4 by name.
ZD_OZONE/My_Chem_ml: Completed carbon numbers

=================== Peter  23/11/2003, rv1_9_9 ==============================

Increased max sizes for Netcdf filenames to 125

=================== Peter  23/11/2003, rv1_9_8 ==============================

Corrected Output_hourly.f90 such that runlabel1 is also written
for hourly output.

grun.pl : define runlabel also for ACID
NetCDF: corrected small bug for dates in monthly and yearly files.

=================== Dave  23/11/2003, rv1_9_7 ==============================

Correction! Use lde_biomass instead of tf2_biomass in grun.pl, UKsetup_ml
WHEAT used properly to set Wheat g_pot=0.8 in DryDep_ml
grun.pl changes:
    $SR introduced - to help in setting iyr_trend and emisdir properly
    $emisyear removed, replaced by just $emisdir.

=================== Peter  20/11/2003, rv1_9_6 ==============================

runlabel read in grun.pl used to "label" the output

Small Netcdf changes: use runlabel1 in file names.
	              CDF time is set to current time - half period		      
Unimod.f90: read runlabels
Emissions: inverted a do and a if loop
ModelConstants: define runlabel1 and runlabel2
grun.pl: define runlabel1 and runlabel

=================== Dave  18/11/2003, rv1_9_5 ==============================
Correction. WHEAT = 9, not 10!

=================== Dave  18/11/2003, rv1_9_4 ==============================

*** New landuse.nov2003 used *****

Changes and cleanup in UK_ml.f90

And....

EQSAM_ml.f90 in Makefile, not EQSAM-v03d_ml.f90

Output to RunLog.out added (with IO_LOG) to provide output file with emissions.
(Maybe good for SR runs?)
   => Changes in Emissions_ml, Unimod


WHEAT(=10) added to DepVariables. 
Used in UK_ml  (to provide more obvious hard-coding   ;-)


=================== Dave  13/11/2003, rv1_9_3 ==============================
EQSAM-v03d_ml.f90 moved to EQSAM_ml.f90. The former had't been "added"
to the CVS and anyway it is better to update old file names than
add new ones.

=================== Hilde 13/11/2003, rv1_9_2 ==============================
EQSAM version v03d added to OZONE and ACID. Now used as default.

Files changed:
Setup_1d_ml.f90
Setup_1dfields_ml.f90
My_Aerosols_ml.f90 (both ACID and OZONE)
Makefile
EQSAM_v03d_ml.f90 added

=================== Joffen 13/11/2003, rv1_9_1 ==============================

Country numbers for REM, etc. corrected. NLAND extended to 69 with dummy values
for America, EU etc.

=================== Hilde, 12  Nov 2003, rv1_9 ==============================
N2O5 changes added.

Setup_1d_ml,
Setup_1d_fields_ml
Solver
My_Reactions.inc

updated to include changes of N2O5 hydrolysis rate on fine particles. Now we use 
the method of Riemer et al (2003) with a
'base' reaction probability of 0.02 (before 0.1) and then scaled with the realtive 
mass of SO4 and NO3, SO4/(NO3+SO4). Only NO3 fine particles would led to a reaction 
probability of 0.002.

================== Dave, 17  Oct 2003, rv1_8_5 ==============================

Bug-fix:
ZD_OZONE/My_Emis_ml: Order of QRC assigments should be same as in vocsplit files
(Of course, I could have changed the vocsplit files, but this was easier!)

=================== Peter, 17  Oct 2003, rv1_8_4 ==============================
NetCDF_ml,Output_hourly:Allow choice of datatype

=================== Peter, 14  Oct 2003, rv1_8_3 ==============================

My_Outputs_ml: Defined number of vertical levels in Asc2d%nk

Output_hourly: Allow hourly output in NetCDF format on a restricted 
               domain and in a new file every month.

NetCDF_ml:Sizes of restricted domain can be given (horizontal and vertical).
          Create new files for example each month in Hourly output.
          EMEP coordinates and long lat given in output.

My_Derived_ml:defined IOU_HOUR=5

GridValues_ml: Defined EMEP coordinate specifications (xp_EMEP etc.)
               ij2ij: interpolate (used in nesting)

=================== Dave, 25  Sep 2003, rv1_8_2 ==============================
ds rv1_8_2: Added possibility of multi-layer output. Specify

    NLEVELS_HOURLY in My_Outputs_ml, and in hr_out defs use either:
   
         ADVppbv to get surface concentrations (onyl relevant for
                 layer k=20 of course - gives meaningless  number f
                  or higher levels.
   Or,
         BCVppbv to get grid-centre concentrations (relevant for
         all layers.

Dave, 23/9/2003 - removed double definition of iland in Functions_ml

=================== Peter, 23 Sep 2003, 1.8.1 =================================

Several changes for nesting purposes and netcdf. 
	If you do only "usual" calculations: use EMEP grid
	and H50 meteo and you will not nest or use NetCDF output etc..
	then these changes do not affect the results. 

Output_binary: bug for instantaneous output. Should not divide scale by nav 
               if inst output

NetCDF_ml: write NetCDF output files
	   new definition of projection_params
	   Instantaneous concentration file
	   
Many changes in Nest_ml

Met_ml: Test ident(17) for defining xp,yp
        (not used yet but available: calculate sigmadot from a mass 
                                     conserving principle)

Read_Field: In case of non-EMEP grid transform fields to grid (bug corrected)

Solver: do fewer iterations when dt_advec<520 seconds


===================Dave, 23  Sep 2003  1_8       ===================

Rtagged as rv1.8. The "official" version.



===================Hilde , 3 Sep 2003  1_8beta3  ===================
Mace_head O3 for 2001 in GlobalBCs_ml

==============================================================================
=================== Dave, Peter  1st Sep. 2003  rv1_8beta2 ===================
==============================================================================
Peter spotted bug in Met_ml. KZ_MINIMUM was not used! Fixed!


==============================================================================
=================== Dave,  1st Sep. 2003  rv1_8beta ==========================
==============================================================================
MODEL AS DOCUMENTED!! (Except need to change from tf2_ to new files)
in Preport 1/2003, Part 1

Changes made while documenting model:

DryDep_ml.f90
    -- Bug fix: SAIadd moved here from UK_ml
GlobalBCs_ml
    -- vmin fixed for HNO3, SO2
Met_ml
    -- zs1 renamed to zs_bnd
    -- new params and variables:
       real, parameter :: KZ_MINIMUM = 0.001   ! m2/s
       real, parameter :: KZ_MAXIMUM = 1.0e3 ! m2/s - as old kzmax
       real, parameter :: KZ_SBL_LIMIT = 0.1 ! m2/s - Defines stable BL height
       real :: h100 ! Top of lowest layer - replaces 100.0
PhysicalConstants_ml.f90
    -- KARMAN = 0.41  (more consistent with Garratt)
UK_ml
    -- Bug fix: SAIadd moved to DryDep
ZD_OZONE/My_Reactions.inc
  -- GLYOX photolysis products changed
ZD_OZONE/My_WetDep_ml.f90
ZD_ACID/My_WetDep_ml.f90
  -- WScav for pNO3 changed.

+ small tidy ups in DefPhotolysis

==============================================================================
=================== Dave, 24th Aug.  rv1_7_4 ==================================
==============================================================================

ZD_OZONE: My_Reactions_ml
   --  Bug fix: changed products of glyoxal photolysis to be HO2 + 2 CO
       instead of HO2 + CO.

==============================================================================
=================== Dave, 19th Aug.  rv1_7_3 ==================================
==============================================================================
Derived_ml: 
--  Subroutines Consistency_checks and Consistency_count added to search 
     for duplicate entries in derived fields.

ZD_OZONE/My_Derived_ml: 
--   Renumbered ecosystem-entires to avoid collision of numbers (had 541 for 
     both WDEP_SOX and DDEP_RDNWE
--   Added AOT30.

grun.pl
-- modified to point to latest emission files (after bug-fix from Heiko).
==============================================================================
=================== Dave, 1st Aug.  rv1_7_2 ==================================
==============================================================================

Met_ml.f90
-- replaced older Businger+Iversen/Nordeng  \Phi with same Garratt function
as used in deposition scheme.

==============================================================================
=================== Dave, 1st Aug.  rv1_7_1 ==================================
==============================================================================

BoundaryConditions_ml.f90
-- tidy up.
-- replaced old Rorvik stuff with use of DEBUG_i,j

GlobalBCs_ml.f90
-- Bug fixes: 
   1) 2*PI instead of 4.0 * atan(1.0) for twopi_yr 

   2) bc_rawdata(k=20) set to specified BCs, not k=1 !!
   (the BCs were upside down !)

-- Improved vertical scaling - now  uses physical height instead of sigma index
-- mace_head iyr_trend /= year option.
    

Functions_ml.f90

-- added function StandardAtmos_kPa_2_km to convert model's pressure
   level to standard height.

==============================================================================
=================== Dave, 1st Aug.  rv1_7rep2003 =============================
==============================================================================

    ****** THE REPORT VERSION ********


REPORT 1 2003, Part II (model performance) used rv1.6.12. Couldn't tag
as rv1.7 as this tag had been mistakenly applied before.  Use rv1_7rep2003
instead.

Only changes to - this file
==============================================================================
=================== Dave, 18th June, rv1.6.12 =================================
==============================================================================

Derived_ml - added defintions of ecosystems: ECO_CONIF_FOREST, etc.
Changed My_DryDep in ZD_OZONE to make use of these. (Needs same
change in ZD_ACID still)

grun.pl - added check for ProgDir
Makefile: touch depend removed from clean
Output_hourly - Idirectt, Idiffuse added as options

My_Outputs_ml - SITE_XTRA_INDEX, SONDE_XTRA_INDEX introduced to simplify
      access to data from d_2d, d_3d  arrays. 
Sites_ml - d2index, d3index introduced to simplify
      access to data from d_2d, d_3d  arrays. Removes need for explicit
      FSTCF0 cases etc.
ZD_ACID/
    My_Derived - added NOUTPUT_ABS_HEIGHTS - no effect but allows compilation
    My_DryDep  - added c_hveg to Add_ddep
    My_Outputs - as above
ZD_OZONE/
    My_Outputs     - as above
    My_Derived_ml  - new definations for ddep and ecosystem-specific stuff 
    My_DryDep      - added use of ECO_ arrays 

==============================================================================
=================== Hilde, Dave, 11th June, rv1.6.11 =================================
==============================================================================
SO2/NH3 dependence for NH3 dry dep included in Rsurface_ml.f90

Dates_ml changed to use FIRST_SDYEAR=1980, LAST_SDYEAR=2001
  Timefactors_ml modified to use these also.

iyr_ytrend introduced - allows "trend" year to get BCs outside the
   normal 1990-2000 range, e.g. for 1980 or 2050. 
   Changes in:
        BoundaryConditions, ZD_XX/My_BoundaryCOnditions, Global_ml.f90,
        grun.pl, ModelConstants_ml, Unimod.f90

** Specify iyr_trend in grun.pl **

==============================================================================
=================== Dave, 11th June, rv1.6.10 =================================
==============================================================================
Need to account for trends in runs from 1980..2000 :-(
Changed BoundaryConditions_ml to pass year to Set_mybc
Changed ZD_OZONE/My_Bound..   to allow trend_year to set CH4
  Trends introduced for 1990-2000 so far
  (CH4 increased anyway for 1990, from 1760 to 1780)
Fixed bug in grun.pl (2 emisdirs), My_Derived
Changed source of sites.rep03 to $DataDir in grun.pl

==============================================================================
=================== Dave, 11th June, rv1.6.9  =================================
==============================================================================
My_WetDep_ml, increased scavenging ratios
Sites_ml extended to include height of site, based upon Joffen's trotrep work
landuse.tfw used instead of landuse.tf2 (small change)
metdata, emissions, files updated in grun.pl
My_Outputs - some D_2D outputs removed while considering errors
My_Derived - only O3 and H2O2 as 3D

==============================================================================
=================== Dave, 10th June, rv1.6.8  =================================
==============================================================================
Biogenics_ml.f90
Biogenic emissions now derived from landuse.tf2 and using
isoprene emissions factors of Simpson et al., 1999
grun.pl now uses DataDir/forests.tf2, not forest.pcnt

==============================================================================
=================== Dave, 10th June, rv1.6.7  =================================
==============================================================================
Light factors added to isoprene emissions:
Radiation_ml, Setup_1d_ml, phyche.f

removed 300 ppb limit for O3 in GLobalBCs_ml

==============================================================================
=================== Dave, 10th June, rv1.6.6  =================================
==============================================================================
DryDep_ml.f90
IXADV_O3 replaced by FLUX_ADV
Neutral stability assumed when we have land in a grid,  but Hirlam thinks it
is a sea-square.

Met_ml.f90
Pielke's Kz instead of Iversen+Nordeng variety

==============================================================================
=================== Dave, 5th June, rv1.6.5  =================================
==============================================================================
Changed to SEI_based landuse, and added new-style (Fst) flux calculations. 
Changes in DryDep, UK_ml, outouts, etc.

==============================================================================
=================== Dave, 4th June, rv1.6.4  =================================
==============================================================================
grun.pl changed to use ds-fix for UK emissions
New GLobalBCs_ml, using Mace Head BCs correction to Logan
(Needs current_date%year to be passed in Unimod.f90 and BoundaryConditions_ml also).
Makefile reset to not use -g as default

=============================================================================
=================== Dave, 4th June  2003, rv1.6.3t ==========================
=============================================================================

Makefile changed to default without -g option.
Small change to grun.pl to use trends_2003 emissions
(Not model changes, but committed to keep coming comparisons simpler)

==============================================================================
=================== Dave, 29-29 May 2003, rv1.6.3  =============================
==============================================================================

Real Output_hourly changes (as should have been done for rv1.6.2)

Idrctt, Idfuse added to Setup_1Dfields_ml - allows use by other
routines.

==============================================================================
=================== Dave, 27-28 May 2003, rv1.6.2  =============================
==============================================================================

Output_hourly, and My_Outputs_ml.f90 modified to add headers to outputs, 
including number, names, etc. - should make it easier to write and use
processing programs.

Aqueous_ml .. small printout bug fixed

Met_ml - added field surface_precip = rainfall direc from HIRLAM in mm/hr

DryDep_ml, Rsurface_ml, uses surface_precip and logical is_wet instead 
of pr_acc

=================== Hilde 27th of May rv1.6.1 ==========================
Aqueous_ml changed with consistent, tabulated lwc
==============================================================================
=================== Svetlana, 8th May  2003, rv1.6  ==========================

grun.pl is updated to include PMco emissions.
PM emissions are read from ~svetlana/Unify/MyData/emission/em2000 (instead of emis99)
==============================================================================
=================== Svetlana, 7th May  2003, rv1.6  ==========================


Primary PM25 and PMco are included in OZONE version. Files modified are:
My_Chem_ml.f90,  My_Emis_ml.f90,  My_DryDep_ml.f90,
My_WetDep_ml.f90, My_MassBudget_ml.f90, My_Derived_ml.f90, My_Reactions
 
==============================================================================
=================== Hilde, 7th MAy  2003, rv1.6  ============================
My_Reaction.inc : Added H2O2 loss due to SO2 ox
My_Derived_ml.f90: Fixed D3_names (before all was D3_NO2)

==============================================================================
=================== Peter, 14th April  2003, rv1.5.3  ============================
=================== Dave,  24th April  2003, rv1.5.3  ============================
==============================================================================

corrected name of PPM25 and PPMco in ZD_ACID/My_Derived (affects only Net_CDF output )
Used 600 instead of 619 for aNH4 in ZD_ACID & ZD_OZONE /My_Derived
 
==============================================================================
=================== Peter, 2nd April  2003, rv1.5.2  ============================
==============================================================================

Increased maxsize of Deriv%name to 15 characters in My_Derived and redefined some names
 
==============================================================================
=================== Dave, 1st April  2003, rv1.5.1  ============================
==============================================================================

Bug fix for So2->SO4 rates in ZD_OZONE/My_Reactions.inc


==============================================================================
=================== Dave, 28th March 2003, rv1.5  ============================
==============================================================================

Stable (?) version fir TFMM runs. 

==============================================================================
=========== Hilde/Joffen/Dave  28th March 2003, rv1.4.29   ========================
==============================================================================
Units changed to tot. mass in My_Outputs_ml.f90
ADVppbv, ADVugm3, SHLmcm3 now used for Hourly outputs
Output heights put to 3m (or top of tree, er, too difficult to explain, so say 3m )
 - spo use Vg_3m in DryDep and Ra_3m in SubMet_ml

==============================================================================
=========== Dave  27th March 2003, rv1.4.29   ========================
==============================================================================
ZD_ACID: My_Reactions re-corrected for old errors which seemed to come back!
         : HNO3 mssing from pNO3 production, aqrck(ICL3 missing from SO4
grun.pl - now calls "gmake depend" and "gmake" instead of just "make".
	This creates the .depend file

==============================================================================
=========== Dave  27th March 2003, rv1.4.28   ========================
==============================================================================
DEBUG_AERO set false in DryDep_ml
OZONE:NDERIV_2D corrected for bug spotted by Peter (tNO3 line)
==============================================================================
=========== Hilde 26th March 2003, rv1.4.27   ========================
==============================================================================
ACID:My_DryDep_ml.f90:
N_OXN and OXN array and corrected
OZONE:NDERIV_2D corrected
==============================================================================
=========== Hilde 26th March 2003, rv1.4.26   ========================
==============================================================================
My_Derived_ml:
Parameter number for aNH4 changed as it overwrote NO2
Parameter numbers for NH3 set equal in both ACID and OZONE
tNO3 included in OZONE
==============================================================================
=========== Svetlana/Dave 25th March 2003, rv1.4.25   ========================
==============================================================================

Aero_Rb_ml added to enable particle deposition rates to be used.
Fine and coarse rates for So4, aNO3, pNO3, etc.
+ pw bug fix (not changing results?) for no2fac usage in DryDep_ml.
+ reset INORGANIC_AEROSLS true, RUN_EQSAM false in My_Aerosols.

==============================================================================
=========== Hilde/Dave 24th 2003, rv1.4.24  ===============================
==============================================================================

ZD_ACID/My_WetDep changed to remove wet dep of PM
ZD_OZONE/My_Reactions changed to include aqrck for OH, HO2 
.depend and Makefile  introduced - new system suggested by Heiko.

==============================================================================
=========== Dave  24th 2003, rv1.4.23  ===============================
==============================================================================

Bug fixes found by Hilde in ZD_ACID/My_WetDep_ml, My_Reactions, My_DryDep. 
Bug fix in DryDep_ml (max in so2nh3ratio), Dave
Logicals vegetation, urban, added to DepVariables_ml, UK_ml

==============================================================================
=========== Dave  21th 2003, rv1.4.22  ===============================
==============================================================================

SO2/NH3 ratio  REALLY working!  As I (ds) had put so2nh3ratio as intent(in)
the compiler didn't accept it being multiplied by 0.6. Now so2nh3 is used
for the product.

==============================================================================
=========== Hilde, Dave  21th 2003, rv1.4.21  ===============================
==============================================================================

SO2/NH3 ratio  REALLY introduced! rv1.4.20 had RHlim function only.

==============================================================================
=========== Hilde, Dave  21th 2003, rv1.4.20  ===============================
==============================================================================

SO2/NH3 ratio used in DryDep and Rsurface. Also Rhlim function.
(with RH<1 !)

==============================================================================
=========== Dave,  March 21th 2003, rv1.4.19  ===============================
==============================================================================

Fixed My_Reactions for "old" SO2, new pNO3
Extensive stomatal flux  changes in DryDep
Many outputs in My_Derived, My_Outputs, etc.

==============================================================================
=========== Peter, March 21th 2003, rv1.4.18  ===============================
==============================================================================

Included variable timestep in Solver.f90
"Decoupled" variables in ZD_OZONE/My_Reactions.inc:
(PAN,CH3COO2) ,(MPAN,MACRO2), (NO3,N2O5)
ModelConstants: declared dt_advec as a parameter
Dchem is now rate of changes during last dt_advec, instead of absolute change during dt.
Net_CDF: removed a "+" in units attributes

==============================================================================
=========== Dave, March 21th 2003, rv1.4.17  ===============================
==============================================================================

Met_ml bug fixed. 
SO2-> SO4 treatment unified in OZONE and ACID 
(SO2+CH3O2 reaction removed from OZONE as part of this, Fe-reaction added to both).
pNO3 introduced - coarse mode nitrate
Forgot to say earlier: New NO2 deposition method, FNO2 = Vg. max(NO2-4,0)
assumed compensation point of 4 ppb NO2.

==============================================================================
=========== Dave, Svetlana, March 10th 2003, rv1.4.16  =======================
==============================================================================

Primary PM added into ACID version. This slows down ACID a bit, but removes
the need for a separate PM directory. Also, S-R matrices can be done
for PM and ACID substances at the same time - since they are independant.


==============================================================================
=========== Peter ,  Feb. 27th 2003, rv1.4.15  ===============================
=========== Dave  ,  Feb. 27th 2003,           ===============================
==============================================================================
pw: Improved netCDF output. 
ds: New style of BC specification, with ACID and OZONE in grun.pl
ds: O3fix removed from My_Chem_ml
ds: My_Chem_ml not needed for Global... in Makefile
(Hilde has changed names of files in BC_data also, to make consistent system).

==============================================================================
=========== Peter ,  Feb.  7th 2003, rv1.4.14  ===============================
==============================================================================
ZD_ACID/My_Derived_ml: I forgot to define name and unit for D2_ACCSU. (Thanks Dave!)
Restarted daily netCDF output. Corrected small imperfection.

==============================================================================
=========== Peter ,  Feb.  7th 2003, rv1.4.13  ===============================
==============================================================================
Removed daily netCDF output: too slow at present

=============================================================================
==============================================================================
=========== Peter ,  Feb.  7th 2003, rv1.4.12  ==============================
==============================================================================
=============================================================================
Output_binary: daily, monthly and yearly netCDF output
NetCDF_ml: more attributes
My_Derived: additional "Deriv" attributes
Met_ml: smoosp in tiphys, parallel smoosp

==============================================================================
=======
=========== Dave ,  Feb.  7th 2003, rv1.4.11  ================================
==============================================================================
=============================================================================

Corrected Makefile - otherwise as rv1.4.10

==============================================================================
=========== Dave ,  Feb.  6th 2003, rv1.4.10  ================================
==============================================================================
=============================================================================
STO_FLUX, unit_flux, lai_flux  lines added into DryDep, in preperation for
ecosystem modelling. Rsur(NO2) doubled - temporary soln until a better
way of allowing for 2-way NO2 fluxes is found (compensation points one
day, perhaps).

==============================================================================
=========== Hilde,  Jan. 31st 2003, rv1.4.9  ==================================
==============================================================================
=============================================================================
Aqueous chemistry for SO2->SO4 ox. re-introduced. All BCs read from file are now 50*50km2.

==============================================================================
=========== Dave,  Jan. 27nd 2003, rv1.4.8  ==================================
==============================================================================
==============================================================================

CEH-derived Rns used  in Rsurface_ml, and wetarea set in DryDep.
RH-based correction to Gns added

==============================================================================
=========== Dave,  Jan. 24nd 2003, rv1.4.7  ==================================
==============================================================================
==============================================================================

Crude adjustment of BCs (+10 ppb ozone) added in Global_BCs, so that clean
air masses have same ozone as Mace Head. 

==============================================================================
=========== Dave,  Jan. 22nd 2003, rv1.4.6  ==================================
==============================================================================
==============================================================================

BUG-fix -- SAIadd was defined locally in UK_ml, so the SIAadd
from DepVariables never got set.  Fixed.

==============================================================================
=========== Dave,  Jan. 22nd 2003, rv1.4.5  ==================================
==============================================================================
==============================================================================

Added r_water from CEH/ Hilde's code for NH3 to Rsurface_ml.

==============================================================================
=========== Dave,  Jan. 21st 2003, rv1.4.4  ==================================
==============================================================================
==============================================================================

Changed Wesely_ml : increased H* for NH3

==============================================================================
=========== Dave,  Jan. 21st 2003, rv1.4.3  ==================================
==============================================================================
==============================================================================

New MonthlyFac and DailyFac introduced - pollutant specific.
(Changes in Timefactors_ml, grun.pl)

==============================================================================
=========== Peter , January 2003, rv1.4.2  ====================================
==============================================================================
==============================================================================

1)DryDep_ml: 
	use amk
	confac2=... /amk(KMAX_MID) 
        ds-Bug created whewn xn_2d used instead of xn_adv (when put inside i,j loop ?)

2)NetCDF_ml: new module
3)Unimod.f90: call to netCDF_ml
4)Output_binary_ml: call to NetCDF_ml

3)GridValues_ml: added routine coordzero (used by NetCDF_ml)

4)ReadCDF_ml: not used by the model, but contains routines that can read the
	NetCDF output.

5)Makefile: 
	LIBS = -lmpi -lnetcdf
	INCL = -I/home/u4/mifahik/netcdf/include
	LLIB = -L/home/u4/mifahik/netcdf/lib64


6)My_Derived: included /max(1E-80, (xn_adv(...))) in order to avoid division by zero for 0 concentrations.


7)./ZD_ACID/My_Derived_ml:      (was done in ZD_OZONE, but not in ZD_ACID)
	 wdep( :,:,:,:) = 0.0
      ddep( :,:,:,:) = 0.0
      d_2d( :,:,:,:) = 0.0
      d_3d( :,:,:,:,:) = 0.0


==============================================================================
==============================================================================
=========== Dave, 14 Jan 2003  rv1.4.1  ======================================
==============================================================================
==============================================================================

Made Ox. rate SO2->SO4 same (arg=4) in OZONE as in ACID

==============================================================================
==============================================================================
=========== Hilde, Joffen, Peter, sub. Dave, 14 Jan 2003  rv1.4    ===========
==============================================================================
==============================================================================

Corrected Logan's data. grun.pl refers to new location.
Timefactors_ml bug corrected  (Hilde had done this already, so rv1.3.1 
                               was okay)


==============================================================================
==============================================================================
==============================================================================
=========== Hilde   2nd Jan 2003  rv1.3.1   ==========================
==============================================================================
==============================================================================

From forum:
Reply #3 Posted at Thu Jan 2 13:41:23 2003    Revision 1.3.1
Drydep inside loop in Runchem.
Kz_min lifted one layer.
Budget error discovered by jej fixed.

==============================================================================
==============================================================================
==============================================================================
=========== Hilde   2nd Jan 2003  rv1.3     ==========================
==============================================================================
==============================================================================

From forum:
  Reply #2 Posted at Thu Jan 2 12:47:55 2003
Last Modified at Thu Jan 2 13:17:58 2003 by David Simpson Revision rv1.3
New ammoium and nitrate indexes, eq models rewritten/added.

Indexes have been changed so that AMSU and AMNI do not exist anymore. Intead we have aNO3 (aerosol nitrae) and aNH4(aerosol ammonium). The Ammonium routine is rewritten to handle the new indexes. MARS and EQSAM can be run instead of Ammoniun by setting true/false in My_Aerosols_ml.
EQSAM is set as 'default'.



==============================================================================
=========== Dave  , Dec   2   2002, rv1.2.1  ==========================
==============================================================================
==============================================================================

Bug found by Svetlana fixed, Setup_1d_ml now uses KEMISTOP, noit
KMAX_MID-3. ModelConstants_ml also fixed. 


==============================================================================
=========== Dave  , Nov   26  2002, rv1.2  ==========================
==============================================================================
==============================================================================

Fixed (non-influencing?) bugs found by Hilde, Peter, in ZD_ACID version, 
My_Chem_ml and  My_MassBalance_ml.


=========== Dave  , Nov   18  2002, =================================
==============================================================================
==============================================================================

Bug-fixes - pr_acc instead of pr in DryDep and Rsurface
            wasinword in Io_ml

==============================================================================
=========== Dave  , Oct.  24  2002, emep1.2  ==========================
==============================================================================
==============================================================================

Wrtchem changed to correct problems with daily binary output.
Small other changes.
        
==============================================================================
=========== Dave  , Oct.  22  2002, emep1.2helcomU  ==========================
==============================================================================
==============================================================================

Some small bug-changes compared to 1.2helcomF


==============================================================================
=========== Dave  , Sept. 27  2002, emep1.2helcomF  ==========================
==============================================================================
==============================================================================

Version used for Helcom runs.
Added ij Hilde's stack table, but used NEMISLAYERS in EmisDef instead of
KEMISTOP in ModelConstants, to keep emission definitions in Emis files.
Added crude effect of wetness on RextS in Rsurface_ml. 


==============================================================================
=========== Dave  , Sept. 26  2002, emep1.2helcom2  ==========================
==============================================================================
==============================================================================

Peter corrected Output_binary
Dave  corrected nadv  for ecosystem-specific dep.

==============================================================================
=========== Dave  , Sept.  2002, emep1.2beta2 ================================
==============================================================================
==============================================================================

0) Started this Log.changes file. Please add your changes here as appropriate.
  Of course, now the code is under CVS control, differences between releases
  can be easily obtained, but a simple Log file is also helpful.

1) Merged Peter's, Hilde's and my changes in emep1.2beta2, plus

  EmisDef_ml- ANTROP_SECTORS added
  EmisGet_ml- ANTROP_SECTORS added

2) Fixed bugs listed on forum
  Derived_ml - fixed timefrac

3) Re-coded DryDep model to work for ACID

4) ACID version update and tested

5) Merged inpar, in_isnowc and (commented out SetZ0) into MetModel_LandUSe
   in Met_ml. The idea is to keep all HIRLAM/mm5 met data in the same place

6) Moved V_RAIn to ModelCOnstants. Put DEBUG_i, DEBUG_j into ModelConstants -
   used to specifiy which grid square print-outs are wanted for.

7) Setup_1d_ml.f90 - max(1,izen) added
                - In trotrep version xn_shl was reset
  to xn_2d. In emep1.2beta this wasn't done. The 2beta
  version is therefore faster, but this reset allows
  stats such as max_oh to be calculated. Therefore trotrep
  version adopted.

8) Ecosystem-specific deposition added for OXN over seas and forests, for
   Jurek's HELCOM request.

9) INTERACTIVE option added to grun.pl - useful when preparing code for
    running with totalview.

==============================================================================
=========== Peter , summer 2002  =============================================
==============================================================================
==============================================================================
1)Added a test in ReadField_ml, to see if we use the
 EMEP map. If not the field is transformed into the current map.

2)Included routines ij2lb, lb2ij and ij2ij in GridValues_ml.

3)Moved routine inpar and array iclass from GridValues to DryDep

4)Moved  "call inpar" from GridValues to Unimod.f90

5)inpar: explicit loop instead of (:)

6)Commented out routine and call SetZ0 (never used)

7)Changed formula for precipitations (pr) when not found (MM5 case),
  defined V_RAIN in PhysicalConstants_ml

8)Changed 2 last decimals of PI in PhysicalConstants_ml

9)Dates_ml: add_dates_s : Allow to add 3600 seconds (before 3599 was 
  largest allowed). 

10)Print max Courant number in Advection_ml

11)(Changed by Hilde) Loop for skh in Met_ml k=2,KMAX (instead of k=1,KMAX), and z_mid(i,j,k-1)

12)Tabulations : use T0 from PhysicalConstants

13)Rsurface.f90 :(Changed by Dave) /D_i instead of /diffc

14)grun.pl Included an if test in loop for meteo files

15)included a DEBUG compiler option in Makefile

16)commented out a declaration (amax,amin) 

17)Commented out call to smoosp. The routine is not well parallelized.

18)replaced izen = int ( zen(i,j) + 0.5 ) by  izen = max(1,int ( zen(i,j) + 0.5 )) in Setup_1d_ml

19)Jej: My_derived_ml commented out O3= ... !/ (roa ...)

20)Corrected a small bug in advvk in Advection_ml

21)Removed an amax1(.,.) in tiphys (Met_ml)

22)Include  -TARG:exc_min=OZV as compiler option. This will stop the execution if
   wrong operations are done (such as 0/0 , NaN ).

