\chapter{Outputs}
\label{Output:ascii}

Output files are written out in NetCDF format.  
Model will write the output files into your working directory (see the
runscript 'run.pl' where you have set the working directory
path. Chapter 4, 'Submitting a Run' explains all the paths).  For a
base run, all the outputs will be stored into a subdirectory called
'Base' under your working directory, and the files will be named
'Base\_day.nc', 'Base\_hour.nc' etc., for a daily output and hourly
output respectively.  You can also provide a better self descriptive
name for the experiments and then the outputs will be written out with
this experiment name as the base name. This is done in the run
script (ref. Chapter 4).  


\section{sites and sondes}


Two main options are available for the output of ascii files for comparison
with measurements or detailed model analysis. These are

\begin{description}
\item[sites]  

      output of surface concentrations for a set of specified
      measurement site locations.
\item[sondes] 

      output of concentrations for the vertical column above
     a set of specified locations.
\end{description}

Both sites and sondes are specified and handled in similar ways, in
the module {\bf Sites\_ml}, so we treat them both together below.

Locations are specified in input files ('sites.dat' and 'sondes.dat')
whose directory-locations should be specified in {\bf run.pl}.
sites.dat and sondes.dat start with a description of the file contents
followed by a list of the stations. For example, a sondes.dat file
may look like this:


\begin{small}
\begin{verbatim}
# "Sondes: names, locations, elevations"
# "Area: EMEP-Europe"
# "ix: x coordinate"
# "iy: y coordinate"
# "lev: vertical coordinate (20=ground)"
: Units index
: Coords ModelCoords
: VertCoords EMEPsigma
: DomainName EMEP-50kmEurope
#
name ix iy lev #HEADERS
-    index index level #SKIP
#DATA:
Col_Dome          104   45  20  ! comment
Sonnblick         109   55  20  ! comment
Colle_Gnifetti    105   47  20  ! comment
Schauinsland      101   51  20  ! comment
Mt._Zeppelin       59  104  20  ! comment
\end{verbatim}
\end{small}

Or, in cases where latitudes and longitudes are used rather than grid
indices to specify the locations of the stations:

\begin{small}
\begin{verbatim}
# "Sondes: names, locations, elevations"
# "Area: Northern Hemisphere"
# "latitude in degrees (positive north)"
# "longitude in degrees (positive east of Greenwich)"
: Units deg
: Coords LatLong
: VertCoords EMEPsigma
: DomainName Hemis
#
name lat long lev #HEADERS
-    deg deg level #SKIP
#DATA:
Uccle             50.80    4.35  20  ! comment
Lerwick           60.13   -1.18  20  ! comment
Sodankyla         67.39   26.65  20  ! comment
Ny_Alesund        78.93   11.88  20  ! comment
Hohenpeissenberg  47.80   11.02  20  ! comment
\end{verbatim}
\end{small}

The first line in each file is a header telling what is in the file.
Then, the contents are described in more detail. Text strings after
\# are just clarifying comments. 'Area', e.g., is the domain to which
the stations belong, e.g. 'Northern Hemisphere'.

Text after ':' is read in by the model:\newline
- Units: either 'deg' (degrees) or 'index' (model grid indices)\newline
- Coords: either 'LatLong' (latitudes/longitudes) or 'ModelCoords'
(indices of the grid box in which the station is located)\newline
- VertCoords: vertical coordinate system that is used in the model (usually
'EMEPsigma')\newline
- DomainName: domain, for which the model is run (e.g. 'Global\_1x1' or 'Hemis')\newline

Subsequently, the headers of the table columns are specified, e.g.
name (of the station), lat (latitude), long (longitude), and lev
(number of model level corresponding to station elevation),
followed by a line giving the units.
Finally the stations are listed. After the exclamation mark comments
can be added where needed.
\newline
\newline
Plans for the near future:\newline
- use the same file for all domains (GLOBAL, HEMIS, EMEP)\newline
- use latitudes/longitudes only instead of grid indices\newline
- specify the station level in meters asl\newline
\newline
These changes would eliminate the need to specify 'Units',
'Coords' and 'DomainName', and also simplify the path in run.pl
\newline

Both sites.dat and sondes.dat files are optional.
\newline
The species and meteorological data required are specified in {\bf My\_Outputs}
through the use of arrays. Only a few met fields are defined so far but
more can be added into {\bf Sites\_ml} as required. The outputs consist
of a header giving the number of sites used, species/met data used, and
then actual values specified with a 5es10.3 format. For the sonde data
values are given for all 20 levels, starting with the ground-level values.


\section{Hourly out}

\noindent
Optional -  specify in \MyOutputs\, hourly\_out\%ix1, etc.\\
Ascii and netCDF.  Only netCDF outputs will be available in future. 
Put 'Hourly\_ASCII' switch defines whether the output has to be written
into Ascci format or netCDF format.  Ascii may be easy to use, but
produces very large output files.  

\vspace{1cm}

This output is intended to allow hourly (or any resolution) outputs of surface
as well as 3D concentrations in
variable precision for user-defined areas.  

Make sure that the labels 'NHOURLY\_OUT, NLEVELS\_HOURLY, and FREQ\_HOURLY' are updated with the number of
variables, number of levels and frequency of output interval you want
to output into hourly file.  It is explained clearly in the code as
well.  

 
In \MyOutputs\ we have for example:

\begin{small}
\begin{verbatim}
  !**          name type ofmt ispec ix1 ix2  iy1 iy2 nk unit conv max

  hr_out(1) = Hr_output("o3_3m","ADVppbv", 
             "(f8.4)",IXADV_O3, 87, 110, 51, 75,1,"ppbv",PPBINV,600.0)
  hr_out(3) = Hr_output("o3_50m","BCVppbv",
             "(f8.4)",IXADV_O3, 87, 110, 51, 75,20,"ppbv", PPBINV,9000.0)
\end{verbatim}
\end{small}

The above example gives both 3D as well as surface concentration of
Ozone.  Here the type 'ADVppbv' gives surface concentration (note
that nk=1) and 'BCVppbv' gives 3D concentration for all the 20 levels
(nk=20). These are defined in {\bf 'Output\_hourly'}.  The area for which we want to write out the output is
specified with 'ix1','ix2','iy1' and 'iy2'.  Unit is chosen as 'ppbv'
and the conversion factor, 'PPBINV' is coming from
{\bf 'ModelConstants\_ml}'.  


\section{Restricted output}
(TO BE REMOVED! Same functionality available with either use of
sondes files or use of Derived.)

\noindent
Optional -  specify in \MyOutputs\, hourly\_out\%ix1, etc.\\
Binary
\vspace{1cm}

This output is intended to allow 3-hourly (??) outputs of the 3-D concentration
fields for a limited area, for example Milan. Can thus provide boundary-values
for input to other models. (These could also be provided by specifying the
coordinates of the required boundary in the sites.dat file)

In \MyOutputs\ we have for example:

\begin{small}
\begin{verbatim}
  integer, public, parameter ::  &
	 ISPEC_OUTBEG  = 121  &
	,JSPEC_OUTBEG  =  61  &
	,ISPEC_OUTEND  = -130 &     ! Set negative here to exclude
	,JSPEC_OUTEND  = -80        ! Set negative here to exclude
\end{verbatim}
\end{small}


\section{Derived fields and binary outputs}

{\bf modules My\_Derived\_ml, Derived\_ml}\\

My\_Derived\_ml:\\
\begin{itemize}
  \item Constructs arrays wanted\_deriv2d, wanted\_deriv3d, listing
   the outputs which the user wants in netcdf fields.
\end{itemize}

Derived\_ml:\\
\begin{itemize}
  \item Contains definitions of possible output fields
  \item Allocates data arrays d\_2d and d\_3d for those
    fields which were requested in My\_Derived\_ml	
\end{itemize}



\noindent
The fields which are output as netCDF data from model runs consist
of either 2-D or 3-D  arrays, with some identfiers. 
Some data-fields will contain concentration, others depositions, still
others user-defined fields such as column sulphate or AOT40.
Some data will be averaged and printed out daily, other data will
be accumulated to monthly or yearl average totals.
The unified model 
attempts to deal with the various possible data-fields through
a consistent methdology, treating all of the above as simply "derived"
fields.

The basic idea is that  the module Derived\_ml contains an extensive
set of pre-defined outputs. The user chooses which of these
outputs to use by simply defining the arrays wanted\_deriv2d
and wanted\_deriv3d in My\_Derived\_ml.  For example,
we might just have wanted\_derivd2d = (/ "WDEP\_SOX", "D2\_UNAOT40" /)
\footnote{Actually, we usually define wanted\_deriv2d to be
a longer array, and use a string "NOT\_SET\_STRING" to mark
the unwanted elements, thus wanted\_derivd2d = 
(/ "WDEP\_SOX", "D2\_UNAOT40", NOT\_SET\_STRING, NOT\_SET\_STRING, \dots /).
}




A fortran'90 type, Deriv, is defined which contains
a description of the parameters associated with each wanted field.
In this module, derived fields are identified by a "class", such as "ADV" of "VOC".
The user also specifies if averaging is wanted, and sets various
time markers to be true or false. More details are supplied below.

 The Derived\_ml should perform any integrations for these fields.
 Several often-used routines (e.g. for AOTs, acc. sulphate, are defined 
 in the Derived\_ml.f90, and these are only called if the appropriate
 class is found from My\_Derived\_ml. (Users should also be
 able to define their own routines in My\_Derived\_ml, since
 we do not use "use only" in Derived\_ml. However, as far as possible
 we are trying to to keep My\_Derived short and the routines flexible.)

  We define 4 possibilities
  for output time-periods, corresponding to: instantaneous,year,month,day:

  \begin{small}\begin{verbatim}
   integer, public, parameter ::  NIOUTYP = 4
   integer, public, parameter ::  & 
        IOU_INST=1, IOU_YEAR=2, IOU_MON=3, IOU_DAY=4
  \end{verbatim}
  \end{small}


   We also define a new type,`Deriv':

  \begin{small}\begin{verbatim}
    type, public:: Deriv
       character(len=5) :: class ! Class of data, e.g. ADV or VOC
       logical  :: avg      ! True => average data (divide by nav), else accumulate
       integer  :: index    ! index in concentation array, or other
       real     :: scale    ! Scaling factor          ! (was SCALOUT_DERIV_3D)
       logical  :: inst     ! True when instantaneous values needed
       logical  :: year     ! True when yearly averages wanted
       logical  :: month    ! True when monthly averages wanted
       logical  :: day      ! True when daily averages wanted
    end type Deriv
  \end{verbatim}
  \end{small}


  By using this Deriv type, and the subroutine AddDef which sets the elements of the
  Deriv arrays
  def\_2d, def\_3d to be equal to the routines input arguments, we can specify the characteristics of the data
  with just one line of fortran. For example, for the wet deposition of
  sulphur oxides, we use:


  \begin{small}
\begin{verbatim}
    call AddDef("WDEP ", F, -1, 1.0e6, F  ,  T , T ,  T, "WDEP_SOX","mgS/m2")
  \end{verbatim}
  \end{small}

  (Note, F is shorthand for false, T for true.)\\
  \bigskip


 \noindent
  And if WDEP\_SOX is asked for in the My\_Derived list, the Derived\_ml will
  set one of the f\_2d fields to match the above.
  For this example, WDEP\_SOX is the text field we need to identify the
  data, and we set a scaling factor of 1.0e6 for output. The index
  is set to -1 since we do need access to any one index from say 
  the xn\_adv arrays.
   The class
  "WDEP" will tell the rest of the code that this is a wet-deposition field,
   and  calculations will be done accordingly. 

   We have set the avg field to false, as wet-deposition needs to be accumulated,
   not averaged. The time fields show that we want daily, monthly and yearly
   output, but not output of instantaneous fields.

   \begin{table}[h]
   \caption{Summary of parameters, definition and data arrays for derived types}
   \label{TABDRV}
   \begin{tabular}{|lllp{6cm}|}\hline
     No. fields    &  Definition array & Data array  & Comments  \\
                   &               &                 &           \\
     NWDEP         &    f\_wdep    &    wdep   & Wet deposition and accumulated precipitation  \\
     NDDEP         &    d\_wdep    &    ddep   & Dry deposition   \\
     NDERIV\_2D     &    f\_2d      &    d\_2d   & Derived 2-D fields, surface concs., etc.  \\
     NDERIV\_3D     &    f\_3d      &    d\_3d   & Derived 3-D fields  \\ \hline
   \end{tabular}
   \end{table}
