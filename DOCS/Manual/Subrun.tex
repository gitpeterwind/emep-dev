\chapter{Submitting a Run}
\label{ch:SubmitARun}

In this chapter we provide detailed information on how to run the
regional EMEP/MSC-W model for two different types of simulations, namely: 

\begin{description}
\item[Base run]
This is the default set up for yearly transport model calculations
in $50\times50$~km$^2$ grid. 
\item[Scenario run]
 A run with reduced emissions from a particular country or several
 countries is called 
a ``Scenario run''. It is the basic type of run for the source-receptor
calculations. 
\end{description}

\noindent
Details about the submission of these
different types of runs are given below. We suggest that users test
the ``Base run'' first, which can be done without significant changes in
the code itself. One can also use the outputs of such a run in the
future as a reference run for the other simulations.\\  
% 
% As explained in the previous chapters, once the model tar file is
% untarred and all the files are located in the directory called
% {\sl Unify/Unimod.rv3\_7/}, one can find the run script with name
% ``modrun.sh'' in this 
% directory.

\newpage
\section{Base run}

This is an example of a minimum modrun.sh script to run the model.

\begin{quote}
\begin{verbatim}
#!/bin/bash

# Minimalistic script for run the EMEP/MSC-W model

# Link the input data
inputdir=.
ln -s $inputdir/input/* .   # Other input files

# Run the model
mpirun $inputdir/code/Unimod

# Clean the links to the input data and remove INPUT.PARA
ls $inputdir/met  |xargs rm
ls $inputdir/input|xargs rm

\end{verbatim}
\end{quote}

This bash shell script is designed so that users can easily 
adapt it to fit their needs. It contain the minimum information 
required to run the EMEP/MSC-W model. 
The script should be self-explanatory. It assumes one directory for input data other than meteorology data. 
The metdata for the year, and for January 1$^{st}$ the following year (365 +1 files) is linked directly in the
'config\_emep.nml' file. 
You need to set the right paths 
for the input directories.  
All the input files in the input directories are linked to the directory you are working from. 

\subsection{Config\_emep.nml}

The model has a namelist system.  It is possible to set different constants and 
flags for running the model.  The constants and flags itself
is defined in 'ModelConstants\_ml.f90', while they are set in the namelist file under
'ModelConstants\_config' parameter. 
Some of these are briefly explained in Chapter \ref{ch:InputFiles}. 
 Model gets information about running for special cases from this 
file.  The datasets provided are for the EMEP grid EECCA. 

The different parameters for the model run are set in the 'config\_emep.nml' file.  In the very beginning 
of this, the section 'INPUT\_PARA' has all these variables including the link to the meteorology data. 
The trendyear can be set to change the boundary emissions for 
earlier and future years, see the modules {\bf BoundaryConditions\_ml.f90 } 
and {\bf GlobalBCs\_ml.f90 } to understand better what the trendyear 
setting does. The default setting is the meteorological year you are running for, in this case 2012. 
The runlabel1 option sets the name of the different output netCDF 
files , see Table \ref{ch:output}. 
The startdate and enddate parameters are set for the timeperiod you want the model 
to run (YYYY MM DD), and you need meteorology data for the period.

The following is an example of 'INPUT\_PARA' in namelist:

\begin{quote}
\begin{verbatim}

&INPUT_PARA
  iyr_trend = 2012,
  runlabel1 = 'Base',
  runlabel2 = 'Opensource_Setup_2014',
  startdate = 2012,01,01,000000,
  enddate   = 2012,01,10,000000,
  meteo     = 'met/meteoYYYYMMDD.nc',
&end

\end{verbatim}
\end{quote}
 
 This means, that the model is run for the period 1 January to 10 Januray 2012 and the trend year 
 used is 2012.  Output files will be stored with the name 'Base' and the meteorological files are stored
 under the directory 'met' and are linked to the working directory. 

It is possible to run the model on a smaller domain than the full
regional model domain, as defined by  x coordinates ranging
from 1 to 132 and y coordinates ranging from 1 to 159. 

To set a smaller domain, one needs only to specify the
coordinates of the new domain in {\bf RUNDOMAIN} in the namelist file,  
 ``config\_emep.nml''. For example:

\begin{quote}
\begin{verbatim}
! --------Sub domain x0   x1  y0   y1
        RUNDOMAIN =  36, 100, 50, 150   ! smaller EECCA domain
\end{verbatim}
\end{quote}

tells the model to run in the domain with x coordinates ranging from
36 to 100 and y coordinates from 50 to 150.\\ 

To run the model, the correct path to the EMEP/MSC-W model code 
has to be set (mpirun path\_to\_the\_modelcode/Unimod).  

It is recommended to submit the script as a batch job. Please check the 
submission routine on the computer system you are running on. 
In the newer model versions (since 4.0) the number of nodes is set 
automatically from what is asked for when submitting a job. 
% When setting the number of nodes, it is important that it equals to the number set in the FORTRAN module 
% {\bf ModelConstants\_ml.f90}. In the module you set the wanted nodes in the x- and y-direction with {\bf NPROCX } and 
% {\bf NPROCY.} The product of these two is the number of nodes used. 
The approximate time and CPU usage is described in Section \ref{sec:compinf}\\

When the job is no longer running or in the queue, it is either finished or has crashed for some reason.  
If the model run crashed, an error message will give information on what was missing or wrong in the routine.  
If the run was successful, a message
\begin{quote}
\begin{verbatim}
 ++++++++++++++++++++++++++++++++++++++++++++++++
 programme is finished
\end{verbatim}
\end{quote}
will be stated at the end of the log file, before printing the Timing.out file.   
The model results will be written to this same directory. Please make 
sure there is enough disk place for the model results. 
%Here again, the user can edit the script to create an output directory. 
For more information about the model result output files, see chapter \ref{ch:output}.\\

If for some reason the model crashed, please check both the log and the error 
file for any clue of the crash. After fixing the problem the job can be 
submitted again. If the model has crashed, then the links to the input data 
are not removed. 

The script can also be submitted interactively, and either have the output 
written to the screen or to named error and output log files. 
% \newpage

% \newpage

The variables wanted in the output are specified in the 'OutputConcs\_config', 
OutputDep\_config and in the 'OutputMisc\_config' parameters respectively for 
surface concentrations, depositions and some miscellaneous outputs.  


\section{Nesting}
\label{sec:nesting}

The boundary conditions needed for EMEP  MSC-W model is provided with the input data. 
The model can read Boundary conditions data from other models as well.  These data has
to be in netCDF format.  The boundary conditions needed for EMEP  MSC-W model is provided with the 	input data.  The model can read Boundary conditions data from other models as well. 
These data has to be in netCDF format.  

Different Nesting modes are:

\begin{itemize}			
\item read the external BC data only,
\item produce EMEP BC data from the simulation, 
\item read the external BC data and produce EMEP BC data, 
\item using the default EMEP BC data from the input data directory and write out EMEP BC at the end of the simulation, 
\item read the external BC data only in the beginning of the simulation,
\item read external BC at the beginning of the simulation and write out EMEP BC at the end of the simulation.   	
\end{itemize}	

These options are controlled by the {\bf`MODE'} flag  in the {\textbf `config\_emep.nml'} file and the mode options are:

\begin{itemize}
\item MODE=0   ${\rightarrow}$  do nothing
\item MODE=1   ${\rightarrow}$  write at given NHOURSAVE intervals in Nest\_ml.f90  
\item MODE=2   ${\rightarrow}$  read 
\item MODE=3   ${\rightarrow}$  read and write at given NHOURSAVE intervals 
\item MODE=10  ${\rightarrow}$  write at end of run 
\item MODE=11  ${\rightarrow}$  read at start
\item MODE=12  ${\rightarrow}$ read at start and write at end 
\end{itemize}


\subsection{How to use External BC data (MODE=2)}

Following is an example showing how to read `MyBC.nc' as an external BC data.  
The model is reading in 3 variables – {\bf O3}, {\bf PAN}, and {\bf CO} – from this data.  See the 	section {\bf \&ExternalBICs\_bc} . 

Steps to follow: 

	Copy `config\_EMEPSTD.nml' to {\bf `config\_NEST.nml'} 

	Edit {\bf `config\_NEST.nml'}:	

	Choose the {\bf MODE} in {\bf `config\_NEST.nml'} file. This is done in the section {\bf \&Nest\_config}
For egs.,

{\bf \&Nest\_config}
\begin{quote}
\begin{verbatim}
MODE		     = 2			           !for reading external BC 
template_read_BC = 'MyBC.nc'   		       !(The name of your BC data file)
template_write   = 'EMEP_OUT_YYYYMMDD.nc'  !(ONLY for MODE=1, 3, 10 and 12)
\end{verbatim}
\end{quote}


{\bf \&ExternalBICs\_config}
\begin{quote}
\begin{verbatim}
USE_EXTERNAL_BIC 	= T,
EXTERNAL_BIC_NAME 	= 'MyBICScenario'  !(egs., IFS for BC data from ECMWF) 
TOP_BC 		    	= T,   		       !(If you want to use Top BC also from your file )
filename_eta		= 'filename.zaxis' !(This is a text file containing the 
                                         description of your vertical coordinate.)			
\&end
\end{verbatim}
\end{quote}


The checks for reading vertical levels in the BC data is done in the following order:
\begin{itemize}
\item The variable {\textbf `hyam'} (hybrid `a' coefficient at layer midpoint), exists :${\rightarrow}$ {\bf eta coordinate}. 
\item Level is indexed with {\textbf `k'}  :${\rightarrow}$ {\bf Sigma coordinate}
\item {\textbf `filename\_eta'} exist :${\rightarrow}$ {\bf eta coordinate} derived from `vct'*  information in filename\_eta
\item Level indexed with {\textbf`lev'} and no `hyam' or `filename\_eta' :${\rightarrow}$ {\bf pressure coordinate}	
\end{itemize}


Independent of the coordinates of the BC file, the BC levels will be interpolated into EMEP model levels.  If the BC file level structure is not recognized, and there 	is no `filename\_eta' provided, the model will crash. 

An example of the `filename\_eta' for EMEP model levels is given below. Here the `vct' variable describes the model level boundaries in hybrid eta coordinate: 	

{\bf emep\_eta.zaxis}
\begin{quote}
\begin{verbatim}
# 
# zaxisID 0 
# 
zaxistype : surface 
size      : 1 
name      : sfc 
longname  : surface 
levels    : 0 
# 
# zaxisID 1 
# 
zaxistype = hybrid 
size      : 20 
name      : k 
longname  : vertical sigma coordinates 
units     : sigma_level 
levels    : 0.0200 0.0600 0.1000 0.1425 0.1950 0.2635 0.3470 
	    0.4365 0.5215 0.5990 0.6695 0.7330 0.7895 0.8390 
	    0.8815 0.9170 0.9455 0.9670 0.9820 0.9940 
vctsize   = 42 
vct       =
	    10000. 09600. 09200. 08800. 08350. 07750. 06980. 
	    06080. 05190. 04380. 03640. 02970. 02370. 01840. 
	    01380. 00990. 00670. 00420. 00240. 00120. 00000. 
	    0.0000 0.0400 0.0800 0.1200 0.1650 0.2250 0.3020 
	    0.3920 0.4810 0.5620 0.6360 0.7030 0.7630 0.8160 
	    0.8620 0.9010 0.9330 0.9580 0.9760 0.9880 1.0000 
\end{verbatim}
\end{quote}


\textit {*`vct' is the vertical coordinate table describing the hybrid `a' and `b' values (`hyai' and `hybi') at the layer interfaces in eta coordinate system.  They must respect the following constraint:} 

\textit{hyai$_{1}$ = 0    hybi${_1}$ =1}
\newline
\textit{hyai${_0}$ =P${_t}$   hybi${_0}$ = 0}
\newline
\textit{where P${_t}$ → Pressure at top.}
\newline

In this file, the first 21 values in 'vct' column represent 'hyai' and the rest 21 represent 'hybi' values in hPa.  

The variables to be used from the external boundary condition data are given in the 'ExternalBICS\_bc' parameter in the 'config\_emep.nml' file.  An example to use only O3 and NO from a file is given below. 

{\bf \&ExternalBICs\_bc}
\begin{quote}
\begin{verbatim}
description='MyBICScenario','Version name',2,  ! name,version,size 
map_bc=! emep,external,frac,wanted,found,IXADV, 
!        'O3'    ,'O3_VMR_inst'    ,1.0,T,F,-1,
!        'NO'    ,'NO_VMR_inst'    ,1.0,T,F,-1,
\&end 
\end{verbatim}
\end{quote}

Variables in {\bf map\_bc} mean the following: 

\begin{enumerate}
\item ${\rightarrow}$  Variable name in EMEP MSC-W model.
\item ${\rightarrow}$  Variable name in the External BC data file. 
\item ${\rightarrow}$  External BC component to EMEP component fraction.  
\item ${\rightarrow}$  Is this component wanted or not.  (should be T). 
\item ${\rightarrow}$  Was the BC variable found on the file (reset by the model)
\item ${\rightarrow}$  Index of the advected model variable (reset by the model)			 
\end{enumerate}

The fraction is helpful, when one has to map a variable that is explicitly not in EMEP 	model, but a fraction of that particular variable can be mapped to a matching variable in EMEP.

Caution should be given to the units of the variables in the External BC data file.  The model tries to read in the variable together with its units.  This is done in the module `Units\_ml.f90'.  The default units that EMEP can handle now are: 

	{\bf gSm$^{3}$, ugNm$^{3}$, ugCm$^{3}$,  ugm$^{3}$, ppb} and {\bf mixing ratio} ({\bf mol/mol}).

If you have a BC data with different units, either convert them into one of the above 	mentioned units or add the respective conversion factor in the module `Units\_ml.f90'.  

\subsection{How to produce BC data from EMEP MSC-W model (MODE=1):}
	
The time resolution of the BC data that has to produced by EMEP model, is specifed in the module `Nest\_ml.f90' by setting the variable `NHOURSAVE' . 
 
\begin{quote}
\begin{verbatim}
Egs., \bf {NHOURSAVE = 3},  means the data will be written out at 3 hour interval. 
\end{verbatim}
\end{quote}

One can choose the frequency in which the BC out files has to be created (template\_write in config file), and also the domain for which the data has to be written out (sub domain part in config file).  The default setup of the model creates BC data for the whole run domain. 
 
Egs.,  {\bf Nest\_config}

\begin{verbatim}
MODE = 1.
template_write   = `EMEP_OUT_YYYYMMDD.nc'  (This option will write out a file 
everyday with 8 timesteps in each file with the option `NHOURSAVE=3' in Nest_ml.f90).  

`EMEP_OUT_YYYYMM.nc'    (will write out a file every month with no. of days of 
month *8 timesteps in each file with `NHOURSAVE=3' in Nest_ml.f90).
				
!-------- Sub domain for write modes 1,3. 
istart =  60,   
jstart =  11,   
iend   = 107,   
jend   =  58,   
\end{verbatim}

This will produce a `EMEP\_OUT' file for the domain `i=60,107 and j=11,58'.  

Please note that MODE=12 and MODE=13 will always write out fulldomain.   


\section {Source Receptor (SR) Runs}

The EMEP/MSC-W model can be used to test the impact of reduced emission of
one or more pollutants from a particular country or a number of
countries.  Such runs are called ``Scenario runs''. They are the basic
runs for source-receptor calculations.

Emission factors for reduced emissions of pollutants from different
sectors and countries can be defined in the input file called
``femis.dat'', which can be found in the downloaded input data
directory, see section \ref{sec:femis}.

An example of the ``femis.dat'' file for a base run is shown below:
\begin{quote}

\begin{verbatim}
------------------------------------------
Name  5     sox    nox   voc   nh3  pm25
27    0     1.0    1.0   1.0   1.0  1.0  

------------------------------------------
\end{verbatim}
\end{quote}
\noindent
This base run example means that there are (1.0), no emission reductions of 
sox (SO$_x$), nox (NO$_x$), voc (VOC), nh3 (NH$_3$) and pm25 (PM$_{2.5}$) from 
all sectors in the UK. 

\begin{itemize}

\item The first column of
the second line represents the country code. (27 is the code for UK.)
The codes for all countries can be found in  Fortran module {\bf
  Country\_ml.f90}. Please note that the country code must be the same
as in the emission files for the given country. Some
countries and areas are divided into sub-areas in the emission
files. In this case, one line for each sub-area has to be included
into the ``femis.dat'' file. Countries and areas where emissions are
given for sub-areas include the Russian Federation, Germany and all 
sea areas.    

\item The second
column of the second line 
represents the sector and ``0'' means all sectors. Here one can write
the appropriate sector code if the emission is reduced only from a specific
sector. The description of each sector can also be found in the Fortran
module {\bf EmisDef\_ml.f90}. 

\item The columns under the pollutant names show the emission factors
  for the given pollutants. For example, 0.7 would mean 70\% of the
  original emission, thus 30\% reduction.

\item The number (``5'') following
the first text (``Name'') in the first line gives the number of
pollutants treated in the file.   
              
\end{itemize}


An example of ``femis.dat'' file describing 50\% reduced emission of
``sox'' from sector 10 (the emission from agriculture) in the UK can be given as:  
\begin{quote}
\begin{verbatim}
-----------------------------------------
Name  5    sox    nox   voc   nh3  pm25 
27    10   0.5    1.0   1.0   1.0  1.0   

-----------------------------------------
\end{verbatim}        
\end{quote}
For a scenario run ``femis.dat'' file should be edited 
manually depending on the level of
reduction one would like to test with any pollutant from any sector
and/or any country. Several lines can be written in the file.
% Once the ``femis.dat''  file is
% edited, the scenario run can be submitted.  
